System.register([],(function(t,e){"use strict";return{execute:function(){t({BitMask:Dt,CCClass:Se,CacheMode:void 0,DebugMode:void 0,Enum:It,Eventify:Gn,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,Overflow:void 0,SystemEventType:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:Fx,WorldNode3DToWorldNodeUI:zx,absMax:ke,absMaxComponent:We,approx:we,assert:f,assertID:P,bezier:vw,bezierByTime:Cw,ccenum:Mt,clamp:De,clamp01:Ie,color:Cn,computeRatioByType:Iw,createDefaultPipeline:am,deserialize:nd,earcut:Vz,equals:Pe,error:p,errorID:C,find:JE,fragmentText:XR,getBaselineOffset:function(){return 0},getError:D,getPathFromRoot:function(t,e){let n=t,i="";for(;null!==n&&n!==e;)i=`${n.name}/${i}`,n=n.parent;return i.slice(0,-1)},getWorldTransformUntilRoot:function(t,e,n){for(pn.identity(n);t!==e;)pn.fromRTS(HD,t.rotation,t.position,t.scale),pn.multiply(n,HD,n),t=t.parent;return n},instantiate:Wx,inverseLerp:je,isCustomTargetModifier:JD,isDisplayStats:I,isElementModifier:ZD,isPropertyModifier:$D,isUnicodeCJK:jR,isUnicodeSpace:WR,isValid:Mn,lerp:Re,log:u,logID:S,markAsWarning:void 0,mat4:gn,murmurhash2_32_gc:Na,nextPow2:He,pingPong:Ve,pseudoRandom:Fe,pseudoRandomRange:ze,pseudoRandomRangeInt:Ue,quat:un,randomRange:Le,randomRangeInt:Be,rect:Tn,removeProperty:void 0,repeat:Ge,replaceProperty:void 0,safeMeasureText:kR,sampleAnimationCurve:Dw,setDefaultLogTimes:function(t){t>0&&(qg=t)},setDisplayStats:R,size:xn,toDegree:Me,toRadian:Oe,tween:RQ,tweenUtil:OQ,v2:Ke,v3:Qe,v4:en,warn:d,warnID:E});const n="undefined"==typeof window?global:window,i=t("cclegacy",{_global:n});i.internal={},n.CC_BUILD=!0,n.CC_TEST=!1,n.CC_EDITOR=false,n.CC_PREVIEW=!1,n.CC_DEV=!1,n.CC_DEBUG=!1,n.CC_JSB=!0,n.CC_BYTEDANCE=!1,n.CC_WECHAT=!1,n.CC_ALIPAY=!1,n.CC_XIAOMI=!1,n.CC_BAIDU=!1,n.CC_COCOSPLAY=!1,n.CC_HUAWEI=!1,n.CC_OPPO=!1,n.CC_VIVO=!1,n.CC_MINIGAME=!1,n.CC_RUNTIME_BASED=!1,n.CC_SUPPORT_JIT=!0;const s=t("VERSION","3.1.1");n.CocosEngine=i.ENGINE_VERSION=s,n.cc=i;let o=null,r=console.log.bind(console),a=r,c=r,l=(t,e,...n)=>{t||console.log(`ASSERT: ${_(e,...n)}`)},h=r;function _(t,...e){return i.js.formatStr.apply(null,[t].concat(e))}function u(t,...e){return r(t,...e)}function d(t,...e){return a(t,...e)}function p(t,...e){return c(t,...e)}function f(t,e,...n){return l(t,e,...n)}function m(...t){return h(...t)}function g(t){if(r=a=c=l=h=()=>{},t!==w.NONE){if(t>w.ERROR){const e=t=>{if(i.game.canvas){if(!o){const t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",i.game.canvas.height);const e=t.style;e.zIndex="99999",e.position="absolute",e.top=e.left="0",o=document.createElement("textarea"),o.setAttribute("rows","20"),o.setAttribute("cols","30"),o.setAttribute("disabled","true");const n=o.style;n.backgroundColor="transparent",n.borderBottom="1px solid #cccccc",n.borderTopWidth=n.borderLeftWidth=n.borderRightWidth="0px",n.borderTopStyle=n.borderLeftStyle=n.borderRightStyle="none",n.padding="0px",n.margin="0px",t.appendChild(o),i.game.canvas.parentNode.appendChild(t)}o.value=`${o.value+t}\r\n`,o.scrollTop=o.scrollHeight}};c=(t,...n)=>{e(`ERROR :  ${_(t,...n)}`)},l=(t,n,...i)=>{t||e(`ASSERT: ${_(n,...i)}`)},t!==w.ERROR_FOR_WEB_PAGE&&(a=(t,...n)=>{e(`WARN :  ${_(t,...n)}`)}),t===w.INFO_FOR_WEB_PAGE&&(r=(t,...n)=>{e(_(t,...n))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),c=console.error.bind?console.error.bind(console):console.error,l=(t,e,...n)=>{if(!t){const t=_(e,...n);throw new Error(t)}});if(t!==w.ERROR&&(a=console.warn.bind?console.warn.bind(console):console.warn),t===w.INFO&&(r="JavaScriptCore"===scriptEngineType?(t,...e)=>console.log.apply(console,[t,...e]):console.log),t<=w.VERBOSE&&"function"==typeof console.debug){const t=console.debug;h=(...e)=>t(...e)}}}function v(t){{const e=t.stack;return void p(e?`${t}\n${e}`:t)}}function y(t){return(e,...n)=>{const i=`${t} ${e}, please go to https://github.com/cocos-creator/engine/blob/3d/EngineErrorMap.md#${e} to see details.`;return 0===n.length?i:`${i} Arguments: ${n.join(", ")}`}}const x=y("Log");function S(t,...e){u(x(t,...e))}const T=y("Warning");function E(t,...e){d(T(t,...e))}const A=y("Error");function C(t,...e){p(A(t,...e))}const b=y("Assert");function P(t,e,...n){t||f(!1,b(e,...n))}let w;function D(t,...e){return A(t,...e)}function I(){return!!i.profiler&&i.profiler.isShowingStats()}function R(t){i.profiler&&(t?i.profiler.showStats():i.profiler.hideStats(),i.game.config.showFPS=!!t)}!function(t){t[t.NONE=0]="NONE",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",t[t.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",t[t.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(w||(w=t("DebugMode",{})));var O=Object.freeze({__proto__:null,log:u,warn:d,error:p,assert:f,debug:m,_resetDebugSetting:g,_throw:v,logID:S,warnID:E,errorID:C,assertID:P,get DebugMode(){return w},getError:D,isDisplayStats:I,setDisplayStats:R});function M(t){let e=32;return(t&=-t)&&e--,65535&t&&(e-=16),16711935&t&&(e-=8),252645135&t&&(e-=4),858993459&t&&(e-=2),1431655765&t&&(e-=1),e}const N=new Array(256);(t=>{for(let e=0;e<256;++e){let n=e,i=e,s=7;for(n>>>=1;n;n>>>=1)i<<=1,i|=1&n,--s;t[e]=i<<s&255}})(N);var L=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:2147483647,INT_MIN:-2147483648,sign:function(t){return(t>0)-(t<0)},abs:function(t){const e=t>>31;return(t^e)-e},min:function(t,e){return e^(t^e)&-(t<e)},max:function(t,e){return t^(t^e)&-(t<e)},isPow2:function(t){return!(t&t-1||!t)},log2:function(t){let e,n;return e=(t>65535)<<4,n=((t>>>=e)>255)<<3,e|=n,n=((t>>>=n)>15)<<2,e|=n,n=((t>>>=n)>3)<<1,e|=n,e|(t>>>=n)>>1},log10:function(t){return t>=1e9?9:t>=1e8?8:t>=1e7?7:t>=1e6?6:t>=1e5?5:t>=1e4?4:t>=1e3?3:t>=100?2:t>=10?1:0},popCount:function(t){return 16843009*((t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)>>>24},countTrailingZeros:M,nextPow2:function(t){return t+=0===t,--t,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,1+(t|=t>>>16)},prevPow2:function(t){return t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,(t|=t>>>16)-(t>>>1)},parity:function(t){return t^=t>>>16,t^=t>>>8,t^=t>>>4,27030>>>(t&=15)&1},reverse:function(t){return N[255&t]<<24|N[t>>>8&255]<<16|N[t>>>16&255]<<8|N[t>>>24&255]},interleave2:function(t,e){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))<<1},deinterleave2:function(t,e){return(t=65535&((t=16711935&((t=252645135&((t=858993459&((t=t>>>e&1431655765)|t>>>1))|t>>>2))|t>>>4))|t>>>16))<<16>>16},interleave3:function(t,e,n){return t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2),(t|=(e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2))<<1)|(n=1227133513&((n=3272356035&((n=251719695&((n=4278190335&((n&=1023)|n<<16))|n<<8))|n<<4))|n<<2))<<2},deinterleave3:function(t,e){return(t=1023&((t=4278190335&((t=251719695&((t=3272356035&((t=t>>>e&1227133513)|t>>>2))|t>>>4))|t>>>8))|t>>>16))<<22>>22},nextCombination:function(t){const e=t|t-1;return e+1|(~e&-~e)-1>>>M(t)+1}});t("bits",L);class B{constructor(t){this.i=0,this.array=t}get length(){return this.array.length}set length(t){this.array.length=t,this.i>=t&&(this.i=t-1)}remove(t){const e=this.array.indexOf(t);e>=0&&this.removeAt(e)}removeAt(t){this.array.splice(t,1),t<=this.i&&--this.i}fastRemove(t){const e=this.array.indexOf(t);e>=0&&this.fastRemoveAt(e)}fastRemoveAt(t){const e=this.array;e[t]=e[e.length-1],--e.length,t<=this.i&&--this.i}push(t){this.array.push(t)}}function F(t,e){t.splice(e,1)}function z(t,e){const n=t.length;e<0||e>=n||(t[e]=t[n-1],t.length=n-1)}function U(t,e){const n=t.indexOf(e);return n>=0&&(F(t,n),!0)}function H(t,e){return t.indexOf(e)>=0}var G=Object.freeze({__proto__:null,removeAt:F,fastRemoveAt:z,remove:U,fastRemove:function(t,e){const n=t.indexOf(e);n>=0&&(t[n]=t[t.length-1],--t.length)},removeIf:function(t,e){const n=t.findIndex(e);if(n>=0){const e=t[n];return F(t,n),e}},verifyType:function(t,e){if(t&&t.length>0)for(const n of t)if(!(n instanceof e))return S(1300),!1;return!0},removeArray:function(t,e){for(let n=0,i=e.length;n<i;n++)U(t,e[n])},appendObjectsAt:function(t,e,n){return t.splice.apply(t,[n,0,...e]),t},contains:H,copy:function(t){const e=t.length,n=new Array(e);for(let i=0;i<e;i+=1)n[i]=t[i];return n},MutableForwardIterator:B});class V{constructor(t){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=t?t+".":""}getNewId(){return this.prefix+ ++this.id}}V.global=new V("global");const j=new V("TmpCId."),W="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),k="__cid__";function q(t){return"number"==typeof t||t instanceof Number}function X(t){return"string"==typeof t||t instanceof String}function Y(t){for(const e in t)return!1;return!0}const K=(()=>{const t={value:void 0,enumerable:!1,writable:!1,configurable:!0};return(e,n,i,s,o)=>{t.value=i,t.writable=s,t.enumerable=o,Object.defineProperty(e,n,t),t.value=void 0}})(),$=(()=>{const t={get:void 0,set:void 0,enumerable:!1};return(e,n,i,s,o=!1,r=!1)=>{"boolean"==typeof s&&(o=s,s=void 0),t.get=i,t.set=s,t.enumerable=o,t.configurable=r,Object.defineProperty(e,n,t),t.get=void 0,t.set=void 0}})(),Z=(()=>{const t={get:void 0,enumerable:!1,configurable:!1};return(e,n,i,s,o)=>{t.get=i,t.enumerable=s,t.configurable=o,Object.defineProperty(e,n,t),t.get=void 0}})(),J=(()=>{const t={set:void 0,enumerable:!1,configurable:!1};return(e,n,i,s,o)=>{t.set=i,t.enumerable=s,t.configurable=o,Object.defineProperty(e,n,t),t.set=void 0}})();function Q(t){const e=Object.create(null);if(t){const t=".",n="/";e[t]=1,e[n]=1,delete e[t],delete e[n]}return e}function tt(t){if("function"==typeof t){const e=t.prototype;if(e&&e.hasOwnProperty("__classname__")&&e.__classname__)return e.__classname__;let n="";if(t.name&&(n=t.name),t.toString){let e;const i=t.toString();e="["===i.charAt(0)?i.match(/\[\w+\s*(\w+)\]/):i.match(/function\s*(\w+)/),e&&2===e.length&&(n=e[1])}return"Object"!==n?n:""}return t&&t.constructor?tt(t.constructor):""}function et(t,e,n,i){const s=/([^.]+)$/,o=s.exec(e)[0],r=s.exec(n)[0];function a(){return this[r]}i?$(t,o,a,(function(t){this[r]=t})):Z(t,o,a)}function nt(t,e,n,i){for(const s in n)et(t,`${e}.${s}`,n[s],i)}const it=/(%d)|(%s)/,st=/%s/;function ot(t,...e){if(0===arguments.length)return"";if(0===e.length)return`${t}`;const n="string"==typeof t&&it.test(t);if(n)for(const n of e){const e="number"==typeof n?it:st;if(e.test(t)){const i=`${n}`;t=t.replace(e,i)}else t+=` ${n}`}else for(const n of e)t+=` ${n}`;return t}function rt(){const t=arguments.length-1,e=new Array(t);for(let n=0;n<t;++n)e[n]=arguments[n+1];return e}function at(t,e){for(;t;){const n=Object.getOwnPropertyDescriptor(t,e);if(n)return n;t=Object.getPrototypeOf(t)}return null}function ct(t,e,n){const i=at(e,t);i&&Object.defineProperty(n,t,i)}function lt(t,...e){t=t||{};for(const n of e)if(n){if("object"!=typeof n){C(5402,n);continue}for(const e in n)e in t||ct(e,n,t)}return t}function ht(t,...e){t=t||{};for(const n of e)if(n){if("object"!=typeof n){C(5403,n);continue}for(const e in n)ct(e,n,t)}return t}function _t(t,e){for(const n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t.prototype=Object.create(e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),t}function ut(t){const e=t.prototype,n=e&&Object.getPrototypeOf(e);return n&&n.constructor}function dt(t,e){if(t&&e){if("function"!=typeof t)return!1;if("function"!=typeof e)return!1;if(t===e)return!0;for(;;){if(!(t=ut(t)))return!1;if(t===e)return!0}}return!1}function pt(t){for(const e of Object.keys(t))delete t[e]}const ft=Q(!0),mt=Q(!0);function gt(t,e){return function(n,i){if(i.prototype.hasOwnProperty(t)&&delete e[i.prototype[t]],K(i.prototype,t,n),n){const s=e[n];s&&s!==i?p(`A Class already exists with the same ${t} : "${n}".`):e[n]=i}}}const vt=gt("__cid__",ft),yt=gt("__classname__",mt);function xt(t,e){if(yt(t,e),!e.prototype.hasOwnProperty(k)){const n=t||j.getNewId();n&&vt(n,e)}}function St(t,e){const n=mt[e],i=ft[e];let s=!0;if(n&&n!==t&&(p(`"${e}" has already been set as name or alias of another class.`),s=!1),i&&i!==t&&(p(`"${e}" has already been set as id or alias of another class.`),s=!1),s){let n=t[W];n||(n=[],t[W]=n),n.push(e),mt[e]=t,ft[e]=t}}function Tt(...t){for(const e of t){const t=e.prototype,n=t.__cid__;n&&delete ft[n];const i=t.__classname__;i&&delete mt[i];const s=t[W];if(s)for(let t=0;t<s.length;++t){const e=s[t];delete mt[e],delete ft[e]}}}function Et(t){return ft[t]}function At(t){return mt[t]}function Ct(t,e){let n;if(e=void 0===e||e,"function"==typeof t&&t.prototype.hasOwnProperty(k))return n=t.prototype.__cid__,n;if(t&&t.constructor){const e=t.constructor.prototype;if(e&&e.hasOwnProperty(k))return n=t.__cid__,n}return""}class bt{get(){return this._get()}constructor(t,e){this.count=void 0,this._pool=void 0,this._cleanup=void 0;const n=void 0===e?t:e,i=void 0===e?null:t;this.count=0,this._pool=new Array(n),this._cleanup=i}_get(){if(this.count>0){--this.count;const t=this._pool[this.count];return this._pool[this.count]=null,t}return null}put(t){const e=this._pool;if(this.count<e.length){if(this._cleanup&&!1===this._cleanup(t))return;e[this.count]=t,++this.count}}resize(t){t>=0&&(this._pool.length=t,this.count>t&&(this.count=t))}}const Pt=G,wt={IDGenerator:V,Pool:bt,array:G,isNumber:q,isString:X,isEmptyObject:Y,getPropertyDescriptor:at,addon:lt,mixin:ht,extend:_t,getSuper:ut,isChildClassOf:dt,clear:pt,value:K,getset:$,get:Z,set:J,unregisterClass:Tt,getClassName:tt,setClassName:xt,setClassAlias:St,getClassByName:At,get _registeredClassNames(){return{...mt}},set _registeredClassNames(t){pt(mt),Object.assign(mt,t)},get _registeredClassIds(){return{...ft}},set _registeredClassIds(t){pt(ft),Object.assign(ft,t)},_getClassId:Ct,_setClassId:vt,_getClassById:Et,obsolete:et,obsoletes:nt,formatStr:ot,shiftArguments:rt,createMap:Q};function Dt(t){if("__bitmask__"in t)return t;K(t,"__bitmask__",null,!0);let e=-1;const n=Object.keys(t);for(let i=0;i<n.length;i++){const s=n[i];let o=t[s];if(-1===o)o=++e,t[s]=o;else if("number"==typeof o)e=o;else if("string"==typeof o&&Number.isInteger(parseFloat(s)))continue;const r=`${o}`;s!==r&&K(t,r,s)}return t}function It(t){return"__enums__"in t?t:(K(t,"__enums__",null,!0),It.update(t))}function Rt(t){t.hasOwnProperty("__enums__")}function Ot(t){Rt(t);const e=t.__enums__||[];e.length=0;for(const n in t){const i=t[n];Number.isInteger(i)&&e.push({name:n,value:i})}return e.sort(((t,e)=>t.value-e.value)),t.__enums__=e,e}function Mt(t){"__enums__"in t||K(t,"__enums__",null,!0)}i.js=wt,t("js",Object.freeze({__proto__:null,array:Pt,js:wt,IDGenerator:V,Pool:bt,isNumber:q,isString:X,isEmptyObject:Y,value:K,getset:$,get:Z,set:J,createMap:Q,getClassName:tt,obsolete:et,obsoletes:nt,formatStr:ot,shiftArguments:rt,getPropertyDescriptor:at,addon:lt,mixin:ht,extend:_t,getSuper:ut,isChildClassOf:dt,clear:pt,_idToClass:ft,_nameToClass:mt,_setClassId:vt,setClassName:xt,setClassAlias:St,unregisterClass:Tt,_getClassById:Et,getClassByName:At,_getClassId:Ct})),Dt.isBitMask=t=>t&&t.hasOwnProperty("__bitmask__"),Dt.getList=t=>{if(t.__bitmask__)return t.__bitmask__;const e=t.__bitmask__=[];for(const n in t){const i=t[n];Number.isInteger(i)&&e.push({name:n,value:i})}return e.sort(((t,e)=>t.value-e.value)),e},i.BitMask=Dt,It.update=t=>{let e=-1;const n=Object.keys(t);for(let i=0;i<n.length;i++){const s=n[i];let o=t[s];if(-1===o)o=++e,t[s]=o;else if("number"==typeof o)e=o;else if("string"==typeof o&&Number.isInteger(parseFloat(s)))continue;const r=`${o}`;s!==r&&K(t,r,s)}return Array.isArray(t.__enums__)&&Ot(t),t},It||(It=t("Enum",{})),It.isEnum=t=>t&&t.hasOwnProperty("__enums__"),It.getList=t=>(Rt(t),t.__enums__?t.__enums__:Ot(t)),i.Enum=It;class Nt{clone(){return C(100,`${tt(this)}.clone`),this}equals(t){return!1}set(t){C(100,`${tt(this)}.set`)}toString(){return`${{}}`}}t("ValueType",Nt),xt("cc.ValueType",Nt),i.ValueType=Nt;const Lt=t("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20});i.macro=Lt;const Bt=/^(?:cc|dragonBones|sp|ccsg)\..+/,Ft=new Array(123);for(let t=0;t<123;++t)Ft[t]=64;for(let t=0;t<64;++t)Ft["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(t)]=t;const zt=Ft;function Ut(t,e,n){function i(t,e,n,i){const s=Object.getOwnPropertyDescriptor(t,e);if(s)s.get&&(t[n]=s.get),s.set&&i&&(t[i]=s.set);else{const s=t[n];$(t,e,s,t[i])}}let s;const o=t.prototype;for(let t=0;t<e.length;t++){s=e[t];const n=s[0].toUpperCase()+s.slice(1);i(o,s,`get${n}`,`set${n}`)}for(s in n){const t=n[s];i(o,s,t[0],t[1])}}function Ht(t,e,n,i){const s=t[e];s?Array.isArray(s)?i?(s.push(s[0]),s[0]=n):s.push(n):t[e]=i?[n,s]:[s,n]:t[e]=n}function Gt(t,e){if("function"==typeof t.contains)return t.contains(e);if("function"==typeof t.compareDocumentPosition)return!!(16&t.compareDocumentPosition(e));{let n=e.parentNode;if(n)do{if(n===t)return!0;n=n.parentNode}while(null!==n);return!1}}function Vt(t){return"object"==typeof window&&"function"==typeof Node?t instanceof Node:t&&"object"==typeof t&&"number"==typeof t.nodeType&&"string"==typeof t.nodeName}function jt(t,e,n){t&&setTimeout((()=>{t(e,n)}),0)}function Wt(t){return!(!t||t.constructor!==Object)&&Y(t)}function kt(t,e,n){if(e>n){const t=e;e=n,n=t}return t<e?e:t<n?t:n}function qt(t){return t*Lt.RAD}function Xt(t){return t*Lt.DEG}i.misc={BUILTIN_CLASSID_RE:Bt,BASE64_VALUES:zt,propertyDefine:Ut,pushToMap:Ht,contains:Gt,isDomNode:Vt,callInNextTick:jt,isPlainEmptyObj_DEV:Wt,clampf:kt,degreesToRadians:qt,radiansToDegrees:Xt},t("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:Bt,BASE64_VALUES:zt,propertyDefine:Ut,pushToMap:Ht,contains:Gt,isDomNode:Vt,callInNextTick:jt,tryCatchFunctor_EDITOR:function(t){return Function("target",`try {\n  target.${t}();\n}\ncatch (e) {\n  cc._throw(e);\n}`)},isPlainEmptyObj_DEV:Wt,clampf:kt,degreesToRadians:qt,radiansToDegrees:Xt}));const Yt="$_$";function Kt(t,e){const n=e?Object.create(e):{};return K(t,"__attrs__",n),n}function $t(t){if("function"!=typeof t)return Kt(t,Jt(t.constructor));let e;const n=i.Class.getInheritanceChain(t);for(let t=n.length-1;t>=0;t--){const i=n[t];i.hasOwnProperty("__attrs__")&&i.__attrs__||(e=n[t+1],Kt(i,e&&e.__attrs__))}return e=n[0],Kt(t,e&&e.__attrs__),t.__attrs__}function Zt(t,e){const n=Jt(t),i=e+Yt,s={};for(const t in n)t.startsWith(i)&&(s[t.slice(i.length)]=n[t]);return s}function Jt(t){return t.hasOwnProperty("__attrs__")&&t.__attrs__||$t(t)}function Qt(t,e,n,i){Jt(t)[e+Yt+n]=i}class te{constructor(t,e){this.name=void 0,this.default=void 0,this.name=t,this.default=e}toString(){return this.name}}const ee=t("CCInteger",new te("Integer",0));i.Integer=ee,i.CCInteger=ee;const ne=t("CCFloat",new te("Float",0));i.Float=ne,i.CCFloat=ne;const ie=t("CCBoolean",new te("Boolean",!1));i.Boolean=ie,i.CCBoolean=ie;const se=t("CCString",new te("String",""));function oe(t,e){return function(n,i){const s=`"${tt(n)}.${i}"`,o=Zt(n,i);let r=o.type;if(r===ee||r===ne?r="Number":r!==se&&r!==ie||(r=`${r}`),r!==t)return void E(3604,s);if(!o.hasOwnProperty("default"))return;const a=o.default;if(void 0===a)return;if(Array.isArray(a)||Wt(a))return;const c=typeof a,l=t.toLowerCase();if(c===l)if("object"===l){if(!a||a instanceof o.ctor)return;E(3605,s,tt(o.ctor))}else"Number"!==t&&E(3606,e,s,t);else{if("function"===c)return;t===se.default&&null==a?E(3607,s):E(3611,e,s,c)}delete o.type}}i.String=se,i.CCString=se;var re=Object.freeze({__proto__:null,DELIMETER:Yt,createAttrsSingle:Kt,createAttrs:$t,attr:Zt,getClassAttrs:Jt,setClassAttr:Qt,PrimitiveType:te,CCInteger:ee,CCFloat:ne,CCBoolean:ie,CCString:se,getTypeChecker_ET:oe,getObjTypeChecker_ET:function(t){return function(e,n){oe("Object","type")(e,n);const s=Jt(e)[`${n+Yt}default`],o=i.Class.getDefault(s);if(!Array.isArray(o)&&dt(t,i.ValueType)){const i=tt(t),o=ot('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',tt(e),n,i);s?u(o):E(3612,o,i,tt(e),n,i)}}}});const ae={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function ce(t,e,n,i){if(!t.get&&!t.set&&t.hasOwnProperty("default")){const s=`_N$${e}`;t.get=function(){return this[s]},t.set=function(t){const e=this[s];this[s]=t,n.call(this,e)};const o={};i[s]=o;for(const e in ae){const n=ae[e];t.hasOwnProperty(e)&&(o[e]=t[e],n.canUsedInGet||delete t[e])}}}function le(t,e,n,s){if(Array.isArray(e)){if(!(e.length>0))return C(5508,n,s);t.type=e=e[0]}"function"==typeof e&&(e===String?t.type=i.String:e===Boolean?t.type=i.Boolean:e===Number&&(t.type=i.Float))}function he(t,e,n){const i=t?{_short:!0}:{_short:!0,default:e};return n&&(i.type=n),i}function _e(t,e){if(!t||t.constructor!==Object){if(Array.isArray(t)&&t.length>0)return he(e,[],t);if("function"==typeof t){const n=t;return he(e,dt(n,i.ValueType)?new n:null,n)}return he(e,t instanceof te?t.default:t)}return null}let ue=[];function de(){return ue[ue.length-1]}i._RF={push:function(t,e,n,i){void 0===n&&(n=e,e=""),ue.push({uuid:e,script:n,module:t,exports:t.exports,beh:null,importMeta:i})},pop:function(){const t=ue.pop(),e=t.module;let n=e.exports;if(n===t.exports){for(const t in n)return;e.exports=n=t.cls}},peek:de};const pe=Yt,fe={datas:null,push(t){if(this.datas)this.datas.push(t);else{this.datas=[t];const e=this;setTimeout((()=>{e.init()}),0)}},init(){const t=this.datas;if(t){for(let e=0;e<t.length;++e){const n=t[e],i=n.cls;let s=n.props;"function"==typeof s&&(s=s());const o=tt(i);s?xe(i,o,s,i.$super,n.mixins):C(3633,o)}this.datas=null}}};function me(t,e,n,i){!function(t,e){!function(t,e){t.indexOf(e)<0&&t.push(e)}(t.__props__,e)}(t,n),Ee(t,i,e,n)}function ge(t,e,n,i){const s=i.get;i.set,s&&(Ee(t,i,e,n),Qt(t,n,"serializable",!1))}function ve(t){return"function"==typeof t?t():t}function ye(t,e,n){for(const i in e)t.hasOwnProperty(i)||n&&!n(i)||Object.defineProperty(t,i,at(e,i))}function xe(t,e,n,i,s){if(t.__props__=[],i&&i.__props__&&(t.__props__=i.__props__.slice()),s)for(let e=0;e<s.length;++e){const n=s[e];n.__props__&&(t.__props__=t.__props__.concat(n.__props__.filter((e=>t.__props__.indexOf(e)<0))))}if(n){!function(t,e){for(const n in t){let i=t[n];const s=_e(i,!1);if(s&&(i=t[n]=s),i){const s=i.notify;s&&ce(i,n,s,t),"type"in i&&le(i,i.type,e,n)}}}(n,e);for(const i in n){const s=n[i];s.get||s.set?ge(t,e,i,s):me(t,e,i,s)}}const o=Jt(t);t.__values__=t.__props__.filter((t=>!1!==o[`${t+pe}serializable`]))}function Se(t){let e=t.name;const n=t.extends,s=t.mixins,o=function(t,e,n,s){const o=i.Component,r=de();if(r&&dt(e,o)){if(dt(r.cls,o))return C(3615),null;t=t||r.script}const a=function(t,e,n,i){const s=i.ctor,o=[s],r=s;K(r,"__ctors__",o.length>0?o:null,!0);const a=r.prototype;if(e&&(r.$super=e),n){for(let t=n.length-1;t>=0;t--){const e=n[t];ye(a,e.prototype),Se._isCCClass(e)&&ye(Jt(r),Jt(e))}a.constructor=r}return xt(t,r),r}(t,e,n,s);if(r)if(dt(e,o)){const t=r.uuid;t&&vt(t,a),r.cls=a}else dt(r.cls,o)||(r.cls=a);return a}(e,n,s,t);e||(e=i.js.getClassName(o)),o._sealed=!0,n&&(n._sealed=!1);const r=t.properties;"function"==typeof r||n&&null===n.__props__||s&&s.some((t=>null===t.__props__))?(fe.push({cls:o,props:r,mixins:s}),o.__props__=o.__values__=null):xe(o,e,r,n,t.mixins);const a=t.editor;return a&&dt(n,i.Component)&&i.Component._registerEditorProps(o,a),o}Se._isCCClass=function(t){var e;return null==t||null===(e=t.hasOwnProperty)||void 0===e?void 0:e.call(t,"__ctors__")},Se.fastDefine=function(t,e,n){xt(t,e);const i=e.__props__=e.__values__=Object.keys(n),s=Jt(e);for(let t=0;t<i.length;t++){const e=i[t];s[`${e+pe}visible`]=!1,s[`${e+pe}default`]=n[e]}},Se.Attr=re,Se.attr=Zt,Se.getInheritanceChain=function(t){const e=[];for(;t=ut(t);)t!==Object&&e.push(t);return e};const Te={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function Ee(t,e,n,i){let s=null,o="";function r(){return o=i+pe,s=Jt(t)}"type"in e&&void 0===e.type&&E(3660,i,n);const a=e.type;a&&(Te[a]?(s||r())[`${o}type`]=a:"Object"===a||("object"==typeof a?It.isEnum(a)?((s||r())[`${o}type`]="Enum",s[`${o}enumList`]=It.getList(a)):Dt.isBitMask(a)&&((s||r())[`${o}type`]="BitMask",s[`${o}bitmaskList`]=Dt.getList(a)):"function"==typeof a&&((s||r())[`${o}type`]="Object",s[`${o}ctor`]=a))),"default"in e&&((s||r())[`${o}default`]=e.default);const c=(t,n)=>{if(t in e){const i=e[t];typeof i===n&&((s||r())[o+t]=i)}};var l;e.editorOnly&&((s||r())[`${o}editorOnly`]=!0),e.__noImplicit?(s||r())[`${o}serializable`]=null!==(l=e.serializable)&&void 0!==l&&l:!1===e.serializable&&((s||r())[`${o}serializable`]=!1),c("formerlySerializedAs","string");const h=e.range;h&&Array.isArray(h)&&h.length>=2&&((s||r())[`${o}min`]=h[0],s[`${o}max`]=h[1],h.length>2&&(s[`${o}step`]=h[2])),c("min","number"),c("max","number"),c("step","number")}Se.isArray=function(t){return t=ve(t),Array.isArray(t)},Se.getDefault=ve,Se.escapeForJS=function(t){return JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},Se.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,Se.getNewValueTypeCode=function(t){const e=tt(t),n=t.constructor;let i=`new ${e}(`;for(let e=0;e<n.__props__.length;e++)i+=t[n.__props__[e]],e<n.__props__.length-1&&(i+=",");return`${i})`},i.Class=Se;const Ae=Math.PI/180,Ce=180/Math.PI,be=t("EPSILON",1e-6);function Pe(t,e){return Math.abs(t-e)<=be*Math.max(1,Math.abs(t),Math.abs(e))}function we(t,e,n){return n=n||be,Math.abs(t-e)<=n}function De(t,e,n){if(e>n){const t=e;e=n,n=t}return t<e?e:t>n?n:t}function Ie(t){return t<0?0:t>1?1:t}function Re(t,e,n){return t+(e-t)*n}function Oe(t){return t*Ae}function Me(t){return t*Ce}const Ne=t("random",Math.random);function Le(t,e){return Math.random()*(e-t)+t}function Be(t,e){return Math.floor(Le(t,e))}function Fe(t){return(t=(9301*t+49297)%233280)/233280}function ze(t,e,n){return Fe(t)*(n-e)+e}function Ue(t,e,n){return Math.floor(ze(t,e,n))}function He(t){return--t,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}function Ge(t,e){return t-Math.floor(t/e)*e}function Ve(t,e){return t=Ge(t,2*e),e-Math.abs(t-e)}function je(t,e,n){return(n-t)/(e-t)}function We(t){return Math.abs(t.x)>Math.abs(t.y)?Math.abs(t.x)>Math.abs(t.z)?t.x:t.z:Math.abs(t.y)>Math.abs(t.z)?t.y:t.z}function ke(t,e){return Math.abs(t)>Math.abs(e)?t:e}class qe extends Nt{static clone(t){return new qe(t.x,t.y)}static copy(t,e){return t.x=e.x,t.y=e.y,t}static set(t,e,n){return t.x=e,t.y=n,t}static add(t,e,n){return t.x=e.x+n.x,t.y=e.y+n.y,t}static subtract(t,e,n){return t.x=e.x-n.x,t.y=e.y-n.y,t}static multiply(t,e,n){return t.x=e.x*n.x,t.y=e.y*n.y,t}static divide(t,e,n){return t.x=e.x/n.x,t.y=e.y/n.y,t}static ceil(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t}static floor(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t}static min(t,e,n){return t.x=Math.min(e.x,n.x),t.y=Math.min(e.y,n.y),t}static max(t,e,n){return t.x=Math.max(e.x,n.x),t.y=Math.max(e.y,n.y),t}static round(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t}static multiplyScalar(t,e,n){return t.x=e.x*n,t.y=e.y*n,t}static scaleAndAdd(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t}static distance(t,e){const n=e.x-t.x,i=e.y-t.y;return Math.sqrt(n*n+i*i)}static squaredDistance(t,e){const n=e.x-t.x,i=e.y-t.y;return n*n+i*i}static len(t){const e=t.x,n=t.y;return Math.sqrt(e*e+n*n)}static lengthSqr(t){const e=t.x,n=t.y;return e*e+n*n}static negate(t,e){return t.x=-e.x,t.y=-e.y,t}static inverse(t,e){return t.x=1/e.x,t.y=1/e.y,t}static inverseSafe(t,e){const n=e.x,i=e.y;return Math.abs(n)<be?t.x=0:t.x=1/n,Math.abs(i)<be?t.y=0:t.y=1/i,t}static normalize(t,e){const n=e.x,i=e.y;let s=n*n+i*i;return s>0&&(s=1/Math.sqrt(s),t.x=n*s,t.y=i*s),t}static dot(t,e){return t.x*e.x+t.y*e.y}static cross(t,e,n){return t.x=t.y=0,t.z=e.x*n.y-e.y*n.x,t}static lerp(t,e,n,i){const s=e.x,o=e.y;return t.x=s+i*(n.x-s),t.y=o+i*(n.y-o),t}static random(t,e){e=e||1;const n=2*Ne()*Math.PI;return t.x=Math.cos(n)*e,t.y=Math.sin(n)*e,t}static transformMat3(t,e,n){const i=e.x,s=e.y;return t.x=n.m00*i+n.m03*s+n.m06,t.y=n.m01*i+n.m04*s+n.m07,t}static transformMat4(t,e,n){const i=e.x,s=e.y;return t.x=n.m00*i+n.m04*s+n.m12,t.y=n.m01*i+n.m05*s+n.m13,t}static str(t){return`Vec2(${t.x}, ${t.y})`}static toArray(t,e,n=0){return t[n+0]=e.x,t[n+1]=e.y,t}static fromArray(t,e,n=0){return t.x=e[n+0],t.y=e[n+1],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y}static equals(t,e,n=be){return Math.abs(t.x-e.x)<=n*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=n*Math.max(1,Math.abs(t.y),Math.abs(e.y))}static angle(t,e){qe.normalize(Xe,t),qe.normalize(Ye,e);const n=qe.dot(Xe,Ye);return n>1?0:n<-1?Math.PI:Math.acos(n)}constructor(t,e){super(),t&&"object"==typeof t?(this.x=t.x,this.y=t.y):(this.x=t||0,this.y=e||0)}clone(){return new qe(this.x,this.y)}set(t,e){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y):(this.x=t||0,this.y=e||0),this}equals(t,e=be){return Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))}equals2f(t,e,n=be){return Math.abs(this.x-t)<=n*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=n*Math.max(1,Math.abs(this.y),Math.abs(e))}strictEquals(t){return t&&this.x===t.x&&this.y===t.y}strictEquals2f(t,e){return this.x===t&&this.y===e}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}lerp(t,e){const n=this.x,i=this.y;return this.x=n+e*(t.x-n),this.y=i+e*(t.y-i),this}clampf(t,e){return this.x=De(this.x,t.x,e.x),this.y=De(this.y,t.y,e.y),this}add(t){return this.x+=t.x,this.y+=t.y,this}add2f(t,e){return this.x+=t,this.y+=e,this}subtract(t){return this.x-=t.x,this.y-=t.y,this}subtract2f(t,e){return this.x-=t,this.y-=e,this}multiplyScalar(t){return"object"==typeof t&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=t,this.y*=t,this}multiply(t){return"object"!=typeof t&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this}multiply2f(t,e){return this.x*=t,this.y*=e,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divide2f(t,e){return this.x/=t,this.y/=e,this}negative(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSqr(){return this.x*this.x+this.y*this.y}normalize(){const t=this.x,e=this.y;let n=t*t+e*e;return n>0&&(n=1/Math.sqrt(n),this.x*=n,this.y*=n),this}angle(t){const e=this.lengthSqr(),n=t.lengthSqr();if(0===e||0===n)return console.warn("Can't get angle between zero vector"),0;let i=this.dot(t)/Math.sqrt(e*n);return i=De(i,-1,1),Math.acos(i)}signAngle(t){const e=this.angle(t);return this.cross(t)<0?-e:e}rotate(t){const e=this.x,n=this.y,i=Math.sin(t),s=Math.cos(t);return this.x=s*e-i*n,this.y=i*e+s*n,this}project(t){const e=this.dot(t)/t.dot(t);return this.x=t.x*e,this.y=t.y*e,this}transformMat4(t){const e=this.x,n=this.y;return this.x=t.m00*e+t.m04*n+t.m12,this.y=t.m01*e+t.m05*n+t.m13,this}}t("Vec2",qe),qe.ZERO=Object.freeze(new qe(0,0)),qe.ONE=Object.freeze(new qe(1,1)),qe.NEG_ONE=Object.freeze(new qe(-1,-1)),qe.UNIT_X=Object.freeze(new qe(1,0)),qe.UNIT_Y=Object.freeze(new qe(0,1));const Xe=new qe,Ye=new qe;function Ke(t,e){return new qe(t,e)}Se.fastDefine("cc.Vec2",qe,{x:0,y:0}),i.Vec2=qe,i.v2=Ke;class $e extends Nt{static zero(t){return t.x=0,t.y=0,t.z=0,t}static clone(t){return new $e(t.x,t.y,t.z)}static copy(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t}static set(t,e,n,i){return t.x=e,t.y=n,t.z=i,t}static add(t,e,n){return t.x=e.x+n.x,t.y=e.y+n.y,t.z=e.z+n.z,t}static subtract(t,e,n){return t.x=e.x-n.x,t.y=e.y-n.y,t.z=e.z-n.z,t}static multiply(t,e,n){return t.x=e.x*n.x,t.y=e.y*n.y,t.z=e.z*n.z,t}static divide(t,e,n){return t.x=e.x/n.x,t.y=e.y/n.y,t.z=e.z/n.z,t}static ceil(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t}static floor(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t}static min(t,e,n){return t.x=Math.min(e.x,n.x),t.y=Math.min(e.y,n.y),t.z=Math.min(e.z,n.z),t}static max(t,e,n){return t.x=Math.max(e.x,n.x),t.y=Math.max(e.y,n.y),t.z=Math.max(e.z,n.z),t}static round(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t}static multiplyScalar(t,e,n){return t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t}static scaleAndAdd(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t.z=e.z+n.z*i,t}static distance(t,e){const n=e.x-t.x,i=e.y-t.y,s=e.z-t.z;return Math.sqrt(n*n+i*i+s*s)}static squaredDistance(t,e){const n=e.x-t.x,i=e.y-t.y,s=e.z-t.z;return n*n+i*i+s*s}static len(t){const e=t.x,n=t.y,i=t.z;return Math.sqrt(e*e+n*n+i*i)}static lengthSqr(t){const e=t.x,n=t.y,i=t.z;return e*e+n*n+i*i}static negate(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t}static invert(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t}static invertSafe(t,e){const n=e.x,i=e.y,s=e.z;return Math.abs(n)<be?t.x=0:t.x=1/n,Math.abs(i)<be?t.y=0:t.y=1/i,Math.abs(s)<be?t.z=0:t.z=1/s,t}static normalize(t,e){const n=e.x,i=e.y,s=e.z;let o=n*n+i*i+s*s;return o>0&&(o=1/Math.sqrt(o),t.x=n*o,t.y=i*o,t.z=s*o),t}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static cross(t,e,n){const{x:i,y:s,z:o}=e,{x:r,y:a,z:c}=n;return t.x=s*c-o*a,t.y=o*r-i*c,t.z=i*a-s*r,t}static lerp(t,e,n,i){return t.x=e.x+i*(n.x-e.x),t.y=e.y+i*(n.y-e.y),t.z=e.z+i*(n.z-e.z),t}static random(t,e){e=e||1;const n=2*Ne()*Math.PI,i=2*Ne()-1,s=Math.sqrt(1-i*i);return t.x=s*Math.cos(n)*e,t.y=s*Math.sin(n)*e,t.z=i*e,t}static transformMat4(t,e,n){const i=e.x,s=e.y,o=e.z;let r=n.m03*i+n.m07*s+n.m11*o+n.m15;return r=r?Math.abs(1/r):1,t.x=(n.m00*i+n.m04*s+n.m08*o+n.m12)*r,t.y=(n.m01*i+n.m05*s+n.m09*o+n.m13)*r,t.z=(n.m02*i+n.m06*s+n.m10*o+n.m14)*r,t}static transformMat4Normal(t,e,n){const i=e.x,s=e.y,o=e.z;let r=n.m03*i+n.m07*s+n.m11*o;return r=r?Math.abs(1/r):1,t.x=(n.m00*i+n.m04*s+n.m08*o)*r,t.y=(n.m01*i+n.m05*s+n.m09*o)*r,t.z=(n.m02*i+n.m06*s+n.m10*o)*r,t}static transformMat3(t,e,n){const i=e.x,s=e.y,o=e.z;return t.x=i*n.m00+s*n.m03+o*n.m06,t.y=i*n.m01+s*n.m04+o*n.m07,t.z=i*n.m02+s*n.m05+o*n.m08,t}static transformAffine(t,e,n){const i=e.x,s=e.y,o=e.z;return t.x=n.m00*i+n.m04*s+n.m08*o+n.m12,t.y=n.m01*i+n.m05*s+n.m09*o+n.m13,t.x=n.m02*i+n.m06*s+n.m10*o+n.m14,t}static transformQuat(t,e,n){const i=n.w*e.x+n.y*e.z-n.z*e.y,s=n.w*e.y+n.z*e.x-n.x*e.z,o=n.w*e.z+n.x*e.y-n.y*e.x,r=-n.x*e.x-n.y*e.y-n.z*e.z;return t.x=i*n.w+r*-n.x+s*-n.z-o*-n.y,t.y=s*n.w+r*-n.y+o*-n.x-i*-n.z,t.z=o*n.w+r*-n.z+i*-n.y-s*-n.x,t}static transformRTS(t,e,n,i,s){const o=e.x*s.x,r=e.y*s.y,a=e.z*s.z,c=n.w*o+n.y*a-n.z*r,l=n.w*r+n.z*o-n.x*a,h=n.w*a+n.x*r-n.y*o,_=-n.x*o-n.y*r-n.z*a;return t.x=c*n.w+_*-n.x+l*-n.z-h*-n.y+i.x,t.y=l*n.w+_*-n.y+h*-n.x-c*-n.z+i.y,t.z=h*n.w+_*-n.z+c*-n.y-l*-n.x+i.z,t}static transformInverseRTS(t,e,n,i,s){const o=e.x-i.x,r=e.y-i.y,a=e.z-i.z,c=n.w*o-n.y*a+n.z*r,l=n.w*r-n.z*o+n.x*a,h=n.w*a-n.x*r+n.y*o,_=n.x*o+n.y*r+n.z*a;return t.x=(c*n.w+_*n.x+l*n.z-h*n.y)/s.x,t.y=(l*n.w+_*n.y+h*n.x-c*n.z)/s.y,t.z=(h*n.w+_*n.z+c*n.y-l*n.x)/s.z,t}static rotateX(t,e,n,i){const s=e.x-n.x,o=e.y-n.y,r=e.z-n.z,a=Math.cos(i),c=Math.sin(i),l=s,h=o*a-r*c,_=o*c+r*a;return t.x=l+n.x,t.y=h+n.y,t.z=_+n.z,t}static rotateY(t,e,n,i){const s=e.x-n.x,o=e.y-n.y,r=e.z-n.z,a=Math.cos(i),c=Math.sin(i),l=r*c+s*a,h=o,_=r*a-s*c;return t.x=l+n.x,t.y=h+n.y,t.z=_+n.z,t}static rotateZ(t,e,n,i){const s=e.x-n.x,o=e.y-n.y,r=e.z-n.z,a=Math.cos(i),c=Math.sin(i),l=s*a-o*c,h=s*c+o*a,_=r;return t.x=l+n.x,t.y=h+n.y,t.z=_+n.z,t}static toArray(t,e,n=0){return t[n+0]=e.x,t[n+1]=e.y,t[n+2]=e.z,t}static fromArray(t,e,n=0){return t.x=e[n+0],t.y=e[n+1],t.z=e[n+2],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z}static equals(t,e,n=be){const{x:i,y:s,z:o}=t,{x:r,y:a,z:c}=e;return Math.abs(i-r)<=n*Math.max(1,Math.abs(i),Math.abs(r))&&Math.abs(s-a)<=n*Math.max(1,Math.abs(s),Math.abs(a))&&Math.abs(o-c)<=n*Math.max(1,Math.abs(o),Math.abs(c))}static angle(t,e){$e.normalize(Ze,t),$e.normalize(Je,e);const n=$e.dot(Ze,Je);return n>1?0:n<-1?Math.PI:Math.acos(n)}static projectOnPlane(t,e,n){return $e.subtract(t,e,$e.project(t,e,n))}static project(t,e,n){const i=$e.lengthSqr(n);return i<1e-6?$e.set(t,0,0,0):$e.multiplyScalar(t,n,$e.dot(e,n)/i)}constructor(t,e,n){super(),t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t||0,this.y=e||0,this.z=n||0)}clone(){return new $e(this.x,this.y,this.z)}set(t,e,n){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t||0,this.y=e||0,this.z=n||0),this}equals(t,e=be){return Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))}equals3f(t,e,n,i=be){return Math.abs(this.x-t)<=i*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=i*Math.max(1,Math.abs(this.y),Math.abs(e))&&Math.abs(this.z-n)<=i*Math.max(1,Math.abs(this.z),Math.abs(n))}strictEquals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}strictEquals3f(t,e,n){return this.x===t&&this.y===e&&this.z===n}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)}, ${this.z.toFixed(2)})`}lerp(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this.z+=e*(t.z-this.z),this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}add3f(t,e,n){return this.x+=t,this.y+=e,this.z+=n,this}subtract(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subtract3f(t,e,n){return this.x-=t,this.y-=e,this.z-=n,this}multiplyScalar(t){return"object"==typeof t&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=t,this.y*=t,this.z*=t,this}multiply(t){return"object"!=typeof t&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiply3f(t,e,n){return this.x*=t,this.y*=e,this.z*=n,this}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divide3f(t,e,n){return this.x/=t,this.y/=e,this.z/=n,this}negative(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}clampf(t,e){return this.x=De(this.x,t.x,e.x),this.y=De(this.y,t.y,e.y),this.z=De(this.z,t.z,e.z),this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){const{x:e,y:n,z:i}=this,{x:s,y:o,z:r}=t;return this.x=n*r-i*o,this.y=i*s-e*r,this.z=e*o-n*s,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSqr(){return this.x*this.x+this.y*this.y+this.z*this.z}normalize(){const t=this.x,e=this.y,n=this.z;let i=t*t+e*e+n*n;return i>0&&(i=1/Math.sqrt(i),this.x=t*i,this.y=e*i,this.z=n*i),this}transformMat4(t){const e=this.x,n=this.y,i=this.z;let s=t.m03*e+t.m07*n+t.m11*i+t.m15;return s=s?1/s:1,this.x=(t.m00*e+t.m04*n+t.m08*i+t.m12)*s,this.y=(t.m01*e+t.m05*n+t.m09*i+t.m13)*s,this.z=(t.m02*e+t.m06*n+t.m10*i+t.m14)*s,this}}t("Vec3",$e),$e.UNIT_X=Object.freeze(new $e(1,0,0)),$e.UNIT_Y=Object.freeze(new $e(0,1,0)),$e.UNIT_Z=Object.freeze(new $e(0,0,1)),$e.RIGHT=Object.freeze(new $e(1,0,0)),$e.UP=Object.freeze(new $e(0,1,0)),$e.FORWARD=Object.freeze(new $e(0,0,-1)),$e.ZERO=Object.freeze(new $e(0,0,0)),$e.ONE=Object.freeze(new $e(1,1,1)),$e.NEG_ONE=Object.freeze(new $e(-1,-1,-1));const Ze=new $e,Je=new $e;function Qe(t,e,n){return new $e(t,e,n)}Se.fastDefine("cc.Vec3",$e,{x:0,y:0,z:0}),i.Vec3=$e,i.v3=Qe;class tn extends Nt{static clone(t){return new tn(t.x,t.y,t.z,t.w)}static copy(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}static set(t,e,n,i,s){return t.x=e,t.y=n,t.z=i,t.w=s,t}static add(t,e,n){return t.x=e.x+n.x,t.y=e.y+n.y,t.z=e.z+n.z,t.w=e.w+n.w,t}static subtract(t,e,n){return t.x=e.x-n.x,t.y=e.y-n.y,t.z=e.z-n.z,t.w=e.w-n.w,t}static multiply(t,e,n){return t.x=e.x*n.x,t.y=e.y*n.y,t.z=e.z*n.z,t.w=e.w*n.w,t}static divide(t,e,n){return t.x=e.x/n.x,t.y=e.y/n.y,t.z=e.z/n.z,t.w=e.w/n.w,t}static ceil(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t.w=Math.ceil(e.w),t}static floor(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t.w=Math.floor(e.w),t}static min(t,e,n){return t.x=Math.min(e.x,n.x),t.y=Math.min(e.y,n.y),t.z=Math.min(e.z,n.z),t.w=Math.min(e.w,n.w),t}static max(t,e,n){return t.x=Math.max(e.x,n.x),t.y=Math.max(e.y,n.y),t.z=Math.max(e.z,n.z),t.w=Math.max(e.w,n.w),t}static round(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t.w=Math.round(e.w),t}static multiplyScalar(t,e,n){return t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t.w=e.w*n,t}static scaleAndAdd(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t.z=e.z+n.z*i,t.w=e.w+n.w*i,t}static distance(t,e){const n=e.x-t.x,i=e.y-t.y,s=e.z-t.z,o=e.w-t.w;return Math.sqrt(n*n+i*i+s*s+o*o)}static squaredDistance(t,e){const n=e.x-t.x,i=e.y-t.y,s=e.z-t.z,o=e.w-t.w;return n*n+i*i+s*s+o*o}static len(t){const e=t.x,n=t.y,i=t.z,s=t.w;return Math.sqrt(e*e+n*n+i*i+s*s)}static lengthSqr(t){const e=t.x,n=t.y,i=t.z,s=t.w;return e*e+n*n+i*i+s*s}static negate(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=-e.w,t}static inverse(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t.w=1/e.w,t}static inverseSafe(t,e){const n=e.x,i=e.y,s=e.z,o=e.w;return Math.abs(n)<be?t.x=0:t.x=1/n,Math.abs(i)<be?t.y=0:t.y=1/i,Math.abs(s)<be?t.z=0:t.z=1/s,Math.abs(o)<be?t.w=0:t.w=1/o,t}static normalize(t,e){const n=e.x,i=e.y,s=e.z,o=e.w;let r=n*n+i*i+s*s+o*o;return r>0&&(r=1/Math.sqrt(r),t.x=n*r,t.y=i*r,t.z=s*r,t.w=o*r),t}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}static lerp(t,e,n,i){return t.x=e.x+i*(n.x-e.x),t.y=e.y+i*(n.y-e.y),t.z=e.z+i*(n.z-e.z),t.w=e.w+i*(n.w-e.w),t}static random(t,e){e=e||1;const n=2*Ne()*Math.PI,i=2*Ne()-1,s=Math.sqrt(1-i*i);return t.x=s*Math.cos(n)*e,t.y=s*Math.sin(n)*e,t.z=i*e,t.w=0,t}static transformMat4(t,e,n){const i=e.x,s=e.y,o=e.z,r=e.w;return t.x=n.m00*i+n.m04*s+n.m08*o+n.m12*r,t.y=n.m01*i+n.m05*s+n.m09*o+n.m13*r,t.z=n.m02*i+n.m06*s+n.m10*o+n.m14*r,t.w=n.m03*i+n.m07*s+n.m11*o+n.m15*r,t}static transformAffine(t,e,n){const i=e.x,s=e.y,o=e.z,r=e.w;return t.x=n.m00*i+n.m01*s+n.m02*o+n.m03*r,t.y=n.m04*i+n.m05*s+n.m06*o+n.m07*r,t.x=n.m08*i+n.m09*s+n.m10*o+n.m11*r,t.w=e.w,t}static transformQuat(t,e,n){const{x:i,y:s,z:o}=e,r=n.x,a=n.y,c=n.z,l=n.w,h=l*i+a*o-c*s,_=l*s+c*i-r*o,u=l*o+r*s-a*i,d=-r*i-a*s-c*o;return t.x=h*l+d*-r+_*-c-u*-a,t.y=_*l+d*-a+u*-r-h*-c,t.z=u*l+d*-c+h*-a-_*-r,t.w=e.w,t}static toArray(t,e,n=0){return t[n+0]=e.x,t[n+1]=e.y,t[n+2]=e.z,t[n+3]=e.w,t}static fromArray(t,e,n=0){return t.x=e[n+0],t.y=e[n+1],t.z=e[n+2],t.w=e[n+3],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w}static equals(t,e,n=be){return Math.abs(t.x-e.x)<=n*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=n*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=n*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=n*Math.max(1,Math.abs(t.w),Math.abs(e.w))}constructor(t,e,n,i){super(),t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=n||0,this.w=i||0)}clone(){return new tn(this.x,this.y,this.z,this.w)}set(t,e,n,i){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=n||0,this.w=i||0),this}equals(t,e=be){return Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))&&Math.abs(this.w-t.w)<=e*Math.max(1,Math.abs(this.w),Math.abs(t.w))}equals4f(t,e,n,i,s=be){return Math.abs(this.x-t)<=s*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=s*Math.max(1,Math.abs(this.y),Math.abs(e))&&Math.abs(this.z-n)<=s*Math.max(1,Math.abs(this.z),Math.abs(n))&&Math.abs(this.w-i)<=s*Math.max(1,Math.abs(this.w),Math.abs(i))}strictEquals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}strictEquals4f(t,e,n,i){return this.x===t&&this.y===e&&this.z===n&&this.w===i}lerp(t,e){const n=this.x,i=this.y,s=this.z,o=this.w;return this.x=n+e*(t.x-n),this.y=i+e*(t.y-i),this.z=s+e*(t.z-s),this.w=o+e*(t.w-o),this}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)}, ${this.z.toFixed(2)}, ${this.w.toFixed(2)})`}clampf(t,e){return this.x=De(this.x,t.x,e.x),this.y=De(this.y,t.y,e.y),this.z=De(this.z,t.z,e.z),this.w=De(this.w,t.w,e.w),this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}add4f(t,e,n,i){return this.x+=t,this.y+=e,this.z+=n,this.w+=i,this}subtract(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}subtract4f(t,e,n,i){return this.x-=t,this.y-=e,this.z-=n,this.w-=i,this}multiplyScalar(t){return"object"==typeof t&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}multiply(t){return"object"!=typeof t&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}multiply4f(t,e,n,i){return this.x*=t,this.y*=e,this.z*=n,this.w*=i,this}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this}divide4f(t,e,n,i){return this.x/=t,this.y/=e,this.z/=n,this.w/=i,this}negative(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}cross(t){const{x:e,y:n,z:i}=this,{x:s,y:o,z:r}=t;return this.x=n*r-i*o,this.y=i*s-e*r,this.z=e*o-n*s,this}length(){const t=this.x,e=this.y,n=this.z,i=this.w;return Math.sqrt(t*t+e*e+n*n+i*i)}lengthSqr(){const t=this.x,e=this.y,n=this.z,i=this.w;return t*t+e*e+n*n+i*i}normalize(){const t=this.x,e=this.y,n=this.z,i=this.w;let s=t*t+e*e+n*n+i*i;return s>0&&(s=1/Math.sqrt(s),this.x=t*s,this.y=e*s,this.z=n*s,this.w=i*s),this}transformMat4(t){const e=this.x,n=this.y,i=this.z,s=this.w;return this.x=t.m00*e+t.m04*n+t.m08*i+t.m12*s,this.y=t.m01*e+t.m05*n+t.m09*i+t.m13*s,this.z=t.m02*e+t.m06*n+t.m10*i+t.m14*s,this.w=t.m03*e+t.m07*n+t.m11*i+t.m15*s,this}}function en(t,e,n,i){return new tn(t,e,n,i)}t("Vec4",tn),tn.ZERO=Object.freeze(new tn(0,0,0,0)),tn.ONE=Object.freeze(new tn(1,1,1,1)),tn.NEG_ONE=Object.freeze(new tn(-1,-1,-1,-1)),Se.fastDefine("cc.Vec4",tn,{x:0,y:0,z:0,w:0}),i.Vec4=tn,i.v4=en;class nn extends Nt{static clone(t){return new nn(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)}static copy(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t}static set(t,e,n,i,s,o,r,a,c,l){return t.m00=e,t.m01=n,t.m02=i,t.m03=s,t.m04=o,t.m05=r,t.m06=a,t.m07=c,t.m08=l,t}static identity(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t}static transpose(t,e){if(t===e){const n=e.m01,i=e.m02,s=e.m05;t.m01=e.m03,t.m02=e.m06,t.m03=n,t.m05=e.m07,t.m06=i,t.m07=s}else t.m00=e.m00,t.m01=e.m03,t.m02=e.m06,t.m03=e.m01,t.m04=e.m04,t.m05=e.m07,t.m06=e.m02,t.m07=e.m05,t.m08=e.m08;return t}static invert(t,e){const n=e.m00,i=e.m01,s=e.m02,o=e.m03,r=e.m04,a=e.m05,c=e.m06,l=e.m07,h=e.m08,_=h*r-a*l,u=-h*o+a*c,d=l*o-r*c;let p=n*_+i*u+s*d;return 0===p?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t):(p=1/p,t.m00=_*p,t.m01=(-h*i+s*l)*p,t.m02=(a*i-s*r)*p,t.m03=u*p,t.m04=(h*n-s*c)*p,t.m05=(-a*n+s*o)*p,t.m06=d*p,t.m07=(-l*n+i*c)*p,t.m08=(r*n-i*o)*p,t)}static determinant(t){const e=t.m00,n=t.m01,i=t.m02,s=t.m03,o=t.m04,r=t.m05,a=t.m06,c=t.m07,l=t.m08;return e*(l*o-r*c)+n*(-l*s+r*a)+i*(c*s-o*a)}static multiply(t,e,n){const i=e.m00,s=e.m01,o=e.m02,r=e.m03,a=e.m04,c=e.m05,l=e.m06,h=e.m07,_=e.m08,u=n.m00,d=n.m01,p=n.m02,f=n.m03,m=n.m04,g=n.m05,v=n.m06,y=n.m07,x=n.m08;return t.m00=u*i+d*r+p*l,t.m01=u*s+d*a+p*h,t.m02=u*o+d*c+p*_,t.m03=f*i+m*r+g*l,t.m04=f*s+m*a+g*h,t.m05=f*o+m*c+g*_,t.m06=v*i+y*r+x*l,t.m07=v*s+y*a+x*h,t.m08=v*o+y*c+x*_,t}static multiplyMat4(t,e,n){const i=e.m00,s=e.m01,o=e.m02,r=e.m03,a=e.m04,c=e.m05,l=e.m06,h=e.m07,_=e.m08,u=n.m00,d=n.m01,p=n.m02,f=n.m04,m=n.m05,g=n.m06,v=n.m08,y=n.m09,x=n.m10;return t.m00=u*i+d*r+p*l,t.m01=u*s+d*a+p*h,t.m02=u*o+d*c+p*_,t.m03=f*i+m*r+g*l,t.m04=f*s+m*a+g*h,t.m05=f*o+m*c+g*_,t.m06=v*i+y*r+x*l,t.m07=v*s+y*a+x*h,t.m08=v*o+y*c+x*_,t}static transform(t,e,n){const i=e.m00,s=e.m01,o=e.m02,r=e.m03,a=e.m04,c=e.m05,l=e.m06,h=e.m07,_=e.m08,u=n.x,d=n.y;return t.m00=i,t.m01=s,t.m02=o,t.m03=r,t.m04=a,t.m05=c,t.m06=u*i+d*r+l,t.m07=u*s+d*a+h,t.m08=u*o+d*c+_,t}static scale(t,e,n){const i=n.x,s=n.y;return t.m00=i*e.m00,t.m01=i*e.m01,t.m02=i*e.m02,t.m03=s*e.m03,t.m04=s*e.m04,t.m05=s*e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t}static rotate(t,e,n){const i=e.m00,s=e.m01,o=e.m02,r=e.m03,a=e.m04,c=e.m05,l=e.m06,h=e.m07,_=e.m08,u=Math.sin(n),d=Math.cos(n);return t.m00=d*i+u*r,t.m01=d*s+u*a,t.m02=d*o+u*c,t.m03=d*r-u*i,t.m04=d*a-u*s,t.m05=d*c-u*o,t.m06=l,t.m07=h,t.m08=_,t}static fromMat4(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m04,t.m04=e.m05,t.m05=e.m06,t.m06=e.m08,t.m07=e.m09,t.m08=e.m10,t}static fromViewUp(t,e,n){return $e.lengthSqr(e)<be*be?(nn.identity(t),t):(n=n||$e.UNIT_Y,$e.normalize(sn,$e.cross(sn,n,e)),$e.lengthSqr(sn)<be*be?(nn.identity(t),t):($e.cross(on,e,sn),nn.set(t,sn.x,sn.y,sn.z,on.x,on.y,on.z,e.x,e.y,e.z),t))}static fromTranslation(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=e.x,t.m07=e.y,t.m08=1,t}static fromScaling(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=e.y,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t}static fromRotation(t,e){const n=Math.sin(e),i=Math.cos(e);return t.m00=i,t.m01=n,t.m02=0,t.m03=-n,t.m04=i,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t}static fromQuat(t,e){const n=e.x,i=e.y,s=e.z,o=e.w,r=n+n,a=i+i,c=s+s,l=n*r,h=i*r,_=i*a,u=s*r,d=s*a,p=s*c,f=o*r,m=o*a,g=o*c;return t.m00=1-_-p,t.m03=h-g,t.m06=u+m,t.m01=h+g,t.m04=1-l-p,t.m07=d-f,t.m02=u-m,t.m05=d+f,t.m08=1-l-_,t}static inverseTransposeMat4(t,e){const n=e.m00,i=e.m01,s=e.m02,o=e.m03,r=e.m04,a=e.m05,c=e.m06,l=e.m07,h=e.m08,_=e.m09,u=e.m10,d=e.m11,p=e.m12,f=e.m13,m=e.m14,g=e.m15,v=n*a-i*r,y=n*c-s*r,x=n*l-o*r,S=i*c-s*a,T=i*l-o*a,E=s*l-o*c,A=h*f-_*p,C=h*m-u*p,b=h*g-d*p,P=_*m-u*f,w=_*g-d*f,D=u*g-d*m;let I=v*D-y*w+x*P+S*b-T*C+E*A;return I?(I=1/I,t.m00=(a*D-c*w+l*P)*I,t.m01=(c*b-r*D-l*C)*I,t.m02=(r*w-a*b+l*A)*I,t.m03=(s*w-i*D-o*P)*I,t.m04=(n*D-s*b+o*C)*I,t.m05=(i*b-n*w-o*A)*I,t.m06=(f*E-m*T+g*S)*I,t.m07=(m*x-p*E-g*y)*I,t.m08=(p*T-f*x+g*v)*I,t):null}static toArray(t,e,n=0){return t[n+0]=e.m00,t[n+1]=e.m01,t[n+2]=e.m02,t[n+3]=e.m03,t[n+4]=e.m04,t[n+5]=e.m05,t[n+6]=e.m06,t[n+7]=e.m07,t[n+8]=e.m08,t}static fromArray(t,e,n=0){return t.m00=e[n+0],t.m01=e[n+1],t.m02=e[n+2],t.m03=e[n+3],t.m04=e[n+4],t.m05=e[n+5],t.m06=e[n+6],t.m07=e[n+7],t.m08=e[n+8],t}static add(t,e,n){return t.m00=e.m00+n.m00,t.m01=e.m01+n.m01,t.m02=e.m02+n.m02,t.m03=e.m03+n.m03,t.m04=e.m04+n.m04,t.m05=e.m05+n.m05,t.m06=e.m06+n.m06,t.m07=e.m07+n.m07,t.m08=e.m08+n.m08,t}static subtract(t,e,n){return t.m00=e.m00-n.m00,t.m01=e.m01-n.m01,t.m02=e.m02-n.m02,t.m03=e.m03-n.m03,t.m04=e.m04-n.m04,t.m05=e.m05-n.m05,t.m06=e.m06-n.m06,t.m07=e.m07-n.m07,t.m08=e.m08-n.m08,t}static multiplyScalar(t,e,n){return t.m00=e.m00*n,t.m01=e.m01*n,t.m02=e.m02*n,t.m03=e.m03*n,t.m04=e.m04*n,t.m05=e.m05*n,t.m06=e.m06*n,t.m07=e.m07*n,t.m08=e.m08*n,t}static multiplyScalarAndAdd(t,e,n,i){return t.m00=n.m00*i+e.m00,t.m01=n.m01*i+e.m01,t.m02=n.m02*i+e.m02,t.m03=n.m03*i+e.m03,t.m04=n.m04*i+e.m04,t.m05=n.m05*i+e.m05,t.m06=n.m06*i+e.m06,t.m07=n.m07*i+e.m07,t.m08=n.m08*i+e.m08,t}static strictEquals(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08}static equals(t,e,n=be){return Math.abs(t.m00-e.m00)<=n*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=n*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=n*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=n*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=n*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=n*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=n*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=n*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=n*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))}constructor(t=1,e=0,n=0,i=0,s=1,o=0,r=0,a=0,c=1){super(),"object"==typeof t?(this.m00=t.m00,this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08):(this.m00=t,this.m01=e,this.m02=n,this.m03=i,this.m04=s,this.m05=o,this.m06=r,this.m07=a,this.m08=c)}clone(){const t=this;return new nn(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)}set(t=1,e=0,n=0,i=0,s=1,o=0,r=0,a=0,c=1){return"object"==typeof t?(this.m00=t.m00,this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08):(this.m00=t,this.m01=e,this.m02=n,this.m03=i,this.m04=s,this.m05=o,this.m06=r,this.m07=a,this.m08=c),this}equals(t,e=be){return Math.abs(this.m00-t.m00)<=e*Math.max(1,Math.abs(this.m00),Math.abs(t.m00))&&Math.abs(this.m01-t.m01)<=e*Math.max(1,Math.abs(this.m01),Math.abs(t.m01))&&Math.abs(this.m02-t.m02)<=e*Math.max(1,Math.abs(this.m02),Math.abs(t.m02))&&Math.abs(this.m03-t.m03)<=e*Math.max(1,Math.abs(this.m03),Math.abs(t.m03))&&Math.abs(this.m04-t.m04)<=e*Math.max(1,Math.abs(this.m04),Math.abs(t.m04))&&Math.abs(this.m05-t.m05)<=e*Math.max(1,Math.abs(this.m05),Math.abs(t.m05))&&Math.abs(this.m06-t.m06)<=e*Math.max(1,Math.abs(this.m06),Math.abs(t.m06))&&Math.abs(this.m07-t.m07)<=e*Math.max(1,Math.abs(this.m07),Math.abs(t.m07))&&Math.abs(this.m08-t.m08)<=e*Math.max(1,Math.abs(this.m08),Math.abs(t.m08))}strictEquals(t){return this.m00===t.m00&&this.m01===t.m01&&this.m02===t.m02&&this.m03===t.m03&&this.m04===t.m04&&this.m05===t.m05&&this.m06===t.m06&&this.m07===t.m07&&this.m08===t.m08}toString(){const t=this;return`[\n${t.m00}, ${t.m01}, ${t.m02},\n${t.m03},\n${t.m04}, ${t.m05},\n${t.m06}, ${t.m07},\n${t.m08}\n]`}identity(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this}transpose(){const t=this.m01,e=this.m02,n=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=t,this.m05=this.m07,this.m06=e,this.m07=n,this}invert(){const t=this.m00,e=this.m01,n=this.m02,i=this.m03,s=this.m04,o=this.m05,r=this.m06,a=this.m07,c=this.m08,l=c*s-o*a,h=-c*i+o*r,_=a*i-s*r;let u=t*l+e*h+n*_;return 0===u?(this.set(0,0,0,0,0,0,0,0,0),this):(u=1/u,this.m00=l*u,this.m01=(-c*e+n*a)*u,this.m02=(o*e-n*s)*u,this.m03=h*u,this.m04=(c*t-n*r)*u,this.m05=(-o*t+n*i)*u,this.m06=_*u,this.m07=(-a*t+e*r)*u,this.m08=(s*t-e*i)*u,this)}determinant(){const t=this.m00,e=this.m01,n=this.m02,i=this.m03,s=this.m04,o=this.m05,r=this.m06,a=this.m07,c=this.m08;return t*(c*s-o*a)+e*(-c*i+o*r)+n*(a*i-s*r)}add(t){return this.m00+=t.m00,this.m01+=t.m01,this.m02+=t.m02,this.m03+=t.m03,this.m04+=t.m04,this.m05+=t.m05,this.m06+=t.m06,this.m07+=t.m07,this.m08+=t.m08,this}subtract(t){return this.m00-=t.m00,this.m01-=t.m01,this.m02-=t.m02,this.m03-=t.m03,this.m04-=t.m04,this.m05-=t.m05,this.m06-=t.m06,this.m07-=t.m07,this.m08-=t.m08,this}multiply(t){const e=this.m00,n=this.m01,i=this.m02,s=this.m03,o=this.m04,r=this.m05,a=this.m06,c=this.m07,l=this.m08,h=t.m00,_=t.m01,u=t.m02,d=t.m03,p=t.m04,f=t.m05,m=t.m06,g=t.m07,v=t.m08;return this.m00=h*e+_*s+u*a,this.m01=h*n+_*o+u*c,this.m02=h*i+_*r+u*l,this.m03=d*e+p*s+f*a,this.m04=d*n+p*o+f*c,this.m05=d*i+p*r+f*l,this.m06=m*e+g*s+v*a,this.m07=m*n+g*o+v*c,this.m08=m*i+g*r+v*l,this}multiplyScalar(t){return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=t,this.m05*=t,this.m06*=t,this.m07*=t,this.m08*=t,this}scale(t){const e=t.x,n=t.y;return this.m00=e*this.m00,this.m01=e*this.m01,this.m02=e*this.m02,this.m03=n*this.m03,this.m04=n*this.m04,this.m05=n*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this}rotate(t){const e=this.m00,n=this.m01,i=this.m02,s=this.m03,o=this.m04,r=this.m05,a=this.m06,c=this.m07,l=this.m08,h=Math.sin(t),_=Math.cos(t);return this.m00=_*e+h*s,this.m01=_*n+h*o,this.m02=_*i+h*r,this.m03=_*s-h*e,this.m04=_*o-h*n,this.m05=_*r-h*i,this.m06=a,this.m07=c,this.m08=l,this}fromQuat(t){const e=t.x,n=t.y,i=t.z,s=t.w,o=e+e,r=n+n,a=i+i,c=e*o,l=n*o,h=n*r,_=i*o,u=i*r,d=i*a,p=s*o,f=s*r,m=s*a;return this.m00=1-h-d,this.m03=l-m,this.m06=_+f,this.m01=l+m,this.m04=1-c-d,this.m07=u-p,this.m02=_-f,this.m05=u+p,this.m08=1-c-h,this}}t("Mat3",nn),nn.IDENTITY=Object.freeze(new nn);const sn=new $e,on=new $e;Se.fastDefine("cc.Mat3",nn,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),i.Mat3=nn;class rn extends Nt{static clone(t){return new rn(t.x,t.y,t.z,t.w)}static copy(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}static set(t,e,n,i,s){return t.x=e,t.y=n,t.z=i,t.w=s,t}static identity(t){return t.x=0,t.y=0,t.z=0,t.w=1,t}static rotationTo(t,e,n){const i=$e.dot(e,n);return i<-.999999?($e.cross(ln,$e.UNIT_X,e),ln.length()<1e-6&&$e.cross(ln,$e.UNIT_Y,e),$e.normalize(ln,ln),rn.fromAxisAngle(t,ln,Math.PI),t):i>.999999?(t.x=0,t.y=0,t.z=0,t.w=1,t):($e.cross(ln,e,n),t.x=ln.x,t.y=ln.y,t.z=ln.z,t.w=1+i,rn.normalize(t,t))}static getAxisAngle(t,e){const n=2*Math.acos(e.w),i=Math.sin(n/2);return 0!==i?(t.x=e.x/i,t.y=e.y/i,t.z=e.z/i):(t.x=1,t.y=0,t.z=0),n}static multiply(t,e,n){const i=e.x*n.w+e.w*n.x+e.y*n.z-e.z*n.y,s=e.y*n.w+e.w*n.y+e.z*n.x-e.x*n.z,o=e.z*n.w+e.w*n.z+e.x*n.y-e.y*n.x,r=e.w*n.w-e.x*n.x-e.y*n.y-e.z*n.z;return t.x=i,t.y=s,t.z=o,t.w=r,t}static multiplyScalar(t,e,n){return t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t.w=e.w*n,t}static scaleAndAdd(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t.z=e.z+n.z*i,t.w=e.w+n.w*i,t}static rotateX(t,e,n){n*=.5;const i=Math.sin(n),s=Math.cos(n),{x:o,y:r,z:a,w:c}=e;return t.x=o*s+c*i,t.y=r*s+a*i,t.z=a*s-r*i,t.w=c*s-o*i,t}static rotateY(t,e,n){n*=.5;const i=Math.sin(n),s=Math.cos(n),{x:o,y:r,z:a,w:c}=e;return t.x=o*s-a*i,t.y=r*s+c*i,t.z=a*s+o*i,t.w=c*s-r*i,t}static rotateZ(t,e,n){n*=.5;const i=Math.sin(n),s=Math.cos(n),{x:o,y:r,z:a,w:c}=e;return t.x=o*s+r*i,t.y=r*s-o*i,t.z=a*s+c*i,t.w=c*s-a*i,t}static rotateAround(t,e,n,i){return rn.invert(an,e),$e.transformQuat(ln,n,an),rn.fromAxisAngle(an,ln,i),rn.multiply(t,e,an),t}static rotateAroundLocal(t,e,n,i){return rn.fromAxisAngle(an,n,i),rn.multiply(t,e,an),t}static calculateW(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=Math.sqrt(Math.abs(1-e.x*e.x-e.y*e.y-e.z*e.z)),t}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}static lerp(t,e,n,i){return t.x=e.x+i*(n.x-e.x),t.y=e.y+i*(n.y-e.y),t.z=e.z+i*(n.z-e.z),t.w=e.w+i*(n.w-e.w),t}static slerp(t,e,n,i){let s=0,o=0,r=n.x,a=n.y,c=n.z,l=n.w,h=e.x*n.x+e.y*n.y+e.z*n.z+e.w*n.w;if(h<0&&(h=-h,r=-r,a=-a,c=-c,l=-l),1-h>1e-6){const t=Math.acos(h),e=Math.sin(t);s=Math.sin((1-i)*t)/e,o=Math.sin(i*t)/e}else s=1-i,o=i;return t.x=s*e.x+o*r,t.y=s*e.y+o*a,t.z=s*e.z+o*c,t.w=s*e.w+o*l,t}static sqlerp(t,e,n,i,s,o){return rn.slerp(an,e,s,o),rn.slerp(cn,n,i,o),rn.slerp(t,an,cn,2*o*(1-o)),t}static invert(t,e){const n=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w,i=n?1/n:0;return t.x=-e.x*i,t.y=-e.y*i,t.z=-e.z*i,t.w=e.w*i,t}static conjugate(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=e.w,t}static len(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w)}static lengthSqr(t){return t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w}static normalize(t,e){let n=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;return n>0&&(n=1/Math.sqrt(n),t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t.w=e.w*n),t}static fromAxes(t,e,n,i){return nn.set(hn,e.x,e.y,e.z,n.x,n.y,n.z,i.x,i.y,i.z),rn.normalize(t,rn.fromMat3(t,hn))}static fromViewUp(t,e,n){return nn.fromViewUp(hn,e,n),rn.normalize(t,rn.fromMat3(t,hn))}static fromAxisAngle(t,e,n){n*=.5;const i=Math.sin(n);return t.x=i*e.x,t.y=i*e.y,t.z=i*e.z,t.w=Math.cos(n),t}static fromMat3(t,e){const{m00:n,m03:i,m06:s,m01:o,m04:r,m07:a,m02:c,m05:l,m08:h}=e,_=n+r+h;if(_>0){const e=.5/Math.sqrt(_+1);t.w=.25/e,t.x=(l-a)*e,t.y=(s-c)*e,t.z=(o-i)*e}else if(n>r&&n>h){const e=2*Math.sqrt(1+n-r-h);t.w=(l-a)/e,t.x=.25*e,t.y=(i+o)/e,t.z=(s+c)/e}else if(r>h){const e=2*Math.sqrt(1+r-n-h);t.w=(s-c)/e,t.x=(i+o)/e,t.y=.25*e,t.z=(a+l)/e}else{const e=2*Math.sqrt(1+h-n-r);t.w=(o-i)/e,t.x=(s+c)/e,t.y=(a+l)/e,t.z=.25*e}return t}static fromEuler(t,e,n,i){e*=_n,n*=_n,i*=_n;const s=Math.sin(e),o=Math.cos(e),r=Math.sin(n),a=Math.cos(n),c=Math.sin(i),l=Math.cos(i);return t.x=s*a*l+o*r*c,t.y=o*r*l+s*a*c,t.z=o*a*c-s*r*l,t.w=o*a*l-s*r*c,t}static fromAngleZ(t,e){return e*=_n,t.x=t.y=0,t.z=Math.sin(e),t.w=Math.cos(e),t}static toAxisX(t,e){const n=2*e.y,i=2*e.z;return t.x=1-n*e.y-i*e.z,t.y=n*e.x+i*e.w,t.z=i*e.x+n*e.w,t}static toAxisY(t,e){const n=2*e.x,i=2*e.y,s=2*e.z;return t.x=i*e.x-s*e.w,t.y=1-n*e.x-s*e.z,t.z=s*e.y+n*e.w,t}static toAxisZ(t,e){const n=2*e.x,i=2*e.y,s=2*e.z;return t.x=s*e.x-i*e.w,t.y=s*e.y-n*e.w,t.z=1-n*e.x-i*e.y,t}static toEuler(t,e,n){const{x:i,y:s,z:o,w:r}=e;let a=0,c=0,l=0;const h=i*s+o*r;if(h>.499999)a=0,c=Me(2*Math.atan2(i,r)),l=90;else if(h<-.499999)a=0,c=-Me(2*Math.atan2(i,r)),l=-90;else{const t=i*i,e=s*s,_=o*o;a=Me(Math.atan2(2*i*r-2*s*o,1-2*t-2*_)),c=Me(Math.atan2(2*s*r-2*i*o,1-2*e-2*_)),l=Me(Math.asin(2*h)),n&&(a=-180*Math.sign(a+1e-6)+a,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return t.x=a,t.y=c,t.z=l,t}static toArray(t,e,n=0){return t[n+0]=e.x,t[n+1]=e.y,t[n+2]=e.z,t[n+3]=e.w,t}static fromArray(t,e,n=0){return t.x=e[n+0],t.y=e[n+1],t.z=e[n+2],t.w=e[n+3],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w}static equals(t,e,n=be){return Math.abs(t.x-e.x)<=n*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=n*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=n*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=n*Math.max(1,Math.abs(t.w),Math.abs(e.w))}constructor(t,e,n,i){super(),t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=n||0,this.w=null!=i?i:1)}clone(){return new rn(this.x,this.y,this.z,this.w)}set(t,e,n,i){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=n||0,this.w=null!=i?i:1),this}equals(t,e=be){return Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))&&Math.abs(this.w-t.w)<=e*Math.max(1,Math.abs(this.w),Math.abs(t.w))}strictEquals(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}getEulerAngles(t){return rn.toEuler(t,this)}lerp(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this.z+=e*(t.z-this.z),this.w+=e*(t.w-this.w),this}slerp(t,e){return rn.slerp(this,this,t,e)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSqr(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}}t("Quat",rn),rn.IDENTITY=Object.freeze(new rn);const an=new rn,cn=new rn,ln=new $e,hn=new nn,_n=.5*Math.PI/180;function un(t=0,e=0,n=0,i=1){return new rn(t,e,n,i)}Se.fastDefine("cc.Quat",rn,{x:0,y:0,z:0,w:1}),i.Quat=rn,i.quat=un;const dn=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]);class pn extends Nt{static clone(t){return new pn(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08,t.m09,t.m10,t.m11,t.m12,t.m13,t.m14,t.m15)}static copy(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t}static set(t,e,n,i,s,o,r,a,c,l,h,_,u,d,p,f,m){return t.m00=e,t.m01=n,t.m02=i,t.m03=s,t.m04=o,t.m05=r,t.m06=a,t.m07=c,t.m08=l,t.m09=h,t.m10=_,t.m11=u,t.m12=d,t.m13=p,t.m14=f,t.m15=m,t}static identity(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static transpose(t,e){if(t===e){const n=e.m01,i=e.m02,s=e.m03,o=e.m06,r=e.m07,a=e.m11;t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=n,t.m06=e.m09,t.m07=e.m13,t.m08=i,t.m09=o,t.m11=e.m14,t.m12=s,t.m13=r,t.m14=a}else t.m00=e.m00,t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=e.m01,t.m05=e.m05,t.m06=e.m09,t.m07=e.m13,t.m08=e.m02,t.m09=e.m06,t.m10=e.m10,t.m11=e.m14,t.m12=e.m03,t.m13=e.m07,t.m14=e.m11,t.m15=e.m15;return t}static invert(t,e){const n=e.m00,i=e.m01,s=e.m02,o=e.m03,r=e.m04,a=e.m05,c=e.m06,l=e.m07,h=e.m08,_=e.m09,u=e.m10,d=e.m11,p=e.m12,f=e.m13,m=e.m14,g=e.m15,v=n*a-i*r,y=n*c-s*r,x=n*l-o*r,S=i*c-s*a,T=i*l-o*a,E=s*l-o*c,A=h*f-_*p,C=h*m-u*p,b=h*g-d*p,P=_*m-u*f,w=_*g-d*f,D=u*g-d*m;let I=v*D-y*w+x*P+S*b-T*C+E*A;return 0===I?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=0,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=0,t):(I=1/I,t.m00=(a*D-c*w+l*P)*I,t.m01=(s*w-i*D-o*P)*I,t.m02=(f*E-m*T+g*S)*I,t.m03=(u*T-_*E-d*S)*I,t.m04=(c*b-r*D-l*C)*I,t.m05=(n*D-s*b+o*C)*I,t.m06=(m*x-p*E-g*y)*I,t.m07=(h*E-u*x+d*y)*I,t.m08=(r*w-a*b+l*A)*I,t.m09=(i*b-n*w-o*A)*I,t.m10=(p*T-f*x+g*v)*I,t.m11=(_*x-h*T-d*v)*I,t.m12=(a*C-r*P-c*A)*I,t.m13=(n*P-i*C+s*A)*I,t.m14=(f*y-p*S-m*v)*I,t.m15=(h*S-_*y+u*v)*I,t)}static determinant(t){const e=t.m00,n=t.m01,i=t.m02,s=t.m03,o=t.m04,r=t.m05,a=t.m06,c=t.m07,l=t.m08,h=t.m09,_=t.m10,u=t.m11,d=t.m12,p=t.m13,f=t.m14,m=t.m15;return(e*r-n*o)*(_*m-u*f)-(e*a-i*o)*(h*m-u*p)+(e*c-s*o)*(h*f-_*p)+(n*a-i*r)*(l*m-u*d)-(n*c-s*r)*(l*f-_*d)+(i*c-s*a)*(l*p-h*d)}static multiply(t,e,n){const i=e.m00,s=e.m01,o=e.m02,r=e.m03,a=e.m04,c=e.m05,l=e.m06,h=e.m07,_=e.m08,u=e.m09,d=e.m10,p=e.m11,f=e.m12,m=e.m13,g=e.m14,v=e.m15;let y=n.m00,x=n.m01,S=n.m02,T=n.m03;return t.m00=y*i+x*a+S*_+T*f,t.m01=y*s+x*c+S*u+T*m,t.m02=y*o+x*l+S*d+T*g,t.m03=y*r+x*h+S*p+T*v,y=n.m04,x=n.m05,S=n.m06,T=n.m07,t.m04=y*i+x*a+S*_+T*f,t.m05=y*s+x*c+S*u+T*m,t.m06=y*o+x*l+S*d+T*g,t.m07=y*r+x*h+S*p+T*v,y=n.m08,x=n.m09,S=n.m10,T=n.m11,t.m08=y*i+x*a+S*_+T*f,t.m09=y*s+x*c+S*u+T*m,t.m10=y*o+x*l+S*d+T*g,t.m11=y*r+x*h+S*p+T*v,y=n.m12,x=n.m13,S=n.m14,T=n.m15,t.m12=y*i+x*a+S*_+T*f,t.m13=y*s+x*c+S*u+T*m,t.m14=y*o+x*l+S*d+T*g,t.m15=y*r+x*h+S*p+T*v,t}static transform(t,e,n){const i=n.x,s=n.y,o=n.z;if(e===t)t.m12=e.m00*i+e.m04*s+e.m08*o+e.m12,t.m13=e.m01*i+e.m05*s+e.m09*o+e.m13,t.m14=e.m02*i+e.m06*s+e.m10*o+e.m14,t.m15=e.m03*i+e.m07*s+e.m11*o+e.m15;else{const n=e.m00,r=e.m01,a=e.m02,c=e.m03,l=e.m04,h=e.m05,_=e.m06,u=e.m07,d=e.m08,p=e.m09,f=e.m10,m=e.m11;e.m12,e.m13,e.m14,e.m15,t.m00=n,t.m01=r,t.m02=a,t.m03=c,t.m04=l,t.m05=h,t.m06=_,t.m07=u,t.m08=d,t.m09=p,t.m10=f,t.m11=m,t.m12=n*i+l*s+d*o+e.m12,t.m13=r*i+h*s+p*o+e.m13,t.m14=a*i+_*s+f*o+e.m14,t.m15=c*i+u*s+m*o+e.m15}return t}static translate(t,e,n){return console.warn("function changed"),e===t?(t.m12+=n.x,t.m13+=n.y,t.m14+=n.z):(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12+=n.x,t.m13+=n.y,t.m14+=n.z,t.m15=e.m15),t}static scale(t,e,n){const i=n.x,s=n.y,o=n.z;return t.m00=e.m00*i,t.m01=e.m01*i,t.m02=e.m02*i,t.m03=e.m03*i,t.m04=e.m04*s,t.m05=e.m05*s,t.m06=e.m06*s,t.m07=e.m07*s,t.m08=e.m08*o,t.m09=e.m09*o,t.m10=e.m10*o,t.m11=e.m11*o,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t}static rotate(t,e,n,i){let s=i.x,o=i.y,r=i.z,a=Math.sqrt(s*s+o*o+r*r);if(Math.abs(a)<be)return null;a=1/a,s*=a,o*=a,r*=a;const c=Math.sin(n),l=Math.cos(n),h=1-l,_=e.m00,u=e.m01,d=e.m02,p=e.m03,f=e.m04,m=e.m05,g=e.m06,v=e.m07,y=e.m08,x=e.m09,S=e.m10,T=e.m11,E=s*s*h+l,A=o*s*h+r*c,C=r*s*h-o*c,b=s*o*h-r*c,P=o*o*h+l,w=r*o*h+s*c,D=s*r*h+o*c,I=o*r*h-s*c,R=r*r*h+l;return t.m00=_*E+f*A+y*C,t.m01=u*E+m*A+x*C,t.m02=d*E+g*A+S*C,t.m03=p*E+v*A+T*C,t.m04=_*b+f*P+y*w,t.m05=u*b+m*P+x*w,t.m06=d*b+g*P+S*w,t.m07=p*b+v*P+T*w,t.m08=_*D+f*I+y*R,t.m09=u*D+m*I+x*R,t.m10=d*D+g*I+S*R,t.m11=p*D+v*I+T*R,e!==t&&(t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t}static rotateX(t,e,n){const i=Math.sin(n),s=Math.cos(n),o=e.m04,r=e.m05,a=e.m06,c=e.m07,l=e.m08,h=e.m09,_=e.m10,u=e.m11;return e!==t&&(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m04=o*s+l*i,t.m05=r*s+h*i,t.m06=a*s+_*i,t.m07=c*s+u*i,t.m08=l*s-o*i,t.m09=h*s-r*i,t.m10=_*s-a*i,t.m11=u*s-c*i,t}static rotateY(t,e,n){const i=Math.sin(n),s=Math.cos(n),o=e.m00,r=e.m01,a=e.m02,c=e.m03,l=e.m08,h=e.m09,_=e.m10,u=e.m11;return e!==t&&(t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=o*s-l*i,t.m01=r*s-h*i,t.m02=a*s-_*i,t.m03=c*s-u*i,t.m08=o*i+l*s,t.m09=r*i+h*s,t.m10=a*i+_*s,t.m11=c*i+u*s,t}static rotateZ(t,e,n){const i=Math.sin(n),s=Math.cos(n),o=e.m00,r=e.m01,a=e.m02,c=e.m03,l=e.m04,h=e.m05,_=e.m06,u=e.m07;return e!==t&&(t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=o*s+l*i,t.m01=r*s+h*i,t.m02=a*s+_*i,t.m03=c*s+u*i,t.m04=l*s-o*i,t.m05=h*s-r*i,t.m06=_*s-a*i,t.m07=u*s-c*i,t}static fromTranslation(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=e.x,t.m13=e.y,t.m14=e.z,t.m15=1,t}static fromScaling(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=e.y,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=e.z,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromRotation(t,e,n){let i=n.x,s=n.y,o=n.z,r=Math.sqrt(i*i+s*s+o*o);if(Math.abs(r)<be)return null;r=1/r,i*=r,s*=r,o*=r;const a=Math.sin(e),c=Math.cos(e),l=1-c;return t.m00=i*i*l+c,t.m01=s*i*l+o*a,t.m02=o*i*l-s*a,t.m03=0,t.m04=i*s*l-o*a,t.m05=s*s*l+c,t.m06=o*s*l+i*a,t.m07=0,t.m08=i*o*l+s*a,t.m09=s*o*l-i*a,t.m10=o*o*l+c,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromXRotation(t,e){const n=Math.sin(e),i=Math.cos(e);return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=i,t.m06=n,t.m07=0,t.m08=0,t.m09=-n,t.m10=i,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromYRotation(t,e){const n=Math.sin(e),i=Math.cos(e);return t.m00=i,t.m01=0,t.m02=-n,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=n,t.m09=0,t.m10=i,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromZRotation(t,e){const n=Math.sin(e),i=Math.cos(e);return t.m00=i,t.m01=n,t.m02=0,t.m03=0,t.m04=-n,t.m05=i,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromRT(t,e,n){const i=e.x,s=e.y,o=e.z,r=e.w,a=i+i,c=s+s,l=o+o,h=i*a,_=i*c,u=i*l,d=s*c,p=s*l,f=o*l,m=r*a,g=r*c,v=r*l;return t.m00=1-(d+f),t.m01=_+v,t.m02=u-g,t.m03=0,t.m04=_-v,t.m05=1-(h+f),t.m06=p+m,t.m07=0,t.m08=u+g,t.m09=p-m,t.m10=1-(h+d),t.m11=0,t.m12=n.x,t.m13=n.y,t.m14=n.z,t.m15=1,t}static getTranslation(t,e){return t.x=e.m12,t.y=e.m13,t.z=e.m14,t}static getScaling(t,e){const n=mn.m00=e.m00,i=mn.m01=e.m01,s=mn.m02=e.m02,o=mn.m03=e.m04,r=mn.m04=e.m05,a=mn.m05=e.m06,c=mn.m06=e.m08,l=mn.m07=e.m09,h=mn.m08=e.m10;return t.x=Math.sqrt(n*n+i*i+s*s),t.y=Math.sqrt(o*o+r*r+a*a),t.z=Math.sqrt(c*c+l*l+h*h),nn.determinant(mn)<0&&(t.x*=-1),t}static getRotation(t,e){const n=e.m00+e.m05+e.m10;let i=0;return n>0?(i=2*Math.sqrt(n+1),t.w=.25*i,t.x=(e.m06-e.m09)/i,t.y=(e.m08-e.m02)/i,t.z=(e.m01-e.m04)/i):e.m00>e.m05&&e.m00>e.m10?(i=2*Math.sqrt(1+e.m00-e.m05-e.m10),t.w=(e.m06-e.m09)/i,t.x=.25*i,t.y=(e.m01+e.m04)/i,t.z=(e.m08+e.m02)/i):e.m05>e.m10?(i=2*Math.sqrt(1+e.m05-e.m00-e.m10),t.w=(e.m08-e.m02)/i,t.x=(e.m01+e.m04)/i,t.y=.25*i,t.z=(e.m06+e.m09)/i):(i=2*Math.sqrt(1+e.m10-e.m00-e.m05),t.w=(e.m01-e.m04)/i,t.x=(e.m08+e.m02)/i,t.y=(e.m06+e.m09)/i,t.z=.25*i),t}static toRTS(t,e,n,i){i.x=$e.set(fn,t.m00,t.m01,t.m02).length(),mn.m00=t.m00/i.x,mn.m01=t.m01/i.x,mn.m02=t.m02/i.x,i.y=$e.set(fn,t.m04,t.m05,t.m06).length(),mn.m03=t.m04/i.y,mn.m04=t.m05/i.y,mn.m05=t.m06/i.y,i.z=$e.set(fn,t.m08,t.m09,t.m10).length(),mn.m06=t.m08/i.z,mn.m07=t.m09/i.z,mn.m08=t.m10/i.z,nn.determinant(mn)<0&&(i.x*=-1,mn.m00*=-1,mn.m01*=-1,mn.m02*=-1),rn.fromMat3(e,mn),$e.set(n,t.m12,t.m13,t.m14)}static fromRTS(t,e,n,i){const s=e.x,o=e.y,r=e.z,a=e.w,c=s+s,l=o+o,h=r+r,_=s*c,u=s*l,d=s*h,p=o*l,f=o*h,m=r*h,g=a*c,v=a*l,y=a*h,x=i.x,S=i.y,T=i.z;return t.m00=(1-(p+m))*x,t.m01=(u+y)*x,t.m02=(d-v)*x,t.m03=0,t.m04=(u-y)*S,t.m05=(1-(_+m))*S,t.m06=(f+g)*S,t.m07=0,t.m08=(d+v)*T,t.m09=(f-g)*T,t.m10=(1-(_+p))*T,t.m11=0,t.m12=n.x,t.m13=n.y,t.m14=n.z,t.m15=1,t}static fromRTSOrigin(t,e,n,i,s){const o=e.x,r=e.y,a=e.z,c=e.w,l=o+o,h=r+r,_=a+a,u=o*l,d=o*h,p=o*_,f=r*h,m=r*_,g=a*_,v=c*l,y=c*h,x=c*_,S=i.x,T=i.y,E=i.z,A=s.x,C=s.y,b=s.z;return t.m00=(1-(f+g))*S,t.m01=(d+x)*S,t.m02=(p-y)*S,t.m03=0,t.m04=(d-x)*T,t.m05=(1-(u+g))*T,t.m06=(m+v)*T,t.m07=0,t.m08=(p+y)*E,t.m09=(m-v)*E,t.m10=(1-(u+f))*E,t.m11=0,t.m12=n.x+A-(t.m00*A+t.m04*C+t.m08*b),t.m13=n.y+C-(t.m01*A+t.m05*C+t.m09*b),t.m14=n.z+b-(t.m02*A+t.m06*C+t.m10*b),t.m15=1,t}static fromQuat(t,e){const n=e.x,i=e.y,s=e.z,o=e.w,r=n+n,a=i+i,c=s+s,l=n*r,h=i*r,_=i*a,u=s*r,d=s*a,p=s*c,f=o*r,m=o*a,g=o*c;return t.m00=1-_-p,t.m01=h+g,t.m02=u-m,t.m03=0,t.m04=h-g,t.m05=1-l-p,t.m06=d+f,t.m07=0,t.m08=u+m,t.m09=d-f,t.m10=1-l-_,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static frustum(t,e,n,i,s,o,r){const a=1/(n-e),c=1/(s-i),l=1/(o-r);return t.m00=2*o*a,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=2*o*c,t.m06=0,t.m07=0,t.m08=(n+e)*a,t.m09=(s+i)*c,t.m10=(r+o)*l,t.m11=-1,t.m12=0,t.m13=0,t.m14=r*o*2*l,t.m15=0,t}static perspective(t,e,n,i,s,o=!0,r=-1,a=1,c=0){const l=1/Math.tan(e/2),h=1/(i-s),_=o?l/n:l,u=(o?l:l*n)*a,d=dn[c];return t.m00=_*d[0],t.m01=_*d[1],t.m02=0,t.m03=0,t.m04=u*d[2],t.m05=u*d[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=(s-r*i)*h,t.m11=-1,t.m12=0,t.m13=0,t.m14=s*i*h*(1-r),t.m15=0,t}static ortho(t,e,n,i,s,o,r,a=-1,c=1,l=0){const h=1/(e-n),_=1/(i-s)*c,u=1/(o-r),d=-2*h,p=-2*_,f=(e+n)*h,m=(s+i)*_,g=dn[l];return t.m00=d*g[0],t.m01=d*g[1],t.m02=0,t.m03=0,t.m04=p*g[2],t.m05=p*g[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=u*(1-a),t.m11=0,t.m12=f*g[0]+m*g[2],t.m13=f*g[1]+m*g[3],t.m14=(o-a*r)*u,t.m15=1,t}static lookAt(t,e,n,i){const s=e.x,o=e.y,r=e.z,a=i.x,c=i.y,l=i.z;let h=s-n.x,_=o-n.y,u=r-n.z,d=1/Math.sqrt(h*h+_*_+u*u);h*=d,_*=d,u*=d;let p=c*u-l*_,f=l*h-a*u,m=a*_-c*h;d=1/Math.sqrt(p*p+f*f+m*m),p*=d,f*=d,m*=d;const g=_*m-u*f,v=u*p-h*m,y=h*f-_*p;return t.m00=p,t.m01=g,t.m02=h,t.m03=0,t.m04=f,t.m05=v,t.m06=_,t.m07=0,t.m08=m,t.m09=y,t.m10=u,t.m11=0,t.m12=-(p*s+f*o+m*r),t.m13=-(g*s+v*o+y*r),t.m14=-(h*s+_*o+u*r),t.m15=1,t}static inverseTranspose(t,e){const n=e.m00,i=e.m01,s=e.m02,o=e.m03,r=e.m04,a=e.m05,c=e.m06,l=e.m07,h=e.m08,_=e.m09,u=e.m10,d=e.m11,p=e.m12,f=e.m13,m=e.m14,g=e.m15,v=n*a-i*r,y=n*c-s*r,x=n*l-o*r,S=i*c-s*a,T=i*l-o*a,E=s*l-o*c,A=h*f-_*p,C=h*m-u*p,b=h*g-d*p,P=_*m-u*f,w=_*g-d*f,D=u*g-d*m;let I=v*D-y*w+x*P+S*b-T*C+E*A;return I?(I=1/I,t.m00=(a*D-c*w+l*P)*I,t.m01=(c*b-r*D-l*C)*I,t.m02=(r*w-a*b+l*A)*I,t.m03=0,t.m04=(s*w-i*D-o*P)*I,t.m05=(n*D-s*b+o*C)*I,t.m06=(i*b-n*w-o*A)*I,t.m07=0,t.m08=(f*E-m*T+g*S)*I,t.m09=(m*x-p*E-g*y)*I,t.m10=(p*T-f*x+g*v)*I,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t):null}static toArray(t,e,n=0){return t[n+0]=e.m00,t[n+1]=e.m01,t[n+2]=e.m02,t[n+3]=e.m03,t[n+4]=e.m04,t[n+5]=e.m05,t[n+6]=e.m06,t[n+7]=e.m07,t[n+8]=e.m08,t[n+9]=e.m09,t[n+10]=e.m10,t[n+11]=e.m11,t[n+12]=e.m12,t[n+13]=e.m13,t[n+14]=e.m14,t[n+15]=e.m15,t}static fromArray(t,e,n=0){return t.m00=e[n+0],t.m01=e[n+1],t.m02=e[n+2],t.m03=e[n+3],t.m04=e[n+4],t.m05=e[n+5],t.m06=e[n+6],t.m07=e[n+7],t.m08=e[n+8],t.m09=e[n+9],t.m10=e[n+10],t.m11=e[n+11],t.m12=e[n+12],t.m13=e[n+13],t.m14=e[n+14],t.m15=e[n+15],t}static add(t,e,n){return t.m00=e.m00+n.m00,t.m01=e.m01+n.m01,t.m02=e.m02+n.m02,t.m03=e.m03+n.m03,t.m04=e.m04+n.m04,t.m05=e.m05+n.m05,t.m06=e.m06+n.m06,t.m07=e.m07+n.m07,t.m08=e.m08+n.m08,t.m09=e.m09+n.m09,t.m10=e.m10+n.m10,t.m11=e.m11+n.m11,t.m12=e.m12+n.m12,t.m13=e.m13+n.m13,t.m14=e.m14+n.m14,t.m15=e.m15+n.m15,t}static subtract(t,e,n){return t.m00=e.m00-n.m00,t.m01=e.m01-n.m01,t.m02=e.m02-n.m02,t.m03=e.m03-n.m03,t.m04=e.m04-n.m04,t.m05=e.m05-n.m05,t.m06=e.m06-n.m06,t.m07=e.m07-n.m07,t.m08=e.m08-n.m08,t.m09=e.m09-n.m09,t.m10=e.m10-n.m10,t.m11=e.m11-n.m11,t.m12=e.m12-n.m12,t.m13=e.m13-n.m13,t.m14=e.m14-n.m14,t.m15=e.m15-n.m15,t}static multiplyScalar(t,e,n){return t.m00=e.m00*n,t.m01=e.m01*n,t.m02=e.m02*n,t.m03=e.m03*n,t.m04=e.m04*n,t.m05=e.m05*n,t.m06=e.m06*n,t.m07=e.m07*n,t.m08=e.m08*n,t.m09=e.m09*n,t.m10=e.m10*n,t.m11=e.m11*n,t.m12=e.m12*n,t.m13=e.m13*n,t.m14=e.m14*n,t.m15=e.m15*n,t}static multiplyScalarAndAdd(t,e,n,i){return t.m00=e.m00+n.m00*i,t.m01=e.m01+n.m01*i,t.m02=e.m02+n.m02*i,t.m03=e.m03+n.m03*i,t.m04=e.m04+n.m04*i,t.m05=e.m05+n.m05*i,t.m06=e.m06+n.m06*i,t.m07=e.m07+n.m07*i,t.m08=e.m08+n.m08*i,t.m09=e.m09+n.m09*i,t.m10=e.m10+n.m10*i,t.m11=e.m11+n.m11*i,t.m12=e.m12+n.m12*i,t.m13=e.m13+n.m13*i,t.m14=e.m14+n.m14*i,t.m15=e.m15+n.m15*i,t}static strictEquals(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08&&t.m09===e.m09&&t.m10===e.m10&&t.m11===e.m11&&t.m12===e.m12&&t.m13===e.m13&&t.m14===e.m14&&t.m15===e.m15}static equals(t,e,n=be){return Math.abs(t.m00-e.m00)<=n*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=n*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=n*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=n*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=n*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=n*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=n*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=n*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=n*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))&&Math.abs(t.m09-e.m09)<=n*Math.max(1,Math.abs(t.m09),Math.abs(e.m09))&&Math.abs(t.m10-e.m10)<=n*Math.max(1,Math.abs(t.m10),Math.abs(e.m10))&&Math.abs(t.m11-e.m11)<=n*Math.max(1,Math.abs(t.m11),Math.abs(e.m11))&&Math.abs(t.m12-e.m12)<=n*Math.max(1,Math.abs(t.m12),Math.abs(e.m12))&&Math.abs(t.m13-e.m13)<=n*Math.max(1,Math.abs(t.m13),Math.abs(e.m13))&&Math.abs(t.m14-e.m14)<=n*Math.max(1,Math.abs(t.m14),Math.abs(e.m14))&&Math.abs(t.m15-e.m15)<=n*Math.max(1,Math.abs(t.m15),Math.abs(e.m15))}constructor(t=1,e=0,n=0,i=0,s=0,o=1,r=0,a=0,c=0,l=0,h=1,_=0,u=0,d=0,p=0,f=1){super(),this.m00=void 0,this.m01=void 0,this.m02=void 0,this.m03=void 0,this.m04=void 0,this.m05=void 0,this.m06=void 0,this.m07=void 0,this.m08=void 0,this.m09=void 0,this.m10=void 0,this.m11=void 0,this.m12=void 0,this.m13=void 0,this.m14=void 0,this.m15=void 0,"object"==typeof t?(this.m00=t.m00,this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08,this.m09=t.m09,this.m10=t.m10,this.m11=t.m11,this.m12=t.m12,this.m13=t.m13,this.m14=t.m14,this.m15=t.m15):(this.m00=t,this.m01=e,this.m02=n,this.m03=i,this.m04=s,this.m05=o,this.m06=r,this.m07=a,this.m08=c,this.m09=l,this.m10=h,this.m11=_,this.m12=u,this.m13=d,this.m14=p,this.m15=f)}clone(){return new pn(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)}set(t=1,e=0,n=0,i=0,s=0,o=1,r=0,a=0,c=0,l=0,h=1,_=0,u=0,d=0,p=0,f=1){return"object"==typeof t?(this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08,this.m09=t.m09,this.m10=t.m10,this.m11=t.m11,this.m12=t.m12,this.m13=t.m13,this.m14=t.m14,this.m15=t.m15,this.m00=t.m00):(this.m01=e,this.m02=n,this.m03=i,this.m04=s,this.m05=o,this.m06=r,this.m07=a,this.m08=c,this.m09=l,this.m10=h,this.m11=_,this.m12=u,this.m13=d,this.m14=p,this.m15=f,this.m00=t),this}equals(t,e=be){return Math.abs(this.m00-t.m00)<=e*Math.max(1,Math.abs(this.m00),Math.abs(t.m00))&&Math.abs(this.m01-t.m01)<=e*Math.max(1,Math.abs(this.m01),Math.abs(t.m01))&&Math.abs(this.m02-t.m02)<=e*Math.max(1,Math.abs(this.m02),Math.abs(t.m02))&&Math.abs(this.m03-t.m03)<=e*Math.max(1,Math.abs(this.m03),Math.abs(t.m03))&&Math.abs(this.m04-t.m04)<=e*Math.max(1,Math.abs(this.m04),Math.abs(t.m04))&&Math.abs(this.m05-t.m05)<=e*Math.max(1,Math.abs(this.m05),Math.abs(t.m05))&&Math.abs(this.m06-t.m06)<=e*Math.max(1,Math.abs(this.m06),Math.abs(t.m06))&&Math.abs(this.m07-t.m07)<=e*Math.max(1,Math.abs(this.m07),Math.abs(t.m07))&&Math.abs(this.m08-t.m08)<=e*Math.max(1,Math.abs(this.m08),Math.abs(t.m08))&&Math.abs(this.m09-t.m09)<=e*Math.max(1,Math.abs(this.m09),Math.abs(t.m09))&&Math.abs(this.m10-t.m10)<=e*Math.max(1,Math.abs(this.m10),Math.abs(t.m10))&&Math.abs(this.m11-t.m11)<=e*Math.max(1,Math.abs(this.m11),Math.abs(t.m11))&&Math.abs(this.m12-t.m12)<=e*Math.max(1,Math.abs(this.m12),Math.abs(t.m12))&&Math.abs(this.m13-t.m13)<=e*Math.max(1,Math.abs(this.m13),Math.abs(t.m13))&&Math.abs(this.m14-t.m14)<=e*Math.max(1,Math.abs(this.m14),Math.abs(t.m14))&&Math.abs(this.m15-t.m15)<=e*Math.max(1,Math.abs(this.m15),Math.abs(t.m15))}strictEquals(t){return this.m00===t.m00&&this.m01===t.m01&&this.m02===t.m02&&this.m03===t.m03&&this.m04===t.m04&&this.m05===t.m05&&this.m06===t.m06&&this.m07===t.m07&&this.m08===t.m08&&this.m09===t.m09&&this.m10===t.m10&&this.m11===t.m11&&this.m12===t.m12&&this.m13===t.m13&&this.m14===t.m14&&this.m15===t.m15}toString(){return`[\n${this.m00}, ${this.m01}, ${this.m02}, ${this.m03},\n${this.m04}, ${this.m05}, ${this.m06}, ${this.m07},\n${this.m08}, ${this.m09}, ${this.m10}, ${this.m11},\n${this.m12}, ${this.m13}, ${this.m14}, ${this.m15}\n]`}identity(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}zero(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this}transpose(){const t=this.m01,e=this.m02,n=this.m03,i=this.m06,s=this.m07,o=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=t,this.m06=this.m09,this.m07=this.m13,this.m08=e,this.m09=i,this.m11=this.m14,this.m12=n,this.m13=s,this.m14=o,this}invert(){const t=this.m00,e=this.m01,n=this.m02,i=this.m03,s=this.m04,o=this.m05,r=this.m06,a=this.m07,c=this.m08,l=this.m09,h=this.m10,_=this.m11,u=this.m12,d=this.m13,p=this.m14,f=this.m15,m=t*o-e*s,g=t*r-n*s,v=t*a-i*s,y=e*r-n*o,x=e*a-i*o,S=n*a-i*r,T=c*d-l*u,E=c*p-h*u,A=c*f-_*u,C=l*p-h*d,b=l*f-_*d,P=h*f-_*p;let w=m*P-g*b+v*C+y*A-x*E+S*T;return 0===w?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(w=1/w,this.m00=(o*P-r*b+a*C)*w,this.m01=(n*b-e*P-i*C)*w,this.m02=(d*S-p*x+f*y)*w,this.m03=(h*x-l*S-_*y)*w,this.m04=(r*A-s*P-a*E)*w,this.m05=(t*P-n*A+i*E)*w,this.m06=(p*v-u*S-f*g)*w,this.m07=(c*S-h*v+_*g)*w,this.m08=(s*b-o*A+a*T)*w,this.m09=(e*A-t*b-i*T)*w,this.m10=(u*x-d*v+f*m)*w,this.m11=(l*v-c*x-_*m)*w,this.m12=(o*E-s*C-r*T)*w,this.m13=(t*C-e*E+n*T)*w,this.m14=(d*g-u*y-p*m)*w,this.m15=(c*y-l*g+h*m)*w,this)}determinant(){const t=this.m00,e=this.m01,n=this.m02,i=this.m03,s=this.m04,o=this.m05,r=this.m06,a=this.m07,c=this.m08,l=this.m09,h=this.m10,_=this.m11,u=this.m12,d=this.m13,p=this.m14,f=this.m15;return(t*o-e*s)*(h*f-_*p)-(t*r-n*s)*(l*f-_*d)+(t*a-i*s)*(l*p-h*d)+(e*r-n*o)*(c*f-_*u)-(e*a-i*o)*(c*p-h*u)+(n*a-i*r)*(c*d-l*u)}add(t){return this.m00+=t.m00,this.m01+=t.m01,this.m02+=t.m02,this.m03+=t.m03,this.m04+=t.m04,this.m05+=t.m05,this.m06+=t.m06,this.m07+=t.m07,this.m08+=t.m08,this.m09+=t.m09,this.m10+=t.m10,this.m11+=t.m11,this.m12+=t.m12,this.m13+=t.m13,this.m14+=t.m14,this.m15+=t.m15,this}subtract(t){return this.m00-=t.m00,this.m01-=t.m01,this.m02-=t.m02,this.m03-=t.m03,this.m04-=t.m04,this.m05-=t.m05,this.m06-=t.m06,this.m07-=t.m07,this.m08-=t.m08,this.m09-=t.m09,this.m10-=t.m10,this.m11-=t.m11,this.m12-=t.m12,this.m13-=t.m13,this.m14-=t.m14,this.m15-=t.m15,this}multiply(t){const e=this.m00,n=this.m01,i=this.m02,s=this.m03,o=this.m04,r=this.m05,a=this.m06,c=this.m07,l=this.m08,h=this.m09,_=this.m10,u=this.m11,d=this.m12,p=this.m13,f=this.m14,m=this.m15;let g=t.m00,v=t.m01,y=t.m02,x=t.m03;return this.m00=g*e+v*o+y*l+x*d,this.m01=g*n+v*r+y*h+x*p,this.m02=g*i+v*a+y*_+x*f,this.m03=g*s+v*c+y*u+x*m,g=t.m04,v=t.m05,y=t.m06,x=t.m07,this.m04=g*e+v*o+y*l+x*d,this.m05=g*n+v*r+y*h+x*p,this.m06=g*i+v*a+y*_+x*f,this.m07=g*s+v*c+y*u+x*m,g=t.m08,v=t.m09,y=t.m10,x=t.m11,this.m08=g*e+v*o+y*l+x*d,this.m09=g*n+v*r+y*h+x*p,this.m10=g*i+v*a+y*_+x*f,this.m11=g*s+v*c+y*u+x*m,g=t.m12,v=t.m13,y=t.m14,x=t.m15,this.m12=g*e+v*o+y*l+x*d,this.m13=g*n+v*r+y*h+x*p,this.m14=g*i+v*a+y*_+x*f,this.m15=g*s+v*c+y*u+x*m,this}multiplyScalar(t){return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=t,this.m05*=t,this.m06*=t,this.m07*=t,this.m08*=t,this.m09*=t,this.m10*=t,this.m11*=t,this.m12*=t,this.m13*=t,this.m14*=t,this.m15*=t,this}translate(t){return console.warn("function changed"),this.m12+=t.x,this.m13+=t.y,this.m14+=t.z,this}scale(t){const e=t.x,n=t.y,i=t.z;return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=n,this.m05*=n,this.m06*=n,this.m07*=n,this.m08*=i,this.m09*=i,this.m10*=i,this.m11*=i,this}rotate(t,e){let n=e.x,i=e.y,s=e.z,o=Math.sqrt(n*n+i*i+s*s);if(Math.abs(o)<be)return null;o=1/o,n*=o,i*=o,s*=o;const r=Math.sin(t),a=Math.cos(t),c=1-a,l=this.m00,h=this.m01,_=this.m02,u=this.m03,d=this.m04,p=this.m05,f=this.m06,m=this.m07,g=this.m08,v=this.m09,y=this.m10,x=this.m11,S=n*n*c+a,T=i*n*c+s*r,E=s*n*c-i*r,A=n*i*c-s*r,C=i*i*c+a,b=s*i*c+n*r,P=n*s*c+i*r,w=i*s*c-n*r,D=s*s*c+a;return this.m00=l*S+d*T+g*E,this.m01=h*S+p*T+v*E,this.m02=_*S+f*T+y*E,this.m03=u*S+m*T+x*E,this.m04=l*A+d*C+g*b,this.m05=h*A+p*C+v*b,this.m06=_*A+f*C+y*b,this.m07=u*A+m*C+x*b,this.m08=l*P+d*w+g*D,this.m09=h*P+p*w+v*D,this.m10=_*P+f*w+y*D,this.m11=u*P+m*w+x*D,this}getTranslation(t){return t.x=this.m12,t.y=this.m13,t.z=this.m14,t}getScale(t){const e=mn.m00=this.m00,n=mn.m01=this.m01,i=mn.m02=this.m02,s=mn.m03=this.m04,o=mn.m04=this.m05,r=mn.m05=this.m06,a=mn.m06=this.m08,c=mn.m07=this.m09,l=mn.m08=this.m10;return t.x=Math.sqrt(e*e+n*n+i*i),t.y=Math.sqrt(s*s+o*o+r*r),t.z=Math.sqrt(a*a+c*c+l*l),nn.determinant(mn)<0&&(t.x*=-1),t}getRotation(t){const e=this.m00+this.m05+this.m10;let n=0;return e>0?(n=2*Math.sqrt(e+1),t.w=.25*n,t.x=(this.m06-this.m09)/n,t.y=(this.m08-this.m02)/n,t.z=(this.m01-this.m04)/n):this.m00>this.m05&&this.m00>this.m10?(n=2*Math.sqrt(1+this.m00-this.m05-this.m10),t.w=(this.m06-this.m09)/n,t.x=.25*n,t.y=(this.m01+this.m04)/n,t.z=(this.m08+this.m02)/n):this.m05>this.m10?(n=2*Math.sqrt(1+this.m05-this.m00-this.m10),t.w=(this.m08-this.m02)/n,t.x=(this.m01+this.m04)/n,t.y=.25*n,t.z=(this.m06+this.m09)/n):(n=2*Math.sqrt(1+this.m10-this.m00-this.m05),t.w=(this.m01-this.m04)/n,t.x=(this.m08+this.m02)/n,t.y=(this.m06+this.m09)/n,t.z=.25*n),t}fromRTS(t,e,n){const i=t.x,s=t.y,o=t.z,r=t.w,a=i+i,c=s+s,l=o+o,h=i*a,_=i*c,u=i*l,d=s*c,p=s*l,f=o*l,m=r*a,g=r*c,v=r*l,y=n.x,x=n.y,S=n.z;return this.m00=(1-(d+f))*y,this.m01=(_+v)*y,this.m02=(u-g)*y,this.m03=0,this.m04=(_-v)*x,this.m05=(1-(h+f))*x,this.m06=(p+m)*x,this.m07=0,this.m08=(u+g)*S,this.m09=(p-m)*S,this.m10=(1-(h+d))*S,this.m11=0,this.m12=e.x,this.m13=e.y,this.m14=e.z,this.m15=1,this}fromQuat(t){const e=t.x,n=t.y,i=t.z,s=t.w,o=e+e,r=n+n,a=i+i,c=e*o,l=n*o,h=n*r,_=i*o,u=i*r,d=i*a,p=s*o,f=s*r,m=s*a;return this.m00=1-h-d,this.m01=l+m,this.m02=_-f,this.m03=0,this.m04=l-m,this.m05=1-c-d,this.m06=u+p,this.m07=0,this.m08=_+f,this.m09=u-p,this.m10=1-c-h,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}}t("Mat4",pn),pn.IDENTITY=Object.freeze(new pn);const fn=new $e,mn=new nn;function gn(t,e,n,i,s,o,r,a,c,l,h,_,u,d,p,f){return new pn(t,e,n,i,s,o,r,a,c,l,h,_,u,d,p,f)}Se.fastDefine("cc.Mat4",pn,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),i.Mat4=pn,i.mat4=gn;class vn{static identity(){return new vn}static clone(t){return new vn(t.a,t.b,t.c,t.d,t.tx,t.ty)}static concat(t,e,n){const i=e.a,s=e.b,o=e.c,r=e.d,a=e.tx,c=e.ty;t.a=i*n.a+s*n.c,t.b=i*n.b+s*n.d,t.c=o*n.a+r*n.c,t.d=o*n.b+r*n.d,t.tx=a*n.a+c*n.c+n.tx,t.ty=a*n.b+c*n.d+n.ty}static invert(t,e){const n=1/(e.a*e.d-e.b*e.c);t.a=n*e.d,t.b=-n*e.b,t.c=-n*e.c,t.d=n*e.a,t.tx=n*(e.c*e.ty-e.d*e.tx),t.ty=n*(e.b*e.tx-e.a*e.ty)}static fromMat4(t,e){t.a=e.m00,t.b=e.m01,t.c=e.m04,t.d=e.m05,t.tx=e.m12,t.ty=e.m13}static transformVec2(t,e,n,i){let s,o;void 0===i?(i=n,s=e.x,o=e.y):(s=e,o=n),t.x=i.a*s+i.c*o+i.tx,t.y=i.b*s+i.d*o+i.ty}static transformSize(t,e,n){t.width=n.a*e.width+n.c*e.height,t.height=n.b*e.width+n.d*e.height}static transformRect(t,e,n){const i=e.x+e.width,s=e.y+e.height,o=n.a*e.x+n.c*e.y+n.tx,r=n.b*e.x+n.d*e.y+n.ty,a=n.a*i+n.c*e.y+n.tx,c=n.b*i+n.d*e.y+n.ty,l=n.a*e.x+n.c*s+n.tx,h=n.b*e.x+n.d*s+n.ty,_=n.a*i+n.c*s+n.tx,u=n.b*i+n.d*s+n.ty,d=Math.min(o,a,l,_),p=Math.max(o,a,l,_),f=Math.min(r,c,h,u),m=Math.max(r,c,h,u);t.x=d,t.y=f,t.width=p-d,t.height=m-f}static transformObb(t,e,n,i,s,o){const r=o.a*s.x+o.c*s.y+o.tx,a=o.b*s.x+o.d*s.y+o.ty,c=o.a*s.width,l=o.b*s.width,h=o.c*s.height,_=o.d*s.height;e.x=r,e.y=a,n.x=c+r,n.y=l+a,t.x=h+r,t.y=_+a,i.x=c+h+r,i.y=l+_+a}constructor(t=1,e=0,n=0,i=1,s=0,o=0){this.a=t,this.b=e,this.c=n,this.d=i,this.tx=s,this.ty=o}}t("AffineTransform",vn),i.AffineTransform=vn;class yn extends Nt{static lerp(t,e,n,i){return t.width=e.width+(n.width-e.width)*i,t.height=e.height+(n.height-e.height)*i,t}set x(t){this.width=t}get x(){return this.width}set y(t){this.height=t}get y(){return this.height}constructor(t,e){super(),t&&"object"==typeof t?(this.width=t.width,this.height=t.height):(this.width=t||0,this.height=e||0)}clone(){return new yn(this.width,this.height)}set(t,e){return t&&"object"==typeof t?(this.height=t.height,this.width=t.width):(this.width=t||0,this.height=e||0),this}equals(t){return this.width===t.width&&this.height===t.height}lerp(t,e){return this.width+=(t.width-this.width)*e,this.height+=(t.height-this.height)*e,this}toString(){return`(${this.width.toFixed(2)}, ${this.height.toFixed(2)})`}}function xn(t=0,e=0){return new yn(t,e)}t("Size",yn),yn.ZERO=Object.freeze(new yn(0,0)),yn.ONE=Object.freeze(new yn(1,1)),Se.fastDefine("cc.Size",yn,{width:0,height:0}),i.size=xn,i.Size=yn;class Sn extends Nt{static fromMinMax(t,e,n){const i=Math.min(e.x,n.x),s=Math.min(e.y,n.y),o=Math.max(e.x,n.x),r=Math.max(e.y,n.y);return t.x=i,t.y=s,t.width=o-i,t.height=r-s,t}static lerp(t,e,n,i){const s=e.x,o=e.y,r=e.width,a=e.height;return t.x=s+(n.x-s)*i,t.y=o+(n.y-o)*i,t.width=r+(n.width-r)*i,t.height=a+(n.height-a)*i,t}static intersection(t,e,n){const i=e.x,s=e.y,o=e.x+e.width,r=e.y+e.height,a=n.x,c=n.y,l=n.x+n.width,h=n.y+n.height;return t.x=Math.max(i,a),t.y=Math.max(s,c),t.width=Math.min(o,l)-t.x,t.height=Math.min(r,h)-t.y,t}static union(t,e,n){const i=e.x,s=e.y,o=e.width,r=e.height,a=n.x,c=n.y,l=n.width,h=n.height;return t.x=Math.min(i,a),t.y=Math.min(s,c),t.width=Math.max(i+o,a+l)-t.x,t.height=Math.max(s+r,c+h)-t.y,t}get xMin(){return this.x}set xMin(t){this.width+=this.x-t,this.x=t}get yMin(){return this.y}set yMin(t){this.height+=this.y-t,this.y=t}get xMax(){return this.x+this.width}set xMax(t){this.width=t-this.x}get yMax(){return this.y+this.height}set yMax(t){this.height=t-this.y}get center(){return new qe(this.x+.5*this.width,this.y+.5*this.height)}set center(t){this.x=t.x-.5*this.width,this.y=t.y-.5*this.height}get origin(){return new qe(this.x,this.y)}set origin(t){this.x=t.x,this.y=t.y}get size(){return new yn(this.width,this.height)}set size(t){this.width=t.width,this.height=t.height}set z(t){this.width=t}get z(){return this.width}set w(t){this.height=t}get w(){return this.height}constructor(t,e,n,i){super(),t&&"object"==typeof t?(this.y=t.y,this.width=t.width,this.height=t.height,this.x=t.x):(this.x=t||0,this.y=e||0,this.width=n||0,this.height=i||0)}clone(){return new Sn(this.x,this.y,this.width,this.height)}set(t,e,n,i){return t&&"object"==typeof t?(this.y=t.y,this.width=t.width,this.height=t.height,this.x=t.x):(this.x=t||0,this.y=e||0,this.width=n||0,this.height=i||0),this}equals(t){return this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height}lerp(t,e){const n=this.x,i=this.y,s=this.width,o=this.height;return this.x=n+(t.x-n)*e,this.y=i+(t.y-i)*e,this.width=s+(t.width-s)*e,this.height=o+(t.height-o)*e,this}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)}, ${this.width.toFixed(2)}, ${this.height.toFixed(2)})`}intersects(t){const e=this.x+this.width,n=this.y+this.height,i=t.x+t.width,s=t.y+t.height;return!(e<t.x||i<this.x||n<t.y||s<this.y)}contains(t){return this.x<=t.x&&this.x+this.width>=t.x&&this.y<=t.y&&this.y+this.height>=t.y}containsRect(t){return this.x<=t.x&&this.x+this.width>=t.x+t.width&&this.y<=t.y&&this.y+this.height>=t.y+t.height}transformMat4(t){const e=this.x,n=this.y,i=e+this.width,s=n+this.height,o=t.m00*e+t.m04*n+t.m12,r=t.m01*e+t.m05*n+t.m13,a=t.m00*i+t.m04*n+t.m12,c=t.m01*i+t.m05*n+t.m13,l=t.m00*e+t.m04*s+t.m12,h=t.m01*e+t.m05*s+t.m13,_=t.m00*i+t.m04*s+t.m12,u=t.m01*i+t.m05*s+t.m13,d=Math.min(o,a,l,_),p=Math.max(o,a,l,_),f=Math.min(r,c,h,u),m=Math.max(r,c,h,u);return this.x=d,this.y=f,this.width=p-d,this.height=m-f,this}transformMat4ToPoints(t,e,n,i,s){const o=this.x,r=this.y,a=o+this.width,c=r+this.height;e.x=t.m00*o+t.m04*r+t.m12,e.y=t.m01*o+t.m05*r+t.m13,s.x=t.m00*a+t.m04*r+t.m12,s.y=t.m01*a+t.m05*r+t.m13,n.x=t.m00*o+t.m04*c+t.m12,n.y=t.m01*o+t.m05*c+t.m13,i.x=t.m00*a+t.m04*c+t.m12,i.y=t.m01*a+t.m05*c+t.m13}}function Tn(t=0,e=0,n=0,i=0){return new Sn(t,e,n,i)}t("Rect",Sn),Se.fastDefine("cc.Rect",Sn,{x:0,y:0,width:0,height:0}),i.Rect=Sn,i.rect=Tn;const En=1/255;class An extends Nt{static clone(t){const e=new An;return t._val?e._val=t._val:e._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,e}static copy(t,e){return t.r=e.r,t.g=e.g,t.b=e.b,t.a=e.a,t}static set(t,e,n,i,s){return t.r=e,t.g=n,t.b=i,t.a=s,t}static fromHEX(t,e){return e=0===e.indexOf("#")?e.substring(1):e,t.r=parseInt(e.substr(0,2),16)||0,t.g=parseInt(e.substr(2,2),16)||0,t.b=parseInt(e.substr(4,2),16)||0,t.a=parseInt(e.substr(6,2),16)||255,t._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,t}static add(t,e,n){return t.r=e.r+n.r,t.g=e.g+n.g,t.b=e.b+n.b,t.a=e.a+n.a,t}static subtract(t,e,n){return t.r=e.r-n.r,t.g=e.g-n.g,t.b=e.b-n.b,t.a=e.a-n.a,t}static multiply(t,e,n){return t.r=e.r*n.r,t.g=e.g*n.g,t.b=e.b*n.b,t.a=e.a*n.a,t}static divide(t,e,n){return t.r=e.r/n.r,t.g=e.g/n.g,t.b=e.b/n.b,t.a=e.a/n.a,t}static scale(t,e,n){return t.r=e.r*n,t.g=e.g*n,t.b=e.b*n,t.a=e.a*n,t}static lerp(t,e,n,i){let s=e.r,o=e.g,r=e.b,a=e.a;return s+=(n.r-s)*i,o+=(n.g-o)*i,r+=(n.b-r)*i,a+=(n.a-a)*i,t._val=Math.floor((a<<24>>>0)+(r<<16)+(o<<8)+s),t}static toArray(t,e,n=0){const i=e instanceof An||e.a>1?1/255:1;return t[n+0]=e.r*i,t[n+1]=e.g*i,t[n+2]=e.b*i,t[n+3]=e.a*i,t}static fromArray(t,e,n=0){return e.r=255*t[n+0],e.g=255*t[n+1],e.b=255*t[n+2],e.a=255*t[n+3],e}static strictEquals(t,e){return t.r===e.r&&t.g===e.g&&t.b===e.b&&t.a===e.a}static equals(t,e,n=be){return Math.abs(t.r-e.r)<=n*Math.max(1,Math.abs(t.r),Math.abs(e.r))&&Math.abs(t.g-e.g)<=n*Math.max(1,Math.abs(t.g),Math.abs(e.g))&&Math.abs(t.b-e.b)<=n*Math.max(1,Math.abs(t.b),Math.abs(e.b))&&Math.abs(t.a-e.a)<=n*Math.max(1,Math.abs(t.a),Math.abs(e.a))}static hex(t){return(255*t.r<<24|255*t.g<<16|255*t.b<<8|255*t.a)>>>0}get r(){return 255&this._val}set r(t){t=~~De(t,0,255),this._val=(4294967040&this._val|t)>>>0}get g(){return(65280&this._val)>>8}set g(t){t=~~De(t,0,255),this._val=(4294902015&this._val|t<<8)>>>0}get b(){return(16711680&this._val)>>16}set b(t){t=~~De(t,0,255),this._val=(4278255615&this._val|t<<16)>>>0}get a(){return(4278190080&this._val)>>>24}set a(t){t=~~De(t,0,255),this._val=(16777215&this._val|t<<24)>>>0}get x(){return this.r*En}set x(t){this.r=255*t}get y(){return this.g*En}set y(t){this.g=255*t}get z(){return this.b*En}set z(t){this.b=255*t}get w(){return this.a*En}set w(t){this.a=255*t}constructor(t,e,n,i){super(),this._val=0,"string"==typeof t?this.fromHEX(t):void 0!==e?this.set(t,e,n,i):this.set(t)}clone(){const t=new An;return t._val=this._val,t}equals(t){return t&&this._val===t._val}lerp(t,e){let n=this.r,i=this.g,s=this.b,o=this.a;return n+=(t.r-n)*e,i+=(t.g-i)*e,s+=(t.b-s)*e,o+=(t.a-o)*e,this._val=Math.floor((o<<24>>>0)+(s<<16)+(i<<8)+n),this}toString(){return`rgba(${this.r.toFixed()}, ${this.g.toFixed()}, ${this.b.toFixed()}, ${this.a.toFixed()})`}toCSS(t="rgba"){return"rgba"===t?`rgba(${this.r},${this.g},${this.b},${(this.a*En).toFixed(2)})`:"rgb"===t?`rgb(${this.r},${this.g},${this.b})`:`#${this.toHEX(t)}`}fromHEX(t){t=0===t.indexOf("#")?t.substring(1):t;const e=parseInt(t.substr(0,2),16)||0,n=parseInt(t.substr(2,2),16)||0,i=parseInt(t.substr(4,2),16)||0,s=parseInt(t.substr(6,2),16)||255;return this._val=(s<<24>>>0)+(i<<16)+(n<<8)+(0|e),this}toHEX(t="#rrggbb"){const e="0",n=[(this.r<16?e:"")+this.r.toString(16),(this.g<16?e:"")+this.g.toString(16),(this.b<16?e:"")+this.b.toString(16)];return"#rgb"===t?(n[0]=n[0][0],n[1]=n[1][0],n[2]=n[2][0]):"#rrggbbaa"===t&&n.push((this.a<16?e:"")+this.a.toString(16)),n.join("")}toRGBValue(){return 16777215&this._val}fromHSV(t,e,n){let i=0,s=0,o=0;if(0===e)i=s=o=n;else if(0===n)i=s=o=0;else{1===t&&(t=0),t*=6;const r=Math.floor(t),a=t-r,c=n*(1-e),l=n*(1-e*a),h=n*(1-e*(1-a));switch(r){case 0:i=n,s=h,o=c;break;case 1:i=l,s=n,o=c;break;case 2:i=c,s=n,o=h;break;case 3:i=c,s=l,o=n;break;case 4:i=h,s=c,o=n;break;case 5:i=n,s=c,o=l}}return i*=255,s*=255,o*=255,this._val=(this.a<<24>>>0)+(o<<16)+(s<<8)+(0|i),this}toHSV(){const t=this.r*En,e=this.g*En,n=this.b*En,i={h:0,s:0,v:0},s=Math.max(t,e,n),o=Math.min(t,e,n);let r=0;return i.v=s,i.s=s?(s-o)/s:0,i.s?(r=s-o,i.h=t===s?(e-n)/r:e===s?2+(n-t)/r:4+(t-e)/r,i.h/=6,i.h<0&&(i.h+=1)):i.h=0,i}set(t,e,n,i){return"object"==typeof t?null!=t._val?this._val=t._val:(e=t.g||0,n=t.b||0,i="number"==typeof t.a?t.a:255,t=t.r||0,this._val=(i<<24>>>0)+(n<<16)+(e<<8)+(0|t)):(t=t||0,e=e||0,n=n||0,i="number"==typeof i?i:255,this._val=(i<<24>>>0)+(n<<16)+(e<<8)+(0|t)),this}multiply(t){const e=(255&this._val)*t.r>>8,n=(65280&this._val)*t.g>>8,i=(16711680&this._val)*t.b>>8,s=((4278190080&this._val)>>>8)*t.a;return this._val=4278190080&s|16711680&i|65280&n|255&e,this}_set_r_unsafe(t){return this._val=(4294967040&this._val|t)>>>0,this}_set_g_unsafe(t){return this._val=(4294902015&this._val|t<<8)>>>0,this}_set_b_unsafe(t){return this._val=(4278255615&this._val|t<<16)>>>0,this}_set_a_unsafe(t){return this._val=(16777215&this._val|t<<24)>>>0,this}}function Cn(t,e,n,i){return new An(t,e,n,i)}t("Color",An),An.WHITE=Object.freeze(new An(255,255,255,255)),An.GRAY=Object.freeze(new An(127,127,127,255)),An.BLACK=Object.freeze(new An(0,0,0,255)),An.TRANSPARENT=Object.freeze(new An(0,0,0,0)),An.RED=Object.freeze(new An(255,0,0,255)),An.GREEN=Object.freeze(new An(0,255,0,255)),An.BLUE=Object.freeze(new An(0,0,255,255)),An.CYAN=Object.freeze(new An(0,255,255,255)),An.MAGENTA=Object.freeze(new An(255,0,255,255)),An.YELLOW=Object.freeze(new An(255,255,0,255)),Se.fastDefine("cc.Color",An,{r:0,g:0,b:0,a:255}),i.Color=An,i.color=Cn;var bn=Object.freeze({__proto__:null,bits:L,Vec2:qe,v2:Ke,Vec3:$e,v3:Qe,Vec4:tn,v4:en,Quat:rn,quat:un,Mat3:nn,Mat4:pn,mat4:gn,AffineTransform:vn,Size:yn,size:xn,Rect:Sn,rect:Tn,Color:An,color:Cn,EPSILON:be,equals:Pe,approx:we,clamp:De,clamp01:Ie,lerp:Re,toRadian:Oe,toDegree:Me,random:Ne,randomRange:Le,randomRangeInt:Be,pseudoRandom:Fe,pseudoRandomRange:ze,pseudoRandomRangeInt:Ue,nextPow2:He,repeat:Ge,pingPong:Ve,inverseLerp:je,absMaxComponent:We,absMax:ke});t("math",bn);class Pn{constructor(t,e){this._ctor=void 0,this._elementsPerBatch=void 0,this._nextAvail=void 0,this._freepool=[],this._ctor=t,this._elementsPerBatch=Math.max(e,1),this._nextAvail=this._elementsPerBatch-1;for(let e=0;e<this._elementsPerBatch;++e)this._freepool.push(t())}alloc(){if(this._nextAvail<0){const t=this._elementsPerBatch;for(let e=0;e<t;e++)this._freepool.push(this._ctor());this._nextAvail=t-1}const t=this._freepool[this._nextAvail--];return this._freepool.length--,t}free(t){this._freepool.push(t),this._nextAvail++}freeArray(t){Array.prototype.push.apply(this._freepool,t),this._nextAvail+=t.length}destroy(t){if(t)for(let e=0;e<=this._nextAvail;e++)t(this._freepool[e]);this._freepool.length=0,this._nextAvail=-1}}t("Pool",Pn);class wn{constructor(t,e){this._fn=void 0,this._count=0,this._data=void 0,this._fn=t,this._data=new Array(e);for(let n=0;n<e;++n)this._data[n]=t()}get length(){return this._count}get data(){return this._data}reset(){this._count=0}resize(t){if(t>this._data.length)for(let e=this._data.length;e<t;++e)this._data[e]=this._fn()}add(){return this._count>=this._data.length&&this.resize(2*this._data.length),this._data[this._count++]}removeAt(t){if(t>=this._count)return;const e=this._count-1,n=this._data[t];this._data[t]=this._data[e],this._data[e]=n,this._count-=1}}t("RecyclePool",wn);class Dn{constructor(t,e){this.array=void 0,this.length=0,this._compareFn=void 0,this.array=new Array(t),this.length=0,this._compareFn=void 0!==e?e:(t,e)=>t-e}push(t){this.array[this.length++]=t}pop(){return this.array[--this.length]}get(t){return this.array[t]}clear(){this.length=0}destroy(){this.length=0,this.array.length=0}sort(){this.array.length=this.length,this.array.sort(this._compareFn)}concat(t){for(let e=0;e<t.length;++e)this.array[this.length++]=t[e]}fastRemove(t){if(t>=this.length||t<0)return;const e=--this.length;this.array[t]=this.array[e]}indexOf(t){return this.array.indexOf(t)}}t("CachedArray",Dn),t("memop",Object.freeze({__proto__:null,Pool:Pn,RecyclePool:wn,CachedArray:Dn}));const In=[];class Rn{static _deferredDestroy(){const t=In.length;for(let e=0;e<t;++e){const t=In[e];1&t._objFlags||t._destroyImmediate()}t===In.length?In.length=0:In.splice(0,t)}constructor(t=""){this._objFlags=void 0,this._name=void 0,this._name=t,this._objFlags=0}get name(){return this._name}set name(t){this._name=t}set hideFlags(t){const e=t&Rn.Flags.AllHideMasks;this._objFlags=this._objFlags&~Rn.Flags.AllHideMasks|e}get hideFlags(){return this._objFlags&Rn.Flags.AllHideMasks}get isValid(){return!(1&this._objFlags)}destroy(){return 1&this._objFlags?(E(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,In.push(this),0))}_destruct(){const t=this.constructor;let e=t.__destruct__;e||(e=function(t,e){const n=t instanceof i._BaseNode||t instanceof i.Component,s=n?"_id":null;let o;const r={};for(o in t)if(t.hasOwnProperty(o)){if(o===s)continue;switch(typeof t[o]){case"string":r[o]="";break;case"object":case"function":r[o]=null}}if(Se._isCCClass(e)){const t=i.Class.Attr.getClassAttrs(e),s=e.__props__;for(let e=0;e<s.length;e++){o=s[e];const a=`${o+i.Class.Attr.DELIMETER}default`;if(a in t){if(n&&"_id"===o)continue;switch(typeof t[a]){case"string":r[o]="";break;case"object":case"function":r[o]=null;break;case"undefined":r[o]=void 0}}}}{let t="";for(o in r){let e;e=Se.IDENTIFIER_RE.test(o)?`o.${o}=`:`o[${Se.escapeForJS(o)}]=`;let n=r[o];""===n&&(n='""'),t+=`${e+n};\n`}return Function("o",t)}}(this,t),K(t,"__destruct__",e,!0)),e(this)}_destroyImmediate(){1&this._objFlags?C(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)}}t("CCObject",Rn);const On=Rn.prototype;function Mn(t,e){return"object"==typeof t?!(!t||t._objFlags&(e?5:1)):void 0!==t}On._deserialize=null,On._onPreDestroy=null,Se.fastDefine("cc.Object",Rn,{_name:"",_objFlags:0}),K(Rn,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),i.isValid=Mn,i.Object=Rn;const Nn=Pt.fastRemoveAt;function Ln(){}class Bn{constructor(){this.callback=Ln,this.target=void 0,this.once=!1}set(t,e,n){this.callback=t||Ln,this.target=e,this.once=!!n}reset(){this.target=void 0,this.callback=Ln,this.once=!1}check(){return!(this.target instanceof Rn&&!Mn(this.target,!0))}}const Fn=new Pn((()=>new Bn),32);class zn{constructor(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}removeByCallback(t){for(let e=0;e<this.callbackInfos.length;++e){const n=this.callbackInfos[e];n&&n.callback===t&&(n.reset(),Fn.free(n),Nn(this.callbackInfos,e),--e)}}removeByTarget(t){for(let e=0;e<this.callbackInfos.length;++e){const n=this.callbackInfos[e];n&&n.target===t&&(n.reset(),Fn.free(n),Nn(this.callbackInfos,e),--e)}}cancel(t){const e=this.callbackInfos[t];e&&(e.reset(),this.isInvoking?this.callbackInfos[t]=null:Nn(this.callbackInfos,t),Fn.free(e)),this.containCanceled=!0}cancelAll(){for(let t=0;t<this.callbackInfos.length;t++){const e=this.callbackInfos[t];e&&(e.reset(),Fn.free(e),this.callbackInfos[t]=null)}this.containCanceled=!0}purgeCanceled(){for(let t=this.callbackInfos.length-1;t>=0;--t)this.callbackInfos[t]||Nn(this.callbackInfos,t);this.containCanceled=!1}clear(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1}}const Un=new Pn((()=>new zn),16);class Hn{constructor(){this._callbackTable=Q(!0)}on(t,e,n,i){if(!this.hasEventListener(t,e,n)){let s=this._callbackTable[t];s||(s=this._callbackTable[t]=Un.alloc());const o=Fn.alloc();o.set(e,n,i),s.callbackInfos.push(o)}return e}hasEventListener(t,e,n){const i=this._callbackTable&&this._callbackTable[t];if(!i)return!1;const s=i.callbackInfos;if(!e){if(i.isInvoking){for(let t=0;t<s.length;++t)if(s[t])return!0;return!1}return s.length>0}for(let t=0;t<s.length;++t){const i=s[t];if(i&&i.check()&&i.callback===e&&i.target===n)return!0}return!1}removeAll(t){if("string"==typeof t){const e=this._callbackTable&&this._callbackTable[t];e&&(e.isInvoking?e.cancelAll():(e.clear(),Un.free(e),delete this._callbackTable[t]))}else if(t)for(const e in this._callbackTable){const n=this._callbackTable[e];if(n.isInvoking){const e=n.callbackInfos;for(let i=0;i<e.length;++i){const s=e[i];s&&s.target===t&&n.cancel(i)}}else n.removeByTarget(t)}}off(t,e,n){const i=this._callbackTable&&this._callbackTable[t];if(i){const s=i.callbackInfos;if(e)for(let t=0;t<s.length;++t){const o=s[t];if(o&&o.callback===e&&o.target===n){i.cancel(t);break}}else this.removeAll(t)}}emit(t,e,n,i,s,o){const r=this._callbackTable&&this._callbackTable[t];if(r){const a=!r.isInvoking;r.isInvoking=!0;const c=r.callbackInfos;for(let r=0,a=c.length;r<a;++r){const a=c[r];if(a){const r=a.callback,c=a.target;a.once&&this.off(t,r,c),a.check()?c?r.call(c,e,n,i,s,o):r(e,n,i,s,o):this.off(t,r,c)}}a&&(r.isInvoking=!1,r.containCanceled&&r.purgeCanceled())}}clear(){for(const t in this._callbackTable){const e=this._callbackTable[t];e&&(e.clear(),Un.free(e),delete this._callbackTable[t])}}}function Gn(t){class e extends t{constructor(...t){super(...t),this._callbackTable=Q(!0)}once(t,e,n){return this.on(t,e,n,!0)}targetOff(t){this.removeAll(t)}}const n=Hn.prototype,i=Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n));for(let t=0;t<i.length;++t){const s=i[t];if(!(s in e.prototype)){const t=Object.getOwnPropertyDescriptor(n,s);t&&Object.defineProperty(e.prototype,s,t)}}return e}const Vn=t("EventTarget",Gn(class{}));let jn,Wn,kn,qn,Xn,Yn,Kn;i.EventTarget=Vn,function(t){t.UNKNOWN="unknown",t.WECHAT="wechat",t.ANDROID="androidbrowser",t.IE="ie",t.EDGE="edge",t.QQ="qqbrowser",t.MOBILE_QQ="mqqbrowser",t.UC="ucbrowser",t.UCBS="ucbs",t.BROWSER_360="360browser",t.BAIDU_APP="baiduboxapp",t.BAIDU="baidubrowser",t.MAXTHON="maxthon",t.OPERA="opera",t.OUPENG="oupeng",t.MIUI="miuibrowser",t.FIREFOX="firefox",t.SAFARI="safari",t.CHROME="chrome",t.LIEBAO="liebao",t.QZONE="qzone",t.SOUGOU="sogou",t.HUAWEI="huawei"}(jn||(jn={})),function(t){t.HIDE="hide",t.SHOW="show",t.RESIZE="resize",t.ORIENTATION_CHANGE="orientation_change"}(Wn||(Wn={})),function(t){t.UNKNOWN="unknown",t.ENGLISH="en",t.CHINESE="zh",t.FRENCH="fr",t.ITALIAN="it",t.GERMAN="de",t.SPANISH="es",t.DUTCH="du",t.RUSSIAN="ru",t.KOREAN="ko",t.JAPANESE="ja",t.HUNGARIAN="hu",t.PORTUGUESE="pt",t.ARABIC="ar",t.NORWEGIAN="no",t.POLISH="pl",t.TURKISH="tr",t.UKRAINIAN="uk",t.ROMANIAN="ro",t.BULGARIAN="bg"}(kn||(kn={})),function(t){t[t.NONE=0]="NONE",t[t.LAN=1]="LAN",t[t.WWAN=2]="WWAN"}(qn||(qn={})),function(t){t.UNKNOWN="Unknown",t.IOS="iOS",t.ANDROID="Android",t.WINDOWS="Windows",t.LINUX="Linux",t.OSX="OS X"}(Xn||(Xn={})),function(t){t[t.PORTRAIT=1]="PORTRAIT",t[t.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",t[t.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",t[t.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",t[t.LANDSCAPE=12]="LANDSCAPE"}(Yn||(Yn={})),function(t){t.UNKNOWN="UNKNOWN",t.EDITOR_PAGE="EDITOR_PAGE",t.EDITOR_CORE="EDITOR_CORE",t.MOBILE_BROWSER="MOBILE_BROWSER",t.DESKTOP_BROWSER="DESKTOP_BROWSER",t.WIN32="WIN32",t.ANDROID="ANDROID",t.IOS="IOS",t.MACOS="MACOS",t.WECHAT_GAME="WECHAT_GAME",t.BAIDU_MINI_GAME="BAIDU_MINI_GAME",t.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",t.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",t.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",t.OPPO_MINI_GAME="OPPO_MINI_GAME",t.VIVO_MINI_GAME="VIVO_MINI_GAME",t.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",t.COCOSPLAY="COCOSPLAY",t.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",t.QTT_MINI_GAME="QTT_MINI_GAME"}(Kn||(Kn={}));const $n={0:Yn.PORTRAIT,"-90":Yn.LANDSCAPE_LEFT,90:Yn.LANDSCAPE_RIGHT,180:Yn.PORTRAIT_UPSIDE_DOWN},Zn={},Jn={0:Kn.WIN32,2:Kn.MACOS,3:Kn.ANDROID,4:Kn.IOS,5:Kn.IOS},Qn=new class{get networkType(){return Zn[jsb.device.getNetworkType()]}constructor(){this.isNative=void 0,this.isBrowser=void 0,this.isMobile=void 0,this.isLittleEndian=void 0,this.platform=void 0,this.language=void 0,this.nativeLanguage=void 0,this.os=void 0,this.osVersion=void 0,this.osMainVersion=void 0,this.browserType=void 0,this.browserVersion=void 0,this.pixelRatio=void 0,this.supportCapability=void 0,this._eventTarget=new Vn,this.isNative=!0,this.isBrowser=!1,this.platform=Jn[__getPlatform()],this.isMobile=this.platform===Kn.ANDROID||this.platform===Kn.IOS,this.isLittleEndian=(()=>{const t=new ArrayBuffer(2);return new DataView(t).setInt16(0,256,!0),256===new Int16Array(t)[0]})();const t=__getCurrentLanguageCode();this.nativeLanguage=t?t.toLowerCase():kn.UNKNOWN,this.language=__getCurrentLanguage(),this.os=__getOS(),this.osVersion=__getOSVersion(),this.osMainVersion=parseInt(this.osVersion),this.browserType=jn.UNKNOWN,this.browserVersion="",this.pixelRatio=jsb.device.getDevicePixelRatio()||1,this.supportCapability={webp:!0,gl:!0,canvas:!0,imageBitmap:!1},this._registerEvent()}_registerEvent(){jsb.onResize=t=>{0!==t.width&&0!==t.height&&(t.width/=this.pixelRatio,t.height/=this.pixelRatio,window.resize(t.width,t.height),this._eventTarget.emit(Wn.RESIZE))},jsb.onOrientationChanged=()=>{this._eventTarget.emit(Wn.ORIENTATION_CHANGE)},jsb.onPause=()=>{this._eventTarget.emit(Wn.HIDE)},jsb.onResume=()=>{this._eventTarget.emit(Wn.SHOW)}}getViewSize(){return new yn(window.innerWidth,window.innerHeight)}getOrientation(){return $n[jsb.device.getDeviceOrientation()]}getSafeAreaEdge(){const t=jsb.device.getSafeAreaEdge();let e=t.x,n=t.z,i=t.y,s=t.w;return this.getOrientation()===Yn.PORTRAIT?e<n?e=n:n=e:i<s?i=s:s=i,{top:e,bottom:n,left:i,right:s}}getBatteryLevel(){return jsb.device.getBatteryLevel()}triggerGC(){jsb.garbageCollect()}openURL(t){jsb.openURL(t)}now(){return Date.now?Date.now():+new Date}restartJSVM(){__restartVM()}onHide(t){this._eventTarget.on(Wn.HIDE,t)}onShow(t){this._eventTarget.on(Wn.SHOW,t)}onViewResize(t){this._eventTarget.on(Wn.RESIZE,t)}onOrientationChange(t){this._eventTarget.on(Wn.ORIENTATION_CHANGE,t)}offHide(t){this._eventTarget.off(Wn.HIDE,t)}offShow(t){this._eventTarget.off(Wn.SHOW,t)}offViewResize(t){this._eventTarget.off(Wn.RESIZE,t)}offOrientationChange(t){this._eventTarget.off(Wn.ORIENTATION_CHANGE,t)}},ti=/(\.[^\.\/\?\\]*)(\?.*)?$/,ei=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,ni=/[^\.\/]+\/\.\.\//;function ii(...t){let e="";for(const n of t)e=(e+(""===e?"":"/")+n).replace(/(\/|\\\\)$/,"");return e}function si(t){const e=ti.exec(t);return e?e[1]:""}function oi(t){if(t){const e=t.lastIndexOf(".");if(-1!==e)return t.substring(0,e)}return t}function ri(t,e){const n=t.indexOf("?");n>0&&(t=t.substring(0,n));const i=/(\/|\\)([^\/\\]+)$/g.exec(t.replace(/(\/|\\)$/,""));if(!i)return t;const s=i[2];return e&&t.substring(t.length-e.length).toLowerCase()===e.toLowerCase()?s.substring(0,s.length-e.length):s}function ai(t){const e=ei.exec(t);return e?e[2]:""}function ci(t,e){e=e||"";let n=t.indexOf("?"),i="";return n>0&&(i=t.substring(n),t=t.substring(0,n)),n=t.lastIndexOf("."),n<0?t+e+i:t.substring(0,n)+e+i}function li(t,e,n){if(0===e.indexOf("."))return ci(t,e);let i=t.indexOf("?"),s="";const o=n?si(t):"";return i>0&&(s=t.substring(i),t=t.substring(0,i)),i=t.lastIndexOf("/"),i=i<=0?0:i+1,t.substring(0,i)+e+o+s}function hi(t){let e=t=String(t);do{e=t,t=t.replace(ni,"")}while(e.length!==t.length);return t}function _i(t){return t.replace(/[\/\\]$/,"")}function ui(){return Qn.os===Xn.WINDOWS?"\\":"/"}t("path",Object.freeze({__proto__:null,join:ii,extname:si,mainFileName:oi,basename:ri,dirname:ai,changeExtname:ci,changeBasename:li,_normalize:hi,stripSep:_i,getSeperator:ui})),i.log=u,i.warn=d,i.error=p,i.assert=f,i._throw=v,i.logID=S,i.warnID=E,i.errorID=C,i.assertID=P,i.debug=O,i.path={join:ii,extname:si,mainFileName:oi,basename:ri,dirname:ai,changeExtname:ci,changeBasename:li,_normalize:hi,stripSep:_i,get sep(){return ui()}};let di=0;const pi={};var fi={addStage(t){if(void 0!==pi[t])return;const e=1<<di;pi[t]=e,di+=1},stageID(t){const e=pi[t];return void 0===e?-1:e},stageIDs(t){let e=0;for(const n of t){const t=pi[n];void 0!==t&&(e|=t)}return e}};const mi=jsb.NativeBufferPool,gi=jsb.NativeObjectPool,vi=jsb.NativeBufferAllocator;var yi;!function(t){t[t.UINT32=0]="UINT32",t[t.FLOAT32=1]="FLOAT32",t[t.NEVER=2]="NEVER"}(yi||(yi={}));class xi{constructor(t,e,n,i=8){this._dataType=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freelists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=n.COUNT,this._entryBits=i,this._dataType=e,this._stride=4*this._elementCount,this._entriesPerChunk=1<<i,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new mi(t,i,this._stride);let s=yi.NEVER,o=!1,r=!1;for(const t in e){if(o=this._hasFloat32,r=this._hasUint32,r&&o)break;s=e[t],o||s!==yi.FLOAT32?r||s!==yi.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}alloc(){let t=0;for(;t<this._freelists.length;t++){const e=this._freelists[t];if(e.length){const n=e[e.length-1];return e.length--,(t<<this._entryBits)+n+this._poolFlag}}const e=this._nativePool.allocateNewChunk(),n=[],i=[],s=[],o=this._hasFloat32,r=this._hasUint32;for(let t=0;t<this._entriesPerChunk;t++)o&&n.push(new Float32Array(e,this._stride*t,this._elementCount)),r&&i.push(new Uint32Array(e,this._stride*t,this._elementCount)),t&&s.push(t);return this._arrayBuffers.push(e),r&&this._uint32BufferViews.push(i),o&&this._float32BufferViews.push(n),this._freelists.push(s),(t<<this._entryBits)+this._poolFlag}get(t,e){const n=(this._chunkMask&t)>>this._entryBits,i=this._entryMask&t;return(this._dataType[e]===yi.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][i][e]}set(t,e,n){const i=(this._chunkMask&t)>>this._entryBits,s=this._entryMask&t;(this._dataType[e]===yi.UINT32?this._uint32BufferViews:this._float32BufferViews)[i][s][e]=n}setVec2(t,e,n){const i=(this._chunkMask&t)>>this._entryBits,s=this._entryMask&t;let o=e;const r=(this._dataType[e]===yi.UINT32?this._uint32BufferViews:this._float32BufferViews)[i][s];r[o++]=n.x,r[o++]=n.y}setVec3(t,e,n){const i=(this._chunkMask&t)>>this._entryBits,s=this._entryMask&t;let o=e;const r=(this._dataType[e]===yi.UINT32?this._uint32BufferViews:this._float32BufferViews)[i][s];r[o++]=n.x,r[o++]=n.y,r[o]=n.z}getVec3(t,e,n){const i=(this._chunkMask&t)>>this._entryBits,s=this._entryMask&t;let o=e;const r=(this._dataType[e]===yi.UINT32?this._uint32BufferViews:this._float32BufferViews)[i][s];n.x=r[o++],n.y=r[o++],n.z=r[o]}setVec4(t,e,n){const i=(this._chunkMask&t)>>this._entryBits,s=this._entryMask&t;let o=e;const r=(this._dataType[e]===yi.UINT32?this._uint32BufferViews:this._float32BufferViews)[i][s];r[o++]=n.x,r[o++]=n.y,r[o++]=n.z,r[o]=n.w}getVec4(t,e,n){const i=(this._chunkMask&t)>>this._entryBits,s=this._entryMask&t;let o=e;const r=(this._dataType[e]===yi.UINT32?this._uint32BufferViews:this._float32BufferViews)[i][s];n.x=r[o++],n.y=r[o++],n.z=r[o++],n.w=r[o]}setMat4(t,e,n){const i=(this._chunkMask&t)>>this._entryBits,s=this._entryMask&t;let o=e;const r=(this._dataType[e]===yi.UINT32?this._uint32BufferViews:this._float32BufferViews)[i][s];r[o++]=n.m00,r[o++]=n.m01,r[o++]=n.m02,r[o++]=n.m03,r[o++]=n.m04,r[o++]=n.m05,r[o++]=n.m06,r[o++]=n.m07,r[o++]=n.m08,r[o++]=n.m09,r[o++]=n.m10,r[o++]=n.m11,r[o++]=n.m12,r[o++]=n.m13,r[o++]=n.m14,r[o]=n.m15}free(t){const e=(this._chunkMask&t)>>this._entryBits,n=this._entryMask&t;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[e][n].fill(0),this._freelists[e].push(n)}}class Si{constructor(t,e,n){this._ctor=void 0,this._dtor=void 0,this._indexMask=void 0,this._poolFlag=void 0,this._array=[],this._freelist=[],this._nativePool=void 0,this._ctor=e,n&&(this._dtor=n),this._poolFlag=1<<29,this._indexMask=~this._poolFlag,this._nativePool=new gi(t,this._array)}alloc(...t){const e=this._freelist;let n=-1;if(e.length)n=e[e.length-1],e.length--,this._array[n]=this._ctor(arguments,this._array[n]);else{n=this._array.length;const t=this._ctor(arguments);if(!t)return 0;this._array.push(t)}return this._nativePool.bind(n,this._array[n]),n+this._poolFlag}get(t){const e=this._indexMask&t;return this._array[e]}free(t){const e=this._indexMask&t;this._dtor&&(this._array[e]=this._dtor(this._array[e])),this._freelist.push(e)}}class Ti{constructor(t){this._nativeBufferAllocator=void 0,this._buffers=new Map,this._nextBufferIdx=0,this._poolFlag=void 0,this._bufferIdxMask=void 0,this._freelist=[],this._poolFlag=1<<30,this._bufferIdxMask=~this._poolFlag,this._nativeBufferAllocator=new vi(t)}alloc(t){const e=this._freelist;let n=-1;e.length?(n=e[e.length-1],e.length--):n=this._nextBufferIdx++;const i=this._nativeBufferAllocator.alloc(n,t);return this._buffers.set(n,i),n|this._poolFlag}free(t){const e=this._bufferIdxMask&t;this._buffers.get(e)&&(this._nativeBufferAllocator.free(e),this._buffers.delete(e),this._freelist.push(e))}getBuffer(t){const e=this._bufferIdxMask&t;return this._buffers.get(e)||null}}class Ei extends Ti{constructor(t,e,n,i){super(t),this._viewCtor=void 0,this._size=void 0,this._step=void 0,this._viewCtor=e,this._size=n*e.BYTES_PER_ELEMENT,this._step=i||n}alloc(){const t=this._nextBufferIdx++,e=this._nativeBufferAllocator.alloc(t,this._size);return this._buffers.set(t,new this._viewCtor(e)),t|this._poolFlag}getBuffer(t){return null}assign(t,e,n){const i=this._bufferIdxMask&t;let s=this._buffers.get(i);if(!s)return;const o=e+1;if(o>=s.length){let t=s.length;for(;o>=t;)t+=this._step;t*=this._viewCtor.BYTES_PER_ELEMENT;const e=new this._viewCtor(this._nativeBufferAllocator.alloc(i,t));e.set(s),s=e,this._buffers.set(i,s)}s[o]=n;const r=s[0];s[0]=o>r?o:r}erase(t,e){const n=this._bufferIdxMask&t,i=this._buffers.get(n);if(i&&!(e>=i[0])){for(let t=e+1;t<i[0];++t)i[t]=i[t+1];--i[0]}}push(t,e){const n=this._bufferIdxMask&t,i=this._buffers.get(n);i&&this.assign(t,i[0],e)}pop(t){const e=this._bufferIdxMask&t,n=this._buffers.get(e);n&&0!==n[0]&&--n[0]}clear(t){const e=this._bufferIdxMask&t,n=this._buffers.get(e);n&&(n[0]=0)}get(t,e){const n=this._bufferIdxMask&t,i=this._buffers.get(n);return!i||e>=i[0]?0:i[e+1]}length(t){const e=this._bufferIdxMask&t,n=this._buffers.get(e);return n?n[0]:0}}function Ai(t,e,n,i=!0){const s=e.length(t);for(let i=0;i<s;i++){const s=e.get(t,i);s&&n.free(s)}i?e.free(t):e.clear(t)}let Ci;!function(t){t[t.ATTRIBUTE=0]="ATTRIBUTE",t[t.DESCRIPTOR_SETS=1]="DESCRIPTOR_SETS",t[t.SHADER=2]="SHADER",t[t.INPUT_ASSEMBLER=3]="INPUT_ASSEMBLER",t[t.PIPELINE_LAYOUT=4]="PIPELINE_LAYOUT",t[t.FRAMEBUFFER=5]="FRAMEBUFFER",t[t.PASS=100]="PASS",t[t.SUB_MODEL=101]="SUB_MODEL",t[t.MODEL=102]="MODEL",t[t.SCENE=103]="SCENE",t[t.CAMERA=104]="CAMERA",t[t.NODE=105]="NODE",t[t.ROOT=106]="ROOT",t[t.AABB=107]="AABB",t[t.RENDER_WINDOW=108]="RENDER_WINDOW",t[t.FRUSTUM=109]="FRUSTUM",t[t.AMBIENT=110]="AMBIENT",t[t.FOG=111]="FOG",t[t.SKYBOX=112]="SKYBOX",t[t.SHADOW=113]="SHADOW",t[t.LIGHT=114]="LIGHT",t[t.SPHERE=115]="SPHERE",t[t.INSTANCED_ATTRIBUTE=116]="INSTANCED_ATTRIBUTE",t[t.FLAT_BUFFER=117]="FLAT_BUFFER",t[t.SUB_MESH=118]="SUB_MESH",t[t.RASTERIZER_STATE=119]="RASTERIZER_STATE",t[t.DEPTH_STENCIL_STATE=120]="DEPTH_STENCIL_STATE",t[t.BLEND_TARGET=121]="BLEND_TARGET",t[t.BLEND_STATE=122]="BLEND_STATE",t[t.BATCH_2D=123]="BATCH_2D",t[t.PIPELINE_SCENE_DATA=124]="PIPELINE_SCENE_DATA",t[t.SUB_MODEL_ARRAY=200]="SUB_MODEL_ARRAY",t[t.MODEL_ARRAY=201]="MODEL_ARRAY",t[t.ATTRIBUTE_ARRAY=202]="ATTRIBUTE_ARRAY",t[t.FLAT_BUFFER_ARRAY=203]="FLAT_BUFFER_ARRAY",t[t.INSTANCED_BUFFER_ARRAY=204]="INSTANCED_BUFFER_ARRAY",t[t.LIGHT_ARRAY=205]="LIGHT_ARRAY",t[t.BLEND_TARGET_ARRAY=206]="BLEND_TARGET_ARRAY",t[t.BATCH_ARRAY_2D=207]="BATCH_ARRAY_2D",t[t.RAW_BUFFER=300]="RAW_BUFFER",t[t.RAW_OBJECT=400]="RAW_OBJECT"}(Ci||(Ci={}));const bi=new Si(Ci.SHADER,((t,e)=>e?(e.initialize(t[1]),e):t[0].createShader(t[1])),(t=>(t&&t.destroy(),t))),Pi=new Si(Ci.DESCRIPTOR_SETS,((t,e)=>e?(e.initialize(t[1]),e):t[0].createDescriptorSet(t[1])),(t=>(t&&t.destroy(),t))),wi=new Si(Ci.INPUT_ASSEMBLER,((t,e)=>e?(e.initialize(t[1]),e):t[0].createInputAssembler(t[1])),(t=>(t&&t.destroy(),t))),Di=new Si(Ci.PIPELINE_LAYOUT,((t,e)=>e?(e.initialize(t[1]),e):t[0].createPipelineLayout(t[1])),(t=>(t&&t.destroy(),t))),Ii=new Si(Ci.FRAMEBUFFER,((t,e)=>e?(e.initialize(t[1]),e):t[0].createFramebuffer(t[1])),(t=>(t&&t.destroy(),t))),Ri=new Ei(Ci.SUB_MODEL_ARRAY,Uint32Array,8,4),Oi=new Ei(Ci.MODEL_ARRAY,Uint32Array,32,16),Mi=new Ei(Ci.ATTRIBUTE_ARRAY,Uint32Array,8,4),Ni=new Ei(Ci.FLAT_BUFFER_ARRAY,Uint32Array,8,4),Li=new Ei(Ci.LIGHT_ARRAY,Uint32Array,8,4),Bi=new Ei(Ci.BLEND_TARGET_ARRAY,Uint32Array,8,4),Fi=new Ei(Ci.BATCH_ARRAY_2D,Uint32Array,32,16),zi=new Ti(Ci.RAW_BUFFER),Ui=new Si(Ci.RAW_OBJECT,(t=>t[0]||{}),(()=>{}));let Hi;!function(t){t[t.PRIORITY=0]="PRIORITY",t[t.STAGE=1]="STAGE",t[t.PHASE=2]="PHASE",t[t.BATCHING_SCHEME=3]="BATCHING_SCHEME",t[t.PRIMITIVE=4]="PRIMITIVE",t[t.DYNAMIC_STATES=5]="DYNAMIC_STATES",t[t.HASH=6]="HASH",t[t.RASTERIZER_STATE=7]="RASTERIZER_STATE",t[t.DEPTH_STENCIL_STATE=8]="DEPTH_STENCIL_STATE",t[t.BLEND_STATE=9]="BLEND_STATE",t[t.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",t[t.PIPELINE_LAYOUT=11]="PIPELINE_LAYOUT",t[t.COUNT=12]="COUNT"}(Hi||(Hi={}));const Gi={[Hi.PRIORITY]:yi.UINT32,[Hi.STAGE]:yi.UINT32,[Hi.PHASE]:yi.UINT32,[Hi.BATCHING_SCHEME]:yi.UINT32,[Hi.PRIMITIVE]:yi.UINT32,[Hi.DYNAMIC_STATES]:yi.UINT32,[Hi.HASH]:yi.UINT32,[Hi.RASTERIZER_STATE]:yi.UINT32,[Hi.DEPTH_STENCIL_STATE]:yi.UINT32,[Hi.BLEND_STATE]:yi.UINT32,[Hi.DESCRIPTOR_SET]:yi.UINT32,[Hi.PIPELINE_LAYOUT]:yi.UINT32,[Hi.COUNT]:yi.NEVER},Vi=new xi(Ci.PASS,Gi,Hi);let ji;!function(t){t[t.PRIORITY=0]="PRIORITY",t[t.PASS_COUNT=1]="PASS_COUNT",t[t.PASS_0=2]="PASS_0",t[t.PASS_1=3]="PASS_1",t[t.PASS_2=4]="PASS_2",t[t.PASS_3=5]="PASS_3",t[t.PASS_4=6]="PASS_4",t[t.PASS_5=7]="PASS_5",t[t.PASS_6=8]="PASS_6",t[t.PASS_7=9]="PASS_7",t[t.SHADER_0=10]="SHADER_0",t[t.SHADER_1=11]="SHADER_1",t[t.SHADER_2=12]="SHADER_2",t[t.SHADER_3=13]="SHADER_3",t[t.SHADER_4=14]="SHADER_4",t[t.SHADER_5=15]="SHADER_5",t[t.SHADER_6=16]="SHADER_6",t[t.SHADER_7=17]="SHADER_7",t[t.PLANAR_SHADER=18]="PLANAR_SHADER",t[t.PLANAR_INSTANCE_SHADER=19]="PLANAR_INSTANCE_SHADER",t[t.DESCRIPTOR_SET=20]="DESCRIPTOR_SET",t[t.INPUT_ASSEMBLER=21]="INPUT_ASSEMBLER",t[t.SUB_MESH=22]="SUB_MESH",t[t.COUNT=23]="COUNT"}(ji||(ji={}));const Wi={[ji.PRIORITY]:yi.UINT32,[ji.PASS_COUNT]:yi.UINT32,[ji.PASS_0]:yi.UINT32,[ji.PASS_1]:yi.UINT32,[ji.PASS_2]:yi.UINT32,[ji.PASS_3]:yi.UINT32,[ji.PASS_4]:yi.UINT32,[ji.PASS_5]:yi.UINT32,[ji.PASS_6]:yi.UINT32,[ji.PASS_7]:yi.UINT32,[ji.SHADER_0]:yi.UINT32,[ji.SHADER_1]:yi.UINT32,[ji.SHADER_2]:yi.UINT32,[ji.SHADER_3]:yi.UINT32,[ji.SHADER_4]:yi.UINT32,[ji.SHADER_5]:yi.UINT32,[ji.SHADER_6]:yi.UINT32,[ji.SHADER_7]:yi.UINT32,[ji.PLANAR_SHADER]:yi.UINT32,[ji.PLANAR_INSTANCE_SHADER]:yi.UINT32,[ji.DESCRIPTOR_SET]:yi.UINT32,[ji.INPUT_ASSEMBLER]:yi.UINT32,[ji.SUB_MESH]:yi.UINT32,[ji.COUNT]:yi.NEVER},ki=new xi(Ci.SUB_MODEL,Wi,ji);let qi;!function(t){t[t.ENABLED=0]="ENABLED",t[t.VIS_FLAGS=1]="VIS_FLAGS",t[t.CAST_SHADOW=2]="CAST_SHADOW",t[t.RECEIVE_SHADOW=3]="RECEIVE_SHADOW",t[t.WORLD_BOUNDS=4]="WORLD_BOUNDS",t[t.NODE=5]="NODE",t[t.TRANSFORM=6]="TRANSFORM",t[t.SUB_MODEL_ARRAY=7]="SUB_MODEL_ARRAY",t[t.INSTANCED_BUFFER=8]="INSTANCED_BUFFER",t[t.INSTANCED_ATTR_ARRAY=9]="INSTANCED_ATTR_ARRAY",t[t.COUNT=10]="COUNT"}(qi||(qi={}));const Xi={[qi.ENABLED]:yi.UINT32,[qi.VIS_FLAGS]:yi.UINT32,[qi.CAST_SHADOW]:yi.UINT32,[qi.RECEIVE_SHADOW]:yi.UINT32,[qi.WORLD_BOUNDS]:yi.UINT32,[qi.NODE]:yi.UINT32,[qi.TRANSFORM]:yi.UINT32,[qi.SUB_MODEL_ARRAY]:yi.UINT32,[qi.INSTANCED_BUFFER]:yi.UINT32,[qi.INSTANCED_ATTR_ARRAY]:yi.UINT32,[qi.COUNT]:yi.NEVER},Yi=new xi(Ci.MODEL,Xi,qi);let Ki;!function(t){t[t.VIS_FLAGS=0]="VIS_FLAGS",t[t.PASS_COUNT=1]="PASS_COUNT",t[t.PASS_0=2]="PASS_0",t[t.PASS_1=3]="PASS_1",t[t.PASS_2=4]="PASS_2",t[t.PASS_3=5]="PASS_3",t[t.SHADER_0=6]="SHADER_0",t[t.SHADER_1=7]="SHADER_1",t[t.SHADER_2=8]="SHADER_2",t[t.SHADER_3=9]="SHADER_3",t[t.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",t[t.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",t[t.COUNT=12]="COUNT"}(Ki||(Ki={}));const $i={[Ki.VIS_FLAGS]:yi.UINT32,[Ki.PASS_COUNT]:yi.UINT32,[Ki.PASS_0]:yi.UINT32,[Ki.PASS_1]:yi.UINT32,[Ki.PASS_2]:yi.UINT32,[Ki.PASS_3]:yi.UINT32,[Ki.SHADER_0]:yi.UINT32,[Ki.SHADER_1]:yi.UINT32,[Ki.SHADER_2]:yi.UINT32,[Ki.SHADER_3]:yi.UINT32,[Ki.DESCRIPTOR_SET]:yi.UINT32,[Ki.INPUT_ASSEMBLER]:yi.UINT32,[Ki.COUNT]:yi.NEVER},Zi=new xi(Ci.BATCH_2D,$i,Ki);let Ji;!function(t){t[t.CENTER=0]="CENTER",t[t.HALF_EXTENSION=3]="HALF_EXTENSION",t[t.COUNT=6]="COUNT"}(Ji||(Ji={}));const Qi={[Ji.CENTER]:yi.FLOAT32,[Ji.HALF_EXTENSION]:yi.FLOAT32,[Ji.COUNT]:yi.NEVER},ts=new xi(Ci.AABB,Qi,Ji);let es;!function(t){t[t.MAIN_LIGHT=0]="MAIN_LIGHT",t[t.MODEL_ARRAY=1]="MODEL_ARRAY",t[t.SPHERE_LIGHT_ARRAY=2]="SPHERE_LIGHT_ARRAY",t[t.SPOT_LIGHT_ARRAY=3]="SPOT_LIGHT_ARRAY",t[t.BATCH_ARRAY_2D=4]="BATCH_ARRAY_2D",t[t.COUNT=5]="COUNT"}(es||(es={}));const ns={[es.MAIN_LIGHT]:yi.UINT32,[es.MODEL_ARRAY]:yi.UINT32,[es.SPHERE_LIGHT_ARRAY]:yi.UINT32,[es.SPOT_LIGHT_ARRAY]:yi.UINT32,[es.BATCH_ARRAY_2D]:yi.UINT32,[es.COUNT]:yi.NEVER},is=new xi(Ci.SCENE,ns,es);let ss;!function(t){t[t.WIDTH=0]="WIDTH",t[t.HEIGHT=1]="HEIGHT",t[t.EXPOSURE=2]="EXPOSURE",t[t.CLEAR_FLAGS=3]="CLEAR_FLAGS",t[t.CLEAR_DEPTH=4]="CLEAR_DEPTH",t[t.CLEAR_STENCIL=5]="CLEAR_STENCIL",t[t.VISIBILITY=6]="VISIBILITY",t[t.NODE=7]="NODE",t[t.SCENE=8]="SCENE",t[t.FRUSTUM=9]="FRUSTUM",t[t.WINDOW=10]="WINDOW",t[t.FORWARD=11]="FORWARD",t[t.POSITION=14]="POSITION",t[t.VIEW_PORT=17]="VIEW_PORT",t[t.CLEAR_COLOR=21]="CLEAR_COLOR",t[t.MAT_VIEW=25]="MAT_VIEW",t[t.MAT_VIEW_PROJ=41]="MAT_VIEW_PROJ",t[t.MAT_VIEW_PROJ_INV=57]="MAT_VIEW_PROJ_INV",t[t.MAT_PROJ=73]="MAT_PROJ",t[t.MAT_PROJ_INV=89]="MAT_PROJ_INV",t[t.MAT_VIEW_PROJ_OFFSCREEN=105]="MAT_VIEW_PROJ_OFFSCREEN",t[t.MAT_VIEW_PROJ_INV_OFFSCREEN=121]="MAT_VIEW_PROJ_INV_OFFSCREEN",t[t.MAT_PROJ_OFFSCREEN=137]="MAT_PROJ_OFFSCREEN",t[t.MAT_PROJ_INV_OFFSCREEN=153]="MAT_PROJ_INV_OFFSCREEN",t[t.COUNT=169]="COUNT"}(ss||(ss={}));const os={[ss.WIDTH]:yi.UINT32,[ss.HEIGHT]:yi.UINT32,[ss.EXPOSURE]:yi.FLOAT32,[ss.CLEAR_FLAGS]:yi.UINT32,[ss.CLEAR_DEPTH]:yi.FLOAT32,[ss.CLEAR_STENCIL]:yi.UINT32,[ss.VISIBILITY]:yi.UINT32,[ss.NODE]:yi.UINT32,[ss.SCENE]:yi.UINT32,[ss.FRUSTUM]:yi.UINT32,[ss.WINDOW]:yi.UINT32,[ss.FORWARD]:yi.FLOAT32,[ss.POSITION]:yi.FLOAT32,[ss.VIEW_PORT]:yi.FLOAT32,[ss.CLEAR_COLOR]:yi.FLOAT32,[ss.MAT_VIEW]:yi.FLOAT32,[ss.MAT_VIEW_PROJ]:yi.FLOAT32,[ss.MAT_VIEW_PROJ_INV]:yi.FLOAT32,[ss.MAT_PROJ]:yi.FLOAT32,[ss.MAT_PROJ_INV]:yi.FLOAT32,[ss.MAT_VIEW_PROJ_OFFSCREEN]:yi.FLOAT32,[ss.MAT_VIEW_PROJ_INV_OFFSCREEN]:yi.FLOAT32,[ss.MAT_PROJ_OFFSCREEN]:yi.FLOAT32,[ss.MAT_PROJ_INV_OFFSCREEN]:yi.FLOAT32,[ss.COUNT]:yi.NEVER},rs=new xi(Ci.CAMERA,os,ss);let as;!function(t){t[t.FLAGS_CHANGED=0]="FLAGS_CHANGED",t[t.LAYER=1]="LAYER",t[t.WORLD_SCALE=2]="WORLD_SCALE",t[t.WORLD_POSITION=5]="WORLD_POSITION",t[t.WORLD_ROTATION=8]="WORLD_ROTATION",t[t.WORLD_MATRIX=12]="WORLD_MATRIX",t[t.COUNT=28]="COUNT"}(as||(as={}));const cs={[as.FLAGS_CHANGED]:yi.UINT32,[as.LAYER]:yi.UINT32,[as.WORLD_SCALE]:yi.FLOAT32,[as.WORLD_POSITION]:yi.FLOAT32,[as.WORLD_ROTATION]:yi.FLOAT32,[as.WORLD_MATRIX]:yi.FLOAT32,[as.COUNT]:yi.NEVER},ls=new xi(Ci.NODE,cs,as);let hs;!function(t){t[t.CUMULATIVE_TIME=0]="CUMULATIVE_TIME",t[t.FRAME_TIME=1]="FRAME_TIME",t[t.COUNT=2]="COUNT"}(hs||(hs={}));const _s={[hs.CUMULATIVE_TIME]:yi.FLOAT32,[hs.FRAME_TIME]:yi.FLOAT32,[hs.COUNT]:yi.NEVER},us=new xi(Ci.ROOT,_s,hs,1);let ds;!function(t){t[t.HAS_ON_SCREEN_ATTACHMENTS=0]="HAS_ON_SCREEN_ATTACHMENTS",t[t.HAS_OFF_SCREEN_ATTACHMENTS=1]="HAS_OFF_SCREEN_ATTACHMENTS",t[t.FRAMEBUFFER=2]="FRAMEBUFFER",t[t.COUNT=3]="COUNT"}(ds||(ds={}));const ps={[ds.HAS_ON_SCREEN_ATTACHMENTS]:yi.UINT32,[ds.HAS_OFF_SCREEN_ATTACHMENTS]:yi.UINT32,[ds.FRAMEBUFFER]:yi.UINT32,[ds.COUNT]:yi.NEVER},fs=new xi(Ci.RENDER_WINDOW,ps,ds,2);let ms;!function(t){t[t.VERTICES=0]="VERTICES",t[t.PLANES=24]="PLANES",t[t.COUNT=48]="COUNT"}(ms||(ms={}));const gs={[ms.VERTICES]:yi.FLOAT32,[ms.PLANES]:yi.FLOAT32,[ms.COUNT]:yi.NEVER},vs=new xi(Ci.FRUSTUM,gs,ms);let ys;!function(t){t[t.ENABLE=0]="ENABLE",t[t.ILLUM=1]="ILLUM",t[t.SKY_COLOR=2]="SKY_COLOR",t[t.GROUND_ALBEDO=6]="GROUND_ALBEDO",t[t.COUNT=10]="COUNT"}(ys||(ys={}));const xs={[ys.ENABLE]:yi.UINT32,[ys.ILLUM]:yi.FLOAT32,[ys.SKY_COLOR]:yi.FLOAT32,[ys.GROUND_ALBEDO]:yi.FLOAT32,[ys.COUNT]:yi.NEVER},Ss=new xi(Ci.AMBIENT,xs,ys,1);let Ts;!function(t){t[t.ENABLE=0]="ENABLE",t[t.IS_RGBE=1]="IS_RGBE",t[t.USE_IBL=2]="USE_IBL",t[t.MODEL=3]="MODEL",t[t.COUNT=4]="COUNT"}(Ts||(Ts={}));const Es={[Ts.ENABLE]:yi.UINT32,[Ts.IS_RGBE]:yi.UINT32,[Ts.USE_IBL]:yi.UINT32,[Ts.MODEL]:yi.UINT32,[Ts.COUNT]:yi.NEVER},As=new xi(Ci.SKYBOX,Es,Ts,1);let Cs;!function(t){t[t.ENABLE=0]="ENABLE",t[t.TYPE=1]="TYPE",t[t.DENSITY=2]="DENSITY",t[t.START=3]="START",t[t.END=4]="END",t[t.ATTEN=5]="ATTEN",t[t.TOP=6]="TOP",t[t.RANGE=7]="RANGE",t[t.COLOR=8]="COLOR",t[t.COUNT=12]="COUNT"}(Cs||(Cs={}));const bs={[Cs.ENABLE]:yi.UINT32,[Cs.TYPE]:yi.UINT32,[Cs.DENSITY]:yi.FLOAT32,[Cs.START]:yi.FLOAT32,[Cs.END]:yi.FLOAT32,[Cs.ATTEN]:yi.FLOAT32,[Cs.TOP]:yi.FLOAT32,[Cs.RANGE]:yi.FLOAT32,[Cs.COLOR]:yi.FLOAT32,[Cs.COUNT]:yi.NEVER},Ps=new xi(Ci.FOG,bs,Cs);let ws;!function(t){t[t.ENABLE=0]="ENABLE",t[t.DIRTY=1]="DIRTY",t[t.TYPE=2]="TYPE",t[t.DISTANCE=3]="DISTANCE",t[t.INSTANCE_PASS=4]="INSTANCE_PASS",t[t.PLANAR_PASS=5]="PLANAR_PASS",t[t.NEAR=6]="NEAR",t[t.FAR=7]="FAR",t[t.ASPECT=8]="ASPECT",t[t.PCF_TYPE=9]="PCF_TYPE",t[t.SHADOW_MAP_DIRTY=10]="SHADOW_MAP_DIRTY",t[t.BIAS=11]="BIAS",t[t.PACKING=12]="PACKING",t[t.LINEAR=13]="LINEAR",t[t.SELF_SHADOW=14]="SELF_SHADOW",t[t.NORMAL_BIAS=15]="NORMAL_BIAS",t[t.ORTHO_SIZE=16]="ORTHO_SIZE",t[t.AUTO_ADAPT=17]="AUTO_ADAPT",t[t.COLOR=18]="COLOR",t[t.SIZE=22]="SIZE",t[t.NORMAL=24]="NORMAL",t[t.MAT_LIGHT=27]="MAT_LIGHT",t[t.COUNT=43]="COUNT"}(ws||(ws={}));const Ds={[ws.ENABLE]:yi.UINT32,[ws.DIRTY]:yi.UINT32,[ws.TYPE]:yi.UINT32,[ws.DISTANCE]:yi.FLOAT32,[ws.INSTANCE_PASS]:yi.UINT32,[ws.PLANAR_PASS]:yi.UINT32,[ws.NEAR]:yi.FLOAT32,[ws.FAR]:yi.FLOAT32,[ws.ASPECT]:yi.FLOAT32,[ws.PCF_TYPE]:yi.UINT32,[ws.SHADOW_MAP_DIRTY]:yi.UINT32,[ws.BIAS]:yi.FLOAT32,[ws.PACKING]:yi.UINT32,[ws.LINEAR]:yi.UINT32,[ws.SELF_SHADOW]:yi.UINT32,[ws.NORMAL_BIAS]:yi.FLOAT32,[ws.ORTHO_SIZE]:yi.FLOAT32,[ws.AUTO_ADAPT]:yi.UINT32,[ws.COLOR]:yi.FLOAT32,[ws.SIZE]:yi.FLOAT32,[ws.NORMAL]:yi.FLOAT32,[ws.MAT_LIGHT]:yi.FLOAT32,[ws.COUNT]:yi.NEVER},Is=new xi(Ci.SHADOW,Ds,ws,1);let Rs;!function(t){t[t.SHADOW=0]="SHADOW",t[t.SKYBOX=1]="SKYBOX",t[t.AMBIENT=2]="AMBIENT",t[t.FOG=3]="FOG",t[t.IS_HDR=4]="IS_HDR",t[t.SHADING_SCALE=5]="SHADING_SCALE",t[t.FP_SCALE=6]="FP_SCALE",t[t.DEFERRED_LIGHT_PASS=7]="DEFERRED_LIGHT_PASS",t[t.DEFERRED_LIGHT_PASS_SHADER=8]="DEFERRED_LIGHT_PASS_SHADER",t[t.DEFERRED_POST_PASS=9]="DEFERRED_POST_PASS",t[t.DEFERRED_POST_PASS_SHADER=10]="DEFERRED_POST_PASS_SHADER",t[t.COUNT=11]="COUNT"}(Rs||(Rs={}));const Os={[Rs.SHADOW]:yi.UINT32,[Rs.SKYBOX]:yi.UINT32,[Rs.AMBIENT]:yi.UINT32,[Rs.FOG]:yi.UINT32,[Rs.IS_HDR]:yi.UINT32,[Rs.SHADING_SCALE]:yi.UINT32,[Rs.FP_SCALE]:yi.UINT32,[Rs.DEFERRED_LIGHT_PASS]:yi.UINT32,[Rs.DEFERRED_LIGHT_PASS_SHADER]:yi.UINT32,[Rs.DEFERRED_POST_PASS]:yi.UINT32,[Rs.DEFERRED_POST_PASS_SHADER]:yi.UINT32,[Rs.COUNT]:yi.NEVER},Ms=new xi(Ci.PIPELINE_SCENE_DATA,Os,Rs,1);let Ns;!function(t){t[t.USE_COLOR_TEMPERATURE=0]="USE_COLOR_TEMPERATURE",t[t.ILLUMINANCE=1]="ILLUMINANCE",t[t.NODE=2]="NODE",t[t.RANGE=3]="RANGE",t[t.TYPE=4]="TYPE",t[t.AABB=5]="AABB",t[t.FRUSTUM=6]="FRUSTUM",t[t.SIZE=7]="SIZE",t[t.SPOT_ANGLE=8]="SPOT_ANGLE",t[t.ASPECT=9]="ASPECT",t[t.DIRECTION=10]="DIRECTION",t[t.COLOR=13]="COLOR",t[t.COLOR_TEMPERATURE_RGB=16]="COLOR_TEMPERATURE_RGB",t[t.POSITION=19]="POSITION",t[t.COUNT=22]="COUNT"}(Ns||(Ns={}));const Ls={[Ns.USE_COLOR_TEMPERATURE]:yi.UINT32,[Ns.ILLUMINANCE]:yi.FLOAT32,[Ns.NODE]:yi.UINT32,[Ns.RANGE]:yi.FLOAT32,[Ns.TYPE]:yi.UINT32,[Ns.AABB]:yi.UINT32,[Ns.FRUSTUM]:yi.UINT32,[Ns.SIZE]:yi.FLOAT32,[Ns.SPOT_ANGLE]:yi.FLOAT32,[Ns.ASPECT]:yi.FLOAT32,[Ns.DIRECTION]:yi.FLOAT32,[Ns.COLOR]:yi.FLOAT32,[Ns.COLOR_TEMPERATURE_RGB]:yi.FLOAT32,[Ns.POSITION]:yi.FLOAT32,[Ns.COUNT]:yi.NEVER},Bs=new xi(Ci.LIGHT,Ls,Ns,3);let Fs;!function(t){t[t.RADIUS=0]="RADIUS",t[t.CENTER=1]="CENTER",t[t.COUNT=4]="COUNT"}(Fs||(Fs={}));const zs={[Fs.RADIUS]:yi.FLOAT32,[Fs.CENTER]:yi.FLOAT32,[Fs.COUNT]:yi.NEVER},Us=new xi(Ci.SPHERE,zs,Fs,3);let Hs;!function(t){t[t.STRIDE=0]="STRIDE",t[t.AMOUNT=1]="AMOUNT",t[t.BUFFER=2]="BUFFER",t[t.COUNT=3]="COUNT"}(Hs||(Hs={}));const Gs={[Hs.STRIDE]:yi.UINT32,[Hs.AMOUNT]:yi.UINT32,[Hs.BUFFER]:yi.UINT32,[Hs.COUNT]:yi.NEVER},Vs=new xi(Ci.FLAT_BUFFER,Gs,Hs,3);let js;!function(t){t[t.FLAT_BUFFER_ARRAY=0]="FLAT_BUFFER_ARRAY",t[t.COUNT=1]="COUNT"}(js||(js={}));const Ws={[js.FLAT_BUFFER_ARRAY]:yi.UINT32,[js.COUNT]:yi.NEVER},ks=new xi(Ci.SUB_MESH,Ws,js,3);let qs;!function(t){t[t.IS_DISCARD=0]="IS_DISCARD",t[t.POLYGO_MODEL=1]="POLYGO_MODEL",t[t.SHADE_MODEL=2]="SHADE_MODEL",t[t.CULL_MODE=3]="CULL_MODE",t[t.IS_FRONT_FACE_CCW=4]="IS_FRONT_FACE_CCW",t[t.DEPTH_BIAS_ENABLED=5]="DEPTH_BIAS_ENABLED",t[t.DEPTH_BIAS=6]="DEPTH_BIAS",t[t.DEPTH_BIAS_CLAMP=7]="DEPTH_BIAS_CLAMP",t[t.DEPTH_BIAS_SLOP=8]="DEPTH_BIAS_SLOP",t[t.IS_DEPTH_CLIP=9]="IS_DEPTH_CLIP",t[t.IS_MULTI_SAMPLE=10]="IS_MULTI_SAMPLE",t[t.LINE_WIDTH=11]="LINE_WIDTH",t[t.COUNT=12]="COUNT"}(qs||(qs={}));const Xs={[qs.IS_DISCARD]:yi.UINT32,[qs.POLYGO_MODEL]:yi.UINT32,[qs.SHADE_MODEL]:yi.UINT32,[qs.CULL_MODE]:yi.UINT32,[qs.IS_FRONT_FACE_CCW]:yi.UINT32,[qs.DEPTH_BIAS_ENABLED]:yi.UINT32,[qs.DEPTH_BIAS]:yi.FLOAT32,[qs.DEPTH_BIAS_CLAMP]:yi.FLOAT32,[qs.DEPTH_BIAS_SLOP]:yi.FLOAT32,[qs.IS_DEPTH_CLIP]:yi.UINT32,[qs.IS_MULTI_SAMPLE]:yi.UINT32,[qs.LINE_WIDTH]:yi.FLOAT32,[qs.COUNT]:yi.NEVER},Ys=new xi(Ci.RASTERIZER_STATE,Xs,qs,9);let Ks;!function(t){t[t.DEPTH_TEST=0]="DEPTH_TEST",t[t.DEPTH_WRITE=1]="DEPTH_WRITE",t[t.DEPTH_FUNC=2]="DEPTH_FUNC",t[t.STENCIL_TEST_FRONT=3]="STENCIL_TEST_FRONT",t[t.STENCIL_FUNC_FRONT=4]="STENCIL_FUNC_FRONT",t[t.STENCIL_READ_MASK_FRONT=5]="STENCIL_READ_MASK_FRONT",t[t.STENCIL_WRITE_MASK_FRONT=6]="STENCIL_WRITE_MASK_FRONT",t[t.STENCIL_FAIL_OP_FRONT=7]="STENCIL_FAIL_OP_FRONT",t[t.STENCIL_Z_FAIL_OP_FRONT=8]="STENCIL_Z_FAIL_OP_FRONT",t[t.STENCIL_PASS_OP_FRONT=9]="STENCIL_PASS_OP_FRONT",t[t.STENCIL_REF_FRONT=10]="STENCIL_REF_FRONT",t[t.STENCIL_TEST_BACK=11]="STENCIL_TEST_BACK",t[t.STENCIL_FUNC_BACK=12]="STENCIL_FUNC_BACK",t[t.STENCIL_READ_MADK_BACK=13]="STENCIL_READ_MADK_BACK",t[t.STENCIL_WRITE_MASK_BACK=14]="STENCIL_WRITE_MASK_BACK",t[t.STENCIL_FAIL_OP_BACK=15]="STENCIL_FAIL_OP_BACK",t[t.STENCIL_Z_FAIL_OP_BACK=16]="STENCIL_Z_FAIL_OP_BACK",t[t.STENCIL_PASS_OP_BACK=17]="STENCIL_PASS_OP_BACK",t[t.STENCIL_REF_BACK=18]="STENCIL_REF_BACK",t[t.COUNT=19]="COUNT"}(Ks||(Ks={}));const $s={[Ks.DEPTH_TEST]:yi.UINT32,[Ks.DEPTH_WRITE]:yi.UINT32,[Ks.DEPTH_FUNC]:yi.UINT32,[Ks.STENCIL_TEST_FRONT]:yi.UINT32,[Ks.STENCIL_FUNC_FRONT]:yi.UINT32,[Ks.STENCIL_READ_MASK_FRONT]:yi.UINT32,[Ks.STENCIL_WRITE_MASK_FRONT]:yi.UINT32,[Ks.STENCIL_FAIL_OP_FRONT]:yi.UINT32,[Ks.STENCIL_Z_FAIL_OP_FRONT]:yi.UINT32,[Ks.STENCIL_PASS_OP_FRONT]:yi.UINT32,[Ks.STENCIL_REF_FRONT]:yi.UINT32,[Ks.STENCIL_TEST_BACK]:yi.UINT32,[Ks.STENCIL_FUNC_BACK]:yi.UINT32,[Ks.STENCIL_READ_MADK_BACK]:yi.UINT32,[Ks.STENCIL_WRITE_MASK_BACK]:yi.UINT32,[Ks.STENCIL_FAIL_OP_BACK]:yi.UINT32,[Ks.STENCIL_Z_FAIL_OP_BACK]:yi.UINT32,[Ks.STENCIL_PASS_OP_BACK]:yi.UINT32,[Ks.STENCIL_REF_BACK]:yi.UINT32,[Ks.COUNT]:yi.NEVER},Zs=new xi(Ci.DEPTH_STENCIL_STATE,$s,Ks,9);let Js;!function(t){t[t.BLEND=0]="BLEND",t[t.BLEND_SRC=1]="BLEND_SRC",t[t.BLEND_DST=2]="BLEND_DST",t[t.BLEND_EQ=3]="BLEND_EQ",t[t.BLEND_SRC_ALPHA=4]="BLEND_SRC_ALPHA",t[t.BLEND_DST_ALPHA=5]="BLEND_DST_ALPHA",t[t.BLEND_ALPHA_EQ=6]="BLEND_ALPHA_EQ",t[t.BLEND_COLOR_MASK=7]="BLEND_COLOR_MASK",t[t.COUNT=8]="COUNT"}(Js||(Js={})),Js.BLEND,yi.UINT32,Js.BLEND_SRC,yi.UINT32,Js.BLEND_DST,yi.UINT32,Js.BLEND_EQ,yi.UINT32,Js.BLEND_SRC_ALPHA,yi.UINT32,Js.BLEND_DST_ALPHA,yi.UINT32,Js.BLEND_ALPHA_EQ,yi.UINT32,Js.BLEND_COLOR_MASK,yi.UINT32,Js.COUNT,yi.NEVER;const Qs=new xi(Ci.BLEND_TARGET,$s,Js,9);let to;!function(t){t[t.IS_A2C=0]="IS_A2C",t[t.IS_INDEPEND=1]="IS_INDEPEND",t[t.BLEND_COLOR=2]="BLEND_COLOR",t[t.BLEND_TARGET=6]="BLEND_TARGET",t[t.COUNT=7]="COUNT"}(to||(to={}));const eo={[to.IS_A2C]:yi.UINT32,[to.IS_INDEPEND]:yi.UINT32,[to.BLEND_COLOR]:yi.FLOAT32,[to.BLEND_TARGET]:yi.UINT32,[to.COUNT]:yi.NEVER},no=new xi(Ci.BLEND_STATE,eo,to,9);class io{get colorArray(){return this._colorArray}get albedoArray(){return this._albedoArray}set enabled(t){Ss.set(this._handle,ys.ENABLE,t?1:0)}get enabled(){return Ss.get(this._handle,ys.ENABLE)}get skyColor(){return this._skyColor}set skyColor(t){this._skyColor.set(t),An.toArray(this._colorArray,this._skyColor),Ss.setVec4(this._handle,ys.SKY_COLOR,this._skyColor)}get skyIllum(){return Ss.get(this._handle,ys.ILLUM)}set skyIllum(t){Ss.set(this._handle,ys.ILLUM,t)}get groundAlbedo(){return this._groundAlbedo}set groundAlbedo(t){this._groundAlbedo.set(t),$e.toArray(this._albedoArray,this._groundAlbedo),Ss.setVec4(this._handle,ys.GROUND_ALBEDO,this._groundAlbedo)}get handle(){return this._handle}constructor(){this._skyColor=new An(51,128,204,1),this._groundAlbedo=new An(51,51,51,255),this._albedoArray=Float32Array.from([.2,.2,.2,1]),this._colorArray=Float32Array.from([.2,.5,.8,1]),this._handle=0,this._handle=Ss.alloc()}initialize(t){this._skyColor.set(t.skyColor),this._groundAlbedo.set(t.groundAlbedo),An.toArray(this._colorArray,this._skyColor),$e.toArray(this._albedoArray,this._groundAlbedo),Ss.setVec4(this._handle,ys.SKY_COLOR,this._skyColor),Ss.setVec4(this._handle,ys.GROUND_ALBEDO,this._groundAlbedo),Ss.set(this._handle,ys.ILLUM,t.skyIllum)}destroy(){this._handle&&(Ss.free(this._handle),this._handle=0)}}io.SUN_ILLUM=65e3,io.SKY_ILLUM=2e4,i.Ambient=io;const so=new $e,oo=new $e,ro=new $e,ao=new $e,co=new $e,lo=new $e,ho=new Array(3),_o=new Array(3);function uo(t,e){return $e.dot(e.n,t)-e.d}function po(t,e,n){return $e.copy(t,e),$e.subtract(co,n.center,n.halfExtents),$e.add(lo,n.center,n.halfExtents),t.x=t.x<co.x?co.x:t.x,t.y=t.y<co.y?co.y:t.y,t.z=t.z<co.z?co.z:t.z,t.x=t.x>lo.x?lo.x:t.x,t.y=t.y>lo.y?lo.y:t.y,t.z=t.z>lo.z?lo.z:t.z,t}function fo(t,e,n){$e.set(so,n.orientation.m00,n.orientation.m01,n.orientation.m02),$e.set(oo,n.orientation.m03,n.orientation.m04,n.orientation.m05),$e.set(ro,n.orientation.m06,n.orientation.m07,n.orientation.m08),ho[0]=so,ho[1]=oo,ho[2]=ro,_o[0]=n.halfExtents.x,_o[1]=n.halfExtents.y,_o[2]=n.halfExtents.z,$e.subtract(ao,e,n.center),$e.set(t,n.center.x,n.center.y,n.center.z);for(let e=0;e<3;e++){let n=$e.dot(ao,ho[e]);n>_o[e]&&(n=_o[e]),n<-_o[e]&&(n=-_o[e]),t.x+=n*ho[e].x,t.y+=n*ho[e].y,t.z+=n*ho[e].z}return t}var mo=Object.freeze({__proto__:null,point_plane:uo,pt_point_plane:function(t,e,n){const i=uo(e,n);return $e.subtract(t,e,$e.multiplyScalar(t,n.n,i))},pt_point_aabb:po,pt_point_obb:fo,pt_point_line:function(t,e,n,i){$e.subtract(so,n,i);const s=so,o=$e.lengthSqr(s);if(0==o)$e.copy(t,n);else{$e.subtract(so,e,n);const r=$e.dot(so,s)/o;r<0?$e.copy(t,n):r>1?$e.copy(t,i):$e.scaleAndAdd(t,n,s,r)}}}),go={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512};class vo{static create(t=0,e=0,n=0,i=0,s=0,o=1){return new vo(t,e,n,i,s,o)}static clone(t){return new vo(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)}static copy(t,e){return $e.copy(t.o,e.o),$e.copy(t.d,e.d),t}static fromPoints(t,e,n){return $e.copy(t.o,e),$e.normalize(t.d,$e.subtract(t.d,n,e)),t}static set(t,e,n,i,s,o,r){return t.o.x=e,t.o.y=n,t.o.z=i,t.d.x=s,t.d.y=o,t.d.z=r,t}get type(){return this._type}constructor(t=0,e=0,n=0,i=0,s=0,o=-1){this.o=void 0,this.d=void 0,this._type=void 0,this._type=go.SHAPE_RAY,this.o=new $e(t,e,n),this.d=new $e(i,s,o)}computeHit(t,e){$e.normalize(t,this.d),$e.scaleAndAdd(t,this.o,t,e)}}const yo=new $e,xo=new $e,So=new $e,To=new $e;function Eo(t){return Math.max(Math.max(t.x,t.y),t.z)}class Ao{static create(t,e,n,i){return new Ao(t,e,n,i)}static clone(t){return new Ao(t.center.x,t.center.y,t.center.z,t.radius)}static copy(t,e){return $e.copy(t.center,e.center),t.radius=e.radius,t}static fromPoints(t,e,n){return $e.multiplyScalar(t.center,$e.add(yo,e,n),.5),t.radius=.5*$e.subtract(yo,n,e).length(),t}static set(t,e,n,i,s){return t.center.x=e,t.center.y=n,t.center.z=i,t.radius=s,t}static mergePoint(t,e,n){if(e.radius<0)return t.center.set(n),t.radius=0,t;$e.subtract(xo,n,e.center);const i=xo.length();if(i>e.radius){const n=.5*(i-e.radius);t.radius+=n,$e.multiplyScalar(xo,xo,n/i),$e.add(t.center,t.center,xo)}return t}static mergeAABB(t,e,n){return n.getBoundary(So,To),Ao.mergePoint(t,e,So),Ao.mergePoint(t,e,To),t}get center(){return this._center}set center(t){this._center=t,Us.setVec3(this._poolHandle,Fs.CENTER,this._center)}get radius(){return Us.get(this._poolHandle,Fs.RADIUS)}set radius(t){Us.set(this._poolHandle,Fs.RADIUS,t)}get handle(){return this._poolHandle}get type(){return this._type}constructor(t=0,e=0,n=0,i=1){this._center=new $e(0,0,0),this._poolHandle=0,this._type=void 0,this._type=go.SHAPE_SPHERE,this._center=new $e(t,e,n),this._poolHandle=Us.alloc(),Us.setVec3(this._poolHandle,Fs.CENTER,this._center),Us.set(this._poolHandle,Fs.RADIUS,i)}destroy(){this._poolHandle&&(Us.free(this._poolHandle),this._poolHandle=0)}clone(){return Ao.clone(this)}copy(t){return Ao.copy(this,t)}getBoundary(t,e){$e.set(t,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),$e.set(e,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)}transform(t,e,n,i,s){$e.transformMat4(s.center,this.center,t),s.radius=this.radius*Eo(i)}translateAndRotate(t,e,n){$e.transformMat4(n.center,this.center,t)}setScale(t,e){e.radius=this.radius*Eo(t)}}class Co{static create(t=1,e=0,n=0,i=0,s=0,o=0,r=0,a=0,c=1){return new Co(t,e,n,i,s,o,r,a,c)}static clone(t){return new Co(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)}static copy(t,e){return $e.copy(t.a,e.a),$e.copy(t.b,e.b),$e.copy(t.c,e.c),t}static fromPoints(t,e,n,i){return $e.copy(t.a,e),$e.copy(t.b,n),$e.copy(t.c,i),t}static set(t,e,n,i,s,o,r,a,c,l){return t.a.x=e,t.a.y=n,t.a.z=i,t.b.x=s,t.b.y=o,t.b.z=r,t.c.x=a,t.c.y=c,t.c.z=l,t}get type(){return this._type}constructor(t=0,e=0,n=0,i=1,s=0,o=0,r=0,a=1,c=0){this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=go.SHAPE_TRIANGLE,this.a=new $e(t,e,n),this.b=new $e(i,s,o),this.c=new $e(r,a,c)}}const bo=(t,e,n)=>{for(let i=0;i<e.length;++i)t.length<=i&&t.push(new n),t[i].copy(e[i]);t.length=e.length};let Po,wo,Do,Io,Ro,Oo,Mo,No,Lo,Bo,Fo,zo,Uo,Ho,Go,Vo,jo,Wo,ko,qo,Xo,Yo,Ko,$o,Zo,Jo,Qo,tr,er,ir,sr,or,rr,ar,cr,lr,hr,_r,ur;!function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.BUFFER=1]="BUFFER",t[t.TEXTURE=2]="TEXTURE",t[t.RENDER_PASS=3]="RENDER_PASS",t[t.FRAMEBUFFER=4]="FRAMEBUFFER",t[t.SAMPLER=5]="SAMPLER",t[t.SHADER=6]="SHADER",t[t.DESCRIPTOR_SET_LAYOUT=7]="DESCRIPTOR_SET_LAYOUT",t[t.PIPELINE_LAYOUT=8]="PIPELINE_LAYOUT",t[t.PIPELINE_STATE=9]="PIPELINE_STATE",t[t.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",t[t.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",t[t.COMMAND_BUFFER=12]="COMMAND_BUFFER",t[t.QUEUE=13]="QUEUE",t[t.GLOBAL_BARRIER=14]="GLOBAL_BARRIER",t[t.TEXTURE_BARRIER=15]="TEXTURE_BARRIER",t[t.BUFFER_BARRIER=16]="BUFFER_BARRIER"}(Po||(Po={})),function(t){t[t.UNREADY=0]="UNREADY",t[t.FAILED=1]="FAILED",t[t.SUCCESS=2]="SUCCESS"}(wo||(wo={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.GLES2=1]="GLES2",t[t.GLES3=2]="GLES3",t[t.METAL=3]="METAL",t[t.VULKAN=4]="VULKAN",t[t.WEBGL=5]="WEBGL",t[t.WEBGL2=6]="WEBGL2",t[t.WEBGPU=7]="WEBGPU"}(Do||(Do={})),function(t){t[t.IDENTITY=0]="IDENTITY",t[t.ROTATE_90=1]="ROTATE_90",t[t.ROTATE_180=2]="ROTATE_180",t[t.ROTATE_270=3]="ROTATE_270"}(Io||(Io={})),function(t){t[t.COLOR_FLOAT=0]="COLOR_FLOAT",t[t.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",t[t.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",t[t.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",t[t.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",t[t.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",t[t.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",t[t.FORMAT_D16=7]="FORMAT_D16",t[t.FORMAT_D16S8=8]="FORMAT_D16S8",t[t.FORMAT_D24=9]="FORMAT_D24",t[t.FORMAT_D24S8=10]="FORMAT_D24S8",t[t.FORMAT_D32F=11]="FORMAT_D32F",t[t.FORMAT_D32FS8=12]="FORMAT_D32FS8",t[t.FORMAT_ETC1=13]="FORMAT_ETC1",t[t.FORMAT_ETC2=14]="FORMAT_ETC2",t[t.FORMAT_DXT=15]="FORMAT_DXT",t[t.FORMAT_PVRTC=16]="FORMAT_PVRTC",t[t.FORMAT_ASTC=17]="FORMAT_ASTC",t[t.FORMAT_RGB8=18]="FORMAT_RGB8",t[t.MSAA=19]="MSAA",t[t.ELEMENT_INDEX_UINT=20]="ELEMENT_INDEX_UINT",t[t.INSTANCED_ARRAYS=21]="INSTANCED_ARRAYS",t[t.MULTIPLE_RENDER_TARGETS=22]="MULTIPLE_RENDER_TARGETS",t[t.BLEND_MINMAX=23]="BLEND_MINMAX",t[t.DEPTH_BOUNDS=24]="DEPTH_BOUNDS",t[t.LINE_WIDTH=25]="LINE_WIDTH",t[t.STENCIL_WRITE_MASK=26]="STENCIL_WRITE_MASK",t[t.STENCIL_COMPARE_MASK=27]="STENCIL_COMPARE_MASK",t[t.MULTITHREADED_SUBMISSION=28]="MULTITHREADED_SUBMISSION",t[t.COMPUTE_SHADER=29]="COMPUTE_SHADER",t[t.COUNT=30]="COUNT"}(Ro||(Ro={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.A8=1]="A8",t[t.L8=2]="L8",t[t.LA8=3]="LA8",t[t.R8=4]="R8",t[t.R8SN=5]="R8SN",t[t.R8UI=6]="R8UI",t[t.R8I=7]="R8I",t[t.R16F=8]="R16F",t[t.R16UI=9]="R16UI",t[t.R16I=10]="R16I",t[t.R32F=11]="R32F",t[t.R32UI=12]="R32UI",t[t.R32I=13]="R32I",t[t.RG8=14]="RG8",t[t.RG8SN=15]="RG8SN",t[t.RG8UI=16]="RG8UI",t[t.RG8I=17]="RG8I",t[t.RG16F=18]="RG16F",t[t.RG16UI=19]="RG16UI",t[t.RG16I=20]="RG16I",t[t.RG32F=21]="RG32F",t[t.RG32UI=22]="RG32UI",t[t.RG32I=23]="RG32I",t[t.RGB8=24]="RGB8",t[t.SRGB8=25]="SRGB8",t[t.RGB8SN=26]="RGB8SN",t[t.RGB8UI=27]="RGB8UI",t[t.RGB8I=28]="RGB8I",t[t.RGB16F=29]="RGB16F",t[t.RGB16UI=30]="RGB16UI",t[t.RGB16I=31]="RGB16I",t[t.RGB32F=32]="RGB32F",t[t.RGB32UI=33]="RGB32UI",t[t.RGB32I=34]="RGB32I",t[t.RGBA8=35]="RGBA8",t[t.BGRA8=36]="BGRA8",t[t.SRGB8_A8=37]="SRGB8_A8",t[t.RGBA8SN=38]="RGBA8SN",t[t.RGBA8UI=39]="RGBA8UI",t[t.RGBA8I=40]="RGBA8I",t[t.RGBA16F=41]="RGBA16F",t[t.RGBA16UI=42]="RGBA16UI",t[t.RGBA16I=43]="RGBA16I",t[t.RGBA32F=44]="RGBA32F",t[t.RGBA32UI=45]="RGBA32UI",t[t.RGBA32I=46]="RGBA32I",t[t.R5G6B5=47]="R5G6B5",t[t.R11G11B10F=48]="R11G11B10F",t[t.RGB5A1=49]="RGB5A1",t[t.RGBA4=50]="RGBA4",t[t.RGB10A2=51]="RGB10A2",t[t.RGB10A2UI=52]="RGB10A2UI",t[t.RGB9E5=53]="RGB9E5",t[t.D16=54]="D16",t[t.D16S8=55]="D16S8",t[t.D24=56]="D24",t[t.D24S8=57]="D24S8",t[t.D32F=58]="D32F",t[t.D32F_S8=59]="D32F_S8",t[t.BC1=60]="BC1",t[t.BC1_ALPHA=61]="BC1_ALPHA",t[t.BC1_SRGB=62]="BC1_SRGB",t[t.BC1_SRGB_ALPHA=63]="BC1_SRGB_ALPHA",t[t.BC2=64]="BC2",t[t.BC2_SRGB=65]="BC2_SRGB",t[t.BC3=66]="BC3",t[t.BC3_SRGB=67]="BC3_SRGB",t[t.BC4=68]="BC4",t[t.BC4_SNORM=69]="BC4_SNORM",t[t.BC5=70]="BC5",t[t.BC5_SNORM=71]="BC5_SNORM",t[t.BC6H_UF16=72]="BC6H_UF16",t[t.BC6H_SF16=73]="BC6H_SF16",t[t.BC7=74]="BC7",t[t.BC7_SRGB=75]="BC7_SRGB",t[t.ETC_RGB8=76]="ETC_RGB8",t[t.ETC2_RGB8=77]="ETC2_RGB8",t[t.ETC2_SRGB8=78]="ETC2_SRGB8",t[t.ETC2_RGB8_A1=79]="ETC2_RGB8_A1",t[t.ETC2_SRGB8_A1=80]="ETC2_SRGB8_A1",t[t.ETC2_RGBA8=81]="ETC2_RGBA8",t[t.ETC2_SRGB8_A8=82]="ETC2_SRGB8_A8",t[t.EAC_R11=83]="EAC_R11",t[t.EAC_R11SN=84]="EAC_R11SN",t[t.EAC_RG11=85]="EAC_RG11",t[t.EAC_RG11SN=86]="EAC_RG11SN",t[t.PVRTC_RGB2=87]="PVRTC_RGB2",t[t.PVRTC_RGBA2=88]="PVRTC_RGBA2",t[t.PVRTC_RGB4=89]="PVRTC_RGB4",t[t.PVRTC_RGBA4=90]="PVRTC_RGBA4",t[t.PVRTC2_2BPP=91]="PVRTC2_2BPP",t[t.PVRTC2_4BPP=92]="PVRTC2_4BPP",t[t.ASTC_RGBA_4x4=93]="ASTC_RGBA_4x4",t[t.ASTC_RGBA_5x4=94]="ASTC_RGBA_5x4",t[t.ASTC_RGBA_5x5=95]="ASTC_RGBA_5x5",t[t.ASTC_RGBA_6x5=96]="ASTC_RGBA_6x5",t[t.ASTC_RGBA_6x6=97]="ASTC_RGBA_6x6",t[t.ASTC_RGBA_8x5=98]="ASTC_RGBA_8x5",t[t.ASTC_RGBA_8x6=99]="ASTC_RGBA_8x6",t[t.ASTC_RGBA_8x8=100]="ASTC_RGBA_8x8",t[t.ASTC_RGBA_10x5=101]="ASTC_RGBA_10x5",t[t.ASTC_RGBA_10x6=102]="ASTC_RGBA_10x6",t[t.ASTC_RGBA_10x8=103]="ASTC_RGBA_10x8",t[t.ASTC_RGBA_10x10=104]="ASTC_RGBA_10x10",t[t.ASTC_RGBA_12x10=105]="ASTC_RGBA_12x10",t[t.ASTC_RGBA_12x12=106]="ASTC_RGBA_12x12",t[t.ASTC_SRGBA_4x4=107]="ASTC_SRGBA_4x4",t[t.ASTC_SRGBA_5x4=108]="ASTC_SRGBA_5x4",t[t.ASTC_SRGBA_5x5=109]="ASTC_SRGBA_5x5",t[t.ASTC_SRGBA_6x5=110]="ASTC_SRGBA_6x5",t[t.ASTC_SRGBA_6x6=111]="ASTC_SRGBA_6x6",t[t.ASTC_SRGBA_8x5=112]="ASTC_SRGBA_8x5",t[t.ASTC_SRGBA_8x6=113]="ASTC_SRGBA_8x6",t[t.ASTC_SRGBA_8x8=114]="ASTC_SRGBA_8x8",t[t.ASTC_SRGBA_10x5=115]="ASTC_SRGBA_10x5",t[t.ASTC_SRGBA_10x6=116]="ASTC_SRGBA_10x6",t[t.ASTC_SRGBA_10x8=117]="ASTC_SRGBA_10x8",t[t.ASTC_SRGBA_10x10=118]="ASTC_SRGBA_10x10",t[t.ASTC_SRGBA_12x10=119]="ASTC_SRGBA_12x10",t[t.ASTC_SRGBA_12x12=120]="ASTC_SRGBA_12x12",t[t.COUNT=121]="COUNT"}(Oo||(Oo={})),function(t){t[t.NONE=0]="NONE",t[t.UNORM=1]="UNORM",t[t.SNORM=2]="SNORM",t[t.UINT=3]="UINT",t[t.INT=4]="INT",t[t.UFLOAT=5]="UFLOAT",t[t.FLOAT=6]="FLOAT"}(Mo||(Mo={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.BOOL=1]="BOOL",t[t.BOOL2=2]="BOOL2",t[t.BOOL3=3]="BOOL3",t[t.BOOL4=4]="BOOL4",t[t.INT=5]="INT",t[t.INT2=6]="INT2",t[t.INT3=7]="INT3",t[t.INT4=8]="INT4",t[t.UINT=9]="UINT",t[t.UINT2=10]="UINT2",t[t.UINT3=11]="UINT3",t[t.UINT4=12]="UINT4",t[t.FLOAT=13]="FLOAT",t[t.FLOAT2=14]="FLOAT2",t[t.FLOAT3=15]="FLOAT3",t[t.FLOAT4=16]="FLOAT4",t[t.MAT2=17]="MAT2",t[t.MAT2X3=18]="MAT2X3",t[t.MAT2X4=19]="MAT2X4",t[t.MAT3X2=20]="MAT3X2",t[t.MAT3=21]="MAT3",t[t.MAT3X4=22]="MAT3X4",t[t.MAT4X2=23]="MAT4X2",t[t.MAT4X3=24]="MAT4X3",t[t.MAT4=25]="MAT4",t[t.SAMPLER1D=26]="SAMPLER1D",t[t.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",t[t.SAMPLER2D=28]="SAMPLER2D",t[t.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",t[t.SAMPLER3D=30]="SAMPLER3D",t[t.SAMPLER_CUBE=31]="SAMPLER_CUBE",t[t.SAMPLER=32]="SAMPLER",t[t.TEXTURE1D=33]="TEXTURE1D",t[t.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",t[t.TEXTURE2D=35]="TEXTURE2D",t[t.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",t[t.TEXTURE3D=37]="TEXTURE3D",t[t.TEXTURE_CUBE=38]="TEXTURE_CUBE",t[t.IMAGE1D=39]="IMAGE1D",t[t.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",t[t.IMAGE2D=41]="IMAGE2D",t[t.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",t[t.IMAGE3D=43]="IMAGE3D",t[t.IMAGE_CUBE=44]="IMAGE_CUBE",t[t.SUBPASS_INPUT=45]="SUBPASS_INPUT",t[t.COUNT=46]="COUNT"}(No||(No={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.INDEX=4]="INDEX",t[t.VERTEX=8]="VERTEX",t[t.UNIFORM=16]="UNIFORM",t[t.STORAGE=32]="STORAGE",t[t.INDIRECT=64]="INDIRECT"}(Lo||(Lo={})),function(t){t[t.NONE=0]="NONE"}(Bo||(Bo={})),function(t){t[t.NONE=0]="NONE",t[t.READ_ONLY=1]="READ_ONLY",t[t.WRITE_ONLY=2]="WRITE_ONLY",t[t.READ_WRITE=3]="READ_WRITE"}(Fo||(Fo={})),function(t){t[t.NONE=0]="NONE",t[t.DEVICE=1]="DEVICE",t[t.HOST=2]="HOST"}(zo||(zo={})),function(t){t[t.TEX1D=0]="TEX1D",t[t.TEX2D=1]="TEX2D",t[t.TEX3D=2]="TEX3D",t[t.CUBE=3]="CUBE",t[t.TEX1D_ARRAY=4]="TEX1D_ARRAY",t[t.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(Uo||(Uo={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.SAMPLED=4]="SAMPLED",t[t.STORAGE=8]="STORAGE",t[t.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",t[t.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",t[t.TRANSIENT_ATTACHMENT=64]="TRANSIENT_ATTACHMENT",t[t.INPUT_ATTACHMENT=128]="INPUT_ATTACHMENT"}(Ho||(Ho={})),function(t){t[t.NONE=0]="NONE",t[t.GEN_MIPMAP=1]="GEN_MIPMAP",t[t.IMMUTABLE=2]="IMMUTABLE"}(Go||(Go={})),function(t){t[t.X1=0]="X1",t[t.X2=1]="X2",t[t.X4=2]="X4",t[t.X8=3]="X8",t[t.X16=4]="X16",t[t.X32=5]="X32",t[t.X64=6]="X64"}(Vo||(Vo={})),function(t){t[t.NONE=0]="NONE",t[t.POINT=1]="POINT",t[t.LINEAR=2]="LINEAR",t[t.ANISOTROPIC=3]="ANISOTROPIC"}(jo||(jo={})),function(t){t[t.WRAP=0]="WRAP",t[t.MIRROR=1]="MIRROR",t[t.CLAMP=2]="CLAMP",t[t.BORDER=3]="BORDER"}(Wo||(Wo={})),function(t){t[t.NEVER=0]="NEVER",t[t.LESS=1]="LESS",t[t.EQUAL=2]="EQUAL",t[t.LESS_EQUAL=3]="LESS_EQUAL",t[t.GREATER=4]="GREATER",t[t.NOT_EQUAL=5]="NOT_EQUAL",t[t.GREATER_EQUAL=6]="GREATER_EQUAL",t[t.ALWAYS=7]="ALWAYS"}(ko||(ko={})),function(t){t[t.ZERO=0]="ZERO",t[t.KEEP=1]="KEEP",t[t.REPLACE=2]="REPLACE",t[t.INCR=3]="INCR",t[t.DECR=4]="DECR",t[t.INVERT=5]="INVERT",t[t.INCR_WRAP=6]="INCR_WRAP",t[t.DECR_WRAP=7]="DECR_WRAP"}(qo||(qo={})),function(t){t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SRC_ALPHA=2]="SRC_ALPHA",t[t.DST_ALPHA=3]="DST_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",t[t.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",t[t.SRC_COLOR=6]="SRC_COLOR",t[t.DST_COLOR=7]="DST_COLOR",t[t.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",t[t.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",t[t.CONSTANT_COLOR=11]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(Xo||(Xo={})),function(t){t[t.ADD=0]="ADD",t[t.SUB=1]="SUB",t[t.REV_SUB=2]="REV_SUB",t[t.MIN=3]="MIN",t[t.MAX=4]="MAX"}(Yo||(Yo={})),function(t){t[t.NONE=0]="NONE",t[t.R=1]="R",t[t.G=2]="G",t[t.B=4]="B",t[t.A=8]="A",t[t.ALL=15]="ALL"}(Ko||(Ko={})),function(t){t[t.NONE=0]="NONE",t[t.VERTEX=1]="VERTEX",t[t.CONTROL=2]="CONTROL",t[t.EVALUATION=4]="EVALUATION",t[t.GEOMETRY=8]="GEOMETRY",t[t.FRAGMENT=16]="FRAGMENT",t[t.COMPUTE=32]="COMPUTE",t[t.ALL=63]="ALL"}($o||($o={})),function(t){t[t.LOAD=0]="LOAD",t[t.CLEAR=1]="CLEAR",t[t.DISCARD=2]="DISCARD"}(Zo||(Zo={})),function(t){t[t.STORE=0]="STORE",t[t.DISCARD=1]="DISCARD"}(Jo||(Jo={})),function(t){t[t.NONE=0]="NONE",t[t.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",t[t.INDEX_BUFFER=2]="INDEX_BUFFER",t[t.VERTEX_BUFFER=3]="VERTEX_BUFFER",t[t.VERTEX_SHADER_READ_UNIFORM_BUFFER=4]="VERTEX_SHADER_READ_UNIFORM_BUFFER",t[t.VERTEX_SHADER_READ_TEXTURE=5]="VERTEX_SHADER_READ_TEXTURE",t[t.VERTEX_SHADER_READ_OTHER=6]="VERTEX_SHADER_READ_OTHER",t[t.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=7]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",t[t.FRAGMENT_SHADER_READ_TEXTURE=8]="FRAGMENT_SHADER_READ_TEXTURE",t[t.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=9]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",t[t.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=10]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",t[t.FRAGMENT_SHADER_READ_OTHER=11]="FRAGMENT_SHADER_READ_OTHER",t[t.COLOR_ATTACHMENT_READ=12]="COLOR_ATTACHMENT_READ",t[t.DEPTH_STENCIL_ATTACHMENT_READ=13]="DEPTH_STENCIL_ATTACHMENT_READ",t[t.COMPUTE_SHADER_READ_UNIFORM_BUFFER=14]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",t[t.COMPUTE_SHADER_READ_TEXTURE=15]="COMPUTE_SHADER_READ_TEXTURE",t[t.COMPUTE_SHADER_READ_OTHER=16]="COMPUTE_SHADER_READ_OTHER",t[t.TRANSFER_READ=17]="TRANSFER_READ",t[t.HOST_READ=18]="HOST_READ",t[t.PRESENT=19]="PRESENT",t[t.VERTEX_SHADER_WRITE=20]="VERTEX_SHADER_WRITE",t[t.FRAGMENT_SHADER_WRITE=21]="FRAGMENT_SHADER_WRITE",t[t.COLOR_ATTACHMENT_WRITE=22]="COLOR_ATTACHMENT_WRITE",t[t.DEPTH_STENCIL_ATTACHMENT_WRITE=23]="DEPTH_STENCIL_ATTACHMENT_WRITE",t[t.COMPUTE_SHADER_WRITE=24]="COMPUTE_SHADER_WRITE",t[t.TRANSFER_WRITE=25]="TRANSFER_WRITE",t[t.HOST_PREINITIALIZED=26]="HOST_PREINITIALIZED",t[t.HOST_WRITE=27]="HOST_WRITE"}(Qo||(Qo={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.RAY_TRACING=2]="RAY_TRACING"}(tr||(tr={})),function(t){t[t.POINT_LIST=0]="POINT_LIST",t[t.LINE_LIST=1]="LINE_LIST",t[t.LINE_STRIP=2]="LINE_STRIP",t[t.LINE_LOOP=3]="LINE_LOOP",t[t.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",t[t.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",t[t.ISO_LINE_LIST=6]="ISO_LINE_LIST",t[t.TRIANGLE_LIST=7]="TRIANGLE_LIST",t[t.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=9]="TRIANGLE_FAN",t[t.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",t[t.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",t[t.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",t[t.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(er||(er={})),function(t){t[t.FILL=0]="FILL",t[t.POINT=1]="POINT",t[t.LINE=2]="LINE"}(ir||(ir={})),function(t){t[t.GOURAND=0]="GOURAND",t[t.FLAT=1]="FLAT"}(sr||(sr={})),function(t){t[t.NONE=0]="NONE",t[t.FRONT=1]="FRONT",t[t.BACK=2]="BACK"}(or||(or={})),function(t){t[t.NONE=0]="NONE",t[t.VIEWPORT=1]="VIEWPORT",t[t.SCISSOR=2]="SCISSOR",t[t.LINE_WIDTH=4]="LINE_WIDTH",t[t.DEPTH_BIAS=8]="DEPTH_BIAS",t[t.BLEND_CONSTANTS=16]="BLEND_CONSTANTS",t[t.DEPTH_BOUNDS=32]="DEPTH_BOUNDS",t[t.STENCIL_WRITE_MASK=64]="STENCIL_WRITE_MASK",t[t.STENCIL_COMPARE_MASK=128]="STENCIL_COMPARE_MASK"}(rr||(rr={})),function(t){t[t.FRONT=0]="FRONT",t[t.BACK=1]="BACK",t[t.ALL=2]="ALL"}(ar||(ar={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",t[t.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",t[t.STORAGE_BUFFER=4]="STORAGE_BUFFER",t[t.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",t[t.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",t[t.SAMPLER=32]="SAMPLER",t[t.TEXTURE=64]="TEXTURE",t[t.STORAGE_IMAGE=128]="STORAGE_IMAGE",t[t.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(cr||(cr={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.TRANSFER=2]="TRANSFER"}(lr||(lr={})),function(t){t[t.PRIMARY=0]="PRIMARY",t[t.SECONDARY=1]="SECONDARY"}(hr||(hr={})),function(t){t[t.NONE=0]="NONE",t[t.COLOR=1]="COLOR",t[t.DEPTH=2]="DEPTH",t[t.STENCIL=4]="STENCIL",t[t.DEPTH_STENCIL=6]="DEPTH_STENCIL",t[t.ALL=7]="ALL"}(_r||(_r={}));class dr{constructor(t=0,e=0,n=0){this.x=t,this.y=e,this.z=n}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}}class pr{constructor(t=0,e=0,n=0,i=0,s=0,o=0,r=0,a=0,c=0,l=0,h=0,_=0,u=0,d=0,p=0,f=1,m=0,g=0,v=new dr,y=new dr,x=-1,S=1,T=1){this.maxVertexAttributes=t,this.maxVertexUniformVectors=e,this.maxFragmentUniformVectors=n,this.maxTextureUnits=i,this.maxImageUnits=s,this.maxVertexTextureUnits=o,this.maxColorRenderTargets=r,this.maxShaderStorageBufferBindings=a,this.maxShaderStorageBlockSize=c,this.maxUniformBufferBindings=l,this.maxUniformBlockSize=h,this.maxTextureSize=_,this.maxCubeMapTextureSize=u,this.depthBits=d,this.stencilBits=p,this.uboOffsetAlignment=f,this.maxComputeSharedMemorySize=m,this.maxComputeWorkGroupInvocations=g,this.maxComputeWorkGroupSize=v,this.maxComputeWorkGroupCount=y,this.clipSpaceMinZ=x,this.screenSpaceSignY=S,this.clipSpaceSignY=T}copy(t){return this.maxVertexAttributes=t.maxVertexAttributes,this.maxVertexUniformVectors=t.maxVertexUniformVectors,this.maxFragmentUniformVectors=t.maxFragmentUniformVectors,this.maxTextureUnits=t.maxTextureUnits,this.maxImageUnits=t.maxImageUnits,this.maxVertexTextureUnits=t.maxVertexTextureUnits,this.maxColorRenderTargets=t.maxColorRenderTargets,this.maxShaderStorageBufferBindings=t.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=t.maxShaderStorageBlockSize,this.maxUniformBufferBindings=t.maxUniformBufferBindings,this.maxUniformBlockSize=t.maxUniformBlockSize,this.maxTextureSize=t.maxTextureSize,this.maxCubeMapTextureSize=t.maxCubeMapTextureSize,this.depthBits=t.depthBits,this.stencilBits=t.stencilBits,this.uboOffsetAlignment=t.uboOffsetAlignment,this.maxComputeSharedMemorySize=t.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=t.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(t.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(t.maxComputeWorkGroupCount),this.clipSpaceMinZ=t.clipSpaceMinZ,this.screenSpaceSignY=t.screenSpaceSignY,this.clipSpaceSignY=t.clipSpaceSignY,this}}class fr{constructor(t=0,e=0,n=0){this.x=t,this.y=e,this.z=n}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}}class mr{constructor(t=0,e=0,n=0,i=0){this.x=t,this.y=e,this.width=n,this.height=i}copy(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this}}class gr{constructor(t=0,e=0,n=1){this.width=t,this.height=e,this.depth=n}copy(t){return this.width=t.width,this.height=t.height,this.depth=t.depth,this}}class vr{constructor(t=0,e=0,n=1){this.mipLevel=t,this.baseArrayLayer=e,this.layerCount=n}copy(t){return this.mipLevel=t.mipLevel,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this}}class yr{constructor(t=0,e=1,n=0,i=1){this.baseMipLevel=t,this.levelCount=e,this.baseArrayLayer=n,this.layerCount=i}copy(t){return this.baseMipLevel=t.baseMipLevel,this.levelCount=t.levelCount,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this}}class xr{constructor(t=new vr,e=new fr,n=new vr,i=new fr,s=new gr){this.srcSubres=t,this.srcOffset=e,this.dstSubres=n,this.dstOffset=i,this.extent=s}copy(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.extent.copy(t.extent),this}}class Sr{constructor(t=new vr,e=new fr,n=new gr,i=new vr,s=new fr,o=new gr){this.srcSubres=t,this.srcOffset=e,this.srcExtent=n,this.dstSubres=i,this.dstOffset=s,this.dstExtent=o}copy(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.srcExtent.copy(t.srcExtent),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.dstExtent.copy(t.dstExtent),this}}class Tr{constructor(t=0,e=0,n=new fr,i=new gr,s=new vr){this.buffStride=t,this.buffTexHeight=e,this.texOffset=n,this.texExtent=i,this.texSubres=s}copy(t){return this.buffStride=t.buffStride,this.buffTexHeight=t.buffTexHeight,this.texOffset.copy(t.texOffset),this.texExtent.copy(t.texExtent),this.texSubres.copy(t.texSubres),this}}class Er{constructor(t=0,e=0,n=0,i=0,s=0,o=1){this.left=t,this.top=e,this.width=n,this.height=i,this.minDepth=s,this.maxDepth=o}copy(t){return this.left=t.left,this.top=t.top,this.width=t.width,this.height=t.height,this.minDepth=t.minDepth,this.maxDepth=t.maxDepth,this}}class Ar{constructor(t=0,e=0,n=0,i=0){this.x=t,this.y=e,this.z=n,this.w=i}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}}class Cr{constructor(t=[],e=[],n=0){this.bufferOffsets=t,this.samplerOffsets=e,this.flexibleSet=n}copy(t){return this.bufferOffsets=t.bufferOffsets.slice(),this.samplerOffsets=t.samplerOffsets.slice(),this.flexibleSet=t.flexibleSet,this}}class br{constructor(t=Lo.NONE,e=zo.NONE,n=0,i=0,s=Bo.NONE){this.usage=t,this.memUsage=e,this.size=n,this.stride=i,this.flags=s}copy(t){return this.usage=t.usage,this.memUsage=t.memUsage,this.size=t.size,this.stride=t.stride,this.flags=t.flags,this}}class Pr{constructor(t=null,e=0,n=0){this.buffer=t,this.offset=e,this.range=n}copy(t){return this.buffer=t.buffer,this.offset=t.offset,this.range=t.range,this}}class wr{constructor(t=0,e=0,n=0,i=0,s=0,o=0,r=0){this.vertexCount=t,this.firstVertex=e,this.indexCount=n,this.firstIndex=i,this.vertexOffset=s,this.instanceCount=o,this.firstInstance=r}copy(t){return this.vertexCount=t.vertexCount,this.firstVertex=t.firstVertex,this.indexCount=t.indexCount,this.firstIndex=t.firstIndex,this.vertexOffset=t.vertexOffset,this.instanceCount=t.instanceCount,this.firstInstance=t.firstInstance,this}}class Dr{constructor(t=0,e=0,n=0,i=null,s=0){this.groupCountX=t,this.groupCountY=e,this.groupCountZ=n,this.indirectBuffer=i,this.indirectOffset=s}copy(t){return this.groupCountX=t.groupCountX,this.groupCountY=t.groupCountY,this.groupCountZ=t.groupCountZ,this.indirectBuffer=t.indirectBuffer,this.indirectOffset=t.indirectOffset,this}}class Ir{constructor(t=[]){this.drawInfos=t}copy(t){return bo(this.drawInfos,t.drawInfos,wr),this}}class Rr{constructor(t=Uo.TEX2D,e=Ho.NONE,n=Oo.UNKNOWN,i=0,s=0,o=Go.NONE,r=1,a=1,c=Vo.X1,l=1){this.type=t,this.usage=e,this.format=n,this.width=i,this.height=s,this.flags=o,this.layerCount=r,this.levelCount=a,this.samples=c,this.depth=l}copy(t){return this.type=t.type,this.usage=t.usage,this.format=t.format,this.width=t.width,this.height=t.height,this.flags=t.flags,this.layerCount=t.layerCount,this.levelCount=t.levelCount,this.samples=t.samples,this.depth=t.depth,this}}class Or{constructor(t=null,e=Uo.TEX2D,n=Oo.UNKNOWN,i=0,s=1,o=0,r=1){this.texture=t,this.type=e,this.format=n,this.baseLevel=i,this.levelCount=s,this.baseLayer=o,this.layerCount=r}copy(t){return this.texture=t.texture,this.type=t.type,this.format=t.format,this.baseLevel=t.baseLevel,this.levelCount=t.levelCount,this.baseLayer=t.baseLayer,this.layerCount=t.layerCount,this}}class Mr{constructor(t=jo.LINEAR,e=jo.LINEAR,n=jo.NONE,i=Wo.WRAP,s=Wo.WRAP,o=Wo.WRAP,r=0,a=ko.ALWAYS,c=new Ar,l=0){this.minFilter=t,this.magFilter=e,this.mipFilter=n,this.addressU=i,this.addressV=s,this.addressW=o,this.maxAnisotropy=r,this.cmpFunc=a,this.borderColor=c,this.mipLODBias=l}copy(t){return this.minFilter=t.minFilter,this.magFilter=t.magFilter,this.mipFilter=t.mipFilter,this.addressU=t.addressU,this.addressV=t.addressV,this.addressW=t.addressW,this.maxAnisotropy=t.maxAnisotropy,this.cmpFunc=t.cmpFunc,this.borderColor.copy(t.borderColor),this.mipLODBias=t.mipLODBias,this}}class Nr{constructor(t="",e=No.UNKNOWN,n=0){this.name=t,this.type=e,this.count=n}copy(t){return this.name=t.name,this.type=t.type,this.count=t.count,this}}class Lr{constructor(t=0,e=0,n="",i=[],s=0){this.set=t,this.binding=e,this.name=n,this.members=i,this.count=s}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,bo(this.members,t.members,Nr),this.count=t.count,this}}class Br{constructor(t=0,e=0,n="",i=No.UNKNOWN,s=0){this.set=t,this.binding=e,this.name=n,this.type=i,this.count=s}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this}}class Fr{constructor(t=0,e=0,n="",i=0){this.set=t,this.binding=e,this.name=n,this.count=i}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this}}class zr{constructor(t=0,e=0,n="",i=No.UNKNOWN,s=0){this.set=t,this.binding=e,this.name=n,this.type=i,this.count=s}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this}}class Ur{constructor(t=0,e=0,n="",i=No.UNKNOWN,s=0,o=Fo.READ_WRITE){this.set=t,this.binding=e,this.name=n,this.type=i,this.count=s,this.memoryAccess=o}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this.memoryAccess=t.memoryAccess,this}}class Hr{constructor(t=0,e=0,n="",i=0,s=Fo.READ_WRITE){this.set=t,this.binding=e,this.name=n,this.count=i,this.memoryAccess=s}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this.memoryAccess=t.memoryAccess,this}}class Gr{constructor(t=0,e=0,n="",i=0){this.set=t,this.binding=e,this.name=n,this.count=i}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this}}class Vr{constructor(t=$o.NONE,e=""){this.stage=t,this.source=e}copy(t){return this.stage=t.stage,this.source=t.source,this}}class jr{constructor(t="",e=Oo.UNKNOWN,n=!1,i=0,s=!1,o=0){this.name=t,this.format=e,this.isNormalized=n,this.stream=i,this.isInstanced=s,this.location=o}copy(t){return this.name=t.name,this.format=t.format,this.isNormalized=t.isNormalized,this.stream=t.stream,this.isInstanced=t.isInstanced,this.location=t.location,this}}class Wr{constructor(t="",e=[],n=[],i=[],s=[],o=[],r=[],a=[],c=[],l=[]){this.name=t,this.stages=e,this.attributes=n,this.blocks=i,this.buffers=s,this.samplerTextures=o,this.samplers=r,this.textures=a,this.images=c,this.subpassInputs=l}copy(t){return this.name=t.name,bo(this.stages,t.stages,Vr),bo(this.attributes,t.attributes,jr),bo(this.blocks,t.blocks,Lr),bo(this.buffers,t.buffers,Hr),bo(this.samplerTextures,t.samplerTextures,Br),bo(this.samplers,t.samplers,Fr),bo(this.textures,t.textures,zr),bo(this.images,t.images,Ur),bo(this.subpassInputs,t.subpassInputs,Gr),this}}class kr{constructor(t=[],e=[],n=null,i=null){this.attributes=t,this.vertexBuffers=e,this.indexBuffer=n,this.indirectBuffer=i}copy(t){return bo(this.attributes,t.attributes,jr),this.vertexBuffers=t.vertexBuffers.slice(),this.indexBuffer=t.indexBuffer,this.indirectBuffer=t.indirectBuffer,this}}class qr{constructor(t=Oo.UNKNOWN,e=Vo.X1,n=Zo.CLEAR,i=Jo.STORE,s=[],o=[Qo.PRESENT]){this.format=t,this.sampleCount=e,this.loadOp=n,this.storeOp=i,this.beginAccesses=s,this.endAccesses=o}copy(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.loadOp=t.loadOp,this.storeOp=t.storeOp,this.beginAccesses=t.beginAccesses.slice(),this.endAccesses=t.endAccesses.slice(),this}}class Xr{constructor(t=Oo.UNKNOWN,e=Vo.X1,n=Zo.CLEAR,i=Jo.STORE,s=Zo.CLEAR,o=Jo.STORE,r=[],a=[Qo.DEPTH_STENCIL_ATTACHMENT_WRITE]){this.format=t,this.sampleCount=e,this.depthLoadOp=n,this.depthStoreOp=i,this.stencilLoadOp=s,this.stencilStoreOp=o,this.beginAccesses=r,this.endAccesses=a}copy(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.depthLoadOp=t.depthLoadOp,this.depthStoreOp=t.depthStoreOp,this.stencilLoadOp=t.stencilLoadOp,this.stencilStoreOp=t.stencilStoreOp,this.beginAccesses=t.beginAccesses.slice(),this.endAccesses=t.endAccesses.slice(),this}}class Yr{constructor(t=[],e=[],n=[],i=[],s=-1){this.inputs=t,this.colors=e,this.resolves=n,this.preserves=i,this.depthStencil=s}copy(t){return this.inputs=t.inputs.slice(),this.colors=t.colors.slice(),this.resolves=t.resolves.slice(),this.preserves=t.preserves.slice(),this.depthStencil=t.depthStencil,this}}class Kr{constructor(t=[],e=new Xr,n=[]){this.colorAttachments=t,this.depthStencilAttachment=e,this.subpasses=n}copy(t){return bo(this.colorAttachments,t.colorAttachments,qr),this.depthStencilAttachment.copy(t.depthStencilAttachment),bo(this.subpasses,t.subpasses,Yr),this}}class $r{constructor(t=[],e=[]){this.prevAccesses=t,this.nextAccesses=e}copy(t){return this.prevAccesses=t.prevAccesses.slice(),this.nextAccesses=t.nextAccesses.slice(),this}}class Zr{constructor(t=[],e=[],n=!1,i=null,s=null){this.prevAccesses=t,this.nextAccesses=e,this.discardContents=n,this.srcQueue=i,this.dstQueue=s}copy(t){return this.prevAccesses=t.prevAccesses.slice(),this.nextAccesses=t.nextAccesses.slice(),this.discardContents=t.discardContents,this.srcQueue=t.srcQueue,this.dstQueue=t.dstQueue,this}}class Jr{constructor(t=null,e=[],n=null,i=[],s=0){this.renderPass=t,this.colorTextures=e,this.depthStencilTexture=n,this.colorMipmapLevels=i,this.depthStencilMipmapLevel=s}copy(t){return this.renderPass=t.renderPass,this.colorTextures=t.colorTextures.slice(),this.depthStencilTexture=t.depthStencilTexture,this.colorMipmapLevels=t.colorMipmapLevels.slice(),this.depthStencilMipmapLevel=t.depthStencilMipmapLevel,this}}class Qr{constructor(t=-1,e=cr.UNKNOWN,n=0,i=$o.NONE,s=[]){this.binding=t,this.descriptorType=e,this.count=n,this.stageFlags=i,this.immutableSamplers=s}copy(t){return this.binding=t.binding,this.descriptorType=t.descriptorType,this.count=t.count,this.stageFlags=t.stageFlags,this.immutableSamplers=t.immutableSamplers.slice(),this}}class ta{constructor(t=[]){this.bindings=t}copy(t){return bo(this.bindings,t.bindings,Qr),this}}class ea{constructor(t=null){this.layout=t}copy(t){return this.layout=t.layout,this}}class na{constructor(t=[]){this.setLayouts=t}copy(t){return this.setLayouts=t.setLayouts.slice(),this}}class ia{constructor(t=[]){this.attributes=t}copy(t){return bo(this.attributes,t.attributes,jr),this}}class sa{constructor(t=null,e=hr.PRIMARY){this.queue=t,this.type=e}copy(t){return this.queue=t.queue,this.type=t.type,this}}class oa{constructor(t=lr.GRAPHICS){this.type=t}copy(t){return this.type=t.type,this}}class ra{constructor(t="",e=0,n=0,i=Mo.NONE,s=!1,o=!1,r=!1,a=!1){this.name=t,this.size=e,this.count=n,this.type=i,this.hasAlpha=s,this.hasDepth=o,this.hasStencil=r,this.isCompressed=a}}class aa{constructor(t=0,e=0){this.bufferSize=t,this.textureSize=e}copy(t){return this.bufferSize=t.bufferSize,this.textureSize=t.textureSize,this}}class ca{get gfxType(){return this._gfxType}constructor(t){this._gfxType=Po.UNKNOWN,this._gfxType=t}}class la{constructor(t,e=!0,n=!0,i=1,s=1,o=1,r=new Cr){this.canvasElm=t,this.isAntialias=e,this.isPremultipliedAlpha=n,this.devicePixelRatio=i,this.nativeWidth=s,this.nativeHeight=o,this.bindingMappingInfo=r}}!function(t){t.ATTR_POSITION="a_position",t.ATTR_NORMAL="a_normal",t.ATTR_TANGENT="a_tangent",t.ATTR_BITANGENT="a_bitangent",t.ATTR_WEIGHTS="a_weights",t.ATTR_JOINTS="a_joints",t.ATTR_COLOR="a_color",t.ATTR_COLOR1="a_color1",t.ATTR_COLOR2="a_color2",t.ATTR_TEX_COORD="a_texCoord",t.ATTR_TEX_COORD1="a_texCoord1",t.ATTR_TEX_COORD2="a_texCoord2",t.ATTR_TEX_COORD3="a_texCoord3",t.ATTR_TEX_COORD4="a_texCoord4",t.ATTR_TEX_COORD5="a_texCoord5",t.ATTR_TEX_COORD6="a_texCoord6",t.ATTR_TEX_COORD7="a_texCoord7",t.ATTR_TEX_COORD8="a_texCoord8",t.ATTR_BATCH_ID="a_batch_id",t.ATTR_BATCH_UV="a_batch_uv"}(ur||(ur={}));const ha=Object.freeze([new ra("UNKNOWN",0,0,Mo.NONE,!1,!1,!1,!1),new ra("A8",1,1,Mo.UNORM,!0,!1,!1,!1),new ra("L8",1,1,Mo.UNORM,!1,!1,!1,!1),new ra("LA8",1,2,Mo.UNORM,!0,!1,!1,!1),new ra("R8",1,1,Mo.UNORM,!1,!1,!1,!1),new ra("R8SN",1,1,Mo.SNORM,!1,!1,!1,!1),new ra("R8UI",1,1,Mo.UINT,!1,!1,!1,!1),new ra("R8I",1,1,Mo.INT,!1,!1,!1,!1),new ra("R16F",2,1,Mo.FLOAT,!1,!1,!1,!1),new ra("R16UI",2,1,Mo.UINT,!1,!1,!1,!1),new ra("R16I",2,1,Mo.INT,!1,!1,!1,!1),new ra("R32F",4,1,Mo.FLOAT,!1,!1,!1,!1),new ra("R32UI",4,1,Mo.UINT,!1,!1,!1,!1),new ra("R32I",4,1,Mo.INT,!1,!1,!1,!1),new ra("RG8",2,2,Mo.UNORM,!1,!1,!1,!1),new ra("RG8SN",2,2,Mo.SNORM,!1,!1,!1,!1),new ra("RG8UI",2,2,Mo.UINT,!1,!1,!1,!1),new ra("RG8I",2,2,Mo.INT,!1,!1,!1,!1),new ra("RG16F",4,2,Mo.FLOAT,!1,!1,!1,!1),new ra("RG16UI",4,2,Mo.UINT,!1,!1,!1,!1),new ra("RG16I",4,2,Mo.INT,!1,!1,!1,!1),new ra("RG32F",8,2,Mo.FLOAT,!1,!1,!1,!1),new ra("RG32UI",8,2,Mo.UINT,!1,!1,!1,!1),new ra("RG32I",8,2,Mo.INT,!1,!1,!1,!1),new ra("RGB8",3,3,Mo.UNORM,!1,!1,!1,!1),new ra("SRGB8",3,3,Mo.UNORM,!1,!1,!1,!1),new ra("RGB8SN",3,3,Mo.SNORM,!1,!1,!1,!1),new ra("RGB8UI",3,3,Mo.UINT,!1,!1,!1,!1),new ra("RGB8I",3,3,Mo.INT,!1,!1,!1,!1),new ra("RGB16F",6,3,Mo.FLOAT,!1,!1,!1,!1),new ra("RGB16UI",6,3,Mo.UINT,!1,!1,!1,!1),new ra("RGB16I",6,3,Mo.INT,!1,!1,!1,!1),new ra("RGB32F",12,3,Mo.FLOAT,!1,!1,!1,!1),new ra("RGB32UI",12,3,Mo.UINT,!1,!1,!1,!1),new ra("RGB32I",12,3,Mo.INT,!1,!1,!1,!1),new ra("RGBA8",4,4,Mo.UNORM,!0,!1,!1,!1),new ra("BGRA8",4,4,Mo.UNORM,!0,!1,!1,!1),new ra("SRGB8_A8",4,4,Mo.UNORM,!0,!1,!1,!1),new ra("RGBA8SN",4,4,Mo.SNORM,!0,!1,!1,!1),new ra("RGBA8UI",4,4,Mo.UINT,!0,!1,!1,!1),new ra("RGBA8I",4,4,Mo.INT,!0,!1,!1,!1),new ra("RGBA16F",8,4,Mo.FLOAT,!0,!1,!1,!1),new ra("RGBA16UI",8,4,Mo.UINT,!0,!1,!1,!1),new ra("RGBA16I",8,4,Mo.INT,!0,!1,!1,!1),new ra("RGBA32F",16,4,Mo.FLOAT,!0,!1,!1,!1),new ra("RGBA32UI",16,4,Mo.UINT,!0,!1,!1,!1),new ra("RGBA32I",16,4,Mo.INT,!0,!1,!1,!1),new ra("R5G6B5",2,3,Mo.UNORM,!1,!1,!1,!1),new ra("R11G11B10F",4,3,Mo.FLOAT,!1,!1,!1,!1),new ra("RGB5A1",2,4,Mo.UNORM,!0,!1,!1,!1),new ra("RGBA4",2,4,Mo.UNORM,!0,!1,!1,!1),new ra("RGB10A2",2,4,Mo.UNORM,!0,!1,!1,!1),new ra("RGB10A2UI",2,4,Mo.UINT,!0,!1,!1,!1),new ra("RGB9E5",2,4,Mo.FLOAT,!0,!1,!1,!1),new ra("D16",2,1,Mo.UINT,!1,!0,!1,!1),new ra("D16S8",3,2,Mo.UINT,!1,!0,!0,!1),new ra("D24",3,1,Mo.UINT,!1,!0,!1,!1),new ra("D24S8",4,2,Mo.UINT,!1,!0,!0,!1),new ra("D32F",4,1,Mo.FLOAT,!1,!0,!1,!1),new ra("D32FS8",5,2,Mo.FLOAT,!1,!0,!0,!1),new ra("BC1",1,3,Mo.UNORM,!1,!1,!1,!0),new ra("BC1_ALPHA",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("BC1_SRGB",1,3,Mo.UNORM,!1,!1,!1,!0),new ra("BC1_SRGB_ALPHA",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("BC2",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("BC2_SRGB",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("BC3",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("BC3_SRGB",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("BC4",1,1,Mo.UNORM,!1,!1,!1,!0),new ra("BC4_SNORM",1,1,Mo.SNORM,!1,!1,!1,!0),new ra("BC5",1,2,Mo.UNORM,!1,!1,!1,!0),new ra("BC5_SNORM",1,2,Mo.SNORM,!1,!1,!1,!0),new ra("BC6H_UF16",1,3,Mo.UFLOAT,!1,!1,!1,!0),new ra("BC6H_SF16",1,3,Mo.FLOAT,!1,!1,!1,!0),new ra("BC7",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("BC7_SRGB",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ETC_RGB8",1,3,Mo.UNORM,!1,!1,!1,!0),new ra("ETC2_RGB8",1,3,Mo.UNORM,!1,!1,!1,!0),new ra("ETC2_SRGB8",1,3,Mo.UNORM,!1,!1,!1,!0),new ra("ETC2_RGB8_A1",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ETC2_SRGB8_A1",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ETC2_RGBA8",2,4,Mo.UNORM,!0,!1,!1,!0),new ra("ETC2_SRGB8_A8",2,4,Mo.UNORM,!0,!1,!1,!0),new ra("EAC_R11",1,1,Mo.UNORM,!1,!1,!1,!0),new ra("EAC_R11SN",1,1,Mo.SNORM,!1,!1,!1,!0),new ra("EAC_RG11",2,2,Mo.UNORM,!1,!1,!1,!0),new ra("EAC_RG11SN",2,2,Mo.SNORM,!1,!1,!1,!0),new ra("PVRTC_RGB2",2,3,Mo.UNORM,!1,!1,!1,!0),new ra("PVRTC_RGBA2",2,4,Mo.UNORM,!0,!1,!1,!0),new ra("PVRTC_RGB4",2,3,Mo.UNORM,!1,!1,!1,!0),new ra("PVRTC_RGBA4",2,4,Mo.UNORM,!0,!1,!1,!0),new ra("PVRTC2_2BPP",2,4,Mo.UNORM,!0,!1,!1,!0),new ra("PVRTC2_4BPP",2,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_4x4",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_5x4",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_5x5",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_6x5",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_6x6",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_8x5",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_8x6",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_8x8",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_10x5",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_10x6",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_10x8",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_10x10",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_12x10",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_12x12",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_4x4",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_5x4",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_5x5",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_6x5",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_6x6",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_8x5",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_8x6",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_8x8",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_10x5",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_10x6",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_10x8",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_10x10",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_12x10",1,4,Mo.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_12x12",1,4,Mo.UNORM,!0,!1,!1,!0)]),_a=cr.UNIFORM_BUFFER|cr.DYNAMIC_UNIFORM_BUFFER|cr.STORAGE_BUFFER|cr.DYNAMIC_STORAGE_BUFFER,ua=cr.SAMPLER_TEXTURE|cr.SAMPLER|cr.TEXTURE|cr.STORAGE_IMAGE|cr.INPUT_ATTACHMENT,da=cr.DYNAMIC_STORAGE_BUFFER|cr.DYNAMIC_UNIFORM_BUFFER;function pa(t){return t>0&&0==(t&t-1)}function fa(t,e,n,i){if(!ha[t].isCompressed)return e*n*i*ha[t].size;switch(t){case Oo.BC1:case Oo.BC1_ALPHA:case Oo.BC1_SRGB:case Oo.BC1_SRGB_ALPHA:return Math.ceil(e/4)*Math.ceil(n/4)*8*i;case Oo.BC2:case Oo.BC2_SRGB:case Oo.BC3:case Oo.BC3_SRGB:case Oo.BC4:case Oo.BC4_SNORM:case Oo.BC6H_SF16:case Oo.BC6H_UF16:case Oo.BC7:case Oo.BC7_SRGB:return Math.ceil(e/4)*Math.ceil(n/4)*16*i;case Oo.BC5:case Oo.BC5_SNORM:return Math.ceil(e/4)*Math.ceil(n/4)*32*i;case Oo.ETC_RGB8:case Oo.ETC2_RGB8:case Oo.ETC2_SRGB8:case Oo.ETC2_RGB8_A1:case Oo.EAC_R11:case Oo.EAC_R11SN:return Math.ceil(e/4)*Math.ceil(n/4)*8*i;case Oo.ETC2_RGBA8:case Oo.ETC2_SRGB8_A1:case Oo.EAC_RG11:case Oo.EAC_RG11SN:return Math.ceil(e/4)*Math.ceil(n/4)*16*i;case Oo.PVRTC_RGB2:case Oo.PVRTC_RGBA2:case Oo.PVRTC2_2BPP:return Math.ceil(Math.max(e,16)*Math.max(n,8)/4)*i;case Oo.PVRTC_RGB4:case Oo.PVRTC_RGBA4:case Oo.PVRTC2_4BPP:return Math.ceil(Math.max(e,8)*Math.max(n,8)/2)*i;case Oo.ASTC_RGBA_4x4:case Oo.ASTC_SRGBA_4x4:return Math.ceil(e/4)*Math.ceil(n/4)*16*i;case Oo.ASTC_RGBA_5x4:case Oo.ASTC_SRGBA_5x4:return Math.ceil(e/5)*Math.ceil(n/4)*16*i;case Oo.ASTC_RGBA_5x5:case Oo.ASTC_SRGBA_5x5:return Math.ceil(e/5)*Math.ceil(n/5)*16*i;case Oo.ASTC_RGBA_6x5:case Oo.ASTC_SRGBA_6x5:return Math.ceil(e/6)*Math.ceil(n/5)*16*i;case Oo.ASTC_RGBA_6x6:case Oo.ASTC_SRGBA_6x6:return Math.ceil(e/6)*Math.ceil(n/6)*16*i;case Oo.ASTC_RGBA_8x5:case Oo.ASTC_SRGBA_8x5:return Math.ceil(e/8)*Math.ceil(n/5)*16*i;case Oo.ASTC_RGBA_8x6:case Oo.ASTC_SRGBA_8x6:return Math.ceil(e/8)*Math.ceil(n/6)*16*i;case Oo.ASTC_RGBA_8x8:case Oo.ASTC_SRGBA_8x8:return Math.ceil(e/8)*Math.ceil(n/8)*16*i;case Oo.ASTC_RGBA_10x5:case Oo.ASTC_SRGBA_10x5:return Math.ceil(e/10)*Math.ceil(n/5)*16*i;case Oo.ASTC_RGBA_10x6:case Oo.ASTC_SRGBA_10x6:return Math.ceil(e/10)*Math.ceil(n/6)*16*i;case Oo.ASTC_RGBA_10x8:case Oo.ASTC_SRGBA_10x8:return Math.ceil(e/10)*Math.ceil(n/8)*16*i;case Oo.ASTC_RGBA_10x10:case Oo.ASTC_SRGBA_10x10:return Math.ceil(e/10)*Math.ceil(n/10)*16*i;case Oo.ASTC_RGBA_12x10:case Oo.ASTC_SRGBA_12x10:return Math.ceil(e/12)*Math.ceil(n/10)*16*i;case Oo.ASTC_RGBA_12x12:case Oo.ASTC_SRGBA_12x12:return Math.ceil(e/12)*Math.ceil(n/12)*16*i;default:return 0}}function ma(t,e,n,i,s){let o=0;for(let r=0;r<s;++r)o+=fa(t,e,n,i),e=Math.max(e>>1,1),n=Math.max(n>>1,1);return o}const ga=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function va(t){return ga[t]||0}function ya(t){const e=t.size/t.count;switch(t.type){case Mo.UNORM:case Mo.UINT:switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case Mo.SNORM:case Mo.INT:switch(e){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case Mo.FLOAT:return Float32Array}return Float32Array}var xa=Object.freeze({__proto__:null,get ObjectType(){return Po},get Status(){return wo},get API(){return Do},get SurfaceTransform(){return Io},get Feature(){return Ro},get Format(){return Oo},get FormatType(){return Mo},get Type(){return No},get BufferUsageBit(){return Lo},get BufferFlagBit(){return Bo},get MemoryAccessBit(){return Fo},get MemoryUsageBit(){return zo},get TextureType(){return Uo},get TextureUsageBit(){return Ho},get TextureFlagBit(){return Go},get SampleCount(){return Vo},get Filter(){return jo},get Address(){return Wo},get ComparisonFunc(){return ko},get StencilOp(){return qo},get BlendFactor(){return Xo},get BlendOp(){return Yo},get ColorMask(){return Ko},get ShaderStageFlagBit(){return $o},get LoadOp(){return Zo},get StoreOp(){return Jo},get AccessType(){return Qo},get PipelineBindPoint(){return tr},get PrimitiveMode(){return er},get PolygonMode(){return ir},get ShadeModel(){return sr},get CullMode(){return or},get DynamicStateFlagBit(){return rr},get StencilFace(){return ar},get DescriptorType(){return cr},get QueueType(){return lr},get CommandBufferType(){return hr},get ClearFlagBit(){return _r},Size:dr,DeviceCaps:pr,Offset:fr,Rect:mr,Extent:gr,TextureSubresLayers:vr,TextureSubresRange:yr,TextureCopy:xr,TextureBlit:Sr,BufferTextureCopy:Tr,Viewport:Er,Color:Ar,BindingMappingInfo:Cr,BufferInfo:br,BufferViewInfo:Pr,DrawInfo:wr,DispatchInfo:Dr,IndirectBuffer:Ir,TextureInfo:Rr,TextureViewInfo:Or,SamplerInfo:Mr,Uniform:Nr,UniformBlock:Lr,UniformSamplerTexture:Br,UniformSampler:Fr,UniformTexture:zr,UniformStorageImage:Ur,UniformStorageBuffer:Hr,UniformInputAttachment:Gr,ShaderStage:Vr,Attribute:jr,ShaderInfo:Wr,InputAssemblerInfo:kr,ColorAttachment:qr,DepthStencilAttachment:Xr,SubpassInfo:Yr,RenderPassInfo:Kr,GlobalBarrierInfo:$r,TextureBarrierInfo:Zr,FramebufferInfo:Jr,DescriptorSetLayoutBinding:Qr,DescriptorSetLayoutInfo:ta,DescriptorSetInfo:ea,PipelineLayoutInfo:na,InputState:ia,CommandBufferInfo:sa,QueueInfo:oa,FormatInfo:ra,MemoryStatus:aa,Obj:ca,DeviceInfo:la,get AttributeName(){return ur},FormatInfos:ha,DESCRIPTOR_BUFFER_TYPE:_a,DESCRIPTOR_SAMPLER_TYPE:ua,DESCRIPTOR_DYNAMIC_TYPE:da,DRAW_INFO_SIZE:28,IsPowerOf2:pa,FormatSize:fa,FormatSurfaceSize:ma,GetTypeSize:va,getTypedArrayConstructor:ya});class Sa{constructor(t=!1,e=ir.FILL,n=sr.GOURAND,i=or.BACK,s=!0,o=!1,r=0,a=0,c=0,l=!0,h=!1,_=1){this.h=void 0,this.h=Ys.alloc(),this.assignProperties(t,e,n,i,s,o,r,a,c,l,h,_)}get isDiscard(){return!!Ys.get(this.h,qs.IS_DISCARD)}set isDiscard(t){Ys.set(this.h,qs.IS_DISCARD,t?1:0)}get polygonMode(){return Ys.get(this.h,qs.POLYGO_MODEL)}set polygonMode(t){Ys.set(this.h,qs.POLYGO_MODEL,t)}get shadeModel(){return Ys.get(this.h,qs.SHADE_MODEL)}set shadeModel(t){Ys.set(this.h,qs.SHADE_MODEL,t)}get cullMode(){return Ys.get(this.h,qs.CULL_MODE)}set cullMode(t){Ys.set(this.h,qs.CULL_MODE,t)}get isFrontFaceCCW(){return!!Ys.get(this.h,qs.IS_FRONT_FACE_CCW)}set isFrontFaceCCW(t){Ys.set(this.h,qs.IS_FRONT_FACE_CCW,t?1:0)}get depthBiasEnabled(){return!!Ys.get(this.h,qs.DEPTH_BIAS_ENABLED)}set depthBiasEnabled(t){Ys.set(this.h,qs.DEPTH_BIAS_ENABLED,t?1:0)}get depthBias(){return Ys.get(this.h,qs.DEPTH_BIAS)}set depthBias(t){Ys.set(this.h,qs.DEPTH_BIAS,t)}get depthBiasClamp(){return Ys.get(this.h,qs.DEPTH_BIAS_CLAMP)}set depthBiasClamp(t){Ys.set(this.h,qs.DEPTH_BIAS_CLAMP,t)}get depthBiasSlop(){return Ys.get(this.h,qs.DEPTH_BIAS_SLOP)}set depthBiasSlop(t){Ys.set(this.h,qs.DEPTH_BIAS_SLOP,t)}get isDepthClip(){return!!Ys.get(this.h,qs.IS_DEPTH_CLIP)}set isDepthClip(t){Ys.set(this.h,qs.IS_DEPTH_CLIP,t?1:0)}get isMultisample(){return!!Ys.get(this.h,qs.IS_MULTI_SAMPLE)}set isMultisample(t){Ys.set(this.h,qs.IS_MULTI_SAMPLE,t?1:0)}get lineWidth(){return Ys.get(this.h,qs.LINE_WIDTH)}set lineWidth(t){Ys.set(this.h,qs.LINE_WIDTH,t)}get handle(){return this.h}reset(){this.assignProperties(!1,ir.FILL,sr.GOURAND,or.BACK,!0,!1,0,0,0,!0,!1,1)}assign(t){t&&this.assignProperties(t.isDiscard,t.polygonMode,t.shadeModel,t.cullMode,t.isFrontFaceCCW,t.depthBiasEnabled,t.depthBias,t.depthBiasClamp,t.depthBiasSlop,t.isDepthClip,t.isMultisample,t.lineWidth)}destroy(){this.h&&(Ys.free(this.h),this.h=0)}assignProperties(t,e,n,i,s,o,r,a,c,l,h,_){void 0!==t&&(this.isDiscard=t),void 0!==e&&(this.polygonMode=e),void 0!==n&&(this.shadeModel=n),void 0!==i&&(this.cullMode=i),void 0!==s&&(this.isFrontFaceCCW=s),void 0!==o&&(this.depthBiasEnabled=o),void 0!==r&&(this.depthBias=r),void 0!==a&&(this.depthBiasClamp=a),void 0!==c&&(this.depthBiasSlop=c),void 0!==l&&(this.isDepthClip=l),void 0!==h&&(this.isMultisample=h),void 0!==_&&(this.lineWidth=_)}}class Ta{constructor(t=!0,e=!0,n=ko.LESS,i=!1,s=ko.ALWAYS,o=65535,r=65535,a=qo.KEEP,c=qo.KEEP,l=qo.KEEP,h=1,_=!1,u=ko.ALWAYS,d=65535,p=65535,f=qo.KEEP,m=qo.KEEP,g=qo.KEEP,v=1){this.h=void 0,this.h=Zs.alloc(),this.assignProperties(t,e,n,i,s,o,r,a,c,l,h,_,u,d,p,f,m,g,v)}get depthTest(){return!!Zs.get(this.h,Ks.DEPTH_TEST)}set depthTest(t){Zs.set(this.h,Ks.DEPTH_TEST,t?1:0)}get depthWrite(){return!!Zs.get(this.h,Ks.DEPTH_WRITE)}set depthWrite(t){Zs.set(this.h,Ks.DEPTH_WRITE,t?1:0)}get depthFunc(){return Zs.get(this.h,Ks.DEPTH_FUNC)}set depthFunc(t){Zs.set(this.h,Ks.DEPTH_FUNC,t)}get stencilTestFront(){return!!Zs.get(this.h,Ks.STENCIL_TEST_FRONT)}set stencilTestFront(t){Zs.set(this.h,Ks.STENCIL_TEST_FRONT,t?1:0)}get stencilFuncFront(){return Zs.get(this.h,Ks.STENCIL_FUNC_FRONT)}set stencilFuncFront(t){Zs.set(this.h,Ks.STENCIL_FUNC_FRONT,t)}get stencilReadMaskFront(){return Zs.get(this.h,Ks.STENCIL_READ_MASK_FRONT)}set stencilReadMaskFront(t){Zs.set(this.h,Ks.STENCIL_READ_MASK_FRONT,t)}get stencilWriteMaskFront(){return Zs.get(this.h,Ks.STENCIL_WRITE_MASK_FRONT)}set stencilWriteMaskFront(t){Zs.set(this.h,Ks.STENCIL_WRITE_MASK_FRONT,t)}get stencilFailOpFront(){return Zs.get(this.h,Ks.STENCIL_FAIL_OP_FRONT)}set stencilFailOpFront(t){Zs.set(this.h,Ks.STENCIL_FAIL_OP_FRONT,t)}get stencilZFailOpFront(){return Zs.get(this.h,Ks.STENCIL_Z_FAIL_OP_FRONT)}set stencilZFailOpFront(t){Zs.set(this.h,Ks.STENCIL_Z_FAIL_OP_FRONT,t)}get stencilPassOpFront(){return Zs.get(this.h,Ks.STENCIL_PASS_OP_FRONT)}set stencilPassOpFront(t){Zs.set(this.h,Ks.STENCIL_PASS_OP_FRONT,t)}get stencilRefFront(){return Zs.get(this.h,Ks.STENCIL_REF_FRONT)}set stencilRefFront(t){Zs.set(this.h,Ks.STENCIL_REF_FRONT,t)}get stencilTestBack(){return!!Zs.get(this.h,Ks.STENCIL_TEST_BACK)}set stencilTestBack(t){Zs.set(this.h,Ks.STENCIL_TEST_BACK,t?1:0)}get stencilFuncBack(){return Zs.get(this.h,Ks.STENCIL_FUNC_BACK)}set stencilFuncBack(t){Zs.set(this.h,Ks.STENCIL_FUNC_BACK,t)}get stencilReadMaskBack(){return Zs.get(this.h,Ks.STENCIL_READ_MADK_BACK)}set stencilReadMaskBack(t){Zs.set(this.h,Ks.STENCIL_READ_MADK_BACK,t)}get stencilWriteMaskBack(){return Zs.get(this.h,Ks.STENCIL_WRITE_MASK_BACK)}set stencilWriteMaskBack(t){Zs.set(this.h,Ks.STENCIL_WRITE_MASK_BACK,t)}get stencilFailOpBack(){return Zs.get(this.h,Ks.STENCIL_FAIL_OP_BACK)}set stencilFailOpBack(t){Zs.set(this.h,Ks.STENCIL_FAIL_OP_BACK,t)}get stencilZFailOpBack(){return Zs.get(this.h,Ks.STENCIL_Z_FAIL_OP_BACK)}set stencilZFailOpBack(t){Zs.set(this.h,Ks.STENCIL_Z_FAIL_OP_BACK,t)}get stencilPassOpBack(){return Zs.get(this.h,Ks.STENCIL_PASS_OP_BACK)}set stencilPassOpBack(t){Zs.set(this.h,Ks.STENCIL_PASS_OP_BACK,t)}get stencilRefBack(){return Zs.get(this.h,Ks.STENCIL_REF_BACK)}set stencilRefBack(t){Zs.set(this.h,Ks.STENCIL_REF_BACK,t)}get handle(){return this.h}reset(){this.assignProperties(!0,!0,ko.LESS,!1,ko.ALWAYS,65535,65535,qo.KEEP,qo.KEEP,qo.KEEP,1,!1,ko.ALWAYS,65535,65535,qo.KEEP,qo.KEEP,qo.KEEP,1)}assign(t){t&&this.assignProperties(t.depthTest,t.depthWrite,t.depthFunc,t.stencilTestFront,t.stencilFuncFront,t.stencilReadMaskFront,t.stencilWriteMaskFront,t.stencilFailOpFront,t.stencilZFailOpFront,t.stencilPassOpFront,t.stencilRefFront,t.stencilTestBack,t.stencilFuncBack,t.stencilReadMaskBack,t.stencilWriteMaskBack,t.stencilFailOpBack,t.stencilZFailOpBack,t.stencilPassOpBack,t.stencilRefBack)}destroy(){Zs.free(this.h),this.h=0}assignProperties(t,e,n,i,s,o,r,a,c,l,h,_,u,d,p,f,m,g,v){void 0!==t&&(this.depthTest=t),void 0!==e&&(this.depthWrite=e),void 0!==n&&(this.depthFunc=n),void 0!==i&&(this.stencilTestFront=i),void 0!==s&&(this.stencilFuncFront=s),void 0!==o&&(this.stencilReadMaskFront=o),void 0!==r&&(this.stencilWriteMaskFront=r),void 0!==a&&(this.stencilFailOpFront=a),void 0!==c&&(this.stencilZFailOpFront=c),void 0!==l&&(this.stencilPassOpFront=l),void 0!==h&&(this.stencilRefFront=h),void 0!==_&&(this.stencilTestBack=_),void 0!==u&&(this.stencilFuncBack=u),void 0!==d&&(this.stencilReadMaskBack=d),void 0!==p&&(this.stencilWriteMaskBack=p),void 0!==f&&(this.stencilFailOpBack=f),void 0!==m&&(this.stencilZFailOpBack=m),void 0!==g&&(this.stencilPassOpBack=g),void 0!==v&&(this.stencilRefBack=v)}}class Ea{constructor(t=!1,e=Xo.ONE,n=Xo.ZERO,i=Yo.ADD,s=Xo.ONE,o=Xo.ZERO,r=Yo.ADD,a=Ko.ALL){this.h=void 0,this.h=Qs.alloc(),this.assignProperties(t,e,n,i,s,o,r,a)}get blend(){return!!Qs.get(this.h,Js.BLEND)}set blend(t){Qs.set(this.h,Js.BLEND,t?1:0)}get blendSrc(){return Qs.get(this.h,Js.BLEND_SRC)}set blendSrc(t){Qs.set(this.h,Js.BLEND_SRC,t)}get blendDst(){return Qs.get(this.h,Js.BLEND_DST)}set blendDst(t){Qs.set(this.h,Js.BLEND_DST,t)}get blendEq(){return Qs.get(this.h,Js.BLEND_EQ)}set blendEq(t){Qs.set(this.h,Js.BLEND_EQ,t)}get blendSrcAlpha(){return Qs.get(this.h,Js.BLEND_SRC_ALPHA)}set blendSrcAlpha(t){Qs.set(this.h,Js.BLEND_SRC_ALPHA,t)}get blendDstAlpha(){return Qs.get(this.h,Js.BLEND_DST_ALPHA)}set blendDstAlpha(t){Qs.set(this.h,Js.BLEND_DST_ALPHA,t)}get blendAlphaEq(){return Qs.get(this.h,Js.BLEND_ALPHA_EQ)}set blendAlphaEq(t){Qs.set(this.h,Js.BLEND_ALPHA_EQ,t)}get blendColorMask(){return Qs.get(this.h,Js.BLEND_COLOR_MASK)}set blendColorMask(t){Qs.set(this.h,Js.BLEND_COLOR_MASK,t)}get handle(){return this.h}reset(){this.assignProperties(!1,Xo.ONE,Xo.ZERO,Yo.ADD,Xo.ONE,Xo.ZERO,Yo.ADD,Ko.ALL)}destroy(){Qs.free(this.h),this.h=0}assign(t){t&&this.assignProperties(t.blend,t.blendSrc,t.blendDst,t.blendEq,t.blendSrcAlpha,t.blendDstAlpha,t.blendAlphaEq,t.blendColorMask)}assignProperties(t,e,n,i,s,o,r,a){void 0!==t&&(this.blend=t),void 0!==e&&(this.blendSrc=e),void 0!==n&&(this.blendDst=n),void 0!==i&&(this.blendEq=i),void 0!==s&&(this.blendSrcAlpha=s),void 0!==o&&(this.blendDstAlpha=o),void 0!==r&&(this.blendAlphaEq=r),void 0!==a&&(this.blendColorMask=a)}}class Aa{constructor(t=!1,e=!1,n=new Ar,i=[new Ea]){this.h=void 0,this.hBt=void 0,this.targets=void 0,this._blendColor=void 0,this.h=no.alloc(),this.targets=i,this.blendColor=n,this.isA2c=t,this.isIndepend=e,this.blendColor=n,this.hBt=Bi.alloc(),no.set(this.h,to.BLEND_TARGET,this.hBt);for(let t=0,e=i.length;t<e;++t)Bi.push(this.hBt,i[t].handle)}get isA2c(){return!!no.get(this.h,to.IS_A2C)}set isA2c(t){no.set(this.h,to.IS_A2C,t?1:0)}get isIndepend(){return!!no.get(this.h,to.IS_INDEPEND)}set isIndepend(t){no.set(this.h,to.IS_INDEPEND,t?1:0)}get blendColor(){return this._blendColor}set blendColor(t){this._blendColor=t,no.setVec4(this.h,to.BLEND_COLOR,t)}get handle(){return this.h}setTarget(t,e){let n=this.targets[t];n||(n=this.targets[t]=new Ea,Bi.assign(this.hBt,t,n.handle)),n.assign(e)}reset(){this.isA2c=!1,this.isIndepend=!1,no.setVec4(this.h,to.BLEND_COLOR,new Ar(0,0,0,0));const t=this.targets;for(let e=1,n=t.length;e<n;++e)t[e].destroy();t.length=1,t[0].reset(),Bi.clear(this.hBt),Bi.push(this.hBt,t[0].handle)}destroy(){no.free(this.h),this.h=0,Bi.free(this.hBt),this.hBt=0;for(let t=0,e=this.targets.length;t<e;++t)this.targets[t].destroy();this.targets=null}}const Ca=gfx.PipelineState,ba=gfx.PipelineStateInfo;class Pa extends ca{get layout(){return this._layout}constructor(t){super(Po.DESCRIPTOR_SET),this._device=void 0,this._layout=null,this._buffers=[],this._textures=[],this._samplers=[],this._isDirty=!1,this._device=t}bindBuffer(t,e,n=0){const i=this._layout.bindingIndices[t],s=this._layout.bindings[i];if(s)if(s.descriptorType&_a){const i=this._layout.descriptorIndices[t];this._buffers[i+n]!==e&&(this._buffers[i+n]=e,this._isDirty=!0)}else console.warn("Setting binding is not DescriptorType.UNIFORM_BUFFER.")}bindSampler(t,e,n=0){const i=this._layout.bindingIndices[t],s=this._layout.bindings[i];if(s)if(s.descriptorType&ua){const i=this._layout.descriptorIndices[t];this._samplers[i+n]!==e&&(this._samplers[i+n]=e,this._isDirty=!0)}else console.warn("Setting binding is not DescriptorType.SAMPLER.")}bindTexture(t,e,n=0){const i=this._layout.bindingIndices[t],s=this._layout.bindings[i];if(s)if(s.descriptorType&ua){const i=this._layout.descriptorIndices[t];this._textures[i+n]!==e&&(this._textures[i+n]=e,this._isDirty=!0)}else console.warn("Setting binding is not DescriptorType.SAMPLER.")}getBuffer(t,e=0){const n=this._layout.descriptorIndices[t];return this._buffers[n+e]}getSampler(t,e=0){const n=this._layout.descriptorIndices[t];return this._samplers[n+e]}getTexture(t,e=0){const n=this._layout.descriptorIndices[t];return this._textures[n+e]}}class wa extends ca{get usage(){return this._usage}get memUsage(){return this._memUsage}get size(){return this._size}get stride(){return this._stride}get count(){return this._count}get flags(){return this._flags}constructor(t){super(Po.BUFFER),this._device=void 0,this._usage=Lo.NONE,this._memUsage=zo.NONE,this._size=0,this._stride=1,this._count=0,this._flags=Bo.NONE,this._indirectBuffer=null,this._isBufferView=!1,this._device=t}}class Da extends ca{get type(){return this._type}get queue(){return this._queue}get numDrawCalls(){return this._numDrawCalls}get numInstances(){return this._numInstances}get numTris(){return this._numTris}constructor(t){super(Po.COMMAND_BUFFER),this._device=void 0,this._queue=null,this._type=hr.PRIMARY,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._device=t}}Mt(Oo);class Ia{constructor(){this._canvas=null,this._canvas2D=null,this._gfxAPI=Do.UNKNOWN,this._transform=Io.IDENTITY,this._deviceName="",this._renderer="",this._vendor="",this._version="",this._features=new Array(Ro.COUNT),this._queue=null,this._cmdBuff=null,this._devicePixelRatio=1,this._width=0,this._height=0,this._nativeWidth=0,this._nativeHeight=0,this._colorFmt=Oo.UNKNOWN,this._depthStencilFmt=Oo.UNKNOWN,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new aa,this._caps=new pr}get canvas(){return this._canvas}get canvas2D(){return this._canvas2D}get gfxAPI(){return this._gfxAPI}get queue(){return this._queue}get commandBuffer(){return this._cmdBuff}get devicePixelRatio(){return this._devicePixelRatio}get width(){return this._width}get height(){return this._height}get nativeWidth(){return this._nativeWidth}get nativeHeight(){return this._nativeHeight}get renderer(){return this._renderer}get vendor(){return this._vendor}get colorFormat(){return this._colorFmt}get depthStencilFormat(){return this._depthStencilFmt}get numDrawCalls(){return this._numDrawCalls}get numInstances(){return this._numInstances}get numTris(){return this._numTris}get memoryStatus(){return this._memoryStatus}get capabilities(){return this._caps}get surfaceTransform(){return this._transform}hasFeature(t){return this._features[t]}}class Ra extends ca{get renderPass(){return this._renderPass}get colorTextures(){return this._colorTextures}get depthStencilTexture(){return this._depthStencilTexture}constructor(t){super(Po.FRAMEBUFFER),this._device=void 0,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._device=t}}const Oa=String.prototype.charCodeAt;function Ma(t){return this[t]}function Na(t,e){let n=t.length,i=e^n,s=0;const o="string"==typeof t?Oa:Ma;for(;n>=4;){let e=255&o.call(t,s)|(255&o.call(t,++s))<<8|(255&o.call(t,++s))<<16|(255&o.call(t,++s))<<24;e=1540483477*(65535&e)+((1540483477*(e>>>16)&65535)<<16),e^=e>>>24,e=1540483477*(65535&e)+((1540483477*(e>>>16)&65535)<<16),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)^e,n-=4,++s}switch(n){case 3:i^=(255&o.call(t,s+2))<<16;case 2:i^=(255&o.call(t,s+1))<<8;case 1:i^=255&o.call(t,s),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)}return i^=i>>>13,i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16),i^=i>>>15,i>>>0}class La extends ca{get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get attributes(){return this._attributes}get attributesHash(){return this._attributesHash}get vertexCount(){return this._vertexCount}set vertexCount(t){this._vertexCount=t}get firstVertex(){return this._firstVertex}set firstVertex(t){this._firstVertex=t}get indexCount(){return this._indexCount}set indexCount(t){this._indexCount=t}get firstIndex(){return this._firstIndex}set firstIndex(t){this._firstIndex=t}get vertexOffset(){return this._vertexOffset}set vertexOffset(t){this._vertexOffset=t}get instanceCount(){return this._instanceCount}set instanceCount(t){this._instanceCount=t}get firstInstance(){return this._firstInstance}set firstInstance(t){this._firstInstance=t}get indirectBuffer(){return this._indirectBuffer}constructor(t){super(Po.INPUT_ASSEMBLER),this._device=void 0,this._attributes=[],this._vertexBuffers=[],this._indexBuffer=null,this._vertexCount=0,this._firstVertex=0,this._indexCount=0,this._firstIndex=0,this._vertexOffset=0,this._instanceCount=0,this._firstInstance=0,this._attributesHash=0,this._indirectBuffer=null,this._device=t}getVertexBuffer(t=0){return t<this._vertexBuffers.length?this._vertexBuffers[t]:null}computeAttributesHash(){let t="attrs";for(let e=0;e<this.attributes.length;++e){const n=this.attributes[e];t+=`,${n.name},${n.format},${n.isNormalized},${n.stream},${n.isInstanced}`}return Na(t,666)}}class Ba extends ca{get bindings(){return this._bindings}get bindingIndices(){return this._bindingIndices}get descriptorIndices(){return this._descriptorIndices}constructor(t){super(Po.DESCRIPTOR_SET_LAYOUT),this._device=void 0,this._bindings=[],this._bindingIndices=[],this._descriptorIndices=[],this._device=t}}class Fa extends ca{get setLayouts(){return this._setLayouts}constructor(t){super(Po.PIPELINE_LAYOUT),this._device=void 0,this._setLayouts=[],this._device=t}}class za extends ca{get type(){return this._type}constructor(t){super(Po.QUEUE),this._device=void 0,this._type=lr.GRAPHICS,this._isAsync=!1,this._device=t}isAsync(){return this._isAsync}}class Ua extends ca{get colorAttachments(){return this._colorInfos}get depthStencilAttachment(){return this._depthStencilInfo}get subPasses(){return this._subpasses}get hash(){return this._hash}constructor(t){super(Po.RENDER_PASS),this._device=void 0,this._colorInfos=[],this._depthStencilInfo=null,this._subpasses=[],this._hash=0,this._device=t}computeHash(){let t="";if(this._subpasses.length)for(let e=0;e<this._subpasses.length;++e){const n=this._subpasses[e];if(n.inputs.length){t+="ia";for(let e=0;e<n.inputs.length;++e){const i=this._colorInfos[n.inputs[e]];t+=`,${i.format},${i.sampleCount}`}}if(n.colors.length){t+="ca";for(let e=0;e<n.inputs.length;++e){const i=this._colorInfos[n.inputs[e]];t+=`,${i.format},${i.sampleCount}`}}if(n.depthStencil>=0){const e=this._colorInfos[n.depthStencil];t+=`ds,${e.format},${e.sampleCount}`}}else{t+="ca";for(let e=0;e<this._colorInfos.length;++e){const n=this._colorInfos[e];t+=`,${n.format},${n.sampleCount}`}const e=this._depthStencilInfo;e&&(t+=`ds,${e.format},${e.sampleCount}`)}return Na(t,666)}}class Ha extends ca{get minFilter(){return this._minFilter}get magFilter(){return this._magFilter}get mipFilter(){return this._mipFilter}get addressU(){return this._addressU}get addressV(){return this._addressV}get addressW(){return this._addressW}get maxAnisotropy(){return this._maxAnisotropy}get cmpFunc(){return this._cmpFunc}get borderColor(){return this._borderColor}get mipLODBias(){return this._mipLODBias}constructor(t){super(Po.SAMPLER),this._device=void 0,this._minFilter=jo.LINEAR,this._magFilter=jo.LINEAR,this._mipFilter=jo.NONE,this._addressU=Wo.WRAP,this._addressV=Wo.WRAP,this._addressW=Wo.WRAP,this._maxAnisotropy=16,this._cmpFunc=ko.NEVER,this._borderColor=new Ar,this._mipLODBias=0,this._device=t}}class Ga extends ca{get id(){return this._id}get name(){return this._name}get attributes(){return this._attributes}get blocks(){return this._blocks}get samplers(){return this._samplers}constructor(t){super(Po.SHADER),this._device=void 0,this._id=void 0,this._name="",this._stages=[],this._attributes=[],this._blocks=[],this._samplers=[],this._device=t,this._id=Ga._shaderIdGen++}}Ga._shaderIdGen=0;class Va extends ca{get type(){return this._type}get usage(){return this._usage}get format(){return this._format}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get layerCount(){return this._layerCount}get levelCount(){return this._levelCount}get samples(){return this._samples}get flags(){return this._flags}get size(){return this._size}constructor(t){super(Po.TEXTURE),this._device=void 0,this._type=Uo.TEX2D,this._usage=Ho.NONE,this._format=Oo.UNKNOWN,this._width=0,this._height=0,this._depth=1,this._layerCount=1,this._levelCount=1,this._samples=Vo.X1,this._flags=Go.NONE,this._isPowerOf2=!1,this._size=0,this._device=t}}class ja extends ca{constructor(t){super(Po.GLOBAL_BARRIER),this._device=void 0,this._info=new $r,this._device=t}initialize(t){return this._info.copy(t),!0}}class Wa extends ca{constructor(t){super(Po.TEXTURE_BARRIER),this._device=void 0,this._info=new Zr,this._device=t}initialize(t){return this._info.copy(t),!0}}const ka=Object.assign({},xa);ka.Device=gfx.Device,ka.Buffer=gfx.Buffer,ka.Texture=gfx.Texture,ka.Sampler=gfx.Sampler,ka.Shader=gfx.Shader,ka.InputAssembler=gfx.InputAssembler,ka.RenderPass=gfx.RenderPass,ka.Framebuffer=gfx.Framebuffer,ka.DescriptorSet=gfx.DescriptorSet,ka.DescriptorSetLayout=gfx.DescriptorSetLayout,ka.PipelineLayout=gfx.PipelineLayout,ka.PipelineState=gfx.PipelineState,ka.CommandBuffer=gfx.CommandBuffer,ka.Queue=gfx.Queue,i.gfx=ka;const qa=gfx.Attribute,Xa=Ea,Ya=Aa,Ka=Sa,$a=Ta,Za=Ca,Ja=ba;let Qa;ka.BlendTarget=Ea,ka.BlendState=Aa,ka.RasterizerState=Sa,ka.DepthStencilState=Ta,ka.PipelineStateInfo=ba,t("gfx",Object.freeze({__proto__:null,DescriptorSet:Pa,Buffer:wa,CommandBuffer:Da,get ObjectType(){return Po},get Status(){return wo},get API(){return Do},get SurfaceTransform(){return Io},get Feature(){return Ro},get Format(){return Oo},get FormatType(){return Mo},get Type(){return No},get BufferUsageBit(){return Lo},get BufferFlagBit(){return Bo},get MemoryAccessBit(){return Fo},get MemoryUsageBit(){return zo},get TextureType(){return Uo},get TextureUsageBit(){return Ho},get TextureFlagBit(){return Go},get SampleCount(){return Vo},get Filter(){return jo},get Address(){return Wo},get ComparisonFunc(){return ko},get StencilOp(){return qo},get BlendFactor(){return Xo},get BlendOp(){return Yo},get ColorMask(){return Ko},get ShaderStageFlagBit(){return $o},get LoadOp(){return Zo},get StoreOp(){return Jo},get AccessType(){return Qo},get PipelineBindPoint(){return tr},get PrimitiveMode(){return er},get PolygonMode(){return ir},get ShadeModel(){return sr},get CullMode(){return or},get DynamicStateFlagBit(){return rr},get StencilFace(){return ar},get DescriptorType(){return cr},get QueueType(){return lr},get CommandBufferType(){return hr},get ClearFlagBit(){return _r},Size:dr,DeviceCaps:pr,Offset:fr,Rect:mr,Extent:gr,TextureSubresLayers:vr,TextureSubresRange:yr,TextureCopy:xr,TextureBlit:Sr,BufferTextureCopy:Tr,Viewport:Er,Color:Ar,BindingMappingInfo:Cr,BufferInfo:br,BufferViewInfo:Pr,DrawInfo:wr,DispatchInfo:Dr,IndirectBuffer:Ir,TextureInfo:Rr,TextureViewInfo:Or,SamplerInfo:Mr,Uniform:Nr,UniformBlock:Lr,UniformSamplerTexture:Br,UniformSampler:Fr,UniformTexture:zr,UniformStorageImage:Ur,UniformStorageBuffer:Hr,UniformInputAttachment:Gr,ShaderStage:Vr,Attribute:qa,ShaderInfo:Wr,InputAssemblerInfo:kr,ColorAttachment:qr,DepthStencilAttachment:Xr,SubpassInfo:Yr,RenderPassInfo:Kr,GlobalBarrierInfo:$r,TextureBarrierInfo:Zr,FramebufferInfo:Jr,DescriptorSetLayoutBinding:Qr,DescriptorSetLayoutInfo:ta,DescriptorSetInfo:ea,PipelineLayoutInfo:na,InputState:ia,CommandBufferInfo:sa,QueueInfo:oa,FormatInfo:ra,MemoryStatus:aa,Obj:ca,DeviceInfo:la,get AttributeName(){return ur},FormatInfos:ha,DESCRIPTOR_BUFFER_TYPE:_a,DESCRIPTOR_SAMPLER_TYPE:ua,DESCRIPTOR_DYNAMIC_TYPE:da,DRAW_INFO_SIZE:28,IsPowerOf2:pa,FormatSize:fa,FormatSurfaceSize:ma,GetTypeSize:va,getTypedArrayConstructor:ya,Device:Ia,Framebuffer:Ra,InputAssembler:La,DescriptorSetLayout:Ba,PipelineLayout:Fa,Queue:za,RenderPass:Ua,Sampler:Ha,Shader:Ga,Texture:Va,GlobalBarrier:ja,TextureBarrier:Wa,BlendTarget:Xa,BlendState:Ya,RasterizerState:Ka,DepthStencilState:$a,PipelineState:Za,PipelineStateInfo:Ja})),function(t){t[t.ALL=0]="ALL",t[t.CLOSEST=1]="CLOSEST",t[t.ANY=2]="ANY"}(Qa||(Qa={}));const tc=function(){const t=new $e(0,0,0);return function(e,n){const i=$e.dot(e.d,n.n);if(Math.abs(i)<Number.EPSILON)return 0;$e.multiplyScalar(t,n.n,n.d);const s=$e.dot($e.subtract(t,t,e.o),n.n)/i;return s<0?0:s}}(),ec=function(){const t=new $e(0,0,0),e=new $e(0,0,0),n=new $e(0,0,0),i=new $e(0,0,0),s=new $e(0,0,0);return function(o,r,a){$e.subtract(t,r.b,r.a),$e.subtract(e,r.c,r.a),$e.cross(n,o.d,e);const c=$e.dot(t,n);if(c<Number.EPSILON&&(!a||c>-Number.EPSILON))return 0;const l=1/c;$e.subtract(i,o.o,r.a);const h=$e.dot(i,n)*l;if(h<0||h>1)return 0;$e.cross(s,i,t);const _=$e.dot(o.d,s)*l;if(_<0||h+_>1)return 0;const u=$e.dot(e,s)*l;return u<0?0:u}}(),nc=function(){const t=new $e(0,0,0);return function(e,n){const i=n.radius,s=n.center,o=e.o,r=e.d,a=i*i;$e.subtract(t,s,o);const c=t.lengthSqr(),l=$e.dot(t,r),h=a-(c-l*l);if(h<0)return 0;const _=Math.sqrt(h),u=c<a?l+_:l-_;return u<0?0:u}}(),ic=function(){const t=new $e,e=new $e;return function(n,i){return $e.subtract(t,i.center,i.halfExtents),$e.add(e,i.center,i.halfExtents),sc(n,t,e)}}();function sc(t,e,n){const i=t.o,s=t.d,o=1/s.x,r=1/s.y,a=1/s.z,c=(e.x-i.x)*o,l=(n.x-i.x)*o,h=(e.y-i.y)*r,_=(n.y-i.y)*r,u=(e.z-i.z)*a,d=(n.z-i.z)*a,p=Math.max(Math.max(Math.min(c,l),Math.min(h,_)),Math.min(u,d)),f=Math.min(Math.min(Math.max(c,l),Math.max(h,_)),Math.max(u,d));return f<0||p>f?0:p>0?p:f}const oc=function(){let t=new $e,e=new $e,n=new $e;const i=new $e,s=new $e,o=new $e,r=new $e,a=new Array(3),c=new Array(3),l=new Array(3),h=new Array(6);return function(_,u){a[0]=u.halfExtents.x,a[1]=u.halfExtents.y,a[2]=u.halfExtents.z,t=u.center,e=_.o,n=_.d,$e.set(i,u.orientation.m00,u.orientation.m01,u.orientation.m02),$e.set(s,u.orientation.m03,u.orientation.m04,u.orientation.m05),$e.set(o,u.orientation.m06,u.orientation.m07,u.orientation.m08),$e.subtract(r,t,e),c[0]=$e.dot(i,n),c[1]=$e.dot(s,n),c[2]=$e.dot(o,n),l[0]=$e.dot(i,r),l[1]=$e.dot(s,r),l[2]=$e.dot(o,r);for(let t=0;t<3;++t){if(0===c[t]){if(-l[t]-a[t]>0||-l[t]+a[t]<0)return 0;c[t]=1e-7}h[2*t+0]=(l[t]+a[t])/c[t],h[2*t+1]=(l[t]-a[t])/c[t]}const d=Math.max(Math.max(Math.min(h[0],h[1]),Math.min(h[2],h[3])),Math.min(h[4],h[5])),p=Math.min(Math.min(Math.max(h[0],h[1]),Math.max(h[2],h[3])),Math.max(h[4],h[5]));return p<0||d>p?0:d>0?d:p}}(),rc=function(){const t=new $e,e=new $e,n=new $e,i=new $e,s=new $e,o=new $e,r=new $e,a=new Ao;return function(c,l){const h=l.radius*l.radius,_=$e.normalize(t,c.d),u=l.ellipseCenter0,d=l.ellipseCenter1,p=$e.subtract(e,d,u);if(p.equals($e.ZERO))return a.radius=l.radius,a.center.set(l.ellipseCenter0),Fc.raySphere(c,a);const f=c.o,m=$e.subtract(n,f,u),g=$e.cross(i,_,p),v=g.lengthSqr();if(0===v){a.radius=l.radius;const t=$e.subtract(s,d,f);return m.lengthSqr()<t.lengthSqr()?a.center.set(l.ellipseCenter0):a.center.set(l.ellipseCenter1),Fc.raySphere(c,a)}const y=$e.cross(s,m,p),x=p.lengthSqr(),S=2*$e.dot(g,y),T=S*S-4*v*(y.lengthSqr()-h*x);if(T<0)return 0;const E=(-S-Math.sqrt(T))/(2*v);if(E<0){a.radius=l.radius;const t=$e.subtract(o,d,f);return m.lengthSqr()<t.lengthSqr()?a.center.set(l.ellipseCenter0):a.center.set(l.ellipseCenter1),Fc.raySphere(c,a)}{const t=$e.scaleAndAdd(o,c.o,_,E),e=$e.subtract(r,t,u),n=$e.dot(e,p)/x;return n>=0&&n<=1?E:n<0?(a.radius=l.radius,a.center.set(l.ellipseCenter0),Fc.raySphere(c,a)):n>1?(a.radius=l.radius,a.center.set(l.ellipseCenter1),Fc.raySphere(c,a)):0}}}(),ac=function(){const t=Co.create(),e={distance:1/0,doubleSided:!1,mode:Qa.ANY};let n=0;const i=(t,e,i,s,o,r)=>{t===Qa.CLOSEST?(n>e||0===n)&&(n=e,r&&(0===r.length?r.push({distance:e,vertexIndex0:i/3,vertexIndex1:s/3,vertexIndex2:o/3}):(r[0].distance=e,r[0].vertexIndex0=i/3,r[0].vertexIndex1=s/3,r[0].vertexIndex2=o/3))):(n=e,r&&r.push({distance:e,vertexIndex0:i/3,vertexIndex1:s/3,vertexIndex2:o/3}))};return function(s,o,r){if(n=0,0===o.geometricInfo.positions.length)return n;const a=void 0===r?e:r;if(sc(s,o.geometricInfo.boundingBox.min,o.geometricInfo.boundingBox.max)){const e=o.primitiveMode,{positions:n,indices:r}=o.geometricInfo;((e,n,s,o,r)=>{if(s===er.TRIANGLE_LIST){const s=n.length;for(let a=0;a<s;a+=3){const s=3*n[a],c=3*n[a+1],l=3*n[a+2];$e.set(t.a,e[s],e[s+1],e[s+2]),$e.set(t.b,e[c],e[c+1],e[c+2]),$e.set(t.c,e[l],e[l+1],e[l+2]);const h=Fc.rayTriangle(o,t,r.doubleSided);if(!(0===h||h>r.distance)&&(i(r.mode,h,s,c,l,r.result),r.mode===Qa.ANY))return h}}else if(s===er.TRIANGLE_STRIP){const s=n.length-2;let a=0;for(let c=0;c<s;c+=1){const s=3*n[c-a],l=3*n[c+a+1],h=3*n[c+2];$e.set(t.a,e[s],e[s+1],e[s+2]),$e.set(t.b,e[l],e[l+1],e[l+2]),$e.set(t.c,e[h],e[h+1],e[h+2]),a=~a;const _=Fc.rayTriangle(o,t,r.doubleSided);if(!(0===_||_>r.distance)&&(i(r.mode,_,s,l,h,r.result),r.mode===Qa.ANY))return _}}else if(s===er.TRIANGLE_FAN){const s=n.length-1,a=3*n[0];$e.set(t.a,e[a],e[a+1],e[a+2]);for(let c=1;c<s;c+=1){const s=3*n[c],l=3*n[c+1];$e.set(t.b,e[s],e[s+1],e[s+2]),$e.set(t.c,e[l],e[l+1],e[l+2]);const h=Fc.rayTriangle(o,t,r.doubleSided);if(!(0===h||h>r.distance)&&(i(r.mode,h,a,s,l,r.result),r.mode===Qa.ANY))return h}}})(n,r,e,s,a)}return n}}(),cc=function(){let t=0;const e={distance:1/0,doubleSided:!1,mode:Qa.ANY};return function(n,i,s){t=0;const o=void 0===s?e:s,r=i.renderingSubMeshes.length,a=i.struct.minPosition,c=i.struct.maxPosition;if(a&&c&&!sc(n,a,c))return t;for(let e=0;e<r;e++){const s=i.renderingSubMeshes[e],r=ac(n,s,o);if(r)if(o.mode===Qa.CLOSEST)(0===t||t>r)&&(t=r,o.subIndices&&(o.subIndices[0]=e));else if(t=r,o.subIndices&&o.subIndices.push(e),o.mode===Qa.ANY)return r}return t&&o.mode===Qa.CLOSEST&&(o.result&&(o.result[0].distance=t,o.result.length=1),o.subIndices&&(o.subIndices.length=1)),t}}(),lc=function(){let t=0;const e={distance:1/0,doubleSided:!1,mode:Qa.ANY},n=new vo,i=new pn;return function(s,o,r){t=0;const a=void 0===r?e:r,c=o.worldBounds;if(c&&!ic(s,c))return t;vo.copy(n,s),o.node&&(pn.invert(i,o.node.getWorldMatrix(i)),$e.transformMat4(n.o,s.o,i),$e.transformMat4Normal(n.d,s.d,i));const l=o.subModels;for(let e=0;e<l.length;e++){const i=l[e].subMesh,s=ac(n,i,a);if(s)if(a.mode===Qa.CLOSEST)(0===t||t>s)&&(t=s,a.subIndices&&(a.subIndices[0]=e));else if(t=s,a.subIndices&&a.subIndices.push(e),a.mode===Qa.ANY)return s}return t&&a.mode===Qa.CLOSEST&&(a.result&&(a.result[0].distance=t,a.result.length=1),a.subIndices&&(a.subIndices.length=1)),t}}(),hc=function(){const t=new $e(0,0,0);return function(e,n){$e.subtract(t,e.e,e.s);const i=(n.d-$e.dot(e.s,n.n))/$e.dot(t,n.n);return i<0||i>1?0:i}}(),_c=function(){const t=new $e(0,0,0),e=new $e(0,0,0),n=new $e(0,0,0),i=new $e(0,0,0),s=new $e(0,0,0),o=new $e(0,0,0);return function(r,a,c){$e.subtract(t,a.b,a.a),$e.subtract(e,a.c,a.a),$e.subtract(n,r.s,r.e),$e.cross(s,t,e);const l=$e.dot(n,s);if(l<=0)return 0;$e.subtract(i,r.s,a.a);const h=$e.dot(i,s);if(h<0||h>l)return 0;$e.cross(o,n,i);let _=$e.dot(e,o);if(_<0||_>l)return 0;let u=-$e.dot(t,o);if(u<0||_+u>l)return 0;if(c){const t=1/l;_*=t,u*=t;const e=1-_-u;$e.set(c,a.a.x*e+a.b.x*_+a.c.x*u,a.a.y*e+a.b.y*_+a.c.y*u,a.a.z*e+a.b.z*_+a.c.z*u)}return 1}}(),uc=new vo;function dc(t,e){uc.o.set(t.s),$e.subtract(uc.d,t.e,t.s),uc.d.normalize();const n=ic(uc,e);return n<=t.length()?n:0}function pc(t,e){uc.o.set(t.s),$e.subtract(uc.d,t.e,t.s),uc.d.normalize();const n=oc(uc,e);return n<=t.length()?n:0}function fc(t,e){uc.o.set(t.s),$e.subtract(uc.d,t.e,t.s),uc.d.normalize();const n=nc(uc,e);return n<=t.length()?n:0}const mc=function(){const t=new $e,e=new $e,n=new $e,i=new $e;return function(s,o){return $e.subtract(t,s.center,s.halfExtents),$e.add(e,s.center,s.halfExtents),$e.subtract(n,o.center,o.halfExtents),$e.add(i,o.center,o.halfExtents),t.x<=i.x&&e.x>=n.x&&t.y<=i.y&&e.y>=n.y&&t.z<=i.z&&e.z>=n.z}}();function gc(t,e,n,i,s,o){$e.set(o[0],t.x+n.x*e.x+i.x*e.y+s.x*e.z,t.y+n.y*e.x+i.y*e.y+s.y*e.z,t.z+n.z*e.x+i.z*e.y+s.z*e.z),$e.set(o[1],t.x-n.x*e.x+i.x*e.y+s.x*e.z,t.y-n.y*e.x+i.y*e.y+s.y*e.z,t.z-n.z*e.x+i.z*e.y+s.z*e.z),$e.set(o[2],t.x+n.x*e.x-i.x*e.y+s.x*e.z,t.y+n.y*e.x-i.y*e.y+s.y*e.z,t.z+n.z*e.x-i.z*e.y+s.z*e.z),$e.set(o[3],t.x+n.x*e.x+i.x*e.y-s.x*e.z,t.y+n.y*e.x+i.y*e.y-s.y*e.z,t.z+n.z*e.x+i.z*e.y-s.z*e.z),$e.set(o[4],t.x-n.x*e.x-i.x*e.y-s.x*e.z,t.y-n.y*e.x-i.y*e.y-s.y*e.z,t.z-n.z*e.x-i.z*e.y-s.z*e.z),$e.set(o[5],t.x+n.x*e.x-i.x*e.y-s.x*e.z,t.y+n.y*e.x-i.y*e.y-s.y*e.z,t.z+n.z*e.x-i.z*e.y-s.z*e.z),$e.set(o[6],t.x-n.x*e.x+i.x*e.y-s.x*e.z,t.y-n.y*e.x+i.y*e.y-s.y*e.z,t.z-n.z*e.x+i.z*e.y-s.z*e.z),$e.set(o[7],t.x-n.x*e.x-i.x*e.y+s.x*e.z,t.y-n.y*e.x-i.y*e.y+s.y*e.z,t.z-n.z*e.x-i.z*e.y+s.z*e.z)}function vc(t,e){let n=$e.dot(e,t[0]),i=n;for(let s=1;s<8;++s){const o=$e.dot(e,t[s]);n=o<n?o:n,i=o>i?o:i}return[n,i]}const yc=function(){const t=new Array(15);for(let e=0;e<15;e++)t[e]=new $e(0,0,0);const e=new Array(8),n=new Array(8);for(let t=0;t<8;t++)e[t]=new $e(0,0,0),n[t]=new $e(0,0,0);const i=new $e,s=new $e;return function(o,r){$e.set(t[0],1,0,0),$e.set(t[1],0,1,0),$e.set(t[2],0,0,1),$e.set(t[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),$e.set(t[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),$e.set(t[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(let e=0;e<3;++e)$e.cross(t[6+3*e],t[e],t[0]),$e.cross(t[7+3*e],t[e],t[1]),$e.cross(t[7+3*e],t[e],t[2]);$e.subtract(i,o.center,o.halfExtents),$e.add(s,o.center,o.halfExtents),function(t,e,n){$e.set(n[0],t.x,e.y,e.z),$e.set(n[1],t.x,e.y,t.z),$e.set(n[2],t.x,t.y,e.z),$e.set(n[3],t.x,t.y,t.z),$e.set(n[4],e.x,e.y,e.z),$e.set(n[5],e.x,e.y,t.z),$e.set(n[6],e.x,t.y,e.z),$e.set(n[7],e.x,t.y,t.z)}(i,s,e),gc(r.center,r.halfExtents,t[3],t[4],t[5],n);for(let i=0;i<15;++i){const s=vc(e,t[i]),o=vc(n,t[i]);if(o[0]>s[1]||s[0]>o[1])return 0}return 1}}(),xc=function(t,e){const n=t.halfExtents.x*Math.abs(e.n.x)+t.halfExtents.y*Math.abs(e.n.y)+t.halfExtents.z*Math.abs(e.n.z),i=$e.dot(e.n,t.center);return i+n<e.d?-1:i-n>e.d?0:1},Sc=function(t,e){for(let n=0;n<e.planes.length;n++)if(-1===xc(t,e.planes[n]))return 0;return 1},Tc=function(){const t=new Array(8);let e=0,n=0;for(let e=0;e<t.length;e++)t[e]=new $e(0,0,0);return function(i,s){let o=0,r=!1;for(let t=0;t<s.planes.length;t++){if(o=xc(i,s.planes[t]),-1===o)return 0;1===o&&(r=!0)}if(!r)return 1;for(let e=0;e<s.vertices.length;e++)$e.subtract(t[e],s.vertices[e],i.center);e=0,n=0;for(let o=0;o<s.vertices.length;o++)t[o].x>i.halfExtents.x?e++:t[o].x<-i.halfExtents.x&&n++;if(e===s.vertices.length||n===s.vertices.length)return 0;e=0,n=0;for(let o=0;o<s.vertices.length;o++)t[o].y>i.halfExtents.y?e++:t[o].y<-i.halfExtents.y&&n++;if(e===s.vertices.length||n===s.vertices.length)return 0;e=0,n=0;for(let o=0;o<s.vertices.length;o++)t[o].z>i.halfExtents.z?e++:t[o].z<-i.halfExtents.z&&n++;return e===s.vertices.length||n===s.vertices.length?0:1}}(),Ec=function(){const t=new $e(0,0,0),e=new nn;return function(n,i){return $e.subtract(t,i,n.center),$e.transformMat3(t,t,nn.transpose(e,n.orientation)),s=t,o=n.halfExtents,Math.abs(s.x)<o.x&&Math.abs(s.y)<o.y&&Math.abs(s.z)<o.z;var s,o}}(),Ac=function(){const t=function(t,e,n,i){return Math.abs(t.x*e+t.y*n+t.z*i)};return function(e,n){const i=e.halfExtents.x*t(n.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*t(n.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*t(n.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),s=$e.dot(n.n,e.center);return s+i<n.d?-1:s-i>n.d?0:1}}(),Cc=function(t,e){for(let n=0;n<e.planes.length;n++)if(-1===Ac(t,e.planes[n]))return 0;return 1},bc=function(){const t=new Array(8);let e=0,n=0,i=0;for(let e=0;e<t.length;e++)t[e]=new $e(0,0,0);const s=function(t,e,n,i){return t.x*e+t.y*n+t.z*i};return function(o,r){let a=0,c=!1;for(let t=0;t<r.planes.length;t++){if(a=Ac(o,r.planes[t]),-1===a)return 0;1===a&&(c=!0)}if(!c)return 1;for(let e=0;e<r.vertices.length;e++)$e.subtract(t[e],r.vertices[e],o.center);n=0,i=0;for(let a=0;a<r.vertices.length;a++)e=s(t[a],o.orientation.m00,o.orientation.m01,o.orientation.m02),e>o.halfExtents.x?n++:e<-o.halfExtents.x&&i++;if(n===r.vertices.length||i===r.vertices.length)return 0;n=0,i=0;for(let a=0;a<r.vertices.length;a++)e=s(t[a],o.orientation.m03,o.orientation.m04,o.orientation.m05),e>o.halfExtents.y?n++:e<-o.halfExtents.y&&i++;if(n===r.vertices.length||i===r.vertices.length)return 0;n=0,i=0;for(let a=0;a<r.vertices.length;a++)e=s(t[a],o.orientation.m06,o.orientation.m07,o.orientation.m08),e>o.halfExtents.z?n++:e<-o.halfExtents.z&&i++;return n===r.vertices.length||i===r.vertices.length?0:1}}(),Pc=function(){const t=new Array(15);for(let e=0;e<15;e++)t[e]=new $e(0,0,0);const e=new Array(8),n=new Array(8);for(let t=0;t<8;t++)e[t]=new $e(0,0,0),n[t]=new $e(0,0,0);return function(i,s){$e.set(t[0],i.orientation.m00,i.orientation.m01,i.orientation.m02),$e.set(t[1],i.orientation.m03,i.orientation.m04,i.orientation.m05),$e.set(t[2],i.orientation.m06,i.orientation.m07,i.orientation.m08),$e.set(t[3],s.orientation.m00,s.orientation.m01,s.orientation.m02),$e.set(t[4],s.orientation.m03,s.orientation.m04,s.orientation.m05),$e.set(t[5],s.orientation.m06,s.orientation.m07,s.orientation.m08);for(let e=0;e<3;++e)$e.cross(t[6+3*e],t[e],t[0]),$e.cross(t[7+3*e],t[e],t[1]),$e.cross(t[7+3*e],t[e],t[2]);gc(i.center,i.halfExtents,t[0],t[1],t[2],e),gc(s.center,s.halfExtents,t[3],t[4],t[5],n);for(let i=0;i<15;++i){const s=vc(e,t[i]),o=vc(n,t[i]);if(o[0]>s[1]||s[0]>o[1])return 0}return 1}}(),wc=function(){const t=new Ao,e=new $e,n=new $e,i=new $e,s=new Array(8);for(let t=0;t<8;t++)s[t]=new $e;const o=new Array(8);for(let t=0;t<8;t++)o[t]=new $e;return function(r,a){if(0===$e.squaredDistance(a.ellipseCenter0,a.ellipseCenter1))return t.radius=a.radius,t.center.set(a.ellipseCenter0),Fc.sphereOBB(t,r);{e.x=r.orientation.m00,e.y=r.orientation.m01,e.z=r.orientation.m02,n.x=r.orientation.m03,n.y=r.orientation.m04,n.z=r.orientation.m05,i.x=r.orientation.m06,i.y=r.orientation.m07,i.z=r.orientation.m08,gc(r.center,r.halfExtents,e,n,i,s);const t=o,c=$e.copy(t[0],e),l=$e.copy(t[1],n),h=$e.copy(t[2],i);$e.subtract(t[3],a.center,r.center).normalize();const _=$e.subtract(t[4],a.ellipseCenter0,a.ellipseCenter1);_.normalize(),$e.cross(t[5],c,_),$e.cross(t[6],l,_),$e.cross(t[7],h,_);for(let e=0;e<8;++e){const n=vc(s,t[e]),i=$e.dot(t[e],a.ellipseCenter0),o=$e.dot(t[e],a.ellipseCenter1),r=Math.max(i,o),c=Math.min(i,o)-a.radius,l=r+a.radius;if(c>n[1]||n[0]>l)return 0}return 1}}}(),Dc=function(t,e){const n=$e.dot(e.n,t.center),i=t.radius*e.n.length();return n+i<e.d?-1:n-i>e.d?0:1},Ic=function(t,e){for(let n=0;n<e.planes.length;n++)if(-1===Dc(t,e.planes[n]))return 0;return 1},Rc=function(){const t=new $e(0,0,0),e=[1,-1,1,-1,1,-1];return function(n,i){for(let s=0;s<6;s++){const o=i.planes[s],r=n.radius,a=n.center,c=o.n,l=o.d,h=$e.dot(c,a);if(h+r<l)return 0;if(!(h-r>l)){$e.add(t,a,$e.multiplyScalar(t,c,r));for(let n=0;n<6;n++){if(n===s||n===s+e[s])continue;const o=i.planes[n];if($e.dot(o.n,t)<o.d)return 0}}}return 1}}(),Oc=function(t,e){const n=t.radius+e.radius;return $e.squaredDistance(t.center,e.center)<n*n},Mc=function(){const t=new $e;return function(e,n){return po(t,e.center,n),$e.squaredDistance(e.center,t)<e.radius*e.radius}}(),Nc=function(){const t=new $e;return function(e,n){return fo(t,e.center,n),$e.squaredDistance(e.center,t)<e.radius*e.radius}}(),Lc=function(){const t=new $e,e=new $e;return function(n,i){const s=n.radius+i.radius,o=s*s,r=$e.squaredDistance(i.ellipseCenter0,i.ellipseCenter1);if(0===r)return $e.squaredDistance(n.center,i.center)<o;{$e.subtract(t,n.center,i.ellipseCenter0),$e.subtract(e,i.ellipseCenter1,i.ellipseCenter0);const s=$e.dot(t,e)/r;return s<0?$e.squaredDistance(n.center,i.ellipseCenter0)<o:s>1?$e.squaredDistance(n.center,i.ellipseCenter1)<o:($e.scaleAndAdd(t,i.ellipseCenter0,e,s),$e.squaredDistance(n.center,t)<o)}}}(),Bc=function(){const t=new $e,e=new $e,n=new $e,i=new $e,s=new $e,o=new $e;return function(r,a){const c=$e.subtract(t,r.ellipseCenter1,r.ellipseCenter0),l=$e.subtract(e,a.ellipseCenter1,a.ellipseCenter0),h=$e.subtract(n,r.ellipseCenter0,a.ellipseCenter0),_=$e.dot(c,c),u=$e.dot(c,l),d=$e.dot(l,l),p=$e.dot(c,h),f=$e.dot(l,h),m=_*d-u*u;let g,v,y,x,S=m,T=m;m<be?(v=0,S=1,x=f,T=d):(v=u*f-d*p,x=_*f-u*p,v<0?(v=0,x=f,T=d):v>S&&(v=S,x=f+u,T=d)),x<0?(x=0,-p<0?v=0:-p>_?v=S:(v=-p,S=_)):x>T&&(x=T,-p+u<0?v=0:-p+u>_?v=S:(v=-p+u,S=_)),g=Math.abs(v)<be?0:v/S,y=Math.abs(x)<be?0:x/T;const E=i;E.set(h),E.add($e.multiplyScalar(s,c,g)),E.subtract($e.multiplyScalar(o,l,y));const A=r.radius+a.radius;return E.lengthSqr()<A*A}}(),Fc={raySphere:nc,rayAABB:ic,rayOBB:oc,rayPlane:tc,rayTriangle:ec,rayCapsule:rc,raySubMesh:ac,rayMesh:cc,rayModel:lc,lineSphere:fc,lineAABB:dc,lineOBB:pc,linePlane:hc,lineTriangle:_c,sphereWithSphere:Oc,sphereAABB:Mc,sphereOBB:Nc,spherePlane:Dc,sphereFrustum:Ic,sphereFrustumAccurate:Rc,sphereCapsule:Lc,aabbWithAABB:mc,aabbWithOBB:yc,aabbPlane:xc,aabbFrustum:Sc,aabbFrustumAccurate:Tc,obbWithOBB:Pc,obbPlane:Ac,obbFrustum:Cc,obbFrustumAccurate:bc,obbPoint:Ec,obbCapsule:wc,capsuleWithCapsule:Bc,resolve(t,e,n=null){const i=t._type,s=e._type,o=this[i|s];return i<s?o(t,e,n):o(e,t,n)}};Fc[go.SHAPE_RAY|go.SHAPE_SPHERE]=nc,Fc[go.SHAPE_RAY|go.SHAPE_AABB]=ic,Fc[go.SHAPE_RAY|go.SHAPE_OBB]=oc,Fc[go.SHAPE_RAY|go.SHAPE_PLANE]=tc,Fc[go.SHAPE_RAY|go.SHAPE_TRIANGLE]=ec,Fc[go.SHAPE_RAY|go.SHAPE_CAPSULE]=rc,Fc[go.SHAPE_LINE|go.SHAPE_SPHERE]=fc,Fc[go.SHAPE_LINE|go.SHAPE_AABB]=dc,Fc[go.SHAPE_LINE|go.SHAPE_OBB]=pc,Fc[go.SHAPE_LINE|go.SHAPE_PLANE]=hc,Fc[go.SHAPE_LINE|go.SHAPE_TRIANGLE]=_c,Fc[go.SHAPE_SPHERE]=Oc,Fc[go.SHAPE_SPHERE|go.SHAPE_AABB]=Mc,Fc[go.SHAPE_SPHERE|go.SHAPE_OBB]=Nc,Fc[go.SHAPE_SPHERE|go.SHAPE_PLANE]=Dc,Fc[go.SHAPE_SPHERE|go.SHAPE_FRUSTUM]=Ic,Fc[go.SHAPE_SPHERE|go.SHAPE_FRUSTUM_ACCURATE]=Rc,Fc[go.SHAPE_SPHERE|go.SHAPE_CAPSULE]=Lc,Fc[go.SHAPE_AABB]=mc,Fc[go.SHAPE_AABB|go.SHAPE_OBB]=yc,Fc[go.SHAPE_AABB|go.SHAPE_PLANE]=xc,Fc[go.SHAPE_AABB|go.SHAPE_FRUSTUM]=Sc,Fc[go.SHAPE_AABB|go.SHAPE_FRUSTUM_ACCURATE]=Tc,Fc[go.SHAPE_OBB]=Pc,Fc[go.SHAPE_OBB|go.SHAPE_PLANE]=Ac,Fc[go.SHAPE_OBB|go.SHAPE_FRUSTUM]=Cc,Fc[go.SHAPE_OBB|go.SHAPE_FRUSTUM_ACCURATE]=bc,Fc[go.SHAPE_OBB|go.SHAPE_CAPSULE]=wc,Fc[go.SHAPE_CAPSULE]=Bc;class zc{static create(t,e,n,i,s,o){return new zc(t,e,n,i,s,o)}static clone(t){return new zc(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)}static copy(t,e){return $e.copy(t.s,e.s),$e.copy(t.e,e.e),t}static fromPoints(t,e,n){return $e.copy(t.s,e),$e.copy(t.e,n),t}static set(t,e,n,i,s,o,r){return t.s.x=e,t.s.y=n,t.s.z=i,t.e.x=s,t.e.y=o,t.e.z=r,t}static len(t){return $e.distance(t.s,t.e)}get type(){return this._type}constructor(t=0,e=0,n=0,i=0,s=0,o=-1){this.s=void 0,this.e=void 0,this._type=void 0,this._type=go.SHAPE_LINE,this.s=new $e(t,e,n),this.e=new $e(i,s,o)}length(){return $e.distance(this.s,this.e)}}const Uc=new $e(0,0,0),Hc=new $e(0,0,0),Gc=i.mat4(),Vc=i.v4();class jc{static create(t,e,n,i){return new jc(t,e,n,i)}static clone(t){return new jc(t.n.x,t.n.y,t.n.z,t.d)}static copy(t,e){return $e.copy(t.n,e.n),t.d=e.d,t}static fromPoints(t,e,n,i){return $e.subtract(Uc,n,e),$e.subtract(Hc,i,e),$e.normalize(t.n,$e.cross(t.n,Uc,Hc)),t.d=$e.dot(t.n,e),t}static set(t,e,n,i,s){return t.n.x=e,t.n.y=n,t.n.z=i,t.d=s,t}static fromNormalAndPoint(t,e,n){return $e.copy(t.n,e),t.d=$e.dot(e,n),t}static normalize(t,e){const n=e.n.length();return $e.normalize(t.n,e.n),n>0&&(t.d=e.d/n),t}get type(){return this._type}set x(t){this.n.x=t}get x(){return this.n.x}set y(t){this.n.y=t}get y(){return this.n.y}set z(t){this.n.z=t}get z(){return this.n.z}set w(t){this.d=t}get w(){return this.d}constructor(t=0,e=1,n=0,i=0){this.n=void 0,this.d=void 0,this._type=void 0,this._type=go.SHAPE_PLANE,this.n=new $e(t,e,n),this.d=i}transform(t){pn.invert(Gc,t),pn.transpose(Gc,Gc),tn.set(Vc,this.n.x,this.n.y,this.n.z,this.d),tn.transformMat4(Vc,Vc,Gc),$e.set(this.n,Vc.x,Vc.y,Vc.z),this.d=Vc.w}}const Wc=new $e,kc=new $e,qc=new $e,Xc=new $e,Yc=new nn,Kc=(t,e,n)=>{Yc.m00=Math.abs(n.m00),Yc.m01=Math.abs(n.m01),Yc.m02=Math.abs(n.m02),Yc.m03=Math.abs(n.m04),Yc.m04=Math.abs(n.m05),Yc.m05=Math.abs(n.m06),Yc.m06=Math.abs(n.m08),Yc.m07=Math.abs(n.m09),Yc.m08=Math.abs(n.m10),$e.transformMat3(t,e,Yc)};class $c{static create(t,e,n,i,s,o){return new $c(t,e,n,i,s,o)}static clone(t){return new $c(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)}static copy(t,e){return $e.copy(t.center,e.center),$e.copy(t.halfExtents,e.halfExtents),t}static fromPoints(t,e,n){return $e.add(Wc,n,e),$e.subtract(kc,n,e),$e.multiplyScalar(t.center,Wc,.5),$e.multiplyScalar(t.halfExtents,kc,.5),t}static set(t,e,n,i,s,o,r){return $e.set(t.center,e,n,i),$e.set(t.halfExtents,s,o,r),t}static merge(t,e,n){return $e.subtract(Wc,e.center,e.halfExtents),$e.subtract(kc,n.center,n.halfExtents),$e.add(qc,e.center,e.halfExtents),$e.add(Xc,n.center,n.halfExtents),$e.max(Xc,qc,Xc),$e.min(qc,Wc,kc),$c.fromPoints(t,qc,Xc)}static toBoundingSphere(t,e){e.getBoundary(Wc,kc),t.center.set(Wc),t.radius=0,$e.subtract(qc,kc,t.center);const n=qc.length(),i=.5*n;return t.radius+=i,$e.multiplyScalar(qc,qc,i/n),$e.add(t.center,t.center,qc),t}static transform(t,e,n){return $e.transformMat4(t.center,e.center,n),Kc(t.halfExtents,e.halfExtents,n),t}get type(){return this._type}constructor(t=0,e=0,n=0,i=1,s=1,o=1){this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._type=go.SHAPE_AABB,this.center=new $e(t,e,n),this.halfExtents=new $e(i,s,o)}getBoundary(t,e){$e.subtract(t,this.center,this.halfExtents),$e.add(e,this.center,this.halfExtents)}transform(t,e,n,i,s){$e.transformMat4(s.center,this.center,t),Kc(s.halfExtents,this.halfExtents,t)}clone(){return $c.clone(this)}copy(t){return $c.copy(this,t)}}const Zc=new $e,Jc=new $e,Qc=new nn;class tl{static create(t,e,n,i,s,o,r,a,c,l,h,_,u,d,p){return new tl(t,e,n,i,s,o,r,a,c,l,h,_,u,d,p)}static clone(t){return new tl(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)}static copy(t,e){return $e.copy(t.center,e.center),$e.copy(t.halfExtents,e.halfExtents),nn.copy(t.orientation,e.orientation),t}static fromPoints(t,e,n){return $e.multiplyScalar(t.center,$e.add(Zc,e,n),.5),$e.multiplyScalar(t.halfExtents,$e.subtract(Jc,n,e),.5),nn.identity(t.orientation),t}static set(t,e,n,i,s,o,r,a,c,l,h,_,u,d,p,f){return $e.set(t.center,e,n,i),$e.set(t.halfExtents,s,o,r),nn.set(t.orientation,a,c,l,h,_,u,d,p,f),t}get type(){return this._type}constructor(t=0,e=0,n=0,i=1,s=1,o=1,r=1,a=0,c=0,l=0,h=1,_=0,u=0,d=0,p=1){this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=go.SHAPE_OBB,this.center=new $e(t,e,n),this.halfExtents=new $e(i,s,o),this.orientation=new nn(r,a,c,l,h,_,u,d,p)}getBoundary(t,e){var n,i,s;n=Zc,i=this.halfExtents,s=this.orientation,Qc.m00=Math.abs(s.m00),Qc.m01=Math.abs(s.m01),Qc.m02=Math.abs(s.m02),Qc.m03=Math.abs(s.m03),Qc.m04=Math.abs(s.m04),Qc.m05=Math.abs(s.m05),Qc.m06=Math.abs(s.m06),Qc.m07=Math.abs(s.m07),Qc.m08=Math.abs(s.m08),$e.transformMat3(n,i,Qc),$e.subtract(t,this.center,Zc),$e.add(e,this.center,Zc)}transform(t,e,n,i,s){$e.transformMat4(s.center,this.center,t),nn.fromQuat(s.orientation,n),$e.multiply(s.halfExtents,this.halfExtents,i)}translateAndRotate(t,e,n){$e.transformMat4(n.center,this.center,t),nn.fromQuat(n.orientation,e)}setScale(t,e){$e.multiply(e.halfExtents,this.halfExtents,t)}}const el=new Array(8);el[0]=new $e(1,1,1),el[1]=new $e(-1,1,1),el[2]=new $e(-1,-1,1),el[3]=new $e(1,-1,1),el[4]=new $e(1,1,-1),el[5]=new $e(-1,1,-1),el[6]=new $e(-1,-1,-1),el[7]=new $e(1,-1,-1);class nl{set accurate(t){this._type=t?go.SHAPE_FRUSTUM_ACCURATE:go.SHAPE_FRUSTUM}static create(){return new nl}static clone(t){return nl.copy(new nl,t)}static copy(t,e){t._type=e._type;for(let n=0;n<6;++n)jc.copy(t.planes[n],e.planes[n]);for(let n=0;n<8;++n)$e.copy(t.vertices[n],e.vertices[n]);return t}get type(){return this._type}constructor(){this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=go.SHAPE_FRUSTUM,this.planes=new Array(6);for(let t=0;t<6;++t)this.planes[t]=jc.create(0,0,0,0);this.vertices=new Array(8);for(let t=0;t<8;++t)this.vertices[t]=new $e}update(t,e){if($e.set(this.planes[0].n,t.m03+t.m00,t.m07+t.m04,t.m11+t.m08),this.planes[0].d=-(t.m15+t.m12),$e.set(this.planes[1].n,t.m03-t.m00,t.m07-t.m04,t.m11-t.m08),this.planes[1].d=-(t.m15-t.m12),$e.set(this.planes[2].n,t.m03+t.m01,t.m07+t.m05,t.m11+t.m09),this.planes[2].d=-(t.m15+t.m13),$e.set(this.planes[3].n,t.m03-t.m01,t.m07-t.m05,t.m11-t.m09),this.planes[3].d=-(t.m15-t.m13),$e.set(this.planes[4].n,t.m03+t.m02,t.m07+t.m06,t.m11+t.m10),this.planes[4].d=-(t.m15+t.m14),$e.set(this.planes[5].n,t.m03-t.m02,t.m07-t.m06,t.m11-t.m10),this.planes[5].d=-(t.m15-t.m14),this._type===go.SHAPE_FRUSTUM_ACCURATE){for(let t=0;t<6;t++){const e=this.planes[t],n=1/e.n.length();$e.multiplyScalar(e.n,e.n,n),e.d*=n}for(let t=0;t<8;t++)$e.transformMat4(this.vertices[t],el[t],e)}}transform(t){if(this._type===go.SHAPE_FRUSTUM_ACCURATE){for(let e=0;e<8;e++)$e.transformMat4(this.vertices[e],this.vertices[e],t);jc.fromPoints(this.planes[0],this.vertices[1],this.vertices[5],this.vertices[6]),jc.fromPoints(this.planes[1],this.vertices[3],this.vertices[7],this.vertices[4]),jc.fromPoints(this.planes[2],this.vertices[6],this.vertices[7],this.vertices[3]),jc.fromPoints(this.planes[3],this.vertices[0],this.vertices[4],this.vertices[5]),jc.fromPoints(this.planes[4],this.vertices[2],this.vertices[3],this.vertices[0]),jc.fromPoints(this.planes[0],this.vertices[7],this.vertices[6],this.vertices[5])}}}function il(t,e){if(!e||0===t)return;const n=e.vertices;let i=ms.VERTICES;for(let e=0;e<8;++e)vs.setVec3(t,i,n[e]),i+=3;const s=e.planes;let o=ms.PLANES;for(let e=0;e<6;e++,o+=4)vs.setVec4(t,o,s[e])}let sl,ol;nl.createOrtho=(()=>{const t=new $e;return(e,n,i,s,o,r)=>{const a=n/2,c=i/2;$e.set(t,a,c,s),$e.transformMat4(e.vertices[0],t,r),$e.set(t,-a,c,s),$e.transformMat4(e.vertices[1],t,r),$e.set(t,-a,-c,s),$e.transformMat4(e.vertices[2],t,r),$e.set(t,a,-c,s),$e.transformMat4(e.vertices[3],t,r),$e.set(t,a,c,o),$e.transformMat4(e.vertices[4],t,r),$e.set(t,-a,c,o),$e.transformMat4(e.vertices[5],t,r),$e.set(t,-a,-c,o),$e.transformMat4(e.vertices[6],t,r),$e.set(t,a,-c,o),$e.transformMat4(e.vertices[7],t,r),jc.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),jc.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),jc.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),jc.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),jc.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),jc.fromPoints(e.planes[0],e.vertices[7],e.vertices[5],e.vertices[6])}})(),function(t){t[t.Default=0]="Default",t[t.Normal=1]="Normal",t[t.Loop=2]="Loop",t[t.ShouldWrap=4]="ShouldWrap",t[t.Clamp=8]="Clamp",t[t.PingPong=22]="PingPong",t[t.Reverse=36]="Reverse"}(sl||(sl={})),function(t){t[t.Default=sl.Default]="Default",t[t.Normal=sl.Normal]="Normal",t[t.Reverse=sl.Reverse]="Reverse",t[t.Loop=sl.Loop]="Loop",t[t.LoopReverse=sl.Loop|sl.Reverse]="LoopReverse",t[t.PingPong=sl.PingPong]="PingPong",t[t.PingPongReverse=sl.PingPong|sl.Reverse]="PingPongReverse"}(ol||(ol={})),Mt(ol);class rl{constructor(t){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,t&&this.set(t)}set(t){this.ratio=t.ratio,this.time=t.time,this.direction=t.direction,this.stopped=t.stopped,this.iterations=t.iterations,this.frameIndex=t.frameIndex}}const al=It({Default:sl.Default,Normal:sl.Normal,Clamp:sl.Clamp,Loop:sl.Loop,PingPong:sl.PingPong});class cl{constructor(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0}}Se.fastDefine("cc.Keyframe",cl,{time:0,value:0,inTangent:0,outTangent:0});class ll{constructor(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}evaluate(t){return e=t-this.time,n=this.coefficient,e*(e*(e*n[0]+n[1])+n[2])+n[3];var e,n}}class hl{constructor(t=null){this.keyFrames=void 0,this.preWrapMode=al.Loop,this.postWrapMode=al.Clamp,this.cachedKey=void 0,this.keyFrames=t||[].concat(hl.defaultKF),this.cachedKey=new ll}addKey(t){null==this.keyFrames&&(this.keyFrames=[]),this.keyFrames.push(t)}evaluate_slow(t){let e=t;const n=t<0?this.preWrapMode:this.postWrapMode,i=this.keyFrames[0].time,s=this.keyFrames[this.keyFrames.length-1].time;switch(n){case al.Loop:e=Ge(t-i,s-i)+i;break;case al.PingPong:e=Ve(t-i,s-i)+i;break;case al.Default:case al.Normal:case al.Clamp:default:e=De(t,i,s)}let o=0;if(e>this.keyFrames[0].time)if(e>=this.keyFrames[this.keyFrames.length-1].time)o=this.keyFrames.length-2;else for(let t=0;t<this.keyFrames.length-1;t++)if(e>=this.keyFrames[0].time&&e<=this.keyFrames[t+1].time){o=t;break}const r=this.keyFrames[o],a=this.keyFrames[o+1],c=je(r.time,a.time,e),l=a.time-r.time,h=r.outTangent*l,_=a.inTangent*l,u=c*c,d=u*c,p=d-2*u+c,f=d-u,m=-2*d+3*u;return(2*d-3*u+1)*r.value+p*h+f*_+m*a.value}evaluate(t){let e=t;const n=t<0?this.preWrapMode:this.postWrapMode,i=this.keyFrames[0].time,s=this.keyFrames[this.keyFrames.length-1].time;switch(n){case al.Loop:e=Ge(t-i,s-i)+i;break;case al.PingPong:e=Ve(t-i,s-i)+i;break;case al.Default:case al.Normal:case al.Clamp:default:e=De(t,i,s)}if(e>=this.cachedKey.time&&e<this.cachedKey.endTime)return this.cachedKey.evaluate(e);const o=this.findIndex(this.cachedKey,e),r=Math.min(o+1,this.keyFrames.length-1);return this.calcOptimizedKey(this.cachedKey,o,r),this.cachedKey.evaluate(e)}calcOptimizedKey(t,e,n){const i=this.keyFrames[e],s=this.keyFrames[n];t.index=e,t.time=i.time,t.endTime=s.time;const o=s.time-i.time,r=s.value-i.value,a=1/(o*o),c=i.outTangent*o,l=s.inTangent*o;t.coefficient[0]=(c+l-r-r)*a/o,t.coefficient[1]=(r+r+r-c-c-l)*a,t.coefficient[2]=i.outTangent,t.coefficient[3]=i.value}findIndex(t,e){const n=t.index;if(-1!==n)if(e>this.keyFrames[n].time)for(let t=0;t<3;t++){const i=n+t;if(i+1<this.keyFrames.length&&this.keyFrames[i+1].time>e)return i}else for(let t=0;t<3;t++){const i=n-t;if(i>=0&&this.keyFrames[i-1].time<=e)return i-1}let i,s=0,o=this.keyFrames.length;for(;o-s>1;)i=Math.floor((s+o)/2),this.keyFrames[i].time>=e?o=i:s=i;return s}}hl.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],Se.fastDefine("cc.AnimationCurve",hl,{preWrapMode:al.Default,postWrapMode:al.Default,keyFrames:[]});var _l=Object.freeze({__proto__:null,distance:mo,enums:go,intersect:Fc,Line:zc,Plane:jc,Ray:vo,Triangle:Co,Sphere:Ao,AABB:$c,OBB:tl,Capsule:class{get type(){return this._type}constructor(t=.5,e=.5,n=1){this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=go.SHAPE_CAPSULE,this.radius=t,this.halfHeight=e,this.axis=n,this.center=new $e,this.rotation=new rn,this.ellipseCenter0=new $e(0,e,0),this.ellipseCenter1=new $e(0,-e,0),this.updateCache()}transform(t,e,n,i,s){const o=i,r=We(o);s.radius=this.radius*Math.abs(r);let a=(this.halfHeight+this.radius)*Math.abs(o.y)-s.radius;a<0&&(a=0),s.halfHeight=a,$e.transformMat4(s.center,this.center,t),rn.multiply(s.rotation,this.rotation,n),s.updateCache()}updateCache(){this.updateLocalCenter(),$e.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),$e.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)}updateLocalCenter(){const t=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(t,0,0),this.ellipseCenter1.set(-t,0,0);break;case 1:this.ellipseCenter0.set(0,t,0),this.ellipseCenter1.set(0,-t,0);break;case 2:this.ellipseCenter0.set(0,0,t),this.ellipseCenter1.set(0,0,-t)}}},Frustum:nl,Keyframe:cl,AnimationCurve:hl,get ERaycastMode(){return Qa}});t("geometry",_l);const ul={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295};class dl{static makeMaskInclude(t){let e=0;for(const n of t)e|=n;return e}static makeMaskExclude(t){return~dl.makeMaskInclude(t)}static addLayer(t,e){void 0!==e?e>19||e<0?console.warn("maximum layers reached."):(dl.Enum[t]=1<<e,dl.Enum[e]=t,dl.BitMask[t]=1<<e,dl.BitMask[e]=t):console.warn("bitNum can't be undefined")}static deleteLayer(t){t>19||t<0?console.warn("do not change buildin layers."):(delete dl.Enum[dl.Enum[t]],delete dl.Enum[t],delete dl.BitMask[dl.BitMask[t]],delete dl.BitMask[t])}}let pl,fl;t("Layers",dl),dl.Enum=It(ul),dl.BitMask=Dt({...ul}),i.Layers=dl,function(t){t[t.DEFAULT=100]="DEFAULT",t[t.UI=200]="UI"}(pl||(pl={})),i.RenderPassStage=pl,function(t){t[t.MIN=0]="MIN",t[t.MAX=255]="MAX",t[t.DEFAULT=128]="DEFAULT"}(fl||(fl={}));const ml={bindings:[],layouts:{}},gl={bindings:[],layouts:{}};let vl;!function(t){t[t.UBO_GLOBAL=0]="UBO_GLOBAL",t[t.UBO_CAMERA=1]="UBO_CAMERA",t[t.UBO_SHADOW=2]="UBO_SHADOW",t[t.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",t[t.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",t[t.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",t[t.SAMPLER_GBUFFER_ALBEDOMAP=6]="SAMPLER_GBUFFER_ALBEDOMAP",t[t.SAMPLER_GBUFFER_POSITIONMAP=7]="SAMPLER_GBUFFER_POSITIONMAP",t[t.SAMPLER_GBUFFER_NORMALMAP=8]="SAMPLER_GBUFFER_NORMALMAP",t[t.SAMPLER_GBUFFER_EMISSIVEMAP=9]="SAMPLER_GBUFFER_EMISSIVEMAP",t[t.SAMPLER_LIGHTING_RESULTMAP=10]="SAMPLER_LIGHTING_RESULTMAP",t[t.COUNT=11]="COUNT"}(vl||(vl={}));const yl=vl.SAMPLER_SHADOWMAP,xl=vl.COUNT-yl;let Sl;!function(t){t[t.UBO_LOCAL=0]="UBO_LOCAL",t[t.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",t[t.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",t[t.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",t[t.UBO_MORPH=4]="UBO_MORPH",t[t.SAMPLER_JOINTS=5]="SAMPLER_JOINTS",t[t.SAMPLER_MORPH_POSITION=6]="SAMPLER_MORPH_POSITION",t[t.SAMPLER_MORPH_NORMAL=7]="SAMPLER_MORPH_NORMAL",t[t.SAMPLER_MORPH_TANGENT=8]="SAMPLER_MORPH_TANGENT",t[t.SAMPLER_LIGHTMAP=9]="SAMPLER_LIGHTMAP",t[t.SAMPLER_SPRITE=10]="SAMPLER_SPRITE",t[t.COUNT=11]="COUNT"}(Sl||(Sl={}));const Tl=Sl.SAMPLER_JOINTS,El=Sl.COUNT-Tl;let Al;!function(t){t[t.GLOBAL=0]="GLOBAL",t[t.MATERIAL=1]="MATERIAL",t[t.LOCAL=2]="LOCAL"}(Al||(Al={}));const Cl=new Cr;Cl.bufferOffsets=[0,yl+Tl,yl],Cl.samplerOffsets=[-yl,xl+El,xl-Tl],Cl.flexibleSet=1;class bl{}bl.TIME_OFFSET=0,bl.NATIVE_SIZE_OFFSET=bl.TIME_OFFSET+4,bl.SCREEN_SIZE_OFFSET=bl.NATIVE_SIZE_OFFSET+4,bl.COUNT=bl.SCREEN_SIZE_OFFSET+4,bl.SIZE=4*bl.COUNT,bl.NAME="CCGlobal",bl.BINDING=vl.UBO_GLOBAL,bl.DESCRIPTOR=new Qr(bl.BINDING,cr.UNIFORM_BUFFER,1,$o.ALL),bl.LAYOUT=new Lr(Al.GLOBAL,bl.BINDING,bl.NAME,[new Nr("cc_time",No.FLOAT4,1),new Nr("cc_screenSize",No.FLOAT4,1),new Nr("cc_nativeSize",No.FLOAT4,1)],1),ml.layouts[bl.NAME]=bl.LAYOUT,ml.bindings[bl.BINDING]=bl.DESCRIPTOR;class Pl{}Pl.MAT_VIEW_OFFSET=0,Pl.MAT_VIEW_INV_OFFSET=Pl.MAT_VIEW_OFFSET+16,Pl.MAT_PROJ_OFFSET=Pl.MAT_VIEW_INV_OFFSET+16,Pl.MAT_PROJ_INV_OFFSET=Pl.MAT_PROJ_OFFSET+16,Pl.MAT_VIEW_PROJ_OFFSET=Pl.MAT_PROJ_INV_OFFSET+16,Pl.MAT_VIEW_PROJ_INV_OFFSET=Pl.MAT_VIEW_PROJ_OFFSET+16,Pl.CAMERA_POS_OFFSET=Pl.MAT_VIEW_PROJ_INV_OFFSET+16,Pl.SCREEN_SCALE_OFFSET=Pl.CAMERA_POS_OFFSET+4,Pl.EXPOSURE_OFFSET=Pl.SCREEN_SCALE_OFFSET+4,Pl.MAIN_LIT_DIR_OFFSET=Pl.EXPOSURE_OFFSET+4,Pl.MAIN_LIT_COLOR_OFFSET=Pl.MAIN_LIT_DIR_OFFSET+4,Pl.AMBIENT_SKY_OFFSET=Pl.MAIN_LIT_COLOR_OFFSET+4,Pl.AMBIENT_GROUND_OFFSET=Pl.AMBIENT_SKY_OFFSET+4,Pl.GLOBAL_FOG_COLOR_OFFSET=Pl.AMBIENT_GROUND_OFFSET+4,Pl.GLOBAL_FOG_BASE_OFFSET=Pl.GLOBAL_FOG_COLOR_OFFSET+4,Pl.GLOBAL_FOG_ADD_OFFSET=Pl.GLOBAL_FOG_BASE_OFFSET+4,Pl.COUNT=Pl.GLOBAL_FOG_ADD_OFFSET+4,Pl.SIZE=4*Pl.COUNT,Pl.NAME="CCCamera",Pl.BINDING=vl.UBO_CAMERA,Pl.DESCRIPTOR=new Qr(Pl.BINDING,cr.UNIFORM_BUFFER,1,$o.ALL),Pl.LAYOUT=new Lr(Al.GLOBAL,Pl.BINDING,Pl.NAME,[new Nr("cc_matView",No.MAT4,1),new Nr("cc_matViewInv",No.MAT4,1),new Nr("cc_matProj",No.MAT4,1),new Nr("cc_matProjInv",No.MAT4,1),new Nr("cc_matViewProj",No.MAT4,1),new Nr("cc_matViewProjInv",No.MAT4,1),new Nr("cc_cameraPos",No.FLOAT4,1),new Nr("cc_screenScale",No.FLOAT4,1),new Nr("cc_exposure",No.FLOAT4,1),new Nr("cc_mainLitDir",No.FLOAT4,1),new Nr("cc_mainLitColor",No.FLOAT4,1),new Nr("cc_ambientSky",No.FLOAT4,1),new Nr("cc_ambientGround",No.FLOAT4,1),new Nr("cc_fogColor",No.FLOAT4,1),new Nr("cc_fogBase",No.FLOAT4,1),new Nr("cc_fogAdd",No.FLOAT4,1)],1),ml.layouts[Pl.NAME]=Pl.LAYOUT,ml.bindings[Pl.BINDING]=Pl.DESCRIPTOR;class wl{}wl.MAT_LIGHT_PLANE_PROJ_OFFSET=0,wl.MAT_LIGHT_VIEW_OFFSET=wl.MAT_LIGHT_PLANE_PROJ_OFFSET+16,wl.MAT_LIGHT_VIEW_PROJ_OFFSET=wl.MAT_LIGHT_VIEW_OFFSET+16,wl.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET=wl.MAT_LIGHT_VIEW_PROJ_OFFSET+16,wl.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=wl.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET+4,wl.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=wl.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+4,wl.SHADOW_COLOR_OFFSET=wl.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+4,wl.COUNT=wl.SHADOW_COLOR_OFFSET+4,wl.SIZE=4*wl.COUNT,wl.NAME="CCShadow",wl.BINDING=vl.UBO_SHADOW,wl.DESCRIPTOR=new Qr(wl.BINDING,cr.UNIFORM_BUFFER,1,$o.ALL),wl.LAYOUT=new Lr(Al.GLOBAL,wl.BINDING,wl.NAME,[new Nr("cc_matLightPlaneProj",No.MAT4,1),new Nr("cc_matLightView",No.MAT4,1),new Nr("cc_matLightViewProj",No.MAT4,1),new Nr("cc_shadowNFLSInfo",No.FLOAT4,1),new Nr("cc_shadowWHPBInfo",No.FLOAT4,1),new Nr("cc_shadowLPNNInfo",No.FLOAT4,1),new Nr("cc_shadowColor",No.FLOAT4,1)],1),ml.layouts[wl.NAME]=wl.LAYOUT,ml.bindings[wl.BINDING]=wl.DESCRIPTOR;const Dl=vl.SAMPLER_SHADOWMAP,Il=new Qr(Dl,cr.SAMPLER_TEXTURE,1,$o.FRAGMENT),Rl=new Br(Al.GLOBAL,Dl,"cc_shadowMap",No.SAMPLER2D,1);ml.layouts.cc_shadowMap=Rl,ml.bindings[Dl]=Il;const Ol=vl.SAMPLER_GBUFFER_ALBEDOMAP,Ml=new Qr(Ol,cr.SAMPLER_TEXTURE,1,$o.FRAGMENT),Nl=new Br(Al.GLOBAL,Ol,"cc_gbuffer_albedoMap",No.SAMPLER2D,1);ml.layouts.cc_gbuffer_albedoMap=Nl,ml.bindings[Ol]=Ml;const Ll=vl.SAMPLER_GBUFFER_POSITIONMAP,Bl=new Qr(Ll,cr.SAMPLER_TEXTURE,1,$o.FRAGMENT),Fl=new Br(Al.GLOBAL,Ll,"cc_gbuffer_positionMap",No.SAMPLER2D,1);ml.layouts.cc_gbuffer_positionMap=Fl,ml.bindings[Ll]=Bl;const zl=vl.SAMPLER_GBUFFER_NORMALMAP,Ul=new Qr(zl,cr.SAMPLER_TEXTURE,1,$o.FRAGMENT),Hl=new Br(Al.GLOBAL,zl,"cc_gbuffer_normalMap",No.SAMPLER2D,1);ml.layouts.cc_gbuffer_normalMap=Hl,ml.bindings[zl]=Ul;const Gl=vl.SAMPLER_LIGHTING_RESULTMAP,Vl=new Qr(Gl,cr.SAMPLER_TEXTURE,1,$o.FRAGMENT),jl=new Br(Al.GLOBAL,Gl,"cc_lighting_resultMap",No.SAMPLER2D,1);ml.layouts.cc_lighting_resultMap=jl,ml.bindings[Gl]=Vl;const Wl=vl.SAMPLER_GBUFFER_EMISSIVEMAP,kl=new Qr(Wl,cr.SAMPLER_TEXTURE,1,$o.FRAGMENT),ql=new Br(Al.GLOBAL,Wl,"cc_gbuffer_emissiveMap",No.SAMPLER2D,1);ml.layouts.cc_gbuffer_emissiveMap=ql,ml.bindings[Wl]=kl;const Xl=vl.SAMPLER_ENVIRONMENT,Yl=new Qr(Xl,cr.SAMPLER_TEXTURE,1,$o.FRAGMENT),Kl=new Br(Al.GLOBAL,Xl,"cc_environment",No.SAMPLER_CUBE,1);ml.layouts.cc_environment=Kl,ml.bindings[Xl]=Yl;const $l=vl.SAMPLER_SPOT_LIGHTING_MAP,Zl=new Qr($l,cr.SAMPLER_TEXTURE,1,$o.FRAGMENT),Jl=new Br(Al.GLOBAL,$l,"cc_spotLightingMap",No.SAMPLER2D,1);ml.layouts.cc_spotLightingMap=Jl,ml.bindings[$l]=Zl;class Ql{}Ql.MAT_WORLD_OFFSET=0,Ql.MAT_WORLD_IT_OFFSET=Ql.MAT_WORLD_OFFSET+16,Ql.LIGHTINGMAP_UVPARAM=Ql.MAT_WORLD_IT_OFFSET+16,Ql.COUNT=Ql.LIGHTINGMAP_UVPARAM+4,Ql.SIZE=4*Ql.COUNT,Ql.NAME="CCLocal",Ql.BINDING=Sl.UBO_LOCAL,Ql.DESCRIPTOR=new Qr(Ql.BINDING,cr.UNIFORM_BUFFER,1,$o.VERTEX),Ql.LAYOUT=new Lr(Al.LOCAL,Ql.BINDING,Ql.NAME,[new Nr("cc_matWorld",No.MAT4,1),new Nr("cc_matWorldIT",No.MAT4,1),new Nr("cc_lightingMapUVParam",No.FLOAT4,1)],1),gl.layouts[Ql.NAME]=Ql.LAYOUT,gl.bindings[Ql.BINDING]=Ql.DESCRIPTOR;class th{}th.BATCHING_COUNT=10,th.MAT_WORLDS_OFFSET=0,th.COUNT=16*th.BATCHING_COUNT,th.SIZE=4*th.COUNT,th.NAME="CCLocalBatched",th.BINDING=Sl.UBO_LOCAL,th.DESCRIPTOR=new Qr(th.BINDING,cr.UNIFORM_BUFFER,1,$o.VERTEX),th.LAYOUT=new Lr(Al.LOCAL,th.BINDING,th.NAME,[new Nr("cc_matWorlds",No.MAT4,th.BATCHING_COUNT)],1),gl.layouts[th.NAME]=th.LAYOUT,gl.bindings[th.BINDING]=th.DESCRIPTOR;class eh{}eh.LIGHTS_PER_PASS=1,eh.LIGHT_POS_OFFSET=0,eh.LIGHT_COLOR_OFFSET=eh.LIGHT_POS_OFFSET+4*eh.LIGHTS_PER_PASS,eh.LIGHT_SIZE_RANGE_ANGLE_OFFSET=eh.LIGHT_COLOR_OFFSET+4*eh.LIGHTS_PER_PASS,eh.LIGHT_DIR_OFFSET=eh.LIGHT_SIZE_RANGE_ANGLE_OFFSET+4*eh.LIGHTS_PER_PASS,eh.COUNT=eh.LIGHT_DIR_OFFSET+4*eh.LIGHTS_PER_PASS,eh.SIZE=4*eh.COUNT,eh.NAME="CCForwardLight",eh.BINDING=Sl.UBO_FORWARD_LIGHTS,eh.DESCRIPTOR=new Qr(eh.BINDING,cr.DYNAMIC_UNIFORM_BUFFER,1,$o.FRAGMENT),eh.LAYOUT=new Lr(Al.LOCAL,eh.BINDING,eh.NAME,[new Nr("cc_lightPos",No.FLOAT4,eh.LIGHTS_PER_PASS),new Nr("cc_lightColor",No.FLOAT4,eh.LIGHTS_PER_PASS),new Nr("cc_lightSizeRangeAngle",No.FLOAT4,eh.LIGHTS_PER_PASS),new Nr("cc_lightDir",No.FLOAT4,eh.LIGHTS_PER_PASS)],1),gl.layouts[eh.NAME]=eh.LAYOUT,gl.bindings[eh.BINDING]=eh.DESCRIPTOR;class nh{}nh.JOINTS_TEXTURE_INFO_OFFSET=0,nh.COUNT=nh.JOINTS_TEXTURE_INFO_OFFSET+4,nh.SIZE=4*nh.COUNT,nh.NAME="CCSkinningTexture",nh.BINDING=Sl.UBO_SKINNING_TEXTURE,nh.DESCRIPTOR=new Qr(nh.BINDING,cr.UNIFORM_BUFFER,1,$o.VERTEX),nh.LAYOUT=new Lr(Al.LOCAL,nh.BINDING,nh.NAME,[new Nr("cc_jointTextureInfo",No.FLOAT4,1)],1),gl.layouts[nh.NAME]=nh.LAYOUT,gl.bindings[nh.BINDING]=nh.DESCRIPTOR;class ih{}ih.JOINTS_ANIM_INFO_OFFSET=0,ih.COUNT=ih.JOINTS_ANIM_INFO_OFFSET+4,ih.SIZE=4*ih.COUNT,ih.NAME="CCSkinningAnimation",ih.BINDING=Sl.UBO_SKINNING_ANIMATION,ih.DESCRIPTOR=new Qr(ih.BINDING,cr.UNIFORM_BUFFER,1,$o.VERTEX),ih.LAYOUT=new Lr(Al.LOCAL,ih.BINDING,ih.NAME,[new Nr("cc_jointAnimInfo",No.FLOAT4,1)],1),gl.layouts[ih.NAME]=ih.LAYOUT,gl.bindings[ih.BINDING]=ih.DESCRIPTOR;class sh{}sh.JOINTS_OFFSET=0,sh.COUNT=sh.JOINTS_OFFSET+360,sh.SIZE=4*sh.COUNT,sh.NAME="CCSkinning",sh.BINDING=Sl.UBO_SKINNING_TEXTURE,sh.DESCRIPTOR=new Qr(sh.BINDING,cr.UNIFORM_BUFFER,1,$o.VERTEX),sh.LAYOUT=new Lr(Al.LOCAL,sh.BINDING,sh.NAME,[new Nr("cc_joints",No.FLOAT4,90)],1),gl.layouts[sh.NAME]=sh.LAYOUT,gl.bindings[sh.BINDING]=sh.DESCRIPTOR;class oh{}oh.MAX_MORPH_TARGET_COUNT=60,oh.OFFSET_OF_WEIGHTS=0,oh.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*oh.MAX_MORPH_TARGET_COUNT,oh.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=oh.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH+4,oh.OFFSET_OF_VERTICES_COUNT=oh.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT+4,oh.COUNT_BASE_4_BYTES=4*Math.ceil(oh.MAX_MORPH_TARGET_COUNT/4)+4,oh.SIZE=4*oh.COUNT_BASE_4_BYTES,oh.NAME="CCMorph",oh.BINDING=Sl.UBO_MORPH,oh.DESCRIPTOR=new Qr(oh.BINDING,cr.UNIFORM_BUFFER,1,$o.VERTEX),oh.LAYOUT=new Lr(Al.LOCAL,oh.BINDING,oh.NAME,[new Nr("cc_displacementWeights",No.FLOAT4,oh.MAX_MORPH_TARGET_COUNT/4),new Nr("cc_displacementTextureInfo",No.FLOAT4,1)],1),gl.layouts[oh.NAME]=oh.LAYOUT,gl.bindings[oh.BINDING]=oh.DESCRIPTOR;const rh=Sl.SAMPLER_JOINTS,ah=new Qr(rh,cr.SAMPLER_TEXTURE,1,$o.VERTEX),ch=new Br(Al.LOCAL,rh,"cc_jointTexture",No.SAMPLER2D,1);gl.layouts.cc_jointTexture=ch,gl.bindings[rh]=ah;const lh=Sl.SAMPLER_MORPH_POSITION,hh=new Qr(lh,cr.SAMPLER_TEXTURE,1,$o.VERTEX),_h=new Br(Al.LOCAL,lh,"cc_PositionDisplacements",No.SAMPLER2D,1);gl.layouts.cc_PositionDisplacements=_h,gl.bindings[lh]=hh;const uh=Sl.SAMPLER_MORPH_NORMAL,dh=new Qr(uh,cr.SAMPLER_TEXTURE,1,$o.VERTEX),ph=new Br(Al.LOCAL,uh,"cc_NormalDisplacements",No.SAMPLER2D,1);gl.layouts.cc_NormalDisplacements=ph,gl.bindings[uh]=dh;const fh=Sl.SAMPLER_MORPH_TANGENT,mh=new Qr(fh,cr.SAMPLER_TEXTURE,1,$o.VERTEX),gh=new Br(Al.LOCAL,fh,"cc_TangentDisplacements",No.SAMPLER2D,1);gl.layouts.cc_TangentDisplacements=gh,gl.bindings[fh]=mh;const vh=Sl.SAMPLER_LIGHTMAP,yh=new Qr(vh,cr.SAMPLER_TEXTURE,1,$o.FRAGMENT),xh=new Br(Al.LOCAL,vh,"cc_lightingMap",No.SAMPLER2D,1);gl.layouts.cc_lightingMap=xh,gl.bindings[vh]=yh;const Sh=Sl.SAMPLER_SPRITE,Th=new Qr(Sh,cr.SAMPLER_TEXTURE,1,$o.FRAGMENT),Eh=new Br(Al.LOCAL,Sh,"cc_spriteTexture",No.SAMPLER2D,1);gl.layouts.cc_spriteTexture=Eh,gl.bindings[Sh]=Th;const Ah=dl.makeMaskExclude([dl.BitMask.UI_2D,dl.BitMask.GIZMOS,dl.BitMask.EDITOR,dl.BitMask.SCENE_GIZMO,dl.BitMask.PROFILER]);let Ch,bh,Ph,wh,Dh;dl.makeMaskExclude([dl.BitMask.UI_2D,dl.BitMask.PROFILER]),dl.Enum.ALL,function(t){t[t.VERTICAL=0]="VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL"}(Ch||(Ch={})),function(t){t[t.ORTHO=0]="ORTHO",t[t.PERSPECTIVE=1]="PERSPECTIVE"}(bh||(bh={})),function(t){t[t.F1_8=0]="F1_8",t[t.F2_0=1]="F2_0",t[t.F2_2=2]="F2_2",t[t.F2_5=3]="F2_5",t[t.F2_8=4]="F2_8",t[t.F3_2=5]="F3_2",t[t.F3_5=6]="F3_5",t[t.F4_0=7]="F4_0",t[t.F4_5=8]="F4_5",t[t.F5_0=9]="F5_0",t[t.F5_6=10]="F5_6",t[t.F6_3=11]="F6_3",t[t.F7_1=12]="F7_1",t[t.F8_0=13]="F8_0",t[t.F9_0=14]="F9_0",t[t.F10_0=15]="F10_0",t[t.F11_0=16]="F11_0",t[t.F13_0=17]="F13_0",t[t.F14_0=18]="F14_0",t[t.F16_0=19]="F16_0",t[t.F18_0=20]="F18_0",t[t.F20_0=21]="F20_0",t[t.F22_0=22]="F22_0"}(Ph||(Ph={})),function(t){t[t.ISO100=0]="ISO100",t[t.ISO200=1]="ISO200",t[t.ISO400=2]="ISO400",t[t.ISO800=3]="ISO800"}(wh||(wh={})),function(t){t[t.D1=0]="D1",t[t.D2=1]="D2",t[t.D4=2]="D4",t[t.D8=3]="D8",t[t.D15=4]="D15",t[t.D30=5]="D30",t[t.D60=6]="D60",t[t.D125=7]="D125",t[t.D250=8]="D250",t[t.D500=9]="D500",t[t.D1000=10]="D1000",t[t.D2000=11]="D2000",t[t.D4000=12]="D4000"}(Dh||(Dh={}));const Ih=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],Rh=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],Oh=[100,200,400,800],Mh=new $e,Nh=new $e,Lh=new pn,Bh=_r.STENCIL<<1,Fh=[];class zh{constructor(t){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=Ch.VERTICAL,this._fov=Oe(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new Ar(.2,.2,.2,1),this._viewport=new Sn(0,0,1,1),this._curTransform=Io.IDENTITY,this._isProjDirty=!0,this._matView=new pn,this._matViewInv=null,this._matProj=new pn,this._matProjInv=new pn,this._matViewProj=new pn,this._matViewProjInv=new pn,this._frustum=new nl,this._forward=new $e,this._position=new $e,this._priority=0,this._aperture=Ph.F16_0,this._apertureValue=void 0,this._shutter=Dh.D125,this._shutterValue=0,this._iso=wh.ISO100,this._isoValue=0,this._ec=0,this._poolHandle=0,this._frustumHandle=0,this._window=null,this._device=t,this._apertureValue=Ih[this._aperture],this._shutterValue=Rh[this._shutter],this._isoValue=Oh[this._iso],this._aspect=this.screenScale=1,!Fh.length){const e=t.capabilities.clipSpaceSignY;Fh[Io.IDENTITY]=new pn(1,0,0,0,0,e),Fh[Io.ROTATE_90]=new pn(0,1,0,0,-e,0),Fh[Io.ROTATE_180]=new pn(-1,0,0,0,0,-e),Fh[Io.ROTATE_270]=new pn(0,-1,0,0,e,0)}}initialize(t){this._name=t.name,this._node=t.node,this._proj=t.projection,this._priority=t.priority||0,this._aspect=this.screenScale=1;const e=this._poolHandle=rs.alloc();rs.set(e,ss.WIDTH,1),rs.set(e,ss.HEIGHT,1),rs.set(e,ss.CLEAR_FLAGS,_r.NONE),rs.set(e,ss.CLEAR_DEPTH,1),rs.set(e,ss.NODE,this._node.handle),rs.set(e,ss.VISIBILITY,Ah),this._scene&&rs.set(e,ss.SCENE,this._scene.handle),this._frustumHandle=vs.alloc(),rs.set(e,ss.FRUSTUM,this._frustumHandle),this.updateExposure(),this.changeTargetWindow(t.window),console.log(`Created Camera: ${this._name} ${rs.get(e,ss.WIDTH)}x${rs.get(e,ss.HEIGHT)}`)}destroy(){this._window&&this._window.detachCamera(this),this._name=null,this._poolHandle&&(rs.free(this._poolHandle),this._poolHandle=0,this._frustumHandle&&(vs.free(this._frustumHandle),this._frustumHandle=0))}attachToScene(t){this._scene=t,this._enabled=!0,rs.set(this._poolHandle,ss.SCENE,t.handle)}detachFromScene(){this._scene=null,this._enabled=!1,rs.set(this._poolHandle,ss.SCENE,0)}resize(t,e){const n=this._poolHandle;rs.set(n,ss.WIDTH,t),rs.set(n,ss.HEIGHT,e),this._aspect=t*this._viewport.width/(e*this._viewport.height),this._isProjDirty=!0}setFixedSize(t,e){const n=this._poolHandle;rs.set(n,ss.WIDTH,t),rs.set(n,ss.HEIGHT,e),this._aspect=t*this._viewport.width/(e*this._viewport.height),this.isWindowSize=!1}update(t=!1){if(!this._node)return;let e=!1;(this._node.hasChangedFlags||t)&&(pn.invert(this._matView,this._node.worldMatrix),rs.setMat4(this._poolHandle,ss.MAT_VIEW,this._matView),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),rs.setVec3(this._poolHandle,ss.POSITION,this._position),rs.setVec3(this._poolHandle,ss.FORWARD,this._forward),e=!0);let n=this._device.surfaceTransform;if(this._isProjDirty||this._curTransform!==n){var i;this._curTransform=n;const t=this._device.capabilities.clipSpaceSignY;if((null===(i=this.window)||void 0===i?void 0:i.hasOffScreenAttachments)&&(n=Io.IDENTITY),this._proj===bh.PERSPECTIVE)pn.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===Ch.VERTICAL,this._device.capabilities.clipSpaceMinZ,t,n);else{const e=this._orthoHeight*this._aspect,i=this._orthoHeight;pn.ortho(this._matProj,-e,e,-i,i,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,t,n)}pn.invert(this._matProjInv,this._matProj),rs.setMat4(this._poolHandle,ss.MAT_PROJ,this._matProj),rs.setMat4(this._poolHandle,ss.MAT_PROJ_INV,this._matProjInv),e=!0,this._isProjDirty=!1}e&&(pn.multiply(this._matViewProj,this._matProj,this._matView),pn.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv),rs.setMat4(this._poolHandle,ss.MAT_VIEW_PROJ,this._matViewProj),rs.setMat4(this._poolHandle,ss.MAT_VIEW_PROJ_INV,this._matViewProjInv),il(this._frustumHandle,this._frustum))}set node(t){this._node=t}get node(){return this._node}set enabled(t){this._enabled=t}get enabled(){return this._enabled}set orthoHeight(t){this._orthoHeight=t,this._isProjDirty=!0}get orthoHeight(){return this._orthoHeight}set projectionType(t){this._proj=t,this._isProjDirty=!0}get projectionType(){return this._proj}set fovAxis(t){this._fovAxis=t,this._isProjDirty=!0}get fovAxis(){return this._fovAxis}set fov(t){this._fov=t,this._isProjDirty=!0}get fov(){return this._fov}set nearClip(t){this._nearClip=t,this._isProjDirty=!0}get nearClip(){return this._nearClip}set farClip(t){this._farClip=t,this._isProjDirty=!0}get farClip(){return this._farClip}set clearColor(t){this._clearColor.x=t.x,this._clearColor.y=t.y,this._clearColor.z=t.z,this._clearColor.w=t.w,rs.setVec4(this._poolHandle,ss.CLEAR_COLOR,t)}get clearColor(){return this._clearColor}get viewport(){return this._viewport}set viewport(t){const{x:e,width:n,height:i}=t,s=this._device.capabilities.clipSpaceSignY<0?1-t.y-i:t.y;switch(this._device.surfaceTransform){case Io.ROTATE_90:this._viewport.x=1-s-i,this._viewport.y=e,this._viewport.width=i,this._viewport.height=n;break;case Io.ROTATE_180:this._viewport.x=1-e-n,this._viewport.y=1-s-i,this._viewport.width=n,this._viewport.height=i;break;case Io.ROTATE_270:this._viewport.x=s,this._viewport.y=1-e-n,this._viewport.width=i,this._viewport.height=n;break;case Io.IDENTITY:this._viewport.x=e,this._viewport.y=s,this._viewport.width=n,this._viewport.height=i}rs.setVec4(this._poolHandle,ss.VIEW_PORT,this._viewport),this.resize(this.width,this.height)}get scene(){return this._scene}get name(){return this._name}get width(){return rs.get(this._poolHandle,ss.WIDTH)}get height(){return rs.get(this._poolHandle,ss.HEIGHT)}get aspect(){return this._aspect}set matView(t){this._matView=t,rs.setMat4(this._poolHandle,ss.MAT_VIEW,this._matView)}get matView(){return this._matView}set matViewInv(t){this._matViewInv=t}get matViewInv(){return this._matViewInv||this._node.worldMatrix}set matProj(t){this._matProj=t,rs.setMat4(this._poolHandle,ss.MAT_PROJ,this._matProj)}get matProj(){return this._matProj}set matProjInv(t){this._matProjInv=t,rs.setMat4(this._poolHandle,ss.MAT_PROJ_INV,this._matProjInv)}get matProjInv(){return this._matProjInv}set matViewProj(t){this._matViewProj=t,rs.setMat4(this._poolHandle,ss.MAT_VIEW_PROJ,this._matViewProj)}get matViewProj(){return this._matViewProj}set matViewProjInv(t){this._matViewProjInv=t,rs.setMat4(this._poolHandle,ss.MAT_VIEW_PROJ_INV,this._matViewProjInv)}get matViewProjInv(){return this._matViewProjInv}set frustum(t){this._frustum=t,il(this._frustumHandle,t)}get frustum(){return this._frustum}set window(t){this._window=t,t&&rs.set(this._poolHandle,ss.WINDOW,t.handle)}get window(){return this._window}set forward(t){this._forward=t,rs.setVec3(this._poolHandle,ss.FORWARD,this._forward)}get forward(){return this._forward}set position(t){this._position=t,rs.setVec3(this._poolHandle,ss.POSITION,this._position)}get position(){return this._position}set visibility(t){rs.set(this._poolHandle,ss.VISIBILITY,t)}get visibility(){return rs.get(this._poolHandle,ss.VISIBILITY)}get priority(){return this._priority}set priority(t){this._priority=t}set aperture(t){this._aperture=t,this._apertureValue=Ih[this._aperture],this.updateExposure()}get aperture(){return this._aperture}get apertureValue(){return this._apertureValue}set shutter(t){this._shutter=t,this._shutterValue=Rh[this._shutter],this.updateExposure()}get shutter(){return this._shutter}get shutterValue(){return this._shutterValue}set iso(t){this._iso=t,this._isoValue=Oh[this._iso],this.updateExposure()}get iso(){return this._iso}get isoValue(){return this._isoValue}set ec(t){this._ec=t}get ec(){return this._ec}get exposure(){return rs.get(this._poolHandle,ss.EXPOSURE)}get clearFlag(){return rs.get(this._poolHandle,ss.CLEAR_FLAGS)}set clearFlag(t){rs.set(this._poolHandle,ss.CLEAR_FLAGS,t)}get clearDepth(){return rs.get(this._poolHandle,ss.CLEAR_DEPTH)}set clearDepth(t){rs.set(this._poolHandle,ss.CLEAR_DEPTH,t)}get clearStencil(){return rs.get(this._poolHandle,ss.CLEAR_STENCIL)}set clearStencil(t){rs.set(this._poolHandle,ss.CLEAR_STENCIL,t)}get handle(){return this._poolHandle}changeTargetWindow(t=null){this._window&&this._window.detachCamera(this);const e=t||i.director.root.mainWindow;e&&(e.attachCamera(this),this.resize(e.width,e.height),this._window=e,rs.set(this._poolHandle,ss.WINDOW,e.handle))}detachCamera(){this._window&&this._window.detachCamera(this)}screenPointToRay(t,e,n){if(!this._node)return null;const i=this._poolHandle,s=rs.get(i,ss.WIDTH),o=rs.get(i,ss.HEIGHT),r=this._viewport.x*s,a=this._viewport.y*o,c=this._viewport.width*s,l=this._viewport.height*o,h=this._proj===bh.PERSPECTIVE,_=this._device.capabilities.clipSpaceSignY,u=dn[this._curTransform];$e.set(Mh,(e-r)/c*2-1,(n-a)/l*2-1,h?1:-1);const{x:d,y:p}=Mh;return Mh.x=d*u[0]+p*u[2]*_,Mh.y=d*u[1]+p*u[3]*_,$e.transformMat4(h?Mh:t.o,Mh,this._matViewProjInv),h?(this._node.getWorldPosition(Nh),vo.fromPoints(t,Nh,Mh)):$e.transformQuat(t.d,$e.FORWARD,this._node.worldRotation),t}screenToWorld(t,e){const n=this._poolHandle,i=rs.get(n,ss.WIDTH),s=rs.get(n,ss.HEIGHT),o=this._viewport.x*i,r=this._viewport.y*s,a=this._viewport.width*i,c=this._viewport.height*s,l=this._device.capabilities.clipSpaceSignY,h=dn[this._curTransform];if(this._proj===bh.PERSPECTIVE){$e.set(t,(e.x-o)/a*2-1,(e.y-r)/c*2-1,1);const{x:n,y:i}=t;t.x=n*h[0]+i*h[2]*l,t.y=n*h[1]+i*h[3]*l,$e.transformMat4(t,t,this._matViewProjInv),this._node&&this._node.getWorldPosition(Mh),$e.lerp(t,Mh,t,Re(this._nearClip/this._farClip,1,e.z))}else{$e.set(t,(e.x-o)/a*2-1,(e.y-r)/c*2-1,2*e.z-1);const{x:n,y:i}=t;t.x=n*h[0]+i*h[2]*l,t.y=n*h[1]+i*h[3]*l,$e.transformMat4(t,t,this._matViewProjInv)}return t}worldToScreen(t,e){const n=this._poolHandle,i=rs.get(n,ss.WIDTH),s=rs.get(n,ss.HEIGHT),o=this._viewport.x*i,r=this._viewport.y*s,a=this._viewport.width*i,c=this._viewport.height*s,l=this._device.capabilities.clipSpaceSignY,h=dn[this._curTransform];$e.transformMat4(t,e,this._matViewProj);const{x:_,y:u}=t;return t.x=_*h[0]+u*h[2]*l,t.y=_*h[1]+u*h[3]*l,t.x=o+.5*(t.x+1)*a,t.y=r+.5*(t.y+1)*c,t.z=.5*t.z+.5,t}worldMatrixToScreen(t,e,n,i){pn.multiply(t,this._matViewProj,e),pn.multiply(t,Fh[this._curTransform],t);const s=n/2,o=i/2;return pn.identity(Lh),pn.transform(Lh,Lh,$e.set(Mh,s,o,0)),pn.scale(Lh,Lh,$e.set(Mh,s,o,1)),pn.multiply(t,Lh,t),t}updateExposure(){const t=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);rs.set(this._poolHandle,ss.EXPOSURE,.833333/2**t)}}let Uh,Hh,Gh;function Vh(t,e){e<1e3?e=1e3:e>15e3&&(e=15e3);const n=e*e,i=(.860117757+.000154118254*e+1.28641212e-7*n)/(1+.000842420235*e+7.08145163e-7*n),s=(.317398726+422806245e-13*e+4.20481691e-8*n)/(1-289741816e-13*e+1.61456053e-7*n),o=2*i-8*s+4,r=3*i/o,a=2*s/o,c=1/a*r,l=1/a*(1-r-a);t.x=3.2404542*c-1.5371385+-.4985314*l,t.y=-.969266*c+1.8760108+.041556*l,t.z=.0556434*c-.2040259+1.0572252*l}!function(t){t[t.LOCAL=0]="LOCAL",t[t.WORLD=1]="WORLD"}(Uh||(Uh={})),function(t){t[t.NONE=0]="NONE",t[t.POSITION=1]="POSITION",t[t.ROTATION=2]="ROTATION",t[t.SCALE=4]="SCALE",t[t.RS=t.ROTATION|t.SCALE]="RS",t[t.TRS=t.POSITION|t.ROTATION|t.SCALE]="TRS",t[t.TRS_MASK=~t.TRS]="TRS_MASK"}(Hh||(Hh={})),i.internal.TransformBit=Hh,function(t){t[t.DIRECTIONAL=0]="DIRECTIONAL",t[t.SPHERE=1]="SPHERE",t[t.SPOT=2]="SPOT",t[t.UNKNOWN=3]="UNKNOWN"}(Gh||(Gh={}));const jh=t=>4*Math.PI*Math.PI*t*t;class Wh{constructor(){this._baked=!1,this._color=new $e(1,1,1),this._colorTemp=6550,this._colorTempRGB=new $e(1,1,1),this._scene=null,this._node=null,this._name=null,this._handle=0}get baked(){return this._baked}set baked(t){this._baked=t}set color(t){this._color.set(t),Bs.setVec3(this._handle,Ns.COLOR,t)}get color(){return this._color}set useColorTemperature(t){Bs.set(this._handle,Ns.USE_COLOR_TEMPERATURE,t?1:0)}get useColorTemperature(){return 1===Bs.get(this._handle,Ns.USE_COLOR_TEMPERATURE)}set colorTemperature(t){this._colorTemp=t,Vh(this._colorTempRGB,this._colorTemp),Bs.setVec3(this._handle,Ns.COLOR_TEMPERATURE_RGB,this._colorTempRGB)}get colorTemperature(){return this._colorTemp}get colorTemperatureRGB(){return this._colorTempRGB}set node(t){this._node=t,this._node&&(this._node.hasChangedFlags|=Hh.ROTATION,Bs.set(this._handle,Ns.NODE,this._node.handle))}get node(){return this._node}get type(){return Bs.get(this._handle,Ns.TYPE)}get name(){return this._name}set name(t){this._name=t}get scene(){return this._scene}get handle(){return this._handle}initialize(){this._handle=Bs.alloc(),Bs.setVec3(this._handle,Ns.COLOR,this._color),Bs.setVec3(this._handle,Ns.COLOR_TEMPERATURE_RGB,this._colorTempRGB),Bs.set(this._handle,Ns.TYPE,Gh.UNKNOWN)}attachToScene(t){this._scene=t}detachFromScene(){this._scene=null}destroy(){this._name=null,this._node=null,this._handle&&(Bs.free(this._handle),this._handle=0)}update(){}}const kh=new $e(0,0,-1),qh=new $e;function Xh(t,e,n,i){n&&Object.defineProperty(t,e,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(i):void 0})}function Yh(t,e,n,i,s){var o={};return Object.keys(i).forEach((function(t){o[t]=i[t]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=n.slice().reverse().reduce((function(n,i){return i(t,e,n)||n}),o),s&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(s):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(t,e,o),o=null),o}const Kh=()=>{},$h=()=>Kh,Zh=Jh((()=>{}));function Jh(t){return function(e){return"function"==typeof e?t(e):function(n){return t(n,e)}}}function Qh(t){return e=>n=>{!function(t,e,n){const i=e_(t);if(i){const t=n_(i,"proto");n_(t,"editor")[e]=n}}(n,t,e)}}const t_="__ccclassCache__";function e_(t){return n_(t,t_)}function n_(t,e){return t[e]||(t[e]={})}const i_=Jh(((t,e)=>{let n=wt.getSuper(t);n===Object&&(n=null);const i={name:e,extends:n,ctor:t},s=t[t_];if(s){const e=s.proto;e&&wt.mixin(i,e),t[t_]=void 0}return Se(i)})),s_=Qh("requireComponent"),o_=Qh("executionOrder"),r_=Zh;function a_(t,e,n){let i=null;function s(t,e,n){const s=e_(t.constructor);if(s){const o=n_(s,"proto"),r=n_(o,"properties");!function(t,e,n,i,s,o){let r;const a=s&&(s.get||s.set);i&&(r=_e(i,a));const c=e[n],l=wt.mixin(c||{},r||i||{});if(a)s.get&&(l.get=s.get),s.set&&(l.set=s.set);else if(s)s.initializer&&(l.default=function(t){let e;try{e=t()}catch(e){return t}return"object"!=typeof e||null===e?e:t}(s.initializer));else{const e=o.default||(o.default=function(t){let e;try{e=new t}catch(t){return{}}return e}(t));e.hasOwnProperty(n)&&(l.default=e[n])}e[n]=l}(t.constructor,r,e,i,n,s)}}return void 0===t?a_({type:void 0}):void 0===e?(i=t,s):void s(t,e,n)}const c_=(t,e,n)=>{return a_(((i={}).__noImplicit=!0,"serializable"in i||(i.serializable=!0),i))(t,e,n);var i},l_=(t,e,n)=>a_({editorOnly:!0})(t,e,n),h_=Zh,__=$h,u_=Zh,d_=$h,p_=$h,f_=$h,m_=Kh,g_=$h,v_=$h,y_=$h,x_=$h,S_=$h,T_=$h,E_=$h,A_=Kh,C_=$h,b_=Kh,P_=Kh,w_=O_(ee),D_=O_(ne),I_=O_(ie),R_=O_(se);function O_(t){return a_({type:t})}const M_=(t,e,n)=>a_({__noImplicit:!0,override:!0})(t,e,n);class N_{constructor(t){this._map=null,this._count=0,t?(this._map=t,this._count=Object.keys(t).length):(this._map=wt.createMap(!0),this._count=0)}add(t,e){return t in this._map||this._count++,this._map[t]=e}get(t){return this._map[t]}has(t){return t in this._map}remove(t){const e=this._map[t];return t in this._map&&(delete this._map[t],this._count--),e}clear(){0!==this._count&&(this._map=wt.createMap(!0),this._count=0)}forEach(t){for(const e in this._map)t(this._map[e],e)}find(t){for(const e in this._map)if(t(this._map[e],e))return this._map[e];return null}get count(){return this._count}destroy(){this._map=null}}class L_{constructor(t,e){this.id=L_._pipelineId++,this.name="",this.pipes=[],this.name=t;for(let t=0,n=e.length;t<n;t++)this.pipes.push(e[t])}insert(t,e){return e>this.pipes.length?(E(4921),this):(this.pipes.splice(e,0,t),this)}append(t){return this.pipes.push(t),this}remove(t){return this.pipes.splice(t,1),this}sync(t){const e=this.pipes;if(0===e.length)return null;t.isFinish=!1;for(let n=0,i=e.length;n<i;){const s=(0,e[n])(t);if(s)return t.isFinish=!0,s;n++,n!==i&&(t.input=t.output,t.output=null)}return t.isFinish=!0,t.output}async(t){0!==this.pipes.length&&(t.isFinish=!1,this._flow(0,t))}_flow(t,e){(0,this.pipes[t])(e,(n=>{n?(e.isFinish=!0,e.dispatch("complete",n)):++t<this.pipes.length?(e.input=e.output,e.output=null,this._flow(t,e)):(e.isFinish=!0,e.dispatch("complete",n,e.output))}))}}L_._pipelineId=0;const B_=new N_,F_=new N_,z_=new N_,U_=new N_,H_=new L_("normal load",[]),G_=new L_("fetch",[]),V_=new L_("transform url",[]);let j_;!function(t){t.UUID="uuid",t.PATH="path",t.DIR="dir",t.URL="url",t.SCENE="scene"}(j_||(j_={}));const W_={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};let k_;!function(t){t.RESOURCES="resources",t.MAIN="main",t.START_SCENE="start-scene"}(k_||(k_={}));class q_{static create(t){let e;return 0!==q_._deadPool.length?(e=q_._deadPool.pop(),e.set(t)):e=new q_(t),e}constructor(t){this.id=q_._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(t)}set(t=Object.create(null)){this.onComplete=t.onComplete||null,this.onProgress=t.onProgress||null,this.onError=t.onError||null,this.source=this.input=t.input,this.output=null,this.progress=t.progress,this.options=t.options||Object.create(null)}dispatch(t,e,n,i,s){switch(t){case"complete":this.onComplete&&this.onComplete(e,n);break;case"progress":this.onProgress&&this.onProgress(e,n,i,s);break;case"error":this.onError&&this.onError(e,n,i,s);break;default:{const o=`on${t[0].toUpperCase()}${t.substr(1)}`;"function"==typeof this[o]&&this[o](e,n,i,s);break}}}recycle(){q_._deadPool.length!==q_.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,q_._deadPool.push(this))}}q_.MAX_DEAD_NUM=500,q_._taskId=0,q_._deadPool=[];const X_="0123456789abcdef".split(""),Y_=["","","",""],K_=Y_.concat(Y_,"-",Y_,"-",Y_,"-",Y_,"-",Y_,Y_,Y_),$_=K_.map(((t,e)=>"-"===t?NaN:e)).filter(isFinite);function Z_(t){const e=t.split("@")[0];if(22!==e.length)return t;K_[0]=t[0],K_[1]=t[1];for(let e=2,n=2;e<22;e+=2){const i=zt[t.charCodeAt(e)],s=zt[t.charCodeAt(e+1)];K_[$_[n++]]=X_[i>>2],K_[$_[n++]]=X_[(3&i)<<2|s>>4],K_[$_[n++]]=X_[15&s]}return t.replace(e,K_.join(""))}const J_=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function Q_(t,e){(e=e||Object.create(null)).__isNative__=e.isNative,e.ext=e.nativeExt;const n=U_.find((e=>!!e.getAssetInfo(t)));return n&&(e.bundle=n.name),nu(t,e)}function tu(t){return t&&(t instanceof i.SceneAsset||t instanceof i.Scene)}function eu(t){return t&&(46===t.charCodeAt(0)&&47===t.charCodeAt(1)?t=t.slice(2):47===t.charCodeAt(0)&&(t=t.slice(1))),t}function nu(t,e){const n=q_.create({input:t,options:e}),i=[];try{const t=V_.sync(n);for(const e of t){const t=e.url;e.recycle(),i.push(t)}}catch(t){for(const t of n.output)t.recycle();p(t.message,t.stack)}return n.recycle(),i.length>1?i:i[0]}var iu,su,ou,ru,au=Object.freeze({__proto__:null,getUuidFromURL:function(t){const e=J_.exec(t);return e?e[1]:""},getUrlWithUuid:Q_,isScene:tu,normalize:eu,transform:nu,decodeUuid:Z_});class cu{constructor(t,e){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=t,this.bubbles=!!e}unuse(){this.type=cu.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=cu.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1}reuse(t,e){this.type=t,this.bubbles=e||!1}isStopped(){return this.propagationStopped||this.propagationImmediateStopped}getCurrentTarget(){return this.currentTarget}getType(){return this.type}}t("Event",cu),cu.NO_TYPE="no_type",cu.TOUCH="touch",cu.MOUSE="mouse",cu.KEYBOARD="keyboard",cu.ACCELERATION="acceleration",cu.NONE=0,cu.CAPTURING_PHASE=1,cu.AT_TARGET=2,cu.BUBBLING_PHASE=3,i.Event=cu;let lu=t("Asset",i_("cc.Asset")((ru=class extends(Gn(Rn)){static deserialize(t){return i.deserialize(t)}get nativeUrl(){if(!this._nativeUrl){if(!this._native)return"";const t=this._native;if(47===t.charCodeAt(0))return t.slice(1);46===t.charCodeAt(0)?this._nativeUrl=Q_(this._uuid,{nativeExt:t,isNative:!0}):this._nativeUrl=Q_(this._uuid,{__nativeName__:t,nativeExt:si(t),isNative:!0})}return this._nativeUrl}get _nativeAsset(){return this._file}set _nativeAsset(t){this._file=t}constructor(...t){super(...t),this.loaded=!0,Xh(this,"_native",ou,this),this._nativeUrl="",this.__onLoadedInvoked__=!1,this.__nativeDepend__=null,this.__depends__=null,this._file=null,this._ref=0,Object.defineProperty(this,"_uuid",{value:"",writable:!0})}toString(){return this.nativeUrl}serialize(){}_setRawAsset(t,e=!0){this._native=!1!==e?t||"":`/${t}`}get _nativeDep(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}get refCount(){return this._ref}addRef(){return this._ref++,this}decRef(t=!0){return this._ref>0&&this._ref--,t&&i.assetManager._releaseManager.tryRelease(this),this}onLoaded(){}initDefault(t){t&&(this._uuid=t),this.isDefault=!0}validate(){return!0}},ou=Yh((su=ru).prototype,"_native",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Yh(su.prototype,"_nativeAsset",[a_],Object.getOwnPropertyDescriptor(su.prototype,"_nativeAsset"),su.prototype),iu=su))||iu);lu.prototype.createNode=null,i.Asset=lu;let hu,_u,uu,du=1024;var pu,fu,mu,gu;function vu(t){return i.sys.capabilities.imageBitmap&&t instanceof ImageBitmap}!function(t){t[t.RGB565=Oo.R5G6B5]="RGB565",t[t.RGB5A1=Oo.RGB5A1]="RGB5A1",t[t.RGBA4444=Oo.RGBA4]="RGBA4444",t[t.RGB888=Oo.RGB8]="RGB888",t[t.RGB32F=Oo.RGB32F]="RGB32F",t[t.RGBA8888=Oo.RGBA8]="RGBA8888",t[t.RGBA32F=Oo.RGBA32F]="RGBA32F",t[t.A8=Oo.A8]="A8",t[t.I8=Oo.L8]="I8",t[t.AI8=Oo.LA8]="AI8",t[t.RGB_PVRTC_2BPPV1=Oo.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",t[t.RGBA_PVRTC_2BPPV1=Oo.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",t[t.RGB_A_PVRTC_2BPPV1=du++]="RGB_A_PVRTC_2BPPV1",t[t.RGB_PVRTC_4BPPV1=Oo.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",t[t.RGBA_PVRTC_4BPPV1=Oo.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",t[t.RGB_A_PVRTC_4BPPV1=du++]="RGB_A_PVRTC_4BPPV1",t[t.RGB_ETC1=Oo.ETC_RGB8]="RGB_ETC1",t[t.RGBA_ETC1=du++]="RGBA_ETC1",t[t.RGB_ETC2=Oo.ETC2_RGB8]="RGB_ETC2",t[t.RGBA_ETC2=Oo.ETC2_RGBA8]="RGBA_ETC2",t[t.RGBA_ASTC_4x4=Oo.ASTC_RGBA_4x4]="RGBA_ASTC_4x4",t[t.RGBA_ASTC_5x4=Oo.ASTC_RGBA_5x4]="RGBA_ASTC_5x4",t[t.RGBA_ASTC_5x5=Oo.ASTC_RGBA_5x5]="RGBA_ASTC_5x5",t[t.RGBA_ASTC_6x5=Oo.ASTC_RGBA_6x5]="RGBA_ASTC_6x5",t[t.RGBA_ASTC_6x6=Oo.ASTC_RGBA_6x6]="RGBA_ASTC_6x6",t[t.RGBA_ASTC_8x5=Oo.ASTC_RGBA_8x5]="RGBA_ASTC_8x5",t[t.RGBA_ASTC_8x6=Oo.ASTC_RGBA_8x6]="RGBA_ASTC_8x6",t[t.RGBA_ASTC_8x8=Oo.ASTC_RGBA_8x8]="RGBA_ASTC_8x8",t[t.RGBA_ASTC_10x5=Oo.ASTC_RGBA_10x5]="RGBA_ASTC_10x5",t[t.RGBA_ASTC_10x6=Oo.ASTC_RGBA_10x6]="RGBA_ASTC_10x6",t[t.RGBA_ASTC_10x8=Oo.ASTC_RGBA_10x8]="RGBA_ASTC_10x8",t[t.RGBA_ASTC_10x10=Oo.ASTC_RGBA_10x10]="RGBA_ASTC_10x10",t[t.RGBA_ASTC_12x10=Oo.ASTC_RGBA_12x10]="RGBA_ASTC_12x10",t[t.RGBA_ASTC_12x12=Oo.ASTC_RGBA_12x12]="RGBA_ASTC_12x12"}(hu||(hu={})),function(t){t[t.REPEAT=Wo.WRAP]="REPEAT",t[t.CLAMP_TO_EDGE=Wo.CLAMP]="CLAMP_TO_EDGE",t[t.MIRRORED_REPEAT=Wo.MIRROR]="MIRRORED_REPEAT",t[t.CLAMP_TO_BORDER=Wo.BORDER]="CLAMP_TO_BORDER"}(_u||(_u={})),function(t){t[t.NONE=jo.NONE]="NONE",t[t.LINEAR=jo.LINEAR]="LINEAR",t[t.NEAREST=jo.POINT]="NEAREST"}(uu||(uu={}));let yu,xu=t("ImageAsset",i_("cc.ImageAsset")((gu=mu=class t extends lu{get _nativeAsset(){return this._nativeData}set _nativeAsset(t){t instanceof HTMLElement||vu(t)||(t.format=t.format||this._format),this.reset(t)}get data(){return this._nativeData&&!0!==(t=this._nativeData)._compressed&&(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||vu(t))?this._nativeData:this._nativeData&&this._nativeData._data;var t}get width(){return this._nativeData.width||this._width}get height(){return this._nativeData.height||this._height}get format(){return this._format}get isCompressed(){return this._format>=hu.RGB_ETC1&&this._format<=hu.RGBA_ASTC_12x12||this._format>=hu.RGB_A_PVRTC_2BPPV1&&this._format<=hu.RGBA_ETC1}get url(){return this.nativeUrl}set _texture(t){this._tex=t}get _texture(){if(!this._tex){const t=new i.Texture2D;t.name=this.nativeUrl,t.image=this,this._tex=t}return this._tex}constructor(t){super(),this._nativeData=void 0,this._tex=void 0,this._exportedExts=void 0,this._format=hu.RGBA8888,this._width=0,this._height=0,this.loaded=!1,this._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==t&&this.reset(t)}reset(t){vu(t)?(this._nativeData=t,this._onDataComplete()):t instanceof HTMLElement?(this._nativeData=t,t.complete||t instanceof HTMLCanvasElement?this._onDataComplete():(this.loaded=!1,t.addEventListener("load",(()=>{this._onDataComplete()})),t.addEventListener("error",(t=>{E(3119,t.message)})))):(this._nativeData=t,this._format=t.format,this._onDataComplete())}destroy(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset(""),this.data.destroy()):vu(this.data)&&this.data.close&&this.data.close(),super.destroy()}_serialize(){}_deserialize(e){let n="";"string"==typeof e?n=e:(this._width=e.w,this._height=e.h,n=e.fmt);const s=i.director.root?i.director.root.device:null,o=n.split("_");let r="",a=Number.MAX_VALUE,c=this._format,l="";const h=i.macro.SUPPORT_TEXTURE_FORMATS;for(const e of o){const n=e.split("@"),o=parseInt(n[0],void 0),_=t.extnames[o]||n[0],u=h.indexOf(_);if(-1!==u&&u<a){const t=n[1]?parseInt(n[1]):this._format;if(!(".astc"!==_||s&&s.hasFeature(Ro.FORMAT_ASTC)))continue;if(!(".pvr"!==_||s&&s.hasFeature(Ro.FORMAT_PVRTC)))continue;if(!(t!==hu.RGB_ETC1&&t!==hu.RGBA_ETC1||s&&s.hasFeature(Ro.FORMAT_ETC1)))continue;if(!(t!==hu.RGB_ETC2&&t!==hu.RGBA_ETC2||s&&s.hasFeature(Ro.FORMAT_ETC2)))continue;if(".webp"===_&&!i.sys.capabilities.webp)continue;a=u,l=_,c=t}else r||(r=_)}l?(this._setRawAsset(l),this._format=c):r?(this._setRawAsset(r),E(3120,r,r)):E(3121)}_onDataComplete(){this.loaded=!0,this.emit("load")}initDefault(e){if(super.initDefault(e),t._sharedPlaceHolderCanvas)this.reset(t._sharedPlaceHolderCanvas);else{const e=document.createElement("canvas"),n=e.getContext("2d"),i=e.width=e.height=2;n.fillStyle="#ff00ff",n.fillRect(0,0,i,i),this.reset(e),t._sharedPlaceHolderCanvas=e}}validate(){return!!this.data}},mu.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],mu._sharedPlaceHolderCanvas=null,Yh((fu=gu).prototype,"_nativeAsset",[M_],Object.getOwnPropertyDescriptor(fu.prototype,"_nativeAsset"),fu.prototype),pu=fu))||pu);i.ImageAsset=xu,function(t){t[t.minFilter=0]="minFilter",t[t.magFilter=1]="magFilter",t[t.mipFilter=2]="mipFilter",t[t.addressU=3]="addressU",t[t.addressV=4]="addressV",t[t.addressW=5]="addressW",t[t.maxAnisotropy=6]="maxAnisotropy",t[t.cmpFunc=7]="cmpFunc",t[t.mipLODBias=8]="mipLODBias",t[t.total=9]="total"}(yu||(yu={}));const Su=[jo.LINEAR,jo.LINEAR,jo.NONE,Wo.WRAP,Wo.WRAP,Wo.WRAP,0,ko.NEVER,0],Tu=Cu(Su),Eu=new Ar,Au=new Mr;function Cu(t){let e=0,n=0;for(let i=0;i<Su.length;i++)switch(e=t[i]||Su[i],i){case yu.minFilter:n|=e;break;case yu.magFilter:n|=e<<2;break;case yu.mipFilter:n|=e<<4;break;case yu.addressU:n|=e<<6;break;case yu.addressV:n|=e<<8;break;case yu.addressW:n|=e<<10;break;case yu.maxAnisotropy:n|=e<<12;break;case yu.cmpFunc:n|=e<<16;break;case yu.mipLODBias:n|=e<<28}return n}const bu=new class{constructor(){this._cache={}}getSampler(t,e){e||(e=Tu);const n=this._cache[e];return n||(Au.minFilter=3&e,Au.magFilter=e>>2&3,Au.mipFilter=e>>4&3,Au.addressU=e>>6&3,Au.addressV=e>>8&3,Au.addressW=e>>10&3,Au.maxAnisotropy=e>>12&15,Au.cmpFunc=e>>16&15,Au.mipLODBias=e>>28&15,Au.borderColor=Eu,this._cache[e]=t.createSampler(Au))}};var Pu,wu,Du,Iu,Ru,Ou,Mu,Nu,Lu,Bu,Fu,zu;i.samplerLib=bu;const Uu=new V("Tex");let Hu=i_("cc.TextureBase")((zu=Fu=class extends lu{get isCompressed(){return this._format>=hu.RGB_ETC1&&this._format<=hu.RGBA_ASTC_12x12||this._format>=hu.RGB_A_PVRTC_2BPPV1&&this._format<=hu.RGBA_ETC1}get width(){return this._width}get height(){return this._height}constructor(){super(),Xh(this,"_format",Du,this),Xh(this,"_minFilter",Iu,this),Xh(this,"_magFilter",Ru,this),Xh(this,"_mipFilter",Ou,this),Xh(this,"_wrapS",Mu,this),Xh(this,"_wrapT",Nu,this),Xh(this,"_wrapR",Lu,this),Xh(this,"_anisotropy",Bu,this),this._width=1,this._height=1,this._id=void 0,this._samplerInfo=[],this._samplerHash=0,this._gfxSampler=null,this._gfxDevice=null,this._textureHash=0,this._id=Uu.getNewId(),this.loaded=!1,this._gfxDevice=this._getGFXDevice(),this._textureHash=Na(this._id,666)}getId(){return this._id}getPixelFormat(){return this._format}getAnisotropy(){return this._anisotropy}setWrapMode(t,e,n){this._wrapS=t,this._samplerInfo[yu.addressU]=t,this._wrapT=e,this._samplerInfo[yu.addressV]=e,void 0!==n&&(this._wrapR=n,this._samplerInfo[yu.addressW]=n),this._samplerHash=Cu(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=bu.getSampler(this._gfxDevice,this._samplerHash))}setFilters(t,e){this._minFilter=t,this._samplerInfo[yu.minFilter]=t,this._magFilter=e,this._samplerInfo[yu.magFilter]=e,this._samplerHash=Cu(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=bu.getSampler(this._gfxDevice,this._samplerHash))}setMipFilter(t){this._mipFilter=t,this._samplerInfo[yu.mipFilter]=t,this._samplerHash=Cu(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=bu.getSampler(this._gfxDevice,this._samplerHash))}setAnisotropy(t){this._anisotropy=t,this._samplerInfo[yu.maxAnisotropy]=t,this._samplerHash=Cu(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=bu.getSampler(this._gfxDevice,this._samplerHash))}destroy(){const t=super.destroy();return t&&i.director.root&&i.director.root.batcher2D&&i.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),t}getHash(){return this._textureHash}getGFXTexture(){return null}getSamplerHash(){return this._samplerHash}getGFXSampler(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=bu.getSampler(this._gfxDevice,this._samplerHash):C(9302)),this._gfxSampler}_serialize(t){return""}_deserialize(t,e){const n=t.split(",");n.unshift(""),n.length>=5&&(this.setFilters(parseInt(n[1]),parseInt(n[2])),this.setWrapMode(parseInt(n[3]),parseInt(n[4]))),n.length>=7&&(this.setMipFilter(parseInt(n[5])),this.setAnisotropy(parseInt(n[6])))}_getGFXDevice(){return i.director.root?i.director.root.device:null}_getGFXFormat(){return this._getGFXPixelFormat(this._format)}_setGFXFormat(t){this._format=void 0===t?hu.RGBA8888:t}_getGFXPixelFormat(t){return t===hu.RGBA_ETC1?t=hu.RGB_ETC1:t===hu.RGB_A_PVRTC_4BPPV1?t=hu.RGB_PVRTC_4BPPV1:t===hu.RGB_A_PVRTC_2BPPV1&&(t=hu.RGB_PVRTC_2BPPV1),t}},Fu.PixelFormat=hu,Fu.WrapMode=_u,Fu.Filter=uu,Du=Yh((wu=zu).prototype,"_format",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hu.RGBA8888}}),Iu=Yh(wu.prototype,"_minFilter",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uu.LINEAR}}),Ru=Yh(wu.prototype,"_magFilter",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uu.LINEAR}}),Ou=Yh(wu.prototype,"_mipFilter",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uu.NONE}}),Mu=Yh(wu.prototype,"_wrapS",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _u.REPEAT}}),Nu=Yh(wu.prototype,"_wrapT",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _u.REPEAT}}),Lu=Yh(wu.prototype,"_wrapR",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _u.REPEAT}}),Bu=Yh(wu.prototype,"_anisotropy",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Pu=wu))||Pu;i.TextureBase=Hu;const Gu=[qe,$e,tn,rn,An,yn,Sn,pn];function Vu(t,e){t.x=e[1],t.y=e[2],t.z=e[3],t.w=e[4]}const ju=[(t,e)=>{t.x=e[1],t.y=e[2]},(t,e)=>{t.x=e[1],t.y=e[2],t.z=e[3]},Vu,Vu,(t,e)=>{t._val=e[1]},(t,e)=>{t.width=e[1],t.height=e[2]},(t,e)=>{t.x=e[1],t.y=e[2],t.width=e[3],t.height=e[4]},(t,e)=>{pn.fromArray(t,e,1)}];class Wu{constructor(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}init(t){this.uuidObjList=t[8],this.uuidPropList=t[9],this.uuidList=t[10]}reset(){this.uuidList=null,this.uuidObjList=null,this.uuidPropList=null}push(t,e,n,i){this.uuidObjList.push(t),this.uuidPropList.push(e),this.uuidList.push(n),this.uuidTypeList.push(i||"")}}function ku(t,e){const n=t[4][e[0]],i=n[0],s=new(0,i[0]),o=i[1],r=i[2],a=n[n.length-1];let c=1;for(;c<a;++c)s[o[n[c]]]=e[c];for(;c<e.length;++c){const a=o[n[c]],l=i[n[c]+r];(0,Zu[l])(t,s,a,e[c])}return s}function qu(t,e,n){const i=new e;return i._deserialize?i._deserialize(n,t[0]):C(5303,tt(e)),i}function Xu(t,e,n,i){i>=0?e[n]=t[5][i]:t[7][3*~i]=e}function Yu(t){return(e,n,i,s)=>{n[i]=s;for(let n=0;n<s.length;++n)t(e,s,n,s[n])}}function Ku(t,e,n,i){e[n]=null,t[8][i]=e}function $u(t,e,n,i){e[n]=ku(t,i)}t("Details",Wu),Wu.pool=new bt((t=>{t.reset()}),5),Wu.pool.get=function(){return this._get()||new Wu};const Zu=new Array(13);function Ju(t,e){return t||nd.reportMissingClass(e),Object}function Qu(t,e,n,i,s,o){let r=t(e);if(!r){if(s)return void(n[i]=(a=n,c=i,l=e,function(){const e=t(l)||Ju(o,l);return a[c]=e,new e}));r=Ju(o,e)}var a,c,l;n[i]=r}function td(t,e,n){const i=n||Et,s=t[3];for(let t=0;t<s.length;++t){const o=s[t];"string"!=typeof o?Qu(i,o[0],o,0,e,n):Qu(i,o,s,t,e,n)}}function ed(t){const e=t[4];if(e){const n=t[3];for(let t=0;t<e.length;++t){const i=e[t];i[0]=n[i[0]]}}}function nd(t,e,n){"string"==typeof t&&(t=JSON.parse(t));const s=!e;let o;{(e=e||Wu.pool.get()).init(t),n=n||{};let s=t[0],c=!1;if("object"==typeof s&&(c=s.preprocessed,s=s.version),s<1)throw new Error(D(5304,s));n._version=s,n.result=e,t[0]=n,c||(td(t,!1,n.classFinder),ed(t)),i.game._isCloning=!0;const l=t[5],h=function(t){const e=t[5],n=t[6],i=0===n?0:n.length;let s=e[e.length-1],o=e.length-i;"number"!=typeof s?s=0:(s<0&&(s=~s),--o);let r=0;for(;r<o;++r)e[r]=ku(t,e[r]);const a=t[3];for(let s=0;s<i;++s,++r){let i=n[s];const o=e[r];if(i>=0){const n=a[i];e[r]=qu(t,n,o)}else i=~i,(0,Zu[i])(t,e,r,o)}return s}(t);i.game._isCloning=!1,t[7]&&function(t,e,n){const i=t.length-1;let s=0;const o=3*t[i];for(;s<o;s+=3){const i=t[s],o=e[t[s+2]],r=t[s+1];r>=0?i[n[r]]=o:i[~r]=o}for(;s<i;s+=3){const i=e[t[s]],o=e[t[s+2]],r=t[s+1];r>=0?i[n[r]]=o:i[~r]=o}}(t[7],l,t[2]),function(t){const e=t[5],n=t[2],i=t[1],s=t[8],o=t[9],r=t[10];for(let t=0;t<s.length;++t){const a=s[t];"number"==typeof a&&(s[t]=e[a]);let c=o[t];"number"==typeof c&&(c=c>=0?n[c]:~c,o[t]=c);const l=r[t];"number"==typeof l&&(r[t]=i[l])}}(t);for(let t=0;t<l.length;++t){var r,a;null===(r=l[t])||void 0===r||null===(a=r.onAfterDeserialize_JSB)||void 0===a||a.call(r)}o=l[h]}return s&&Wu.pool.put(e),o}Zu[0]=function(t,e,n,i){e[n]=i},Zu[1]=Xu,Zu[2]=Yu(Xu),Zu[3]=Yu(Ku),Zu[4]=$u,Zu[5]=function(t,e,n,i){ju[i[0]](e[n],i)},Zu[6]=Ku,Zu[7]=function(t,e,n,i){e[n].set(i)},Zu[8]=function(t,e,n,i){const s=new Gu[i[0]];ju[i[0]](s,i),e[n]=s},Zu[9]=Yu($u),Zu[10]=function(t,e,n,i){const s=t[3][i[0]];e[n]=qu(t,s,i[1])},Zu[11]=function(t,e,n,i){const s=i[0];e[n]=s;for(let e=1;e<i.length;e+=3){const n=i[e],o=i[e+1],r=i[e+2];(0,Zu[o])(t,s,n,r)}},Zu[12]=function(t,e,n,i){const s=i[0];e[n]=s;for(let e=0;e<s.length;++e){const n=s[e],o=i[e+1];0!==o&&(0,Zu[o])(t,s,e,n)}},nd.Details=Wu,nd.reportMissingClass=t=>{E(5302,t)};class id{constructor(t){this.preprocessed=!0,this.version=t}}function sd(t,e,n){return[1,0,0,[t],0,n?[e,-1]:[e],[0],0,[],[],[]]}var od,rd,ad;i.deserialize=nd;let cd=t("Script",i_("cc.Script")(od=class extends lu{})||od);i._Script=cd;let ld=t("JavaScript",i_("cc.JavaScript")(rd=class extends cd{})||rd);i._JavaScript=ld;let hd=t("TypeScript",i_("cc.TypeScript")(ad=class extends cd{})||ad);var _d,ud,dd,pd,fd,md,gd,vd,yd,xd,Sd;i._TypeScript=hd;const Td=new V("Comp"),Ed=Rn.Flags.IsOnLoadCalled;let Ad=t("Component",(_d=i_("cc.Component"),ud=v_(),dd=O_(cd),pd=y_(),_d((Sd=xd=class extends Rn{constructor(...t){super(...t),Xh(this,"node",gd,this),Xh(this,"_enabled",vd,this),Xh(this,"__prefab",yd,this),this._sceneGetter=null,this._id=Td.getNewId()}get name(){if(this._name)return this._name;let t=tt(this);const e=t.lastIndexOf(".");return e>=0&&(t=t.slice(e+1)),`${this.node.name}<${t}>`}set name(t){this._name=t}get uuid(){return this._id}get __scriptAsset(){return null}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&(this._enabled=t,this.node.activeInHierarchy)){const e=i.director._compScheduler;t?e.enableComp(this):e.disableComp(this)}}get enabledInHierarchy(){return this._enabled&&this.node&&this.node.activeInHierarchy}get _isOnLoadCalled(){return this._objFlags&Ed}_getRenderScene(){return this._sceneGetter?this._sceneGetter():this.node.scene._renderScene}addComponent(t){return this.node.addComponent(t)}getComponent(t){return this.node.getComponent(t)}getComponents(t){return this.node.getComponents(t)}getComponentInChildren(t){return this.node.getComponentInChildren(t)}getComponentsInChildren(t){return this.node.getComponentsInChildren(t)}destroy(){return!!super.destroy()&&(this._enabled&&this.node.activeInHierarchy&&i.director._compScheduler.disableComp(this),!0)}_onPreDestroy(){this.unscheduleAllCallbacks(),i.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)}_instantiate(t){return t||(t=i.instantiate._clone(this,this)),t&&(t.node=null),t}schedule(t,e=0,n=i.macro.REPEAT_FOREVER,s=0){P(t,1619),P((e=e||0)>=0,1620),n=Number.isNaN(n)?i.macro.REPEAT_FOREVER:n,s=s||0;const o=i.director.getScheduler(),r=o.isTargetPaused(this);o.schedule(t,this,e,n,s,r)}scheduleOnce(t,e=0){this.schedule(t,0,0,e)}unschedule(t){t&&i.director.getScheduler().unschedule(t,this)}unscheduleAllCallbacks(){i.director.getScheduler().unscheduleAllForTarget(this)}},xd.system=null,Yh((md=Sd).prototype,"__scriptAsset",[ud,dd,pd,P_],Object.getOwnPropertyDescriptor(md.prototype,"__scriptAsset"),md.prototype),gd=Yh(md.prototype,"node",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vd=Yh(md.prototype,"_enabled",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),yd=Yh(md.prototype,"__prefab",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fd=md))||fd));const Cd=Ad.prototype;var bd,Pd,wd;Cd.update=null,Cd.lateUpdate=null,Cd.__preload=null,Cd.onLoad=null,Cd.start=null,Cd.onEnable=null,Cd.onDisable=null,Cd.onDestroy=null,Cd.onFocusInEditor=null,Cd.onLostFocusInEditor=null,Cd.resetInEditor=null,Cd._getLocalBounds=null,Cd.onRestore=null,Ad._requireComponent=null,Ad._executionOrder=0,K(Ad,"_registerEditorProps",((t,e)=>{const n=e.requireComponent;n&&(t._requireComponent=n);const i=e.executionOrder;i&&"number"==typeof i&&(t._executionOrder=i)})),i.Component=Ad;let Dd=t("MissingScript",i_("cc.MissingScript")(bd=d_()((wd=Yh((Pd=class extends Ad{static safeFindClass(t){const e=Et(t);if(e)return e;i.deserialize.reportMissingClass(t)}constructor(){super(),Xh(this,"_$erialized",wd,this)}onLoad(){E(4600,this.node.name)}}).prototype,"_$erialized",[c_,l_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bd=Pd))||bd)||bd);function Id(t,e){let n;n=Dd.safeFindClass;const i=Wu.pool.get();let s;try{s=nd(t,i,{classFinder:n,customEnv:e})}catch(t){throw p(t),Wu.pool.put(i),t}s._uuid=e.__uuid__||"";const o=i.uuidList,r=i.uuidObjList,a=i.uuidPropList,c=i.uuidTypeList||[],l=[];for(let t=0;t<o.length;t++){const e=o[t];l[t]={uuid:Z_(e),owner:r[t],prop:a[t],type:wt._getClassById(c[t])}}return s.__depends__=l,s._native&&(s.__nativeDepend__=!0),Wu.pool.put(i),s}i._MissingScript=Dd;var Rd,Od=new class{constructor(){this._depends=new N_}init(){this._depends.clear()}getNativeDep(t){const e=this._depends.get(t);return e&&e.nativeDep?{...e.nativeDep}:null}getDeps(t){return this._depends.has(t)?this._depends.get(t).deps:[]}getDepsRecursively(t){const e=Object.create(null),n=[];return this._descend(t,e,n),n}remove(t){this._depends.remove(t)}parse(t,e){let n=null;if(Array.isArray(e)||e.__type__){if(this._depends.has(t))return this._depends.get(t);if(Array.isArray(e)&&!function(t){const e=t[5],n=e[e.length-1];return"number"==typeof n&&n<0}(e))n={deps:this._parseDepsFromJson(e)};else try{const i=Id(e,{__uuid__:t});n=this._parseDepsFromAsset(i),n.nativeDep&&(n.nativeDep.uuid=t),z_.add(`${t}@import`,i)}catch(e){F_.remove(`${t}@import`),n={deps:[]}}}else{if(this._depends.has(t)&&(n=this._depends.get(t),n.parsedFromExistAsset))return n;n=this._parseDepsFromAsset(e)}return this._depends.add(t,n),n}_parseDepsFromAsset(t){const e={deps:[],parsedFromExistAsset:!0},n=t.__depends__;for(let t=0,i=n.length;t<i;t++)e.deps.push(n[t].uuid);return t.__nativeDepend__&&(e.nativeDep=t._nativeDep),e}_parseDepsFromJson(t){let e=null;return e=function(t){const e=t[1];return t[10].map((t=>e[t]))}(t),e.forEach(((t,n)=>e[n]=Z_(t))),e}_descend(t,e,n){const i=this.getDeps(t);for(let t=0;t<i.length;t++){const s=i[t];e[s]||(e[s]=!0,n.push(s),this._descend(s,e,n))}}};const Md=[new Tr];function Nd(t){return t&&0==(t&t-1)}let Ld=i_("cc.SimpleTexture")(Rd=class extends Hu{constructor(...t){super(...t),this._gfxTexture=null,this._mipmapLevel=1,this._textureWidth=0,this._textureHeight=0}get mipmapLevel(){return this._mipmapLevel}getGFXTexture(){return this._gfxTexture}destroy(){return this._tryDestroyTexture(),super.destroy()}updateImage(){this.updateMipmaps(0)}updateMipmaps(t=0,e){}uploadData(t,e=0,n=0){if(!this._gfxTexture||this._mipmapLevel<=e)return;const i=this._getGFXDevice();if(!i)return;const s=Md[0];s.texExtent.width=this._textureWidth>>e,s.texExtent.height=this._textureHeight>>e,s.texSubres.mipLevel=e,s.texSubres.baseArrayLayer=n,ArrayBuffer.isView(t)?i.copyBuffersToTexture([t],this._gfxTexture,Md):i.copyTexImagesToTexture([t],this._gfxTexture,Md)}_assignImage(t,e,n){const s=()=>{const i=t.data;if(i&&(this.uploadData(i,e,n),this._checkTextureLoaded(),Lt.CLEANUP_IMAGE_CACHE)){const e=Od.getDeps(this._uuid),n=e.indexOf(t._uuid);-1!==n&&(z(e,n),t.decRef())}};if(t.loaded)s();else{if(t.once("load",(()=>{s()})),!this.isCompressed){const t=i.builtinResMgr.get("black-texture").image;this.uploadData(t.data,e,n)}i.assetManager.postLoadNative(t)}}_checkTextureLoaded(){this._textureReady()}_textureReady(){this.loaded=!0,this.emit("load")}_setMipmapLevel(t){this._mipmapLevel=t<1?1:t}_getGfxTextureCreateInfo(t){return null}_tryReset(){if(this._tryDestroyTexture(),0===this._mipmapLevel)return;const t=this._getGFXDevice();t&&this._createTexture(t)}_createTexture(t){if(0===this._width||0===this._height)return;let e=Go.NONE;this._mipFilter!==uu.NONE&&function(t,e,n){return!(t.gfxAPI===Do.WEBGL)||Nd(e)&&Nd(n)}(t,this._width,this._height)&&(this._mipmapLevel=function(t,e){let n=Math.max(t,e),i=0;for(;n;)n>>=1,i++;return i}(this._width,this._height),e=Go.GEN_MIPMAP);const n=this._getGfxTextureCreateInfo({usage:Ho.SAMPLED|Ho.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:e|Go.IMMUTABLE});if(!n)return;const i=t.createTexture(n);this._textureWidth=n.width,this._textureHeight=n.height,this._gfxTexture=i}_tryDestroyTexture(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)}})||Rd;var Bd,Fd,zd,Ud,Hd;i.SimpleTexture=Ld;let Gd=t("Texture2D",(Bd=i_("cc.Texture2D"),Fd=O_([xu]),Bd((Hd=Yh((Ud=class extends Ld{constructor(...t){super(...t),Xh(this,"_mipmaps",Hd,this)}get mipmaps(){return this._mipmaps}set mipmaps(t){if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){const t=this._mipmaps[0];this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach(((t,e)=>{this._assignImage(t,e)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}get image(){return 0===this._mipmaps.length?null:this._mipmaps[0]}set image(t){this.mipmaps=t?[t]:[]}initialize(){this.mipmaps=this._mipmaps}onLoaded(){this.initialize()}reset(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format),this._setMipmapLevel(t.mipmapLevel||1),this._tryReset()}create(t,e,n=hu.RGBA8888,i=1){this.reset({width:t,height:e,format:n,mipmapLevel:i})}toString(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""}updateMipmaps(t=0,e){if(t>=this._mipmaps.length)return;const n=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t);for(let e=0;e<n;++e){const n=t+e;this._assignImage(this._mipmaps[n],n)}}getHtmlElementObj(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null}destroy(){return this._mipmaps=[],super.destroy()}description(){return`<cc.Texture2D | Name = ${this._mipmaps[0]?this._mipmaps[0].url:""} | Dimension = ${this.width} x ${this.height}>`}releaseTexture(){this.destroy()}_serialize(t){return null}_deserialize(t,e){const n=t;super._deserialize(n.base,e),this._mipmaps=new Array(n.mipmaps.length);for(let t=0;t<n.mipmaps.length;++t){if(this._mipmaps[t]=new xu,!n.mipmaps[t])continue;const i=n.mipmaps[t];e.result.push(this._mipmaps,`${t}`,i,wt._getClassId(xu)),this._mipmaps[t]._texture=this}}_getGfxTextureCreateInfo(t){const e=new Rr(Uo.TEX2D);return e.width=this._width,e.height=this._height,Object.assign(e,t)}_checkTextureLoaded(){let t=!0;for(let e=0;e<this._mipmaps.length;++e)if(!this._mipmaps[e].loaded){t=!1;break}t&&super._textureReady()}initDefault(t){super.initDefault(t);const e=new xu;e.initDefault(),this.image=e}validate(){return this.mipmaps&&0!==this.mipmaps.length}}).prototype,"_mipmaps",[Fd],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zd=Ud))||zd));var Vd,jd,Wd,kd,qd,Xd;i.Texture2D=Gd,function(t){t[t.right=0]="right",t[t.left=1]="left",t[t.top=2]="top",t[t.bottom=3]="bottom",t[t.front=4]="front",t[t.back=5]="back"}(Xd||(Xd={}));let Yd=t("TextureCube",i_("cc.TextureCube")((qd=kd=class t extends Ld{constructor(...t){super(...t),Xh(this,"_mipmaps",Wd,this)}get mipmaps(){return this._mipmaps}set mipmaps(t){if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){const t=this._mipmaps[0].front;this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach(((t,e)=>{Kd(t,((t,n)=>{this._assignImage(t,e,n)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}get image(){return 0===this._mipmaps.length?null:this._mipmaps[0]}set image(t){this.mipmaps=t?[t]:[]}static fromTexture2DArray(e,n){const i=[],s=e.length/6;for(let t=0;t<s;t++){const n=6*t;i.push({front:e[n+Xd.front].image,back:e[n+Xd.back].image,left:e[n+Xd.left].image,right:e[n+Xd.right].image,top:e[n+Xd.top].image,bottom:e[n+Xd.bottom].image})}return(n=n||new t).mipmaps=i,n}onLoaded(){this.mipmaps=this._mipmaps,this.loaded=!0,this.emit("load")}reset(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format),this._setMipmapLevel(t.mipmapLevel||1),this._tryReset()}updateMipmaps(t=0,e){if(t>=this._mipmaps.length)return;const n=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t);for(let e=0;e<n;++e){const n=t+e;Kd(this._mipmaps[n],((t,e)=>{this._assignImage(t,n,e)}))}}destroy(){return this._mipmaps=[],super.destroy()}releaseTexture(){this.mipmaps=[]}_serialize(t){return null}_deserialize(t,e){const n=t;super._deserialize(n.base,e),this._mipmaps=new Array(n.mipmaps.length);for(let t=0;t<n.mipmaps.length;++t){this._mipmaps[t]={front:new xu,back:new xu,left:new xu,right:new xu,top:new xu,bottom:new xu};const i=n.mipmaps[t],s=wt._getClassId(xu);e.result.push(this._mipmaps[t],"front",i.front,s),e.result.push(this._mipmaps[t],"back",i.back,s),e.result.push(this._mipmaps[t],"left",i.left,s),e.result.push(this._mipmaps[t],"right",i.right,s),e.result.push(this._mipmaps[t],"top",i.top,s),e.result.push(this._mipmaps[t],"bottom",i.bottom,s)}}_getGfxTextureCreateInfo(t){const e=new Rr(Uo.CUBE);return e.width=this._width,e.height=this._height,e.layerCount=6,Object.assign(e,t),e}initDefault(t){super.initDefault(t);const e=new xu;e.initDefault(),this.mipmaps=[{front:e,back:e,top:e,bottom:e,left:e,right:e}]}validate(){return 0!==this._mipmaps.length&&!this._mipmaps.find((t=>!(t.top&&t.bottom&&t.front&&t.back&&t.left&&t.right)))}},kd.FaceIndex=Xd,Wd=Yh((jd=qd).prototype,"_mipmaps",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vd=jd))||Vd);function Kd(t,e){e(t.front,Xd.front),e(t.back,Xd.back),e(t.left,Xd.left),e(t.right,Xd.right),e(t.top,Xd.top),e(t.bottom,Xd.bottom)}i.TextureCube=Yd;const $d=t("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:456146524,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:50,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:1062464958,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[]},locals:{blocks:[],samplerTextures:[]}},defines:[],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0}]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:3946667351,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:46,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_dist",type:13,count:1,defines:[],stageFlags:1,format:11,location:2}]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:932177378,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],attributes:[{name:"a_position_starttime",type:16,count:1,defines:[],stageFlags:1,format:44,location:0},{name:"a_size_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_rotation_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:2},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_dir_life",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_rndSeed",type:13,count:1,defines:[],stageFlags:1,format:11,location:5},{name:"a_texCoord",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:8},{name:"a_color1",type:16,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:44,location:9}]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:293909391,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4}]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:3802928649,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_color1",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:8},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7}]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:2041444135,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:46,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2},{name:"a_color2",type:16,count:1,defines:["TWO_COLORED"],stageFlags:1,format:44,location:3}]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:1142786345,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:46,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"deferred",propertyIndex:0,blendState:{targets:[{blend:!1},{blend:!1},{blend:!1},{blend:!1}]},program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:632993342,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:216,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]}]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:16,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:44,location:13},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:14}]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:1518991842,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:179,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:22},globals:{blocks:[{name:"CCShadow",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:13}]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"deferred",propertyIndex:0,blendState:{targets:[{blend:!1},{blend:!1},{blend:!1},{blend:!1}]},program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:2532494361,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:64,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:55},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]}]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD"]}],samplerTextures:[{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2}]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:3874167763,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:62,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2}]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:3579616855,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:195,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:16,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:44,location:13}]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:4181944545,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:37,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:53},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_gbuffer_albedoMap",defines:[]},{name:"cc_gbuffer_positionMap",defines:[]},{name:"cc_gbuffer_normalMap",defines:[]},{name:"cc_gbuffer_emissiveMap",defines:[]}]},locals:{blocks:[{name:"CCForwardLight",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"USE_LIGHTMAP",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_USE_FOG",type:"number",range:[0,4]}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:3940098901,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:210,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:53},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12}]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:2054814724,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:145,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:37},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_lighting_resultMap",defines:[]}]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7}]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:553035852,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:37,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:37},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}]},locals:{blocks:[],samplerTextures:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3}]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:3108604430,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:58,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:37},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[],samplerTextures:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1}]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},precent:{value:[.5],type:13,handleInfo:["u_buffer0",2,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,.5,0]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:624029864,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[]},locals:{blocks:[],samplerTextures:[]}},defines:[],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:14,count:1,defines:[],stageFlags:1,format:21,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1}]}]}]),Zd=4026531840,Jd=264241152,Qd=3145728,tp=1032192;let ep;!function(t){t[t.BUFFER=0]="BUFFER",t[t.TEXTURE=1]="TEXTURE"}(ep||(ep={}));const np=(t,e,n,i,s=0)=>t<<28&Zd|i<<22&Jd|e<<20&Qd|n<<14&tp|16383&s,ip=t=>(t&Zd)>>>28,sp=t=>(t&Jd)>>>22,op=t=>(t&tp)>>>14,rp=t=>16383&t,ap=(t,e)=>t&~Jd|e<<22&Jd,cp={[No.UNKNOWN]:()=>console.warn("illegal uniform handle"),[No.INT]:(t,e,n=0)=>t[n],[No.INT2]:(t,e,n=0)=>qe.fromArray(e,t,n),[No.INT3]:(t,e,n=0)=>$e.fromArray(e,t,n),[No.INT4]:(t,e,n=0)=>tn.fromArray(e,t,n),[No.FLOAT]:(t,e,n=0)=>t[n],[No.FLOAT2]:(t,e,n=0)=>qe.fromArray(e,t,n),[No.FLOAT3]:(t,e,n=0)=>$e.fromArray(e,t,n),[No.FLOAT4]:(t,e,n=0)=>tn.fromArray(e,t,n),[No.MAT3]:(t,e,n=0)=>nn.fromArray(e,t,n),[No.MAT4]:(t,e,n=0)=>pn.fromArray(e,t,n)},lp={[No.UNKNOWN]:()=>console.warn("illegal uniform handle"),[No.INT]:(t,e,n=0)=>t[n]=e,[No.INT2]:(t,e,n=0)=>qe.toArray(t,e,n),[No.INT3]:(t,e,n=0)=>$e.toArray(t,e,n),[No.INT4]:(t,e,n=0)=>tn.toArray(t,e,n),[No.FLOAT]:(t,e,n=0)=>t[n]=e,[No.FLOAT2]:(t,e,n=0)=>qe.toArray(t,e,n),[No.FLOAT3]:(t,e,n=0)=>$e.toArray(t,e,n),[No.FLOAT4]:(t,e,n=0)=>tn.toArray(t,e,n),[No.MAT3]:(t,e,n=0)=>nn.toArray(t,e,n),[No.MAT4]:(t,e,n=0)=>pn.toArray(t,e,n)},hp=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function _p(t){switch(t){case No.BOOL:case No.INT:case No.UINT:case No.FLOAT:return hp[0];case No.BOOL2:case No.INT2:case No.UINT2:case No.FLOAT2:return hp[1];case No.BOOL4:case No.INT4:case No.UINT4:case No.FLOAT4:return hp[2];case No.MAT4:return hp[3];case No.SAMPLER2D:return"default-texture";case No.SAMPLER_CUBE:return"default-cube-texture"}return hp[0]}function up(t,e){const n=Object.entries(e);let i=!1;for(let e=0;e<n.length;e++)t[n[e][0]]!==n[e][1]&&(t[n[e][0]]=n[e][1],i=!0);return i}const dp=new ta;function pp(t){return Math.ceil(Math.log2(Math.max(t,2)))}function fp(t,e){switch(t.type){case"boolean":return"number"==typeof e?e.toString():e?"1":"0";case"string":return void 0!==e?e:t.options[0];case"number":return void 0!==e?e.toString():t.range[0].toString();default:return console.warn(`unknown define type '${t.type}'`),"-1"}}function mp(t,e,n,i,s){const o=t.builtins[i],r=[];for(let t=0;t<o.blocks.length;t++){const e=o.blocks[t],i=n.layouts[e.name],a=i&&n.bindings.find((t=>t.binding===i.binding));i&&a&&a.descriptorType&_a?(r.push(i),s&&!s.includes(a)&&s.push(a)):console.warn(`builtin UBO '${e.name}' not available!`)}Array.prototype.unshift.apply(e.gfxBlocks,r);const a=[];for(let t=0;t<o.samplerTextures.length;t++){const e=o.samplerTextures[t],i=n.layouts[e.name],r=i&&n.bindings.find((t=>t.binding===i.binding));i&&r&&r.descriptorType&ua?(a.push(i),s&&!s.includes(r)&&s.push(r)):console.warn(`builtin samplerTexture '${e.name}' not available!`)}Array.prototype.unshift.apply(e.gfxSamplerTextures,a),s&&s.sort(((t,e)=>t.binding-e.binding))}function gp(t){return t.members.reduce(((t,e)=>t+va(e.type)*e.count),0)}function vp(t,e){for(let n=0;n<t.length;n++){const i=t[n];if("!"===i[0]){if(e[i.slice(1)])return!1}else if(!e[i])return!1}return!0}function yp(t){switch(t.gfxAPI){case Do.GLES2:case Do.WEBGL:return"glsl1";case Do.GLES3:case Do.WEBGL2:return"glsl3";default:return"glsl4"}}const xp=new class{constructor(){this._templates={},this._cache={},this._templateInfos={}}register(t){for(let e=0;e<t.shaders.length;e++)this.define(t.shaders[e]).effectName=t.name}define(t){const e=this._templates[t.name];if(e&&e.hash===t.hash)return e;const n={...t};let i=0;for(let t=0;t<n.defines.length;t++){const e=n.defines[t];let s=1;if("number"===e.type){const t=e.range;s=pp(t[1]-t[0]+1),e._map=e=>e-t[0]}else"string"===e.type?(s=pp(e.options.length),e._map=t=>Math.max(0,e.options.findIndex((e=>e===t)))):"boolean"===e.type&&(e._map=t=>t?1:0);e._offset=i,i+=s}i>31&&(n.uber=!0),n.constantMacros="";for(const t in n.builtins.statistics)n.constantMacros+=`#define ${t} ${n.builtins.statistics[t]}\n`;if(this._templates[t.name]=n,!this._templateInfos[n.hash]){const t={};t.samplerStartBinding=n.blocks.length,t.gfxBlocks=[],t.gfxSamplerTextures=[],t.bindings=[],t.blockSizes=[];for(let e=0;e<n.blocks.length;e++){const i=n.blocks[e];t.blockSizes.push(gp(i)),t.bindings.push(new Qr(i.binding,i.descriptorType||cr.UNIFORM_BUFFER,1,i.stageFlags)),t.gfxBlocks.push(new Lr(Al.MATERIAL,i.binding,i.name,i.members.map((t=>new Nr(t.name,t.type,t.count))),1))}for(let e=0;e<n.samplerTextures.length;e++){const i=n.samplerTextures[e];t.bindings.push(new Qr(i.binding,i.descriptorType||cr.SAMPLER_TEXTURE,i.count,i.stageFlags)),t.gfxSamplerTextures.push(new Br(Al.MATERIAL,i.binding,i.name,i.type,i.count))}t.gfxAttributes=[];for(let e=0;e<n.attributes.length;e++){const i=n.attributes[e];t.gfxAttributes.push(new qa(i.name,i.format,i.isNormalized,0,i.isInstanced,i.location))}mp(n,t,gl,"locals"),t.gfxStages=[],t.gfxStages.push(new Vr($o.VERTEX,"")),t.gfxStages.push(new Vr($o.FRAGMENT,"")),t.handleMap=function(t){const e={};for(let n=0;n<t.blocks.length;n++){const i=t.blocks[n],s=i.members;let o=0;for(let t=0;t<s.length;t++){const n=s[t];e[n.name]=np(ep.BUFFER,Al.MATERIAL,i.binding,n.type,o),o+=(va(n.type)>>2)*n.count}}for(let n=0;n<t.samplerTextures.length;n++){const i=t.samplerTextures[n];e[i.name]=np(ep.TEXTURE,Al.MATERIAL,i.binding,i.type)}return e}(n),t.hPipelineLayout=0,t.setLayouts=[],this._templateInfos[n.hash]=t}return n}getTemplate(t){return this._templates[t]}getTemplateInfo(t){const e=this._templates[t].hash;return this._templateInfos[e]}getDescriptorSetLayout(t,e,n=!1){const i=this._templates[e],s=this._templateInfos[i.hash];return s.setLayouts.length||(dp.bindings=s.bindings,s.setLayouts[Al.MATERIAL]=t.createDescriptorSetLayout(dp),dp.bindings=gl.bindings,s.setLayouts[Al.LOCAL]=t.createDescriptorSetLayout(dp)),s.setLayouts[n?Al.LOCAL:Al.MATERIAL]}hasProgram(t){return void 0!==this._templates[t]}getKey(t,e){const n=this._templates[t],i=n.defines;if(n.uber){let t="";for(let n=0;n<i.length;n++){const s=i[n],o=e[s.name];if(!o||!s._map)continue;const r=s._map(o);t+=`${s._offset}${r}|`}return`${t}${n.hash}`}let s=0;for(let t=0;t<i.length;t++){const n=i[t],o=e[n.name];o&&n._map&&(s|=n._map(o)<<n._offset)}return`${s.toString(16)}|${n.hash}`}destroyShaderByDefines(t){const e=Object.keys(t);if(!e.length)return;const n=e.map((e=>{let n=t[e];return"boolean"==typeof n&&(n=n?"1":"0"),new RegExp(`${e}${n}`)})),i=Object.keys(this._cache).filter((t=>n.every((e=>e.test(bi.get(this._cache[t]).name)))));for(let t=0;t<i.length;t++){const e=i[t],n=bi.get(this._cache[e]);console.log(`destroyed shader ${n.name}`),n.destroy(),delete this._cache[e]}}getGFXShader(t,e,n,i,s){Object.assign(n,i.macros),s||(s=this.getKey(e,n));const o=this._cache[s];if(o)return o;const r=this._templates[e],a=this._templateInfos[r.hash];a.hPipelineLayout||(this.getDescriptorSetLayout(t,e),mp(r,a,ml,"globals"),a.setLayouts[Al.GLOBAL]=i.descriptorSetLayout,a.hPipelineLayout=Di.alloc(t,new na(a.setLayouts)));const c=function(t,e){const n=[];for(let i=0;i<e.length;i++){const s=e[i],o=s.name,r=t[o],a=fp(s,r),c=!r||"0"===r;n.push({name:o,value:a,isDefault:c})}return n}(n,r.defines),l=i.constantMacros+r.constantMacros+c.reduce(((t,e)=>`${t}#define ${e.name} ${e.value}\n`),"");let h=r.glsl3;const _=yp(t);_?h=r[_]:console.error("Invalid GFX API!"),a.gfxStages[0].source=l+h.vert,a.gfxStages[1].source=l+h.frag;const u=function(t,e,n){const i=[],s=t.attributes,o=e.gfxAttributes;for(let t=0;t<s.length;t++)vp(s[t].defines,n)&&i.push(o[t]);return i}(r,a,n),d=function(t,e){return t+e.reduce(((t,e)=>e.isDefault?t:`${t}|${e.name}${e.value}`),"")}(e,c),p=new Wr(d,a.gfxStages,u,a.gfxBlocks);return p.samplerTextures=a.gfxSamplerTextures,this._cache[s]=bi.alloc(t,p)}};i.programLib=xp;const Sp={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\nrotateCorner(viewSpaceVert, q.z);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\nseed = mod(seed, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 rotation = a_rotation_uv.xyz;\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nrotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nrotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = rotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., rotation.z);\n#endif\ncomputeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\nmat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\nrotateCorner(viewSpaceVert, q.z);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\ncomputeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_texCoord.x\n#endif\n);\ncolor = a_color;\n#else\nmat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\nmat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying float v_fog_factor;\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(pos);\n#else\nv_fog_factor = 1.0;\n#endif\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nvarying float v_fog_factor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nuniform lowp vec4 cc_shadowColor;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\n#if USE_VERTEX_COLOR\nvarying vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor *= v_color;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * pbrParams.w) * normalize(v_tangent) +\n(nmmp.y * pbrParams.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\ns.position = v_position;\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = clamp(pbr.x, 0.0, 0.96);\ns.roughness = clamp(pbr.y, 0.04, 1.0);\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 0\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(s.position, s.roughness);\ngl_FragData[2] = vec4(s.normal, s.metallic);\ngl_FragData[3] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\nret = fract(ret);\nret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\nreturn ret;\n}\nuniform highp mat4 cc_matLightView;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nvec4 viewStartPos = cc_matLightView * v_worldPos;\nfloat dist = length(viewStartPos.xyz);\nfloat linearDepth = cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\nreturn vec4(linearDepth, 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying float v_fog_factor;\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(vec4(worldPos, 1.0));\n#else\nv_fog_factor = 1.0;\n#endif\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nuniform lowp vec4 cc_shadowColor;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nvarying float v_fog_factor;\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\ns.position = v_position;\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 0\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(s.position, s.roughness);\ngl_FragData[2] = vec4(s.normal, s.metallic);\ngl_FragData[3] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\nret = fract(ret);\nret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying float v_fog_factor;\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(matWorld * position);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(matWorld * position);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(matWorld * position);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(matWorld * position);\n#else\nv_fog_factor = 1.0;\n#endif\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_fogColor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying float v_fog_factor;\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no *= v_color;\n#endif\n#if USE_TEXTURE\no *= texture2D(mainTexture, v_uv);\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\no = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, v_fog_factor), o.a);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nuniform lowp vec4 cc_shadowColor;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying vec2 v_uv;\nuniform sampler2D cc_gbuffer_albedoMap;\nuniform sampler2D cc_gbuffer_positionMap;\nuniform sampler2D cc_gbuffer_normalMap;\nuniform sampler2D cc_gbuffer_emissiveMap;\nvoid main () {\nStandardSurface s;\nvec4 albedoMap = texture2D(cc_gbuffer_albedoMap,v_uv);\nvec4 positionMap = texture2D(cc_gbuffer_positionMap,v_uv);\nvec4 normalMap = texture2D(cc_gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(cc_gbuffer_emissiveMap,v_uv);\ns.albedo = albedoMap;\ns.position = positionMap.xyz;\ns.roughness = positionMap.w;\ns.normal = normalMap.xyz;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\n#if CC_USE_FOG == 0\nfogFactor = LinearFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 1\nfogFactor = ExpFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 2\nfogFactor = ExpSquaredFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 3\nfogFactor = LayeredFog(vec4(s.position, 1));\n#else\nfogFactor = 1.0;\n#endif\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(s.position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\nCCStandardShadingAdditive(s, shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, fogFactor), color.a);\ngl_FragColor = CCFragOutput(color);\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform highp mat4 cc_matLightPlaneProj;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nposition = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\nposition.z -= 0.0001;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvec4 frag () {\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\nvarying vec2 v_uv;\nuniform sampler2D cc_lighting_resultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(cc_lighting_resultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nmat4 matProj = cc_matProj;\nif (matProj[3].w > 0.0) {\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\n}\nvec4 pos = matProj * matViewRotOnly * viewDir;\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nvec4 position = cc_matViewProj * vec4(a_position, 1.0);\nposition.xy += offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvarying float v_percent;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nv_percent = u_buffer0.z;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nvarying float v_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat precent = clamp(v_percent, 0.0, 1.0);\ncolor.xyz *= precent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\nrotateCorner(viewSpaceVert, q.z);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\nseed = mod(seed, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 rotation = a_rotation_uv.xyz;\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nrotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nrotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = rotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., rotation.z);\n#endif\ncomputeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\nmat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\nrotateCorner(viewSpaceVert, q.z);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\ncomputeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_texCoord.x\n#endif\n);\ncolor = a_color;\n#else\nmat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\nmat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if SAMPLE_FROM_RT\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nout float v_fog_factor;\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout vec4 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\n#if USE_NORMAL_MAP\nout vec3 v_tangent;\nout vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(pos);\n#else\nv_fog_factor = 1.0;\n#endif\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nin float v_fog_factor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\n#if USE_VERTEX_COLOR\nin vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin vec3 v_tangent;\nin vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor *= v_color;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * pbrParams.w) * normalize(v_tangent) +\n(nmmp.y * pbrParams.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\ns.position = v_position;\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = clamp(pbr.x, 0.0, 0.96);\ns.roughness = clamp(pbr.y, 0.04, 1.0);\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 0\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\nret = fract(ret);\nret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\nreturn ret;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nvec4 viewStartPos = cc_matLightView * v_worldPos;\nfloat dist = length(viewStartPos.xyz);\nfloat linearDepth = cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\nreturn vec4(linearDepth, 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nout float v_fog_factor;\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout highp vec3 v_position;\nout mediump vec3 v_normal;\n#if USE_NORMALMAP\nout mediump vec3 v_tangent;\nout mediump vec3 v_binormal;\n#endif\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(vec4(worldPos, 1.0));\n#else\nv_fog_factor = 1.0;\n#endif\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nin float v_fog_factor;\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if USE_NORMALMAP\nin mediump vec3 v_tangent;\nin mediump vec3 v_binormal;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\ns.position = v_position;\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 0\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\nret = fract(ret);\nret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nout float v_fog_factor;\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(matWorld * position);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(matWorld * position);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(matWorld * position);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(matWorld * position);\n#else\nv_fog_factor = 1.0;\n#endif\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin float v_fog_factor;\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no *= v_color;\n#endif\n#if USE_TEXTURE\no *= texture(mainTexture, v_uv);\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\no = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, v_fog_factor), o.a);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nin vec2 v_uv;\nuniform sampler2D cc_gbuffer_albedoMap;\nuniform sampler2D cc_gbuffer_positionMap;\nuniform sampler2D cc_gbuffer_normalMap;\nuniform sampler2D cc_gbuffer_emissiveMap;\nlayout(location = 0) out vec4 fragColor;\nvoid main () {\nStandardSurface s;\nvec4 albedoMap = texture(cc_gbuffer_albedoMap,v_uv);\nvec4 positionMap = texture(cc_gbuffer_positionMap,v_uv);\nvec4 normalMap = texture(cc_gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(cc_gbuffer_emissiveMap,v_uv);\ns.albedo = albedoMap;\ns.position = positionMap.xyz;\ns.roughness = positionMap.w;\ns.normal = normalMap.xyz;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\n#if CC_USE_FOG == 0\nfogFactor = LinearFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 1\nfogFactor = ExpFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 2\nfogFactor = ExpSquaredFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 3\nfogFactor = LayeredFog(vec4(s.position, 1));\n#else\nfogFactor = 1.0;\n#endif\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(s.position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\nCCStandardShadingAdditive(s, shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, fogFactor), color.a);\nfragColor = CCFragOutput(color);\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nposition = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\nposition.z -= 0.0001;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvec4 frag () {\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nin vec2 v_uv;\nuniform sampler2D cc_lighting_resultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(cc_lighting_resultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nmat4 matProj = cc_matProj;\nif (matProj[3].w > 0.0) {\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\n}\nvec4 pos = matProj * matViewRotOnly * viewDir;\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nvec4 position = cc_matViewProj * vec4(a_position, 1.0);\nposition.xy += offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nout float v_percent;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nv_percent = u_buffer0.z;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nin float v_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat precent = clamp(v_percent, 0.0, 1.0);\ncolor.xyz *= precent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]],glsl4:[[{vert:"\nprecision mediump float;\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(set = 1, binding = 1) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 3) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 2) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(location = 0) in vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec4 v_color;\nlayout(location = 2) in float a_dist;\nlayout(location = 1) out float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(location = 0) in vec4 v_color;\nlayout(location = 1) in float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\nrotateCorner(viewSpaceVert, q.z);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(set = 1, binding = 1) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(set = 1, binding = 2) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nlayout(location = 0) in vec4 a_position_starttime;\nlayout(location = 1) in vec4 a_size_uv;\nlayout(location = 2) in vec4 a_rotation_uv;\nlayout(location = 3) in vec4 a_color;\nlayout(location = 4) in vec4 a_dir_life;\nlayout(location = 5) in float a_rndSeed;\n#if CC_RENDER_MODE == 4\nlayout(location = 6) in vec3 a_texCoord;\nlayout(location = 7) in vec3 a_texCoord3;\nlayout(location = 8) in vec3 a_normal;\nlayout(location = 9) in vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\nseed = mod(seed, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 10) uniform sampler2D color_over_time_tex0;\nlayout(set = 1, binding = 3) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 11) uniform sampler2D rotation_over_time_tex0;\nlayout(set = 1, binding = 4) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 12) uniform sampler2D size_over_time_tex0;\nlayout(set = 1, binding = 5) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 13) uniform sampler2D force_over_time_tex0;\nlayout(set = 1, binding = 6) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 14) uniform sampler2D velocity_over_time_tex0;\nlayout(set = 1, binding = 7) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nlayout(set = 1, binding = 15) uniform sampler2D texture_animation_tex0;\nlayout(set = 1, binding = 8) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 rotation = a_rotation_uv.xyz;\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nrotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nrotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = rotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., rotation.z);\n#endif\ncomputeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\nmat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 16) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 9) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_texCoord;\nlayout(location = 2) in vec3 a_texCoord1;\nlayout(location = 3) in vec3 a_texCoord2;\nlayout(location = 4) in vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nlayout(location = 2) out vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\n#if CC_DRAW_WIRE_FRAME\nlayout(location = 2) in vec3 vBarycentric;\n#endif\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 1) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\nrotateCorner(viewSpaceVert, q.z);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_texCoord;\nlayout(location = 2) in vec3 a_texCoord1;\nlayout(location = 3) in vec3 a_texCoord2;\nlayout(location = 4) in vec4 a_color;\n#if CC_RENDER_MODE == 1\nlayout(location = 8) in vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nlayout(location = 6) in vec3 a_texCoord3;\nlayout(location = 7) in vec3 a_normal;\nlayout(location = 8) in vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\ncomputeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_texCoord.x\n#endif\n);\ncolor = a_color;\n#else\nmat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\nmat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 1) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(location = 0) out vec4 v_light;\nlayout(location = 1) out vec2 uv0;\n#if TWO_COLORED\nlayout(location = 3) in vec4 a_color2;\nlayout(location = 2) out vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(set = 1, binding = 0) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nlayout(location = 0) in vec4 v_light;\n#if TWO_COLORED\nlayout(location = 2) in vec4 v_dark;\n#endif\nlayout(location = 1) in vec2 uv0;\nlayout(set = 2, binding = 10) uniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if SAMPLE_FROM_RT\n#endif\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(location = 0) out vec4 color;\nlayout(location = 1) out vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(set = 1, binding = 0) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nlayout(location = 0) in vec4 color;\n#if USE_TEXTURE\nlayout(location = 1) in vec2 uv0;\nlayout(set = 2, binding = 10) uniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nlayout(location = 7) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nlayout(location = 8) in vec4 a_matWorld0;\nlayout(location = 9) in vec4 a_matWorld1;\nlayout(location = 10) in vec4 a_matWorld2;\n#if USE_LIGHTMAP\nlayout(location = 11) in vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\nlayout(set = 2, binding = 0) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nlayout(location = 0) out float v_fog_factor;\nlayout(location = 1) out highp vec4 v_shadowPos;\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nlayout(location = 13) in vec4 a_color;\nlayout(location = 2) out vec4 v_color;\n#endif\nlayout(location = 3) out vec3 v_position;\nlayout(location = 4) out vec3 v_normal;\nlayout(location = 5) out vec2 v_uv;\nlayout(location = 6) out vec2 v_uv1;\n#if USE_NORMAL_MAP\nlayout(location = 7) out vec3 v_tangent;\nlayout(location = 8) out vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nlayout(location = 14) in vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nlayout(location = 9) out vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(pos);\n#else\nv_fog_factor = 1.0;\n#endif\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(location = 0) in float v_fog_factor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nlayout(set = 0, binding = 4) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nlayout(location = 1) in highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nlayout(location = 9) in vec3 v_luv;\nlayout(set = 2, binding = 9) uniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nlayout(location = 3) in vec3 v_position;\nlayout(location = 5) in vec2 v_uv;\nlayout(location = 6) in vec2 v_uv1;\nlayout(location = 4) in vec3 v_normal;\n#if USE_VERTEX_COLOR\nlayout(location = 2) in vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nlayout(set = 1, binding = 1) uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nlayout(location = 7) in vec3 v_tangent;\nlayout(location = 8) in vec3 v_bitangent;\nlayout(set = 1, binding = 2) uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nlayout(set = 1, binding = 3) uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nlayout(set = 1, binding = 4) uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nlayout(set = 1, binding = 5) uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nlayout(set = 1, binding = 6) uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor *= v_color;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * pbrParams.w) * normalize(v_tangent) +\n(nmmp.y * pbrParams.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\ns.position = v_position;\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = clamp(pbr.x, 0.0, 0.96);\ns.roughness = clamp(pbr.y, 0.04, 1.0);\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(set = 2, binding = 1) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 0\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nlayout(location = 7) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nlayout(location = 8) in vec4 a_matWorld0;\nlayout(location = 9) in vec4 a_matWorld1;\nlayout(location = 10) in vec4 a_matWorld2;\n#if USE_LIGHTMAP\nlayout(location = 11) in vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\nlayout(set = 2, binding = 0) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\nlayout(location = 13) in vec2 a_texCoord1;\n#endif\nlayout(location = 0) out vec2 v_uv;\nlayout(location = 1) out vec2 v_uv1;\nlayout(location = 2) out vec4 v_worldPos;\nlayout(location = 3) out float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\nret = fract(ret);\nret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\nreturn ret;\n}\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nlayout(location = 0) in vec2 v_uv;\nlayout(location = 1) in vec2 v_uv1;\nlayout(location = 2) in vec4 v_worldPos;\nlayout(location = 3) in float v_clip_depth;\n#if USE_ALBEDO_MAP\nlayout(set = 1, binding = 1) uniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nvec4 viewStartPos = cc_matLightView * v_worldPos;\nfloat dist = length(viewStartPos.xyz);\nfloat linearDepth = cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\nreturn vec4(linearDepth, 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nlayout(location = 0) out float v_fog_factor;\nlayout(location = 1) out highp vec4 v_shadowPos;\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform sampler2D cc_spotLightingMap;\n#endif\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 2) out highp vec3 v_position;\nlayout(location = 3) out mediump vec3 v_normal;\n#if USE_NORMALMAP\nlayout(location = 4) out mediump vec3 v_tangent;\nlayout(location = 5) out mediump vec3 v_binormal;\n#endif\nlayout(location = 6) out mediump vec2 uvw;\nlayout(location = 7) out mediump vec2 uv0;\nlayout(location = 8) out mediump vec2 uv1;\nlayout(location = 9) out mediump vec2 uv2;\nlayout(location = 10) out mediump vec2 uv3;\nlayout(location = 11) out mediump vec3 luv;\nlayout(location = 12) out mediump vec3 diffuse;\nlayout(set = 1, binding = 0) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(vec4(worldPos, 1.0));\n#else\nv_fog_factor = 1.0;\n#endif\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nlayout(set = 0, binding = 4) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nlayout(location = 0) in float v_fog_factor;\nlayout(location = 1) in highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nlayout(location = 13) in vec3 v_luv;\nlayout(set = 2, binding = 9) uniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nlayout(location = 2) in highp vec3 v_position;\nlayout(location = 3) in mediump vec3 v_normal;\n#if USE_NORMALMAP\nlayout(location = 4) in mediump vec3 v_tangent;\nlayout(location = 5) in mediump vec3 v_binormal;\n#endif\nlayout(location = 6) in mediump vec2 uvw;\nlayout(location = 7) in mediump vec2 uv0;\nlayout(location = 8) in mediump vec2 uv1;\nlayout(location = 9) in mediump vec2 uv2;\nlayout(location = 10) in mediump vec2 uv3;\nlayout(location = 12) in mediump vec3 diffuse;\nlayout(location = 11) in mediump vec3 luv;\nlayout(set = 1, binding = 1) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nlayout(set = 1, binding = 2) uniform sampler2D weightMap;\nlayout(set = 1, binding = 3) uniform sampler2D detailMap0;\nlayout(set = 1, binding = 4) uniform sampler2D detailMap1;\nlayout(set = 1, binding = 5) uniform sampler2D detailMap2;\nlayout(set = 1, binding = 6) uniform sampler2D detailMap3;\nlayout(set = 1, binding = 7) uniform sampler2D normalMap0;\nlayout(set = 1, binding = 8) uniform sampler2D normalMap1;\nlayout(set = 1, binding = 9) uniform sampler2D normalMap2;\nlayout(set = 1, binding = 10) uniform sampler2D normalMap3;\nlayout(set = 1, binding = 11) uniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\ns.position = v_position;\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(set = 2, binding = 1) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 0\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 0) out vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\nret = fract(ret);\nret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\nreturn ret;\n}\nlayout(location = 0) in vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nlayout(location = 7) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nlayout(location = 8) in vec4 a_matWorld0;\nlayout(location = 9) in vec4 a_matWorld1;\nlayout(location = 10) in vec4 a_matWorld2;\n#if USE_LIGHTMAP\nlayout(location = 11) in vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\nlayout(set = 2, binding = 0) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nlayout(location = 0) out float v_fog_factor;\n#if USE_VERTEX_COLOR\nlayout(location = 13) in lowp vec4 a_color;\nlayout(location = 1) out lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nlayout(location = 2) out vec2 v_uv;\nlayout(set = 1, binding = 0) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(matWorld * position);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(matWorld * position);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(matWorld * position);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(matWorld * position);\n#else\nv_fog_factor = 1.0;\n#endif\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in float v_fog_factor;\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nlayout(location = 2) in vec2 v_uv;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\n#endif\nlayout(set = 1, binding = 1) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nlayout(location = 1) in lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no *= v_color;\n#endif\n#if USE_TEXTURE\no *= texture(mainTexture, v_uv);\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\no = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, v_fog_factor), o.a);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(location = 0) out vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nlayout(set = 0, binding = 4) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(set = 2, binding = 1) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nlayout(location = 0) in vec2 v_uv;\nlayout (set = 0, binding = 6) uniform sampler2D cc_gbuffer_albedoMap;\nlayout (set = 0, binding = 7) uniform sampler2D cc_gbuffer_positionMap;\nlayout (set = 0, binding = 8) uniform sampler2D cc_gbuffer_normalMap;\nlayout (set = 0, binding = 9) uniform sampler2D cc_gbuffer_emissiveMap;\nlayout(location = 0) out vec4 fragColor;\nvoid main () {\nStandardSurface s;\nvec4 albedoMap = texture(cc_gbuffer_albedoMap,v_uv);\nvec4 positionMap = texture(cc_gbuffer_positionMap,v_uv);\nvec4 normalMap = texture(cc_gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(cc_gbuffer_emissiveMap,v_uv);\ns.albedo = albedoMap;\ns.position = positionMap.xyz;\ns.roughness = positionMap.w;\ns.normal = normalMap.xyz;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\n#if CC_USE_FOG == 0\nfogFactor = LinearFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 1\nfogFactor = ExpFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 2\nfogFactor = ExpSquaredFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 3\nfogFactor = LayeredFog(vec4(s.position, 1));\n#else\nfogFactor = 1.0;\n#endif\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(s.position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\nCCStandardShadingAdditive(s, shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, fogFactor), color.a);\nfragColor = CCFragOutput(color);\n}"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nlayout(location = 7) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nlayout(location = 8) in vec4 a_matWorld0;\nlayout(location = 9) in vec4 a_matWorld1;\nlayout(location = 10) in vec4 a_matWorld2;\n#if USE_LIGHTMAP\nlayout(location = 11) in vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\nlayout(set = 2, binding = 0) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nposition = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\nposition.z -= 0.0001;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvec4 frag () {\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nlayout(location = 7) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(location = 0) out vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(location = 0) in vec2 v_uv;\nlayout (set = 0, binding = 10) uniform sampler2D cc_lighting_resultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(cc_lighting_resultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n}"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\nlayout(location = 0) out mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nmat4 matProj = cc_matProj;\nif (matProj[3].w > 0.0) {\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\n}\nvec4 pos = matProj * matViewRotOnly * viewDir;\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 0, binding = 4) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nlayout(location = 0) in mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec2 v_uv;\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 offset;\n};\nlayout(set = 1, binding = 1) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nvec4 position = cc_matViewProj * vec4(a_position, 1.0);\nposition.xy += offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in vec2 v_uv;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(location = 0) in vec2 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 0) out vec2 v_uv;\nlayout(location = 1) out float v_percent;\nlayout(set = 1, binding = 0) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nv_percent = u_buffer0.z;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(location = 0) in vec2 v_uv;\nlayout(location = 1) in float v_percent;\nlayout(set = 1, binding = 1) uniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat precent = clamp(v_percent, 0.0, 1.0);\ncolor.xyz *= precent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},Tp=t("builtinResMgr",i.builtinResMgr=new class{constructor(){this._device=null,this._resources={}}initBuiltinRes(t){this._device=t;const e=this._resources,n=document.createElement("canvas"),s=n.getContext("2d"),o=new xu(n),r=n.width=n.height=2;s.fillStyle="#000",s.fillRect(0,0,r,r);const a=new Gd;a._uuid="black-texture",a.image=o,e[a._uuid]=a,s.fillStyle="rgba(0,0,0,0)",s.fillRect(0,0,r,r);const c=new Gd;c._uuid="empty-texture",c.image=o,e[c._uuid]=c;const l=new Yd;l._uuid="black-cube-texture",l.setMipFilter(Yd.Filter.NEAREST),l.image={front:new xu(n),back:new xu(n),left:new xu(n),right:new xu(n),top:new xu(n),bottom:new xu(n)},e[l._uuid]=l,s.fillStyle="#777",s.fillRect(0,0,r,r);const h=new Gd;h._uuid="grey-texture",h.image=o,e[h._uuid]=h,s.fillStyle="#fff",s.fillRect(0,0,r,r);const _=new Gd;_._uuid="white-texture",_.image=o,e[_._uuid]=_;const u=new Yd;u._uuid="white-cube-texture",u.setMipFilter(Yd.Filter.NEAREST),u.image={front:new xu(n),back:new xu(n),left:new xu(n),right:new xu(n),top:new xu(n),bottom:new xu(n)},e[u._uuid]=u,s.fillStyle="#7f7fff",s.fillRect(0,0,r,r);const d=new Gd;d._uuid="normal-texture",d.image=o,e[d._uuid]=d,n.width=n.height=16,s.fillStyle="#ddd",s.fillRect(0,0,16,16),s.fillStyle="#555",s.fillRect(0,0,8,8),s.fillStyle="#555",s.fillRect(8,8,8,8);const p=new Gd;p._uuid="default-texture",p.image=o,e[p._uuid]=p;const f=new Yd;if(f.setMipFilter(Yd.Filter.NEAREST),f._uuid="default-cube-texture",f.image={front:new xu(n),back:new xu(n),left:new xu(n),right:new xu(n),top:new xu(n),bottom:new xu(n)},e[f._uuid]=f,i.SpriteFrame){const t=new i.SpriteFrame,n=o._texture;t.texture=n,t._uuid="default-spriteframe",e[t._uuid]=t}const m=yp(t);if(!m)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));const g=Sp[m];return g?Promise.resolve().then((()=>{$d.forEach(((t,e)=>{const n=Object.assign(new i.EffectAsset,t);n.shaders.forEach(((t,n)=>{const i=g[e][n];i&&(t[m]=i)})),n.hideInEditor=!0,n.onLoaded()})),this._initMaterials()})):Promise.reject(Error(`Current device is requiring builtin shaders of version ${m} but shaders of that version are not assembled in this build.`))}get(t){return this._resources[t]}_initMaterials(){const t=this._resources,e=[],n=new i.Material;n._uuid="standard-material",n.initialize({effectName:"standard"}),t[n._uuid]=n,e.push(n);const s=new i.Material;s._uuid="missing-effect-material",s.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),s.setProperty("mainColor",i.color("#ffff00")),t[s._uuid]=s,e.push(s);const o=new i.Material;o._uuid="missing-material",o.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),o.setProperty("mainColor",i.color("#ff00ff")),t[o._uuid]=o,e.push(o);const r=new i.Material;r._uuid="default-clear-stencil",r.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),t[r._uuid]=r,e.push(r);const a=new i.Material;a._uuid="ui-base-material",a.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),t[a._uuid]=a,e.push(a);const c=new i.Material;c._uuid="ui-sprite-material",c.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),t[c._uuid]=c,e.push(c);const l=new i.Material;l._uuid="ui-alpha-test-material",l.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),t[l._uuid]=l,e.push(l);const h=new i.Material;h._uuid="ui-sprite-gray-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),t[h._uuid]=h,e.push(h);const _=new i.Material;_._uuid="ui-sprite-alpha-sep-material",_.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),t[_._uuid]=_,e.push(_);const u=new i.Material;u._uuid="ui-sprite-gray-alpha-sep-material",u.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),t[u._uuid]=u,e.push(u);const d=new i.Material;d._uuid="ui-graphics-material",d.initialize({effectName:"graphics"}),t[d._uuid]=d,e.push(d);const p=new i.Material;p._uuid="default-particle-material",p.initialize({effectName:"particle"}),t[p._uuid]=p,e.push(p);const f=new i.Material;f._uuid="default-particle-gpu-material",f.initialize({effectName:"particle-gpu"}),t[f._uuid]=f,e.push(f);const m=new i.Material;m._uuid="default-trail-material",m.initialize({effectName:"particle-trail"}),t[m._uuid]=m,e.push(m);const g=new i.Material;g._uuid="default-billboard-material",g.initialize({effectName:"billboard"}),t[g._uuid]=g,e.push(g);const v=new i.Material;v._uuid="default-spine-material",v.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),t[v._uuid]=v,e.push(v);const y=new i.Material;y._uuid="builtin-deferred-material",y.initialize({effectName:"deferred-lighting"}),t[y._uuid]=y,e.push(y);const x=new i.Material;x._uuid="builtin-post-process-material",x.initialize({effectName:"post-process"}),t[x._uuid]=x,e.push(x),i.game.on(i.Game.EVENT_RENDERER_INITED,(()=>{for(let t=0;t<e.length;++t){const n=e[t];for(let t=0;t<n.passes.length;++t)n.passes[t].tryCompile()}}))}}),Ep=(()=>{const t=new Map;let e=0;return n=>"number"==typeof n?n:(t.has(n)||(t.set(n,1<<e),e++),t.get(n))})(),Ap=new br(Lo.UNIFORM|Lo.TRANSFER_DST,zo.HOST|zo.DEVICE),Cp=new Pr(null),bp=new ea(null);let Pp;!function(t){t[t.INSTANCING=1]="INSTANCING",t[t.VB_MERGING=2]="VB_MERGING"}(Pp||(Pp={}));class wp{static fillPipelineInfo(t,e){const n=t.handle;void 0!==e.priority&&Vi.set(n,Hi.PRIORITY,e.priority),void 0!==e.primitive&&Vi.set(n,Hi.PRIMITIVE,e.primitive),void 0!==e.stage&&Vi.set(n,Hi.STAGE,e.stage),void 0!==e.dynamicStates&&Vi.set(n,Hi.DYNAMIC_STATES,e.dynamicStates),void 0!==e.phase&&Vi.set(n,Hi.PHASE,Ep(e.phase));const i=t._bs;if(e.blendState){const t=e.blendState,{targets:n}=t;n&&n.forEach(((t,e)=>{i.setTarget(e,t)})),void 0!==t.isA2C&&(i.isA2C=t.isA2C),void 0!==t.isIndepend&&(i.isIndepend=t.isIndepend),void 0!==t.blendColor&&(i.blendColor=t.blendColor)}t._rs.assign(e.rasterizerState),t._dss.assign(e.depthStencilState)}static getPassHash(t,e){const n=t.handle;let i=`${e},${Vi.get(n,Hi.PRIMITIVE)},${Vi.get(n,Hi.DYNAMIC_STATES)}`;var s;return i+=function(t){let e=`,bs,${t.isA2C}`;for(const n of t.targets)e+=`,bt,${n.blend},${n.blendEq},${n.blendAlphaEq},${n.blendColorMask}`,e+=`,${n.blendSrc},${n.blendDst},${n.blendSrcAlpha},${n.blendDstAlpha}`;return e}(t._bs),i+=function(t){let e=`,dss,${t.depthTest},${t.depthWrite},${t.depthFunc}`;return e+=`,${t.stencilTestFront},${t.stencilFuncFront},${t.stencilRefFront},${t.stencilReadMaskFront}`,e+=`,${t.stencilFailOpFront},${t.stencilZFailOpFront},${t.stencilPassOpFront},${t.stencilWriteMaskFront}`,e+=`,${t.stencilTestBack},${t.stencilFuncBack},${t.stencilRefBack},${t.stencilReadMaskBack}`,e+=`,${t.stencilFailOpBack},${t.stencilZFailOpBack},${t.stencilPassOpBack},${t.stencilWriteMaskBack}`,e}(t._dss),i+=`,rs,${(s=t._rs).cullMode},${s.depthBias},${s.isFrontFaceCCW}`,Na(i,666)}constructor(t){this._rootBuffer=null,this._rootBufferDirty=!1,this._buffers=[],this._descriptorSet=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._root=void 0,this._device=void 0,this._hShaderDefault=0,this._handle=0,this._bs=new Ya,this._dss=new $a,this._rs=new Ka,this._root=t,this._device=t.device}initialize(t){this._doInit(t),this.resetUBOs(),this.resetTextures(),this.tryCompile()}getHandle(t,e=0,n=No.UNKNOWN){let i=this._propertyHandleMap[t];return i?(n?i=ap(i,n):e&&(i=ap(i,sp(i)-e)),i+e):0}getBinding(t){const e=this.getHandle(t);return e?wp.getBindingFromHandle(e):-1}setUniform(t,e){const n=wp.getBindingFromHandle(t),i=wp.getTypeFromHandle(t),s=wp.getOffsetFromHandle(t),o=this._blocks[n];lp[i](o,e,s),this._rootBufferDirty=!0}getUniform(t,e){const n=wp.getBindingFromHandle(t),i=wp.getTypeFromHandle(t),s=wp.getOffsetFromHandle(t),o=this._blocks[n];return cp[i](o,e,s)}setUniformArray(t,e){const n=wp.getBindingFromHandle(t),i=wp.getTypeFromHandle(t),s=va(i)>>2,o=this._blocks[n];let r=wp.getOffsetFromHandle(t);for(let t=0;t<e.length;t++,r+=s)null!==e[t]&&lp[i](o,e[t],r);this._rootBufferDirty=!0}bindTexture(t,e,n){this._descriptorSet.bindTexture(t,e,n||0)}bindSampler(t,e,n){this._descriptorSet.bindSampler(t,e,n||0)}setDynamicState(t,e){const n=this._dynamics[t];n&&n.value===e||(n.value=e,n.dirty=!0)}overridePipelineStates(t,e){console.warn("base pass cannot override states, please use pass instance instead.")}update(){this._rootBufferDirty&&this._rootBuffer&&(this._rootBuffer.update(this._rootBlock),this._rootBufferDirty=!1),this._descriptorSet.update()}destroy(){for(let t=0;t<this._shaderInfo.blocks.length;t++){const e=this._shaderInfo.blocks[t];this._buffers[e.binding].destroy()}this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBlock=null),this._descriptorSet=null,this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._handle&&(Pi.free(Vi.get(this._handle,Hi.DESCRIPTOR_SET)),Vi.free(this._handle),this._handle=0)}resetUniform(t){const e=this.getHandle(t);if(!e)return;const n=wp.getTypeFromHandle(e),i=wp.getBindingFromHandle(e),s=wp.getOffsetFromHandle(e),o=this._blocks[i],r=this._properties[t],a=r&&r.value||_p(n);lp[n](o,a,s),this._rootBufferDirty=!0}resetTexture(t,e){const n=this.getHandle(t);if(!n)return;const i=wp.getTypeFromHandle(n),s=wp.getBindingFromHandle(n),o=this._properties[t],r=o&&o.value,a=r?`${r}-texture`:_p(i),c=Tp.get(a),l=c&&c.getGFXTexture(),h=o&&void 0!==o.samplerHash?o.samplerHash:c&&c.getSamplerHash(),_=bu.getSampler(this._device,h);this._descriptorSet.bindSampler(s,_,e),this._descriptorSet.bindTexture(s,l,e)}resetUBOs(){for(let t=0;t<this._shaderInfo.blocks.length;t++){const e=this._shaderInfo.blocks[t],n=this._blocks[e.binding];let i=0;for(let t=0;t<e.members.length;t++){const s=e.members[t],o=this._properties[s.name],r=o&&o.value||_p(s.type),a=(va(s.type)>>2)*s.count;for(let t=0;t+r.length<=a;t+=r.length)n.set(r,i+t);i+=a}}this._rootBufferDirty=!0}resetTextures(){for(let t=0;t<this._shaderInfo.samplerTextures.length;t++){const e=this._shaderInfo.samplerTextures[t];for(let t=0;t<e.count;t++)this.resetTexture(e.name,t)}}tryCompile(){const{pipeline:t}=this._root;return!!t&&(this._syncBatchingScheme(),this._hShaderDefault=xp.getGFXShader(this._device,this._programName,this._defines,t),this._hShaderDefault?(Vi.set(this._handle,Hi.PIPELINE_LAYOUT,xp.getTemplateInfo(this._programName).hPipelineLayout),Vi.set(this._handle,Hi.HASH,wp.getPassHash(this,this._hShaderDefault)),!0):(console.warn(`create shader ${this._programName} failed`),!1))}getShaderVariant(t=null){if(!this._hShaderDefault&&!this.tryCompile())return console.warn("pass resources incomplete"),0;if(!t)return this._hShaderDefault;const{pipeline:e}=this._root;for(let e=0;e<t.length;e++){const n=t[e];this._defines[n.name]=n.value}const n=xp.getGFXShader(this._device,this._programName,this._defines,e);for(let e=0;e<t.length;e++){const n=t[e];delete this._defines[n.name]}return n}beginChangeStatesSilently(){}endChangeStatesSilently(){}_doInit(t,e=!1){const n=this._handle=Vi.alloc();Vi.set(n,Hi.PRIORITY,fl.DEFAULT),Vi.set(n,Hi.STAGE,pl.DEFAULT),Vi.set(n,Hi.PHASE,Ep("default")),Vi.set(n,Hi.PRIMITIVE,er.TRIANGLE_LIST),Vi.set(n,Hi.RASTERIZER_STATE,this._rs.handle),Vi.set(n,Hi.DEPTH_STENCIL_STATE,this._dss.handle),Vi.set(n,Hi.BLEND_STATE,this._bs.handle),this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=e?{...t.defines}:t.defines,this._shaderInfo=xp.getTemplate(t.program),this._properties=t.properties||this._properties;const i=this._device;wp.fillPipelineInfo(this,t),t.stateOverrides&&wp.fillPipelineInfo(this,t.stateOverrides),bp.layout=xp.getDescriptorSetLayout(this._device,t.program);const s=Pi.alloc(this._device,bp);Vi.set(this._handle,Hi.DESCRIPTOR_SET,s),this._descriptorSet=Pi.get(s);const o=this._shaderInfo.blocks,r=xp.getTemplateInfo(t.program),{blockSizes:a,handleMap:c}=r,l=i.capabilities.uboOffsetAlignment,h=[];let _=0,u=0;for(let t=0;t<o.length;t++){const e=a[t];h.push(u),u+=Math.ceil(e/l)*l,_=e}const d=h[h.length-1]+_;d&&(Ap.size=16*Math.ceil(d/16),this._rootBuffer=i.createBuffer(Ap),this._rootBlock=new ArrayBuffer(d));for(let t=0,e=0;t<o.length;t++){const{binding:n}=o[t],s=a[t];Cp.buffer=this._rootBuffer,Cp.offset=h[e++],Cp.range=16*Math.ceil(s/16);const r=this._buffers[n]=i.createBuffer(Cp);this._blocks[n]=new Float32Array(this._rootBlock,Cp.offset,s/Float32Array.BYTES_PER_ELEMENT),this._descriptorSet.bindBuffer(n,r)}const p=this._propertyHandleMap=c,f={};for(const t in this._properties){const e=this._properties[t];e.handleInfo&&(f[t]=this.getHandle.apply(this,e.handleInfo))}Object.assign(p,f)}_syncBatchingScheme(){this._defines.USE_INSTANCING?this._device.hasFeature(Ro.INSTANCED_ARRAYS)?Vi.set(this._handle,Hi.BATCHING_SCHEME,Pp.INSTANCING):(this._defines.USE_INSTANCING=!1,Vi.set(this._handle,Hi.BATCHING_SCHEME,0)):this._defines.USE_BATCHING?Vi.set(this._handle,Hi.BATCHING_SCHEME,Pp.VB_MERGING):Vi.set(this._handle,Hi.BATCHING_SCHEME,0)}_destroyHandle(){this._handle&&(Vi.free(this._handle),this._handle=0)}_initPassFromTarget(t,e,n,i){Vi.set(this.handle,Hi.PRIORITY,t.priority),Vi.set(this.handle,Hi.STAGE,t.stage),Vi.set(this.handle,Hi.PHASE,t.phase),Vi.set(this.handle,Hi.BATCHING_SCHEME,t.batchingScheme),Vi.set(this.handle,Hi.PRIMITIVE,t.primitive),Vi.set(this.handle,Hi.DYNAMIC_STATES,t.dynamicStates),this._descriptorSet=t.descriptorSet,Vi.set(this.handle,Hi.DESCRIPTOR_SET,Vi.get(t.handle,Hi.DESCRIPTOR_SET)),this._bs=n,Vi.set(this.handle,Hi.BLEND_STATE,n.handle),this._rs=t.rasterizerState,Vi.set(this.handle,Hi.RASTERIZER_STATE,Vi.get(t.handle,Hi.RASTERIZER_STATE)),this._dss=e,Vi.set(this.handle,Hi.DEPTH_STENCIL_STATE,e.handle),this._passIndex=t.passIndex,this._propertyIndex=t.propertyIndex,this._programName=t.program,this._defines=t.defines,this._shaderInfo=t._shaderInfo,this._properties=t._properties,this._blocks=t._blocks,this._dynamics=t._dynamics,this._hShaderDefault=t._hShaderDefault,Vi.set(this._handle,Hi.PIPELINE_LAYOUT,xp.getTemplateInfo(this._programName).hPipelineLayout);const s=Vi.get(t.handle,Hi.HASH);Vi.set(this._handle,Hi.HASH,s^i)}get root(){return this._root}get device(){return this._device}get shaderInfo(){return this._shaderInfo}get localSetLayout(){return xp.getDescriptorSetLayout(this._device,this._programName,!0)}get program(){return this._programName}get properties(){return this._properties}get defines(){return this._defines}get passIndex(){return this._passIndex}get propertyIndex(){return this._propertyIndex}get dynamics(){return this._dynamics}get blocks(){return this._blocks}get handle(){return this._handle}get priority(){return Vi.get(this._handle,Hi.PRIORITY)}get primitive(){return Vi.get(this._handle,Hi.PRIMITIVE)}get stage(){return Vi.get(this._handle,Hi.STAGE)}get phase(){return Vi.get(this._handle,Hi.PHASE)}get rasterizerState(){return this._rs}get depthStencilState(){return this._dss}get blendState(){return this._bs}get dynamicStates(){return Vi.get(this._handle,Hi.DYNAMIC_STATES)}get batchingScheme(){return Vi.get(this._handle,Hi.BATCHING_SCHEME)}get descriptorSet(){return this._descriptorSet}get hash(){return Vi.get(this._handle,Hi.HASH)}get rootBufferDirty(){return this._rootBufferDirty}}wp.PropertyType=ep,wp.getPropertyTypeFromHandle=ip,wp.getTypeFromHandle=sp,wp.getBindingFromHandle=op,wp.getOffsetFromHandle=rp;const Dp=Qn.getViewSize(),Ip=Qn.pixelRatio,Rp=t("sys",{NetworkType:qn,Language:kn,OS:Xn,Platform:Kn,BrowserType:jn,isNative:Qn.isNative,isBrowser:Qn.isBrowser,isMobile:Qn.isMobile,isLittleEndian:Qn.isLittleEndian,platform:Qn.platform,language:Qn.language,languageCode:Qn.nativeLanguage,os:Qn.os,osVersion:Qn.osVersion,osMainVersion:Qn.osMainVersion,browserType:Qn.browserType,browserVersion:Qn.browserVersion,windowPixelResolution:{width:Dp.width*Ip,height:Dp.height*Ip},capabilities:{canvas:Qn.supportCapability.canvas,opengl:Qn.supportCapability.gl,webp:Qn.supportCapability.webp,imageBitmap:Qn.supportCapability.imageBitmap,touches:!1,mouse:!1,keyboard:!1,accelerometer:!1},localStorage:null,getNetworkType:()=>Qn.networkType,getBatteryLevel:()=>Qn.getBatteryLevel(),garbageCollect(){Qn.triggerGC()},isObjectValid:t=>null!=t,dump(){let t="";t+=`isMobile : ${this.isMobile}\r\n`,t+=`language : ${this.language}\r\n`,t+=`browserType : ${this.browserType}\r\n`,t+=`browserVersion : ${this.browserVersion}\r\n`,t+=`capabilities : ${JSON.stringify(this.capabilities)}\r\n`,t+=`os : ${this.os}\r\n`,t+=`osVersion : ${this.osVersion}\r\n`,t+=`platform : ${this.platform}\r\n`,t+=`Using ${i.game.renderType===i.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS"} renderer.\r\n`,u(t)},openURL(t){Qn.openURL(t)},now:()=>Qn.now(),restartVM(){Qn.restartJSVM()},getSafeAreaRect(){const t=i.view,e=Qn.getSafeAreaEdge(),n=Qn.getViewSize(),s=new qe(e.left,n.height-e.bottom),o=new qe(n.width-e.right,e.top),r={left:0,top:0,width:n.width,height:n.height};t.convertToLocationInView(s.x,s.y,r,s),t.convertToLocationInView(o.x,o.y,r,o),t._convertPointWithScale(s),t._convertPointWithScale(o);const a=s.x,c=s.y,l=o.x-s.x,h=o.y-s.y;return new Sn(a,c,l,h)},__init(){try{let t=Rp.localStorage=window.localStorage;t.setItem("storage",""),t.removeItem("storage"),t=null}catch(t){const e=function(){E(5200)};Rp.localStorage={getItem:e,setItem:e,removeItem:e,clear:e}}const t=window,e=t.navigator,n=document,i=n.documentElement,s=Rp.capabilities;(void 0!==i.ontouchstart||void 0!==n.ontouchstart||e.msPointerEnabled)&&(s.touches=!0),void 0!==i.onmouseup&&(s.mouse=!0),void 0!==i.onkeyup&&(s.keyboard=!0),(t.DeviceMotionEvent||t.DeviceOrientationEvent)&&(s.accelerometer=!0),Rp.__isWebIOS14OrIPadOS14Env=(Rp.os===Xn.IOS||Rp.os===Xn.OSX)&&Qn.isBrowser&&/(OS 1[4-9])|(Version\/1[4-9])/.test(window.navigator.userAgent),Qn.onViewResize((()=>{const t=Qn.getViewSize();Rp.windowPixelResolution={width:Math.round(t.width*Ip),height:Math.round(t.height*Ip)}}))}});Rp.__init(),i.sys=Rp;const Op={topLeft:i.v2(0,0),topRight:i.v2(0,0),top:i.v2(0,0),bottomLeft:i.v2(0,0),bottomRight:i.v2(0,0),bottom:i.v2(0,0),center:i.v2(0,0),left:i.v2(0,0),right:i.v2(0,0),width:0,height:0,init(t){const e=this.width=t.width,n=this.height=t.height,i=t.x,s=t.y,o=s+n,r=i+e;this.topLeft.x=i,this.topLeft.y=o,this.topRight.x=r,this.topRight.y=o,this.top.x=i+e/2,this.top.y=o,this.bottomLeft.x=i,this.bottomLeft.y=s,this.bottomRight.x=r,this.bottomRight.y=s,this.bottom.x=i+e/2,this.bottom.y=s,this.center.x=i+e/2,this.center.y=s+n/2,this.left.x=i,this.left.y=s+n/2,this.right.x=r,this.right.y=s+n/2}};let Mp;i.visibleRect=Op,function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.MOUSE_ENTER="mouse-enter",t.MOUSE_LEAVE="mouse-leave",t.KEY_DOWN="keydown",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion",t.TRANSFORM_CHANGED="transform-changed",t.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",t.SIZE_CHANGED="size-changed",t.ANCHOR_CHANGED="anchor-changed",t.COLOR_CHANGED="color-changed",t.CHILD_ADDED="child-added",t.CHILD_REMOVED="child-removed",t.PARENT_CHANGED="parent-changed",t.NODE_DESTROYED="node-destroyed",t.LAYER_CHANGED="layer-changed",t.SIBLING_ORDER_CHANGED="sibling-order-changed"}(Mp||(Mp=t("SystemEventType",{}))),Mt(Mp),i.SystemEventType=Mp;class Np{constructor(){this.support=void 0,this._intervalInSeconds=.2,this._intervalId=void 0,this._isEnabled=!1,this._eventTarget=new Vn,this._didAccelerateFunc=void 0;const t=Qn.isMobile;this.support=t,this._didAccelerateFunc=this._didAccelerate.bind(this)}_didAccelerate(){const t=jsb.device.getDeviceMotionValue();let e=.1*t[3],n=.1*t[4];const i=.1*t[5],s=Qn.getOrientation(),o=e;s===Yn.LANDSCAPE_RIGHT?(e=-n,n=o):s===Yn.LANDSCAPE_LEFT?(e=n,n=-o):s===Yn.PORTRAIT_UPSIDE_DOWN&&(e=-e,n=-n),Qn.os===Xn.ANDROID&&(e=-e,n=-n);const r={type:Mp.DEVICEMOTION,x:e,y:n,z:i,timestamp:performance.now()};this._eventTarget.emit(Mp.DEVICEMOTION,r)}start(){this._intervalId&&clearInterval(this._intervalId),this._intervalId=setInterval(this._didAccelerateFunc,1e3*this._intervalInSeconds),jsb.device.setAccelerometerInterval(this._intervalInSeconds),jsb.device.setAccelerometerEnabled(!0),this._isEnabled=!0}stop(){this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),jsb.device.setAccelerometerEnabled(!1),this._isEnabled=!1}setInterval(t){this._intervalInSeconds=t/1e3,jsb.device.setAccelerometerInterval(this._intervalInSeconds),this._isEnabled&&(jsb.device.setAccelerometerEnabled(!1),jsb.device.setAccelerometerEnabled(!0))}onChange(t){this._eventTarget.on(Mp.DEVICEMOTION,t)}}class Lp{constructor(){this.support=void 0,this.support=!0}show(){throw new Error("Method not implemented.")}hide(){throw new Error("Method not implemented.")}onChange(){throw new Error("Method not implemented.")}onComplete(){throw new Error("Method not implemented.")}offChange(){throw new Error("Method not implemented.")}offComplete(){throw new Error("Method not implemented.")}}class Bp{constructor(){this.support=void 0,this._eventTarget=new Vn,this.support=!Qn.isMobile,this._registerEvent()}_registerEvent(){jsb.onKeyDown=this._createCallback(Mp.KEY_DOWN),jsb.onKeyUp=this._createCallback(Mp.KEY_UP)}_createCallback(t){return e=>{const n={type:t,code:e.keyCode,timestamp:performance.now()};this._eventTarget.emit(t,n)}}onDown(t){this._eventTarget.on(Mp.KEY_DOWN,t)}onUp(t){this._eventTarget.on(Mp.KEY_UP,t)}}class Fp{constructor(){this.support=void 0,this._eventTarget=new Vn,this.support=!Qn.isMobile,this._registerEvent()}_getLocation(t){return new qe(t.x,t.y)}_registerEvent(){jsb.onMouseDown=this._createCallback(Mp.MOUSE_DOWN),jsb.onMouseMove=this._createCallback(Mp.MOUSE_MOVE),jsb.onMouseUp=this._createCallback(Mp.MOUSE_UP),jsb.onMouseWheel=t=>{const e=this._getLocation(t),n=Qn.getViewSize(),i={type:Mp.MOUSE_WHEEL,x:e.x,y:n.height-e.y,button:t.button,deltaX:120*t.wheelDeltaX,deltaY:120*t.wheelDeltaY,timestamp:performance.now()};this._eventTarget.emit(Mp.MOUSE_WHEEL,i)}}_createCallback(t){return e=>{const n=this._getLocation(e),i=Qn.getViewSize(),s={type:t,x:n.x,y:i.height-n.y,button:e.button,timestamp:performance.now()};this._eventTarget.emit(t,s)}}onDown(t){this._eventTarget.on(Mp.MOUSE_DOWN,t)}onMove(t){this._eventTarget.on(Mp.MOUSE_MOVE,t)}onUp(t){this._eventTarget.on(Mp.MOUSE_UP,t)}onWheel(t){this._eventTarget.on(Mp.MOUSE_WHEEL,t)}}class zp{constructor(){this.support=void 0,this._eventTarget=new Vn,this.support=!0,this._registerEvent()}_registerEvent(){jsb.onTouchStart=this._createCallback(Mp.TOUCH_START),jsb.onTouchMove=this._createCallback(Mp.TOUCH_MOVE),jsb.onTouchEnd=this._createCallback(Mp.TOUCH_END),jsb.onTouchCancel=this._createCallback(Mp.TOUCH_CANCEL)}_createCallback(t){return e=>{const n=[],i=e.length,s=Qn.getViewSize();for(let t=0;t<i;++t){const i=e[t],o=this._getLocation(i),r=o.x,a=s.height-o.y,c={identifier:i.identifier,x:r,y:a,force:i.force};n.push(c)}const o={type:t,changedTouches:n,timestamp:performance.now()};this._eventTarget.emit(t,o)}}_getLocation(t){return new qe(t.clientX,t.clientY)}onStart(t){this._eventTarget.on(Mp.TOUCH_START,t)}onMove(t){this._eventTarget.on(Mp.TOUCH_MOVE,t)}onEnd(t){this._eventTarget.on(Mp.TOUCH_END,t)}onCancel(t){this._eventTarget.on(Mp.TOUCH_CANCEL,t)}}const Up=new class{constructor(){this._touch=new zp,this._mouse=new Fp,this._keyboard=new Bp,this._accelerometer=new Np,this._inputBox=new Lp,this._inputEventList=[],this._registerEvent()}_registerEvent(){}_pushEvent(t){this._inputEventList.push(t)}pollEvent(){return this._inputEventList.shift()}};class Hp{static create(t){P(t&&t.event,1900);const e=t.event;delete t.event;let n=null;if(e===i.EventListener.TOUCH_ONE_BY_ONE?n=new jp:e===i.EventListener.TOUCH_ALL_AT_ONCE?n=new Wp:e===i.EventListener.MOUSE?n=new Vp:e===i.EventListener.KEYBOARD?n=new qp:e===i.EventListener.ACCELERATION&&(n=new kp(t.callback),delete t.callback),n)for(const e of Object.keys(t))n[e]=t[e];return n}get onEvent(){return this._onEvent}constructor(t,e,n){this._cameraPriority=0,this.owner=null,this.mask=null,this._previousIn=!1,this._target=null,this._onEvent=void 0,this._type=void 0,this._listenerID=void 0,this._registered=!1,this._fixedPriority=0,this._node=null,this._paused=!0,this._isEnabled=!0,this._onEvent=n,this._type=t||0,this._listenerID=e||""}_setPaused(t){this._paused=t}_isPaused(){return this._paused}_setRegistered(t){this._registered=t}_isRegistered(){return this._registered}_getType(){return this._type}_getListenerID(){return this._listenerID}_setFixedPriority(t){this._fixedPriority=t}_getFixedPriority(){return this._fixedPriority}_setSceneGraphPriority(t){this._target=t,this._node=t}_getSceneGraphPriority(){return this._node}checkAvailable(){return null!==this._onEvent}clone(){return null}setEnabled(t){this._isEnabled=t}isEnabled(){return this._isEnabled}}Hp.UNKNOWN=0,Hp.TOUCH_ONE_BY_ONE=1,Hp.TOUCH_ALL_AT_ONCE=2,Hp.KEYBOARD=3,Hp.MOUSE=4,Hp.ACCELERATION=6,Hp.CUSTOM=8,Hp.ListenerID={MOUSE:"__cc_mouse",TOUCH_ONE_BY_ONE:"__cc_touch_one_by_one",TOUCH_ALL_AT_ONCE:"__cc_touch_all_at_once",KEYBOARD:"__cc_keyboard",ACCELERATION:"__cc_acceleration"};const Gp=Hp.ListenerID;class Vp extends Hp{constructor(){super(Hp.MOUSE,Gp.MOUSE,null),this.onMouseDown=null,this.onMouseUp=null,this.onMouseMove=null,this.onMouseScroll=null,this._onEvent=t=>this._callback(t)}_callback(t){switch(t.eventType){case Mp.MOUSE_DOWN:this.onMouseDown&&this.onMouseDown(t);break;case Mp.MOUSE_UP:this.onMouseUp&&this.onMouseUp(t);break;case Mp.MOUSE_MOVE:this.onMouseMove&&this.onMouseMove(t);break;case Mp.MOUSE_WHEEL:this.onMouseScroll&&this.onMouseScroll(t)}}clone(){const t=new Vp;return t.onMouseDown=this.onMouseDown,t.onMouseUp=this.onMouseUp,t.onMouseMove=this.onMouseMove,t.onMouseScroll=this.onMouseScroll,t}checkAvailable(){return!0}}class jp extends Hp{constructor(){super(Hp.TOUCH_ONE_BY_ONE,Gp.TOUCH_ONE_BY_ONE,null),this.swallowTouches=!1,this.onTouchBegan=null,this.onTouchMoved=null,this.onTouchEnded=null,this.onTouchCancelled=null,this._claimedTouches=[]}setSwallowTouches(t){this.swallowTouches=t}isSwallowTouches(){return this.swallowTouches}clone(){const t=new jp;return t.onTouchBegan=this.onTouchBegan,t.onTouchMoved=this.onTouchMoved,t.onTouchEnded=this.onTouchEnded,t.onTouchCancelled=this.onTouchCancelled,t.swallowTouches=this.swallowTouches,t}checkAvailable(){return!!this.onTouchBegan||(S(1801),!1)}}class Wp extends Hp{constructor(){super(Hp.TOUCH_ALL_AT_ONCE,Gp.TOUCH_ALL_AT_ONCE,null),this.onTouchesBegan=null,this.onTouchesMoved=null,this.onTouchesEnded=null,this.onTouchesCancelled=null}clone(){const t=new Wp;return t.onTouchesBegan=this.onTouchesBegan,t.onTouchesMoved=this.onTouchesMoved,t.onTouchesEnded=this.onTouchesEnded,t.onTouchesCancelled=this.onTouchesCancelled,t}checkAvailable(){return null!==this.onTouchesBegan||null!==this.onTouchesMoved||null!==this.onTouchesEnded||null!==this.onTouchesCancelled||(S(1802),!1)}}class kp extends Hp{constructor(t){super(Hp.ACCELERATION,Gp.ACCELERATION,null),this._onAccelerationEvent=null,this._onEvent=t=>this._callback(t),this._onAccelerationEvent=t}_callback(t){this._onAccelerationEvent&&this._onAccelerationEvent(t.acc,t)}checkAvailable(){return P(this._onAccelerationEvent,1803),!0}clone(){return new kp(this._onAccelerationEvent)}}class qp extends Hp{constructor(){super(Hp.KEYBOARD,Gp.KEYBOARD,null),this.onKeyPressed=null,this.onKeyReleased=null,this._onEvent=t=>this._callback(t)}_callback(t){t.isPressed?this.onKeyPressed&&this.onKeyPressed(t.keyCode,t):this.onKeyReleased&&this.onKeyReleased(t.keyCode,t)}clone(){const t=new qp;return t.onKeyPressed=this.onKeyPressed,t.onKeyReleased=this.onKeyReleased,t}checkAvailable(){return null!==this.onKeyPressed||null!==this.onKeyReleased||(S(1800),!1)}}i.EventListener=Hp;const Xp=Hp.ListenerID;class Yp{constructor(){this.gt0Index=0,this._fixedListeners=[],this._sceneGraphListeners=[]}size(){return this._fixedListeners.length+this._sceneGraphListeners.length}empty(){return 0===this._fixedListeners.length&&0===this._sceneGraphListeners.length}push(t){0===t._getFixedPriority()?this._sceneGraphListeners.push(t):this._fixedListeners.push(t)}clearSceneGraphListeners(){this._sceneGraphListeners.length=0}clearFixedListeners(){this._fixedListeners.length=0}clear(){this._sceneGraphListeners.length=0,this._fixedListeners.length=0}getFixedPriorityListeners(){return this._fixedListeners}getSceneGraphPriorityListeners(){return this._sceneGraphListeners}}const Kp=t("eventManager",new class{constructor(){this._listenersMap={},this._priorityDirtyFlagMap={},this._nodeListenersMap={},this._toAddedListeners=[],this._toRemovedListeners=[],this._dirtyListeners={},this._inDispatch=0,this._isEnabled=!1,this._internalCustomListenerIDs=[],this._currentTouch=null,this._currentTouchListener=null}pauseTarget(t,e=!1){if(!(t instanceof i._BaseNode))return void E(3506);const n=this._nodeListenersMap[t.uuid];if(n)for(let t=0;t<n.length;++t)n[t]._setPaused(!0);if(!0===e){const e=t.children;if(e)for(let t=0;t<e.length;++t){const n=e[t];this.pauseTarget(n,!0)}}}resumeTarget(t,e=!1){if(!(t instanceof i._BaseNode))return void E(3506);const n=this._nodeListenersMap[t.uuid];if(n)for(let t=0;t<n.length;++t)n[t]._setPaused(!1);if(this._setDirtyForNode(t),!0===e&&t.children.length>0){const e=t.children;if(e)for(let t=0;t<e.length;++t){const n=e[t];this.resumeTarget(n,!0)}}}frameUpdateListeners(){const t=this._listenersMap,e=this._priorityDirtyFlagMap;for(const n in t)t[n].empty()&&(delete e[n],delete t[n]);const n=this._toAddedListeners;if(0!==n.length){for(let t=0,e=n.length;t<e;t++)this._forceAddEventListener(n[t]);n.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}hasEventListener(t){return!!this._getListeners(t)}addListener(t,e){if(P(t&&e,3503),!(i.js.isNumber(e)||e instanceof i._BaseNode))return E(3506),null;if(t instanceof i.EventListener){if(t._isRegistered())return S(3505),null}else P(!i.js.isNumber(e),3504),t=i.EventListener.create(t);if(!t.checkAvailable())return null;if(i.js.isNumber(e)){if(0===e)return S(3500),null;t._setSceneGraphPriority(null),t._setFixedPriority(e),t._setRegistered(!0),t._setPaused(!1),this._addListener(t)}else{if(!(n=e)||!n.getComponent("cc.UITransform"))return S(3512),null;t._setSceneGraphPriority(e),t._setFixedPriority(0),t._setRegistered(!0),this._addListener(t)}var n;return t}addCustomListener(t,e){const n=Hp.create({event:i.EventListener.CUSTOM,eventName:t,callback:e});return this.addListener(n,1),n}removeListener(t){if(null==t)return;let e=!1;const n=this._listenersMap;t===this._currentTouchListener&&(this._currentTouchListener=this._currentTouch=null);for(const i in n){const s=n[i],o=s.getFixedPriorityListeners(),r=s.getSceneGraphPriorityListeners();if(e=this._removeListenerInVector(r,t),e?this._setDirty(t._getListenerID(),2):(e=this._removeListenerInVector(o,t),e&&this._setDirty(t._getListenerID(),1)),s.empty()&&(delete this._priorityDirtyFlagMap[t._getListenerID()],delete n[i]),e)break}if(!e){const e=this._toAddedListeners;for(let n=e.length-1;n>=0;n--){const s=e[n];if(s===t){i.js.array.removeAt(e,n),s._setRegistered(!1);break}}}}removeListeners(t,e=!1){if(i.js.isNumber(t)||t instanceof i._BaseNode)if(void 0!==t._id){const n=this._nodeListenersMap[t._id];if(n){const e=i.js.array.copy(n);for(let t=0;t<e.length;++t){const n=e[t];this.removeListener(n)}delete this._nodeListenersMap[t._id]}const s=this._toAddedListeners;for(let e=0;e<s.length;){const n=s[e];n._getSceneGraphPriority()===t?(n._setSceneGraphPriority(null),n._setRegistered(!1),s.splice(e,1)):++e}if(!0===e){const e=t.getChildren();for(let t=0;t<e.length;++t){const n=e[t];this.removeListeners(n,!0)}}}else t===i.EventListener.TOUCH_ONE_BY_ONE?this._removeListenersForListenerID(Xp.TOUCH_ONE_BY_ONE):t===i.EventListener.TOUCH_ALL_AT_ONCE?this._removeListenersForListenerID(Xp.TOUCH_ALL_AT_ONCE):t===i.EventListener.MOUSE?this._removeListenersForListenerID(Xp.MOUSE):t===i.EventListener.ACCELERATION?this._removeListenersForListenerID(Xp.ACCELERATION):t===i.EventListener.KEYBOARD?this._removeListenersForListenerID(Xp.KEYBOARD):S(3501);else E(3506)}removeCustomListeners(t){this._removeListenersForListenerID(t)}removeAllListeners(){const t=this._listenersMap,e=this._internalCustomListenerIDs;for(const n in t)-1===e.indexOf(n)&&this._removeListenersForListenerID(n)}setPriority(t,e){if(null==t)return;const n=this._listenersMap;for(const i in n){const s=n[i].getFixedPriorityListeners();if(s&&-1!==s.indexOf(t))return null!=t._getSceneGraphPriority()&&S(3502),void(t._getFixedPriority()!==e&&(t._setFixedPriority(e),this._setDirty(t._getListenerID(),1)))}}setEnabled(t){this._isEnabled=t}isEnabled(){return this._isEnabled}dispatchEvent(t){if(!this._isEnabled)return;if(this._updateDirtyFlagForSceneGraph(),this._inDispatch++,!t||!t.getType)return void C(3511);if(t.getType().startsWith(i.Event.TOUCH))return this._dispatchTouchEvent(t),void this._inDispatch--;const e=function(t){const e=cu,n=t.type;return n===e.ACCELERATION?Xp.ACCELERATION:n===e.KEYBOARD?Xp.KEYBOARD:n.startsWith(e.MOUSE)?Xp.MOUSE:(n.startsWith(e.TOUCH)&&S(2e3),"")}(t);this._sortEventListeners(e);const n=this._listenersMap[e];null!=n&&(this._dispatchEventToListeners(n,this._onListenerCallback,t),this._onUpdateListeners(n)),this._inDispatch--}_onListenerCallback(t,e){e.currentTarget=t._target;const n=t.onEvent;return n&&n(e),e.isStopped()}dispatchCustomEvent(t,e){const n=new i.Event.EventCustom(t);n.setUserData(e),this.dispatchEvent(n)}_setDirtyForNode(t){const e=this._nodeListenersMap[t._id];if(void 0!==e)for(let t=0,n=e.length;t<n;t++){const n=e[t]._getListenerID();this._dirtyListeners[n]||(this._dirtyListeners[n]=!0)}if(t.children.length>0){const e=t.children;for(let t=0,n=e?e.length:0;t<n;t++)this._setDirtyForNode(e[t])}}_addListener(t){0===this._inDispatch?this._forceAddEventListener(t):this._toAddedListeners.push(t)}_forceAddEventListener(t){const e=t._getListenerID();let n=this._listenersMap[e];if(n||(n=new Yp,this._listenersMap[e]=n),n.push(t),0===t._getFixedPriority()){this._setDirty(e,2);const n=t._getSceneGraphPriority();null===n&&S(3507),this._associateNodeAndEventListener(n,t),n.activeInHierarchy&&this.resumeTarget(n)}else this._setDirty(e,1)}_getListeners(t){return this._listenersMap[t]}_updateDirtyFlagForSceneGraph(){const t=this._dirtyListeners;for(const e in t)this._setDirty(e,2),t[e]=!1}_removeAllListenersInVector(t){if(!t)return;let e;for(let n=t.length-1;n>=0;n--)e=t[n],e._setRegistered(!1),null!=e._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(e._getSceneGraphPriority(),e),e._setSceneGraphPriority(null)),0===this._inDispatch&&i.js.array.removeAt(t,n)}_removeListenersForListenerID(t){const e=this._listenersMap[t];if(e){const n=e.getFixedPriorityListeners(),i=e.getSceneGraphPriorityListeners();this._removeAllListenersInVector(i),this._removeAllListenersInVector(n),delete this._priorityDirtyFlagMap[t],this._inDispatch||(e.clear(),delete this._listenersMap[t])}const n=this._toAddedListeners;for(let e=n.length-1;e>=0;e--){const s=n[e];s&&s._getListenerID()===t&&i.js.array.removeAt(n,e)}}_sortEventListeners(t){let e=0;const n=this._priorityDirtyFlagMap;n[t]&&(e=n[t]),0!==e&&(n[t]=0,1&e&&this._sortListenersOfFixedPriority(t),2&e)&&i.director.getScene()&&this._sortListenersOfSceneGraphPriority(t)}_sortListenersOfSceneGraphPriority(t){const e=this._getListeners(t);if(!e)return;const n=e.getSceneGraphPriorityListeners();if(!n||0===n.length)return;const i=e.getSceneGraphPriorityListeners();i.forEach((t=>{const e=t._getSceneGraphPriority()._uiProps.uiTransformComp;t._cameraPriority=e.cameraPriority})),i.sort(this._sortEventListenersOfSceneGraphPriorityDes)}_sortEventListenersOfSceneGraphPriorityDes(t,e){const n=t._getSceneGraphPriority(),i=e._getSceneGraphPriority();if(!(e&&i&&i._activeInHierarchy&&i._uiProps.uiTransformComp))return-1;if(!(t&&n&&n._activeInHierarchy&&n._uiProps.uiTransformComp))return 1;let s=n,o=i,r=!1;if(t._cameraPriority!==e._cameraPriority)return e._cameraPriority-t._cameraPriority;for(;s.parent._id!==o.parent._id;)s=null===s.parent.parent?(r=!0)&&i:s.parent,o=null===o.parent.parent?(r=!0)&&n:o.parent;if(s._id===o._id){if(s._id===i._id)return-1;if(s._id===n._id)return 1}const a=s.getSiblingIndex(),c=o.getSiblingIndex();return r?a-c:c-a}_sortListenersOfFixedPriority(t){const e=this._listenersMap[t];if(!e)return;const n=e.getFixedPriorityListeners();if(!n||0===n.length)return;n.sort(this._sortListenersOfFixedPriorityAsc);let i=0;for(const t=n.length;i<t&&!(n[i]._getFixedPriority()>=0);)++i;e.gt0Index=i}_sortListenersOfFixedPriorityAsc(t,e){return t._getFixedPriority()-e._getFixedPriority()}_onUpdateListeners(t){const e=t.getFixedPriorityListeners(),n=t.getSceneGraphPriorityListeners(),s=this._toRemovedListeners;if(n)for(let t=n.length-1;t>=0;t--){const e=n[t];if(!e._isRegistered()){i.js.array.removeAt(n,t);const o=s.indexOf(e);-1!==o&&s.splice(o,1)}}if(e)for(let t=e.length-1;t>=0;t--){const n=e[t];if(!n._isRegistered()){i.js.array.removeAt(e,t);const o=s.indexOf(n);-1!==o&&s.splice(o,1)}}n&&0===n.length&&t.clearSceneGraphListeners(),e&&0===e.length&&t.clearFixedListeners()}_updateTouchListeners(t){const e=this._inDispatch;if(P(e>0,3508),e>1)return;let n;n=this._listenersMap[Xp.TOUCH_ONE_BY_ONE],n&&this._onUpdateListeners(n),n=this._listenersMap[Xp.TOUCH_ALL_AT_ONCE],n&&this._onUpdateListeners(n),P(1===e,3509);const i=this._toAddedListeners;if(0!==i.length){for(let t=0,e=i.length;t<e;t++)this._forceAddEventListener(i[t]);this._toAddedListeners.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}_cleanToRemovedListeners(){const t=this._toRemovedListeners;for(let e=0;e<t.length;++e){const n=t[e],i=this._listenersMap[n._getListenerID()];if(!i)continue;const s=i.getFixedPriorityListeners(),o=i.getSceneGraphPriorityListeners();if(o){const t=o.indexOf(n);-1!==t&&o.splice(t,1)}if(s){const t=s.indexOf(n);-1!==t&&s.splice(t,1)}}t.length=0}_onTouchEventCallback(t,e){if(!t._isRegistered())return!1;const n=e.event,i=n.touch;n.currentTarget=t._getSceneGraphPriority();let s=!1,o=-1;const r=n.getEventCode();if(r===Mp.TOUCH_START){if(!Lt.ENABLE_MULTI_TOUCH&&Kp._currentTouch){const t=Kp._currentTouchListener._node;if(!t||t.activeInHierarchy)return!1}t.onTouchBegan&&(s=t.onTouchBegan(i,n),s&&t._isRegistered()&&!t._isPaused()&&(t._claimedTouches.push(i),!Lt.ENABLE_MULTI_TOUCH&&Kp._currentTouch||(Kp._currentTouch=i),Kp._currentTouchListener=t))}else if(t._claimedTouches.length>0&&(o=t._claimedTouches.indexOf(i),-1!==o)){if(s=!0,!Lt.ENABLE_MULTI_TOUCH&&Kp._currentTouch&&Kp._currentTouch!==i)return!1;r===Mp.TOUCH_MOVE&&t.onTouchMoved?t.onTouchMoved(i,n):r===Mp.TOUCH_END?(t.onTouchEnded&&t.onTouchEnded(i,n),t._isRegistered()&&t._claimedTouches.splice(o,1),(Lt.ENABLE_MULTI_TOUCH||Kp._currentTouch===i)&&(Kp._currentTouch=null),Kp._currentTouchListener=null):r===Mp.TOUCH_CANCEL&&(t.onTouchCancelled&&t.onTouchCancelled(i,n),t._isRegistered()&&t._claimedTouches.splice(o,1),(Lt.ENABLE_MULTI_TOUCH||Kp._currentTouch===i)&&(Kp._currentTouch=null),Kp._currentTouchListener=null)}return n.isStopped()?(Kp._updateTouchListeners(n),!0):!!(s&&t._isRegistered()&&t.swallowTouches)&&(e.needsMutableSet&&e.touches.splice(i,1),!0)}_dispatchTouchEvent(t){this._sortEventListeners(Xp.TOUCH_ONE_BY_ONE),this._sortEventListeners(Xp.TOUCH_ALL_AT_ONCE);const e=this._getListeners(Xp.TOUCH_ONE_BY_ONE),n=this._getListeners(Xp.TOUCH_ALL_AT_ONCE);if(null===e&&null===n)return;const s=t.getTouches(),o=i.js.array.copy(s),r={event:t,needsMutableSet:e&&n,touches:o,selTouch:null};if(e)for(let n=0;n<s.length;++n){const i=s[n];t.touch=i,t.propagationStopped=t.propagationImmediateStopped=!1,this._dispatchEventToListeners(e,this._onTouchEventCallback,r)}n&&o.length>0&&(this._dispatchEventToListeners(n,this._onTouchesEventCallback,{event:t,touches:o}),t.isStopped())||this._updateTouchListeners(t)}_onTouchesEventCallback(t,e){if(!t._isRegistered())return!1;const n=e.event,i=e.touches,s=n.getEventCode();return n.currentTarget=t._getSceneGraphPriority(),s===Mp.TOUCH_START&&t.onTouchesBegan?t.onTouchesBegan(i,n):s===Mp.TOUCH_MOVE&&t.onTouchesMoved?t.onTouchesMoved(i,n):s===Mp.TOUCH_END&&t.onTouchesEnded?t.onTouchesEnded(i,n):s===Mp.TOUCH_CANCEL&&t.onTouchesCancelled&&t.onTouchesCancelled(i,n),!!n.isStopped()&&(Kp._updateTouchListeners(n),!0)}_associateNodeAndEventListener(t,e){let n=this._nodeListenersMap[t.uuid];n||(n=[],this._nodeListenersMap[t.uuid]=n),n.push(e)}_dissociateNodeAndEventListener(t,e){const n=this._nodeListenersMap[t.uuid];n&&(i.js.array.remove(n,e),0===n.length&&delete this._nodeListenersMap[t.uuid])}_dispatchEventToListeners(t,e,n){let i=!1;const s=t.getFixedPriorityListeners(),o=t.getSceneGraphPriorityListeners();let r=0;if(s&&0!==s.length)for(;r<t.gt0Index;++r){const t=s[r];if(t.isEnabled()&&!t._isPaused()&&t._isRegistered()&&e(t,n)){i=!0;break}}if(o&&!i)for(let t=0;t<o.length;++t){const s=o[t];if(s.isEnabled()&&!s._isPaused()&&s._isRegistered()&&e(s,n)){i=!0;break}}if(s&&!i)for(;r<s.length;++r){const t=s[r];if(t.isEnabled()&&!t._isPaused()&&t._isRegistered()&&e(t,n)){i=!0;break}}}_setDirty(t,e){const n=this._priorityDirtyFlagMap;null==n[t]?n[t]=e:n[t]|=e}_sortNumberAsc(t,e){return t-e}_removeListenerInCallback(t,e){if(null==t)return!1;for(let n=t.length-1;n>=0;n--){const s=t[n];if(s._onCustomEvent===e||s.onEvent===e)return s._setRegistered(!1),null!=s._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(s._getSceneGraphPriority(),s),s._setSceneGraphPriority(null)),0===this._inDispatch?i.js.array.removeAt(t,n):this._toRemovedListeners.push(s),!0}return!1}_removeListenerInVector(t,e){if(null==t)return!1;for(let n=t.length-1;n>=0;n--){const s=t[n];if(s===e)return s._setRegistered(!1),null!=s._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(s._getSceneGraphPriority(),s),s._setSceneGraphPriority(null)),0===this._inDispatch?i.js.array.removeAt(t,n):this._toRemovedListeners.push(s),!0}return!1}});i.eventManager=Kp;const $p=new qe;class Zp extends cu{constructor(t,e,n){super(cu.MOUSE,e),this.movementX=0,this.movementY=0,this.eventType=void 0,this._button=Zp.BUTTON_MISSING,this._x=0,this._y=0,this._prevX=0,this._prevY=0,this._scrollX=0,this._scrollY=0,this.eventType=t,n&&(this._prevX=n.x,this._prevY=n.y)}setScrollData(t,e){this._scrollX=t,this._scrollY=e}getScrollX(){return this._scrollX}getScrollY(){return this._scrollY}setLocation(t,e){this._x=t,this._y=e}getLocation(t){return t||(t=new qe),qe.set(t,this._x,this._y),t}getLocationInView(t){return t||(t=new qe),qe.set(t,this._x,i.view._designResolutionSize.height-this._y),t}getUILocation(t){return t||(t=new qe),qe.set(t,this._x,this._y),i.view._convertPointWithScale(t),t}getPreviousLocation(t){return t||(t=new qe),qe.set(t,this._prevX,this._prevY),t}getUIPreviousLocation(t){return t||(t=new qe),qe.set(t,this._prevX,this._prevY),i.view._convertPointWithScale(t),t}getDelta(t){return t||(t=new qe),qe.set(t,this._x-this._prevX,this._y-this._prevY),t}getDeltaX(){return this._x-this._prevX}getDeltaY(){return this._y-this._prevY}getUIDelta(t){return t||(t=new qe),qe.set(t,(this._x-this._prevX)/i.view.getScaleX(),(this._y-this._prevY)/i.view.getScaleY()),t}getUIDeltaX(){return(this._x-this._prevX)/i.view.getScaleX()}getUIDeltaY(){return(this._y-this._prevY)/i.view.getScaleY()}setButton(t){this._button=t}getButton(){return this._button}getLocationX(){return this._x}getLocationY(){return this._y}getUILocationX(){const t=i.view.getViewportRect();return(this._x-t.x)/i.view.getScaleX()}getUILocationY(){const t=i.view.getViewportRect();return(this._y-t.y)/i.view.getScaleY()}}t("EventMouse",Zp),Zp.BUTTON_MISSING=-1,Zp.BUTTON_LEFT=0,Zp.BUTTON_RIGHT=2,Zp.BUTTON_MIDDLE=1,Zp.BUTTON_4=3,Zp.BUTTON_5=4,Zp.BUTTON_6=5,Zp.BUTTON_7=6,Zp.BUTTON_8=7;class Jp extends cu{constructor(t,e,n,i){super(cu.TOUCH,e),this.touch=null,this.simulate=!1,this._eventCode=void 0,this._touches=void 0,this._allTouches=void 0,this._eventCode=n||"",this._touches=t||[],this._allTouches=i||[]}getEventCode(){return this._eventCode}getTouches(){return this._touches}getAllTouches(){return this._allTouches}setLocation(t,e){this.touch&&this.touch.setTouchInfo(this.touch.getID(),t,e)}getLocation(t){return this.touch?this.touch.getLocation(t):new qe}getUILocation(t){return this.touch?this.touch.getUILocation(t):new qe}getLocationInView(t){return this.touch?this.touch.getLocationInView(t):new qe}getPreviousLocation(t){return this.touch?this.touch.getPreviousLocation(t):new qe}getStartLocation(t){return this.touch?this.touch.getStartLocation(t):new qe}getUIStartLocation(t){return this.touch?this.touch.getUIStartLocation(t):new qe}getID(){return this.touch?this.touch.getID():null}getDelta(t){return this.touch?this.touch.getDelta(t):new qe}getUIDelta(t){return this.touch?this.touch.getUIDelta(t):new qe}getDeltaX(){return this.touch?this.touch.getDelta($p).x:0}getDeltaY(){return this.touch?this.touch.getDelta($p).y:0}getLocationX(){return this.touch?this.touch.getLocationX():0}getLocationY(){return this.touch?this.touch.getLocationY():0}}t("EventTouch",Jp),Jp.MAX_TOUCHES=5;class Qp extends cu{constructor(t,e){super(cu.ACCELERATION,e),this.acc=void 0,this.acc=t}}t("EventAcceleration",Qp);class tf extends cu{constructor(t,e,n){super(cu.KEYBOARD,n),this.keyCode=void 0,this.rawEvent=void 0,this.isPressed=void 0,"number"==typeof t?this.keyCode=t:(this.keyCode=t.keyCode,this.rawEvent=t),this.isPressed=e}}t("EventKeyboard",tf),cu.EventMouse=Zp,cu.EventTouch=Jp,cu.EventAcceleration=Qp,cu.EventKeyboard=tf;const ef=new qe;class nf{get lastModified(){return this._lastModified}constructor(t,e,n=0){this._point=new qe,this._prevPoint=new qe,this._lastModified=0,this._id=0,this._startPoint=new qe,this._startPointCaptured=!1,this.setTouchInfo(n,t,e)}getLocation(t){return t||(t=new qe),t.set(this._point.x,this._point.y),t}getLocationX(){return this._point.x}getLocationY(){return this._point.y}getUILocation(t){return t||(t=new qe),t.set(this._point.x,this._point.y),i.view._convertPointWithScale(t),t}getUILocationX(){const t=i.view.getViewportRect();return(this._point.x-t.x)/i.view.getScaleX()}getUILocationY(){const t=i.view.getViewportRect();return(this._point.y-t.y)/i.view.getScaleY()}getPreviousLocation(t){return t||(t=new qe),t.set(this._prevPoint.x,this._prevPoint.y),t}getUIPreviousLocation(t){return t||(t=new qe),t.set(this._prevPoint.x,this._prevPoint.y),i.view._convertPointWithScale(t),t}getStartLocation(t){return t||(t=new qe),t.set(this._startPoint.x,this._startPoint.y),t}getUIStartLocation(t){return t||(t=new qe),t.set(this._startPoint.x,this._startPoint.y),i.view._convertPointWithScale(t),t}getDelta(t){return t||(t=new qe),t.set(this._point),t.subtract(this._prevPoint),t}getUIDelta(t){return t||(t=new qe),ef.set(this._point),ef.subtract(this._prevPoint),t.set(i.view.getScaleX(),i.view.getScaleY()),qe.divide(t,ef,t),t}getLocationInView(t){return t||(t=new qe),t.set(this._point.x,i.view._designResolutionSize.height-this._point.y),t}getPreviousLocationInView(t){return t||(t=new qe),t.set(this._prevPoint.x,i.view._designResolutionSize.height-this._prevPoint.y),t}getStartLocationInView(t){return t||(t=new qe),t.set(this._startPoint.x,i.view._designResolutionSize.height-this._startPoint.y),t}getID(){return this._id}setTouchInfo(t=0,e,n){this._prevPoint=this._point,this._point=new qe(e||0,n||0),this._id=t,this._startPointCaptured||(this._startPoint=new qe(this._point),this._startPointCaptured=!0)}setPoint(t,e){"object"==typeof t?(this._point.x=t.x,this._point.y=t.y):(this._point.x=t||0,this._point.y=e||0),this._lastModified=i.director.getCurrentTime()}setPrevPoint(t,e){this._prevPoint="object"==typeof t?new qe(t.x,t.y):new qe(t||0,e||0),this._lastModified=i.director.getCurrentTime()}}t("Touch",nf),i.Touch=nf;class sf{constructor(t=0,e=0,n=0,i=0){this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=t,this.y=e,this.z=n,this.timestamp=i}}const of=Lt.TOUCH_TIMEOUT,rf=new qe,af=new qe,cf=new class{constructor(){this._isRegisterEvent=!1,this._preTouchPoint=new qe,this._prevMousePoint=new qe,this._preTouchPool=[],this._preTouchPoolPointer=0,this._touches=[],this._touchesIntegerDict={},this._indexBitsUsed=0,this._maxTouches=8,this._glView=null}handleTouchesBegin(t){const e=[],n=this._touchesIntegerDict;for(let i=0;i<t.length;++i){const s=t[i],o=s.getID();if(null!==o&&void 0===n[o]){const t=this._getUnUsedIndex();if(-1===t){S(2300,t);continue}s.getLocation(rf);const i=new nf(rf.x,rf.y,o);this._touches[t]=i,s.getPreviousLocation(rf),i.setPrevPoint(rf),n[o]=t,e.push(i)}}if(e.length>0){const t=new Jp(e,!1,Mp.TOUCH_START,Lt.ENABLE_MULTI_TOUCH?this._getUsefulTouches():e);Kp.dispatchEvent(t)}}handleTouchesMove(t){const e=[],n=this._touches;for(let i=0;i<t.length;++i){const s=t[i],o=s.getID();if(null===o)continue;const r=this._touchesIntegerDict[o];void 0!==r&&n[r]&&(s.getLocation(rf),n[r].setPoint(rf),s.getPreviousLocation(rf),n[r].setPrevPoint(rf),e.push(n[r]))}if(e.length>0){const t=new Jp(e,!1,Mp.TOUCH_MOVE,Lt.ENABLE_MULTI_TOUCH?this._getUsefulTouches():e);Kp.dispatchEvent(t)}}handleTouchesEnd(t){const e=this.getSetOfTouchesEndOrCancel(t);if(e.length>0){const t=new Jp(e,!1,Mp.TOUCH_END,Lt.ENABLE_MULTI_TOUCH?this._getUsefulTouches():e);Kp.dispatchEvent(t)}this._preTouchPool.length=0}handleTouchesCancel(t){const e=this.getSetOfTouchesEndOrCancel(t);if(e.length>0){const t=new Jp(e,!1,Mp.TOUCH_CANCEL,Lt.ENABLE_MULTI_TOUCH?this._getUsefulTouches():e);Kp.dispatchEvent(t)}this._preTouchPool.length=0}getSetOfTouchesEndOrCancel(t){const e=[],n=this._touches,i=this._touchesIntegerDict;for(let s=0;s<t.length;++s){const o=t[s],r=o.getID();if(null===r)continue;const a=i[r];void 0!==a&&n[a]&&(o.getLocation(rf),n[a].setPoint(rf),o.getPreviousLocation(rf),n[a].setPrevPoint(rf),e.push(n[a]),this._removeUsedIndexBit(a),delete i[r])}return e}_getPreTouch(t){let e=null;const n=this._preTouchPool,i=t.getID();for(let t=n.length-1;t>=0;t--)if(n[t].getID()===i){e=n[t];break}return e||(e=t),e}_setPreTouch(t){let e=!1;const n=this._preTouchPool,i=t.getID();for(let s=n.length-1;s>=0;s--)if(n[s].getID()===i){n[s]=t,e=!0;break}e||(n.length<=50?n.push(t):(n[this._preTouchPoolPointer]=t,this._preTouchPoolPointer=(this._preTouchPoolPointer+1)%50))}_getViewPixelRatio(){return this._glView?this._glView._devicePixelRatio:1}_getTouch(t){const e=this._preTouchPoint,n=this._getViewPixelRatio(),i=t.x*n,s=t.y*n,o=new nf(i,s,0);return o.setPrevPoint(e.x,e.y),e.x=i,e.y=s,o}_getMouseEvent(t){const e=this._prevMousePoint,n=new Zp(t.type,!1,e),s=this._getViewPixelRatio();return e.x=t.x*s,e.y=t.y*s,i.GAME_VIEW&&(e.x/=i.gameView.canvas.width/i.game.canvas.width,e.y/=i.gameView.canvas.height/i.game.canvas.height),n.setLocation(e.x,e.y),n.setButton(t.button),t.movementX&&(n.movementX=t.movementX),t.movementY&&(n.movementY=t.movementY),n}_getTouchList(t){const e=[],n=this._preTouchPoint,i=t.changedTouches.length,s=this._getViewPixelRatio();for(let o=0;o<i;o++){const i=t.changedTouches[o],r=i.x*s,a=i.y*s,c=new nf(r,a,i.identifier);if(this._getPreTouch(c).getLocation(af),c.setPrevPoint(af.x,af.y),this._setPreTouch(c),n.x=r,n.y=a,e.push(c),!Lt.ENABLE_MULTI_TOUCH)break}return e}_getUnUsedIndex(){let t=this._indexBitsUsed;const e=i.director.getCurrentTime();for(let n=0;n<this._maxTouches;n++){if(!(1&t))return this._indexBitsUsed|=1<<n,n;{const t=this._touches[n];if(e-t.lastModified>of){this._removeUsedIndexBit(n);const e=t.getID();return null!==e&&delete this._touchesIntegerDict[e],n}}t>>=1}return-1}_removeUsedIndexBit(t){if(t<0||t>=this._maxTouches)return;let e=1<<t;e=~e,this._indexBitsUsed&=e}_getUsefulTouches(){const t=[],e=this._touchesIntegerDict;for(const n in e){const i=e[parseInt(n)];if(null==i)continue;const s=this._touches[i];t.push(s)}return t}setAccelerometerEnabled(t){t?Up._accelerometer.start():Up._accelerometer.stop()}setAccelerometerInterval(t){Up._accelerometer.setInterval(t)}registerSystemEvent(){this._isRegisterEvent||(this._glView=i.view,Up._mouse.support&&this._registerMouseEvents(),Up._touch.support&&this._registerTouchEvents(),Up._keyboard.support&&this._registerKeyboardEvent(),Up._accelerometer.support&&this._registerAccelerometerEvent(),this._isRegisterEvent=!0)}_registerMouseEvents(){Up._mouse.onDown((t=>{const e=this._getMouseEvent(t),n=this._getTouch(t);this.handleTouchesBegin([n]),Kp.dispatchEvent(e)})),Up._mouse.onMove((t=>{const e=this._getMouseEvent(t),n=this._getTouch(t);this.handleTouchesMove([n]),Kp.dispatchEvent(e)})),Up._mouse.onUp((t=>{const e=this._getMouseEvent(t),n=this._getTouch(t);this.handleTouchesEnd([n]),Kp.dispatchEvent(e)})),Up._mouse.onWheel((t=>{const e=this._getMouseEvent(t);e.setScrollData(t.deltaX,t.deltaY),Kp.dispatchEvent(e)}))}_registerTouchEvents(){Up._touch.onStart((t=>{const e=this._getTouchList(t);this.handleTouchesBegin(e)})),Up._touch.onMove((t=>{const e=this._getTouchList(t);this.handleTouchesMove(e)})),Up._touch.onEnd((t=>{const e=this._getTouchList(t);this.handleTouchesEnd(e)})),Up._touch.onCancel((t=>{const e=this._getTouchList(t);this.handleTouchesCancel(e)}))}_registerKeyboardEvent(){Up._keyboard.onDown((t=>{Kp.dispatchEvent(new tf(t.code,!0))})),Up._keyboard.onUp((t=>{Kp.dispatchEvent(new tf(t.code,!1))}))}_registerAccelerometerEvent(){Up._accelerometer.onChange((t=>{const{x:e,y:n,z:i,timestamp:s}=t;Kp.dispatchEvent(new Qp(new sf(e,n,i,s)))}))}};i.internal.inputManager=cf;const lf=It({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),hf=lf.LAYERED+1;class _f{set enabled(t){Ps.set(this._handle,Cs.ENABLE,t?1:0),t||Ps.set(this._handle,Cs.TYPE,hf),t?this.activate():this._updatePipeline()}get enabled(){return Ps.get(this._handle,Cs.ENABLE)}set fogColor(t){this._fogColor.set(t),An.toArray(this._colorArray,this._fogColor),Ps.setVec4(this._handle,Cs.COLOR,this._fogColor)}get fogColor(){return this._fogColor}get type(){return Ps.get(this._handle,Cs.TYPE)}set type(t){Ps.set(this._handle,Cs.TYPE,this.enabled?t:hf),this.enabled&&this._updatePipeline()}get fogDensity(){return Ps.get(this._handle,Cs.DENSITY)}set fogDensity(t){Ps.set(this._handle,Cs.DENSITY,t)}get fogStart(){return Ps.get(this._handle,Cs.START)}set fogStart(t){Ps.set(this._handle,Cs.START,t)}get fogEnd(){return Ps.get(this._handle,Cs.END)}set fogEnd(t){Ps.set(this._handle,Cs.END,t)}get fogAtten(){return Ps.get(this._handle,Cs.ATTEN)}set fogAtten(t){Ps.set(this._handle,Cs.ATTEN,t)}get fogTop(){return Ps.get(this._handle,Cs.TOP)}set fogTop(t){Ps.set(this._handle,Cs.TOP,t)}get fogRange(){return Ps.get(this._handle,Cs.RANGE)}set fogRange(t){Ps.set(this._handle,Cs.RANGE,t)}get colorArray(){return this._colorArray}get handle(){return this._handle}constructor(){this._fogColor=new An("#C8C8C8"),this._colorArray=new Float32Array([.2,.2,.2,1]),this._handle=0,this._handle=Ps.alloc()}initialize(t){Ps.set(this._handle,Cs.ENABLE,t.enabled?1:0),Ps.set(this._handle,Cs.TYPE,t.enabled?t.type:hf),this._fogColor.set(t.fogColor),An.toArray(this._colorArray,this._fogColor),Ps.setVec4(this._handle,Cs.COLOR,this._fogColor),Ps.set(this._handle,Cs.DENSITY,t.fogDensity),Ps.set(this._handle,Cs.START,t.fogStart),Ps.set(this._handle,Cs.END,t.fogEnd),Ps.set(this._handle,Cs.ATTEN,t.fogAtten),Ps.set(this._handle,Cs.TOP,t.fogTop),Ps.set(this._handle,Cs.RANGE,t.fogRange)}activate(){this._updatePipeline()}_updatePipeline(){const t=i.director.root,e=this.enabled?this.type:hf,n=t.pipeline;n.macros.CC_USE_FOG!==e&&(n.macros.CC_USE_FOG=e,t.onGlobalPipelineStateChanged())}destroy(){this._handle&&(Ps.free(this._handle),this._handle=0)}}var uf,df,pf,ff,mf,gf,vf,yf;i.Fog=_f;let xf=t("EffectAsset",i_("cc.EffectAsset")((yf=vf=class t extends lu{constructor(...t){super(...t),Xh(this,"techniques",pf,this),Xh(this,"shaders",ff,this),Xh(this,"combinations",mf,this),Xh(this,"hideInEditor",gf,this)}static register(e){t._effects[e.name]=e}static remove(e){if(t._effects[e])delete t._effects[e];else for(const n in t._effects)if(t._effects[n]._uuid===e)return void delete t._effects[n]}static get(e){if(t._effects[e])return t._effects[e];for(const n in t._effects)if(t._effects[n]._uuid===e)return t._effects[n];return null}static getAll(){return t._effects}onLoaded(){xp.register(this),t.register(this),i.game.once(i.Game.EVENT_ENGINE_INITED,this._precompile,this)}_precompile(){const t=i.director.root;for(let e=0;e<this.shaders.length;e++){const n=this.shaders[e],i=this.combinations[e];i&&Object.keys(i).reduce(((t,e)=>t.reduce(((t,n)=>{const s=i[e];for(let i=0;i<s.length;++i){const o={...n};o[e]=s[i],t.push(o)}return t}),[])),[{}]).forEach((e=>xp.getGFXShader(t.device,n.name,e,t.pipeline)))}}destroy(){return t.remove(this.name),super.destroy()}initDefault(e){super.initDefault(e);const n=t.get("unlit");this.name="unlit",this.shaders=n.shaders,this.combinations=n.combinations,this.techniques=n.techniques}validate(){return this.techniques.length>0&&this.shaders.length>0}},vf._effects={},pf=Yh((df=yf).prototype,"techniques",[c_,m_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ff=Yh(df.prototype,"shaders",[c_,m_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mf=Yh(df.prototype,"combinations",[c_,m_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gf=Yh(df.prototype,"hideInEditor",[c_,l_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),uf=df))||uf);var Sf,Tf,Ef,Af,Cf,bf,Pf,wf,Df;i.EffectAsset=xf;const If=new V("RenderTex"),Rf=new qr;Rf.endAccesses=[Qo.FRAGMENT_SHADER_READ_TEXTURE];const Of=new Xr,Mf=new Kr([Rf],Of),Nf={width:1,height:1,renderPassInfo:Mf};let Lf=t("RenderTexture",(Sf=i_("cc.RenderTexture"),Tf=S_(),Ef=T_(),Af=S_(),Cf=T_(),Sf((wf=Yh((Pf=class extends lu{constructor(){super(),Xh(this,"_width",wf,this),Xh(this,"_height",Df,this),this._textureHash=0,this._id=void 0,this._window=null,this._id=If.getNewId(),this._textureHash=Na(this._id,666)}getHash(){return this._textureHash}get width(){return this._width}get height(){return this._height}get window(){return this._window}initialize(t){this._name=t.name||"",this._width=t.width,this._height=t.height,this._initWindow(t)}reset(t){this.initialize(t)}destroy(){return this._window&&(i.director.root.destroyWindow(this._window),this._window=null),super.destroy()}resize(t,e){this._width=t,this._height=e,this._window&&this._window.resize(t,e),this.emit("resize",this._window)}getGFXTexture(){return this._window&&this._window.framebuffer.colorTextures[0]}getGFXSampler(){const t=i.director.root;return bu.getSampler(t.device,Tu)}getSamplerHash(){return Tu}onLoaded(){this._initWindow(),this.loaded=!0,this.emit("load")}_initWindow(t){const e=i.director.root;Nf.title=this._name,Nf.width=this._width,Nf.height=this._height,Nf.renderPassInfo=t&&t.passInfo?t.passInfo:Mf,this._window?(this._window.destroy(),this._window.initialize(e.device,Nf)):this._window=e.createWindow(Nf)}initDefault(t){super.initDefault(t),this._width=this._height=1,this._initWindow()}validate(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048}}).prototype,"_width",[c_,Tf,Ef],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Df=Yh(Pf.prototype,"_height",[c_,Af,Cf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),bf=Pf))||bf));var Bf,Ff,zf,Uf,Hf,Gf,Vf,jf,Wf;i.RenderTexture=Lf;let kf=t("Material",(Bf=i_("cc.Material"),Ff=O_(xf),Bf((Hf=Yh((Uf=class t extends lu{static getHash(t){let e=0;for(const n of t.passes)e^=n.hash;return e}constructor(){super(),Xh(this,"_effectAsset",Hf,this),Xh(this,"_techIdx",Gf,this),Xh(this,"_defines",Vf,this),Xh(this,"_states",jf,this),Xh(this,"_props",Wf,this),this._passes=[],this._hash=0,this.loaded=!1}get effectAsset(){return this._effectAsset}get effectName(){return this._effectAsset?this._effectAsset.name:""}get technique(){return this._techIdx}get passes(){return this._passes}get hash(){return this._hash}get parent(){return null}get owner(){return null}initialize(t){this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),void 0!==t.technique&&(this._techIdx=t.technique),t.effectAsset?this._effectAsset=t.effectAsset:t.effectName&&(this._effectAsset=xf.get(t.effectName)),t.defines&&this._prepareInfo(t.defines,this._defines),t.states&&this._prepareInfo(t.states,this._states),this._update()}reset(t){this.initialize(t)}destroy(){return this._doDestroy(),super.destroy()}recompileShaders(t,e){console.warn(`Shaders in material asset '${this.name}' cannot be modified at runtime, please instantiate the material first.`)}overridePipelineStates(t,e){console.warn(`Pipeline states in material asset '${this.name}' cannot be modified at runtime, please instantiate the material first.`)}onLoaded(){this._update(),this.loaded=!0,this.emit("load")}resetUniforms(t=!0){this._props.length=this._passes.length;for(let t=0;t<this._props.length;t++)this._props[t]={};if(t)for(const t of this._passes)t.resetUBOs(),t.resetTextures()}setProperty(t,e,n){let i=!1;if(void 0===n){const n=this._passes,s=n.length;for(let o=0;o<s;o++){const s=n[o];this._uploadProperty(s,t,e)&&(this._props[s.propertyIndex][t]=e,i=!0)}}else{if(n>=this._passes.length)return void console.warn(`illegal pass index: ${n}.`);const s=this._passes[n];this._uploadProperty(s,t,e)&&(this._props[s.propertyIndex][t]=e,i=!0)}i||console.warn(`illegal property name: ${t}.`)}getProperty(t,e){if(void 0===e){const e=this._props,n=e.length;for(let i=0;i<n;i++){const n=e[i];if(t in n)return n[t]}}else{if(e>=this._props.length)return console.warn(`illegal pass index: ${e}.`),null;const n=this._props[this._passes[e].propertyIndex];if(t in n)return n[t]}return null}copy(t){this._techIdx=t._techIdx,this._props.length=t._props.length;for(let e=0;e<t._props.length;e++)this._props[e]={...t._props[e]};this._defines.length=t._defines.length;for(let e=0;e<t._defines.length;e++)this._defines[e]={...t._defines[e]};this._states.length=t._states.length;for(let e=0;e<t._states.length;e++)this._states[e]={...t._states[e]};this._effectAsset=t._effectAsset,this._update()}_prepareInfo(t,e){let n=t;if(!Array.isArray(n)){const t=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;n=Array(t).fill(n)}for(let t=0;t<n.length;++t)Object.assign(e[t]||(e[t]={}),n[t])}_createPasses(){const t=this._effectAsset.techniques[this._techIdx||0];if(!t)return[];const e=t.passes.length,n=[];for(let s=0;s<e;++s){const e=t.passes[s],o=e.passIndex=s,r=e.defines=this._defines[o]||(this._defines[o]={}),a=e.stateOverrides=this._states[o]||(this._states[o]={});if(void 0!==e.propertyIndex&&(Object.assign(r,this._defines[e.propertyIndex]),Object.assign(a,this._states[e.propertyIndex])),void 0!==e.embeddedMacros&&Object.assign(r,e.embeddedMacros),e.switch&&!r[e.switch])continue;const c=new wp(i.director.root);c.initialize(e),n.push(c)}return n}_update(e=!0){if(this._effectAsset){if(this._passes&&this._passes.length)for(const t of this._passes)t.destroy();this._passes=this._createPasses();const t=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=t,e)this._passes.forEach(((t,e)=>{let n=this._props[e];n||(n=this._props[e]={}),void 0!==t.propertyIndex&&Object.assign(n,this._props[t.propertyIndex]);for(const e in n)this._uploadProperty(t,e,n[e])}));else for(let t=0;t<this._props.length;t++)this._props[t]={}}this._hash=t.getHash(this)}_uploadProperty(t,e,n){const i=t.getHandle(e);if(!i)return!1;const s=wp.getPropertyTypeFromHandle(i);if(s===ep.BUFFER)Array.isArray(n)?t.setUniformArray(i,n):null!==n?t.setUniform(i,n):t.resetUniform(e);else if(s===ep.TEXTURE)if(Array.isArray(n))for(let e=0;e<n.length;e++)this._bindTexture(t,i,n[e],e);else n?this._bindTexture(t,i,n):t.resetTexture(e);return!0}_bindTexture(t,e,n,i){const s=wp.getBindingFromHandle(e);if(n instanceof Va)t.bindTexture(s,n,i);else if(n instanceof Hu||n instanceof Lf){const e=n.getGFXTexture();if(!e||!e.width||!e.height)return;t.bindTexture(s,e,i),t.bindSampler(s,n.getGFXSampler(),i)}}_doDestroy(){if(this._passes&&this._passes.length)for(const t of this._passes)t.destroy();this._effectAsset=null,this._passes.length=0,this._props.length=0,this._defines.length=0,this._states.length=0}initDefault(t){super.initDefault(t),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),this.setProperty("mainColor",new An("#ff00ff"))}validate(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0}}).prototype,"_effectAsset",[Ff],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gf=Yh(Uf.prototype,"_techIdx",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vf=Yh(Uf.prototype,"_defines",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jf=Yh(Uf.prototype,"_states",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Wf=Yh(Uf.prototype,"_props",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zf=Uf))||zf));i.Material=kf;class qf extends wp{get parent(){return this._parent}constructor(t,e){super(t.root),this._parent=void 0,this._owner=void 0,this._dontNotify=!1,this._parent=t,this._owner=e,this._doInit(this._parent,!0);for(let t=0;t<this._shaderInfo.blocks.length;t++){const e=this._shaderInfo.blocks[t],n=this._blocks[e.binding],i=this._parent.blocks[e.binding];n.set(i)}this._rootBufferDirty=!0;const n=this._parent;for(let t=0;t<this._shaderInfo.samplerTextures.length;t++){const e=this._shaderInfo.samplerTextures[t];for(let t=0;t<e.count;t++){const i=n._descriptorSet.getSampler(e.binding,t),s=n._descriptorSet.getTexture(e.binding,t);this._descriptorSet.bindSampler(e.binding,i,t),this._descriptorSet.bindTexture(e.binding,s,t)}}super.tryCompile()}overridePipelineStates(t,e){this._bs.reset(),this._rs.reset(),this._dss.reset(),wp.fillPipelineInfo(this,t),wp.fillPipelineInfo(this,e),this._onStateChange()}tryCompile(t){if(t&&!up(this._defines,t))return!1;const e=super.tryCompile();return this._onStateChange(),e}beginChangeStatesSilently(){this._dontNotify=!0}endChangeStatesSilently(){this._dontNotify=!1}_syncBatchingScheme(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,Vi.set(this._handle,Hi.BATCHING_SCHEME,0)}_onStateChange(){Vi.set(this._handle,Hi.HASH,wp.getPassHash(this,this._hShaderDefault)),this._owner.onPassStateChange(this._dontNotify)}}class Xf extends kf{get parent(){return this._parent}get owner(){return this._owner}constructor(t){super(),this._passes=[],this._parent=void 0,this._owner=void 0,this._subModelIdx=0,this._parent=t.parent,this._owner=t.owner||null,this._subModelIdx=t.subModelIdx||0,this.copy(this._parent)}recompileShaders(t,e){if(this._passes&&this.effectAsset)if(void 0===e)for(const e of this._passes)e.tryCompile(t);else this._passes[e].tryCompile(t)}overridePipelineStates(t,e){if(!this._passes||!this.effectAsset)return;const n=this.effectAsset.techniques[this.technique].passes;if(void 0===e)for(let e=0;e<this._passes.length;e++){const i=this._passes[e],s=this._states[e]||(this._states[e]={});for(const e in t)s[e]=t[e];i.overridePipelineStates(n[i.passIndex],s)}else{const i=this._states[e]||(this._states[e]={});for(const e in t)i[e]=t[e];this._passes[e].overridePipelineStates(n[e],i)}}destroy(){return this._doDestroy(),!0}onPassStateChange(t){this._hash=kf.getHash(this),!t&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)}_createPasses(){const t=[],e=this._parent.passes;if(!e)return t;for(let n=0;n<e.length;++n)t.push(new qf(e[n],this));return t}}let Yf=null,Kf=null;class $f{get model(){return this._model}get enabled(){return As.get(this._handle,Ts.ENABLE)}set enabled(t){t?this.activate():this._updatePipeline(),As.set(this._handle,Ts.ENABLE,t?1:0)}get useIBL(){return As.get(this._handle,Ts.USE_IBL)}set useIBL(t){As.set(this._handle,Ts.USE_IBL,t?1:0),this._updatePipeline()}get isRGBE(){return As.get(this._handle,Ts.IS_RGBE)}set isRGBE(t){t&&(Kf&&Kf.recompileShaders({USE_RGBE_CUBEMAP:t}),this._model&&this._model.setSubModelMaterial(0,Kf)),As.set(this._handle,Ts.IS_RGBE,t?1:0),this._updatePipeline()}get envmap(){return this._envmap}set envmap(t){this._envmap=t||this._default,this._envmap&&(i.director.root.pipeline.pipelineSceneData.ambient.albedoArray[3]=this._envmap.mipmapLevel,this._updateGlobalBinding())}get handle(){return this._handle}constructor(){this._envmap=null,this._globalDescriptorSet=null,this._model=null,this._default=null,this._handle=0,this._handle=As.alloc()}initialize(t){As.set(this._handle,Ts.ENABLE,t.enabled?1:0),As.set(this._handle,Ts.USE_IBL,t.useIBL?1:0),As.set(this._handle,Ts.IS_RGBE,t.isRGBE?1:0),this._envmap=t.envmap}activate(){const t=i.director.root.pipeline,e=t.pipelineSceneData.ambient;if(this._globalDescriptorSet=t.descriptorSet,this._default=Tp.get("default-cube-texture"),this._model||(this._model=i.director.root.createModel(i.renderer.scene.Model),this._model._initLocalDescriptors=()=>{}),As.set(this._handle,Ts.MODEL,this._model.handle),this._envmap||(this._envmap=this._default),e.albedoArray[3]=this._envmap.mipmapLevel,Kf)Kf.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE});else{const t=new kf;t.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:this.isRGBE}}),Kf=new Xf({parent:t})}this.enabled&&(Yf||(Yf=i.utils.createMesh(i.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,Yf.renderingSubMeshes[0],Kf)),this._updateGlobalBinding(),this._updatePipeline()}_updatePipeline(){const t=this.useIBL?this.isRGBE?2:1:0,e=i.director.root,n=e.pipeline;n.macros.CC_USE_IBL!==t&&(n.macros.CC_USE_IBL=t,e.onGlobalPipelineStateChanged())}_updateGlobalBinding(){const t=this.envmap.getGFXTexture(),e=bu.getSampler(i.director._device,this.envmap.getSamplerHash());this._globalDescriptorSet.bindSampler(Xl,e),this._globalDescriptorSet.bindTexture(Xl,t)}destroy(){this._handle&&(As.free(this._handle),this._handle=0)}}i.Skybox=$f;const Zf=It({Planar:0,ShadowMap:1}),Jf=It({HARD:0,FILTER_X5:1,FILTER_X9:2,FILTER_X25:3}),Qf=Zf.ShadowMap+1;class tm{get enabled(){return!!Is.get(this._handle,ws.ENABLE)}set enabled(t){Is.set(this._handle,ws.ENABLE,t?1:0),t||Is.set(this._handle,ws.TYPE,Qf),this.activate()}get normal(){return this._normal}set normal(t){$e.copy(this._normal,t),Is.setVec3(this._handle,ws.NORMAL,this._normal)}get distance(){return Is.get(this._handle,ws.DISTANCE)}set distance(t){Is.set(this._handle,ws.DISTANCE,t)}get shadowColor(){return this._shadowColor}set shadowColor(t){this._shadowColor=t,Is.setVec4(this._handle,ws.COLOR,t)}get type(){return Is.get(this._handle,ws.TYPE)}set type(t){Is.set(this._handle,ws.TYPE,this.enabled?t:Qf),this.activate()}get near(){return Is.get(this._handle,ws.NEAR)}set near(t){Is.set(this._handle,ws.NEAR,t)}get far(){return Is.get(this._handle,ws.FAR)}set far(t){Is.set(this._handle,ws.FAR,t)}get aspect(){return Is.get(this._handle,ws.ASPECT)}set aspect(t){Is.set(this._handle,ws.ASPECT,t)}get orthoSize(){return Is.get(this._handle,ws.ORTHO_SIZE)}set orthoSize(t){Is.set(this._handle,ws.ORTHO_SIZE,t)}get size(){return this._size}set size(t){this._size=t,Is.setVec2(this._handle,ws.SIZE,this._size)}get pcf(){return Is.get(this._handle,ws.PCF_TYPE)}set pcf(t){Is.set(this._handle,ws.PCF_TYPE,t)}get shadowMapDirty(){return!!Is.get(this._handle,ws.SHADOW_MAP_DIRTY)}set shadowMapDirty(t){Is.set(this._handle,ws.SHADOW_MAP_DIRTY,t?1:0)}get bias(){return Is.get(this._handle,ws.BIAS)}set bias(t){Is.set(this._handle,ws.BIAS,t)}get packing(){return!!Is.get(this._handle,ws.PACKING)}set packing(t){Is.set(this._handle,ws.PACKING,t?1:0)}get linear(){return!!Is.get(this._handle,ws.LINEAR)}set linear(t){Is.set(this._handle,ws.LINEAR,t?1:0)}get selfShadow(){return!!Is.get(this._handle,ws.SELF_SHADOW)}set selfShadow(t){Is.set(this._handle,ws.SELF_SHADOW,t?1:0)}get normalBias(){return Is.get(this._handle,ws.NORMAL_BIAS)}set normalBias(t){Is.set(this._handle,ws.NORMAL_BIAS,t)}get autoAdapt(){return!!Is.get(this._handle,ws.AUTO_ADAPT)}set autoAdapt(t){Is.set(this._handle,ws.AUTO_ADAPT,t?1:0)}get matLight(){return this._matLight}get material(){return this._material}get instancingMaterial(){return this._instancingMaterial}get handle(){return this._handle}constructor(){this.sphere=new Ao(0,0,0,.01),this.maxReceived=4,this._normal=new $e(0,1,0),this._shadowColor=new An(0,0,0,76),this._matLight=new pn,this._material=null,this._instancingMaterial=null,this._size=new qe(512,512),this._handle=0,this._handle=Is.alloc()}getPlanarShader(t){return this._material||(this._material=new kf,this._material.initialize({effectName:"planar-shadow"}),Is.set(this._handle,ws.PLANAR_PASS,this._material.passes[0].handle)),this._material.passes[0].getShaderVariant(t)}getPlanarInstanceShader(t){return this._instancingMaterial||(this._instancingMaterial=new kf,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}),Is.set(this._handle,ws.INSTANCE_PASS,this._instancingMaterial.passes[0].handle)),this._instancingMaterial.passes[0].getShaderVariant(t)}initialize(t){Is.set(this._handle,ws.TYPE,t.enabled?t.type:Qf),Is.set(this._handle,ws.NEAR,t.near),Is.set(this._handle,ws.FAR,t.far),Is.set(this._handle,ws.ASPECT,t.aspect),Is.set(this._handle,ws.ORTHO_SIZE,t.orthoSize),this._size=t.shadowMapSize,Is.setVec2(this._handle,ws.SIZE,this._size),Is.set(this._handle,ws.PCF_TYPE,t.pcf),$e.copy(this._normal,t.normal),Is.setVec3(this._handle,ws.NORMAL,this._normal),Is.set(this._handle,ws.DISTANCE,t.distance),this._shadowColor.set(t.shadowColor),Is.setVec4(this._handle,ws.COLOR,this._shadowColor),Is.set(this._handle,ws.BIAS,t.bias),Is.set(this._handle,ws.PACKING,t.packing?1:0),Is.set(this._handle,ws.LINEAR,t.linear?1:0),Is.set(this._handle,ws.SELF_SHADOW,t.selfShadow?1:0),Is.set(this._handle,ws.NORMAL_BIAS,t.normalBias),Is.set(this._handle,ws.ENABLE,t.enabled?1:0),this.maxReceived=t.maxReceived,Is.set(this._handle,ws.AUTO_ADAPT,t.autoAdapt?1:0)}activate(){if(this.enabled)this.type===Zf.ShadowMap?this._updatePipeline():this._updatePlanarInfo();else{const t=i.director.root;t.pipeline.macros.CC_RECEIVE_SHADOW=0,t.onGlobalPipelineStateChanged()}}_updatePlanarInfo(){this._material||(this._material=new kf,this._material.initialize({effectName:"planar-shadow"}),Is.set(this._handle,ws.PLANAR_PASS,this._material.passes[0].handle)),this._instancingMaterial||(this._instancingMaterial=new kf,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}),Is.set(this._handle,ws.INSTANCE_PASS,this._instancingMaterial.passes[0].handle));const t=i.director.root;t.pipeline.macros.CC_RECEIVE_SHADOW=0,t.onGlobalPipelineStateChanged()}_updatePipeline(){const t=i.director.root;t.pipeline.macros.CC_RECEIVE_SHADOW=1,t.onGlobalPipelineStateChanged()}destroy(){this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this._handle&&(Is.free(this._handle),this._handle=0),this.sphere.destroy()}}tm.MAX_FAR=2e3,tm.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),i.Shadows=tm;class em{get handle(){return this._handle}get isHDR(){return Ms.get(this._handle,Rs.IS_HDR)}set isHDR(t){Ms.set(this._handle,Rs.IS_HDR,t?1:0)}get shadingScale(){return Ms.get(this._handle,Rs.SHADING_SCALE)}set shadingScale(t){Ms.set(this._handle,Rs.SHADING_SCALE,t)}get fpScale(){return Ms.get(this._handle,Rs.FP_SCALE)}set fpScale(t){Ms.set(this._handle,Rs.FP_SCALE,t)}constructor(){this.fog=new _f,this.ambient=new io,this.skybox=new $f,this.shadows=new tm,this.renderObjects=[],this.shadowObjects=[],this.shadowFrameBufferMap=new Map,this._handle=Ms.alloc(),Ms.set(this._handle,Rs.AMBIENT,this.ambient.handle),Ms.set(this._handle,Rs.SKYBOX,this.skybox.handle),Ms.set(this._handle,Rs.FOG,this.fog.handle),Ms.set(this._handle,Rs.SHADOW,this.shadows.handle),Ms.set(this._handle,Rs.IS_HDR,0),Ms.set(this._handle,Rs.SHADING_SCALE,1),Ms.set(this._handle,Rs.FP_SCALE,1/1024)}get deferredLightPassHandle(){return Ms.get(this._handle,Rs.DEFERRED_LIGHT_PASS)}get deferredLightPassShaderHandle(){return Ms.get(this._handle,Rs.DEFERRED_LIGHT_PASS_SHADER)}get deferredPostPassHandle(){return Ms.get(this._handle,Rs.DEFERRED_POST_PASS)}get deferredPostPassShaderHandle(){return Ms.get(this._handle,Rs.DEFERRED_POST_PASS_SHADER)}initDeferredPassInfo(){const t=Tp.get("builtin-deferred-material");if(t){const e=t.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}const e=Tp.get("builtin-post-process-material");if(e){const t=e.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently()}if(t){const e=t.passes[0];Ms.set(this._handle,Rs.DEFERRED_LIGHT_PASS,e.handle),Ms.set(this._handle,Rs.DEFERRED_LIGHT_PASS_SHADER,e.getShaderVariant())}if(e){const t=e.passes[0];Ms.set(this._handle,Rs.DEFERRED_POST_PASS,t.handle),Ms.set(this._handle,Rs.DEFERRED_POST_PASS_SHADER,t.getShaderVariant())}}activate(t,e){return this._device=t,this._pipeline=e,this.initDeferredPassInfo(),!0}destroy(){this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this._handle&&Ms.free(this._handle)}}nr.getPhaseID=Ep;const nm=t("RenderPipeline",nr.RenderPipeline),im=(t("RenderFlow",nr.RenderFlow),t("RenderStage",nr.RenderStage),t("InstancedBuffer",nr.InstancedBuffer),t("PipelineStateManager",nr.PipelineStateManager));let sm=nr.InstancedBuffer,om=sm.get;sm.get=function(t){return om.call(this,t.handle)};let rm=nr.PipelineStateManager.getOrCreatePipelineState;function am(){const t=new cm;return t.init(),t}nr.PipelineStateManager.getOrCreatePipelineState=function(t,e,n,i,s){return rm.call(this,e.handle,n,i,s)};class cm extends nr.ForwardPipeline{constructor(){super(),this.pipelineSceneData=new em,this._tag=0,this._flows=[],this.renderTextures=[],this.materials=[]}init(){this.setPipelineSharedSceneData(this.pipelineSceneData.handle);for(let t=0;t<this._flows.length;t++)this._flows[t].init();const t=new nr.RenderPipelineInfo(this._tag,this._flows);this.initialize(t)}activate(){return super.activate()&&this.pipelineSceneData.activate(i.director.root.device,this)}render(t){let e=[];for(let n=0,i=t.length;n<i;++n)e.push(t[n].handle);super.render(e)}destroy(){this.pipelineSceneData.destroy(),super.destroy()}}t("ForwardPipeline",cm),cm.prototype.onAfterDeserialize_JSB=cm.prototype.init;class lm extends nr.ForwardFlow{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this._stages=[]}init(){for(let t=0;t<this._stages.length;t++)this._stages[t].init();const t=new nr.RenderFlowInfo(this._name,this._priority,this._tag,this._stages);this.initialize(t)}}t("ForwardFlow",lm);class hm extends nr.ShadowFlow{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this._stages=[]}init(){for(let t=0;t<this._stages.length;t++)this._stages[t].init();const t=new nr.RenderFlowInfo(this._name,this._priority,this._tag,this._stages);this.initialize(t)}}t("ShadowFlow",hm);class _m extends nr.ForwardStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this.renderQueues=[]}init(){const t=[];for(let e=0;e<this.renderQueues.length;e++)t.push(this.renderQueues[e].init());const e=new nr.RenderStageInfo(this._name,this._priority,this._tag,t);this.initialize(e)}}t("ForwardStage",_m);class um extends nr.ShadowStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0}init(){const t=new nr.RenderStageInfo(this._name,this._priority,this._tag,[]);this.initialize(t)}}t("ShadowStage",um);class dm{constructor(){this.isTransparent=!1,this.sortMode=0,this.stages=[],this.isTransparent=!1,this.sortMode=0,this.stages=[]}init(){return new nr.RenderQueueDesc(this.isTransparent,this.sortMode,this.stages)}}t("RenderQueueDesc",dm);class pm extends nr.DeferredPipeline{constructor(){super(),this.pipelineSceneData=new em,this._tag=0,this._flows=[],this.renderTextures=[],this.materials=[]}init(){this.setPipelineSharedSceneData(this.pipelineSceneData.handle);for(let t=0;t<this._flows.length;t++)this._flows[t].init();let t=new nr.RenderPipelineInfo(this._tag,this._flows);this.initialize(t)}activate(){return super.activate()&&this.pipelineSceneData.activate(i.director.root.device,this)}render(t){let e=[];for(let n=0,i=t.length;n<i;++n)e.push(t[n].handle);super.render(e)}destroy(){this.fog.destroy(),this.ambient.destroy(),this.skybox.destroy(),this.shadows.destroy(),this.pipelineSceneData.destroy(),super.destroy()}}t("DeferredPipeline",pm),pm.prototype.onAfterDeserialize_JSB=pm.prototype.init;class fm extends nr.GbufferFlow{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this._stages=[]}init(){for(let t=0;t<this._stages.length;t++)this._stages[t].init();let t=new nr.RenderFlowInfo(this._name,this._priority,this._tag,this._stages);this.initialize(t)}}t("GbufferFlow",fm);class mm extends nr.GbufferStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this.renderQueues=[]}init(){const t=[];for(let e=0;e<this.renderQueues.length;e++)t.push(this.renderQueues[e].init());let e=new nr.RenderStageInfo(this._name,this._priority,this._tag,t);this.initialize(e)}}t("GbufferStage",mm);class gm extends nr.LightingFlow{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this._stages=[]}init(){for(let t=0;t<this._stages.length;t++)this._stages[t].init();let t=new nr.RenderFlowInfo(this._name,this._priority,this._tag,this._stages);this.initialize(t)}}class vm extends nr.LightingStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this.renderQueues=[]}init(){const t=[];for(let e=0;e<this.renderQueues.length;e++)t.push(this.renderQueues[e].init());let e=new nr.RenderStageInfo(this._name,this._priority,this._tag,t);this.initialize(e)}}t("LightingStage",vm);class ym extends nr.PostprocessStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this.renderQueues=[]}init(){const t=[];for(let e=0;e<this.renderQueues.length;e++)t.push(this.renderQueues[e].init());let e=new nr.RenderStageInfo(this._name,this._priority,this._tag,t);this.initialize(e)}}t("PostprocessStage",ym),xt("DeferredPipeline",pm),xt("GbufferFlow",fm),xt("GbufferStage",mm),xt("LightingFlow",gm),xt("LightingStage",vm),xt("PostprocessStage",ym),xt("ForwardPipeline",cm),xt("ForwardFlow",lm),xt("ShadowFlow",hm),xt("ForwardStage",_m),xt("ShadowStage",um),xt("RenderQueueDesc",dm);class xm extends Vn{constructor(...t){super(...t),this.frame=null,this.container=null,this.canvas=null,this.renderType=-1,this.eventTargetOn=super.on,this.eventTargetOnce=super.once,this.config={},this.onStart=null,this.collisionMatrix=[],this.groupList=[],this._persistRootNodes={},this._paused=!0,this._configLoaded=!1,this._isCloning=!1,this._inited=!1,this._engineInited=!1,this._rendererInitialized=!1,this._gfxDevice=null,this._intervalId=null}get inited(){return this._inited}get frameTime(){return this._frameTime}setFrameRate(t){const e=this.config;"number"!=typeof t&&(t=parseInt(t,10),Number.isNaN(t)&&(t=60)),e.frameRate=t,this._paused=!0,this._setAnimFrame(),this._runMainLoop()}getFrameRate(){return this.config.frameRate||0}step(){i.director.mainLoop()}pause(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))}resume(){this._paused&&this._runMainLoop()}isPaused(){return this._paused}restart(){return new Promise((t=>i.director.once(i.Director.EVENT_AFTER_DRAW,(()=>t())))).then((()=>{for(const t in this._persistRootNodes)this.removePersistRootNode(this._persistRootNodes[t]);return i.director.getScene().destroy(),i.Object._deferredDestroy(),i.director.reset(),this.pause(),this._setRenderPipelineNShowSplash().then((()=>{this.resume(),this._safeEmit(xm.EVENT_RESTART)}))}))}end(){this._gfxDevice&&(this._gfxDevice.destroy(),this._gfxDevice=null),window.close()}on(t,e,n,i){return this._engineInited&&t===xm.EVENT_ENGINE_INITED?e.call(n):this.eventTargetOn(t,e,n,i)}once(t,e,n){return this._engineInited&&t===xm.EVENT_ENGINE_INITED?e.call(n):this.eventTargetOnce(t,e,n)}init(t){return this._initConfig(t),this.config.assetOptions&&i.assetManager.init(this.config.assetOptions),this._initEngine().then((()=>(this._initEvents(),i.director.root.dataPoolManager&&i.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(t.customJointTextureLayouts),this._engineInited)))}run(t,e){let n;return"function"!=typeof t&&t?(n=this.init(t),this.onStart=null!=e?e:null):this.onStart=null!=t?t:null,Promise.resolve(n).then((()=>(Sm.config.registerSystemEvent&&cf.registerSystemEvent(),this._setRenderPipelineNShowSplash())))}addPersistRootNode(t){if(!i.Node.isNode(t)||!t.uuid)return void E(3800);const e=t.uuid;if(!this._persistRootNodes[e]){const n=i.director._scene;if(i.isValid(n))if(t.parent){if(!(t.parent instanceof i.Scene))return void E(3801);if(t.parent!==n)return void E(3802);t._originalSceneId=n.uuid}else t.parent=n;this._persistRootNodes[e]=t,t._persistNode=!0,i.assetManager._releaseManager._addPersistNodeRef(t)}}removePersistRootNode(t){const e=t.uuid||"";t===this._persistRootNodes[e]&&(delete this._persistRootNodes[e],t._persistNode=!1,t._originalSceneId="",i.assetManager._releaseManager._removePersistNodeRef(t))}isPersistRootNode(t){return!!t._persistNode}_initEngine(){return this._initDevice(),Promise.resolve(i.director._init()).then((()=>{u(`Cocos Creator v${s}`),this.emit(xm.EVENT_ENGINE_INITED),this._engineInited=!0,i.internal.dynamicAtlasManager.enabled=!Lt.CLEANUP_IMAGE_CACHE}))}_setAnimFrame(){this._lastTime=performance.now();const t=this.config.frameRate;this._frameTime=1e3/t,jsb.setPreferredFramesPerSecond(t),window.rAF=window.requestAnimationFrame,window.cAF=window.cancelAnimationFrame}_stTimeWithRAF(t){const e=performance.now(),n=Math.max(0,e-Sm._lastTime),i=Math.max(0,Sm._frameTime-n),s=window.setTimeout((()=>{window.requestAnimationFrame(t)}),i);return Sm._lastTime=e+i,s}_stTime(t){const e=performance.now(),n=Math.max(0,e-Sm._lastTime),i=Math.max(0,Sm._frameTime-n),s=window.setTimeout(t,i);return Sm._lastTime=e+i,s}_ctTime(t){window.clearTimeout(t)}_runMainLoop(){if(!this._inited)return;const t=this.config,e=i.director;let n;t.frameRate,R(!!t.showFPS),e.startAnimation(),n=t=>{this._intervalId=window.rAF(n),e.mainLoop(t)},this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._intervalId=window.rAF(n),this._paused=!1}_initConfig(t){"number"!=typeof t.debugMode&&(t.debugMode=w.NONE),t.exposeClassName=!!t.exposeClassName,"number"!=typeof t.frameRate&&(t.frameRate=60);const e=t.renderMode;("number"!=typeof e||e>2||e<0)&&(t.renderMode=0),"boolean"!=typeof t.registerSystemEvent&&(t.registerSystemEvent=!0),t.showFPS=!!t.showFPS,this.collisionMatrix=t.collisionMatrix||[],this.groupList=t.groupList||[],g(t.debugMode),this.config=t,this._configLoaded=!0,this._setAnimFrame()}_determineRenderType(){const t=this.config,e=parseInt(t.renderMode,10);this.renderType=xm.RENDER_TYPE_CANVAS;let n=!1;if(0===e?i.sys.capabilities.opengl?(this.renderType=xm.RENDER_TYPE_WEBGL,n=!0):i.sys.capabilities.canvas&&(this.renderType=xm.RENDER_TYPE_CANVAS,n=!0):1===e&&i.sys.capabilities.canvas?(this.renderType=xm.RENDER_TYPE_CANVAS,n=!0):2===e&&i.sys.capabilities.opengl&&(this.renderType=xm.RENDER_TYPE_WEBGL,n=!0),!n)throw new Error(D(3820,e))}_initDevice(){if(!this._rendererInitialized){if(this.canvas=this.config.adapter.canvas,this.frame=this.config.adapter.frame,this.container=this.config.adapter.container,this._determineRenderType(),this.renderType===xm.RENDER_TYPE_WEBGL){const t=[];if(window.gfx)this._gfxDevice=gfx.deviceInstance;else{let e=!!window.WebGL2RenderingContext;const n=window.navigator.userAgent.toLowerCase();(-1!==n.indexOf("safari")&&-1===n.indexOf("chrome")||Qn.browserType===jn.UC)&&(e=!1),e&&i.WebGL2Device&&t.push(i.WebGL2Device),i.WebGLDevice&&t.push(i.WebGLDevice);const s=new la(this.canvas,Lt.ENABLE_WEBGL_ANTIALIAS,!1,window.devicePixelRatio,Rp.windowPixelResolution.width,Rp.windowPixelResolution.height,Cl);for(let e=0;e<t.length&&(this._gfxDevice=new t[e],!this._gfxDevice.initialize(s));e++);}}if(!this._gfxDevice)return p("can not support canvas rendering in 3D"),void(this.renderType=xm.RENDER_TYPE_CANVAS);this.canvas.oncontextmenu=()=>!1}}_initEvents(){Qn.onShow(this._onShow.bind(this)),Qn.onHide(this._onHide.bind(this))}_onHide(){this.emit(xm.EVENT_HIDE),this.pause()}_onShow(){this.emit(xm.EVENT_SHOW),this.resume()}_setRenderPipelineNShowSplash(){return Promise.resolve(this._setupRenderPipeline()).then((()=>Promise.resolve(this._showSplashScreen()).then((()=>{this._inited=!0,this._setAnimFrame(),this._runMainLoop(),this._safeEmit(xm.EVENT_GAME_INITED),this.onStart&&this.onStart()}))))}_setupRenderPipeline(){const{renderPipeline:t}=this.config;return t?new Promise(((e,n)=>{i.assetManager.loadAny(t,((t,i)=>!t&&i instanceof nm?e(i):n(t)))})).then((t=>{this._setRenderPipeline(t)})).catch((e=>{d(e),d(`Failed load render pipeline: ${t}, engine failed to initialize, will fallback to default pipeline`),this._setRenderPipeline()})):this._setRenderPipeline()}_showSplashScreen(){if(i.internal.SplashScreen){const t=i.internal.SplashScreen.instance;return t.main(i.director.root),new Promise((e=>{t.setOnFinish((()=>e())),t.loadFinish=!0}))}return null}_setRenderPipeline(t){i.director.root.setRenderPipeline(t)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(xm.EVENT_RENDERER_INITED)}_safeEmit(t){this.emit(t)}}t("Game",xm),xm.EVENT_HIDE="game_on_hide",xm.EVENT_SHOW="game_on_show",xm.EVENT_LOW_MEMORY="game_on_low_memory",xm.EVENT_GAME_INITED="game_inited",xm.EVENT_ENGINE_INITED="engine_inited",xm.EVENT_RENDERER_INITED="renderer_inited",xm.EVENT_RESTART="game_on_restart",xm.RENDER_TYPE_CANVAS=0,xm.RENDER_TYPE_WEBGL=1,xm.RENDER_TYPE_OPENGL=2,i.Game=xm;const Sm=t("game",i.game=new xm),Tm=new class{constructor(){this.html=void 0,this.meta={width:"device-width"},this.adaptationType=i.sys.browserType}init(){this.html=document.getElementsByTagName("html")[0]}availWidth(t){return i.sys.isMobile||!t||t===this.html?window.innerWidth:t.clientWidth}availHeight(t){return i.sys.isMobile||!t||t===this.html?window.innerHeight:t.clientHeight}};switch(Qn.os===Xn.IOS&&(Tm.adaptationType=jn.SAFARI),Tm.adaptationType){case jn.SAFARI:Tm.meta["minimal-ui"]="true",Tm.availWidth=t=>t.clientWidth,Tm.availHeight=t=>t.clientHeight;break;case jn.SOUGOU:case jn.UC:Tm.availWidth=t=>t.clientWidth,Tm.availHeight=t=>t.clientHeight}class Em extends Vn{constructor(){super(),this._resizeWithBrowserSize=void 0,this._designResolutionSize=void 0,this._originalDesignResolutionSize=void 0,this._frameSize=void 0,this._scaleX=void 0,this._scaleY=void 0,this._viewportRect=void 0,this._visibleRect=void 0,this._autoFullScreen=void 0,this._devicePixelRatio=void 0,this._maxPixelRatio=void 0,this._retinaEnabled=void 0,this._resizeCallback=void 0,this._resizing=void 0,this._orientationChanging=void 0,this._isRotated=void 0,this._orientation=void 0,this._isAdjustViewport=void 0,this._resolutionPolicy=void 0,this._rpExactFit=void 0,this._rpShowAll=void 0,this._rpNoBorder=void 0,this._rpFixedHeight=void 0,this._rpFixedWidth=void 0;const t=Am,e=Cm;this._frameSize=new yn(0,0),this._designResolutionSize=new yn(0,0),this._originalDesignResolutionSize=new yn(0,0),this._scaleX=1,this._scaleY=1,this._viewportRect=new Sn(0,0,0,0),this._visibleRect=new Sn(0,0,0,0),this._autoFullScreen=!1,this._devicePixelRatio=1,this._maxPixelRatio=4,this._retinaEnabled=!1,this._resizeCallback=null,this._resizing=!1,this._resizeWithBrowserSize=!1,this._orientationChanging=!0,this._isRotated=!1,this._orientation=i.macro.ORIENTATION_AUTO,this._isAdjustViewport=!0,this._rpExactFit=new bm(t.EQUAL_TO_FRAME,e.EXACT_FIT),this._rpShowAll=new bm(t.EQUAL_TO_FRAME,e.SHOW_ALL),this._rpNoBorder=new bm(t.EQUAL_TO_FRAME,e.NO_BORDER),this._rpFixedHeight=new bm(t.EQUAL_TO_FRAME,e.FIXED_HEIGHT),this._rpFixedWidth=new bm(t.EQUAL_TO_FRAME,e.FIXED_WIDTH),this._resolutionPolicy=this._rpShowAll,i.game.once(i.Game.EVENT_ENGINE_INITED,this.init,this)}init(){Tm.init(),this._initFrameSize();const t=i.game.canvas.width,e=i.game.canvas.height;this._designResolutionSize.width=t,this._designResolutionSize.height=e,this._originalDesignResolutionSize.width=t,this._originalDesignResolutionSize.height=e,this._viewportRect.width=t,this._viewportRect.height=e,this._visibleRect.width=t,this._visibleRect.height=e,i.winSize.width=this._visibleRect.width,i.winSize.height=this._visibleRect.height,i.visibleRect&&i.visibleRect.init(this._visibleRect)}resizeWithBrowserSize(t){t?this._resizeWithBrowserSize||(this._resizeWithBrowserSize=!0,Qn.onViewResize(this._resizeEvent),Qn.onOrientationChange(this._orientationChange)):this._resizeWithBrowserSize&&(this._resizeWithBrowserSize=!1,Qn.offViewResize(this._resizeEvent),Qn.offOrientationChange(this._orientationChange))}setResizeCallback(t){"function"!=typeof t&&null!=t||(this._resizeCallback=t)}setOrientation(t){(t&=i.macro.ORIENTATION_AUTO)&&this._orientation!==t&&(this._orientation=t)}adjustViewportMeta(t){this._isAdjustViewport=t}enableRetina(t){this._retinaEnabled=!!t}isRetinaEnabled(){return this._retinaEnabled}enableAutoFullScreen(t){t&&t!==this._autoFullScreen&&i.sys.isMobile&&Qn.browserType!==jn.WECHAT?(this._autoFullScreen=!0,i.screen.autoFullScreen(i.game.frame)):this._autoFullScreen=!1}isAutoFullScreenEnabled(){return this._autoFullScreen}setCanvasSize(t,e){const n=i.game.canvas,s=i.game.container;this._devicePixelRatio=window.devicePixelRatio,n.width=Rp.windowPixelResolution.width,n.height=Rp.windowPixelResolution.height,n.style.width=`${t}px`,n.style.height=`${e}px`,s.style.width=`${t}px`,s.style.height=`${e}px`,this._resizeEvent()}getCanvasSize(){return new yn(i.game.canvas.width,i.game.canvas.height)}getFrameSize(){return new yn(this._frameSize.width,this._frameSize.height)}setFrameSize(t,e){this._frameSize.width=t,this._frameSize.height=e,i.game.frame.style.width=`${t}px`,i.game.frame.style.height=`${e}px`,this._resizeEvent()}getVisibleSize(){return new yn(this._visibleRect.width,this._visibleRect.height)}getVisibleSizeInPixel(){return new yn(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)}getVisibleOrigin(){return new qe(this._visibleRect.x,this._visibleRect.y)}getVisibleOriginInPixel(){return new qe(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)}getResolutionPolicy(){return this._resolutionPolicy}setResolutionPolicy(t){if(t instanceof bm)this._resolutionPolicy=t;else{const e=bm;t===e.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),t===e.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),t===e.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),t===e.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),t===e.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}}setDesignResolutionSize(t,e,n){if(!(t>0&&e>0))return void C(2200);this.setResolutionPolicy(n);const s=this._resolutionPolicy;if(s&&s.preApply(this),i.sys.isMobile&&this._adjustViewportMeta(),this._orientationChanging=!0,this._resizing||this._initFrameSize(),!s)return void S(2201);this._originalDesignResolutionSize.width=this._designResolutionSize.width=t,this._originalDesignResolutionSize.height=this._designResolutionSize.height=e;const o=s.apply(this,this._designResolutionSize);if(o.scale&&2===o.scale.length&&(this._scaleX=o.scale[0],this._scaleY=o.scale[1]),o.viewport){const t=this._viewportRect,e=this._visibleRect,n=o.viewport;t.x=n.x,t.y=n.y,t.width=n.width,t.height=n.height,e.x=0,e.y=0,e.width=n.width/this._scaleX,e.height=n.height/this._scaleY}s.postApply(this),i.winSize.width=this._visibleRect.width,i.winSize.height=this._visibleRect.height,Op&&Op.init(this._visibleRect),this.emit("design-resolution-changed")}getDesignResolutionSize(){return new yn(this._designResolutionSize.width,this._designResolutionSize.height)}setRealPixelResolution(t,e,n){this.setDesignResolutionSize(t,e,n)}getViewportRect(){return this._viewportRect}getScaleX(){return this._scaleX}getScaleY(){return this._scaleY}getDevicePixelRatio(){return this._devicePixelRatio}convertToLocationInView(t,e,n,s){const o=s||new qe,r=this._devicePixelRatio*(t-n.left),a=this._devicePixelRatio*(n.top+n.height-e);return this._isRotated?(o.x=i.game.canvas.width-a,o.y=r):(o.x=r,o.y=a),i.GAME_VIEW&&(o.x/=i.gameView.canvas.width/i.game.canvas.width,o.y/=i.gameView.canvas.height/i.game.canvas.height),o}_convertPointWithScale(t){const e=this._viewportRect;t.x=(t.x-e.x)/this._scaleX,t.y=(t.y-e.y)/this._scaleY}_resizeEvent(){const t=i.view;if(t._frameSize.width,t._frameSize.height,t._isRotated,i.sys.isMobile){const e=i.game.container.style,n=e.margin;e.margin="0",e.display="none",t._initFrameSize(),e.margin=n,e.display="block"}else t._initFrameSize();const e=t._originalDesignResolutionSize.width,n=t._originalDesignResolutionSize.height;t._resizing=!0,e>0&&t.setDesignResolutionSize(e,n,t._resolutionPolicy),t._resizing=!1,t.emit("canvas-resize"),t._resizeCallback&&t._resizeCallback.call()}_orientationChange(){i.view._orientationChanging=!0,i.view._resizeEvent()}_initFrameSize(){const t=this._frameSize,e=Tm.availWidth(i.game.frame),n=Tm.availHeight(i.game.frame),s=e>=n;!i.sys.isMobile||s&&this._orientation&i.macro.ORIENTATION_LANDSCAPE||!s&&this._orientation&i.macro.ORIENTATION_PORTRAIT?(t.width=e,t.height=n,i.game.container.style["-webkit-transform"]="rotate(0deg)",i.game.container.style.transform="rotate(0deg)",this._isRotated=!1):(t.width=n,t.height=e,i.game.container.style["-webkit-transform"]="rotate(90deg)",i.game.container.style.transform="rotate(90deg)",i.game.container.style["-webkit-transform-origin"]="0px 0px 0px",i.game.container.style.transformOrigin="0px 0px 0px",this._isRotated=!0,i.game.canvas.style["-webkit-transform"]="translateZ(0px)",i.game.canvas.style.transform="translateZ(0px)"),this._orientationChanging&&setTimeout((()=>{i.view._orientationChanging=!1}),1e3)}_adjustSizeKeepCanvasSize(){const t=this._originalDesignResolutionSize.width,e=this._originalDesignResolutionSize.height;t>0&&this.setDesignResolutionSize(t,e,this._resolutionPolicy)}_setViewportMeta(t,e){let n=document.getElementById("cocosMetaElement");n&&e&&document.head.removeChild(n);const i=document.getElementsByName("viewport"),s=i?i[0]:null;let o,r,a;for(r in o=s?s.content:"",n=n||document.createElement("meta"),n.id="cocosMetaElement",n.name="viewport",n.content="",t)-1===o.indexOf(r)?o+=`,${r}=${t[r]}`:e&&(a=new RegExp(`${r}s*=s*[^,]+`),o=o.replace(a,`${r}=${t[r]}`));/^,/.test(o)&&(o=o.substr(1)),n.content=o,s&&(s.content=o),document.head.appendChild(n)}_adjustViewportMeta(){this._isAdjustViewport}_convertMouseToLocation(t,e){t.x=this._devicePixelRatio*(t.x-e.left),t.y=this._devicePixelRatio*(e.top+e.height-t.y),i.GAME_VIEW&&(t.x/=i.gameView.canvas.width/i.game.canvas.width,t.y/=i.gameView.canvas.height/i.game.canvas.height)}_convertTouchWidthScale(t){const e=this._viewportRect,n=this._scaleX,i=this._scaleY;t._point.x=(t._point.x-e.x)/n,t._point.y=(t._point.y-e.y)/i,t._prevPoint.x=(t._prevPoint.x-e.x)/n,t._prevPoint.y=(t._prevPoint.y-e.y)/i}_convertTouchesWithScale(t){const e=this._viewportRect,n=this._scaleX,i=this._scaleY;let s,o;for(let r=0;r<t.length;r++){const a=t[r];s=a._point,o=a._prevPoint,s.x=(s.x-e.x)/n,s.y=(s.y-e.y)/i,o.x=(o.x-e.x)/n,o.y=(o.y-e.y)/i}}}t("View",Em),Em.instance=void 0;class Am{constructor(){this.name="ContainerStrategy"}preApply(t){}apply(t,e){}postApply(t){}_setupContainer(t,e,n){const s=i.game.canvas,o=i.game.container;Qn.os===Xn.ANDROID&&(document.body.style.width=`${t._isRotated?n:e}px`,document.body.style.height=`${t._isRotated?e:n}px`),o.style.width=s.style.width=`${e}px`,o.style.height=s.style.height=`${n}px`,t._devicePixelRatio=1,t.isRetinaEnabled()&&(t._devicePixelRatio=Math.min(t._maxPixelRatio,window.devicePixelRatio||1)),s.width=Rp.windowPixelResolution.width,s.height=Rp.windowPixelResolution.height}_fixContainer(){document.body.insertBefore(i.game.container,document.body.firstChild);const t=document.body.style;t.width=`${window.innerWidth}px`,t.height=`${window.innerHeight}px`,t.overflow="hidden";const e=i.game.container.style;e.position="fixed",e.left=e.top="0px",document.body.scrollTop=0}}Am.EQUAL_TO_FRAME=void 0,Am.PROPORTION_TO_FRAME=void 0;class Cm{constructor(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}preApply(t){}apply(t,e){return{scale:[1,1]}}postApply(t){}_buildResult(t,e,n,i,s,o){Math.abs(t-n)<2&&(n=t),Math.abs(e-i)<2&&(i=e);const r=new Sn(Math.round((t-n)/2),Math.round((e-i)/2),n,i);return this._result.scale=[s,o],this._result.viewport=r,this._result}}Cm.EXACT_FIT=void 0,Cm.SHOW_ALL=void 0,Cm.NO_BORDER=void 0,Cm.FIXED_HEIGHT=void 0,Cm.FIXED_WIDTH=void 0,(()=>{const t=("undefined"==typeof window?global:window).__globalAdapter;t&&(t.adaptContainerStrategy&&t.adaptContainerStrategy(Am.prototype),t.adaptView&&t.adaptView(Em.prototype)),Am.EQUAL_TO_FRAME=new class extends Am{constructor(...t){super(...t),this.name="EqualToFrame"}apply(t){const e=t._frameSize.height,n=i.game.container.style;this._setupContainer(t,t._frameSize.width,t._frameSize.height),t._isRotated?n.margin=`0 0 0 ${e}px`:n.margin="0px",n.padding="0px"}},Am.PROPORTION_TO_FRAME=new class extends Am{constructor(...t){super(...t),this.name="ProportionalToFrame"}apply(t,e){const n=t._frameSize.width,s=t._frameSize.height,o=i.game.container.style,r=e.width,a=e.height,c=n/r,l=s/a;let h,_;c<l?(h=n,_=a*c):(h=r*l,_=s);const u=Math.round((n-h)/2),d=Math.round((s-_)/2);h=n-2*u,_=s-2*d,this._setupContainer(t,h,_),t._isRotated?o.margin=`0 0 0 ${s}px`:o.margin="0px",o.paddingLeft=`${u}px`,o.paddingRight=`${u}px`,o.paddingTop=`${d}px`,o.paddingBottom=`${d}px`}},Cm.EXACT_FIT=new class extends Cm{constructor(...t){super(...t),this.name="ExactFit"}apply(t,e){const n=i.game.canvas.width,s=i.game.canvas.height,o=n/e.width,r=s/e.height;return this._buildResult(n,s,n,s,o,r)}},Cm.SHOW_ALL=new class extends Cm{constructor(...t){super(...t),this.name="ShowAll"}apply(t,e){const n=i.game.canvas.width,s=i.game.canvas.height,o=e.width,r=e.height,a=n/o,c=s/r;let l,h,_=0;return a<c?(_=a,l=n,h=r*_):(_=c,l=o*_,h=s),this._buildResult(n,s,l,h,_,_)}},Cm.NO_BORDER=new class extends Cm{constructor(...t){super(...t),this.name="NoBorder"}apply(t,e){const n=i.game.canvas.width,s=i.game.canvas.height,o=e.width,r=e.height,a=n/o,c=s/r;let l,h,_;return a<c?(l=c,h=o*l,_=s):(l=a,h=n,_=r*l),this._buildResult(n,s,h,_,l,l)}},Cm.FIXED_HEIGHT=new class extends Cm{constructor(...t){super(...t),this.name="FixedHeight"}apply(t,e){const n=i.game.canvas.width,s=i.game.canvas.height,o=s/e.height,r=n,a=s;return this._buildResult(n,s,r,a,o,o)}},Cm.FIXED_WIDTH=new class extends Cm{constructor(...t){super(...t),this.name="FixedWidth"}apply(t,e){const n=i.game.canvas.width,s=i.game.canvas.height,o=n/e.width,r=n,a=s;return this._buildResult(n,s,r,a,o,o)}}})();class bm{constructor(t,e){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(t),this.setContentStrategy(e)}get canvasSize(){return new qe(i.game.canvas.width,i.game.canvas.height)}preApply(t){this._containerStrategy.preApply(t),this._contentStrategy.preApply(t)}apply(t,e){return this._containerStrategy.apply(t,e),this._contentStrategy.apply(t,e)}postApply(t){this._containerStrategy.postApply(t),this._contentStrategy.postApply(t)}setContainerStrategy(t){t instanceof Am&&(this._containerStrategy=t)}setContentStrategy(t){t instanceof Cm&&(this._contentStrategy=t)}}t("ResolutionPolicy",bm),bm.EXACT_FIT=0,bm.NO_BORDER=1,bm.SHOW_ALL=2,bm.FIXED_HEIGHT=3,bm.FIXED_WIDTH=4,bm.UNKNOWN=5,bm.ContainerStrategy=Am,bm.ContentStrategy=Cm,i.ResolutionPolicy=bm;const Pm=t("view",Em.instance=i.view=new Em);i.winSize=new yn;let wm=null,Dm=null,Im=null,Rm=null;class Om extends Vn{constructor(){super()}setAccelerometerEnabled(t){t&&window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((t=>{S(3520,t),cf.setAccelerometerEnabled("granted"===t)})).catch((t=>{E(3521,t.message),cf.setAccelerometerEnabled(!1)})):cf.setAccelerometerEnabled(t)}setAccelerometerInterval(t){cf.setAccelerometerInterval(t)}on(t,e,n,s){return super.on(t,e,n,s),t!==Mp.KEY_DOWN&&t!==Mp.KEY_UP||wm||(wm=Hp.create({event:Hp.KEYBOARD,onKeyPressed(t,e){e.type=Mp.KEY_DOWN,Mm.emit(e.type,e)},onKeyReleased(t,e){e.type=Mp.KEY_UP,Mm.emit(e.type,e)}}),Kp.addListener(wm,256)),t===Mp.DEVICEMOTION&&(Dm||(Dm=Hp.create({event:Hp.ACCELERATION,callback(t,e){e.type=Mp.DEVICEMOTION,i.systemEvent.emit(e.type,e)}}),Kp.addListener(Dm,256))),t!==Mp.TOUCH_START&&t!==Mp.TOUCH_MOVE&&t!==Mp.TOUCH_END&&t!==Mp.TOUCH_CANCEL||Im||(Im=Hp.create({event:Hp.TOUCH_ONE_BY_ONE,onTouchBegan:(t,e)=>(e.type=Mp.TOUCH_START,i.systemEvent.emit(e.type,t,e),!0),onTouchMoved(t,e){e.type=Mp.TOUCH_MOVE,i.systemEvent.emit(e.type,t,e)},onTouchEnded(t,e){e.type=Mp.TOUCH_END,i.systemEvent.emit(e.type,t,e)},onTouchCancelled(t,e){e.type=Mp.TOUCH_CANCEL,i.systemEvent.emit(e.type,t,e)}}),Kp.addListener(Im,256)),t!==Mp.MOUSE_DOWN&&t!==Mp.MOUSE_MOVE&&t!==Mp.MOUSE_UP&&t!==Mp.MOUSE_WHEEL||Rm||(Rm=Hp.create({event:Hp.MOUSE,onMouseDown(t){t.type=Mp.MOUSE_DOWN,i.systemEvent.emit(t.type,t)},onMouseMove(t){t.type=Mp.MOUSE_MOVE,i.systemEvent.emit(t.type,t)},onMouseUp(t){t.type=Mp.MOUSE_UP,i.systemEvent.emit(t.type,t)},onMouseScroll(t){t.type=Mp.MOUSE_WHEEL,i.systemEvent.emit(t.type,t)}}),Kp.addListener(Rm,256)),e}off(t,e,n){if(super.off(t,e,n),wm&&(t===Mp.KEY_DOWN||t===Mp.KEY_UP)){const t=this.hasEventListener(Mp.KEY_DOWN),e=this.hasEventListener(Mp.KEY_UP);t||e||(Kp.removeListener(wm),wm=null)}if(Dm&&t===Mp.DEVICEMOTION&&(Kp.removeListener(Dm),Dm=null),Im&&(t===Mp.TOUCH_START||t===Mp.TOUCH_MOVE||t===Mp.TOUCH_END||t===Mp.TOUCH_CANCEL)){const t=this.hasEventListener(Mp.TOUCH_START),e=this.hasEventListener(Mp.TOUCH_MOVE),n=this.hasEventListener(Mp.TOUCH_END),i=this.hasEventListener(Mp.TOUCH_CANCEL);t||e||n||i||(Kp.removeListener(Im),Im=null)}if(Rm&&(t===Mp.MOUSE_DOWN||t===Mp.MOUSE_MOVE||t===Mp.MOUSE_UP||t===Mp.MOUSE_WHEEL)){const t=this.hasEventListener(Mp.MOUSE_DOWN),e=this.hasEventListener(Mp.MOUSE_MOVE),n=this.hasEventListener(Mp.MOUSE_UP),i=this.hasEventListener(Mp.MOUSE_WHEEL);t||e||n||i||(Kp.removeListener(Rm),Rm=null)}}}t("SystemEvent",Om),Om.EventType=Mp,i.SystemEvent=Om;const Mm=t("systemEvent",new Om);i.systemEvent=Mm;const Nm=t("screen",{_supportsFullScreen:!1,_onfullscreenchange:null,_onfullscreenerror:null,_preOnFullScreenError:null,_preOnTouch:null,_touchEvent:"",_fn:null,_fnMap:[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement"]],init(){let t,e,n;this._fn={};const i=this._fnMap;let s;for(t=0,e=i.length;t<e;t++)if(n=i[t],n&&void 0!==document[n[1]]){for(t=0,s=n.length;t<s;t++)this._fn[i[0][t]]=n[t];break}this._supportsFullScreen=void 0!==this._fn.requestFullscreen,this._touchEvent="ontouchstart"in window?"touchstart":"mousedown"},get supportsFullScreen(){return this._supportsFullScreen},fullScreen(){return!!this._supportsFullScreen&&void 0!==document[this._fn.fullscreenElement]&&null!==document[this._fn.fullscreenElement]},requestFullScreen(t,e,n){if(!this._supportsFullScreen)return;if(t=t||document.documentElement,e){const t=this._fn.fullscreenchange;this._onfullscreenchange&&document.removeEventListener(t,this._onfullscreenchange),this._onfullscreenchange=e,document.addEventListener(t,e,!1)}if(n){const t=this._fn.fullscreenerror;this._onfullscreenerror&&document.removeEventListener(t,this._onfullscreenerror),this._onfullscreenerror=n,document.addEventListener(t,n,{once:!0})}const i=t[this._fn.requestFullscreen]();return window.Promise&&i instanceof Promise&&i.catch((()=>{})),i},exitFullScreen(){let t;return this.fullScreen()&&(t=document[this._fn.exitFullscreen](),t.catch((()=>{}))),t},autoFullScreen(t,e){t=t||document.body,this._ensureFullScreen(t,e),this.requestFullScreen(t,e)},disableAutoFullScreen(t){if(this._preOnTouch){const e=i.game.canvas||t,n=this._touchEvent;e.removeEventListener(n,this._preOnTouch),this._preOnTouch=null}},_ensureFullScreen(t,e){const n=i.game.canvas||t,s=this._fn.fullscreenerror,o=this._touchEvent,r=()=>{this._preOnFullScreenError=null,this._preOnTouch&&n.removeEventListener(o,this._preOnTouch),this._preOnTouch=()=>{this._preOnTouch=null,this.requestFullScreen(t,e)},n.addEventListener(o,this._preOnTouch,{once:!0})};this._preOnFullScreenError&&t.removeEventListener(s,this._preOnFullScreenError),this._preOnFullScreenError=r,t.addEventListener(s,r,{once:!0})}});Nm.init(),i.screen=Nm;const Lm=new ea(null);class Bm{constructor(){this._device=null,this._passes=null,this._subMesh=null,this._patches=null,this._handle=0,this._priority=fl.DEFAULT,this._inputAssembler=null,this._descriptorSet=null}set passes(t){if(t.length>8)C(12004,8);else if(this._passes=t,this._flushPassInfo(),this._descriptorSet){Pi.free(ki.get(this._handle,ji.DESCRIPTOR_SET)),Lm.layout=t[0].localSetLayout;const e=Pi.alloc(this._device,Lm);ki.set(this._handle,ji.DESCRIPTOR_SET,e),this._descriptorSet=Pi.get(e)}}get passes(){return this._passes}set subMesh(t){this._subMesh=t,this._inputAssembler.destroy(),this._inputAssembler.initialize(t.iaInfo),this._passes[0].batchingScheme===Pp.VB_MERGING&&this._subMesh.genFlatBuffers(),ki.set(this._handle,ji.SUB_MESH,t.handle)}get subMesh(){return this._subMesh}set priority(t){this._priority=t,ki.set(this._handle,ji.PRIORITY,t)}get priority(){return this._priority}get handle(){return this._handle}get inputAssembler(){return this._inputAssembler}get descriptorSet(){return this._descriptorSet}get patches(){return this._patches}get planarShaderHandle(){return ki.get(this._handle,ji.PLANAR_SHADER)}get planarInstanceShaderHandle(){return ki.get(this._handle,ji.PLANAR_INSTANCE_SHADER)}initialize(t,e,n=null){this._device=i.director.root.device,this._subMesh=t,this._patches=n,this._passes=e,this._handle=ki.alloc(),this._flushPassInfo(),e[0].batchingScheme===Pp.VB_MERGING&&this._subMesh.genFlatBuffers(),Lm.layout=e[0].localSetLayout;const s=Pi.alloc(this._device,Lm),o=wi.alloc(this._device,t.iaInfo);ki.set(this._handle,ji.PRIORITY,fl.DEFAULT),ki.set(this._handle,ji.INPUT_ASSEMBLER,o),ki.set(this._handle,ji.DESCRIPTOR_SET,s),ki.set(this._handle,ji.SUB_MESH,t.handle),this._inputAssembler=wi.get(o),this._descriptorSet=Pi.get(s)}initPlanarShadowShader(){const t=i.director.root.pipeline.pipelineSceneData.shadows.getPlanarShader(this._patches);ki.set(this._handle,ji.PLANAR_SHADER,t)}initPlanarShadowInstanceShader(){const t=i.director.root.pipeline.pipelineSceneData.shadows.getPlanarInstanceShader(this._patches);ki.set(this._handle,ji.PLANAR_INSTANCE_SHADER,t)}destroy(){Pi.free(ki.get(this._handle,ji.DESCRIPTOR_SET)),wi.free(ki.get(this._handle,ji.INPUT_ASSEMBLER)),ki.free(this._handle),this._descriptorSet=null,this._inputAssembler=null,this._priority=fl.DEFAULT,this._handle=0,this._patches=null,this._subMesh=null,this._passes=null}update(){for(let t=0;t<this._passes.length;++t)this._passes[t].update();this._descriptorSet.update()}onPipelineStateChanged(){const t=this._passes;if(t){for(let e=0;e<t.length;e++){const n=t[e];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}}onMacroPatchesStateChanged(t){this._patches=t;const e=this._passes;if(e){for(let t=0;t<e.length;t++){const n=e[t];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}}_flushPassInfo(){const t=this._passes;if(!t)return;ki.set(this._handle,ji.PASS_COUNT,t.length);let e=ji.PASS_0,n=ji.SHADER_0;for(let i=0;i<t.length;i++,e++,n++)ki.set(this._handle,e,t[i].handle),ki.set(this._handle,n,t[i].getShaderVariant(this._patches))}}class Fm{static get(t,e=0){const n=Fm._buffers;n.has(t)||n.set(t,{});const i=n.get(t);return i[e]||(i[e]=new Fm(t))}constructor(t){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=t.device,this.pass=t}destroy(){for(let t=0;t<this.instances.length;++t){const e=this.instances[t];e.vb.destroy(),e.ia.destroy()}this.instances.length=0}merge(t,e,n,i=null){const s=e.buffer.length;if(!s)return;const o=t.inputAssembler,r=t.descriptorSet.getTexture(vh);let a=i;a||(a=ki.get(t.handle,ji.SHADER_0+n));const c=ki.get(t.handle,ji.DESCRIPTOR_SET);for(let t=0;t<this.instances.length;++t){const n=this.instances[t];if(!(n.ia.indexBuffer!==o.indexBuffer||n.count>=1024)&&n.lightingMap===r){if(n.stride!==s)return;if(n.count>=n.capacity){n.capacity<<=1;const t=n.stride*n.capacity,e=n.data;n.data=new Uint8Array(t),n.data.set(e),n.vb.resize(t)}return n.hShader!==a&&(n.hShader=a),n.hDescriptorSet!==c&&(n.hDescriptorSet=c),n.data.set(e.buffer,n.stride*n.count++),void(this.hasPendingModels=!0)}}const l=this._device.createBuffer(new br(Lo.VERTEX|Lo.TRANSFER_DST,zo.HOST|zo.DEVICE,32*s,s)),h=new Uint8Array(32*s),_=o.vertexBuffers.slice(),u=o.attributes.slice(),d=o.indexBuffer;for(let t=0;t<e.attributes.length;t++){const n=e.attributes[t],i=new qa(n.name,n.format,n.isNormalized,_.length,!0);u.push(i)}h.set(e.buffer),_.push(l);const p=new kr(u,_,d),f=this._device.createInputAssembler(p);this.instances.push({count:1,capacity:32,vb:l,data:h,ia:f,stride:s,hShader:a,hDescriptorSet:c,lightingMap:r}),this.hasPendingModels=!0}uploadBuffers(t){for(let e=0;e<this.instances.length;++e){const n=this.instances[e];n.count&&(n.ia.instanceCount=n.count,t.updateBuffer(n.vb,n.data))}}clear(){for(let t=0;t<this.instances.length;++t)this.instances[t].count=0;this.hasPendingModels=!1}}Fm._buffers=new Map;const zm=new Si(Ci.ATTRIBUTE,((t,e)=>e||new qa)),Um=new pn,Hm=new Pn((()=>new Bm),32),Gm=[{name:"CC_RECEIVE_SHADOW",value:!0}];let Vm;!function(t){t[t.DEFAULT=0]="DEFAULT",t[t.SKINNING=1]="SKINNING",t[t.BAKED_SKINNING=2]="BAKED_SKINNING",t[t.BATCH_2D=3]="BATCH_2D",t[t.PARTICLE_BATCH=4]="PARTICLE_BATCH",t[t.LINE=5]="LINE"}(Vm||(Vm={}));const jm=Cu([jo.LINEAR,jo.LINEAR,jo.NONE,Wo.CLAMP,Wo.CLAMP,Wo.CLAMP]),Wm=Cu([jo.LINEAR,jo.LINEAR,jo.LINEAR,Wo.CLAMP,Wo.CLAMP,Wo.CLAMP]);class km{get subModels(){return this._subModels}get inited(){return this._inited}get worldBounds(){return this._worldBounds}get modelBounds(){return this._modelBounds}get localBuffer(){return this._localBuffer}get updateStamp(){return this._updateStamp}get isInstancingEnabled(){return this._instMatWorldIdx>=0}get receiveShadow(){return!!Yi.get(this._handle,qi.RECEIVE_SHADOW)}set receiveShadow(t){Yi.set(this._handle,qi.RECEIVE_SHADOW,t?1:0),this.onMacroPatchesStateChanged()}get castShadow(){return!!Yi.get(this._handle,qi.CAST_SHADOW)}set castShadow(t){Yi.set(this._handle,qi.CAST_SHADOW,t?1:0)}get handle(){return this._handle}get node(){return this._node}set node(t){this._node=t,Yi.set(this._handle,qi.NODE,t.handle)}get transform(){return this._transform}set transform(t){this._transform=t,Yi.set(this._handle,qi.TRANSFORM,t.handle)}get visFlags(){return Yi.get(this._handle,qi.VIS_FLAGS)}set visFlags(t){Yi.set(this._handle,qi.VIS_FLAGS,t)}get enabled(){return!!Yi.get(this._handle,qi.ENABLED)}set enabled(t){Yi.set(this._handle,qi.ENABLED,t?1:0)}constructor(){this.type=Vm.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._transformUpdated=!0,this._handle=0,this._hWorldBounds=0,this._localData=new Float32Array(Ql.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new tn,this._device=i.director.root.device}initialize(){if(!this._inited){this._handle=Yi.alloc();const t=Ri.alloc(),e=Mi.alloc();Yi.set(this._handle,qi.INSTANCED_ATTR_ARRAY,e),Yi.set(this._handle,qi.SUB_MODEL_ARRAY,t),Yi.set(this._handle,qi.VIS_FLAGS,dl.Enum.NONE),Yi.set(this._handle,qi.ENABLED,1),Yi.set(this._handle,qi.RECEIVE_SHADOW,1),Yi.set(this._handle,qi.CAST_SHADOW,0),this._inited=!0}}destroy(){const t=this._subModels;for(let e=0;e<t.length;e++){const t=this._subModels[e];t.destroy(),Hm.free(t)}if(this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._transformUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._handle){const t=Yi.get(this._handle,qi.SUB_MODEL_ARRAY);t&&Ri.free(t);const e=Yi.get(this._handle,qi.INSTANCED_BUFFER);e&&zi.free(e);const n=Yi.get(this._handle,qi.INSTANCED_ATTR_ARRAY);n&&Ai(n,Mi,zm),Yi.free(this._handle),this._handle=0}this._hWorldBounds&&(ts.free(this._hWorldBounds),this._hWorldBounds=0)}attachToScene(t){this.scene=t}detachFromScene(){this.scene=null}updateTransform(t){const e=this.transform;if(e.hasChangedFlags||e._dirtyFlags){e.updateWorldTransform(),this._transformUpdated=!0;const t=this._worldBounds;this._modelBounds&&t&&(this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t),ts.setVec3(this._hWorldBounds,Ji.CENTER,t.center),ts.setVec3(this._hWorldBounds,Ji.HALF_EXTENSION,t.halfExtents))}}updateWorldBound(){const t=this.transform;if(null!==t){t.updateWorldTransform(),this._transformUpdated=!0;const e=this._worldBounds;this._modelBounds&&e&&(this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e),ts.setVec3(this._hWorldBounds,Ji.CENTER,e.center),ts.setVec3(this._hWorldBounds,Ji.HALF_EXTENSION,e.halfExtents))}}updateUBOs(t){const e=this._subModels;for(let t=0;t<e.length;t++)e[t].update();if(this._updateStamp=t,!this._transformUpdated)return;this._transformUpdated=!1;const n=this.transform._mat,i=this._instMatWorldIdx;if(i>=0){const t=this.instancedAttributes.views;!function(t,e,n,i){e[0]=t.m00,e[1]=t.m01,e[2]=t.m02,e[3]=t.m12,n[0]=t.m04,n[1]=t.m05,n[2]=t.m06,n[3]=t.m13,i[0]=t.m08,i[1]=t.m09,i[2]=t.m10,i[3]=t.m14}(n,t[i],t[i+1],t[i+2])}else this._localBuffer&&(pn.toArray(this._localData,n,Ql.MAT_WORLD_OFFSET),pn.inverseTranspose(Um,n),pn.toArray(this._localData,Um,Ql.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData))}createBoundingShape(t,e){t&&e&&(this._modelBounds=$c.fromPoints($c.create(),t,e),this._worldBounds=$c.clone(this._modelBounds),0===this._hWorldBounds&&(this._hWorldBounds=ts.alloc(),Yi.set(this._handle,qi.WORLD_BOUNDS,this._hWorldBounds)),ts.setVec3(this._hWorldBounds,Ji.CENTER,this._worldBounds.center),ts.setVec3(this._hWorldBounds,Ji.HALF_EXTENSION,this._worldBounds.halfExtents))}initSubModel(t,e,n){this.initialize();let i=!1;if(null==this._subModels[t]?(this._subModels[t]=Hm.alloc(),i=!0):this._subModels[t].destroy(),this._subModels[t].initialize(e,n.passes,this.getMacroPatches(t)),this._subModels[t].initPlanarShadowShader(),this._subModels[t].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(t),i){const e=Yi.get(this._handle,qi.SUB_MODEL_ARRAY);Ri.assign(e,t,this._subModels[t].handle)}}setSubModelMesh(t,e){this._subModels[t]&&(this._subModels[t].subMesh=e)}setSubModelMaterial(t,e){this._subModels[t]&&(this._subModels[t].passes=e.passes,this._updateAttributesAndBinding(t))}onGlobalPipelineStateChanged(){const t=this._subModels;for(let e=0;e<t.length;e++)t[e].onPipelineStateChanged()}onMacroPatchesStateChanged(){const t=this._subModels;for(let e=0;e<t.length;e++)t[e].onMacroPatchesStateChanged(this.getMacroPatches(e))}updateLightingmap(t,e){tn.toArray(this._localData,e,Ql.LIGHTINGMAP_UVPARAM),this._lightmap=t,this._lightmapUVParam=e,null===t&&(t=Tp.get("empty-texture"));const n=t.getGFXTexture();if(n){const e=bu.getSampler(this._device,t.mipmaps.length>1?Wm:jm),i=this._subModels;for(let t=0;t<i.length;t++){const{descriptorSet:s}=i[t];s.bindTexture(vh,n),s.bindSampler(vh,e),s.update()}}}getMacroPatches(t){return this.receiveShadow?Gm:null}_updateAttributesAndBinding(t){const e=this._subModels[t];if(!e)return;this._initLocalDescriptors(t),this._updateLocalDescriptors(t,e.descriptorSet);const n=bi.get(ki.get(e.handle,ji.SHADER_0));this._updateInstancedAttributes(n.attributes,e.passes[0])}_getInstancedAttributeIndex(t){const{attributes:e}=this.instancedAttributes;for(let n=0;n<e.length;n++)if(e[n].name===t)return n;return-1}_updateInstancedAttributes(t,e){if(!e.device.hasFeature(Ro.INSTANCED_ARRAYS))return;const n=Yi.get(this._handle,qi.INSTANCED_BUFFER);n&&zi.free(n);const i=Yi.get(this._handle,qi.INSTANCED_ATTR_ARRAY);i&&Ai(i,Mi,zm,!1);let s=0;for(let e=0;e<t.length;e++){const n=t[e];n.isInstanced&&(s+=ha[n.format].size)}const o=zi.alloc(s),r=zi.getBuffer(o);Yi.set(this._handle,qi.INSTANCED_BUFFER,o);const a=this.instancedAttributes;a.buffer=new Uint8Array(r),a.views.length=a.attributes.length=0;let c=0;for(let e=0;e<t.length;e++){const n=t[e];if(!n.isInstanced)continue;const s=zm.alloc(),o=zm.get(s);o.format=n.format,o.name=n.name,o.isNormalized=n.isNormalized,o.location=n.location,a.attributes.push(o),Mi.push(i,s);const l=ha[n.format];a.views.push(new(ya(l))(r,c,l.count)),c+=l.size}e.batchingScheme===Pp.INSTANCING&&Fm.get(e).destroy(),this._instMatWorldIdx=this._getInstancedAttributeIndex("a_matWorld0"),this._transformUpdated=!0}_initLocalDescriptors(t){this._localBuffer||(this._localBuffer=this._device.createBuffer(new br(Lo.UNIFORM|Lo.TRANSFER_DST,zo.HOST|zo.DEVICE,Ql.SIZE,Ql.SIZE)))}_updateLocalDescriptors(t,e){this._localBuffer&&e.bindBuffer(Ql.BINDING,this._localBuffer)}}class qm{get root(){return this._root}get name(){return this._name}get cameras(){return this._cameras}get mainLight(){return this._mainLight}get sphereLights(){return this._sphereLights}get spotLights(){return this._spotLights}get models(){return this._models}get handle(){return this._scenePoolHandle}get batches(){return this._batches}static registerCreateFunc(t){t._createSceneFun=t=>new qm(t)}constructor(t){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._scenePoolHandle=0,this._modelArrayHandle=0,this._batchArrayHandle=0,this._sphereLightsHandle=0,this._spotLightsHandle=0,this._root=t,this._createHandles()}initialize(t){return this._name=t.name,this._createHandles(),!0}update(t){const e=this._mainLight;e&&e.update();const n=this._sphereLights;for(let t=0;t<n.length;t++)n[t].update();const i=this._spotLights;for(let t=0;t<i.length;t++)i[t].update();const s=this._models;for(let e=0;e<s.length;e++){const n=s[e];n.enabled&&(n.updateTransform(t),n.updateUBOs(t))}}destroy(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._modelArrayHandle&&(Oi.free(this._modelArrayHandle),this._modelArrayHandle=0),this._scenePoolHandle&&(is.free(this._scenePoolHandle),this._scenePoolHandle=0),this._sphereLightsHandle&&(Li.free(this._sphereLightsHandle),this._sphereLightsHandle=0),this._spotLightsHandle&&(Li.free(this._spotLightsHandle),this._spotLightsHandle=0),this._batchArrayHandle&&(Fi.free(this._batchArrayHandle),this._batchArrayHandle=0)}addCamera(t){t.attachToScene(this),this._cameras.push(t)}removeCamera(t){for(let e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return this._cameras.splice(e,1),void t.detachFromScene()}removeCameras(){for(const t of this._cameras)t.detachFromScene();this._cameras.splice(0)}setMainLight(t){this._mainLight=t,is.set(this._scenePoolHandle,es.MAIN_LIGHT,t.handle)}unsetMainLight(t){if(this._mainLight===t){const t=this._directionalLights;t.length?(this._mainLight=t[t.length-1],this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=Hh.ROTATION)):this._mainLight=null}}addDirectionalLight(t){t.attachToScene(this),this._directionalLights.push(t)}removeDirectionalLight(t){for(let e=0;e<this._directionalLights.length;++e)if(this._directionalLights[e]===t)return t.detachFromScene(),void this._directionalLights.splice(e,1)}addSphereLight(t){t.attachToScene(this),this._sphereLights.push(t),Li.push(this._sphereLightsHandle,t.handle)}removeSphereLight(t){for(let e=0;e<this._sphereLights.length;++e)if(this._sphereLights[e]===t)return t.detachFromScene(),this._sphereLights.splice(e,1),void Li.erase(this._sphereLightsHandle,e)}addSpotLight(t){t.attachToScene(this),this._spotLights.push(t),Li.push(this._spotLightsHandle,t.handle)}removeSpotLight(t){for(let e=0;e<this._spotLights.length;++e)if(this._spotLights[e]===t)return t.detachFromScene(),this._spotLights.splice(e,1),void Li.erase(this._spotLightsHandle,e)}removeSphereLights(){for(let t=0;t<this._sphereLights.length;++t)this._sphereLights[t].detachFromScene();this._sphereLights.length=0,Li.clear(this._sphereLightsHandle)}removeSpotLights(){for(let t=0;t<this._spotLights.length;++t)this._spotLights[t].detachFromScene();this._spotLights=[],Li.clear(this._spotLightsHandle)}addModel(t){t.attachToScene(this),this._models.push(t),Oi.push(this._modelArrayHandle,t.handle)}removeModel(t){for(let e=0;e<this._models.length;++e)if(this._models[e]===t)return t.detachFromScene(),this._models.splice(e,1),void Oi.erase(this._modelArrayHandle,e)}removeModels(){for(const t of this._models)t.detachFromScene(),t.destroy();this._models.length=0,Oi.clear(this._modelArrayHandle)}addBatch(t){this._batches.push(t),Fi.push(this._batchArrayHandle,t.handle)}removeBatch(t){for(let e=0;e<this._batches.length;++e)if(this._batches[e]===t)return this._batches.splice(e,1),void Fi.erase(this._batchArrayHandle,e)}removeBatches(){this._batches.length=0,Fi.clear(this._batchArrayHandle)}onGlobalPipelineStateChanged(){for(const t of this._models)t.onGlobalPipelineStateChanged()}generateModelId(){return this._modelId++}_createHandles(){this._modelArrayHandle||(this._modelArrayHandle=Oi.alloc(),this._scenePoolHandle=is.alloc(),is.set(this._scenePoolHandle,es.MODEL_ARRAY,this._modelArrayHandle),this._spotLightsHandle=Li.alloc(),is.set(this._scenePoolHandle,es.SPOT_LIGHT_ARRAY,this._spotLightsHandle),this._sphereLightsHandle=Li.alloc(),is.set(this._scenePoolHandle,es.SPHERE_LIGHT_ARRAY,this._sphereLightsHandle)),this._batchArrayHandle||(this._batchArrayHandle=Fi.alloc(),is.set(this._scenePoolHandle,es.BATCH_ARRAY_2D,this._batchArrayHandle))}}const Xm=new $e(0,0,-1),Ym=new rn,Km=new pn,$m=new pn,Zm=new pn,Jm=new pn;var Qm=Object.freeze({__proto__:null,Ambient:io,get CameraFOVAxis(){return Ch},get CameraProjection(){return bh},get CameraAperture(){return Ph},get CameraISO(){return wh},get CameraShutter(){return Dh},SKYBOX_FLAG:Bh,Camera:zh,DirectionalLight:class extends Wh{set direction(t){$e.normalize(this._dir,t),Bs.setVec3(this._handle,Ns.DIRECTION,this._dir)}get direction(){return this._dir}set illuminance(t){Bs.set(this._handle,Ns.ILLUMINANCE,t)}get illuminance(){return Bs.get(this._handle,Ns.ILLUMINANCE)}constructor(){super(),this._dir=new $e(1,-1,-1)}initialize(){super.initialize(),Bs.set(this._handle,Ns.ILLUMINANCE,io.SUN_ILLUM),Bs.setVec3(this._handle,Ns.DIRECTION,this._dir),Bs.set(this._handle,Ns.TYPE,Gh.DIRECTIONAL)}update(){this._node&&this._node.hasChangedFlags&&(this.direction=$e.transformQuat(qh,kh,this._node.worldRotation))}},ColorTemperatureToRGB:Vh,get LightType(){return Gh},nt2lm:jh,Light:Wh,get ModelType(){return Vm},Model:km,ShadowType:Zf,PCFType:Jf,Shadows:tm,RenderScene:qm,Skybox:$f,SphereLight:class extends Wh{get position(){return this._pos}set size(t){Bs.set(this._handle,Ns.SIZE,t)}get size(){return Bs.get(this._handle,Ns.SIZE)}set range(t){Bs.set(this._handle,Ns.RANGE,t),this._needUpdate=!0}get range(){return Bs.get(this._handle,Ns.RANGE)}set luminance(t){Bs.set(this._handle,Ns.ILLUMINANCE,t)}get luminance(){return Bs.get(this._handle,Ns.ILLUMINANCE)}get aabb(){return this._aabb}constructor(){super(),this._needUpdate=!1,this._pos=void 0,this._aabb=void 0,this._hAABB=0,this._aabb=$c.create(),this._pos=new $e}initialize(){super.initialize(),this._hAABB=ts.alloc(),Bs.set(this._handle,Ns.TYPE,Gh.SPHERE),Bs.set(this._handle,Ns.SIZE,.15),Bs.set(this._handle,Ns.RANGE,1),Bs.set(this._handle,Ns.AABB,this._hAABB),Bs.set(this._handle,Ns.ILLUMINANCE,1700/jh(.15))}update(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);const t=Bs.get(this._handle,Ns.RANGE);$c.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,t,t,t),this._needUpdate=!1,Bs.setVec3(this._handle,Ns.POSITION,this._pos),ts.setVec3(this._hAABB,Ji.CENTER,this._aabb.center),ts.setVec3(this._hAABB,Ji.HALF_EXTENSION,this._aabb.halfExtents)}}destroy(){return this._hAABB&&(ts.free(this._hAABB),this._hAABB=0),super.destroy()}},SpotLight:class extends Wh{get position(){return this._pos}set size(t){Bs.set(this._handle,Ns.SIZE,t)}get size(){return Bs.get(this._handle,Ns.SIZE)}set range(t){this._range=t,Bs.set(this._handle,Ns.RANGE,t),this._needUpdate=!0}get range(){return Bs.get(this._handle,Ns.RANGE)}set luminance(t){Bs.set(this._handle,Ns.ILLUMINANCE,t)}get luminance(){return Bs.get(this._handle,Ns.ILLUMINANCE)}get direction(){return this._dir}get spotAngle(){return Bs.get(this._handle,Ns.SPOT_ANGLE)}set spotAngle(t){this._angle=t,Bs.set(this._handle,Ns.SPOT_ANGLE,Math.cos(.5*t)),this._needUpdate=!0}set aspect(t){Bs.set(this._handle,Ns.ASPECT,t),this._needUpdate=!0}get aspect(){return Bs.get(this._handle,Ns.ASPECT)}get aabb(){return this._aabb}get frustum(){return this._frustum}constructor(){super(),this._dir=new $e(1,-1,-1),this._range=5,this._spotAngle=Math.cos(Math.PI/6),this._pos=void 0,this._aabb=void 0,this._frustum=void 0,this._angle=0,this._needUpdate=!1,this._hAABB=0,this._hFrustum=0,this._aabb=$c.create(),this._frustum=nl.create(),this._pos=new $e}initialize(){super.initialize(),this._hAABB=ts.alloc(),this._hFrustum=vs.alloc(),Bs.set(this._handle,Ns.TYPE,Gh.SPOT),Bs.set(this._handle,Ns.SIZE,.15),Bs.set(this._handle,Ns.AABB,this._hAABB),Bs.set(this._handle,Ns.ILLUMINANCE,1700/jh(.15)),Bs.set(this._handle,Ns.RANGE,Math.cos(Math.PI/6)),Bs.set(this._handle,Ns.ASPECT,1),Bs.setVec3(this._handle,Ns.DIRECTION,this._dir),Bs.set(this._handle,Ns.FRUSTUM,this._hFrustum)}update(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),$e.transformQuat(this._dir,Xm,this._node.getWorldRotation(Ym)),$e.normalize(this._dir,this._dir),Bs.setVec3(this._handle,Ns.DIRECTION,this._dir),$c.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(Km),pn.invert(Km,Km),pn.perspective($m,this._angle,1,.001,this._range),pn.multiply(Zm,$m,Km),this._frustum.update(Zm,Jm),this._needUpdate=!1,Bs.setVec3(this._handle,Ns.POSITION,this._pos),ts.setVec3(this._hAABB,Ji.CENTER,this._aabb.center),ts.setVec3(this._hAABB,Ji.HALF_EXTENSION,this._aabb.halfExtents),il(this._hFrustum,this._frustum))}destroy(){return this._hAABB&&(ts.free(this._hAABB),this._hAABB=0),this._hFrustum&&(vs.free(this._hFrustum),this._hFrustum=0),super.destroy()}},SubModel:Bm});let tg,eg;function ng(t){return--t,t|=t>>16,t|=t>>8,t|=t>>4,t|=t>>2,t|=t>>1,++t}function ig(t,e){return Math.ceil(t/e)*e}!function(t){t[t.OPAQUE=0]="OPAQUE",t[t.TRANSPARENT=1]="TRANSPARENT",t[t.OVERLAY=2]="OVERLAY"}(tg||(tg={})),function(t){t[t.DEFAULT=1]="DEFAULT",t[t.FORWARD=2]="FORWARD",t[t.SHADOWCAST=4]="SHADOWCAST"}(eg||(eg={}));const sg=fi.addStage;var og=Object.freeze({__proto__:null,addStage:sg,scene:Qm,createIA:function(t,e){if(!e.positions)return console.error("The data must have positions field"),null;const n=[],i=e.positions.length/3;for(let t=0;t<i;++t)n.push(e.positions[3*t],e.positions[3*t+1],e.positions[3*t+2]),e.normals&&n.push(e.normals[3*t],e.normals[3*t+1],e.normals[3*t+2]),e.uvs&&n.push(e.uvs[2*t],e.uvs[2*t+1]),e.colors&&n.push(e.colors[3*t],e.colors[3*t+1],e.colors[3*t+2]);const s=[];s.push(new qa(ur.ATTR_POSITION,Oo.RGB32F)),e.normals&&s.push(new qa(ur.ATTR_NORMAL,Oo.RGB32F)),e.uvs&&s.push(new qa(ur.ATTR_TEX_COORD,Oo.RG32F)),e.colors&&s.push(new qa(ur.ATTR_COLOR,Oo.RGB32F));const o=t.createBuffer(new br(Lo.VERTEX|Lo.TRANSFER_DST,zo.HOST|zo.DEVICE,4*n.length,4*n.length/i));o.update(new Float32Array(n));let r=null;return e.indices&&(r=t.createBuffer(new br(Lo.INDEX|Lo.TRANSFER_DST,zo.HOST|zo.DEVICE,2*e.indices.length,2)),r.update(new Uint16Array(e.indices))),t.createInputAssembler(new kr(s,[o],r))},get RenderQueue(){return tg},get PassStage(){return eg},get PropertyType(){return ep},genHandle:np,getPropertyTypeFromHandle:ip,getTypeFromHandle:sp,getSetIndexFromHandle:t=>(t&Qd)>>>20,getBindingFromHandle:op,getOffsetFromHandle:rp,customizeType:ap,type2reader:cp,type2writer:lp,getDefaultFromType:_p,overrideMacros:up,get BatchingSchemes(){return Pp},Pass:wp,getDeviceShaderVersion:yp,programLib:xp,get SamplerInfoIndex(){return yu},defaultSamplerHash:Tu,genSamplerHash:Cu,samplerLib:bu,nearestPOT:ng,TextureBufferPool:class{constructor(t){this._device=void 0,this._format=Oo.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new Tr,this._region1=new Tr,this._region2=new Tr,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=t}initialize(t){const e=ha[t.format];this._format=t.format,this._formatSize=e.size,this._channels=e.count,this._bufferViewCtor=ya(e),this._roundUpFn=t.roundUpFn||null,this._alignment=t.alignment||1,t.inOrderFree&&(this.alloc=this._McDonaldAlloc)}destroy(){for(let t=0;t<this._chunkCount;++t)this._chunks[t].texture.destroy();this._chunks.length=0,this._handles.length=0}alloc(t,e){t=ig(t,this._alignment);let n=-1,i=-1;if(void 0!==e&&(n=e,i=this._findAvailableSpace(t,n)),i<0)for(let e=0;e<this._chunkCount&&(n=e,i=this._findAvailableSpace(t,n),!(i>=0));++e);if(i>=0){const e=this._chunks[n];e.start+=t;const s={chunkIdx:n,start:i,end:i+t,texture:e.texture};return this._handles.push(s),s}const s=Math.sqrt(t/this._formatSize),o=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,ng(s)),r=this._chunks[this.createChunk(o)];r.start+=t;const a={chunkIdx:this._chunkCount-1,start:0,end:t,texture:r.texture};return this._handles.push(a),a}free(t){for(let e=0;e<this._handles.length;++e)if(this._handles[e]===t)return this._chunks[t.chunkIdx].end=t.end,void this._handles.splice(e,1)}createChunk(t){const e=t*t*this._formatSize;console.info(`TextureBufferPool: Allocate chunk ${this._chunkCount}, size: ${e}, format: ${this._format}`);const n={texture:this._device.createTexture(new Rr(Uo.TEX2D,Ho.SAMPLED|Ho.TRANSFER_DST,this._format,t,t,Go.IMMUTABLE)),size:e,start:0,end:e};return this._chunks[this._chunkCount]=n,this._chunkCount++}update(t,e){const n=[],i=[],s=t.start/this._formatSize;let o=e.byteLength/this._formatSize,r=s%t.texture.width,a=Math.floor(s/t.texture.width),c=Math.min(t.texture.width-r,o),l=0;r>0&&(this._region0.texOffset.x=r,this._region0.texOffset.y=a,this._region0.texExtent.width=c,this._region0.texExtent.height=1,n.push(new this._bufferViewCtor(e,l*this._formatSize,c*this._channels)),i.push(this._region0),r=0,a+=1,o-=c,l+=c),o>0&&(this._region1.texOffset.x=r,this._region1.texOffset.y=a,o>t.texture.width?(this._region1.texExtent.width=t.texture.width,this._region1.texExtent.height=Math.floor(o/t.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=o,this._region1.texExtent.width=c,this._region1.texExtent.height=1),n.push(new this._bufferViewCtor(e,l*this._formatSize,c*this._channels)),i.push(this._region1),r=0,a+=this._region1.texExtent.height,o-=c,l+=c),o>0&&(this._region2.texOffset.x=r,this._region2.texOffset.y=a,this._region2.texExtent.width=o,this._region2.texExtent.height=1,n.push(new this._bufferViewCtor(e,l*this._formatSize,o*this._channels)),i.push(this._region2)),this._device.copyBuffersToTexture(n,t.texture,i)}_findAvailableSpace(t,e){const n=this._chunks[e];let i=!1,s=n.start;if(s+t<=n.size)i=!0;else{s=0;const o=this._handles.filter((t=>t.chunkIdx===e)).sort(((t,e)=>t.start-e.start));for(let e=0;e<o.length;e++){const n=o[e];if(s+t<=n.start){i=!0;break}s=n.end}!i&&s+t<=n.size&&(i=!0)}return i?s:-1}_McDonaldAlloc(t){t=ig(t,this._alignment);for(let e=0;e<this._chunkCount;++e){const n=this._chunks[e];let i=!1,s=n.start;if(s+t<=n.end?i=!0:s>n.end?s+t<=n.size?i=!0:t<=n.end&&(n.start=s=0,i=!0):s===n.end&&(n.start=s=0,n.end=n.size,t<=n.end&&(i=!0)),i){n.start+=t;const i={chunkIdx:e,start:s,end:s+t,texture:n.texture};return this._handles.push(i),i}}const e=Math.sqrt(t/this._formatSize),n=this._roundUpFn&&this._roundUpFn(e,this._formatSize)||Math.max(1024,ng(e)),i=this._chunks[this.createChunk(n)];i.start+=t;const s={chunkIdx:this._chunkCount,start:0,end:t,texture:i.texture};return this._handles.push(s),s}},MaterialInstance:Xf,PassInstance:qf,ObjectPool:Si,freeHandleArray:Ai,get PoolType(){return Ci},NULL_HANDLE:0,ShaderPool:bi,DSPool:Pi,IAPool:wi,PipelineLayoutPool:Di,FramebufferPool:Ii,SubModelArrayPool:Ri,ModelArrayPool:Oi,AttributeArrayPool:Mi,FlatBufferArrayPool:Ni,LightArrayPool:Li,BlendTargetArrayPool:Bi,UIBatchArrayPool:Fi,RawBufferPool:zi,RawObjectPool:Ui,get PassView(){return Hi},PassPool:Vi,get SubModelView(){return ji},SubModelPool:ki,get ModelView(){return qi},ModelPool:Yi,get BatchView2D(){return Ki},BatchPool2D:Zi,get AABBView(){return Ji},AABBPool:ts,get SceneView(){return es},ScenePool:is,get CameraView(){return ss},CameraPool:rs,get NodeView(){return as},NodePool:ls,get RootView(){return hs},RootPool:us,get RenderWindowView(){return ds},RenderWindowPool:fs,get FrustumView(){return ms},FrustumPool:vs,get AmbientView(){return ys},AmbientPool:Ss,get SkyboxView(){return Ts},SkyboxPool:As,get FogView(){return Cs},FogPool:Ps,get ShadowsView(){return ws},ShadowsPool:Is,get PipelineSceneDataView(){return Rs},PipelineSceneDataPool:Ms,get LightView(){return Ns},LightPool:Bs,get SphereView(){return Fs},SpherePool:Us,get FlatBufferView(){return Hs},FlatBufferPool:Vs,get SubMeshView(){return js},SubMeshPool:ks,get RasterizerStateView(){return qs},RasterizerStatePool:Ys,get DepthStencilStateView(){return Ks},DepthStencilStatePool:Zs,get BlendTargetView(){return Js},BlendTargetPool:Qs,get BlendStateView(){return to},BlendStatePool:no});function rg(t){return t*t}function ag(t){return t*(2-t)}function cg(t){return t*t*t}function lg(t){return--t*t*t+1}function hg(t){return t*t*t*t}function _g(t){return 1- --t*t*t*t}function ug(t){return t*t*t*t*t}function dg(t){return--t*t*t*t*t+1}function pg(t){return 1===t?1:1-Math.cos(t*Math.PI/2)}function fg(t){return Math.sin(t*Math.PI/2)}function mg(t){return 0===t?0:Math.pow(1024,t-1)}function gg(t){return 1===t?1:1-Math.pow(2,-10*t)}function vg(t){return 1-Math.sqrt(1-t*t)}function yg(t){return Math.sqrt(1- --t*t)}function xg(t){let e,n=.1;return 0===t?0:1===t?1:(!n||n<1?(n=1,e=.1):e=.4*Math.asin(1/n)/(2*Math.PI),-n*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4))}function Sg(t){let e,n=.1;return 0===t?0:1===t?1:(!n||n<1?(n=1,e=.1):e=.4*Math.asin(1/n)/(2*Math.PI),n*Math.pow(2,-10*t)*Math.sin(2*(t-e)*Math.PI/.4)+1)}function Tg(t){if(1===t)return 1;const e=1.70158;return t*t*((e+1)*t-e)}function Eg(t){if(0===t)return 0;const e=1.70158;return--t*t*((e+1)*t+e)+1}function Ag(t){return 1-Cg(1-t)}function Cg(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375}t("renderer",og);const bg=Bg(rg,ag),Pg=Bg(cg,lg),wg=Bg(hg,_g),Dg=Bg(ug,dg),Ig=Bg(pg,fg),Rg=Bg(mg,gg),Og=Bg(vg,yg),Mg=Bg(xg,Sg),Ng=Bg(Tg,Eg),Lg=Bg(Ag,Cg);function Bg(t,e){return n=>n<.5?e(2*n)/2:t(2*n-1)/2+.5}var Fg=Object.freeze({__proto__:null,constant:function(){return 0},linear:function(t){return t},quadIn:rg,quadOut:ag,quadInOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)},cubicIn:cg,cubicOut:lg,cubicInOut:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)},quartIn:hg,quartOut:_g,quartInOut:function(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)},quintIn:ug,quintOut:dg,quintInOut:function(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)},sineIn:pg,sineOut:fg,sineInOut:function(t){return.5*(1-Math.cos(Math.PI*t))},expoIn:mg,expoOut:gg,expoInOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))},circIn:vg,circOut:yg,circInOut:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)},elasticIn:xg,elasticOut:Sg,elasticInOut:function(t){let e,n=.1;return 0===t?0:1===t?1:(!n||n<1?(n=1,e=.1):e=.4*Math.asin(1/n)/(2*Math.PI),(t*=2)<1?n*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*-.5:n*Math.pow(2,-10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*.5+1)},backIn:Tg,backOut:Eg,backInOut:function(t){const e=2.5949095;return(t*=2)<1?t*t*((e+1)*t-e)*.5:.5*((t-=2)*t*((e+1)*t+e)+2)},bounceIn:Ag,bounceOut:Cg,bounceInOut:function(t){return t<.5?.5*Ag(2*t):.5*Cg(2*t-1)+.5},smooth:function(t){return t<=0?0:t>=1?1:t*t*(3-2*t)},fade:function(t){return t<=0?0:t>=1?1:t*t*t*(t*(6*t-15)+10)},quadOutIn:bg,cubicOutIn:Pg,quartOutIn:wg,quintOutIn:Dg,sineOutIn:Ig,expoOutIn:Rg,circOutIn:Og,elasticOutIn:Mg,backOutIn:Ng,bounceOutIn:Lg});t("easing",Fg);const zg=new qe;class Ug{set splashFinish(t){this._splashFinish=t,this._tryToStart()}set loadFinish(t){this._loadFinish=t,this._tryToStart()}main(t){if(null!=t){if(window._CCSettings&&window._CCSettings.splashScreen){const t=this.settings=window._CCSettings.splashScreen;t.totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,t.base64src=this.settings.base64src||"",t.effect=this.settings.effect||"FADE-INOUT",t.clearColor=this.settings.clearColor||new Ar(.88,.88,.88,1),t.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,t.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark}else this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new Ar(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.settings.base64src||this.settings.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0;else{i.view.enableRetina(!0),i.view.resizeWithBrowserSize(!0);const e=window._CCSettings.designResolution;e?i.view.setDesignResolutionSize(e.width,e.height,e.policy):i.view.setDesignResolutionSize(960,640,4),this.root=t,this.device=t.device,i.game.once(i.Game.EVENT_GAME_INITED,(()=>{i.director._lateUpdate=performance.now()}),i.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src}}else p("RENDER ROOT IS NULL.")}setOnFinish(t){if(this._directCall&&t)return Ug._ins=void 0,void t();this.callBack=t}_tryToStart(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),i.game.resume())}preInit(){const t=this.settings.clearColor;this.clearColors=[new Ar(t.x,t.y,t.z,t.w)];const e=this.device;this.renderArea=new mr(0,0,e.width,e.height),this.framebuffer=this.root.mainWindow.framebuffer,this.cmdBuff=e.commandBuffer;const n=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),i=4*Float32Array.BYTES_PER_ELEMENT,s=4*i;this.vertexBuffers=e.createBuffer(new br(Lo.VERTEX|Lo.TRANSFER_DST,zo.HOST|zo.DEVICE,s,i)),this.vertexBuffers.update(n);const o=new Uint16Array([0,1,2,1,3,2]),r=Uint16Array.BYTES_PER_ELEMENT,a=6*r;this.indicesBuffers=e.createBuffer(new br(Lo.INDEX|Lo.TRANSFER_DST,zo.HOST|zo.DEVICE,a,r)),this.indicesBuffers.update(o);const c=[new qa("a_position",Oo.RG32F),new qa("a_texCoord",Oo.RG32F)],l=new kr(c,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=e.createInputAssembler(l),this.projection=new pn,pn.ortho(this.projection,-1,1,-1,1,-1,1,e.capabilities.clipSpaceMinZ,e.capabilities.clipSpaceSignY,e.surfaceTransform)}init(){this.initLogo(),this.settings.displayWatermark&&this.initWarterMark();const t=e=>{if(this.cancelAnimate)return;const n=this.settings,i=this.device;pn.ortho(this.projection,-1,1,-1,1,-1,1,i.capabilities.clipSpaceMinZ,i.capabilities.clipSpaceSignY,i.surfaceTransform);const s=i.width,o=i.height,r=s<o?s:o;this.startTime<0&&(this.startTime=e);const a=e-this.startTime;let c=lg(Ie(a/n.totalTime));"NONE"===n.effect&&(c=1);const l=this.logoTexture.width,h=this.logoTexture.height,_=r*n.displayRatio;let u=_*l/h,d=_;if(i.surfaceTransform!==Io.ROTATE_90&&i.surfaceTransform!==Io.ROTATE_270||(u=_*s/o,d=_*h/l*o/s),this.logoMat.setProperty("resolution",zg.set(s,o),0),this.logoMat.setProperty("scale",zg.set(u,d),0),this.logoMat.setProperty("translate",zg.set(.5*s,.5*o),0),this.logoMat.setProperty("precent",c),this.logoMat.setProperty("u_projection",this.projection),this.logoMat.passes[0].update(),n.displayWatermark&&this.watermarkMat){const t=.5*r,e=this.watermarkTexture.width;let n=t,a=t*this.watermarkTexture.height/e;i.surfaceTransform!==Io.ROTATE_90&&i.surfaceTransform!==Io.ROTATE_270||(n=.5*t,a=t*s/o*.5),this.watermarkMat.setProperty("resolution",zg.set(s,o),0),this.watermarkMat.setProperty("scale",zg.set(n,a),0),this.watermarkMat.setProperty("translate",zg.set(.5*s,.1*o),0),this.watermarkMat.setProperty("precent",c),this.watermarkMat.setProperty("u_projection",this.projection),this.watermarkMat.passes[0].update()}this.frame(),a>n.totalTime&&(this.splashFinish=!0),requestAnimationFrame(t)};i.game.pause(),this.handle=requestAnimationFrame(t)}hide(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))}initLogo(){const t=this.device;this.logoMat=new kf,this.logoMat.initialize({effectName:"splash-screen"});const e=new Mr;e.addressU=Wo.CLAMP,e.addressV=Wo.CLAMP,e.addressW=Wo.CLAMP,this.sampler=t.createSampler(e),this.logoTexture=t.createTexture(new Rr(Uo.TEX2D,Ho.SAMPLED|Ho.TRANSFER_DST,Oo.RGBA8,this.logoImage.width,this.logoImage.height));const n=this.logoMat.passes[0],i=n.getBinding("mainTexture");n.bindTexture(i,this.logoTexture),this.shader=bi.get(n.getShaderVariant());const s=Pi.get(Vi.get(n.handle,Hi.DESCRIPTOR_SET));s.bindSampler(i,this.sampler),s.update();const o=new Tr;o.texExtent.width=this.logoImage.width,o.texExtent.height=this.logoImage.height,o.texExtent.depth=1,t.copyTexImagesToTexture([this.logoImage],this.logoTexture,[o])}initWarterMark(){const t=document.createElement("canvas");t.width=330,t.height=30,t.style.width=`${t.width}`,t.style.height=`${t.height}`;const e=t.getContext("2d");e.font="18px Arial",e.textBaseline="top",e.textAlign="left",e.fillStyle="`#424242`";const n="Powered by Cocos Creator",i=e.measureText(n);e.fillText(n,(330-i.width)/2,6);const s=new Tr;s.texExtent.width=t.width,s.texExtent.height=t.height,s.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new Rr(Uo.TEX2D,Ho.SAMPLED|Ho.TRANSFER_DST,Oo.RGBA8,t.width,t.height)),this.device.copyTexImagesToTexture([t],this.watermarkTexture,[s]),this.watermarkMat=new kf,this.watermarkMat.initialize({effectName:"splash-screen"});const o=this.watermarkMat.passes[0],r=o.getBinding("mainTexture");o.bindTexture(r,this.watermarkTexture),Pi.get(Vi.get(o.handle,Hi.DESCRIPTOR_SET)).update()}frame(){const t=this.device;t.acquire();const e=this.cmdBuff,n=this.framebuffer,i=this.renderArea;i.width=t.nativeWidth,i.height=t.nativeHeight,e.begin(),e.beginRenderPass(n.renderPass,n,i,this.clearColors,1,0);const s=this.logoMat.passes[0],o=im.getOrCreatePipelineState(t,s,this.shader,n.renderPass,this.quadAssmebler);if(e.bindPipelineState(o),e.bindDescriptorSet(Al.MATERIAL,s.descriptorSet),e.bindInputAssembler(this.quadAssmebler),e.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){const i=this.watermarkMat.passes[0],s=im.getOrCreatePipelineState(t,i,this.shader,n.renderPass,this.quadAssmebler);e.bindPipelineState(s),e.bindDescriptorSet(Al.MATERIAL,i.descriptorSet),e.bindInputAssembler(this.quadAssmebler),e.draw(this.quadAssmebler)}e.endRenderPass(),e.end(),t.flushCommands([e]),t.queue.submit([e]),t.present()}destroy(){this.callBack=null,this.root=null,this.device=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler.destroy(),this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,Ug._ins=void 0}static get instance(){return Ug._ins||(Ug._ins=new Ug),Ug._ins}constructor(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}}Ug._ins=void 0,i.internal.SplashScreen=Ug;let Hg,Gg,Vg,jg,Wg,kg,qg=10,Xg=0;const Yg=new Map;function Kg(t,e){for(const n of e)Array.isArray(n)?Kg(t,n):t.push(n)}function $g(t){const e=[];return Kg(e,t),e.join("")}jg=(t,e,n,i,s,o,r)=>{const a=Yg.get(o);a&&a.logTimes>a.count&&(s(`'%s' is deprecated, please use '%s' instead. ${r}`,`${t}.${e}`,`${n}.${i}`),a.count++)},Hg=t("replaceProperty",((t,e,n)=>{null!=t&&n.forEach((n=>{const i=Xg++;Yg.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:qg});const s=null!=n.target?n.target:t,o=null!=n.newName?n.newName:n.name,r=null!=n.targetName?n.targetName:e,a=s===t,c=n.suggest?`(${n.suggest})`:"";if(null!=n.customFunction)t[n.name]=function(){return jg(e,n.name,r,o,d,i,c),n.customFunction.call(this,...arguments)};else if(null!=n.customSetter||null!=n.customGetter){const s=null!=n.customSetter,a=null!=n.customGetter;s&&a?Object.defineProperty(t,n.name,{get(){return jg(e,n.name,r,o,d,i,c),n.customGetter.call(this)},set(t){jg(e,n.name,r,o,d,i,c),n.customSetter.call(this,t)},enumerable:!1}):s?Object.defineProperty(t,n.name,{set(t){jg(e,n.name,r,o,d,i,c),n.customSetter.call(this,t)},enumerable:!1}):a&&Object.defineProperty(t,n.name,{get(){return jg(e,n.name,r,o,d,i,c),n.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(t,n.name,{get(){return jg(e,n.name,r,o,d,i,c),a?this[o]:s[o]},set(t){jg(e,n.name,r,o,d,i,c),a?this[o]=t:s[o]=t},enumerable:!1})}))})),kg=(t,e,n,i,s)=>{const o=Yg.get(i);o&&o.logTimes>o.count&&(n(`'%s' has been removed. ${s}`,`${t}.${e}`),o.count++)},Gg=t("removeProperty",((t,e,n)=>{null!=t&&n.forEach((n=>{const i=Xg++;Yg.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:qg});const s=n.suggest?`(${n.suggest})`:"";Object.defineProperty(t,n.name,{get:()=>kg(e,n.name,p,i,s),set(){kg(e,n.name,p,i,s)},enumerable:!1})}))})),Wg=(t,e,n,i,s)=>{const o=Yg.get(i);o&&o.logTimes>o.count&&(n(`'%s' is deprecated. ${s}`,`${t}.${e}`),o.count++)},Vg=t("markAsWarning",((t,e,n)=>{if(null==t)return;const i=(e,n,i,s,o,r)=>{if(e.get){const t=e.get;e.get=function(){return Wg(n,i,s,o,r),t.call(this)}}if(e.set){const t=e.set;e.set=function(e){Wg(n,i,s,o,r),t.call(this,e)}}Object.defineProperty(t,i,e)};n.forEach((n=>{const s=n.name,o=Object.getOwnPropertyDescriptor(t,s);if(!o||!o.configurable)return;const r=Xg++;Yg.set(r,{id:r,count:0,logTimes:void 0!==n.logTimes?n.logTimes:qg});const a=n.suggest?`(${n.suggest})`:"";if(null!=o.value)if("function"==typeof o.value){const n=o.value;t[s]=function(){return Wg(e,s,d,r,a),n.call(this,...arguments)}}else i(o,e,s,d,r,a);else i(o,e,s,d,r,a);Object.defineProperty(t,s,{enumerable:!1})}))}));const Zg=Rn.Flags.Destroyed,Jg=Rn.Flags.PersistentMask,Qg=Se.IDENTIFIER_RE,tv="var ",ev="o",nv={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},iv=Se.escapeForJS;class sv{constructor(t,e){this.varName=void 0,this.expression=void 0,this.varName=t,this.expression=e}toString(){return`${tv+this.varName}=${this.expression};`}}function ov(t,e){return e instanceof sv?new sv(e.varName,t+e.expression):t+e}function rv(t,e,n){Array.isArray(n)?(n[0]=ov(e,n[0]),t.push(n)):t.push(`${ov(e,n)};`)}class av{constructor(t){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=t}append(t,e){this._exps.push([t,e])}writeCode(t){let e;if(this._exps.length>1)t.push(`t=${this._targetExp};`),e="t";else{if(1!==this._exps.length)return;e=this._targetExp}for(let n=0;n<this._exps.length;n++){const i=this._exps[n];rv(t,`${e+cv(i[0])}=`,i[1])}}}function cv(t){return Qg.test(t)?`.${t}`:`[${iv(t)}]`}av.pool=void 0,av.pool=new bt((t=>{t._exps.length=0,t._targetExp=null}),1),av.pool.get=function(t){const e=this._get()||new av;return e._targetExp=t,e};class lv{constructor(t,e){let n;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=e,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=Q(),ht(this.funcModuleCache,nv),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{",`o=R=new ${this.getFuncModule(t.constructor,!0)}();`,"}"),t._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(t),this.enumerateObject(this.codeArray,t),this.globalVariables.length>0&&(n=`${tv+this.globalVariables.join(",")};`);const i=$g(["return (function(R){",n||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",i)(this.objs,this.funcs);for(let t=0,e=this.objsToClear_iN$t.length;t<e;++t)this.objsToClear_iN$t[t]._iN$t=null;this.objsToClear_iN$t.length=0}getFuncModule(t,e){const n=tt(t);if(n){const e=this.funcModuleCache[n];if(e)return e;if(void 0===e){let e=-1!==n.indexOf(".");if(e)try{if(e=t===Function(`return ${n}`)(),e)return this.funcModuleCache[n]=n,n}catch(t){}}}let i=this.funcs.indexOf(t);i<0&&(i=this.funcs.length,this.funcs.push(t));let s=`F[${i}]`;return e&&(s=`(${s})`),this.funcModuleCache[n]=s,s}getObjRef(t){let e=this.objs.indexOf(t);return e<0&&(e=this.objs.length,this.objs.push(t)),`O[${e}]`}setValueType(t,e,n,i){const s=av.pool.get(i);let o=e.constructor.__props__;o||(o=Object.keys(e));for(let t=0;t<o.length;t++){const i=o[t],r=n[i];if(e[i]===r)continue;const a=this.enumerateField(n,i,r);s.append(i,a)}s.writeCode(t),av.pool.put(s)}enumerateCCClass(t,e,n){const s=n.__values__,o=Jt(n);for(let n=0;n<s.length;n++){const r=s[n],a=e[r];let c=o[r+"$_$default"];if(!hv(c,a))if("object"==typeof a&&a instanceof i.ValueType&&(c=Se.getDefault(c),c&&c.constructor===a.constructor)){const e=ev+cv(r);this.setValueType(t,c,a,e)}else this.setObjProp(t,e,r,a)}}instantiateArray(t){if(0===t.length)return"[]";const e="a"+ ++this.localVariableId,n=[new sv(e,`new Array(${t.length})`)];t._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(t);for(let i=0;i<t.length;++i)rv(n,`${e}[${i}]=`,this.enumerateField(t,i,t[i]));return n}instantiateTypedArray(t){const e=t.constructor.name;if(0===t.length)return`new ${e}`;const n="a"+ ++this.localVariableId,i=[new sv(n,`new ${e}(${t.length})`)];t._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(t);for(let e=0;e<t.length;++e)0!==t[e]&&rv(i,`${n}[${e}]=`,t[e]);return i}enumerateField(t,e,n){if("object"==typeof n&&n){const t=n._iN$t;if(t){let e=t.globalVar;if(!e){e=t.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(e);const n=t.source[0];t.source[0]=ov(`${e}=`,n)}return e}return ArrayBuffer.isView(n)?this.instantiateTypedArray(n):Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?iv(n):("_objFlags"===e&&t instanceof Rn&&(n&=Jg),n)}setObjProp(t,e,n,i){rv(t,`${ev+cv(n)}=`,this.enumerateField(e,n,i))}enumerateObject(t,e){const n=e.constructor;if(i.Class._isCCClass(n))this.enumerateCCClass(t,e,n);else for(const n in e){if(!e.hasOwnProperty(n)||95===n.charCodeAt(0)&&95===n.charCodeAt(1)&&"__type__"!==n)continue;const i=e[n];"object"==typeof i&&i&&i===e._iN$t||this.setObjProp(t,e,n,i)}}instantiateObj(t){if(t instanceof i.ValueType)return Se.getNewValueTypeCode(t);if(t instanceof i.Asset)return this.getObjRef(t);if(t._objFlags&Zg)return null;let e;const n=t.constructor;if(i.Class._isCCClass(n)){if(this.parent)if(this.parent instanceof i.Component){if(t instanceof i._BaseNode||t instanceof i.Component)return this.getObjRef(t)}else if(this.parent instanceof i._BaseNode)if(t instanceof i._BaseNode){if(!t.isChildOf(this.parent))return this.getObjRef(t)}else if(t instanceof i.Component&&!t.node.isChildOf(this.parent))return this.getObjRef(t);e=new sv(ev,`new ${this.getFuncModule(n,!0)}()`)}else if(n===Object)e=new sv(ev,"{}");else{if(n)return this.getObjRef(t);e=new sv(ev,"Object.create(null)")}const s=[e];return t._iN$t={globalVar:"",source:s},this.objsToClear_iN$t.push(t),this.enumerateObject(s,t),["(function(){",s,"return o;})();"]}}function hv(t,e){if("function"==typeof t)try{t=t()}catch(t){return!1}if(t===e)return!0;if(t&&e&&"object"==typeof t&&"object"==typeof e&&t.constructor===e.constructor)if(t instanceof i.ValueType){if(t.equals(e))return!0}else{if(Array.isArray(t))return 0===t.length&&0===e.length;if(t.constructor===Object)return Y(t)&&Y(e)}return!1}class _v{get uiTransformComp(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp}set uiTransformComp(t){this._uiTransformComp=t}get uiComp(){return this._uiComp}set uiComp(t){this._uiComp&&t?E(12002):this._uiComp=t}constructor(t){this._uiComp=null,this.opacity=1,this.localOpacity=1,this._uiTransformComp=null,this._node=void 0,this._node=t}}var uv,dv,pv,fv,mv,gv,vv,yv,xv;Rn.Flags.Destroying;const Sv=Rn.Flags.Destroying,Tv=Rn.Flags.DontDestroy,Ev=Rn.Flags.Deactivating,Av=new V("Node");function Cv(t){return t?"string"==typeof t?At(t):t:(C(3804),null)}let bv=t("BaseNode",i_("cc.BaseNode")((xv=yv=class t extends Rn{get components(){return this._components}get _persistNode(){return(this._objFlags&Tv)>0}set _persistNode(t){t?this._objFlags|=Tv:this._objFlags&=~Tv}get name(){return this._name}set name(t){this._name=t}get uuid(){return this._id}get children(){return this._children}get active(){return this._active}set active(t){if(this._active!==t){this._active=t;const e=this._parent;e&&e._activeInHierarchy&&i.director._nodeActivator.activateNode(this,t)}}get activeInHierarchy(){return this._activeInHierarchy}get parent(){return this._parent}set parent(t){this.setParent(t)}get scene(){return this._scene}get eventProcessor(){return this._eventProcessor}static _setScene(t){t._updateScene()}static _findComponent(t,e){const n=e,i=t._components;if(n._sealed)for(let t=0;t<i.length;++t){const n=i[t];if(n.constructor===e)return n}else for(let t=0;t<i.length;++t){const n=i[t];if(n instanceof e)return n}return null}static _findComponents(t,e,n){const i=e,s=t._components;if(i._sealed)for(let t=0;t<s.length;++t){const i=s[t];i.constructor===e&&n.push(i)}else for(let t=0;t<s.length;++t){const i=s[t];i instanceof e&&n.push(i)}}static _findChildComponent(e,n){for(let i=0;i<e.length;++i){const s=e[i];let o=t._findComponent(s,n);if(o)return o;if(s._children.length>0&&(o=t._findChildComponent(s._children,n),o))return o}return null}static _findChildComponents(e,n,i){for(let s=0;s<e.length;++s){const o=e[s];t._findComponents(o,n,i),o._children.length>0&&t._findChildComponents(o._children,n,i)}}_updateScene(){null==this._parent?p("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene}constructor(t){super(t),Xh(this,"_parent",pv,this),Xh(this,"_children",fv,this),Xh(this,"_active",mv,this),Xh(this,"_components",gv,this),Xh(this,"_prefab",vv,this),this._scene=null,this._activeInHierarchy=!1,this._id=Av.getNewId(),this._name=void 0,this._eventProcessor=new i.NodeEventProcessor(this),this._eventMask=0,this._siblingIndex=0,this._originalSceneId="",this._registerIfAttached=void 0,this._name=void 0!==t?t:"New Node"}attr(t){ht(this,t)}getParent(){return this._parent}setParent(t,e=!1){if(this._parent===t)return;const n=this._parent,i=t;if(this._parent=i,this._siblingIndex=0,this._onSetParent(n,e),this.emit&&this.emit(Mp.PARENT_CHANGED,n),n&&!(n._objFlags&Sv)){const t=n._children.indexOf(this);n._children.splice(t,1),n._updateSiblingIndex(),n.emit&&n.emit(Mp.CHILD_REMOVED,this)}i&&(i._children.push(this),this._siblingIndex=i._children.length-1,i.emit&&i.emit(Mp.CHILD_ADDED,this)),this._onHierarchyChanged(n)}getChildByUuid(t){if(!t)return u("Invalid uuid"),null;const e=this._children;for(let n=0,i=e.length;n<i;n++)if(e[n]._id===t)return e[n];return null}getChildByName(t){if(!t)return u("Invalid name"),null;const e=this._children;for(let n=0,i=e.length;n<i;n++)if(e[n]._name===t)return e[n];return null}getChildByPath(t){const e=t.split("/");let n=this;for(let t=0;t<e.length;++t){const i=e[t];if(0===i.length)continue;const s=n.children.find((t=>t.name===i));if(!s)return null;n=s}return n}addChild(t){t.setParent(this)}insertChild(t,e){t.parent=this,t.setSiblingIndex(e)}getSiblingIndex(){return this._siblingIndex}setSiblingIndex(t){if(!this._parent)return;if(this._parent._objFlags&Ev)return void C(3821);const e=this._parent._children;t=-1!==t?t:e.length-1;const n=e.indexOf(this);t!==n&&(e.splice(n,1),t<e.length?e.splice(t,0,this):e.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(t))}walk(e,n){let i=1,s=null,o=null,r=0,a=t._stacks[t._stackId];a||(a=[],t._stacks.push(a)),t._stackId++,a.length=0,a[0]=this;let c=null,l=!1;for(;i;)if(i--,o=a[i],o)if(!l&&e?e(o):l&&n&&n(o),a[i]=null,l){if(c===this._parent)break;if(l=!1,s)if(r++,s[r])a[i]=s[r],i++;else if(c&&(a[i]=c,i++,l=!0,c._parent?(s=c._parent._children,r=s.indexOf(c),c=c._parent):(c=null,s=null),r<0))break}else o._children.length>0?(c=o,s=o._children,r=0,a[i]=s[r],i++):(a[i]=o,i++,l=!0);a.length=0,t._stackId--}removeFromParent(){this._parent&&this._parent.removeChild(this)}removeChild(t){this._children.indexOf(t)>-1&&(t.parent=null)}removeAllChildren(){const t=this._children;for(let e=t.length-1;e>=0;e--){const n=t[e];n&&(n.parent=null)}this._children.length=0}isChildOf(t){let e=this;do{if(e===t)return!0;e=e._parent}while(e);return!1}getComponent(e){const n=Cv(e);return n?t._findComponent(this,n):null}getComponents(e){const n=Cv(e),i=[];return n&&t._findComponents(this,n,i),i}getComponentInChildren(e){const n=Cv(e);return n?t._findChildComponent(this._children,n):null}getComponentsInChildren(e){const n=Cv(e),i=[];return n&&(t._findComponents(this,n,i),t._findChildComponents(this._children,n,i)),i}addComponent(t){let e;if("string"==typeof t){if(e=At(t),!e)throw i._RF.peek()&&C(3808,t),TypeError(D(3807,t))}else{if(!t)throw TypeError(D(3804));e=t}if("function"!=typeof e)throw TypeError(D(3809));if(!dt(e,i.Component))throw TypeError(D(3810));const n=e._requireComponent;n&&!this.getComponent(n)&&this.addComponent(n);const s=new e;return s.node=this,this._components.push(s),this._activeInHierarchy&&i.director._nodeActivator.activateComp(s),s}removeComponent(t){if(!t)return void C(3813);let e=null;e=t instanceof Ad?t:this.getComponent(t),e&&e.destroy()}on(t,e,n,i=!1){switch(t){case Mp.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(t,e,n,i)}off(t,e,n,i=!1){if(this._eventProcessor.off(t,e,n,i),!this._eventProcessor.hasEventListener(t))switch(t){case Mp.TRANSFORM_CHANGED:this._eventMask&=-2}}once(t,e,n,i){this._eventProcessor.once(t,e,n,i)}emit(t,e,n,i,s,o){this._eventProcessor.emit(t,e,n,i,s,o)}dispatchEvent(t){this._eventProcessor.dispatchEvent(t)}hasEventListener(t,e,n){return this._eventProcessor.hasEventListener(t,e,n)}targetOff(t){this._eventProcessor.targetOff(t),1&this._eventMask&&!this._eventProcessor.hasEventListener(Mp.TRANSFORM_CHANGED)&&(this._eventMask&=-2)}destroy(){return!!super.destroy()&&(this.active=!1,!0)}destroyAllChildren(){const t=this._children;for(let e=0;e<t.length;++e)t[e].destroy()}_removeComponent(t){if(t){if(!(this._objFlags&Sv)){const e=this._components.indexOf(t);-1!==e?this._components.splice(e,1):t.node!==this&&C(3815)}}else C(3814)}_updateSiblingIndex(){for(let t=0;t<this._children.length;++t)this._children[t]._siblingIndex=t;this.emit(Mp.SIBLING_ORDER_CHANGED)}_onSetParent(e,n=!1){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(t._setScene))}_onPostActivated(t){}_onBatchCreated(t){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))}_onPreDestroy(){this._onPreDestroyBase()}_onHierarchyChanged(t){return this._onHierarchyChangedBase(t)}_instantiate(t,e){return t||(t=i.instantiate._clone(this,this)),t._prefab,t._parent=null,t._onBatchCreated(e),t}_onHierarchyChangedBase(t){const e=this._parent;!this._persistNode||e instanceof i.Scene||i.game.removePersistRootNode(this);const n=this._active&&!(!e||!e._activeInHierarchy);this._activeInHierarchy!==n&&i.director._nodeActivator.activateNode(this,n)}_onPreDestroyBase(){this._objFlags|=Sv;const t=this._parent,e=!!t&&0!=(t._objFlags&Sv);if(this._persistNode&&i.game.removePersistRootNode(this),!e&&t){this.emit(Mp.PARENT_CHANGED,this);const e=t._children.indexOf(this);t._children.splice(e,1),this._siblingIndex=0,t._updateSiblingIndex(),t.emit&&t.emit(Mp.CHILD_REMOVED,this)}this.emit(Mp.NODE_DESTROYED,this),this._eventProcessor.destroy();const n=this._children;for(let t=0;t<n.length;++t)n[t]._destroyImmediate();const s=this._components;for(let t=0;t<s.length;++t)s[t]._destroyImmediate();return e}},yv.idGenerator=Av,yv._stacks=[[]],yv._stackId=0,Yh((dv=xv).prototype,"_persistNode",[a_],Object.getOwnPropertyDescriptor(dv.prototype,"_persistNode"),dv.prototype),Yh(dv.prototype,"name",[m_],Object.getOwnPropertyDescriptor(dv.prototype,"name"),dv.prototype),Yh(dv.prototype,"children",[m_],Object.getOwnPropertyDescriptor(dv.prototype,"children"),dv.prototype),Yh(dv.prototype,"active",[m_],Object.getOwnPropertyDescriptor(dv.prototype,"active"),dv.prototype),Yh(dv.prototype,"activeInHierarchy",[m_],Object.getOwnPropertyDescriptor(dv.prototype,"activeInHierarchy"),dv.prototype),Yh(dv.prototype,"parent",[m_],Object.getOwnPropertyDescriptor(dv.prototype,"parent"),dv.prototype),pv=Yh(dv.prototype,"_parent",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fv=Yh(dv.prototype,"_children",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mv=Yh(dv.prototype,"_active",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),gv=Yh(dv.prototype,"_components",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vv=Yh(dv.prototype,"_prefab",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),uv=dv))||uv);function Pv(t){const e=t._prefab;if(!e)return;if(!e.instance)return;if(!e.asset)return C(3701,t.name),void(e.instance=void 0);const n=t._objFlags,s=t._parent,o=t._id,r=t._prefab;i.game._isCloning=!0,e.asset._doInstantiate(t),i.game._isCloning=!1,t._objFlags=n,t._parent=s,t._id=o,t._prefab&&(t._prefab.instance=null==r?void 0:r.instance)}function wv(t,e,n){var i;if(!e)return;let s=e;const o=null===(i=t._prefab)||void 0===i?void 0:i.instance;!n&&o&&(e[o.fileId]={},s=e[o.fileId]);const r=t._prefab;r&&(s[r.fileId]=t);const a=t.components;for(let t=0;t<a.length;t++){const e=a[t];e.__prefab&&(s[e.__prefab.fileId]=e)}for(let e=0;e<t.children.length;e++)wv(t.children[e],s,!1)}function Dv(t,e){if(!t)return null;let n=null,i=e;for(let e=0;e<t.length;e++){if(!i)return null;i=i[t[e]]}return n=i,n}function Iv(t,e,n){if(e)for(let t=0;t<e.length;t++){const i=e[t];if(i&&i.targetInfo){const t=Dv(i.targetInfo.localID,n);if(!t)continue;let e=n;const s=i.targetInfo.localID;if(s.length>0)for(let t=0;t<s.length-1;t++)e=e[s[t]];if(i.nodes)for(let n=0;n<i.nodes.length;n++){const s=i.nodes[n];s&&(t._children.push(s),s._parent=t,wv(s,e,!1),s._siblingIndex=t._children.length-1,s._onBatchCreated(!1))}}}}function Rv(t,e,n){if(e)for(let t=0;t<e.length;t++){const i=e[t];if(i&&i.targetInfo){const t=Dv(i.targetInfo.localID,n);if(!t)continue;if(i.components)for(let e=0;e<i.components.length;e++){const n=i.components[e];n&&(n.node=t,t._components.push(n))}}}}function Ov(t,e,n){if(e)for(let t=0;t<e.length;t++){const i=e[t];if(i){const t=Dv(i.localID,n);if(!t||!t.node)continue;const e=t.node.components.indexOf(t);e>=0&&t.node._components.splice(e,1)}}}function Mv(t,e,n){if(e.length<=0)return;let i=null;for(let t=0;t<e.length;t++){const s=e[t];if(s&&s.targetInfo){if(i=Dv(s.targetInfo.localID,n),!i)continue;let t=i;const e=s.propertyPath.slice();if(e.length>0){const n=e.pop();if(!n)continue;for(let n=0;n<e.length&&(t=t[e[n]],t);n++);if(!t)continue;if(Array.isArray(t))if("length"===n)t[n]=s.value;else{const e=Number.parseInt(n);Number.isInteger(e)&&e<t.length&&(t[n]=s.value)}else t[n]=s.value}}}}function Nv(t){var e;const n=null===(e=t._prefab)||void 0===e?void 0:e.targetOverrides;if(n)for(let t=0;t<n.length;t++){var i,s;const e=n[t];let a=e.source;const c=e.sourceInfo;if(c){var o,r;const t=null===(o=e.source)||void 0===o||null===(r=o._prefab)||void 0===r?void 0:r.instance;t&&t.targetMap&&(a=Dv(c.localID,t.targetMap))}if(!a)continue;let l=null;const h=e.targetInfo;if(!h)continue;const _=null===(i=e.target)||void 0===i||null===(s=i._prefab)||void 0===s?void 0:s.instance;if(!_||!_.targetMap)continue;if(l=Dv(h.localID,_.targetMap),!l)continue;const u=e.propertyPath.slice();let d=a;if(u.length>0){const t=u.pop();if(!t)return;for(let t=0;t<u.length&&(d=d[u[t]],d);t++);if(!d)continue;d[t]=l}}}var Lv,Bv,Fv,zv,Uv,Hv,Gv,Vv,jv,Wv,kv;i._BaseNode=bv;const qv=new $e,Xv=new rn,Yv=new rn,Kv=new Array(10),$v=new rn,Zv=new nn,Jv=new nn,Qv=new pn,ty=new Map;let ey=t("Node",(Lv=i_("cc.Node"),Bv=O_($e),Lv((kv=Wv=class t extends bv{constructor(t){super(t),this._uiProps=new _v(this),this._static=!1,this._pos=new $e,this._rot=new rn,this._scale=new $e(1,1,1),this._mat=new pn,Xh(this,"_lpos",Uv,this),Xh(this,"_lrot",Hv,this),Xh(this,"_lscale",Gv,this),Xh(this,"_layer",Vv,this),Xh(this,"_euler",jv,this),this._dirtyFlags=Hh.NONE,this._eulerDirty=!1,this._poolHandle=0,this._poolHandle=ls.alloc(),ls.set(this._poolHandle,as.LAYER,this._layer)}static isNode(e){return e instanceof t&&(e.constructor===t||!(e instanceof i.Scene))}destroy(){return this._poolHandle&&(ls.free(this._poolHandle),this._poolHandle=0),super.destroy()}get handle(){return this._poolHandle}get position(){return this._lpos}set position(t){this.setPosition(t)}get worldPosition(){return this.updateWorldTransform(),this._pos}set worldPosition(t){this.setWorldPosition(t)}get rotation(){return this._lrot}set rotation(t){this.setRotation(t)}set eulerAngles(t){this.setRotationFromEuler(t.x,t.y,t.z)}get eulerAngles(){return this._eulerDirty&&(rn.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler}get angle(){return this._euler.z}set angle(t){$e.set(this._euler,0,0,t),rn.fromAngleZ(this._lrot,t),this._eulerDirty=!1,this.invalidateChildren(Hh.ROTATION),1&this._eventMask&&this.emit(Mp.TRANSFORM_CHANGED,Hh.ROTATION)}get worldRotation(){return this.updateWorldTransform(),this._rot}set worldRotation(t){this.setWorldRotation(t)}get scale(){return this._lscale}set scale(t){this.setScale(t)}get worldScale(){return this.updateWorldTransform(),this._scale}set worldScale(t){this.setWorldScale(t)}set matrix(t){pn.toRTS(t,this._lrot,this._lpos,this._lscale),this.invalidateChildren(Hh.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(Mp.TRANSFORM_CHANGED,Hh.TRS)}get worldMatrix(){return this.updateWorldTransform(),this._mat}get forward(){return $e.transformQuat(new $e,$e.FORWARD,this.worldRotation)}set forward(t){const e=t.length();$e.multiplyScalar(qv,t,-1/e),rn.fromViewUp(Xv,qv),this.setWorldRotation(Xv)}set layer(t){this._layer=t,ls.set(this._poolHandle,as.LAYER,this._layer),this.emit(Mp.LAYER_CHANGED,this._layer)}get layer(){return this._layer}get hasChangedFlags(){return ty.get(this)||0}set hasChangedFlags(t){ty.set(this,t),ls.set(this._poolHandle,as.FLAGS_CHANGED,t)}setParent(t,e=!1){e&&this.updateWorldTransform(),super.setParent(t,e)}_onSetParent(t,e){if(super._onSetParent(t,e),e){const t=this._parent;t?(t.updateWorldTransform(),pn.multiply(Qv,pn.invert(Qv,t._mat),this._mat),pn.toRTS(Qv,this._lrot,this._lpos,this._lscale)):($e.copy(this._lpos,this._pos),rn.copy(this._lrot,this._rot),$e.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(Hh.TRS)}_onHierarchyChanged(t){this.eventProcessor.reattach(),super._onHierarchyChangedBase(t)}_onBatchCreated(t){var e;ls.set(this._poolHandle,as.LAYER,this._layer),ls.setVec3(this._poolHandle,as.WORLD_SCALE,this._scale);const n=null===(e=this._prefab)||void 0===e?void 0:e.instance;!t&&n&&Pv(this),this.hasChangedFlags=Hh.TRS,this._dirtyFlags=Hh.TRS;const i=this._children.length;for(let e=0;e<i;++e)this._children[e]._siblingIndex=e,this._children[e]._onBatchCreated(t);if(!t&&n){const t={};n.targetMap=t,wv(this,t,!0),Iv(0,n.mountedChildren,t),Ov(0,n.removedComponents,t),Rv(0,n.mountedComponents,t),Mv(0,n.propertyOverrides,t)}Nv(this)}_onBeforeSerialize(){this.eulerAngles}_onPostActivated(t){t?(Kp.resumeTarget(this),this.invalidateChildren(Hh.TRS)):Kp.pauseTarget(this)}translate(t,e){const n=e||Uh.LOCAL;if(n===Uh.LOCAL)$e.transformQuat(qv,t,this._lrot),this._lpos.x+=qv.x,this._lpos.y+=qv.y,this._lpos.z+=qv.z;else if(n===Uh.WORLD)if(this._parent){rn.invert(Xv,this._parent.worldRotation),$e.transformQuat(qv,t,Xv);const e=this.worldScale;this._lpos.x+=qv.x/e.x,this._lpos.y+=qv.y/e.y,this._lpos.z+=qv.z/e.z}else this._lpos.x+=t.x,this._lpos.y+=t.y,this._lpos.z+=t.z;this.invalidateChildren(Hh.POSITION),1&this._eventMask&&this.emit(Mp.TRANSFORM_CHANGED,Hh.POSITION),ls.setVec3(this._poolHandle,as.WORLD_POSITION,this.worldPosition)}rotate(t,e){const n=e||Uh.LOCAL;if(rn.normalize(Xv,t),n===Uh.LOCAL)rn.multiply(this._lrot,this._lrot,Xv);else if(n===Uh.WORLD){const t=this.worldRotation;rn.multiply(Yv,Xv,t),rn.invert(Xv,t),rn.multiply(Yv,Xv,Yv),rn.multiply(this._lrot,this._lrot,Yv)}this._eulerDirty=!0,this.invalidateChildren(Hh.ROTATION),1&this._eventMask&&this.emit(Mp.TRANSFORM_CHANGED,Hh.ROTATION),ls.setVec4(this._poolHandle,as.WORLD_ROTATION,this.worldRotation)}lookAt(t,e){this.getWorldPosition(qv),$e.subtract(qv,qv,t),$e.normalize(qv,qv),rn.fromViewUp(Xv,qv,e),this.setWorldRotation(Xv)}invalidateChildren(t){const e=this.hasChangedFlags;if((this._dirtyFlags&e&t)===t)return;this._dirtyFlags|=t,this.hasChangedFlags=e|t;const n=t|Hh.POSITION,i=this._children.length;for(let t=0;t<i;++t){const e=this._children[t];e.isValid&&e.invalidateChildren(n)}}updateWorldTransform(){if(!this._dirtyFlags)return;let t,e=this,n=0;for(;e&&e._dirtyFlags;)Kv[n++]=e,e=e._parent;let i=0;for(;n;)t=Kv[--n],i|=t._dirtyFlags,e?(i&Hh.POSITION&&($e.transformMat4(t._pos,t._lpos,e._mat),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z,ls.setVec3(t._poolHandle,as.WORLD_POSITION,t._pos)),i&Hh.RS&&(pn.fromRTS(t._mat,t._lrot,t._lpos,t._lscale),pn.multiply(t._mat,e._mat,t._mat),i&Hh.ROTATION&&(rn.multiply(t._rot,e._rot,t._lrot),ls.setVec4(t._poolHandle,as.WORLD_ROTATION,t._rot)),nn.fromQuat(Zv,rn.conjugate($v,t._rot)),nn.multiplyMat4(Zv,Zv,t._mat),t._scale.x=Zv.m00,t._scale.y=Zv.m04,t._scale.z=Zv.m08,ls.setVec3(t._poolHandle,as.WORLD_SCALE,t._scale))):(i&Hh.POSITION&&($e.copy(t._pos,t._lpos),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z,ls.setVec3(t._poolHandle,as.WORLD_POSITION,t._pos)),i&Hh.RS&&(i&Hh.ROTATION&&(rn.copy(t._rot,t._lrot),ls.setVec4(t._poolHandle,as.WORLD_ROTATION,t._rot)),i&Hh.SCALE&&($e.copy(t._scale,t._lscale),ls.setVec3(t._poolHandle,as.WORLD_SCALE,t._scale),pn.fromRTS(t._mat,t._rot,t._pos,t._scale)))),i!==Hh.NONE&&ls.setMat4(t._poolHandle,as.WORLD_MATRIX,t._mat),t._dirtyFlags=Hh.NONE,e=t}setPosition(t,e,n){void 0===e&&void 0===n?$e.copy(this._lpos,t):void 0===n?$e.set(this._lpos,t,e,this._lpos.z):$e.set(this._lpos,t,e,n),this.invalidateChildren(Hh.POSITION),1&this._eventMask&&this.emit(Mp.TRANSFORM_CHANGED,Hh.POSITION)}getPosition(t){return t?$e.set(t,this._lpos.x,this._lpos.y,this._lpos.z):$e.copy(new $e,this._lpos)}setRotation(t,e,n,i){void 0===e||void 0===n||void 0===i?rn.copy(this._lrot,t):rn.set(this._lrot,t,e,n,i),this._eulerDirty=!0,this.invalidateChildren(Hh.ROTATION),1&this._eventMask&&this.emit(Mp.TRANSFORM_CHANGED,Hh.ROTATION)}setRotationFromEuler(t,e,n){const i=void 0===n?this._euler.z:n;void 0===e?($e.copy(this._euler,t),rn.fromEuler(this._lrot,t.x,t.y,t.z)):($e.set(this._euler,t,e,i),rn.fromEuler(this._lrot,t,e,i)),this._eulerDirty=!1,this.invalidateChildren(Hh.ROTATION),1&this._eventMask&&this.emit(Mp.TRANSFORM_CHANGED,Hh.ROTATION)}getRotation(t){return t?rn.set(t,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):rn.copy(new rn,this._lrot)}setScale(t,e,n){void 0===e&&void 0===n?$e.copy(this._lscale,t):void 0===n?$e.set(this._lscale,t,e,this._lscale.z):$e.set(this._lscale,t,e,n),this.invalidateChildren(Hh.SCALE),1&this._eventMask&&this.emit(Mp.TRANSFORM_CHANGED,Hh.SCALE)}getScale(t){return t?$e.set(t,this._lscale.x,this._lscale.y,this._lscale.z):$e.copy(new $e,this._lscale)}inverseTransformPoint(t,e){$e.copy(t,e);let n=this,i=0;for(;n._parent;)Kv[i++]=n,n=n._parent;for(;i>=0;)$e.transformInverseRTS(t,t,n._lrot,n._lpos,n._lscale),n=Kv[--i];return t}setWorldPosition(t,e,n){void 0===e||void 0===n?$e.copy(this._pos,t):$e.set(this._pos,t,e,n),ls.setVec3(this._poolHandle,as.WORLD_POSITION,this._pos);const i=this._parent,s=this._lpos;i?(i.updateWorldTransform(),$e.transformMat4(s,this._pos,pn.invert(Qv,i._mat))):$e.copy(s,this._pos),this.invalidateChildren(Hh.POSITION),1&this._eventMask&&this.emit(Mp.TRANSFORM_CHANGED,Hh.POSITION)}getWorldPosition(t){return this.updateWorldTransform(),t?$e.copy(t,this._pos):$e.copy(new $e,this._pos)}setWorldRotation(t,e,n,i){void 0===e||void 0===n||void 0===i?rn.copy(this._rot,t):rn.set(this._rot,t,e,n,i),ls.setVec4(this._poolHandle,as.WORLD_ROTATION,this._rot),this._parent?(this._parent.updateWorldTransform(),rn.multiply(this._lrot,rn.conjugate(this._lrot,this._parent._rot),this._rot)):rn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Hh.ROTATION),1&this._eventMask&&this.emit(Mp.TRANSFORM_CHANGED,Hh.ROTATION)}setWorldRotationFromEuler(t,e,n){rn.fromEuler(this._rot,t,e,n),this._parent?(this._parent.updateWorldTransform(),rn.multiply(this._lrot,rn.conjugate(this._lrot,this._parent._rot),this._rot)):rn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Hh.ROTATION),1&this._eventMask&&this.emit(Mp.TRANSFORM_CHANGED,Hh.ROTATION)}getWorldRotation(t){return this.updateWorldTransform(),t?rn.copy(t,this._rot):rn.copy(new rn,this._rot)}setWorldScale(t,e,n){void 0===e||void 0===n?$e.copy(this._scale,t):$e.set(this._scale,t,e,n),ls.setVec3(this._poolHandle,as.WORLD_SCALE,this._scale);const i=this._parent;i?(i.updateWorldTransform(),nn.fromQuat(Zv,rn.conjugate($v,i._rot)),nn.multiplyMat4(Zv,Zv,i._mat),Jv.m00=this._scale.x,Jv.m04=this._scale.y,Jv.m08=this._scale.z,nn.multiply(Zv,Jv,nn.invert(Zv,Zv)),this._lscale.x=$e.set(qv,Zv.m00,Zv.m01,Zv.m02).length(),this._lscale.y=$e.set(qv,Zv.m03,Zv.m04,Zv.m05).length(),this._lscale.z=$e.set(qv,Zv.m06,Zv.m07,Zv.m08).length()):$e.copy(this._lscale,this._scale),this.invalidateChildren(Hh.SCALE),1&this._eventMask&&this.emit(Mp.TRANSFORM_CHANGED,Hh.SCALE)}getWorldScale(t){return this.updateWorldTransform(),t?$e.copy(t,this._scale):$e.copy(new $e,this._scale)}getWorldMatrix(t){this.updateWorldTransform();const e=t||new pn;return pn.copy(e,this._mat)}getWorldRS(t){this.updateWorldTransform();const e=t||new pn;return pn.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e}getWorldRT(t){this.updateWorldTransform();const e=t||new pn;return pn.fromRT(e,this._rot,this._pos)}setRTS(t,e,n){let i=0;t&&(i|=Hh.ROTATION,void 0!==t.w?(rn.copy(this._lrot,t),this._eulerDirty=!0):($e.copy(this._euler,t),rn.fromEuler(this._lrot,t.x,t.y,t.z),this._eulerDirty=!1)),e&&($e.copy(this._lpos,e),i|=Hh.POSITION),n&&($e.copy(this._lscale,n),i|=Hh.SCALE),i&&(this.invalidateChildren(i),1&this._eventMask&&this.emit(Mp.TRANSFORM_CHANGED,i))}pauseSystemEvents(t){Kp.pauseTarget(this,t)}resumeSystemEvents(t){Kp.resumeTarget(this,t)}static clearBooks(){ty.forEach(((t,e)=>{e.isValid&&(e.hasChangedFlags=Hh.NONE)})),ty.clear()}syncToNativeTransform(){const t=this.hasChangedFlags;t&&(t&Hh.POSITION&&ls.setVec3(this._poolHandle,as.WORLD_POSITION,this.worldPosition),t&Hh.ROTATION&&ls.setVec3(this._poolHandle,as.WORLD_ROTATION,this.worldRotation),t&Hh.SCALE&&ls.setVec3(this._poolHandle,as.WORLD_SCALE,this.worldScale))}syncFromNativeTransform(){const t=ls.get(this._poolHandle,as.FLAGS_CHANGED);t&&(t&Hh.POSITION&&(ls.getVec3(this._poolHandle,as.WORLD_POSITION,qv),this.setWorldPosition(qv)),t&Hh.ROTATION&&(ls.getVec4(this._poolHandle,as.WORLD_ROTATION,Xv),this.setWorldRotation(Xv)),t&Hh.SCALE&&(ls.getVec3(this._poolHandle,as.WORLD_SCALE,qv),this.setWorldScale(qv)))}},Wv.bookOfChange=ty,Wv.EventType=Mp,Wv.NodeSpace=Uh,Wv.TransformDirtyBit=Hh,Wv.TransformBit=Hh,Uv=Yh((zv=kv).prototype,"_lpos",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $e}}),Hv=Yh(zv.prototype,"_lrot",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rn}}),Gv=Yh(zv.prototype,"_lscale",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $e(1,1,1)}}),Vv=Yh(zv.prototype,"_layer",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dl.Enum.DEFAULT}}),jv=Yh(zv.prototype,"_euler",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $e}}),Yh(zv.prototype,"eulerAngles",[Bv],Object.getOwnPropertyDescriptor(zv.prototype,"eulerAngles"),zv.prototype),Yh(zv.prototype,"angle",[m_],Object.getOwnPropertyDescriptor(zv.prototype,"angle"),zv.prototype),Yh(zv.prototype,"layer",[m_],Object.getOwnPropertyDescriptor(zv.prototype,"layer"),zv.prototype),Fv=zv))||Fv));var ny,iy,sy,oy,ry,ay,cy,ly,hy,_y,uy,dy,py,fy,my,gy,vy,yy,xy,Sy,Ty,Ey,Ay,Cy,by,Py,wy,Dy,Iy,Ry,Oy,My,Ny,Ly,By,Fy,zy,Uy,Hy,Gy,Vy,jy,Wy,ky,qy,Xy,Yy,Ky,$y,Zy,Jy,Qy,tx,ex,nx,ix,sx,ox,rx,ax,cx,lx,hx,_x,ux;i.Node=ey;let dx=i_("cc.TargetInfo")((sy=Yh((iy=class{constructor(){Xh(this,"localID",sy,this)}}).prototype,"localID",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ny=iy))||ny,px=(oy=i_("cc.TargetOverrideInfo"),ry=O_(Rn),ay=O_(dx),cy=O_(ey),ly=O_(dx),oy((uy=Yh((_y=class{constructor(){Xh(this,"source",uy,this),Xh(this,"sourceInfo",dy,this),Xh(this,"propertyPath",py,this),Xh(this,"target",fy,this),Xh(this,"targetInfo",my,this)}}).prototype,"source",[c_,ry],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dy=Yh(_y.prototype,"sourceInfo",[c_,ay],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),py=Yh(_y.prototype,"propertyPath",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fy=Yh(_y.prototype,"target",[c_,cy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),my=Yh(_y.prototype,"targetInfo",[c_,ly],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hy=_y))||hy),fx=i_("cc.CompPrefabInfo")((yy=Yh((vy=class{constructor(){Xh(this,"fileId",yy,this)}}).prototype,"fileId",[c_,m_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),gy=vy))||gy,mx=(xy=i_("CCPropertyOverrideInfo"),Sy=O_(dx),xy((Ay=Yh((Ey=class{constructor(){Xh(this,"targetInfo",Ay,this),Xh(this,"propertyPath",Cy,this),Xh(this,"value",by,this)}isTarget(t,e){}}).prototype,"targetInfo",[c_,Sy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Cy=Yh(Ey.prototype,"propertyPath",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),by=Yh(Ey.prototype,"value",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ty=Ey))||Ty),gx=(Py=i_("cc.MountedChildrenInfo"),wy=O_(dx),Dy=O_([ey]),Py((Oy=Yh((Ry=class{constructor(){Xh(this,"targetInfo",Oy,this),Xh(this,"nodes",My,this)}isTarget(t){}}).prototype,"targetInfo",[c_,wy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),My=Yh(Ry.prototype,"nodes",[c_,Dy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Iy=Ry))||Iy),vx=(Ny=i_("cc.MountedComponentsInfo"),Ly=O_(dx),By=O_([Ad]),Ny((Uy=Yh((zy=class{constructor(){Xh(this,"targetInfo",Uy,this),Xh(this,"components",Hy,this)}isTarget(t){}}).prototype,"targetInfo",[c_,Ly],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hy=Yh(zy.prototype,"components",[c_,By],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Fy=zy))||Fy),yx=(Gy=i_("cc.PrefabInstance"),Vy=O_(ey),jy=O_([gx]),Wy=O_([vx]),ky=O_([mx]),qy=O_([dx]),Gy((Ky=Yh((Yy=class{constructor(){Xh(this,"fileId",Ky,this),Xh(this,"prefabRootNode",$y,this),Xh(this,"mountedChildren",Zy,this),Xh(this,"mountedComponents",Jy,this),Xh(this,"propertyOverrides",Qy,this),Xh(this,"removedComponents",tx,this),this.targetMap={}}findPropertyOverride(t,e){}removePropertyOverride(t,e){}}).prototype,"fileId",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),$y=Yh(Yy.prototype,"prefabRootNode",[c_,Vy],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Zy=Yh(Yy.prototype,"mountedChildren",[c_,jy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Jy=Yh(Yy.prototype,"mountedComponents",[c_,Wy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Qy=Yh(Yy.prototype,"propertyOverrides",[c_,ky],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tx=Yh(Yy.prototype,"removedComponents",[c_,qy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Xy=Yy))||Xy),xx=(ex=i_("cc.PrefabInfo"),nx=O_(ey),ix=O_(i.Prefab),sx=O_(yx),ox=O_([px]),ex((cx=Yh((ax=class{constructor(){Xh(this,"root",cx,this),Xh(this,"asset",lx,this),Xh(this,"fileId",hx,this),Xh(this,"instance",_x,this),Xh(this,"targetOverrides",ux,this)}}).prototype,"root",[c_,nx],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),lx=Yh(ax.prototype,"asset",[c_,ix],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),hx=Yh(ax.prototype,"fileId",[c_,m_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_x=Yh(ax.prototype,"instance",[c_,sx],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ux=Yh(ax.prototype,"targetOverrides",[c_,ox],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),rx=ax))||rx);i._PrefabInfo=xx;var Sx,Tx,Ex,Ax,Cx,bx,Px=Object.freeze({__proto__:null,TargetInfo:dx,TargetOverrideInfo:px,CompPrefabInfo:fx,PropertyOverrideInfo:mx,MountedChildrenInfo:gx,MountedComponentsInfo:vx,PrefabInstance:yx,PrefabInfo:xx,createNodeWithPrefab:Pv,generateTargetMap:wv,getTarget:Dv,applyMountedChildren:Iv,applyMountedComponents:Rv,applyRemovedComponents:Ov,applyPropertyOverrides:Mv,applyTargetOverrides:Nv});const wx=It({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2});let Dx=t("Prefab",i_("cc.Prefab")((bx=Cx=class t extends lu{constructor(){super(),Xh(this,"data",Ex,this),Xh(this,"optimizationPolicy",Ax,this),this._createFunction=void 0,this._instantiatedTimes=void 0,this._createFunction=null,this._instantiatedTimes=0}createNode(t){const e=i.instantiate(this);e.name=this.name,t(null,e)}compileCreateFunction(){this._createFunction=function(t){const e=t instanceof i._BaseNode&&t;return new lv(t,e).result}(this.data)}_doInstantiate(t){return this.data._prefab||E(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(t)}_instantiate(){let e,n=!1;return n=this.optimizationPolicy!==wx.SINGLE_INSTANCE&&(this.optimizationPolicy===wx.MULTI_INSTANCE||this._instantiatedTimes+1>=t.OptimizationPolicyThreshold),n?(e=this._doInstantiate(),this.data._instantiate(e)):e=this.data._instantiate(),++this._instantiatedTimes,e}initDefault(t){super.initDefault(t),this.data=new ey,this.data.name="(Missing Node)";const e=new xx;e.asset=this,e.root=this.data,this.data._prefab=e}validate(){return!!this.data}},Cx.OptimizationPolicy=wx,Cx.OptimizationPolicyThreshold=3,Ex=Yh((Tx=bx).prototype,"data",[c_,m_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ax=Yh(Tx.prototype,"optimizationPolicy",[c_,m_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wx.AUTO}}),Sx=Tx))||Sx);var Ix,Rx,Ox,Mx,Nx,Lx;wt.value(Dx,"_utils",Px),i.Prefab=Dx,et(i,"cc._Prefab","Prefab"),t("PrefabLink",(Ix=i_("cc.PrefabLink"),Rx=O_(Dx),Ox=g_(),Ix((Lx=Yh((Nx=class extends Ad{constructor(...t){super(...t),Xh(this,"prefab",Lx,this)}}).prototype,"prefab",[Rx,c_,Ox],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Mx=Nx))||Mx));const Bx=new $e;function Fx(t,e,n,i){i||(i=new $e),t.convertToUINode(e,n,i);const s=n.position;return i.add(s),i}function zx(t,e,n){return n||(n=new $e),t.worldToScreen(e,n),n.x/=i.view.getScaleX(),n.y/=i.view.getScaleY(),n}const Ux=t("convertUtils",{WorldNode3DToLocalNodeUI:Fx,WorldNode3DToWorldNodeUI:zx});i.pipelineUtils=Ux,Hg(i.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction(...t){const e=t[0],n=t[3]||Bx;return e.convertToUINode(t[1],t[2],n),n.add(t[2].position),t[3]||n.clone()}}]);var Hx=Object.freeze({__proto__:null,ccclass:i_,property:a_,requireComponent:s_,executionOrder:o_,disallowMultiple:r_,executeInEditMode:h_,menu:__,playOnFocus:u_,inspector:d_,icon:p_,help:f_,type:O_,integer:w_,float:D_,boolean:I_,string:R_});t("_decorator",Hx);const Gx=Rn.Flags.Destroyed,Vx=Rn.Flags.PersistentMask,jx=[];function Wx(t){let e;if(t instanceof Rn){if(t._instantiate)return i.game._isCloning=!0,e=t._instantiate(null,!0),i.game._isCloning=!1,e;if(t instanceof i.Asset)throw new TypeError(D(6903))}return i.game._isCloning=!0,e=kx(t),i.game._isCloning=!1,e}function kx(t,e){let n;n=t._iN$t?t._iN$t:t.constructor?new(0,t.constructor):Object.create(null),qx(t,n,e);for(let t=0,e=jx.length;t<e;++t)jx[t]._iN$t=null;return jx.length=0,n}function qx(t,e,n){wt.value(t,"_iN$t",e,!0),jx.push(t);const s=t.constructor;if(i.Class._isCCClass(s))!function(t,e,n,i){const s=t.__values__;for(let t=0;t<s.length;t++){const o=s[t],r=e[o];if("object"==typeof r&&r){const t=n[o];t instanceof Nt&&t.constructor===r.constructor?t.set(r):n[o]=r._iN$t||Xx(r,i)}else n[o]=r}}(s,t,e,n);else for(const i in t){if(!t.hasOwnProperty(i)||95===i.charCodeAt(0)&&95===i.charCodeAt(1)&&"__type__"!==i)continue;const s=t[i];if("object"==typeof s&&s){if(s===e)continue;e[i]=s._iN$t||Xx(s,n)}else e[i]=s}t instanceof Rn&&(e._objFlags&=Vx)}function Xx(t,e){if(t instanceof Nt)return t.clone();if(t instanceof i.Asset)return t;let n;if(ArrayBuffer.isView(t)){const e=t.length;n=new t.constructor(e),t._iN$t=n,jx.push(t);for(let i=0;i<e;++i)n[i]=t[i];return n}if(Array.isArray(t)){const i=t.length;n=new Array(i),t._iN$t=n,jx.push(t);for(let s=0;s<i;++s){const i=t[s];n[s]="object"==typeof i&&i?i._iN$t||Xx(i,e):i}return n}if(t._objFlags&Gx)return null;const s=t.constructor;if(i.Class._isCCClass(s)){if(e)if(e instanceof i.Component){if(t instanceof i._BaseNode||t instanceof i.Component)return t}else if(e instanceof i._BaseNode)if(t instanceof i._BaseNode){if(!t.isChildOf(e))return t}else if(t instanceof i.Component&&t.node&&!t.node.isChildOf(e))return t;n=new s}else if(s===Object)n={};else{if(s)return t;n=Object.create(null)}return qx(t,n,e),n}var Yx,Kx,$x,Zx,Jx,Qx,tS,eS;let nS,iS;function sS(t,e){return(e<<3)+t}Wx._clone=kx,i.instantiate=Wx,function(t){t[t.Uint8=0]="Uint8",t[t.Uint16=1]="Uint16",t[t.Uint32=2]="Uint32",t[t.Int8=3]="Int8",t[t.Int16=4]="Int16",t[t.Int32=5]="Int32",t[t.Float32=6]="Float32",t[t.Float64=7]="Float64"}(nS||(nS={})),function(t){t[t.Scalar=0]="Scalar",t[t.Vec2=1]="Vec2",t[t.Vec3=2]="Vec3",t[t.Vec4=3]="Vec4",t[t.Quat=4]="Quat",t[t.Mat4=5]="Mat4"}(iS||(iS={}));let oS=t("CompactValueTypeArray",i_("cc.CompactValueTypeArray")((eS=tS=class t{constructor(){Xh(this,"_byteOffset",$x,this),Xh(this,"_unitCount",Zx,this),Xh(this,"_unitElement",Jx,this),Xh(this,"_length",Qx,this)}static lengthFor(t,e,n){return rS(e).requiredUnits*t.length*aS(n).BYTES_PER_ELEMENT}static compress(e,n,i,s,o,r){const a=rS(n),c=aS(i),l=a.requiredUnits*e.length,h=new c(s,o,l);for(let t=0;t<e.length;++t)a.compress(h,t,e[t]);const _=new t;return _._unitElement=sS(i,n),_._byteOffset=r,_._unitCount=l,_._length=e.length,_}decompress(t){const{storageUnit:e,elementType:n}={storageUnit:7&(i=this._unitElement),elementType:i>>3};var i;const s=rS(n),o=new(aS(e))(t,this._byteOffset,this._unitCount),r=new Array(this._length);for(let t=0;t<this._length;++t)r[t]=s.decompress(o,t);return r}},tS.StorageUnit=nS,tS.ElementType=iS,$x=Yh((Kx=eS).prototype,"_byteOffset",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Zx=Yh(Kx.prototype,"_unitCount",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jx=Yh(Kx.prototype,"_unitElement",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sS(nS.Uint8,iS.Scalar)}}),Qx=Yh(Kx.prototype,"_length",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Yx=Kx))||Yx);function rS(t){return cS[t]}function aS(t){switch(t){case nS.Uint8:return Uint8Array;case nS.Uint16:return Uint16Array;case nS.Uint32:return Uint32Array;case nS.Int8:return Int8Array;case nS.Int16:return Int16Array;case nS.Int32:return Int32Array;case nS.Float32:return Float32Array;case nS.Float64:return Float64Array}}const cS={[iS.Scalar]:{requiredUnits:1,compress(t,e,n){t[e]=n},decompress:(t,e)=>t[e]},[iS.Vec2]:{requiredUnits:2,compress(t,e,n){t[2*e]=n.x,t[2*e+1]=n.y},decompress:(t,e)=>new $e(t[2*e],t[2*e+1])},[iS.Vec3]:{requiredUnits:3,compress(t,e,n){t[3*e]=n.x,t[3*e+1]=n.y,t[3*e+2]=n.z},decompress:(t,e)=>new $e(t[3*e],t[3*e+1],t[3*e+2])},[iS.Vec4]:{requiredUnits:4,compress(t,e,n){t[4*e]=n.x,t[4*e+1]=n.y,t[4*e+2]=n.z,t[4*e+3]=n.w},decompress:(t,e)=>new tn(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])},[iS.Quat]:{requiredUnits:4,compress(t,e,n){t[4*e]=n.x,t[4*e+1]=n.y,t[4*e+2]=n.z,t[4*e+3]=n.w},decompress:(t,e)=>new rn(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])},[iS.Mat4]:{requiredUnits:16,compress(t,e,n){pn.toArray(t,n,16*e)},decompress:(t,e)=>pn.fromArray(new pn,t,16*e)}};var lS,hS;i._decorator=Hx,Gg(Hu.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),Hg(Lf.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction(){return this._window}}]);let _S=t("BufferAsset",i_("cc.BufferAsset")((Yh((hS=class extends lu{constructor(...t){super(...t),this._buffer=null}get _nativeAsset(){return this._buffer}set _nativeAsset(t){t instanceof ArrayBuffer?this._buffer=t:this._buffer=t.buffer}buffer(){return this._buffer}validate(){return!!this.buffer}}).prototype,"_nativeAsset",[M_],Object.getOwnPropertyDescriptor(hS.prototype,"_nativeAsset"),hS.prototype),lS=hS))||lS);i.BufferAsset=_S;const uS={[Mo.UNORM]:"Uint",[Mo.SNORM]:"Int",[Mo.UINT]:"Uint",[Mo.INT]:"Int",[Mo.UFLOAT]:"Float",[Mo.FLOAT]:"Float",default:"Uint"};function dS(t){return`${uS[t.type]||uS.default}${t.size/t.count*8}`}function pS(t,e,n=Oo.R32F,i=0,s=t.byteLength-i,o=0,r){r||(r=new DataView(t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)));const a=ha[n];o||(o=a.size);const c=`set${dS(a)}`,l=`get${dS(a)}`,h=a.size/a.count,_=Math.floor(s/o),u=Rp.isLittleEndian;for(let n=0;n<_;++n){const s=i+o*n;for(let n=0;n<a.count;++n){const i=s+h*n,o=t[l](i,u);r[c](i,e(o,n,t),u)}}return r}class fS{constructor(t,e,n,i=null,s=null){this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._handle=0,this._attributes=e,this._vertexBuffers=t,this._indexBuffer=i,this._indirectBuffer=s,this._primitiveMode=n,this._iaInfo=new kr(e,t,i,s),this._handle=ks.alloc();const o=Ni.alloc();ks.set(this._handle,js.FLAT_BUFFER_ARRAY,o)}get attributes(){return this._attributes}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get indirectBuffer(){return this._indirectBuffer}get primitiveMode(){return this._primitiveMode}get geometricInfo(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:$e.ZERO,max:$e.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:$e.ZERO,max:$e.ZERO}};const{mesh:t}=this,e=this.subMeshIdx,n=t.readAttribute(e,ur.ATTR_POSITION),i=t.readIndices(e),s=new $e,o=new $e,r=this.attributes.find((t=>t.name===ur.ATTR_POSITION));if(r){const t=ha[r.format].count;2===t?(s.set(n[0],n[1],0),o.set(n[0],n[1],0)):(s.set(n[0],n[1],n[2]),o.set(n[0],n[1],n[2]));for(let e=0;e<n.length;e+=t)2===t?(s.x=n[e]>s.x?n[e]:s.x,s.y=n[e+1]>s.y?n[e+1]:s.y,o.x=n[e]<o.x?n[e]:o.x,o.y=n[e+1]<o.y?n[e+1]:o.y):(s.x=n[e]>s.x?n[e]:s.x,s.y=n[e+1]>s.y?n[e+1]:s.y,s.z=n[e+2]>s.z?n[e+2]:s.z,o.x=n[e]<o.x?n[e]:o.x,o.y=n[e+1]<o.y?n[e+1]:o.y,o.z=n[e+2]<o.z?n[e+2]:o.z)}return this._geometricInfo={positions:n,indices:i,boundingBox:{max:s,min:o}},this._geometricInfo}get flatBuffers(){return this._flatBuffers}genFlatBuffers(){if(this._flatBuffers.length||!this.mesh||void 0===this.subMeshIdx)return;const{mesh:t}=this;let e=0;const n=t.struct.primitives[this.subMeshIdx],i=ks.get(this._handle,js.FLAT_BUFFER_ARRAY);n.indexView&&(e=n.indexView.count);for(let s=0;s<n.vertexBundelIndices.length;s++){const o=n.vertexBundelIndices[s],r=t.struct.vertexBundles[o],a=n.indexView?n.indexView.count:r.view.count,c=r.view.stride,l=c*a,h=new Uint8Array(t.data.buffer,r.view.offset,r.view.length),_=zi.alloc(n.indexView?l:r.view.length),u=Vs.alloc();Vs.set(u,Hs.STRIDE,c),Vs.set(u,Hs.AMOUNT,a),Vs.set(u,Hs.BUFFER,_),Ni.push(i,u);const d=zi.getBuffer(_),p=new Uint8Array(d);if(!n.indexView){p.set(t.data.subarray(r.view.offset,r.view.offset+r.view.length)),this._flatBuffers.push({stride:c,count:a,buffer:p});continue}const f=t.readIndices(this.subMeshIdx);for(let t=0;t<e;++t){const e=t*c,n=f[t]*c;for(let t=0;t<c;++t)p[e+t]=h[n+t]}this._flatBuffers.push({stride:c,count:a,buffer:p})}}get jointMappedBuffers(){if(this._jointMappedBuffers)return this._jointMappedBuffers;const t=this._jointMappedBuffers=[],e=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;const{struct:n}=this.mesh,s=n.primitives[this.subMeshIdx];if(!n.jointMaps||void 0===s.jointMapIndex||!n.jointMaps[s.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;let o,r;const{device:a}=i.director.root;for(let i=0;i<s.vertexBundelIndices.length;i++){const c=n.vertexBundles[s.vertexBundelIndices[i]];r=0,o=Oo.UNKNOWN;for(let t=0;t<c.attributes.length;t++){const e=c.attributes[t];if(e.name===ur.ATTR_JOINTS){o=e.format;break}r+=ha[e.format].size}if(o){const l=new Uint8Array(this.mesh.data.buffer,c.view.offset,c.view.length),h=new DataView(l.slice().buffer),_=n.jointMaps[s.jointMapIndex];pS(h,(t=>_.indexOf(t)),o,r,c.view.length,c.view.stride,h);const u=a.createBuffer(new br(Lo.VERTEX|Lo.TRANSFER_DST,zo.DEVICE,c.view.length,c.view.stride));u.update(h.buffer),t.push(u),e.push(i)}else t.push(this.vertexBuffers[s.vertexBundelIndices[i]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(a)),t}get iaInfo(){return this._iaInfo}get handle(){return this._handle}destroy(){for(let t=0;t<this.vertexBuffers.length;t++)this.vertexBuffers[t].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(let t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null),this._handle&&(Ai(ks.get(this._handle,js.FLAT_BUFFER_ARRAY),Ni,Vs),ks.free(this._handle),this._handle=0)}enableVertexIdChannel(t){if(this._vertexIdChannel)return;const e=this.vertexBuffers.length,n=this.attributes.length,i=this._allocVertexIdBuffer(t);this._vertexBuffers.push(i),this._attributes.push(new qa("a_vertexId",Oo.R32F,!1,e)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:e,index:n}}_allocVertexIdBuffer(t){const e=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,n=new Float32Array(e);for(let t=0;t<e;++t)n[t]=t+.5;const i=t.createBuffer(new br(Lo.VERTEX|Lo.TRANSFER_DST,zo.DEVICE,n.byteLength,n.BYTES_PER_ELEMENT));return i.update(n),i}}t("RenderingSubMesh",fS);const mS=new Array(16);let gS=null,vS=new qe;const yS=[Mp.TOUCH_START.toString(),Mp.TOUCH_MOVE.toString(),Mp.TOUCH_END.toString(),Mp.TOUCH_CANCEL.toString()],xS=[Mp.MOUSE_DOWN.toString(),Mp.MOUSE_ENTER.toString(),Mp.MOUSE_MOVE.toString(),Mp.MOUSE_LEAVE.toString(),Mp.MOUSE_UP.toString(),Mp.MOUSE_WHEEL.toString()];function SS(t,e){const n=this.owner;return!(!n||!n._uiProps.uiTransformComp||(t.getUILocation(vS),!n._uiProps.uiTransformComp.isHit(vS,this)||(e.type=Mp.TOUCH_START.toString(),e.touch=t,e.bubbles=!0,n.dispatchEvent(e),0)))}function TS(t,e){const n=this.owner;return!(!n||!n._uiProps.uiTransformComp||(e.type=Mp.TOUCH_MOVE.toString(),e.touch=t,e.bubbles=!0,n.dispatchEvent(e),0))}function ES(t,e){const n=this.owner;n&&n._uiProps.uiTransformComp&&(t.getUILocation(vS),n._uiProps.uiTransformComp.isHit(vS,this)?e.type=Mp.TOUCH_END.toString():e.type=Mp.TOUCH_CANCEL.toString(),e.touch=t,e.bubbles=!0,n.dispatchEvent(e))}function AS(t,e){const n=this.owner;n&&n._uiProps.uiTransformComp&&(e.type=Mp.TOUCH_CANCEL.toString(),e.touch=t,e.bubbles=!0,n.dispatchEvent(e))}function CS(t){const e=this.owner;e&&e._uiProps.uiTransformComp&&(vS=t.getUILocation(),e._uiProps.uiTransformComp.isHit(vS,this)&&(t.type=Mp.MOUSE_DOWN.toString(),t.bubbles=!0,e.dispatchEvent(t)))}function bS(t){const e=this.owner;if(e&&e._uiProps.uiTransformComp){if(vS=t.getUILocation(),e._uiProps.uiTransformComp.isHit(vS,this))this._previousIn||(gS&&gS.eventProcessor.mouseListener&&(t.type=Mp.MOUSE_LEAVE,gS.dispatchEvent(t),gS.eventProcessor.mouseListener&&(gS.eventProcessor.mouseListener._previousIn=!1)),gS=e,t.type=Mp.MOUSE_ENTER.toString(),e.dispatchEvent(t),this._previousIn=!0),t.type=Mp.MOUSE_MOVE.toString(),t.bubbles=!0,e.dispatchEvent(t);else{if(!this._previousIn)return;t.type=Mp.MOUSE_LEAVE.toString(),e.dispatchEvent(t),this._previousIn=!1,gS=null}t.propagationStopped=!0}}function PS(t){const e=this.owner;e&&e._uiProps.uiTransformComp&&(vS=t.getUILocation(),e._uiProps.uiTransformComp.isHit(vS,this)&&(t.type=Mp.MOUSE_UP.toString(),t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0))}function wS(t){const e=this.owner;e&&e._uiProps.uiTransformComp&&(vS=t.getUILocation(),e._uiProps.uiTransformComp.isHit(vS,this)&&(t.type=Mp.MOUSE_WHEEL.toString(),t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0))}function DS(t,e){if(e){let n=0,i=[];for(let s=t;s&&ey.isNode(s);s=s.parent,++n){const t=s.getComponent(e);if(t){const e={index:n,comp:t};i?i.push(e):i=[e]}}return i.length>0?i:null}return null}function IS(t,e){if(!t._persistNode){if(t.eventProcessor.bubblingTargets)for(let n=0;n<e.length;++n)if(t.eventProcessor.bubblingTargets.hasEventListener(e[n]))return!0;if(t.eventProcessor.capturingTargets)for(let n=0;n<e.length;++n)if(t.eventProcessor.capturingTargets.hasEventListener(e[n]))return!0;return!1}return!0}class RS{get node(){return this._node}constructor(t){this.bubblingTargets=null,this.capturingTargets=null,this.touchListener=null,this.mouseListener=null,this._node=void 0,this._node=t}reattach(){let t;this.node.walk((e=>{t||(t=DS(e,RS._comp)),e.eventProcessor.touchListener&&(e.eventProcessor.touchListener.mask=t),e.eventProcessor.mouseListener&&(e.eventProcessor.mouseListener.mask=t)}))}destroy(){gS===this._node&&(gS=null),(this.touchListener||this.mouseListener)&&(Kp.removeListeners(this._node),this.touchListener&&(this.touchListener.owner=null,this.touchListener.mask=null,this.touchListener=null),this.mouseListener&&(this.mouseListener.owner=null,this.mouseListener.mask=null,this.mouseListener=null)),this.capturingTargets&&this.capturingTargets.clear(),this.bubblingTargets&&this.bubblingTargets.clear()}on(t,e,n,i){return this._checknSetupSysEvent(t)?this._onDispatch(t,e,n,i):(this.bubblingTargets||(this.bubblingTargets=new Hn),this.bubblingTargets.on(t,e,n))}once(t,e,n,i){let s;s=this._checknSetupSysEvent(t)&&i?this.capturingTargets=this.capturingTargets||new Hn:this.bubblingTargets=this.bubblingTargets||new Hn,s.on(t,e,n,!0),s.on(t,(()=>{this.off(t,e,n)}),void 0,!0)}off(t,e,n,i){const s=-1!==yS.indexOf(t),o=!s&&-1!==xS.indexOf(t);s||o?(this._offDispatch(t,e,n,i),s?this.touchListener&&!IS(this._node,yS)&&(Kp.removeListener(this.touchListener),this.touchListener=null):o&&this.mouseListener&&!IS(this._node,xS)&&(Kp.removeListener(this.mouseListener),this.mouseListener=null)):this.bubblingTargets&&this.bubblingTargets.off(t,e,n)}emit(t,e,n,i,s,o){this.bubblingTargets&&this.bubblingTargets.emit(t,e,n,i,s,o)}dispatchEvent(t){!function(t,e){let n,i=0;for(e.target=t,mS.length=0,t.eventProcessor.getCapturingTargets(e.type,mS),e.eventPhase=1,i=mS.length-1;i>=0;--i)if(n=mS[i],n.eventProcessor.capturingTargets&&(e.currentTarget=n,n.eventProcessor.capturingTargets.emit(e.type,e,mS),e.propagationStopped))return void(mS.length=0);if(mS.length=0,e.eventPhase=2,e.currentTarget=t,t.eventProcessor.capturingTargets&&t.eventProcessor.capturingTargets.emit(e.type,e),!e.propagationImmediateStopped&&t.eventProcessor.bubblingTargets&&t.eventProcessor.bubblingTargets.emit(e.type,e),!e.propagationStopped&&e.bubbles)for(t.eventProcessor.getBubblingTargets(e.type,mS),e.eventPhase=3,i=0;i<mS.length;++i)if(n=mS[i],n.eventProcessor.bubblingTargets&&(e.currentTarget=n,n.eventProcessor.bubblingTargets.emit(e.type,e),e.propagationStopped))return void(mS.length=0);mS.length=0}(this._node,t),mS.length=0}hasEventListener(t,e,n){let i=!1;return this.bubblingTargets&&(i=this.bubblingTargets.hasEventListener(t,e,n)),!i&&this.capturingTargets&&(i=this.capturingTargets.hasEventListener(t,e,n)),i}targetOff(t){this.capturingTargets&&this.capturingTargets.removeAll(t),this.bubblingTargets&&this.bubblingTargets.removeAll(t),this.touchListener&&!IS(this.node,yS)&&(Kp.removeListener(this.touchListener),this.touchListener=null),this.mouseListener&&!IS(this.node,xS)&&(Kp.removeListener(this.mouseListener),this.mouseListener=null)}getCapturingTargets(t,e){let n=this._node.parent;for(;n;)n.eventProcessor.capturingTargets&&n.eventProcessor.capturingTargets.hasEventListener(t)&&e.push(n),n=n.parent}getBubblingTargets(t,e){let n=this._node.parent;for(;n;)n.eventProcessor.bubblingTargets&&n.eventProcessor.bubblingTargets.hasEventListener(t)&&e.push(n),n=n.parent}_checknSetupSysEvent(t){let e=!1,n=!1;return-1!==yS.indexOf(t)?(this.touchListener||(this.touchListener=i.EventListener.create({event:i.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!0,owner:this._node,mask:DS(this._node,RS._comp),onTouchBegan:SS,onTouchMoved:TS,onTouchEnded:ES,onTouchCancelled:AS}),Kp.addListener(this.touchListener,this._node),e=!0),n=!0):-1!==xS.indexOf(t)&&(this.mouseListener||(this.mouseListener=i.EventListener.create({event:i.EventListener.MOUSE,_previousIn:!1,owner:this._node,mask:DS(this._node,RS._comp),onMouseDown:CS,onMouseMove:bS,onMouseUp:PS,onMouseScroll:wS}),Kp.addListener(this.mouseListener,this._node),e=!0),n=!0),e&&!this._node.activeInHierarchy&&i.director.getScheduler().schedule((()=>{this._node.activeInHierarchy||Kp.pauseTarget(this._node)}),this._node,0,0,0,!1),n}_onDispatch(t,e,n,i){if("boolean"==typeof n?(i=n,n=void 0):i=!!i,!e)return void C(6800);let s=null;return s=i?this.capturingTargets=this.capturingTargets||new Hn:this.bubblingTargets=this.bubblingTargets||new Hn,s.hasEventListener(t,e,n)||s.on(t,e,n),e}_offDispatch(t,e,n,i){if("boolean"==typeof n?(i=n,n=void 0):i=!!i,e){const s=i?this.capturingTargets:this.bubblingTargets;s&&s.off(t,e,n)}else this.capturingTargets&&this.capturingTargets.removeAll(t),this.bubblingTargets&&this.bubblingTargets.removeAll(t)}}var OS,MS,NS,LS,BS,FS,zS,US,HS,GS,VS,jS,WS,kS,qS,XS,YS,KS,$S,ZS,JS,QS,tT,eT,nT,iT,sT,oT,rT,aT,cT,lT,hT,_T,uT,dT,pT,fT,mT,gT,vT,yT,xT,ST,TT,ET,AT,CT,bT,PT,wT,DT,IT,RT,OT,MT,NT,LT,BT,FT,zT,UT,HT,GT,VT,jT,WT,kT,qT,XT,YT,KT,$T,ZT,JT,QT,tE,eE,nE,iE,sE,oE,rE,aE,cE,lE,hE,_E,uE,dE,pE,fE,mE,gE,vE,yE,xE,SE,TE,EE,AE,CE,bE,PE,wE,DE,IE,RE,OE,ME,NE,LE,BE,FE,zE;RS._comp=null,i.NodeEventProcessor=RS;const UE=new $e(0,1,0),HE=new $e,GE=new rn;let VE=(OS=i_("cc.AmbientInfo"),MS=O_(ne),OS((BS=Yh((LS=class{constructor(){Xh(this,"_skyColor",BS,this),Xh(this,"_skyIllum",FS,this),Xh(this,"_groundAlbedo",zS,this),this._resource=null}set skyColor(t){this._skyColor.set(t),this._resource&&(this._resource.skyColor=this._skyColor)}get skyColor(){return this._skyColor}set skyIllum(t){this._skyIllum=t,this._resource&&(this._resource.skyIllum=this.skyIllum)}get skyIllum(){return this._skyIllum}set groundAlbedo(t){this._groundAlbedo.set(t),this._resource&&(this._resource.groundAlbedo=this._groundAlbedo)}get groundAlbedo(){return this._groundAlbedo}activate(t){this._resource=t,this._resource.initialize(this)}}).prototype,"_skyColor",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new An(51,128,204,1)}}),FS=Yh(LS.prototype,"_skyIllum",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return io.SKY_ILLUM}}),zS=Yh(LS.prototype,"_groundAlbedo",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new An(51,51,51,255)}}),Yh(LS.prototype,"skyColor",[m_],Object.getOwnPropertyDescriptor(LS.prototype,"skyColor"),LS.prototype),Yh(LS.prototype,"skyIllum",[m_,MS],Object.getOwnPropertyDescriptor(LS.prototype,"skyIllum"),LS.prototype),Yh(LS.prototype,"groundAlbedo",[m_],Object.getOwnPropertyDescriptor(LS.prototype,"groundAlbedo"),LS.prototype),NS=LS))||NS);i.AmbientInfo=VE;let jE=(US=i_("cc.SkyboxInfo"),HS=O_(Yd),GS=O_(Yd),US((WS=Yh((jS=class{constructor(){Xh(this,"_envmap",WS,this),Xh(this,"_isRGBE",kS,this),Xh(this,"_enabled",qS,this),Xh(this,"_useIBL",XS,this),this._resource=null}set enabled(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=this._enabled))}get enabled(){return this._enabled}set useIBL(t){this._useIBL=t,this._resource&&(this._resource.useIBL=this._useIBL)}get useIBL(){return this._useIBL}set envmap(t){this._envmap=t,this._resource&&(this._resource.envmap=this._envmap)}get envmap(){return this._envmap}set isRGBE(t){this._isRGBE=t,this._resource&&(this._resource.isRGBE=this._isRGBE)}get isRGBE(){return this._isRGBE}activate(t){this._resource=t,this._resource.initialize(this),this._resource.activate()}}).prototype,"_envmap",[HS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kS=Yh(jS.prototype,"_isRGBE",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),qS=Yh(jS.prototype,"_enabled",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),XS=Yh(jS.prototype,"_useIBL",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Yh(jS.prototype,"enabled",[m_],Object.getOwnPropertyDescriptor(jS.prototype,"enabled"),jS.prototype),Yh(jS.prototype,"useIBL",[m_],Object.getOwnPropertyDescriptor(jS.prototype,"useIBL"),jS.prototype),Yh(jS.prototype,"envmap",[m_,GS],Object.getOwnPropertyDescriptor(jS.prototype,"envmap"),jS.prototype),Yh(jS.prototype,"isRGBE",[m_],Object.getOwnPropertyDescriptor(jS.prototype,"isRGBE"),jS.prototype),VS=jS))||VS);i.SkyboxInfo=jE;let WE=(YS=i_("cc.FogInfo"),KS=O_(lf),$S=g_(),ZS=O_(ne),JS=x_(),QS=E_(),tT=C_(),eT=g_(),nT=O_(ne),iT=E_(),sT=C_(),oT=g_(),rT=O_(ne),aT=E_(),cT=C_(),lT=g_(),hT=O_(ne),_T=S_(),uT=E_(),dT=C_(),pT=g_(),fT=O_(ne),mT=E_(),gT=C_(),vT=g_(),yT=O_(ne),xT=E_(),ST=C_(),YS((NT=MT=class{constructor(){Xh(this,"_type",AT,this),Xh(this,"_fogColor",CT,this),Xh(this,"_enabled",bT,this),Xh(this,"_fogDensity",PT,this),Xh(this,"_fogStart",wT,this),Xh(this,"_fogEnd",DT,this),Xh(this,"_fogAtten",IT,this),Xh(this,"_fogTop",RT,this),Xh(this,"_fogRange",OT,this),this._resource=null}set enabled(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}get enabled(){return this._enabled}set fogColor(t){this._fogColor.set(t),this._resource&&(this._resource.fogColor=this._fogColor)}get fogColor(){return this._fogColor}get type(){return this._type}set type(t){this._type=t,this._resource&&(this._resource.type=t)}get fogDensity(){return this._fogDensity}set fogDensity(t){this._fogDensity=t,this._resource&&(this._resource.fogDensity=t)}get fogStart(){return this._fogStart}set fogStart(t){this._fogStart=t,this._resource&&(this._resource.fogStart=t)}get fogEnd(){return this._fogEnd}set fogEnd(t){this._fogEnd=t,this._resource&&(this._resource.fogEnd=t)}get fogAtten(){return this._fogAtten}set fogAtten(t){this._fogAtten=t,this._resource&&(this._resource.fogAtten=t)}get fogTop(){return this._fogTop}set fogTop(t){this._fogTop=t,this._resource&&(this._resource.fogTop=t)}get fogRange(){return this._fogRange}set fogRange(t){this._fogRange=t,this._resource&&(this._resource.fogRange=t)}activate(t){this._resource=t,this._resource.initialize(this),this._resource.activate()}},MT.FogType=lf,AT=Yh((ET=NT).prototype,"_type",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lf.LINEAR}}),CT=Yh(ET.prototype,"_fogColor",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new An("#C8C8C8")}}),bT=Yh(ET.prototype,"_enabled",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),PT=Yh(ET.prototype,"_fogDensity",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),wT=Yh(ET.prototype,"_fogStart",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),DT=Yh(ET.prototype,"_fogEnd",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),IT=Yh(ET.prototype,"_fogAtten",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),RT=Yh(ET.prototype,"_fogTop",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),OT=Yh(ET.prototype,"_fogRange",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),Yh(ET.prototype,"enabled",[m_],Object.getOwnPropertyDescriptor(ET.prototype,"enabled"),ET.prototype),Yh(ET.prototype,"fogColor",[m_],Object.getOwnPropertyDescriptor(ET.prototype,"fogColor"),ET.prototype),Yh(ET.prototype,"type",[m_,KS],Object.getOwnPropertyDescriptor(ET.prototype,"type"),ET.prototype),Yh(ET.prototype,"fogDensity",[$S,ZS,JS,QS,A_,tT],Object.getOwnPropertyDescriptor(ET.prototype,"fogDensity"),ET.prototype),Yh(ET.prototype,"fogStart",[eT,nT,iT,sT],Object.getOwnPropertyDescriptor(ET.prototype,"fogStart"),ET.prototype),Yh(ET.prototype,"fogEnd",[oT,rT,aT,cT],Object.getOwnPropertyDescriptor(ET.prototype,"fogEnd"),ET.prototype),Yh(ET.prototype,"fogAtten",[lT,hT,_T,uT,dT],Object.getOwnPropertyDescriptor(ET.prototype,"fogAtten"),ET.prototype),Yh(ET.prototype,"fogTop",[pT,fT,mT,gT],Object.getOwnPropertyDescriptor(ET.prototype,"fogTop"),ET.prototype),Yh(ET.prototype,"fogRange",[vT,yT,xT,ST],Object.getOwnPropertyDescriptor(ET.prototype,"fogRange"),ET.prototype),TT=ET))||TT),kE=(LT=i_("cc.ShadowsInfo"),BT=O_(Zf),FT=g_(),zT=O_(ne),UT=g_(),HT=O_(Jf),GT=g_(),VT=O_(ee),jT=g_(),WT=O_(ne),kT=g_(),qT=O_(ie),XT=g_(),YT=O_(ie),KT=g_(),$T=O_(ie),ZT=g_(),JT=O_(ne),QT=g_(),tE=O_(ie),eE=g_(),nE=O_(ne),iE=g_(),sE=O_(ne),oE=g_(),rE=O_(ne),aE=g_(),cE=g_(),lE=O_(ne),hE=g_(),LT((dE=Yh((uE=class{constructor(){Xh(this,"_type",dE,this),Xh(this,"_enabled",pE,this),Xh(this,"_normal",fE,this),Xh(this,"_distance",mE,this),Xh(this,"_shadowColor",gE,this),Xh(this,"_autoAdapt",vE,this),Xh(this,"_pcf",yE,this),Xh(this,"_bias",xE,this),Xh(this,"_packing",SE,this),Xh(this,"_linear",TE,this),Xh(this,"_selfShadow",EE,this),Xh(this,"_normalBias",AE,this),Xh(this,"_near",CE,this),Xh(this,"_far",bE,this),Xh(this,"_aspect",PE,this),Xh(this,"_orthoSize",wE,this),Xh(this,"_maxReceived",DE,this),Xh(this,"_size",IE,this),this._resource=null}set enabled(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}get enabled(){return this._enabled}set type(t){this._type=t,this._resource&&(this._resource.type=t)}get type(){return this._type}set shadowColor(t){this._shadowColor.set(t),this._resource&&(this._resource.shadowColor=t)}get shadowColor(){return this._shadowColor}set normal(t){$e.copy(this._normal,t),this._resource&&(this._resource.normal=t)}get normal(){return this._normal}set distance(t){this._distance=t,this._resource&&(this._resource.distance=t)}get distance(){return this._distance}set pcf(t){this._pcf=t,this._resource&&(this._resource.pcf=t)}get pcf(){return this._pcf}set maxReceived(t){this._maxReceived=t,this._resource&&(this._resource.maxReceived=t)}get maxReceived(){return this._maxReceived}set bias(t){this._bias=t,this._resource&&(this._resource.bias=t)}get bias(){return this._bias}set packing(t){this._packing=t,t&&(this._linear=!this._linear&&this._linear,this._resource&&(this._resource.linear=this._linear)),this._resource&&(this._resource.packing=t,this._resource.shadowMapDirty=!0)}get packing(){return this._packing}set linear(t){this._linear=t,t&&(this._packing=!this._packing&&this._packing,this._resource&&(this._resource.packing=this._packing)),this._resource&&(this._resource.linear=t)}get linear(){return this._linear}set selfShadow(t){this._selfShadow=t,this._resource&&(this._resource.selfShadow=t)}get selfShadow(){return this._selfShadow}set normalBias(t){this._normalBias=t,this._resource&&(this._resource.normalBias=t)}get normalBias(){return this._normalBias}set autoAdapt(t){this._autoAdapt=t,this._resource&&(this._resource.autoAdapt=t)}get autoAdapt(){return this._autoAdapt}set near(t){this._near=t,this._resource&&(this._resource.near=t)}get near(){return this._near}set far(t){this._far=t,this._resource&&(this._resource.far=t)}get far(){return this._far}set orthoSize(t){this._orthoSize=t,this._resource&&(this._resource.orthoSize=t)}get orthoSize(){return this._orthoSize}set shadowMapSize(t){this._size.set(t),this._resource&&(this._resource.size=t,this._resource.shadowMapDirty=!0)}get shadowMapSize(){return this._size}set aspect(t){this._aspect=t,this._resource&&(this._resource.aspect=t)}get aspect(){return this._aspect}setPlaneFromNode(t){t.getWorldRotation(GE),this.normal=$e.transformQuat(HE,UE,GE),t.getWorldPosition(HE),this.distance=$e.dot(this._normal,HE)}activate(t){this._resource=t,this._resource.initialize(this),this._resource.activate()}}).prototype,"_type",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Zf.Planar}}),pE=Yh(uE.prototype,"_enabled",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),fE=Yh(uE.prototype,"_normal",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $e(0,1,0)}}),mE=Yh(uE.prototype,"_distance",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gE=Yh(uE.prototype,"_shadowColor",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new An(0,0,0,76)}}),vE=Yh(uE.prototype,"_autoAdapt",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),yE=Yh(uE.prototype,"_pcf",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Jf.HARD}}),xE=Yh(uE.prototype,"_bias",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),SE=Yh(uE.prototype,"_packing",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),TE=Yh(uE.prototype,"_linear",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),EE=Yh(uE.prototype,"_selfShadow",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),AE=Yh(uE.prototype,"_normalBias",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),CE=Yh(uE.prototype,"_near",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),bE=Yh(uE.prototype,"_far",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),PE=Yh(uE.prototype,"_aspect",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),wE=Yh(uE.prototype,"_orthoSize",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),DE=Yh(uE.prototype,"_maxReceived",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),IE=Yh(uE.prototype,"_size",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qe(512,512)}}),Yh(uE.prototype,"enabled",[m_],Object.getOwnPropertyDescriptor(uE.prototype,"enabled"),uE.prototype),Yh(uE.prototype,"type",[m_,BT],Object.getOwnPropertyDescriptor(uE.prototype,"type"),uE.prototype),Yh(uE.prototype,"shadowColor",[m_],Object.getOwnPropertyDescriptor(uE.prototype,"shadowColor"),uE.prototype),Yh(uE.prototype,"normal",[FT],Object.getOwnPropertyDescriptor(uE.prototype,"normal"),uE.prototype),Yh(uE.prototype,"distance",[zT,UT],Object.getOwnPropertyDescriptor(uE.prototype,"distance"),uE.prototype),Yh(uE.prototype,"pcf",[HT,GT],Object.getOwnPropertyDescriptor(uE.prototype,"pcf"),uE.prototype),Yh(uE.prototype,"maxReceived",[VT,jT],Object.getOwnPropertyDescriptor(uE.prototype,"maxReceived"),uE.prototype),Yh(uE.prototype,"bias",[WT,kT],Object.getOwnPropertyDescriptor(uE.prototype,"bias"),uE.prototype),Yh(uE.prototype,"packing",[qT,XT],Object.getOwnPropertyDescriptor(uE.prototype,"packing"),uE.prototype),Yh(uE.prototype,"linear",[YT,KT],Object.getOwnPropertyDescriptor(uE.prototype,"linear"),uE.prototype),Yh(uE.prototype,"selfShadow",[$T,ZT],Object.getOwnPropertyDescriptor(uE.prototype,"selfShadow"),uE.prototype),Yh(uE.prototype,"normalBias",[JT,QT],Object.getOwnPropertyDescriptor(uE.prototype,"normalBias"),uE.prototype),Yh(uE.prototype,"autoAdapt",[tE,eE],Object.getOwnPropertyDescriptor(uE.prototype,"autoAdapt"),uE.prototype),Yh(uE.prototype,"near",[nE,iE],Object.getOwnPropertyDescriptor(uE.prototype,"near"),uE.prototype),Yh(uE.prototype,"far",[sE,oE],Object.getOwnPropertyDescriptor(uE.prototype,"far"),uE.prototype),Yh(uE.prototype,"orthoSize",[rE,aE],Object.getOwnPropertyDescriptor(uE.prototype,"orthoSize"),uE.prototype),Yh(uE.prototype,"shadowMapSize",[cE],Object.getOwnPropertyDescriptor(uE.prototype,"shadowMapSize"),uE.prototype),Yh(uE.prototype,"aspect",[lE,hE],Object.getOwnPropertyDescriptor(uE.prototype,"aspect"),uE.prototype),_E=uE))||_E);i.ShadowsInfo=kE;let qE=(RE=i_("cc.SceneGlobals"),OE=O_(jE),RE((LE=Yh((NE=class{constructor(){Xh(this,"ambient",LE,this),Xh(this,"shadows",BE,this),Xh(this,"_skybox",FE,this),Xh(this,"fog",zE,this)}get skybox(){return this._skybox}set skybox(t){this._skybox=t}activate(){const t=i.director.root.pipeline.pipelineSceneData;this.ambient.activate(t.ambient),this.skybox.activate(t.skybox),this.shadows.activate(t.shadows),this.fog.activate(t.fog)}}).prototype,"ambient",[c_,m_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new VE}}),BE=Yh(NE.prototype,"shadows",[c_,m_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kE}}),FE=Yh(NE.prototype,"_skybox",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jE}}),zE=Yh(NE.prototype,"fog",[m_,c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new WE}}),Yh(NE.prototype,"skybox",[m_,OE],Object.getOwnPropertyDescriptor(NE.prototype,"skybox"),NE.prototype),ME=NE))||ME);var XE,YE,KE,$E;i.SceneGlobals=qE;let ZE=t("Scene",i_("cc.Scene")((Yh((YE=class extends bv{get renderScene(){return this._renderScene}get globals(){return this._globals}_updateScene(){this._scene=this}constructor(t){super(t),Xh(this,"autoReleaseAssets",KE,this),Xh(this,"_globals",$E,this),this._renderScene=null,this.dependAssets=null,this._inited=void 0,this._prefabSyncedInLiveReload=!1,this._pos=$e.ZERO,this._rot=rn.IDENTITY,this._scale=$e.ONE,this._mat=pn.IDENTITY,this._dirtyFlags=0,this._activeInHierarchy=!1,i.director&&i.director.root&&(this._renderScene=i.director.root.createScene({})),this._inited=!i.game||!i.game._isCloning}destroy(){const t=Rn.prototype.destroy.call(this);if(t){const t=this._children;for(let e=0;e<t.length;++e)t[e].active=!1}return i.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,t}addComponent(){throw new Error(D(3822))}_onHierarchyChanged(){}_onBatchCreated(t){super._onBatchCreated(t);const e=this._children.length;for(let n=0;n<e;++n)this.children[n]._siblingIndex=n,this._children[n]._onBatchCreated(t);Nv(this)}getPosition(t){return $e.copy(t||new $e,$e.ZERO)}getRotation(t){return rn.copy(t||new rn,rn.IDENTITY)}getScale(t){return $e.copy(t||new $e,$e.ONE)}getWorldPosition(t){return $e.copy(t||new $e,$e.ZERO)}getWorldRotation(t){return rn.copy(t||new rn,rn.IDENTITY)}getWorldScale(t){return $e.copy(t||new $e,$e.ONE)}getWorldMatrix(t){return pn.copy(t||new pn,pn.IDENTITY)}getWorldRS(t){return pn.copy(t||new pn,pn.IDENTITY)}getWorldRT(t){return pn.copy(t||new pn,pn.IDENTITY)}get position(){return $e.ZERO}get worldPosition(){return $e.ZERO}get rotation(){return rn.IDENTITY}get worldRotation(){return rn.IDENTITY}get scale(){return $e.ONE}get worldScale(){return $e.ONE}get eulerAngles(){return $e.ZERO}get worldMatrix(){return pn.IDENTITY}updateWorldTransform(){}_instantiate(){}_load(){this._inited||(this._onBatchCreated(false),this._inited=!0),this.walk(bv._setScene)}_activate(t){t=!1!==t,i.director._nodeActivator.activateNode(this,t),this._globals.activate()}}).prototype,"globals",[m_],Object.getOwnPropertyDescriptor(YE.prototype,"globals"),YE.prototype),KE=Yh(YE.prototype,"autoReleaseAssets",[c_,m_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$E=Yh(YE.prototype,"_globals",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qE}}),XE=YE))||XE);function JE(t,e){if(!e){const t=i.director.getScene();if(!t)return null;e=t}return e.getChildByPath(t)}i.Scene=ZE,i.find=JE;const QE=Pt.fastRemoveAt,tA=Rn.Flags.IsStartCalled,eA=Rn.Flags.IsOnEnableCalled;function nA(t,e){const n=e.constructor._executionOrder,i=e._id;let s=0;for(let e=t.length-1,o=e>>>1;s<=e;o=s+e>>>1){const r=t[o],a=r.constructor._executionOrder;if(a>n)e=o-1;else if(a<n)s=o+1;else{const t=r._id;if(t>i)e=o-1;else{if(!(t<i))return o;s=o+1}}}return~s}function iA(t,e){const n=t.array;let i=t.i+1;for(;i<n.length;){const s=n[i];s.node._activeInHierarchy?++i:(t.removeAt(i),e&&(s._objFlags&=~e))}}Rn.Flags.IsEditorOnEnableCalled;class sA{constructor(t){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;const e=B;this._zero=new e([]),this._neg=new e([]),this._pos=new e([]),this._invoke=t}}function oA(t,e){return t.constructor._executionOrder-e.constructor._executionOrder}sA.stableRemoveInactive=iA;class rA extends sA{add(t){const e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).array.push(t)}remove(t){const e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).fastRemove(t)}cancelInactive(t){iA(this._zero,t),iA(this._neg,t),iA(this._pos,t)}invoke(){const t=this._neg;t.array.length>0&&(t.array.sort(oA),this._invoke(t),t.array.length=0),this._invoke(this._zero),this._zero.array.length=0;const e=this._pos;e.array.length>0&&(e.array.sort(oA),this._invoke(e),e.array.length=0)}}class aA extends sA{add(t){const e=t.constructor._executionOrder;if(0===e)this._zero.array.push(t);else{const n=e<0?this._neg.array:this._pos.array,i=nA(n,t);i<0&&n.splice(~i,0,t)}}remove(t){const e=t.constructor._executionOrder;if(0===e)this._zero.fastRemove(t);else{const n=e<0?this._neg:this._pos,i=nA(n.array,t);i>=0&&n.removeAt(i)}}invoke(t){this._neg.array.length>0&&this._invoke(this._neg,t),this._invoke(this._zero,t),this._pos.array.length>0&&this._invoke(this._pos,t)}}function cA(t,e,n){const s=`var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];${t}}`,o=e?Function("it","dt",s):Function("it",s);return function(t,e,n){return(s,o)=>{try{e(s,o)}catch(e){i._throw(e);const r=s.array;for(n&&(r[s.i]._objFlags|=n),++s.i;s.i<r.length;++s.i)try{t(r[s.i],o)}catch(t){i._throw(t),n&&(r[s.i]._objFlags|=n)}}}}(Function("c","dt",t),o,n)}const lA=cA(`c.start();c._objFlags|=${tA}`,!1,tA),hA=cA("c.update(dt)",!0),_A=cA("c.lateUpdate(dt)",!0),uA=t=>{const e=i.director._compScheduler,n=t.array;for(t.i=0;t.i<n.length;++t.i){const i=n[t.i];i._enabled&&(i.onEnable(),!i.node._activeInHierarchy||e._onEnabled(i))}};class dA{constructor(){this._deferredComps=[],this.unscheduleAll()}unscheduleAll(){this.startInvoker=new rA(lA),this.updateInvoker=new aA(hA),this.lateUpdateInvoker=new aA(_A),this._updating=!1}_onEnabled(t){i.director.getScheduler().resumeTarget(t),t._objFlags|=eA,this._updating?this._deferredComps.push(t):this._scheduleImmediate(t)}_onDisabled(t){i.director.getScheduler().pauseTarget(t),t._objFlags&=~eA;const e=this._deferredComps.indexOf(t);e>=0?QE(this._deferredComps,e):(!t.start||t._objFlags&tA||this.startInvoker.remove(t),t.update&&this.updateInvoker.remove(t),t.lateUpdate&&this.lateUpdateInvoker.remove(t))}enableComp(t,e){if(!(t._objFlags&eA)){if(t.onEnable){if(e)return void e.add(t);if(t.onEnable(),!t.node._activeInHierarchy)return}this._onEnabled(t)}}disableComp(t){t._objFlags&eA&&(t.onDisable&&t.onDisable(),this._onDisabled(t))}startPhase(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()}updatePhase(t){this.updateInvoker.invoke(t)}lateUpdatePhase(t){this.lateUpdateInvoker.invoke(t),this._updating=!1,this._startForNewComps()}_startForNewComps(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())}_scheduleImmediate(t){"function"!=typeof t.start||t._objFlags&tA||this.startInvoker.add(t),"function"==typeof t.update&&this.updateInvoker.add(t),"function"==typeof t.lateUpdate&&this.lateUpdateInvoker.add(t)}_deferredSchedule(){const t=this._deferredComps;for(let e=0,n=t.length;e<n;e++)this._scheduleImmediate(t[e]);t.length=0}}const pA=Rn.Flags.IsPreloadStarted,fA=Rn.Flags.IsOnLoadStarted,mA=Rn.Flags.IsOnLoadCalled,gA=Rn.Flags.Deactivating;class vA extends sA{add(t){this._zero.array.push(t)}remove(t){this._zero.fastRemove(t)}cancelInactive(t){sA.stableRemoveInactive(this._zero,t)}invoke(){this._invoke(this._zero),this._zero.array.length=0}}const yA=cA("c.__preload();"),xA=cA(`c.onLoad();c._objFlags|=${mA}`,!1,mA),SA=new bt(4);function TA(t,e,n){e?t._removeComponent(e):Pt.removeAt(t._components,n)}SA.get=function(){const t=this._get()||{preload:new vA(yA),onLoad:new rA(xA),onEnable:new rA(uA)};t.preload._zero.i=-1;let e=t.onLoad;return e._zero.i=-1,e._neg.i=-1,e._pos.i=-1,e=t.onEnable,e._zero.i=-1,e._neg.i=-1,e._pos.i=-1,t};class EA{constructor(){this.resetComp=void 0,this.reset()}reset(){this._activatingStack=[]}activateNode(t,e){if(e){const e=SA.get();this._activatingStack.push(e),this._activateNodeRecursively(t,e.preload,e.onLoad,e.onEnable),e.preload.invoke(),e.onLoad.invoke(),e.onEnable.invoke(),this._activatingStack.pop(),SA.put(e)}else{this._deactivateNodeRecursively(t);const e=this._activatingStack;for(const t of e)t.preload.cancelInactive(pA),t.onLoad.cancelInactive(fA),t.onEnable.cancelInactive()}t.emit("active-in-hierarchy-changed",t)}activateComp(t,e,n,s){if(Mn(t,!0)&&(t._objFlags&pA||(t._objFlags|=pA,t.__preload&&(e?e.add(t):t.__preload())),t._objFlags&fA||(t._objFlags|=fA,t.onLoad?n?n.add(t):(t.onLoad(),t._objFlags|=mA):t._objFlags|=mA),t._enabled)){if(!t.node._activeInHierarchy)return;i.director._compScheduler.enableComp(t,s)}}destroyComp(t){i.director._compScheduler.disableComp(t),t.onDestroy&&t._objFlags&mA&&t.onDestroy()}_activateNodeRecursively(t,e,n,s){if(t._objFlags&gA)return void C(3816,t.name);t._activeInHierarchy=!0;let o=t._components.length;for(let r=0;r<o;++r){const a=t._components[r];a instanceof i.Component?this.activateComp(a,e,n,s):(TA(t,a,r),--r,--o)}t._childArrivalOrder=t._children.length;for(let i=0,o=t._children.length;i<o;++i){const o=t._children[i];o._active&&this._activateNodeRecursively(o,e,n,s)}t._onPostActivated(!0)}_deactivateNodeRecursively(t){t._objFlags|=gA,t._activeInHierarchy=!1;const e=t._components.length;for(let n=0;n<e;++n){const e=t._components[n];if(e._enabled&&(i.director._compScheduler.disableComp(e),t._activeInHierarchy))return void(t._objFlags&=~gA)}for(let e=0,n=t._children.length;e<n;++e){const n=t._children[e];if(n._activeInHierarchy&&(this._deactivateNodeRecursively(n),t._activeInHierarchy))return void(t._objFlags&=~gA)}t._onPostActivated(!1),t._objFlags&=~gA}}var AA,CA,bA;t("NodeActivator",EA);let PA=t("SceneAsset",i_("cc.SceneAsset")((bA=Yh((CA=class extends lu{constructor(...t){super(...t),Xh(this,"scene",bA,this)}initDefault(t){super.initDefault(t),this.scene=new ZE("New Scene")}validate(){return!!this.scene}}).prototype,"scene",[m_,c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),AA=CA))||AA);var wA,DA,IA;i.SceneAsset=PA;let RA=t("TextAsset",i_("cc.TextAsset")((IA=Yh((DA=class extends lu{constructor(...t){super(...t),Xh(this,"text",IA,this)}toString(){return this.text}}).prototype,"text",[c_,m_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),wA=DA))||wA);var OA,MA,NA;i.TextAsset=RA;let LA=t("JsonAsset",i_("cc.JsonAsset")((NA=Yh((MA=class extends lu{constructor(...t){super(...t),Xh(this,"json",NA,this)}}).prototype,"json",[c_,m_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),OA=MA))||OA);i.JsonAsset=LA;class BA{constructor(){this._id="",this._priority=0,this._executeInEditMode=!1}set priority(t){this._priority=t}get priority(){return this._priority}set id(t){this._id=t}get id(){return this._id}static sortByPriority(t,e){return t._priority<e._priority?1:t._priority>e.priority?-1:0}init(){}update(t){}postUpdate(t){}}t("System",BA);const FA=new V("Scheduler");class zA{constructor(t,e,n,i){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=t,this.priority=e,this.paused=n,this.markedForDeletion=i}}zA.get=(t,e,n,i)=>{let s=zA._listEntries.pop();return s?(s.target=t,s.priority=e,s.paused=n,s.markedForDeletion=i):s=new zA(t,e,n,i),s},zA.put=t=>{zA._listEntries.length<20&&(t.target=null,zA._listEntries.push(t))},zA._listEntries=[];class UA{constructor(t,e,n,i){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=t,this.entry=e,this.target=n,this.callback=i}}UA.get=(t,e,n,i)=>{let s=UA._hashUpdateEntries.pop();return s?(s.list=t,s.entry=e,s.target=n,s.callback=i):s=new UA(t,e,n,i),s},UA.put=t=>{UA._hashUpdateEntries.length<20&&(t.list=t.entry=t.target=t.callback=null,UA._hashUpdateEntries.push(t))},UA._hashUpdateEntries=[];class HA{constructor(t,e,n,i,s,o){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=t,this.target=e,this.timerIndex=n,this.currentTimer=i,this.currentTimerSalvaged=s,this.paused=o}}HA.get=(t,e,n,i,s,o)=>{let r=HA._hashTimerEntries.pop();return r?(r.timers=t,r.target=e,r.timerIndex=n,r.currentTimer=i,r.currentTimerSalvaged=s,r.paused=o):r=new HA(t,e,n,i,s,o),r},HA.put=t=>{HA._hashTimerEntries.length<20&&(t.timers=t.target=t.currentTimer=null,HA._hashTimerEntries.push(t))},HA._hashTimerEntries=[];class GA{constructor(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}initWithCallback(t,e,n,s,o,r){return this._lock=!1,this._scheduler=t,this._target=n,this._callback=e,this._elapsed=-1,this._interval=s,this._delay=r,this._useDelay=this._delay>0,this._repeat=o,this._runForever=this._repeat===i.macro.REPEAT_FOREVER,!0}getInterval(){return this._interval}setInterval(t){this._interval=t}update(t){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=t,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))}getCallback(){return this._callback}trigger(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)}cancel(){this._scheduler.unschedule(this._callback,this._target)}}GA._timers=[],GA.get=()=>GA._timers.pop()||new GA,GA.put=t=>{GA._timers.length<20&&!t._lock&&(t._scheduler=t._target=t._callback=null,GA._timers.push(t))};class VA extends BA{static enableForTarget(t){let e=!1;(t.uuid||t.id)&&(e=!0),e||(t.__instanceId?E(1513):t.id=FA.getNewId())}constructor(){super(),this._timeScale=void 0,this._updatesNegList=void 0,this._updates0List=void 0,this._updatesPosList=void 0,this._hashForUpdates=void 0,this._hashForTimers=void 0,this._currentTarget=void 0,this._currentTargetSalvaged=void 0,this._updateHashLocked=void 0,this._arrayForTimers=void 0,this._timeScale=1,this._updatesNegList=[],this._updates0List=[],this._updatesPosList=[],this._hashForUpdates=Q(!0),this._hashForTimers=Q(!0),this._currentTarget=null,this._currentTargetSalvaged=!1,this._updateHashLocked=!1,this._arrayForTimers=[]}setTimeScale(t){this._timeScale=t}getTimeScale(){return this._timeScale}update(t){let e,n,i,s,o;for(this._updateHashLocked=!0,1!==this._timeScale&&(t*=this._timeScale),e=0,n=this._updatesNegList,i=n.length;e<i;e++)s=n[e],s.paused||s.markedForDeletion||s.target.update(t);for(e=0,n=this._updates0List,i=n.length;e<i;e++)s=n[e],s.paused||s.markedForDeletion||s.target.update(t);for(e=0,n=this._updatesPosList,i=n.length;e<i;e++)s=n[e],s.paused||s.markedForDeletion||s.target.update(t);const r=this._arrayForTimers;for(e=0;e<r.length;e++){if(o=r[e],this._currentTarget=o,this._currentTargetSalvaged=!1,!o.paused)for(o.timerIndex=0;o.timerIndex<o.timers.length;++o.timerIndex)o.currentTimer=o.timers[o.timerIndex],o.currentTimerSalvaged=!1,o.currentTimer.update(t),o.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--e)}for(e=0,n=this._updatesNegList;e<n.length;)s=n[e],s.markedForDeletion?this._removeUpdateFromHash(s):e++;for(e=0,n=this._updates0List;e<n.length;)s=n[e],s.markedForDeletion?this._removeUpdateFromHash(s):e++;for(e=0,n=this._updatesPosList;e<n.length;)s=n[e],s.markedForDeletion?this._removeUpdateFromHash(s):e++;this._updateHashLocked=!1,this._currentTarget=null}schedule(t,e,n,s,o,r){if("function"!=typeof t){const n=t;t=e,e=n}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(r=!!s,s=i.macro.REPEAT_FOREVER,o=0),P(e,1502);const a=e.uuid||e.id;if(!a)return void C(1510);let c,l,h=this._hashForTimers[a];if(h?h.paused!==r&&E(1511):(h=HA.get(null,e,0,null,null,r),this._arrayForTimers.push(h),this._hashForTimers[a]=h),null==h.timers)h.timers=[];else for(l=0;l<h.timers.length;++l)if(c=h.timers[l],c&&t===c._callback)return S(1507,c.getInterval(),n),void(c._interval=n);c=GA.get(),c.initWithCallback(this,t,e,n,s,o),h.timers.push(c),this._currentTarget===h&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}scheduleUpdate(t,e,n){const i=t.uuid||t.id;if(!i)return void C(1510);const s=this._hashForUpdates[i];if(s&&s.entry){if(s.entry.priority===e)return s.entry.markedForDeletion=!1,void(s.entry.paused=n);if(this._updateHashLocked)return S(1506),s.entry.markedForDeletion=!1,void(s.entry.paused=n);this.unscheduleUpdate(t)}const o=zA.get(t,e,n,!1);let r;0===e?(r=this._updates0List,this._appendIn(r,o)):(r=e<0?this._updatesNegList:this._updatesPosList,this._priorityIn(r,o,e)),this._hashForUpdates[i]=UA.get(r,o,t,null)}unschedule(t,e){if(!e||!t)return;const n=e.uuid||e.id;if(!n)return void C(1510);const i=this,s=i._hashForTimers[n];if(s){const e=s.timers;for(let n=0,o=e.length;n<o;n++){const o=e[n];if(t===o._callback)return o!==s.currentTimer||s.currentTimerSalvaged||(s.currentTimerSalvaged=!0),e.splice(n,1),GA.put(o),s.timerIndex>=n&&s.timerIndex--,void(0===e.length&&(i._currentTarget===s?i._currentTargetSalvaged=!0:i._removeHashElement(s)))}}}unscheduleUpdate(t){if(!t)return;const e=t.uuid||t.id;if(!e)return void C(1510);const n=this._hashForUpdates[e];n&&(this._updateHashLocked?n.entry.markedForDeletion=!0:this._removeUpdateFromHash(n.entry))}unscheduleAllForTarget(t){if(!t)return;const e=t.uuid||t.id;if(!e)return void C(1510);const n=this._hashForTimers[e];if(n){const t=n.timers;t.indexOf(n.currentTimer)>-1&&!n.currentTimerSalvaged&&(n.currentTimerSalvaged=!0);for(let e=0,n=t.length;e<n;e++)GA.put(t[e]);t.length=0,this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)}this.unscheduleUpdate(t)}unscheduleAll(){this.unscheduleAllWithMinPriority(i.Scheduler.PRIORITY_SYSTEM)}unscheduleAllWithMinPriority(t){let e,n;const i=this._arrayForTimers;for(e=i.length-1;e>=0;e--)n=i[e],this.unscheduleAllForTarget(n.target);let s,o=0;if(t<0)for(e=0;e<this._updatesNegList.length;)o=this._updatesNegList.length,s=this._updatesNegList[e],s&&s.priority>=t&&this.unscheduleUpdate(s.target),o===this._updatesNegList.length&&e++;if(t<=0)for(e=0;e<this._updates0List.length;)o=this._updates0List.length,s=this._updates0List[e],s&&this.unscheduleUpdate(s.target),o===this._updates0List.length&&e++;for(e=0;e<this._updatesPosList.length;)o=this._updatesPosList.length,s=this._updatesPosList[e],s&&s.priority>=t&&this.unscheduleUpdate(s.target),o===this._updatesPosList.length&&e++}isScheduled(t,e){P(t,1508),P(e,1509);const n=e.uuid||e.id;if(!n)return void C(1510);const i=this._hashForTimers[n];if(!i)return!1;if(null==i.timers)return!1;{const e=i.timers;for(let n=0;n<e.length;++n)if(t===e[n]._callback)return!0;return!1}}pauseAllTargets(){return this.pauseAllTargetsWithMinPriority(i.Scheduler.PRIORITY_SYSTEM)}pauseAllTargetsWithMinPriority(t){const e=[];let n;const i=this._arrayForTimers;let s,o,r;for(s=0,o=i.length;s<o;s++)n=i[s],n&&(n.paused=!0,e.push(n.target));if(t<0)for(s=0;s<this._updatesNegList.length;s++)r=this._updatesNegList[s],r&&r.priority>=t&&(r.paused=!0,e.push(r.target));if(t<=0)for(s=0;s<this._updates0List.length;s++)r=this._updates0List[s],r&&(r.paused=!0,e.push(r.target));for(s=0;s<this._updatesPosList.length;s++)r=this._updatesPosList[s],r&&r.priority>=t&&(r.paused=!0,e.push(r.target));return e}resumeTargets(t){if(t)for(let e=0;e<t.length;e++)this.resumeTarget(t[e])}pauseTarget(t){P(t,1503);const e=t.uuid||t.id;if(!e)return void C(1510);const n=this._hashForTimers[e];n&&(n.paused=!0);const i=this._hashForUpdates[e];i&&(i.entry.paused=!0)}resumeTarget(t){P(t,1504);const e=t.uuid||t.id;if(!e)return void C(1510);const n=this._hashForTimers[e];n&&(n.paused=!1);const i=this._hashForUpdates[e];i&&(i.entry.paused=!1)}isTargetPaused(t){P(t,1505);const e=t.uuid||t.id;if(!e)return C(1510),!1;const n=this._hashForTimers[e];if(n)return n.paused;const i=this._hashForUpdates[e];return!!i&&i.entry.paused}_removeHashElement(t){const e=t.target.uuid||t.target.id;delete this._hashForTimers[e];const n=this._arrayForTimers;for(let e=0,i=n.length;e<i;e++)if(n[e]===t){n.splice(e,1);break}HA.put(t)}_removeUpdateFromHash(t){const e=t.target.uuid||t.target.id,n=this,i=n._hashForUpdates[e];if(i){const t=i.list,s=i.entry;for(let e=0,n=t.length;e<n;e++)if(t[e]===s){t.splice(e,1);break}delete n._hashForUpdates[e],zA.put(s),UA.put(i)}}_priorityIn(t,e,n){for(let i=0;i<t.length;i++)if(n<t[i].priority)return void t.splice(i,0,e);t.push(e)}_appendIn(t,e){t.push(e)}}t("Scheduler",VA),VA.PRIORITY_SYSTEM=1<<31,VA.PRIORITY_NON_SYSTEM=VA.PRIORITY_SYSTEM+1,VA.ID="scheduler",i.Scheduler=VA;class jA{get width(){return this._width}get height(){return this._height}get framebuffer(){return Ii.get(fs.get(this._poolHandle,ds.FRAMEBUFFER))}get shouldSyncSizeWithSwapchain(){return this._shouldSyncSizeWithSwapchain}get hasOnScreenAttachments(){return 1===fs.get(this._poolHandle,ds.HAS_ON_SCREEN_ATTACHMENTS)}get hasOffScreenAttachments(){return 1===fs.get(this._poolHandle,ds.HAS_OFF_SCREEN_ATTACHMENTS)}get handle(){return this._poolHandle}get cameras(){return this._cameras}static registerCreateFunc(t){t._createWindowFun=t=>new jA(t)}constructor(t){this._title="",this._width=1,this._height=1,this._nativeWidth=1,this._nativeHeight=1,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._swapchainBufferIndices=0,this._shouldSyncSizeWithSwapchain=!1,this._poolHandle=0,this._cameras=[]}initialize(t,e){this._poolHandle=fs.alloc(),void 0!==e.title&&(this._title=e.title),void 0!==e.swapchainBufferIndices&&(this._swapchainBufferIndices=e.swapchainBufferIndices),void 0!==e.shouldSyncSizeWithSwapchain&&(this._shouldSyncSizeWithSwapchain=e.shouldSyncSizeWithSwapchain),this._width=e.width,this._height=e.height,this._nativeWidth=this._width,this._nativeHeight=this._height;const{colorAttachments:n,depthStencilAttachment:i}=e.renderPassInfo;for(let e=0;e<n.length;e++)n[e].format===Oo.UNKNOWN&&(n[e].format=t.colorFormat);i&&i.format===Oo.UNKNOWN&&(i.format=t.depthStencilFormat),this._renderPass=t.createRenderPass(e.renderPassInfo);for(let e=0;e<n.length;e++){let i=null;this._swapchainBufferIndices&1<<e?fs.set(this._poolHandle,ds.HAS_ON_SCREEN_ATTACHMENTS,1):(i=t.createTexture(new Rr(Uo.TEX2D,Ho.COLOR_ATTACHMENT|Ho.SAMPLED,n[e].format,this._width,this._height)),fs.set(this._poolHandle,ds.HAS_OFF_SCREEN_ATTACHMENTS,1)),this._colorTextures.push(i)}i&&(this._swapchainBufferIndices>=0?(this._depthStencilTexture=t.createTexture(new Rr(Uo.TEX2D,Ho.DEPTH_STENCIL_ATTACHMENT|Ho.SAMPLED,i.format,this._width,this._height)),fs.set(this._poolHandle,ds.HAS_OFF_SCREEN_ATTACHMENTS,1)):fs.set(this._poolHandle,ds.HAS_ON_SCREEN_ATTACHMENTS,1));const s=Ii.alloc(t,new Jr(this._renderPass,this._colorTextures,this._depthStencilTexture));return fs.set(this._poolHandle,ds.FRAMEBUFFER,s),!0}destroy(){this.clearCameras(),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(let t=0;t<this._colorTextures.length;t++){const e=this._colorTextures[t];e&&e.destroy()}this._colorTextures.length=0,this._poolHandle&&(Ii.get(fs.get(this._poolHandle,ds.FRAMEBUFFER)).destroy(),this._poolHandle=0)}resize(t,e){if(this._width=t,this._height=e,t>this._nativeWidth||e>this._nativeHeight){this._nativeWidth=t,this._nativeHeight=e;let n=!1;this._depthStencilTexture&&(this._depthStencilTexture.resize(t,e),n=!0);for(let i=0;i<this._colorTextures.length;i++){const s=this._colorTextures[i];s&&(s.resize(t,e),n=!0)}const i=Ii.get(fs.get(this._poolHandle,ds.FRAMEBUFFER));n&&i&&(i.destroy(),i.initialize(new Jr(this._renderPass,this._colorTextures,this._depthStencilTexture)))}for(const n of this._cameras)n.isWindowSize&&n.resize(t,e)}extractRenderCameras(t){for(let e=0;e<this._cameras.length;e++){const n=this._cameras[e];n.enabled&&(n.update(),t.push(n))}}attachCamera(t){for(let e=0;e<this._cameras.length;e++)if(this._cameras[e]===t)return;this._cameras.push(t),this.sortCameras()}detachCamera(t){for(let e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return void this._cameras.splice(e,1)}clearCameras(){this._cameras.length=0}sortCameras(){this._cameras.sort(((t,e)=>t.priority-e.priority))}}class WA{get device(){return this._device}get mainWindow(){return this._mainWindow}set curWindow(t){this._curWindow=t}get curWindow(){return this._curWindow}set tempWindow(t){this._tempWindow=t}get tempWindow(){return this._tempWindow}get windows(){return this._windows}get pipeline(){return this._pipeline}get batcher2D(){return this._batcher}get scenes(){return this._scenes}get cumulativeTime(){return us.get(this._poolHandle,hs.CUMULATIVE_TIME)}get frameTime(){return us.get(this._poolHandle,hs.FRAME_TIME)}get frameCount(){return this._frameCount}get fps(){return this._fps}set fixedFPS(t){t>0?(this._fixedFPS=t,this._fixedFPSFrameTime=1e3/t):this._fixedFPSFrameTime=0}get fixedFPS(){return this._fixedFPS}get dataPoolManager(){return this._dataPoolMgr}get handle(){return this._poolHandle}get useDeferredPipeline(){return this._useDeferredPipeline}constructor(t){this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._fixedFPSFrameTime=0,this._poolHandle=0,this._useDeferredPipeline=!1,this._device=t,this._dataPoolMgr=i.internal.DataPoolManager&&new i.internal.DataPoolManager(t),qm.registerCreateFunc(this),jA.registerCreateFunc(this),this._cameraPool=new Pn((()=>new zh(this._device)),4)}initialize(t){this._poolHandle=us.alloc();const e=new qr,n=new Xr;n.depthStoreOp=Jo.DISCARD,n.stencilStoreOp=Jo.DISCARD;const s=new Kr([e],n);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:this._device.width,height:this._device.height,renderPassInfo:s,swapchainBufferIndices:-1}),this._curWindow=this._mainWindow,Promise.resolve(Tp.initBuiltinRes(this._device)).then((()=>{i.view.on("design-resolution-changed",(()=>{const t=i.game.canvas.width,e=i.game.canvas.height;this.resize(t,e)}),this)}))}destroy(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._poolHandle&&(us.free(this._poolHandle),this._poolHandle=0)}resize(t,e){this._device.resize(t,e),this._mainWindow.resize(t,e);for(const n of this._windows)n.shouldSyncSizeWithSwapchain&&n.resize(t,e);this._pipeline&&this._pipeline.resize(t,e)}setRenderPipeline(t){if(t instanceof pm&&(this._useDeferredPipeline=!0),t||(t=am()),this._pipeline=t,!this._pipeline.activate())return!1;const e=i.director.getScene();return e&&e.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&i.internal.Batcher2D&&(this._batcher=new i.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))}onGlobalPipelineStateChanged(){for(let t=0;t<this._scenes.length;t++)this._scenes[t].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.initDeferredPassInfo()}activeWindow(t){this._curWindow=t}resetCumulativeTime(){us.set(this._poolHandle,hs.CUMULATIVE_TIME,0)}frameMove(t){us.set(this._poolHandle,hs.FRAME_TIME,t),++this._frameCount,us.set(this._poolHandle,hs.CUMULATIVE_TIME,us.get(this._poolHandle,hs.CUMULATIVE_TIME)+t),this._fpsTime+=t,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(let t=0;t<this._scenes.length;++t)this._scenes[t].removeBatches();this._batcher&&this._batcher.update();const e=this._windows,n=[];for(let t=0;t<e.length;t++)e[t].extractRenderCameras(n);if(this._pipeline&&n.length>0){this._device.acquire();const t=this._scenes,e=i.director.getTotalFrames();this._batcher&&this._batcher.uploadBuffers();for(let n=0;n<t.length;n++)t[n].update(e);i.director.emit(i.Director.EVENT_BEFORE_COMMIT),n.sort(((t,e)=>t.priority-e.priority)),this._pipeline.render(n),this._device.present()}this._batcher&&this._batcher.reset()}createWindow(t){const e=this._createWindowFun(this);return e.initialize(this.device,t),this._windows.push(e),e}destroyWindow(t){for(let e=0;e<this._windows.length;++e)if(this._windows[e]===t)return t.destroy(),void this._windows.splice(e,1)}destroyWindows(){for(const t of this._windows)t.destroy();this._windows=[]}createScene(t){const e=this._createSceneFun(this);return e.initialize(t),this._scenes.push(e),e}destroyScene(t){for(let e=0;e<this._scenes.length;++e)if(this._scenes[e]===t)return t.destroy(),void this._scenes.splice(e,1)}destroyScenes(){for(const t of this._scenes)t.destroy();this._scenes=[]}createModel(t){let e=this._modelPools.get(t);e||(this._modelPools.set(t,new Pn((()=>new t),10)),e=this._modelPools.get(t));const n=e.alloc();return n.initialize(),n}destroyModel(t){const e=this._modelPools.get(t.constructor);e?(e.free(t),t.destroy(),t.scene&&t.scene.removeModel(t)):E(1300,t.constructor.name)}createCamera(){return this._cameraPool.alloc()}createLight(t){let e=this._lightPools.get(t);e||(this._lightPools.set(t,new Pn((()=>new t),4)),e=this._lightPools.get(t));const n=e.alloc();return n.initialize(),n}destroyLight(t){const e=this._lightPools.get(t.constructor);if(t.destroy(),e&&(e.free(t),t.scene))switch(t.type){case Gh.SPHERE:t.scene.removeSphereLight(t);break;case Gh.SPOT:t.scene.removeSpotLight(t)}}}i.Root=WA;class kA extends Vn{constructor(){super(),this._compScheduler=void 0,this._nodeActivator=void 0,this._invalid=void 0,this._paused=void 0,this._purgeDirectorInNextLoop=void 0,this._root=void 0,this._loadingScene=void 0,this._scene=void 0,this._totalFrames=void 0,this._lastUpdate=void 0,this._deltaTime=void 0,this._startTime=void 0,this._scheduler=void 0,this._systems=void 0,this._invalid=!1,this._paused=!1,this._purgeDirectorInNextLoop=!1,this._root=null,this._loadingScene="",this._scene=null,this._totalFrames=0,this._lastUpdate=0,this._deltaTime=0,this._startTime=0,this._scheduler=new VA,this._compScheduler=new dA,this._nodeActivator=new EA,this._systems=[],i.game.once(xm.EVENT_RENDERER_INITED,this._initOnRendererInitialized,this)}calculateDeltaTime(t){t||(t=performance.now()),this._deltaTime=t>this._lastUpdate?(t-this._lastUpdate)/1e3:0,this._lastUpdate=t}convertToGL(t){const e=i.game.container,n=i.view,s=e.getBoundingClientRect(),o=s.left+window.pageXOffset-e.clientLeft,r=s.top+window.pageYOffset-e.clientTop,a=n._devicePixelRatio*(t.x-o),c=n._devicePixelRatio*(r+s.height-t.y);return n._isRotated?Ke(n._viewportRect.width-c,a):Ke(a,c)}convertToUI(t){const e=i.game.container,n=i.view,s=e.getBoundingClientRect(),o=s.left+window.pageXOffset-e.clientLeft,r=s.top+window.pageYOffset-e.clientTop,a=Ke(0,0);return n._isRotated?(a.x=o+t.y/n._devicePixelRatio,a.y=r+s.height-(n._viewportRect.width-t.x)/n._devicePixelRatio):(a.x=o+t.x*n._devicePixelRatio,a.y=r+s.height-t.y*n._devicePixelRatio),a}end(){this._purgeDirectorInNextLoop=!0}getWinSize(){return xn(i.winSize)}getWinSizeInPixels(){return xn(i.winSize)}pause(){this._paused||(this._paused=!0)}purgeCachedData(){i.assetManager.releaseAll()}purgeDirector(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),Kp&&Kp.setEnabled(!1),i.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),i.assetManager.releaseAll()}reset(){this.purgeDirector(),this.emit(kA.EVENT_RESET),Kp&&Kp.setEnabled(!0),this.startAnimation()}runSceneImmediate(t,e,n){t instanceof PA&&(t=t.scene),P(t instanceof ZE,1216),t._load();const s=Object.keys(i.game._persistRootNodes).map((t=>i.game._persistRootNodes[t]));for(let e=0;e<s.length;e++){const n=s[e];n.emit(i.Node.SCENE_CHANGED_FOR_PERSISTS,t.renderScene);const o=t.uuid===n._originalSceneId&&t.getChildByUuid(n.uuid);if(o){const e=o.getSiblingIndex();o._destroyImmediate(),t.insertChild(n,e)}else n.parent=t}const o=this._scene;i.isValid(o)&&o.destroy(),i.assetManager._releaseManager._autoRelease(o,t,i.game._persistRootNodes),this._scene=null,Rn._deferredDestroy(),e&&e(),this.emit(i.Director.EVENT_BEFORE_SCENE_LAUNCH,t),this._scene=t,t._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),n&&n(null,t),this.emit(i.Director.EVENT_AFTER_SCENE_LAUNCH,t)}runScene(t,e,n){t instanceof PA&&(t=t.scene),P(t,1205),P(t instanceof ZE,1216),t._load(),this.once(i.Director.EVENT_AFTER_DRAW,(()=>{this.runSceneImmediate(t,e,n)}))}loadScene(t,e,n){if(this._loadingScene)return E(1208,t,this._loadingScene),!1;const s=i.assetManager.bundles.find((e=>!!e.getSceneInfo(t)));return s?(this.emit(i.Director.EVENT_BEFORE_SCENE_LOADING,t),this._loadingScene=t,console.time(`LoadScene ${t}`),s.loadScene(t,((i,s)=>{console.timeEnd(`LoadScene ${t}`),this._loadingScene="",i?(p(i),e&&e(i)):this.runSceneImmediate(s,n,e)})),!0):(C(1209,t),!1)}preloadScene(t,e,n){const s=i.assetManager.bundles.find((e=>!!e.getSceneInfo(t)));if(s)s.preloadScene(t,null,e,n);else{const e=`Can not preload the scene "${t}" because it is not in the build settings.`;n&&n(new Error(e)),p(`preloadScene: ${e}`)}}resume(){this._paused&&(this._lastUpdate=performance.now(),this._lastUpdate||S(1200),this._paused=!1,this._deltaTime=0)}setDepthTest(t){i.Camera.main&&(i.Camera.main.depth=!!t)}setClearColor(t){i.Camera.main&&(i.Camera.main.backgroundColor=t)}get root(){return this._root}getRunningScene(){return this._scene}getScene(){return this._scene}getAnimationInterval(){return 1e3/i.game.getFrameRate()}setAnimationInterval(t){i.game.setFrameRate(Math.round(1e3/t))}getDeltaTime(){return this._deltaTime}getTotalTime(){return performance.now()-this._startTime}getCurrentTime(){return this._lastUpdate}getTotalFrames(){return this._totalFrames}isPaused(){return this._paused}getScheduler(){return this._scheduler}setScheduler(t){this._scheduler!==t&&(this.unregisterSystem(this._scheduler),this._scheduler=t,this.registerSystem(VA.ID,t,200))}registerSystem(t,e,n){e.id=t,e.priority=n,e.init(),this._systems.push(e),this._systems.sort(BA.sortByPriority)}unregisterSystem(t){Pt.fastRemove(this._systems,t),this._systems.sort(BA.sortByPriority)}getSystem(t){return this._systems.find((e=>e.id===t))}getAnimationManager(){return this.getSystem(i.AnimationManager.ID)}startAnimation(){this._invalid=!1,this._lastUpdate=performance.now()}stopAnimation(){this._invalid=!0}mainLoop(t){if(this._purgeDirectorInNextLoop)this._purgeDirectorInNextLoop=!1,this.purgeDirector();else if(!this._invalid){this.calculateDeltaTime(t);const e=this._deltaTime;if(!this._paused){this.emit(kA.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(e);for(let t=0;t<this._systems.length;++t)this._systems[t].update(e);this._compScheduler.lateUpdatePhase(e),this.emit(kA.EVENT_AFTER_UPDATE),Rn._deferredDestroy();for(let t=0;t<this._systems.length;++t)this._systems[t].postUpdate(e)}this.emit(kA.EVENT_BEFORE_DRAW),this._root.frameMove(this._deltaTime),this.emit(kA.EVENT_AFTER_DRAW),Kp.frameUpdateListeners(),ey.clearBooks(),this._totalFrames++}}_initOnRendererInitialized(){this._totalFrames=0,this._lastUpdate=performance.now(),this._startTime=this._lastUpdate,this._paused=!1,this._purgeDirectorInNextLoop=!1,Kp&&Kp.setEnabled(!0),this.registerSystem(VA.ID,this._scheduler,200),this.emit(kA.EVENT_INIT)}_init(){return this._root=new WA(i.game._gfxDevice),this._root.initialize({}).catch((t=>(C(1217),Promise.reject(t))))}}t("Director",kA),kA.EVENT_INIT="director_init",kA.EVENT_RESET="director_reset",kA.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",kA.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",kA.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",kA.EVENT_BEFORE_UPDATE="director_before_update",kA.EVENT_AFTER_UPDATE="director_after_update",kA.EVENT_BEFORE_DRAW="director_before_draw",kA.EVENT_AFTER_DRAW="director_after_draw",kA.EVENT_BEFORE_COMMIT="director_before_commit",kA.EVENT_BEFORE_PHYSICS="director_before_physics",kA.EVENT_AFTER_PHYSICS="director_after_physics",kA.instance=void 0,i.Director=kA;const qA=t("director",kA.instance=i.director=new kA);class XA{constructor(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new N_,this.scenes=new N_,this.paths=new N_}init(t){(t=>{let e=t.uuids;const n=t.paths,i=t.types,s=t.deps,o=t.paths=Object.create(null);if(!1===t.debug){for(let t=0,n=e.length;t<n;t++)e[t]=Z_(e[t]);for(const t in n){const e=n[t],s=e[1];e[1]=i[s]}}else{const t=Object.create(null);for(let n=0,i=e.length;n<i;n++){const i=e[n];e[n]=t[i]=Z_(i)}e=t}for(const t in n){const i=n[t];o[e[t]]=i}const r=t.scenes;for(const t in r){const n=r[t];r[t]=e[n]}const a=t.packs;for(const t in a){const n=a[t];for(let t=0;t<n.length;++t)n[t]=e[n[t]]}const c=t.versions;if(c)for(const t in c){const n=c[t];for(let t=0;t<n.length;t+=2){const i=n[t];n[t]=e[i]||i}}const l=t.redirect;if(l)for(let t=0;t<l.length;t+=2)l[t]=e[l[t]],l[t+1]=s[l[t+1]]})(t),this.importBase=t.importBase||"",this.nativeBase=t.nativeBase||"",this.base=t.base||"",this.name=t.name||"",this.deps=t.deps||[],this._initUuid(t.uuids),this._initPath(t.paths),this._initScene(t.scenes),this._initPackage(t.packs),this._initVersion(t.versions),this._initRedirect(t.redirect)}getInfoWithPath(t,e){if(!t)return null;t=eu(t);const n=this.paths.get(t);if(n){if(!e)return n[0];for(let t=0,i=n.length;t<i;t++){const i=n[t];if(wt.isChildClassOf(i.ctor,e))return i}}return null}getDirWithPath(t,e,n){"/"===(t=eu(t))[t.length-1]&&(t=t.slice(0,-1));const i=n||[];return this.paths.forEach(((n,s)=>{if(s.startsWith(t)&&((t,e)=>!(t.length>e.length)||47===t.charCodeAt(e.length))(s,t)||!t)for(let t=0,s=n.length;t<s;t++){const s=n[t];e&&!wt.isChildClassOf(s.ctor,e)||i.push(s)}})),i}getAssetInfo(t){return this.assetInfos.get(t)||null}getSceneInfo(t){return t.endsWith(".scene")||(t+=".scene"),"/"===t[0]||t.startsWith("db://")||(t=`/${t}`),this.scenes.find(((e,n)=>n.endsWith(t)))}destroy(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()}_initUuid(t){if(t){this.assetInfos.clear();for(let e=0,n=t.length;e<n;e++){const n=t[e];this.assetInfos.add(n,{uuid:n})}}}_initPath(t){if(!t)return;const e=this.paths;e.clear();for(const n in t){const i=t[n],s=i[0],o=i[1],r=3===i.length,a=this.assetInfos.get(n);a.path=s,a.ctor=wt._getClassById(o),e.has(s)?r?e.get(s).push(a):e.get(s).splice(0,0,a):e.add(s,[a])}}_initScene(t){if(!t)return;const e=this.scenes;e.clear();const n=this.assetInfos;for(const i in t){const s=t[i],o=n.get(s);o.url=i,e.add(i,o)}}_initPackage(t){if(!t)return;const e=this.assetInfos;for(const n in t){const i=t[n],s={uuid:n,packedUuids:i,ext:".json"};e.add(n,s);for(let t=0,n=i.length;t<n;t++){const o=i[t],r=e.get(o),a=r.packs;a?1===n?a.splice(0,0,s):a.push(s):r.packs=[s]}}}_initVersion(t){if(!t)return;const e=this.assetInfos;let n=t.import;if(n)for(let t=0,i=n.length;t<i;t+=2){const i=n[t];e.get(i).ver=n[t+1]}if(n=t.native,n)for(let t=0,i=n.length;t<i;t+=2){const i=n[t];e.get(i).nativeVer=n[t+1]}}_initRedirect(t){if(!t)return;const e=this.assetInfos;for(let n=0,i=t.length;n<i;n+=2){const i=t[n];e.get(i).redirect=t[n+1]}}}function YA(t,e){t._uuid&&e.push(t._uuid)}function KA(t,e){const n=Object.getOwnPropertyNames(t);for(let i=0;i<n.length;i++){const s=n[i];if("node"===s||"__eventTargets"===s)continue;const o=t[s];if("object"==typeof o&&o)if(Array.isArray(o))for(let t=0;t<o.length;t++){const n=o[t];n instanceof lu&&YA(n,e)}else if(o.constructor&&o.constructor!==Object)o instanceof lu&&YA(o,e);else{const t=Object.getOwnPropertyNames(o);for(let n=0;n<t.length;n++){const i=o[t[n]];i instanceof lu&&YA(i,e)}}}}function $A(t,e){for(let n=0;n<t._components.length;n++)KA(t._components[n],e);for(let n=0;n<t._children.length;n++)$A(t._children[n],e)}function ZA(t,e,n,i){n.push(t._uuid);const s=Od.getDeps(t._uuid);for(let t=0,o=s.length;t<o;t++){const o=B_.get(s[t]);if(!o)continue;const r=o._uuid;r in e?e[r]+=i:e[r]=o.refCount+i,n.includes(r)||ZA(o,e,n,i)}}const JA=[];var QA=new class{constructor(){this._persistNodeDeps=new N_,this._toDelete=new N_,this._eventListener=!1}init(){this._persistNodeDeps.clear(),this._toDelete.clear()}_addPersistNodeRef(t){const e=[];$A(t,e);for(let t=0,n=e.length;t<n;t++){const n=B_.get(e[t]);n&&n.addRef()}this._persistNodeDeps.add(t.uuid,e)}_removePersistNodeRef(t){if(!this._persistNodeDeps.has(t.uuid))return;const e=this._persistNodeDeps.get(t.uuid);for(let t=0,n=e.length;t<n;t++){const n=B_.get(e[t]);n&&n.decRef()}this._persistNodeDeps.remove(t.uuid)}_autoRelease(t,e,n){if(t){const n=Od.getDeps(t.uuid);for(let e=0,i=n.length;e<i;e++){const i=B_.get(n[e]);i&&i.decRef(t.autoReleaseAssets)}const i=Od._depends.get(t.uuid);if(i&&i.persistDeps){const e=i.persistDeps;for(let n=0,i=e.length;n<i;n++){const i=B_.get(e[n]);i&&i.decRef(t.autoReleaseAssets)}}t.uuid!==e.uuid&&Od.remove(t.uuid)}const i=Od._depends.get(e.uuid);i&&(i.persistDeps=[]);for(const t in n){const e=n[t],s=this._persistNodeDeps.get(e.uuid);for(const t of s){const e=B_.get(t);e&&e.addRef()}i&&i.persistDeps.push(...s)}}tryRelease(t,e=!1){t instanceof lu&&(e?this._free(t,e):(this._toDelete.add(t._uuid,t),this._eventListener||(this._eventListener=!0,jt(this._freeAssets.bind(this)))))}_freeAssets(){this._eventListener=!1,this._toDelete.forEach((t=>{this._free(t)})),this._toDelete.clear()}_free(t,e=!1){const n=t._uuid;if(this._toDelete.remove(n),!Mn(t,!0))return;if(!e&&t.refCount>0&&function(t){const e=Object.create(null);if(e[t._uuid]=t.refCount,ZA(t,e,JA,-1),JA.length=0,0!==e[t._uuid])return e[t._uuid];for(const t in e)0!==e[t]&&ZA(B_.get(t),e,JA,1);return JA.length=0,e[t._uuid]}(t)>0)return;B_.remove(n);const i=Od.getDeps(n);for(let t=0,e=i.length;t<e;t++){const e=B_.get(i[t]);e&&(e.decRef(!1),this._free(e,!1))}t.destroy(),Od.remove(n)}};function tC(t,e){for(let n=0,i=t.input.length;n<i;n++){const i=t.input[n];e&&!i.isNative&&i.content instanceof lu&&i.content.decRef(!1),i.recycle()}t.input=null}function eC(t,e){return e?/\?/.test(t)?`${t}&_t=${Date.now()}`:`${t}?_t=${Date.now()}`:t}function nC(t,e,n,i,s=0){t(s,((o,r)=>{s++,!o||s>e?i&&i(o,r):setTimeout((()=>{nC(t,e,n,i,s)}),n)}))}function iC(t,e,n,i,s){try{const o=Od.parse(t,e);for(let t=0,e=o.deps.length;t<e;t++){const e=o.deps[t];e in n||(n[e]=!0,i.push({uuid:e,bundle:s&&s.name}))}o.nativeDep&&(s&&(o.nativeDep.bundle=s.name),i.push({...o.nativeDep}))}catch(t){p(t.message,t.stack)}}function sC(t,e,n){e&&(n=void 0!==n?n:i.assetManager.cacheAsset,tu(e)||!n||e.isDefault||B_.add(t,e))}function oC(t,e,n){let i=0;const s=[],o=t.length;0===o&&n&&n(s);const r=t=>{t&&s.push(t),i++,i===o&&n&&n(s)};for(let n=0;n<o;n++)e(t[n],r)}function rC(t,e,n){let i=t,s=e,o=n;if(void 0===n){const n="function"==typeof t;e?(o=e,n||(s=null)):void 0===e&&n&&(o=t,i=null,s=null),void 0!==e&&n&&(s=t,i=null)}return{options:i||Object.create(null),onProgress:s,onComplete:o}}function aC(t,e,n){let i=t,s=e,o=n;if(void 0===n){const n=wt.isChildClassOf(t,lu);e?(o=e,n&&(s=null)):void 0!==e||n||(o=t,s=null,i=null),void 0===e||n||(s=t,i=null)}return{type:i,onProgress:s||null,onComplete:o}}function cC(t,e,n,i={}){if(!n[e]||i[e])return!1;i[e]=!0;let s=!1;const o=Od.getDeps(e);if(o)for(let e=0,r=o.length;e<r;e++){const r=o[e];if(r===t||cC(t,r,n,i)){s=!0;break}}return s}function lC(t){return(e,n)=>{if(!t)return;const i=[];Array.isArray(n)?n.forEach((t=>t instanceof lu&&i.push(t.addRef()))):n instanceof lu&&i.push(n.addRef()),jt((()=>{i.forEach((t=>t.decRef(!1))),t(e,n)}))}}class hC{constructor(){this._config=new XA}get config(){return this._config}get name(){return this._config.name}get deps(){return this._config.deps}get base(){return this._config.base}getInfoWithPath(t,e){return this._config.getInfoWithPath(t,e)}getDirWithPath(t,e,n){return this._config.getDirWithPath(t,e,n)}getAssetInfo(t){return this._config.getAssetInfo(t)}getSceneInfo(t){return this._config.getSceneInfo(t)}init(t){this._config.init(t),U_.add(t.name,this)}load(t,e,n,s){const{type:o,onProgress:r,onComplete:a}=aC(e,n,s),c={__requestType__:j_.PATH,type:o,bundle:this.name,__outputAsArray__:Array.isArray(t)};i.assetManager.loadAny(t,c,r,a)}preload(t,e,n,s){const{type:o,onProgress:r,onComplete:a}=aC(e,n,s);i.assetManager.preloadAny(t,{__requestType__:j_.PATH,type:o,bundle:this.name},r,a)}loadDir(t,e,n,s){const{type:o,onProgress:r,onComplete:a}=aC(e,n,s);i.assetManager.loadAny(t,{__requestType__:j_.DIR,type:o,bundle:this.name,__outputAsArray__:!0},r,a)}preloadDir(t,e,n,s){const{type:o,onProgress:r,onComplete:a}=aC(e,n,s);i.assetManager.preloadAny(t,{__requestType__:j_.DIR,type:o,bundle:this.name},r,a)}loadScene(t,e,n,s){const{options:o,onProgress:r,onComplete:a}=rC(e,n,s);o.preset=o.preset||"scene",o.bundle=this.name,i.assetManager.loadAny({scene:t},o,r,((t,e)=>{if(t)p(t.message,t.stack);else if(e instanceof PA&&e.scene){const t=e.scene;t._id=e._uuid,t.name=e.name}else t=new Error(`The asset ${e._uuid} is not a scene`);a&&a(t,e)}))}preloadScene(t,e,n,s){const{options:o,onProgress:r,onComplete:a}=rC(e,n,s);o.bundle=this.name,i.assetManager.preloadAny({scene:t},o,r,(e=>{e&&C(1210,t,e.message),a&&a(e)}))}get(t,e){const n=this.getInfoWithPath(t,e);return n&&B_.get(n.uuid)||null}release(t,e){const n=this.get(t,e);n&&QA.tryRelease(n,!0)}releaseUnusedAssets(){B_.forEach((t=>{const e=this.getAssetInfo(t._uuid);e&&!e.redirect&&QA.tryRelease(t)}))}releaseAll(){B_.forEach((t=>{const e=this.getAssetInfo(t._uuid);e&&!e.redirect&&QA.tryRelease(t,!0)}))}_destroy(){this._config.destroy()}}const _C=t("resources",new hC);function uC(t,e,n){const i=new Image;function s(){i.removeEventListener("load",s),i.removeEventListener("error",o),n&&n(null,i)}function o(){i.removeEventListener("load",s),i.removeEventListener("error",o),n&&n(new Error(D(4930,t)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.addEventListener("load",s),i.addEventListener("error",o),i.src=t,i}function dC(t,e,n,i){const s=new XMLHttpRequest,o=`download failed: ${t}, status: `;if(s.open("GET",t,!0),void 0!==e.xhrResponseType&&(s.responseType=e.xhrResponseType),void 0!==e.xhrWithCredentials&&(s.withCredentials=e.xhrWithCredentials),void 0!==e.xhrMimeType&&s.overrideMimeType&&s.overrideMimeType(e.xhrMimeType),void 0!==e.xhrTimeout&&(s.timeout=e.xhrTimeout),e.xhrHeader)for(const t in e.xhrHeader)s.setRequestHeader(t,e.xhrHeader[t]);return s.onload=()=>{200===s.status||0===s.status?i&&i(null,s.response):i&&i(new Error(`${o}${s.status}(no response)`))},n&&(s.onprogress=t=>{t.lengthComputable&&n(t.loaded,t.total)}),s.onerror=()=>{i&&i(new Error(`${o}${s.status}(error)`))},s.ontimeout=()=>{i&&i(new Error(`${o}${s.status}(time out)`))},s.onabort=()=>{i&&i(new Error(`${o}${s.status}(abort)`))},s.send(null),s}i.resources=_C;const pC={};function fC(t,e,n){if(pC[t])return n&&n(null),null;const i=document.createElement("script");function s(){i.parentNode.removeChild(i),i.removeEventListener("load",s,!1),i.removeEventListener("error",o,!1),pC[t]=!0,n&&n(null)}function o(){i.parentNode.removeChild(i),i.removeEventListener("load",s,!1),i.removeEventListener("error",o,!1),n&&n(new Error(D(4928,t)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.async=e.scriptAsyncLoading||!1,i.src=t,i.addEventListener("load",s,!1),i.addEventListener("error",o,!1),document.body.appendChild(i),i}const mC=/^(?:\w+:\/\/|\.+\/).+/,gC=(t,e,n)=>{(Rp.capabilities.imageBitmap&&i.assetManager.allowImageBitmap?vC:uC)(t,e,n)},vC=(t,e,n)=>{e.xhrResponseType="blob",dC(t,e,e.onFileProgress,n)},yC=(t,e,n)=>{e.xhrResponseType="json",dC(t,e,e.onFileProgress,n)},xC=(t,e,n)=>{e.xhrResponseType="arraybuffer",dC(t,e,e.onFileProgress,n)},SC=(t,e,n)=>{e.xhrResponseType="text",dC(t,e,e.onFileProgress,n)},TC=(t,e,n)=>{const i=ri(t);let s=t;mC.test(s)||(s=-1!==EC.remoteBundles.indexOf(i)?`${EC.remoteServerAddress}remote/${i}`:`assets/${i}`);const o=e.version||EC.bundleVers[i];let r=0,a=null,c=null;yC(`${s}/config.${o?`${o}.`:""}json`,e,((t,e)=>{c=t,a=e,a&&(a.base=`${s}/`),2==++r&&n(c,a)})),fC(`${s}/index.${o?`${o}.`:""}js`,e,(t=>{c=t,2==++r&&n(t,a)}))},EC=new class{constructor(){this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=uC,this.downloadDomAudio=null,this.downloadFile=dC,this.downloadScript=fC,this._downloaders={".png":gC,".jpg":gC,".bmp":gC,".jpeg":gC,".gif":gC,".ico":gC,".tiff":gC,".webp":gC,".image":gC,".pvr":xC,".pkm":xC,".astc":xC,".txt":SC,".xml":SC,".vsh":SC,".fsh":SC,".atlas":SC,".tmx":SC,".tsx":SC,".json":yC,".ExportJson":yC,".plist":SC,".fnt":SC,".binary":xC,".bin":xC,".dbbin":xC,".skel":xC,".js":fC,bundle:TC,default:SC},this._downloading=new N_,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}get remoteServerAddress(){return this._remoteServerAddress}init(t="",e={},n=[]){this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=t,this.bundleVers=e,this.remoteBundles=n}register(t,e){"object"==typeof t?ht(this._downloaders,t):this._downloaders[t]=e}download(t,e,n,i,s){const o=F_.get(t);if(o)return void s(null,o);const r=this._downloading.get(t);if(r){r.push(s);const e=this._queue.find((e=>e.id===t));if(!e)return;const n=i.priority||0;return void(e.priority<n&&(e.priority=n,this._queueDirty=!0))}const a=void 0!==i.maxRetryCount?i.maxRetryCount:this.maxRetryCount,c=void 0!==i.maxConcurrency?i.maxConcurrency:this.maxConcurrency,l=void 0!==i.maxRequestsPerFrame?i.maxRequestsPerFrame:this.maxRequestsPerFrame,h=this._downloaders[n]||this._downloaders.default;nC(((n,o)=>{if(0===n&&this._downloading.add(t,[s]),!this.limited)return void h(eC(e,this.appendTimeStamp),i,o);this._updateTime();const r=(t,e)=>{this._totalNum--,this._handleQueueInNextFrame(c,l),o(t,e)};this._totalNum<c&&this._totalNumThisPeriod<l?(h(eC(e,this.appendTimeStamp),i,r),this._totalNum++,this._totalNumThisPeriod++):(this._queue.push({id:t,priority:i.priority||0,url:e,options:i,done:r,handler:h}),this._queueDirty=!0,this._totalNum<c&&this._handleQueueInNextFrame(c,l))}),a,this.retryInterval,((e,n)=>{e||F_.add(t,n);const i=this._downloading.remove(t);for(let t=0,s=i.length;t<s;t++)i[t](e,n)}))}loadSubpackage(t,e){i.assetManager.loadBundle(t,null,e)}_updateTime(){const t=Date.now(),e=i.director.getDeltaTime(),n=e>this._maxInterval?this._maxInterval:e;t-this._lastDate>1e3*n&&(this._totalNumThisPeriod=0,this._lastDate=t)}_handleQueue(t,e){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<t&&this._totalNumThisPeriod<e;){this._queueDirty&&(this._queue.sort(((t,e)=>t.priority-e.priority)),this._queueDirty=!1);const t=this._queue.pop();if(!t)break;this._totalNum++,this._totalNumThisPeriod++,t.handler(eC(t.url,this.appendTimeStamp),t.options,t.done)}this._handleQueueInNextFrame(t,e)}_handleQueueInNextFrame(t,e){!this._checkNextPeriod&&this._queue.length>0&&(jt(this._handleQueue.bind(this),t,e),this._checkNextPeriod=!0)}};function AC(t,e,n,i){let s=null,o=null;try{s=new xu,s._nativeUrl=t,s._nativeAsset=e}catch(t){o=t}i(o,s)}function CC(t,e,n,i){const s=new LA;s.json=e,i(null,s)}function bC(t,e,n,i){const s=new RA;s.text=e,i(null,s)}function PC(t,e,n,i){const s=new _S;s._nativeUrl=t,s._nativeAsset=e,i(null,s)}function wC(t,e,n,i){const s=new lu;s._nativeUrl=t,s._nativeAsset=e,i(null,s)}function DC(t,n,i,s){let o=U_.get(n.name);o||(o=n.name===k_.RESOURCES?_C:new hC,n.base=n.base||`${t}/`,o.init(n)),e.import(`virtual:///prerequisite-imports/${o.name}`).then((()=>{s(null,o)})).catch(s)}var IC=new class{constructor(){this._creating=new N_,this._producers={".png":AC,".jpg":AC,".bmp":AC,".jpeg":AC,".gif":AC,".ico":AC,".tiff":AC,".webp":AC,".image":AC,".pvr":AC,".pkm":AC,".txt":bC,".xml":bC,".vsh":bC,".fsh":bC,".atlas":bC,".tmx":bC,".tsx":bC,".fnt":bC,".json":CC,".ExportJson":CC,".binary":PC,".bin":PC,".dbbin":PC,".skel":PC,bundle:DC,default:wC}}register(t,e){"object"==typeof t?wt.mixin(this._producers,t):this._producers[t]=e}create(t,e,n,i,s){const o=this._producers[n]||this._producers.default,r=B_.get(t);if(!i.reloadAsset&&r)return void s(null,r);const a=this._creating.get(t);a?a.push(s):(this._creating.add(t,[s]),o(t,e,i,((e,n)=>{!e&&n instanceof lu&&(n._uuid=t,sC(t,n,i.cacheAsset));const s=this._creating.remove(t);for(let t=0,i=s.length;t<i;t++)s[t](e,n)})))}},RC=new class{constructor(){this._loading=new N_,this._unpackers={".json":this.unpackJson}}unpackJson(t,e,n,i){let s=wt.createMap(!0),o=null;if(Array.isArray(e)){(e=function(t){if(t[0]<1)throw new Error(D(5304,t[0]));td(t,!0,void 0),ed(t);const e=new id(t[0]),n=t[1],i=t[2],s=t[3],o=t[4],r=t[5];for(let t=0;t<r.length;++t)r[t].unshift(e,n,i,s,o);return r}(e)).length!==t.length&&C(4915);for(let n=0;n<t.length;n++)s[`${t[n]}@import`]=e[n]}else{const n=wt._getClassId(Gd),i=wt._getClassId(xu);if(e.type===n&&e.data){const i=e.data;i.length!==t.length&&C(4915);for(let e=0;e<t.length;e++)s[`${t[e]}@import`]=sd(n,{base:i[e][0],mipmaps:i[e][1]})}else if(e.type===i&&e.data){const n=e.data;n.length!==t.length&&C(4915);for(let e=0;e<t.length;e++)s[`${t[e]}@import`]=n[e]}else o=new Error("unmatched type pack!"),s=null}i(o,s)}init(){this._loading.clear()}register(t,e){"object"==typeof t?wt.mixin(this._unpackers,t):this._unpackers[t]=e}unpack(t,e,n,i,s){e?(0,this._unpackers[n])(t,e,i,s):s(new Error("package data is wrong!"))}load(t,e,n){if(t.isNative||!t.info||!t.info.packs)return void EC.download(t.id,t.url,t.ext,t.options,n);if(F_.has(t.id))return void n(null,F_.get(t.id));const i=t.info.packs;let s=i.find((t=>this._loading.has(t.uuid)));if(s)return void this._loading.get(s.uuid).push({onComplete:n,id:t.id});s=i[0],this._loading.add(s.uuid,[{onComplete:n,id:t.id}]);const o=nu(s.uuid,{ext:s.ext,bundle:t.config.name});EC.download(s.uuid,o,s.ext,t.options,((e,n)=>{F_.remove(s.uuid),e&&p(e.message,e.stack),this.unpack(s.packedUuids,n,s.ext,t.options,((t,n)=>{if(!t)for(const t in n)F_.add(t,n[t]);const i=this._loading.remove(s.uuid);for(let s=0,o=i.length;s<o;s++){const o=i[s];if(e||t){o.onComplete(e||t);continue}const r=n[o.id];r?o.onComplete(null,r):o.onComplete(new Error("can not retrieve data from package"))}}))}))}};function OC(t,e){let n=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},n=!0);const{options:s,progress:o}=t,r=[],a=o.total,c=s.__exclude__=s.__exclude__||Object.create(null);t.output=[],oC(t.input,((s,l)=>{if(!s.isNative&&B_.has(s.uuid)){const e=B_.get(s.uuid);return s.content=e.addRef(),t.output.push(s),o.canInvoke&&t.dispatch("progress",++o.finish,o.total,s),void l()}RC.load(s,t.options,((h,_)=>{h?t.isFinish||(!i.assetManager.force||n?(p(h.message,h.stack),o.canInvoke=!1,e(h)):(t.output.push(s),o.canInvoke&&t.dispatch("progress",++o.finish,o.total,s))):t.isFinish||(s.file=_,t.output.push(s),s.isNative||(c[s.uuid]=!0,iC(s.uuid,_,c,r,s.config),o.total=a+r.length),o.canInvoke&&t.dispatch("progress",++o.finish,o.total,s)),l()}))}),(()=>{if(t.isFinish)return tC(t,!0),void t.dispatch("error");if(r.length>0){const i=q_.create({input:r,progress:o,options:s,onProgress:t.onProgress,onError:q_.prototype.recycle,onComplete:s=>{s||(t.output.push(...i.output),i.recycle()),n&&MC(t),e(s)}});G_.async(i)}else n&&MC(t),e()}))}function MC(t){const e=t.output;for(let t=0,n=e.length;t<n;t++)e[t].content&&e[t].content.decRef(!1)}const NC=new class extends class{constructor(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}parse(t){return this._parseXML(t)}_parseXML(t){if(this._parser)return this._parser.parseFromString(t,"text/xml");throw new Error("Dom parser is not supported in this platform!")}}{parse(t){const e=this._parseXML(t).documentElement;if("plist"!==e.tagName)return E(5100),{};let n=null;for(let t=0,i=e.childNodes.length;t<i&&(n=e.childNodes[t],1!==n.nodeType);t++);return this._parseNode(n)}_parseNode(t){let e=null;const n=t.tagName;if("dict"===n)e=this._parseDict(t);else if("array"===n)e=this._parseArray(t);else if("string"===n)if(1===t.childNodes.length)e=t.firstChild.nodeValue;else{e="";for(let n=0;n<t.childNodes.length;n++)e+=t.childNodes[n].nodeValue}else"false"===n?e=!1:"true"===n?e=!0:"real"===n?e=parseFloat(t.firstChild.nodeValue):"integer"===n&&(e=parseInt(t.firstChild.nodeValue,10));return e}_parseArray(t){const e=[];for(let n=0,i=t.childNodes.length;n<i;n++){const i=t.childNodes[n];1===i.nodeType&&e.push(this._parseNode(i))}return e}_parseDict(t){const e={};let n="";for(let i=0,s=t.childNodes.length;i<s;i++){const s=t.childNodes[i];1===s.nodeType&&("key"===s.tagName?n=s.firstChild.nodeValue:e[n]=this._parseNode(s))}return e}};function LC(t,e){return t[e]<<8|t[e+1]}var BC=new class{constructor(){this._parsing=new N_,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".mp3":this.parseAudio,".ogg":this.parseAudio,".wav":this.parseAudio,".m4a":this.parseAudio,".plist":this.parsePlist,import:this.parseImport}}parseImage(t,e,n){t instanceof HTMLImageElement?n(null,t):createImageBitmap(t,{premultiplyAlpha:"none"}).then((t=>{n(null,t)}),(t=>{n(t,null)}))}parseAudio(t,e,n){t instanceof ArrayBuffer?Rp.__audioSupport.context.decodeAudioData(t,(t=>{n(null,t)}),(t=>{n(new Error(`Error with decoding audio data${t.err}`),null)})):n(null,t)}parsePVRTex(t,e,n){let i=null,s=null;try{const e=t instanceof ArrayBuffer?t:t.buffer,n=new Int32Array(e,0,13);if(55727696===n[0]){const t=n[7],i=n[6],o=n[12]+52;s={_data:new Uint8Array(e,o),_compressed:!0,width:t,height:i,format:0}}else{if(559044176!==n[11])throw new Error("Invalid magic number in PVR header");{const t=n[0],i=n[1],o=n[2];s={_data:new Uint8Array(e,t),_compressed:!0,width:o,height:i,format:0}}}}catch(t){i=t}n(i,s)}parsePKMTex(t,e,n){let i=null,s=null;try{const e=t instanceof ArrayBuffer?t:t.buffer,n=new Uint8Array(e),i=LC(n,6);if(0!==i&&1!==i&&3!==i)throw new Error("Invalid magic number in ETC header");const o=LC(n,12),r=LC(n,14);LC(n,8),LC(n,10),s={_data:new Uint8Array(e,16),_compressed:!0,width:o,height:r,format:0}}catch(t){i=t}n(i,s)}parseASTCTex(t,e,n){let i=null,s=null;try{const e=t instanceof ArrayBuffer?t:t.buffer,n=new Uint8Array(e);if(1554098963!==n[0]+(n[1]<<8)+(n[2]<<16)+(n[3]<<24))throw new Error("Invalid magic number in ASTC header");const i=n[4],o=n[5],r=n[6];if((i<3||i>6||o<3||o>6||r<3||r>6)&&(i<4||7===i||9===i||11===i||i>12||o<4||7===o||9===o||11===o||o>12||1!==r))throw new Error("Invalid block number in ASTC header");const a=function(t,e){return 4===t?hu.RGBA_ASTC_4x4:5===t?4===e?hu.RGBA_ASTC_5x4:hu.RGBA_ASTC_5x5:6===t?5===e?hu.RGBA_ASTC_6x5:hu.RGBA_ASTC_6x6:8===t?5===e?hu.RGBA_ASTC_8x5:6===e?hu.RGBA_ASTC_8x6:hu.RGBA_ASTC_8x8:10===t?5===e?hu.RGBA_ASTC_10x5:6===e?hu.RGBA_ASTC_10x6:8===e?hu.RGBA_ASTC_10x8:hu.RGBA_ASTC_10x10:10===e?hu.RGBA_ASTC_12x10:hu.RGBA_ASTC_12x12}(i,o),c=n[7]+(n[8]<<8)+(n[9]<<16),l=n[10]+(n[11]<<8)+(n[12]<<16);n[13],n[14],n[15],s={_data:new Uint8Array(e,16),_compressed:!0,width:c,height:l,format:a}}catch(t){i=t}n(i,s)}parsePlist(t,e,n){let i=null;const s=NC.parse(t);s||(i=new Error("parse failed")),n(i,s)}parseImport(t,e,n){if(!t)return void n(new Error(`The json file of asset ${e.__uuid__} is empty or missing`));let i=null,s=null;try{i=Id(t,e)}catch(t){s=t}n(s,i)}init(){this._parsing.clear()}register(t,e){"object"==typeof t?ht(this._parsers,t):this._parsers[t]=e}parse(t,e,n,i,s){const o=z_.get(t);if(o)return void s(null,o);const r=this._parsing.get(t);if(r)return void r.push(s);const a=this._parsers[n];a?(this._parsing.add(t,[s]),a(e,i,((e,n)=>{e?F_.remove(t):tu(n)||z_.add(t,n);const i=this._parsing.remove(t);for(let t=0,s=i.length;t<s;t++)i[t](e,n)}))):s(null,e)}};function FC(t,e){let n=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},n=!0);const{options:s,progress:o}=t;s.__exclude__=s.__exclude__||Object.create(null),t.output=[],oC(t.input,((r,a)=>{const c=q_.create({input:r,onProgress:t.onProgress,options:s,progress:o,onComplete:(s,l)=>{s&&!t.isFinish&&(!i.assetManager.force||n?(p(s.message,s.stack),o.canInvoke=!1,e(s)):o.canInvoke&&t.dispatch("progress",++o.finish,o.total,r)),t.output.push(l),c.recycle(),a(null)}});zC.async(c)}),(()=>{if(s.__exclude__=null,t.isFinish)return tC(t,!0),void t.dispatch("error");!function(t){const e=t.source;if(t.options.__outputAsArray__||1!==e.length){const n=t.output=[];for(let t=0,i=e.length;t<i;t++)n.push(e[t].content)}else t.output=e[0].content}(t),tC(t,!0),e()}))}const zC=new L_("loadOneAsset",[function(t,e){const n=t.output=t.input,{options:i,isNative:s,uuid:o,file:r}=n,{reloadAsset:a}=i;r||!a&&!s&&B_.has(o)?e():RC.load(n,t.options,((t,i)=>{n.file=i,e(t)}))},function(t,e){const n=t.output=t.input,i=t.progress,s=t.options.__exclude__,{id:o,file:r,options:a}=n;if(n.isNative)BC.parse(o,r,n.ext,a,((s,r)=>{s?e(s):(n.content=r,i.canInvoke&&t.dispatch("progress",++i.finish,i.total,n),F_.remove(o),z_.remove(o),e())}));else{const{uuid:c}=n;if(c in s){const{finish:o,content:r,err:a,callbacks:l}=s[c];i.canInvoke&&t.dispatch("progress",++i.finish,i.total,n),o||cC(c,c,s)?(r&&r.addRef(),n.content=r,e(a)):l.push({done:e,item:n})}else if(!a.reloadAsset&&B_.has(c)){const s=B_.get(c);n.content=s.addRef(),i.canInvoke&&t.dispatch("progress",++i.finish,i.total,n),e()}else a.__uuid__=c,BC.parse(o,r,"import",a,((n,i)=>{n?e(n):function(t,e,n){const{input:i,progress:s}=t,{uuid:o,id:r,options:a,config:c}=i,{cacheAsset:l}=a,h=[];e.addRef&&e.addRef(),iC(o,e,Object.create(null),h,c),s.canInvoke&&t.dispatch("progress",++s.finish,s.total+=h.length,i);const _=t.options.__exclude__[o]={content:e,finish:!1,callbacks:[{done:n,item:i}]},u=q_.create({input:h,options:t.options,onProgress:t.onProgress,onError:q_.prototype.recycle,progress:s,onComplete:t=>{if(e.decRef&&e.decRef(!1),_.finish=!0,_.err=t,!t){const t=Array.isArray(u.output)?u.output:[u.output],n=Object.create(null);for(const e of t)e&&(n[e instanceof lu?`${e._uuid}@import`:`${o}@native`]=e);!function(t,e,n){let i=!1;const s=e.__depends__;if(s){for(let t=0,e=s.length;t<e;t++){const e=s[t],o=n[`${e.uuid}@import`];if(o)e.owner[e.prop]=o.addRef();else{if(p(`The asset ${e.uuid} is missing!`),e.type&&e.type!==lu){const t=new e.type;t.initDefault(e.uuid),e.owner[e.prop]=t}i=!0}}e.__depends__=null}e.__nativeDepend__&&(n[`${t}@native`]?e._nativeAsset=n[`${t}@native`]:(i=!0,console.error(`the native asset of ${t} is missing!`)),e.__nativeDepend__=!1)}(o,e,n);try{"function"!=typeof e.onLoaded||e.__onLoadedInvoked__||e.__nativeDepend__||(e.onLoaded(),e.__onLoadedInvoked__=!0)}catch(t){p(`The asset ${o} is invalid for some reason, detail message: ${t.message}, stack: ${t.stack}`)}F_.remove(r),z_.remove(r),sC(o,e,l),u.recycle()}const n=_.callbacks;for(let i=0,s=n.length;i<s;i++){const s=n[i];e.addRef&&e.addRef(),s.item.content=e,s.done(t)}n.length=0}});H_.async(u)}(t,i,e)}))}}]);function UC(t,e){const n=t.options,i=Object.create(null),s=Object.create(null);for(const t in n)switch(t){case j_.PATH:case j_.UUID:case j_.DIR:case j_.SCENE:case j_.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":i[t]=n[t];break;case"__exclude__":case"__outputAsArray__":s[t]=n[t];break;default:i[t]=n[t],s[t]=n[t]}t.options=s;const o=q_.create({input:t.input,options:i});let r=null;try{t.output=t.source=V_.sync(o)}catch(t){r=t;for(let t=0,e=o.output.length;t<e;t++)o.output[t].recycle()}o.recycle(),e(r)}class HC{constructor(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}get id(){return this._id||(this._id=`${this.uuid}@${this.isNative?"native":"import"}`),this._id}static create(){let t;return t=0!==HC._deadPool.length?HC._deadPool.pop():new HC,t}recycle(){HC._deadPool.length!==HC.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),HC._deadPool.push(this))}}HC.MAX_DEAD_NUM=500,HC._deadPool=[];const GC=[];function VC(t){const e=t.options,n=Array.isArray(t.input)?t.input:[t.input];t.output=[];for(let i=0;i<n.length;i++){let s=n[i],o=HC.create(),r=null,a=null;if("string"==typeof s&&(s=Object.create(null),s[e.__requestType__||j_.UUID]=n[i]),"object"==typeof s){lt(s,e),s.preset&&lt(s,W_[s.preset]);for(const t in s){switch(t){case j_.UUID:{const t=o.uuid=Z_(s.uuid);if(!s.bundle){const e=U_.find((e=>!!e.getAssetInfo(t)));s.bundle=e&&e.name}if(U_.has(s.bundle)){if(r=U_.get(s.bundle).config,a=r.getAssetInfo(t),a&&a.redirect){if(!U_.has(a.redirect))throw new Error(`Please load bundle ${a.redirect} first`);r=U_.get(a.redirect).config,a=r.getAssetInfo(t)}o.config=r,o.info=a}o.ext=s.ext||".json";break}case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case j_.DIR:if(U_.has(s.bundle)){U_.get(s.bundle).config.getDirWithPath(s.dir,s.type,GC);for(const t of GC)n.push({uuid:t.uuid,__isNative__:!1,ext:".json",bundle:s.bundle});GC.length=0}o.recycle(),o=null;break;case j_.PATH:if(U_.has(s.bundle)){if(r=U_.get(s.bundle).config,a=r.getInfoWithPath(s.path,s.type),a&&a.redirect){if(!U_.has(a.redirect))throw new Error(`you need to load bundle ${a.redirect} first`);r=U_.get(a.redirect).config,a=r.getAssetInfo(a.uuid)}if(!a)throw o.recycle(),new Error(`Bundle ${s.bundle} doesn't contain ${s.path}`);o.config=r,o.uuid=a.uuid,o.info=a}o.ext=s.ext||".json";break;case j_.SCENE:if(!s.bundle){const t=U_.find((t=>!!t.getSceneInfo(s.scene)));s.bundle=t&&t.name}if(U_.has(s.bundle)){if(r=U_.get(s.bundle).config,a=r.getSceneInfo(s.scene),a&&a.redirect){if(!U_.has(a.redirect))throw new Error(`you need to load bundle ${a.redirect} first`);r=U_.get(a.redirect).config,a=r.getAssetInfo(a.uuid)}if(!a)throw o.recycle(),new Error(`Bundle ${r.name} doesn't contain scene ${s.scene}`);o.config=r,o.uuid=a.uuid,o.info=a}break;case"__isNative__":o.isNative=s.__isNative__;break;case j_.URL:o.url=s.url,o.uuid=s.uuid||s.url,o.ext=s.ext||si(s.url),o.isNative=void 0===s.__isNative__||s.__isNative__;break;default:o.options[t]=s[t]}if(!o)break}}if(o&&(t.output.push(o),!o.uuid&&!o.url))throw new Error(`Can not parse this input:${JSON.stringify(s)}`)}return null}function jC(t){const e=t.output=t.input;for(let t=0;t<e.length;t++){const n=e[t];if(n.url)continue;let s="",o="";const r=n.config;o=n.isNative?r&&r.nativeBase?r.base+r.nativeBase:i.assetManager.generalNativeBase:r&&r.importBase?r.base+r.importBase:i.assetManager.generalImportBase;const a=n.uuid;let c="";n.info&&(c=n.isNative?n.info.nativeVer?`.${n.info.nativeVer}`:"":n.info.ver?`.${n.info.ver}`:""),s=".ttf"===n.ext?`${o}/${a.slice(0,2)}/${a}${c}/${n.options.__nativeName__}`:`${o}/${a.slice(0,2)}/${a}${c}${n.ext}`,n.url=s}return null}class WC{constructor(){this.pipeline=H_.append(UC).append(FC),this.fetchPipeline=G_.append(UC).append(OC),this.transformPipeline=V_.append(VC).append(jC),this.bundles=U_,this.assets=B_,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=Od,this.force=!1,this.allowImageBitmap=!Rp.isMobile,this.utils=au,this.downloader=EC,this.parser=BC,this.packManager=RC,this.cacheAsset=!0,this.cacheManager=null,this.presets=W_,this.factory=IC,this.preprocessPipe=UC,this.fetchPipe=OC,this.loadPipe=FC,this.references=null,this._releaseManager=QA,this._files=F_,this._parsed=z_,this._parsePipeline=null}get main(){return U_.get(k_.MAIN)||null}get resources(){return U_.get(k_.RESOURCES)||null}init(t={}){this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(t.server,t.bundleVers,t.remoteBundles),this.parser.init(),this.dependUtil.init();let e=t.importBase||"";e&&e.endsWith("/")&&(e=e.substr(0,e.length-1));let n=t.nativeBase||"";n&&n.endsWith("/")&&(n=n.substr(0,n.length-1)),this.generalImportBase=e,this.generalNativeBase=n}getBundle(t){return U_.get(t)||null}removeBundle(t){t._destroy(),U_.remove(t.name)}loadAny(t,e,n,i){const{options:s,onProgress:o,onComplete:r}=rC(e,n,i);s.preset=s.preset||"default",t=Array.isArray(t)?t.slice():t;const a=q_.create({input:t,onProgress:o,onComplete:lC(r),options:s});H_.async(a)}preloadAny(t,e,n,i){const{options:s,onProgress:o,onComplete:r}=rC(e,n,i);s.preset=s.preset||"preload",t=Array.isArray(t)?t.slice():t;const a=q_.create({input:t,onProgress:o,onComplete:lC(r),options:s});G_.async(a)}postLoadNative(t,e,n){const{options:i,onComplete:s}=rC(e,void 0,n);if(!t._native||!t.__nativeDepend__)return void lC(s)(null);const o=Od.getNativeDep(t._uuid);if(o){if(!U_.has(o.bundle)){const e=U_.find((e=>!!e.getAssetInfo(t._uuid)));e&&(o.bundle=e.name)}this.loadAny(o,i,((e,n)=>{e?p(e.message,e.stack):t.isValid&&t.__nativeDepend__&&(t._nativeAsset=n,t.__nativeDepend__=!1),s&&s(e)}))}}loadRemote(t,e,n){const{options:i,onComplete:s}=rC(e,void 0,n);i.reloadAsset||!this.assets.has(t)?(i.__isNative__=!0,i.preset=i.preset||"remote",this.loadAny({url:t},i,null,((e,n)=>{e?(p(e.message,e.stack),s&&s(e,n)):IC.create(t,n,i.ext||si(t),i,((t,e)=>{s&&s(t,e)}))}))):lC(s)(null,this.assets.get(t))}loadBundle(t,e,n){const{options:i,onComplete:s}=rC(e,void 0,n),o=ri(t);this.bundles.has(o)?lC(s)(null,this.getBundle(o)):(i.preset=i.preset||"bundle",i.ext="bundle",i.__isNative__=!0,this.loadAny({url:t},i,null,((e,n)=>{e?(p(e.message,e.stack),s&&s(e,n)):IC.create(t,n,"bundle",i,((t,e)=>{s&&s(t,e)}))})))}releaseAsset(t){QA.tryRelease(t,!0)}releaseUnusedAssets(){B_.forEach((t=>{QA.tryRelease(t)}))}releaseAll(){B_.forEach((t=>{QA.tryRelease(t,!0)}))}loadWithJson(t,e,n,i){throw new Error("Only valid in Editor")}}t("AssetManager",WC),WC.Pipeline=L_,WC.Task=q_,WC.Cache=N_,WC.RequestItem=HC,WC.Bundle=hC,WC.BuiltinBundleName=k_;var kC,qC,XC,YC,KC,$C,ZC,JC,QC,tb,eb,nb,ib,sb=t("assetManager",i.assetManager=new WC);i.AssetManager=WC;let ob=t("EventHandler",(kC=i_("cc.ClickEvent"),qC=O_(i.Node),XC=y_(),YC=y_(),KC=y_(),$C=y_(),kC((QC=Yh((JC=class t{constructor(){Xh(this,"target",QC,this),Xh(this,"component",tb,this),Xh(this,"_componentId",eb,this),Xh(this,"handler",nb,this),Xh(this,"customEventData",ib,this)}get _componentName(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)}set _componentName(t){this._componentId=this._compName2Id(t)}static emitEvents(e,...n){for(let i=0,s=e.length;i<s;i++){const s=e[i];s instanceof t&&s.emit(n)}}emit(t){const e=this.target;if(!i.isValid(e))return;this._genCompIdIfNeeded();const n=i.js._getClassById(this._componentId),s=e.getComponent(n);if(!i.isValid(s))return;const o=s[this.handler];"function"==typeof o&&(null!=this.customEventData&&""!==this.customEventData&&(t=t.slice()).push(this.customEventData),o.apply(s,t))}_compName2Id(t){const e=i.js.getClassByName(t);return i.js._getClassId(e)}_compId2Name(t){const e=i.js._getClassById(t);return i.js.getClassName(e)}_genCompIdIfNeeded(){this._componentId||(this._componentName=this.component,this.component="")}}).prototype,"target",[c_,qC,XC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tb=Yh(JC.prototype,"component",[c_,m_,YC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),eb=Yh(JC.prototype,"_componentId",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),nb=Yh(JC.prototype,"handler",[c_,m_,KC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ib=Yh(JC.prototype,"customEventData",[c_,m_,$C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ZC=JC))||ZC));var rb,ab,cb,lb,hb,_b,ub,db,pb,fb,mb,gb,vb,yb,xb,Sb,Tb,Eb,Ab,Cb,bb,Pb,wb,Db,Ib,Rb,Ob,Mb,Nb,Lb,Bb,Fb,zb,Ub,Hb,Gb,Vb,jb,Wb,kb,qb,Xb,Yb,Kb,$b,Zb,Jb,Qb,tP,eP,nP,iP,sP,oP,rP,aP,cP,lP,hP,_P,uP,dP,pP,fP,mP,gP,vP;i.Component.EventHandler=ob;const yP=new $e,xP=It(bh),SP=It(Ch),TP=It(Ph),EP=It(Dh),AP=It(wh),CP=It({SKYBOX:Bh|_r.DEPTH_STENCIL,SOLID_COLOR:_r.ALL,DEPTH_ONLY:_r.DEPTH_STENCIL,DONT_CLEAR:_r.NONE});let bP=t("Camera",(rb=i_("cc.Camera"),ab=f_(),cb=__(),lb=C_(),hb=y_(),_b=O_(dl.BitMask),ub=C_(),db=y_(),pb=O_(CP),fb=C_(),mb=y_(),gb=C_(),vb=y_(),yb=C_(),xb=y_(),Sb=C_(),Tb=y_(),Eb=O_(xP),Ab=C_(),Cb=y_(),bb=O_(SP),Pb=C_(),wb=y_(),Db=C_(),Ib=y_(),Rb=C_(),Ob=y_(),Mb=C_(),Nb=y_(),Lb=C_(),Bb=y_(),Fb=O_(TP),zb=C_(),Ub=y_(),Hb=O_(EP),Gb=C_(),Vb=y_(),jb=O_(AP),Wb=C_(),kb=y_(),qb=C_(),Xb=y_(),Yb=O_(Lf),Kb=C_(),$b=y_(),rb(Zb=ab(Zb=cb(Zb=h_((vP=gP=class extends Ad{constructor(...t){super(...t),Xh(this,"_projection",Qb,this),Xh(this,"_priority",tP,this),Xh(this,"_fov",eP,this),Xh(this,"_fovAxis",nP,this),Xh(this,"_orthoHeight",iP,this),Xh(this,"_near",sP,this),Xh(this,"_far",oP,this),Xh(this,"_color",rP,this),Xh(this,"_depth",aP,this),Xh(this,"_stencil",cP,this),Xh(this,"_clearFlags",lP,this),Xh(this,"_rect",hP,this),Xh(this,"_aperture",_P,this),Xh(this,"_shutter",uP,this),Xh(this,"_iso",dP,this),Xh(this,"_screenScale",pP,this),Xh(this,"_visibility",fP,this),Xh(this,"_targetTexture",mP,this),this._camera=null,this._inEditorMode=!1,this._flows=void 0}get camera(){return this._camera}get priority(){return this._priority}set priority(t){this._priority=t,this._camera&&(this._camera.priority=t)}get visibility(){return this._visibility}set visibility(t){this._visibility=t,this._camera&&(this._camera.visibility=t)}get clearFlags(){return this._clearFlags}set clearFlags(t){this._clearFlags=t,this._camera&&(this._camera.clearFlag=t)}get clearColor(){return this._color}set clearColor(t){this._color.set(t),this._camera&&(this._camera.clearColor=this._color)}get clearDepth(){return this._depth}set clearDepth(t){this._depth=t,this._camera&&(this._camera.clearDepth=t)}get clearStencil(){return this._stencil}set clearStencil(t){this._stencil=t,this._camera&&(this._camera.clearStencil=t)}get projection(){return this._projection}set projection(t){this._projection=t,this._camera&&(this._camera.projectionType=t)}get fovAxis(){return this._fovAxis}set fovAxis(t){t!==this._fovAxis&&(this._fovAxis=t,this._camera&&(this._camera.fovAxis=t,t===Ch.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}get fov(){return this._fov}set fov(t){this._fov=t,this._camera&&(this._camera.fov=Oe(t))}get orthoHeight(){return this._orthoHeight}set orthoHeight(t){this._orthoHeight=t,this._camera&&(this._camera.orthoHeight=t)}get near(){return this._near}set near(t){this._near=t,this._camera&&(this._camera.nearClip=t)}get far(){return this._far}set far(t){this._far=t,this._camera&&(this._camera.farClip=t)}get aperture(){return this._aperture}set aperture(t){this._aperture=t,this._camera&&(this._camera.aperture=t)}get shutter(){return this._shutter}set shutter(t){this._shutter=t,this._camera&&(this._camera.shutter=t)}get iso(){return this._iso}set iso(t){this._iso=t,this._camera&&(this._camera.iso=t)}get rect(){return this._rect}set rect(t){this._rect=t,this._camera&&(this._camera.viewport=t)}get targetTexture(){return this._targetTexture}set targetTexture(t){if(this._targetTexture===t)return;const e=this._targetTexture;this._targetTexture=t,this._chechTargetTextureEvent(e),this._updateTargetTexture(),!t&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0)}get screenScale(){return this._screenScale}set screenScale(t){this._screenScale=t,this._camera&&(this._camera.screenScale=t)}get inEditorMode(){return this._inEditorMode}set inEditorMode(t){this._inEditorMode=t,this._camera&&this._camera.changeTargetWindow(t?i.director.root&&i.director.root.mainWindow:i.director.root&&i.director.root.tempWindow)}onLoad(){this._createCamera()}onEnable(){this.node.hasChangedFlags|=Hh.POSITION,this._camera&&this._attachToScene()}onDisable(){this._camera&&this._detachFromScene()}onDestroy(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")}screenPointToRay(t,e,n){return n||(n=vo.create()),this._camera&&this._camera.screenPointToRay(n,t,e),n}worldToScreen(t,e){return e||(e=new $e),this._camera&&this._camera.worldToScreen(e,t),e}screenToWorld(t,e){return e||(e=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(e,t),e}convertToUINode(t,e,n){if(n||(n=new $e),!this._camera)return n;this.worldToScreen(t,yP);const s=e.getComponent("cc.UITransform"),o=Pm.getVisibleSize(),r=yP.x-.5*this._camera.width,a=yP.y-.5*this._camera.height;return yP.x=r/i.view.getScaleX()+.5*o.width,yP.y=a/i.view.getScaleY()+.5*o.height,s&&s.convertToNodeSpaceAR(yP,n),n}_createCamera(){this._camera||(this._camera=i.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?i.director.root&&i.director.root.mainWindow:i.director.root&&i.director.root.tempWindow,priority:this._priority}),this._camera.viewport=this._rect,this._camera.fovAxis=this._fovAxis,this._camera.fov=Oe(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()}_attachToScene(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))}_detachFromScene(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)}_chechTargetTextureEvent(t){t&&t.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(t=>{this._camera&&this._camera.setFixedSize(t.width,t.height)}),this)}_updateTargetTexture(){if(this._camera&&this._targetTexture){const t=this._targetTexture.window;this._camera.changeTargetWindow(t),this._camera.setFixedSize(t.width,t.height)}}},gP.ProjectionType=xP,gP.FOVAxis=SP,gP.ClearFlag=CP,gP.Aperture=TP,gP.Shutter=EP,gP.ISO=AP,Qb=Yh((Jb=vP).prototype,"_projection",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xP.PERSPECTIVE}}),tP=Yh(Jb.prototype,"_priority",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),eP=Yh(Jb.prototype,"_fov",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),nP=Yh(Jb.prototype,"_fovAxis",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return SP.VERTICAL}}),iP=Yh(Jb.prototype,"_orthoHeight",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),sP=Yh(Jb.prototype,"_near",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),oP=Yh(Jb.prototype,"_far",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),rP=Yh(Jb.prototype,"_color",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new An("#333333")}}),aP=Yh(Jb.prototype,"_depth",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),cP=Yh(Jb.prototype,"_stencil",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lP=Yh(Jb.prototype,"_clearFlags",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CP.SOLID_COLOR}}),hP=Yh(Jb.prototype,"_rect",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Sn(0,0,1,1)}}),_P=Yh(Jb.prototype,"_aperture",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TP.F16_0}}),uP=Yh(Jb.prototype,"_shutter",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return EP.D125}}),dP=Yh(Jb.prototype,"_iso",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AP.ISO100}}),pP=Yh(Jb.prototype,"_screenScale",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),fP=Yh(Jb.prototype,"_visibility",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ah}}),mP=Yh(Jb.prototype,"_targetTexture",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Yh(Jb.prototype,"priority",[lb,hb],Object.getOwnPropertyDescriptor(Jb.prototype,"priority"),Jb.prototype),Yh(Jb.prototype,"visibility",[_b,ub,db],Object.getOwnPropertyDescriptor(Jb.prototype,"visibility"),Jb.prototype),Yh(Jb.prototype,"clearFlags",[pb,fb,mb],Object.getOwnPropertyDescriptor(Jb.prototype,"clearFlags"),Jb.prototype),Yh(Jb.prototype,"clearColor",[gb,vb],Object.getOwnPropertyDescriptor(Jb.prototype,"clearColor"),Jb.prototype),Yh(Jb.prototype,"clearDepth",[yb,xb],Object.getOwnPropertyDescriptor(Jb.prototype,"clearDepth"),Jb.prototype),Yh(Jb.prototype,"clearStencil",[Sb,Tb],Object.getOwnPropertyDescriptor(Jb.prototype,"clearStencil"),Jb.prototype),Yh(Jb.prototype,"projection",[Eb,Ab,Cb],Object.getOwnPropertyDescriptor(Jb.prototype,"projection"),Jb.prototype),Yh(Jb.prototype,"fovAxis",[bb,Pb,wb],Object.getOwnPropertyDescriptor(Jb.prototype,"fovAxis"),Jb.prototype),Yh(Jb.prototype,"fov",[Db,Ib],Object.getOwnPropertyDescriptor(Jb.prototype,"fov"),Jb.prototype),Yh(Jb.prototype,"orthoHeight",[Rb,Ob],Object.getOwnPropertyDescriptor(Jb.prototype,"orthoHeight"),Jb.prototype),Yh(Jb.prototype,"near",[Mb,Nb],Object.getOwnPropertyDescriptor(Jb.prototype,"near"),Jb.prototype),Yh(Jb.prototype,"far",[Lb,Bb],Object.getOwnPropertyDescriptor(Jb.prototype,"far"),Jb.prototype),Yh(Jb.prototype,"aperture",[Fb,zb,Ub],Object.getOwnPropertyDescriptor(Jb.prototype,"aperture"),Jb.prototype),Yh(Jb.prototype,"shutter",[Hb,Gb,Vb],Object.getOwnPropertyDescriptor(Jb.prototype,"shutter"),Jb.prototype),Yh(Jb.prototype,"iso",[jb,Wb,kb],Object.getOwnPropertyDescriptor(Jb.prototype,"iso"),Jb.prototype),Yh(Jb.prototype,"rect",[qb,Xb],Object.getOwnPropertyDescriptor(Jb.prototype,"rect"),Jb.prototype),Yh(Jb.prototype,"targetTexture",[Yb,Kb,$b],Object.getOwnPropertyDescriptor(Jb.prototype,"targetTexture"),Jb.prototype),Zb=Jb))||Zb)||Zb)||Zb)||Zb));var PP,wP,DP,IP,RP,OP,MP,NP,LP;i.Camera=bP;const BP={parent:null,owner:null,subModelIdx:0};let FP=t("RenderableComponent",(PP=i_("cc.RenderableComponent"),wP=O_([kf]),DP=O_(kf),IP=C_(),RP=v_(),PP((NP=Yh((MP=class extends Ad{constructor(...t){super(...t),Xh(this,"_materials",NP,this),Xh(this,"_visFlags",LP,this),this._materialInstances=[],this._models=[]}get visibility(){return this._visFlags}set visibility(t){this._visFlags=t,this._onVisibilityChange(t)}get sharedMaterials(){return this._materials}set sharedMaterials(t){for(let e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(let e=t.length;e<this._materials.length;e++)this.setMaterial(null,e);this._materials.splice(t.length)}}get materials(){for(let t=0;t<this._materials.length;t++)this._materialInstances[t]=this.getMaterialInstance(t);return this._materialInstances}set materials(t){const e=t.length-this._materials.length;if(e>0)this._materials.length=t.length,this._materialInstances.length=t.length;else if(e<0)for(let t=this._materials.length-e;t<this._materials.length;++t)this.setMaterialInstance(t,null);for(let e=0;e<this._materialInstances.length;e++)this._materialInstances[e]!=t[e]&&this.setMaterialInstance(e,t[e])}get sharedMaterial(){return this.getMaterial(0)}getMaterial(t){return t<0||t>=this._materials.length?null:this._materials[t]}setMaterial(t,e){t&&t instanceof Xf&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[e]=t;const n=this._materialInstances[e];n?n.parent!==this._materials[e]&&(n.destroy(),this._materialInstances[e]=null,this._onMaterialModified(e,this._materials[e])):this._onMaterialModified(e,this._materials[e])}get material(){return this.getMaterialInstance(0)}set material(t){1===this._materials.length&&this._materials[0]===t||this.setMaterialInstance(0,t)}getMaterialInstance(t){if(!this._materials[t])return null;if(!this._materialInstances[t]){BP.parent=this._materials[t],BP.owner=this,BP.subModelIdx=t;const e=new Xf(BP);this.setMaterialInstance(t,e)}return this._materialInstances[t]}setMaterialInstance(t,e){e&&e.parent?e!==this._materialInstances[t]&&(this._materialInstances[t]=e,this._onMaterialModified(t,e)):e!==this._materials[t]&&this.setMaterial(e,t)}getRenderMaterial(t){return this._materialInstances[t]||this._materials[t]}_collectModels(){return this._models}_attachToScene(){}_detachFromScene(){}_onMaterialModified(t,e){}_onRebuildPSO(t,e){}_clearMaterials(){}_onVisibilityChange(t){}}).prototype,"_materials",[wP],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),LP=Yh(MP.prototype,"_visFlags",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dl.Enum.NONE}}),Yh(MP.prototype,"sharedMaterials",[DP,IP,RP],Object.getOwnPropertyDescriptor(MP.prototype,"sharedMaterials"),MP.prototype),OP=MP))||OP));var zP,UP,HP,GP,VP,jP;function WP(t){return"string"==typeof t||"number"==typeof t}function kP(t,e){return t instanceof e}i.RenderableComponent=FP;let qP=i_("cc.animation.HierarchyPath")((HP=Yh((UP=class{constructor(t){Xh(this,"path",HP,this),this.path=t||""}get(t){if(!(t instanceof ey))return d("Target of hierarchy path should be of type Node."),null;return t.getChildByPath(this.path)||(d(`Node "${t.name}" has no path "${this.path}"`),null)}}).prototype,"path",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),zP=UP))||zP,XP=i_("cc.animation.ComponentPath")((jP=Yh((VP=class{constructor(t){Xh(this,"component",jP,this),this.component=t||""}get(t){if(!(t instanceof ey))return d("Target of component path should be of type Node."),null;return t.getComponent(this.component)||(d(`Node "${t.name}" has no component "${this.component}"`),null)}}).prototype,"component",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),GP=VP))||GP;function YP(t,...e){let n=t;for(let t=0;t<e.length;++t){const i=e[t];if(WP(i)){if(!(i in n))return d(`Target object has no property "${i}"`),null;n=n[i]}else n=i.get(n);if(null===n)break}return n}var KP,$P,ZP,JP,QP;let tw=i_("cc.animation.UniformProxyFactory")((ZP=Yh(($P=class{constructor(t,e){Xh(this,"passIndex",ZP,this),Xh(this,"uniformName",JP,this),Xh(this,"channelIndex",QP,this),this.passIndex=e||0,this.uniformName=t||""}forTarget(t){const e=t.passes[this.passIndex],n=e.getHandle(this.uniformName);if(!n)throw new Error(`Material "${t.name}" has no uniform "${this.uniformName}"`);const s=wp.getPropertyTypeFromHandle(n);if(s===ep.BUFFER){const i=void 0===this.channelIndex?n:e.getHandle(this.uniformName,this.channelIndex,No.FLOAT);if(!i)throw new Error(`Uniform "${this.uniformName} (in material ${t.name}) has no channel ${this.channelIndex}"`);return function(t,e){for(const n of t.shaderInfo.blocks)for(const t of n.members)if(t.name===e)return t.count>1;return!1}(e,this.uniformName)?{set:t=>{e.setUniformArray(i,t)}}:{set:t=>{e.setUniform(i,t)}}}if(s===ep.TEXTURE){const t=wp.getBindingFromHandle(n),s=e.properties[this.uniformName],o=s&&s.value?`${s.value}-texture`:_p(s.type);let r=Tp.get(o);return r||(d(`Illegal texture default value: ${o}.`),r=Tp.get("default-texture")),{set:n=>{n||(n=r);const s=n.getGFXTexture();s&&s.width&&s.height&&(e.bindTexture(t,s),n instanceof Hu&&e.bindSampler(t,bu.getSampler(i.game._gfxDevice,n.getSamplerHash())))}}}throw new Error(`Animations are not available for uniforms with property type ${s}.`)}}).prototype,"passIndex",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),JP=Yh($P.prototype,"uniformName",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),QP=Yh($P.prototype,"channelIndex",[D_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),KP=$P))||KP;var ew,nw,iw,sw;let ow=i_("cc.animation.MorphWeightsValueProxy")((iw=Yh((nw=class{constructor(){Xh(this,"subMeshIndex",iw,this)}forTarget(t){return{set:e=>{t.setWeights(e,this.subMeshIndex)}}}}).prototype,"subMeshIndex",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ew=nw))||ew,rw=i_("cc.animation.MorphWeightsAllValueProxy")(sw=class{forTarget(t){return{set:e=>{var n,i;const s=null!==(n=null===(i=t.mesh)||void 0===i?void 0:i.struct.primitives.length)&&void 0!==n?n:0;for(let n=0;n<s;++n)t.setWeights(e,n)}}}})||sw;var aw,cw,lw,hw,_w;function uw(t,e,n,i){var s,o,r,a,c;let l=new e,h=new e,_=new e,u=i_(t)((r=Yh((o=class{constructor(t,n,i){Xh(this,"dataPoint",r,this),Xh(this,"inTangent",a,this),Xh(this,"outTangent",c,this),this.dataPoint=t||new e,this.inTangent=n||new e,this.outTangent=i||new e}lerp(t,e,s){const o=this.dataPoint,r=t.dataPoint;h=n(h,this.inTangent,s),_=n(_,t.outTangent,s);const a=e*e*e,c=e*e,u=a-2*c+e,d=-2*a+3*c,p=a-c;return l=n(l,o,2*a-3*c+1),l=i(l,l,h,u),l=i(l,l,r,d),l=i(l,l,_,p),l}getNoLerp(){return this.dataPoint}}).prototype,"dataPoint",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),a=Yh(o.prototype,"inTangent",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),c=Yh(o.prototype,"outTangent",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),s=o))||s;if(e===rn){const t=u.prototype.lerp;u.prototype.lerp=function(e,n,i){const s=t.call(this,e,n,i);return rn.normalize(s,s),s}}return u}const dw=t("CubicSplineVec2Value",uw("cc.CubicSplineVec2Value",qe,qe.multiplyScalar,qe.scaleAndAdd));i.CubicSplineVec2Value=dw;const pw=t("CubicSplineVec3Value",uw("cc.CubicSplineVec3Value",$e,$e.multiplyScalar,$e.scaleAndAdd));i.CubicSplineVec3Value=pw;const fw=t("CubicSplineVec4Value",uw("cc.CubicSplineVec4Value",tn,tn.multiplyScalar,tn.scaleAndAdd));i.CubicSplineVec4Value=fw;const mw=t("CubicSplineQuatValue",uw("cc.CubicSplineQuatValue",rn,rn.multiplyScalar,rn.scaleAndAdd));i.CubicSplineQuatValue=mw;let gw=t("CubicSplineNumberValue",i_("cc.CubicSplineNumberValue")((lw=Yh((cw=class{constructor(t,e,n){Xh(this,"dataPoint",lw,this),Xh(this,"inTangent",hw,this),Xh(this,"outTangent",_w,this),this.dataPoint=t,this.inTangent=e,this.outTangent=n}lerp(t,e,n){const i=this.dataPoint,s=t.dataPoint,o=e*e*e,r=e*e;return i*(2*o-3*r+1)+this.outTangent*n*(o-2*r+e)+s*(-2*o+3*r)+t.inTangent*n*(o-r)}getNoLerp(){return this.dataPoint}}).prototype,"dataPoint",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hw=Yh(cw.prototype,"inTangent",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_w=Yh(cw.prototype,"outTangent",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aw=cw))||aw);function vw(t,e,n,i,s){const o=1-s;return o*(o*(t+(3*e-t)*s)+3*n*s*s)+i*s*s*s}i.CubicSplineNumberValue=gw,t("animation",Object.freeze({__proto__:null,UniformProxyFactory:tw,MorphWeightsValueProxy:ow,MorphWeightsAllValueProxy:rw,isPropertyPath:WP,isCustomPath:kP,HierarchyPath:qP,ComponentPath:XP,evaluatePath:YP,CubicSplineVec2Value:dw,CubicSplineVec3Value:pw,CubicSplineVec4Value:fw,CubicSplineQuatValue:mw,CubicSplineNumberValue:gw})),i.bezier=vw;const yw=Math.cos,xw=Math.acos,Sw=Math.max,Tw=2*Math.PI,Ew=Math.sqrt;function Aw(t){return t<0?-Math.pow(-t,1/3):Math.pow(t,1/3)}function Cw(t,e){const n=function(t,e){const n=e-0,i=e-t[0],s=3*n,o=3*i,r=3*(e-t[2]),a=1/(-n+o-r+(e-1)),c=1/3,l=(s-6*i+r)*a,h=l*c,_=(-s+o)*a,u=(3*_-l*l)*c,d=u*c,p=(2*l*l*l-9*l*_+n*a*27)/27,f=p/2,m=f*f+d*d*d;let g,v,y,x,S;if(m<0){const t=-u*c,e=Ew(t*t*t),n=-p/(2*e),i=xw(n<-1?-1:n>1?1:n),s=2*Aw(e);return y=s*yw(i*c)-h,x=s*yw((i+Tw)*c)-h,S=s*yw((i+2*Tw)*c)-h,y>=0&&y<=1?x>=0&&x<=1?S>=0&&S<=1?Sw(y,x,S):Sw(y,x):S>=0&&S<=1?Sw(y,S):y:x>=0&&x<=1?S>=0&&S<=1?Sw(x,S):x:S}if(0===m)return g=f<0?Aw(-f):-Aw(f),y=2*g-h,x=-g-h,y>=0&&y<=1?x>=0&&x<=1?Sw(y,x):y:x;{const t=Ew(m);return g=Aw(-f+t),v=Aw(f+t),y=g-v-h,y}}(t,e),i=t[1];return((1-n)*(i+(t[3]-i)*n)*3+n*n)*n}function bw(t,e,n=1e-6){let i=0,s=t.length-1,o=s>>>1;for(;i<=s;o=i+s>>>1){const r=t[o];if(r>e+n)s=o-1;else{if(!(r<e-n))return o;i=o+1}}return~i}i.bezierByTime=Cw;class Pw{constructor(t){let e,n;this.ratios=void 0,this._findRatio=void 0,this.ratios=t;let i=!0;for(let s=1,o=t.length;s<o;s++)if(e=t[s]-t[s-1],1===s)n=e;else if(Math.abs(e-n)>1e-6){i=!1;break}this._findRatio=i?Rw:bw}sample(t){return this._findRatio(this.ratios,t)}}t("RatioSampler",Pw),i.RatioSampler=Pw;class ww{static Bezier(t){return t}constructor(t,e){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=e,this._values=t.values;const n=t=>"string"==typeof t?t:Array.isArray(t)?t[0]===t[1]&&t[2]===t[3]?ww.Linear:ww.Bezier(t):ww.Linear;if(void 0!==t.easingMethod)this.type=n(t.easingMethod);else if(Array.isArray(t.easingMethods))this.types=t.easingMethods.map(n);else if(void 0!==t.easingMethods){this.types=new Array(this._values.length).fill(null);for(const e of Object.keys(t.easingMethods))this.types[e]=n(t.easingMethods[e])}else this.type=null;const i=t.values[0];(void 0===t.interpolate||t.interpolate)&&(this._lerp=Ow(i)),void 0!==t._arrayLength&&(this._array=new Array(t._arrayLength))}hasLerp(){return!!this._lerp}valueAt(t){if(void 0===this._array){const e=this._values[t];return e&&e.getNoLerp?e.getNoLerp():e}for(let e=0;e<this._array.length;++e)this._array[e]=this._values[this._array.length*t+e];return this._array}valueBetween(t,e,n,i,s){if(this._lerp){const o=this.types?this.types[e]:this.type,r=s-n;let a=(t-n)/r;if(o&&(a=Iw(a,o)),void 0===this._array){const t=this._values[e],n=this._values[i];return this._lerp(t,n,a,r*this._duration)}for(let t=0;t<this._array.length;++t){const n=this._values[this._array.length*e+t],s=this._values[this._array.length*i+t];this._array[t]=this._lerp(n,s,a,r*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(e);for(let t=0;t<this._array.length;++t)this._array[t]=this._values[this._array.length*e+t];return this._array}empty(){return 0===this._values.length}constant(){return 1===this._values.length}}function Dw(t,e,n){let i=e.sample(n);if(i<0)if(i=~i,i<=0)i=0;else{if(!(i>=e.ratios.length))return t.valueBetween(n,i-1,e.ratios[i-1],i,e.ratios[i]);i=e.ratios.length-1}return t.valueAt(i)}function Iw(t,e){if("string"==typeof e){const n=Fg[e];n?t=n(t):C(3906,e)}else Array.isArray(e)&&(t=Cw(e,t));return t}function Rw(t,e){const n=t.length-1;if(0===n)return 0;const i=t[0];if(e<i)return 0;const s=t[n];if(e>s)return n;const o=(e=(e-i)/(s-i))/(1/n),r=0|o,a=1e-6;return o-r<a?r:r+1-o<a?r+1:~(r+1)}t("AnimCurve",ww),ww.Linear=null,i.AnimCurve=ww,t("EventInfo",class{constructor(){this.events=[]}add(t,e){this.events.push({func:t||"",params:e||[]})}}),i.sampleAnimationCurve=Dw;const Ow=(()=>{function t(t,e,n,i){return t.lerp(e,n,i)}return e=>{if(null!==e){if("number"==typeof e)return Re;if("object"==typeof e&&e.constructor){if(e instanceof rn)return function(){const t=new rn;return(e,n,i)=>rn.slerp(t,e,n,i)}();if(e instanceof Nt)return function(t){const e=new t;return(n,i,s)=>(t.lerp(e,n,i,s),e)}(e.constructor);if(e.constructor===Number)return Re;if("function"==typeof e.lerp)return t}}}})();class Mw{static getOrExtract(t){let e=Mw.pool.get(t);return e&&e.info.sample===t.sample||(e&&i.director.root.dataPoolManager.releaseAnimationClip(t),e=function(t){const e={};t.curves.forEach((t=>{if(!t.valueAdapter&&kP(t.modifiers[0],qP)&&WP(t.modifiers[1])){const{path:n}=t.modifiers[0];let i=e[n];i||(i=e[n]={}),i[t.modifiers[1]]={values:t.data.values,keys:t.data.keys}}}));const n=Math.ceil(t.sample*t.duration)+1;for(const i of Object.keys(e)){const s=e[i];s&&Object.defineProperty(s,"worldMatrix",{get:()=>{if(!s._worldMatrix){const{position:o,rotation:r,scale:a}=s;Nw(t,o,n),Nw(t,r,n),Nw(t,a,n),Lw(e,i,s)}return s._worldMatrix}})}return{info:{frames:n,sample:t.sample},data:e}}(t),Mw.pool.set(t,e)),e}static destroy(t){Mw.pool.delete(t)}}function Nw(t,e,n){const i=t.keys[e.keys],s=[];if(i&&1!==i.length){const o=e.values[0]instanceof rn;for(let r=0,a=0;r<n;r++){let n=r/t.sample;for(;i[a]<=n;)a++;a>i.length-1?(a=i.length-1,n=i[a]):0===a&&(a=1);const c=e.values[a-1].clone(),l=i[a]-i[a-1],h=l?Ie((n-i[a-1])/l):1;o?c.slerp(e.values[a],h):c.lerp(e.values[a],h),s[r]=c}}else for(let t=0;t<n;t++)s[t]=e.values[0].clone();e.values=s}function Lw(t,e,n){const i=n.position.values,s=n.rotation.values,o=n.scale.values,r=i.map((()=>new pn)),a=e.lastIndexOf("/");let c=null;if(a>0){const n=t[e.substring(0,a)];if(!n)return void console.warn("no data for parent bone?");c=n.worldMatrix.values}for(let t=0;t<i.length;t++){const e=i[t],n=s[t],a=o[t],l=r[t];pn.fromRTS(l,n,e,a),c&&pn.multiply(l,c[t],l)}Object.keys(n).forEach((t=>delete n[t])),n._worldMatrix={keys:0,interpolate:!1,values:r}}var Bw,Fw,zw,Uw,Hw,Gw,Vw,jw,Ww,kw,qw,Xw,Yw,Kw,$w;Mw.pool=new Map;let Zw=t("AnimationClip",i_("cc.AnimationClip")(($w=Kw=class t extends lu{constructor(...t){super(...t),Xh(this,"sample",zw,this),Xh(this,"speed",Uw,this),Xh(this,"wrapMode",Hw,this),Xh(this,"events",Gw,this),Xh(this,"enableTrsBlending",Vw,this),Xh(this,"_duration",jw,this),Xh(this,"_keys",Ww,this),Xh(this,"_stepness",kw,this),Xh(this,"_curves",qw,this),Xh(this,"_commonTargets",Xw,this),Xh(this,"_hash",Yw,this),this.frameRate=0,this._ratioSamplers=[],this._runtimeCurves=void 0,this._runtimeEvents=void 0,this._data=null}static createWithSpriteFrames(e,n){if(!Array.isArray(e))return C(3905),null;const i=new t;i.sample=n||i.sample,i.duration=e.length/i.sample;const s=1/i.sample,o=new Array(e.length),r=new Array(o.length);for(let t=0;t<e.length;t++)o[t]=t*s,r[t]=e[t];return i.keys=[o],i.curves=[{modifiers:[new XP("cc.Sprite"),"spriteFrame"],data:{keys:0,values:r}}],i}get duration(){return this._duration}set duration(t){this._duration=t}get keys(){return this._keys}set keys(t){this._keys=t}get eventGroups(){return this._runtimeEvents||this._createRuntimeEvents(),this._runtimeEvents.eventGroups}get stepness(){return this._stepness}set stepness(t){this._stepness=t,this._applyStepness()}get hash(){if(this._hash)return this._hash;const t=this._nativeAsset,e=new Uint8Array(ArrayBuffer.isView(t)?t.buffer:t);return this._hash=Na(e,666)}get curves(){return this._curves}set curves(t){this._curves=t,delete this._runtimeCurves}get data(){return this._data}get commonTargets(){return this._commonTargets}set commonTargets(t){this._commonTargets=t}onLoaded(){this.frameRate=this.sample,this._decodeCVTAs()}getPropertyCurves(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves}updateEventDatas(){delete this._runtimeEvents}getEventGroupIndexAtRatio(t){return this._runtimeEvents||this._createRuntimeEvents(),bw(this._runtimeEvents.ratios,t)}hasEvents(){return 0!==this.events.length}destroy(){return i.director.root.dataPoolManager&&i.director.root.dataPoolManager.releaseAnimationClip(this),Mw.destroy(this),super.destroy()}_createPropertyCurves(){this._ratioSamplers=this._keys.map((t=>new Pw(t.map((t=>t/this._duration))))),this._runtimeCurves=this._curves.map((t=>({curve:new ww(t.data,this._duration),modifiers:t.modifiers,valueAdapter:t.valueAdapter,sampler:this._ratioSamplers[t.data.keys],commonTarget:t.commonTarget}))),this._applyStepness()}_createRuntimeEvents(){const t=[],e=[],n=this.events.sort(((t,e)=>t.frame-e.frame));for(const i of n){const n=i.frame/this._duration;let s=t.findIndex((t=>t===n));s<0&&(s=t.length,t.push(n),e.push({events:[]})),e[s].events.push({functionName:i.func,parameters:i.params})}this._runtimeEvents={ratios:t,eventGroups:e}}_applyStepness(){}_decodeCVTAs(){const t=ArrayBuffer.isView(this._nativeAsset)?this._nativeAsset.buffer:this._nativeAsset;if(!t)return;const e=this._keys;for(let n=0;n<e.length;++n){const i=e[n];i instanceof oS&&(e[n]=i.decompress(t))}for(let e=0;e<this._curves.length;++e){const n=this._curves[e];n.data.values instanceof oS&&(n.data.values=n.data.values.decompress(t))}}validate(){return this.keys.length>0&&this.curves.length>0}},Kw.WrapMode=ol,zw=Yh((Fw=$w).prototype,"sample",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),Uw=Yh(Fw.prototype,"speed",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Hw=Yh(Fw.prototype,"wrapMode",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ol.Normal}}),Gw=Yh(Fw.prototype,"events",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vw=Yh(Fw.prototype,"enableTrsBlending",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jw=Yh(Fw.prototype,"_duration",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ww=Yh(Fw.prototype,"_keys",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kw=Yh(Fw.prototype,"_stepness",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qw=Yh(Fw.prototype,"_curves",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Xw=Yh(Fw.prototype,"_commonTargets",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Yw=Yh(Fw.prototype,"_hash",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Bw=Fw))||Bw);i.AnimationClip=Zw;class Jw{constructor(){this._nodeBlendStates=new Map,this._states=new Set}ref(t,e){let n=this._nodeBlendStates.get(t);n||(n={dirty:!1,properties:{}},this._nodeBlendStates.set(t,n));let i=n.properties[e];return i||(i=n.properties[e]=new tD(n,Qw(e)?new $e:new rn)),++i.refCount,i}deRef(t,e){const n=this._nodeBlendStates.get(t);if(!n)return;const i=n.properties[e];i&&(--i.refCount,i.refCount>0||(delete n.properties[e],function(t){return!(t.properties.position||t.properties.rotation||t.properties.eulerAngles||t.properties.scale)}(n)&&this._nodeBlendStates.delete(t)))}apply(){this._nodeBlendStates.forEach(((t,e)=>{if(!t.dirty)return;t.dirty=!1;const{position:n,scale:i,rotation:s,eulerAngles:o}=t.properties;let r,a,c,l=!1;n&&0!==n.weight&&(n.weight=0,r=n.value,l=!0),i&&0!==i.weight&&(i.weight=0,a=i.value,l=!0),s&&0!==s.weight&&(s.weight=0,c=s.value,l=!0),o&&0!==o.weight&&(o.weight=0,c=o.value,l=!0),l&&e.setRTS(c,r,a)})),this._states.forEach((t=>{t.onBlendFinished()}))}bindState(t){this._states.add(t)}unbindState(t){this._states.delete(t)}}function Qw(t){return!function(t){return"rotation"===t}(t)}class tD{constructor(t,e){this.weight=0,this.value=void 0,this.refCount=0,this._node=void 0,this._node=t,this.value=e}markAsDirty(){this._node.dirty=!0}}function eD(t,e,n){return 0===n.weight&&$e.zero(n.value),0===e?n.value:1===e?$e.copy(n.value,t):$e.scaleAndAdd(n.value,n.value,t,e)}function nD(t,e,n){if(0===n.weight&&rn.identity(n.value),0===e)return n.value;if(1===e)return rn.copy(n.value,t);const i=e/(n.weight+e);return rn.slerp(n.value,n.value,t,i)}const iD=[],sD=new Map;function oD(t,e){let n=0,i=pn.IDENTITY;for(;t;){if(t.stamp===e||t.stamp+1===e&&!t.node.hasChangedFlags){i=t.world,t.stamp=e;break}t.stamp=e,iD[n++]=t,t=t.parent}for(;n>0;){const e=(t=iD[--n]).node;pn.fromRTS(t.local,e.rotation,e.position,e.scale),i=pn.multiply(t.world,i,t.local)}return i}function rD(t,e){let n,i=null,s=0;for(;t!==e;){const e=t.uuid;if(sD.has(e)){i=sD.get(e);break}i={node:t,local:new pn,world:new pn,stamp:-1,parent:null},sD.set(e,i),iD[s++]=i,t=t.parent,i=null}for(;s>0;)n=iD[--s],n.parent=i,i=n;return i}function aD(t){let e=sD.get(t.uuid)||null;for(;e;)sD.delete(e.node.uuid),e=e.parent}var cD,lD,hD;let _D=t("AnimationManager",i_((hD=lD=class extends BA{constructor(...t){super(...t),this._anims=new B([]),this._delayEvents=[],this._blendStateBuffer=new Jw,this._crossFades=[],this._sockets=[]}get blendState(){return this._blendStateBuffer}addCrossFade(t){this._crossFades.push(t)}removeCrossFade(t){U(this._crossFades,t)}update(t){const{_delayEvents:e,_crossFades:n,_sockets:s}=this;for(let e=0,i=n.length;e<i;e++)n[e].update(t);const o=this._anims,r=o.array;for(o.i=0;o.i<r.length;++o.i){const e=r[o.i];e.isMotionless||e.update(t)}this._blendStateBuffer.apply();const a=i.director.getTotalFrames();for(let t=0,e=s.length;t<e;t++){const{target:e,transform:n}=s[t];e.matrix=oD(n,a)}for(let t=0,n=e.length;t<n;t++){const n=e[t];n.fn.apply(n.thisArg,n.args)}e.length=0}destruct(){}addAnimation(t){-1===this._anims.array.indexOf(t)&&this._anims.push(t)}removeAnimation(t){const e=this._anims.array.indexOf(t);e>=0?this._anims.fastRemoveAt(e):C(3907)}pushDelayEvent(t,e,n){this._delayEvents.push({fn:t,thisArg:e,args:n})}addSockets(t,e){for(let n=0;n<e.length;++n){const i=e[n];if(this._sockets.find((t=>t.target===i.target)))continue;const s=t.getChildByPath(i.path),o=i.target&&s&&rD(s,t);o&&this._sockets.push({target:i.target,transform:o})}}removeSockets(t,e){for(let t=0;t<e.length;++t){const n=e[t];for(let t=0;t<this._sockets.length;++t){const e=this._sockets[t];if(e.target===n.target){aD(e.transform.node),this._sockets[t]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}}}},lD.ID="animation",cD=hD))||cD);function uD(t,e,n){const i=e[e.length-1];if(0!==e.length&&WP(i)&&!n){const n=YP(t,...e.slice(0,e.length-1));return null===n?null:{setValue:t=>{n[i]=t},getValue:()=>n[i]}}if(n){const i=YP(t,...e);if(null===i)return null;const s=n.forTarget(i);return{setValue:t=>{s.set(t)},getValue:()=>s.get?s.get():(p("Target doesn't provide a get method."),null)}}return p("Empty animation curve."),null}function dD(t,e,n){const i=uD(t,e,n);if(null===i)return null;const s=i.getValue(),o=fD(s);if(!o)return p("Value is not copyable!"),null;const r=o.createBuffer(),a=o.copy;return Object.assign(i,{peek:()=>r,pull:()=>{const t=i.getValue();a(r,t)},push:()=>{i.setValue(r)}})}function pD(t,e){return t.set(e)}qA.on(kA.EVENT_INIT,(()=>{const t=new _D;qA.registerSystem(_D.ID,t,VA.PRIORITY_SYSTEM)})),i.AnimationManager=_D;const fD=(()=>{const t=new Map;return t.set(qe,{createBuffer:()=>new qe,copy:qe.copy}),t.set($e,{createBuffer:()=>new $e,copy:$e.copy}),t.set(tn,{createBuffer:()=>new tn,copy:tn.copy}),t.set(An,{createBuffer:()=>new An,copy:An.copy}),t.set(yn,{createBuffer:()=>new yn,copy:pD}),e=>t.get(null==e?void 0:e.constructor)})();class mD{constructor(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}get isPlaying(){return this._isPlaying}get isPaused(){return this._isPaused}get isMotionless(){return!this.isPlaying||this.isPaused}play(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(D(3912)):(this._isPlaying=!0,this.onPlay())}stop(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)}pause(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())}resume(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())}step(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()}update(t){}onPlay(){}onPause(){}onResume(){}onStop(){}onError(t){}}let gD;!function(t){t.PLAY="play",t.STOP="stop",t.PAUSE="pause",t.RESUME="resume",t.LASTFRAME="lastframe",t.FINISHED="finished"}(gD||(gD={})),Mt(gD);class vD{constructor(t,e,n){this.commonTargetIndex=void 0,this._curve=void 0,this._boundTarget=void 0,this._rootTargetProperty=void 0,this._curveDetail=void 0,this._curve=t.curve,this._curveDetail=t,this._boundTarget=n,this._shouldLerp=t.curve.hasLerp()}applySample(t,e,n,i,s){let o;o=this._shouldLerp&&n?this._curve.valueBetween(t,i.from,i.fromRatio,i.to,i.toRatio):this._curve.valueAt(e),this._setValue(o,s)}_setValue(t,e){this._boundTarget.setValue(t)}get propertyName(){return this._rootTargetProperty||""}get curveDetail(){return this._curveDetail}}class yD extends mD{get clip(){return this._clip}get name(){return this._name}get length(){return this.duration}get wrapMode(){return this._wrapMode}set wrapMode(t){this._wrapMode=t,this.time=0,t&sl.Loop?this.repeatCount=1/0:this.repeatCount=1}get repeatCount(){return this._repeatCount}set repeatCount(t){this._repeatCount=t;const e=this._wrapMode&sl.ShouldWrap,n=(this.wrapMode&sl.Reverse)===sl.Reverse;this._process=t!==1/0||e||n?this.process:this.simpleProcess}get delay(){return this._delay}set delay(t){this._delayTime=this._delay=t}get playbackRange(){return this._playbackRange}set playbackRange(t){t.max,t.min,this._playbackRange.min=Math.max(t.min,0),this._playbackRange.max=Math.min(t.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}get current(){return this.getWrappedInfo(this.time).time}get ratio(){return this.current/this.duration}constructor(t,e=""){super(),this.duration=1,this.speed=1,this.time=0,this.weight=0,this.frameRate=0,this._targetNode=null,this._curveLoaded=!1,this._clip=void 0,this._process=this.process,this._samplerSharedGroups=[],this._target=null,this._ignoreIndex=-1,this._commonTargetStatuses=[],this._wrapMode=ol.Normal,this._repeatCount=1,this._delay=0,this._delayTime=0,this._currentFramePlayed=!1,this._name=void 0,this._lastIterations=void 0,this._lastWrapInfo=null,this._lastWrapInfoEvent=null,this._wrappedInfo=new rl,this._blendStateBuffer=null,this._blendStateWriters=[],this._allowLastFrame=!1,this._blendStateWriterHost={weight:0,enabled:!1},this._playbackRange=void 0,this._playbackDuration=0,this._invDuration=1,this._clip=t,this._name=e||t&&t.name,this._playbackRange={min:0,max:this._clip.duration},this._playbackDuration=t.duration,t.duration||m(`Clip ${t.name} has zero duration.`)}get curveLoaded(){return this._curveLoaded}initialize(t,e){var n,s;if(this._curveLoaded)return;this._curveLoaded=!0,this._destroyBlendStateWriters(),this._samplerSharedGroups.length=0,this._blendStateBuffer=null!==(n=null===(s=i.director.getAnimationManager())||void 0===s?void 0:s.blendState)&&void 0!==n?n:null,this._blendStateBuffer&&this._blendStateBuffer.bindState(this),this._targetNode=t;const o=this._clip;this.duration=o.duration,this._invDuration=1/this.duration,this.speed=o.speed,this.wrapMode=o.wrapMode,this.frameRate=o.sample,this._playbackRange={min:0,max:o.duration},this._playbackDuration=o.duration,(this.wrapMode&sl.Loop)===sl.Loop?this.repeatCount=1/0:this.repeatCount=1;const r=(t,e,n,i,s)=>{if(!(o.enableTrsBlending&&function(t){let e;if(1===t.length&&"string"==typeof t[0])e=t[0];else if(t.length>1){for(let e=0;e<t.length-1;++e)if(!(t[e]instanceof qP))return!1;e=t[t.length-1]}switch(e){case"position":case"scale":case"rotation":case"eulerAngles":return!0;default:return!1}}(n)&&this._blendStateBuffer))return t(e,n,i);{const i=YP(e,...n.slice(0,n.length-1));if(null!==i&&i instanceof ey){const o=n[n.length-1],r=function(t,e,n,i,s){const o=Qw(n)?eD:nD;let r=t.ref(e,n),a=!1,c=-1;return{destroy(){r&&(t.deRef(e,n),r=null)},forTarget:()=>({get:()=>e[n],set:t=>{if(!r||!i.enabled)return;const e=i.weight;if(s)if(1!==e||e!==c)a=!1;else if(a)return;o(t,e,r),r.weight+=e,r.markAsDirty(),a=!0,c=e}})}}(this._blendStateBuffer,i,o,this._blendStateWriterHost,s);return this._blendStateWriters.push(r),t(e,[],r)}}return null};this._commonTargetStatuses=o.commonTargets.map((e=>{const n=r(dD,t,e.modifiers,e.valueAdapter,!1);return null===n?null:{target:n,changed:!1}})),e||(e=o.getPropertyCurves());for(let n=0;n<e.length;++n){const i=e[n];if(i.curve.empty())continue;let s,o=this._samplerSharedGroups.find((t=>t.sampler===i.sampler));if(o||(o={sampler:i.sampler,curves:[],samplerResultCache:{from:0,fromRatio:0,to:0,toRatio:0}},this._samplerSharedGroups.push(o)),void 0===i.commonTarget)s=t;else{const t=this._commonTargetStatuses[i.commonTarget];if(!t)continue;s=t.target.peek()}const a=r(uD,s,i.modifiers,i.valueAdapter,i.curve.constant());if(null===a);else{const t=new vD(i,s,a);t.commonTargetIndex=i.commonTarget,o.curves.push(t)}}}destroy(){this._destroyBlendStateWriters()}onBlendFinished(){this._blendStateWriterHost.enabled=!1}emit(...t){i.director.getAnimationManager().pushDelayEvent(this._emit,this,t)}on(t,e,n){return this._target&&this._target.isValid?this._target.on(t,e,n):null}once(t,e,n){return this._target&&this._target.isValid?this._target.once(t,e,n):null}off(t,e,n){this._target&&this._target.isValid&&this._target.off(t,e,n)}allowLastFrameEvent(t){this._allowLastFrame=t}_setEventTarget(t){this._target=t}setTime(t){this._currentFramePlayed=!1,this.time=t||0;{this._lastWrapInfoEvent=null,this._ignoreIndex=-1;const e=this.getWrappedInfo(t,this._wrappedInfo),n=e.direction;let i=this._clip.getEventGroupIndexAtRatio(e.ratio);i<0&&(i=~i-1,n<0&&(i+=1),this._ignoreIndex=i)}}update(t){this._delayTime>0&&(this._delayTime-=t,this._delayTime>0)||(this._currentFramePlayed?this.time+=t*this.speed:this._currentFramePlayed=!0,this._process())}sample(){const t=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(t.ratio),this._sampleEvents(t),t}onPlay(){this.setTime(0),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(gD.PLAY,this)}onStop(){this.isPaused||this._onPauseOrStop(),this.emit(gD.STOP,this)}onResume(){this._onReplayOrResume(),this.emit(gD.RESUME,this)}onPause(){this._onPauseOrStop(),this.emit(gD.PAUSE,this)}_sampleCurves(t){this._blendStateWriterHost.weight=this.weight,this._blendStateWriterHost.enabled=!0;const e=this._commonTargetStatuses;for(let t=0,n=e.length;t<n;++t){const n=e[t];n&&(n.target.pull(),n.changed=!1)}let n=0,i=!1;const s=this._samplerSharedGroups;for(let o=0,r=s.length;o<r;++o){const r=s[o],{sampler:a,samplerResultCache:c}=r;i=!1,a?(n=a.sample(t),n<0&&(n=~n,n<=0?n=0:n>=a.ratios.length?n=a.ratios.length-1:(i=!0,c.from=n-1,c.fromRatio=a.ratios[c.from],c.to=n,c.toRatio=a.ratios[c.to],n=c.from))):n=0;const l=r.curves;for(let s=0,o=l.length;s<o;++s){const o=l[s];if(o.applySample(t,n,i,c,this.weight),void 0!==o.commonTargetIndex){const t=e[o.commonTargetIndex];t&&(t.changed=!0)}}}for(let t=0,n=e.length;t<n;++t){const n=e[t];n&&n.changed&&n.target.push()}}process(){const t=this.sample();if(this._allowLastFrame){let e;e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new rl(t),this.repeatCount>1&&(0|t.iterations)>(0|e.iterations)&&this.emit(gD.LASTFRAME,this),e.set(t)}t.stopped&&(this.stop(),this.emit(gD.FINISHED,this))}simpleProcess(){const t=this._playbackRange.min,e=this._playbackDuration;let n=this.time%e;n<0&&(n+=e);const i=(t+n)*this._invDuration;this._sampleCurves(i),this._clip.hasEvents()&&this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(void 0===this._lastIterations&&(this._lastIterations=i),(this.time>0&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit(gD.LASTFRAME,this),this._lastIterations=i)}cache(t){}_needReverse(t){const e=this.wrapMode;let n=!1;return(e&sl.PingPong)===sl.PingPong&&(t-(0|t)==0&&t>0&&(t-=1),1&t&&(n=!n)),(e&sl.Reverse)===sl.Reverse&&(n=!n),n}getWrappedInfo(t,e){e=e||new rl;const n=this._getPlaybackStart(),i=this._getPlaybackEnd()-n;let s=!1;const o=this.repeatCount;let r=t>0?t/i:-t/i;if(r>=o){r=o,s=!0;let e=o-(0|o);0===e&&(e=1),t=e*i*(t>0?1:-1)}if(t>i){const e=t%i;t=0===e?i:e}else t<0&&0!=(t%=i)&&(t+=i);let a=!1;const c=this._wrapMode&sl.ShouldWrap;c&&(a=this._needReverse(r));let l=a?-1:1;return this.speed<0&&(l*=-1),c&&a&&(t=i-t),e.time=n+t,e.ratio=e.time/this.duration,e.direction=l,e.stopped=s,e.iterations=r,e}_getPlaybackStart(){return this._playbackRange.min}_getPlaybackEnd(){return this._playbackRange.max}_sampleEvents(t){const e=this._clip.eventGroups.length;let n=t.direction,s=this._clip.getEventGroupIndexAtRatio(t.ratio);if(s<0&&(s=~s-1,n<0&&(s+=1)),this._ignoreIndex!==s&&(this._ignoreIndex=-1),t.frameIndex=s,!this._lastWrapInfoEvent)return this._fireEvent(s),void(this._lastWrapInfoEvent=new rl(t));const o=this.wrapMode,r=xD(t.iterations),a=this._lastWrapInfoEvent;let c=xD(a.iterations),l=a.frameIndex;const h=a.direction,_=-1!==c&&r!==c;if(l===s&&_&&1===e)this._fireEvent(0);else if(l!==s||_){n=h;do{if(l!==s){if(-1===n&&0===l&&s>0?((o&sl.PingPong)===sl.PingPong?n*=-1:l=e,c++):1===n&&l===e-1&&s<e-1&&((o&sl.PingPong)===sl.PingPong?n*=-1:l=-1,c++),l===s)break;if(c>r)break}l+=n,i.director.getAnimationManager().pushDelayEvent(this._fireEvent,this,[l])}while(l!==s&&l>-1&&l<e)}this._lastWrapInfoEvent.set(t)}_emit(t,e){this._target&&this._target.isValid&&this._target.emit(t,t,e)}_fireEvent(t){if(!this._targetNode||!this._targetNode.isValid)return;const{eventGroups:e}=this._clip;if(t<0||t>=e.length||this._ignoreIndex===t)return;const n=e[t],i=this._targetNode.components;for(const t of n.events){const{functionName:e}=t;for(const n of i){const i=n[e];"function"==typeof i&&i.apply(n,t.parameters)}}}_onReplayOrResume(){i.director.getAnimationManager().addAnimation(this)}_onPauseOrStop(){i.director.getAnimationManager().removeAnimation(this)}_destroyBlendStateWriters(){for(let t=0;t<this._blendStateWriters.length;++t)this._blendStateWriters[t].destroy();this._blendStateWriters.length=0,this._blendStateBuffer&&(this._blendStateBuffer.unbindState(this),this._blendStateBuffer=null),this._blendStateWriterHost.enabled=!1}}function xD(t){return t-(0|t)==0&&(t-=1),0|t}t("AnimationState",yD),i.AnimationState=yD;class SD extends mD{constructor(){super(),this._managedStates=[],this._fadings=[]}update(t){if(this.isMotionless)return;const e=this._managedStates,n=this._fadings;if(1===e.length&&1===n.length){const t=e[0].state;t&&(t.weight=1)}else this._calculateWeights(t);for(let t=0;t<e.length;++t){const n=e[t].state;n&&n.isMotionless&&n.sample()}}crossFade(t,e){var n;0===this._managedStates.length&&(e=0),0===e&&this.clear();let i=this._managedStates.find((e=>e.state===t));i?(null===(n=i.state)||void 0===n?void 0:n.isMotionless)&&i.state.play():(i={state:t,reference:0},t&&t.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:e,easeTime:0,target:i})}clear(){for(let t=0;t<this._managedStates.length;++t){const e=this._managedStates[t].state;e&&e.stop()}this._managedStates.length=0,this._fadings.length=0}onPlay(){super.onPlay(),i.director.getAnimationManager().addCrossFade(this)}onPause(){super.onPause(),i.director.getAnimationManager().removeCrossFade(this);for(let t=0;t<this._managedStates.length;++t){const e=this._managedStates[t].state;e&&e.pause()}}onResume(){super.onResume(),i.director.getAnimationManager().addCrossFade(this);for(let t=0;t<this._managedStates.length;++t){const e=this._managedStates[t].state;e&&e.resume()}}onStop(){super.onStop(),i.director.getAnimationManager().removeCrossFade(this),this.clear()}_calculateWeights(t){const e=this._managedStates;this._fadings;for(let t=0;t<e.length;++t){const n=e[t].state;n&&(n.weight=0)}let n=1,i=this._fadings.length;for(let e=0;e<this._fadings.length;++e){const s=this._fadings[e];s.easeTime+=t;const o=0===s.easeDuration?1:Ie(s.easeTime/s.easeDuration),r=o*n;if(n*=1-o,s.target.state&&(s.target.state.weight+=r),s.easeTime>=s.easeDuration){i=e+1,s.easeTime=s.easeDuration;break}}if(i!==this._fadings.length){for(let t=i;t<this._fadings.length;++t){const e=this._fadings[t];--e.target.reference,e.target.reference<=0&&(e.target.state&&e.target.state.stop(),U(this._managedStates,e.target))}this._fadings.splice(i)}}}var TD,ED,AD,CD,bD,PD,wD,DD,ID,RD,OD,MD,ND,LD,BD,FD,zD;function UD(t,e){return t===e||!!t&&!!e&&t._uuid===e._uuid&&t._uuid}t("Animation",(TD=i_("cc.Animation"),ED=f_(),AD=o_(99),CD=__(),bD=O_([Zw]),PD=y_(),wD=O_(Zw),DD=y_(),ID=y_(),RD=O_([Zw]),TD(OD=ED(OD=AD(OD=h_(OD=CD((zD=FD=class extends(Gn(Ad)){constructor(...t){super(...t),Xh(this,"playOnLoad",ND,this),this._crossFade=new SD,this._nameToState=Q(!0),Xh(this,"_clips",LD,this),Xh(this,"_defaultClip",BD,this),this._hasBeenPlayed=!1}get clips(){return this._clips}set clips(t){this._crossFade&&this._crossFade.clear();for(const t of this._clips)t&&this._removeStateOfAutomaticClip(t);for(const e of t)e&&this.createState(e);const e=t.find((t=>UD(t,this._defaultClip)));this._defaultClip=e||null,this._clips=t}get defaultClip(){return this._defaultClip}set defaultClip(t){this._defaultClip=t,t&&(this._clips.findIndex((e=>UD(e,t)))>=0||(this._clips.push(t),this.createState(t)))}onLoad(){this.clips=this._clips;for(const t in this._nameToState)this._nameToState[t].initialize(this.node)}start(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)}onEnable(){this._crossFade.resume()}onDisable(){this._crossFade.pause()}onDestroy(){this._crossFade.stop();for(const t in this._nameToState)this._nameToState[t].destroy();this._nameToState=Q(!0)}play(t){if(this._hasBeenPlayed=!0,!t){if(!this._defaultClip)return;t=this._defaultClip.name}this.crossFade(t,0)}crossFade(t,e=.3){this._hasBeenPlayed=!0;const n=this._nameToState[t];n&&(this._crossFade.play(),this._crossFade.crossFade(n,e))}pause(){this._crossFade.pause()}resume(){this._crossFade.resume()}stop(){this._crossFade.stop()}getAnimationState(t){return this.getState(t)}getState(t){const e=this._nameToState[t];return e&&!e.curveLoaded&&e.initialize(this.node),e||null}createState(t,e){return e=e||t.name,this.removeState(e),this._doCreateState(t,e)}removeState(t){const e=this._nameToState[t];e&&(e.allowLastFrameEvent(!1),e.stop(),delete this._nameToState[t])}addClip(t,e){return H(this._clips,t)||this._clips.push(t),this.createState(t,e)}removeClip(t,e){let n;for(const e in this._nameToState){const i=this._nameToState[e];if(i.clip===t){n=i;break}}if(t===this._defaultClip){if(!e)return void E(3902);this._defaultClip=null}if(n&&n.isPlaying){if(!e)return void E(3903);n.stop()}this._clips=this._clips.filter((e=>e!==t)),n&&delete this._nameToState[n.name]}on(t,e,n,i){const s=super.on(t,e,n,i);return t===gD.LASTFRAME&&this._syncAllowLastFrameEvent(),s}once(t,e,n){const i=super.once(t,e,n);return t===gD.LASTFRAME&&this._syncAllowLastFrameEvent(),i}off(t,e,n){super.off(t,e,n),t===gD.LASTFRAME&&this._syncDisallowLastFrameEvent()}_createState(t,e){return new yD(t,e)}_doCreateState(t,e){const n=this._createState(t,e);return n._setEventTarget(this),n.allowLastFrameEvent(this.hasEventListener(gD.LASTFRAME)),this.node&&n.initialize(this.node),this._nameToState[n.name]=n,n}_getStateByNameOrDefaultClip(t){if(!t){if(!this._defaultClip)return null;t=this._defaultClip.name}return this._nameToState[t]||null}_removeStateOfAutomaticClip(t){for(const e in this._nameToState){const n=this._nameToState[e];UD(t,n.clip)&&(n.stop(),delete this._nameToState[e])}}_syncAllowLastFrameEvent(){if(this.hasEventListener(gD.LASTFRAME))for(const t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!0)}_syncDisallowLastFrameEvent(){if(!this.hasEventListener(gD.LASTFRAME))for(const t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!1)}},FD.EventType=gD,Yh((MD=zD).prototype,"clips",[bD,PD],Object.getOwnPropertyDescriptor(MD.prototype,"clips"),MD.prototype),Yh(MD.prototype,"defaultClip",[wD,DD],Object.getOwnPropertyDescriptor(MD.prototype,"defaultClip"),MD.prototype),ND=Yh(MD.prototype,"playOnLoad",[c_,ID],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),LD=Yh(MD.prototype,"_clips",[RD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),BD=Yh(MD.prototype,"_defaultClip",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),OD=MD))||OD)||OD)||OD)||OD)||OD));const HD=new pn;var GD,VD,jD,WD;i.easing=Fg;let kD=t("HierachyModifier",i_("cc.HierachyModifier")(GD=class extends qP{})||GD);i.HierachyModifier=kD;let qD=t("ComponentModifier",i_("cc.ComponentModifier")(VD=class extends XP{})||VD);i.ComponentModifier=qD;let XD=t("CurveValueAdapter",i_("cc.CurveValueAdapter")(jD=class{forTarget(t){return{set:()=>{}}}})||jD);i.CurveValueAdapter=XD;let YD,KD=t("UniformCurveValueAdapter",i_("cc.UniformCurveValueAdapter")(WD=class extends tw{})||WD);function $D(t){return"string"==typeof t}function ZD(t){return"number"==typeof t}function JD(t,e){return t instanceof e}i.UniformCurveValueAdapter=KD,i.isPropertyModifier=$D,i.isElementModifier=ZD,i.isCustomTargetModifier=JD,i.math=bn,i.geometry=_l;class QD{constructor(t){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=t,this._pool=[]}size(){return this._pool.length}clear(){const t=this._pool.length;for(let e=0;e<t;++e)this._pool[e].destroy();this._pool.length=0}put(t){if(t&&-1===this._pool.indexOf(t)){t.removeFromParent();const e=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;e&&e.unuse&&e.unuse(),this._pool.push(t)}}get(...t){const e=this._pool.length-1;if(e<0)return null;{const t=this._pool[e];this._pool.length=e;const n=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;return n&&n.reuse&&n.reuse(arguments),t}}}t("NodePool",QD),i.NodePool=QD,i.renderer=og;class tI extends Pa{constructor(...t){super(...t),this._gpuDescriptorSet=null}get gpuDescriptorSet(){return this._gpuDescriptorSet}initialize(t){this._layout=t.layout;const{bindings:e,descriptorIndices:n,descriptorCount:i}=t.layout.gpuDescriptorSetLayout;this._buffers=Array(i).fill(null),this._textures=Array(i).fill(null),this._samplers=Array(i).fill(null);const s=[];this._gpuDescriptorSet={gpuDescriptors:s,descriptorIndices:n};for(let t=0;t<e.length;++t){const n=e[t];for(let t=0;t<n.count;t++)s.push({type:n.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})}return!0}destroy(){this._layout=null,this._gpuDescriptorSet=null}update(){if(this._isDirty&&this._gpuDescriptorSet){const t=this._gpuDescriptorSet.gpuDescriptors;for(let e=0;e<t.length;++e)if(t[e].type&_a){const n=this._buffers[e];n&&(t[e].gpuBuffer=n.gpuBuffer||n.gpuBufferView)}else t[e].type&ua&&(this._textures[e]&&(t[e].gpuTexture=this._textures[e].gpuTexture),this._samplers[e]&&(t[e].gpuSampler=this._samplers[e].gpuSampler));this._isDirty=!1}}}function eI(t,e){switch(t){case Oo.R8:return e.UNSIGNED_BYTE;case Oo.R8SN:return e.BYTE;case Oo.R8UI:return e.UNSIGNED_BYTE;case Oo.R8I:return e.BYTE;case Oo.R16F:return YD.HALF_FLOAT_OES;case Oo.R16UI:return e.UNSIGNED_SHORT;case Oo.R16I:return e.SHORT;case Oo.R32F:return e.FLOAT;case Oo.R32UI:return e.UNSIGNED_INT;case Oo.R32I:return e.INT;case Oo.RG8:return e.UNSIGNED_BYTE;case Oo.RG8SN:return e.BYTE;case Oo.RG8UI:return e.UNSIGNED_BYTE;case Oo.RG8I:return e.BYTE;case Oo.RG16F:return YD.HALF_FLOAT_OES;case Oo.RG16UI:return e.UNSIGNED_SHORT;case Oo.RG16I:return e.SHORT;case Oo.RG32F:return e.FLOAT;case Oo.RG32UI:return e.UNSIGNED_INT;case Oo.RG32I:return e.INT;case Oo.RGB8:case Oo.SRGB8:return e.UNSIGNED_BYTE;case Oo.RGB8SN:return e.BYTE;case Oo.RGB8UI:return e.UNSIGNED_BYTE;case Oo.RGB8I:return e.BYTE;case Oo.RGB16F:return YD.HALF_FLOAT_OES;case Oo.RGB16UI:return e.UNSIGNED_SHORT;case Oo.RGB16I:return e.SHORT;case Oo.RGB32F:return e.FLOAT;case Oo.RGB32UI:return e.UNSIGNED_INT;case Oo.RGB32I:return e.INT;case Oo.BGRA8:case Oo.RGBA8:case Oo.SRGB8_A8:return e.UNSIGNED_BYTE;case Oo.RGBA8SN:return e.BYTE;case Oo.RGBA8UI:return e.UNSIGNED_BYTE;case Oo.RGBA8I:return e.BYTE;case Oo.RGBA16F:return YD.HALF_FLOAT_OES;case Oo.RGBA16UI:return e.UNSIGNED_SHORT;case Oo.RGBA16I:return e.SHORT;case Oo.RGBA32F:return e.FLOAT;case Oo.RGBA32UI:return e.UNSIGNED_INT;case Oo.RGBA32I:return e.INT;case Oo.R5G6B5:return e.UNSIGNED_SHORT_5_6_5;case Oo.R11G11B10F:return e.FLOAT;case Oo.RGB5A1:return e.UNSIGNED_SHORT_5_5_5_1;case Oo.RGBA4:return e.UNSIGNED_SHORT_4_4_4_4;case Oo.RGB10A2:return e.UNSIGNED_BYTE;case Oo.RGB10A2UI:return e.UNSIGNED_INT;case Oo.RGB9E5:return e.UNSIGNED_BYTE;case Oo.D16:return e.UNSIGNED_SHORT;case Oo.D16S8:return YD.UNSIGNED_INT_24_8_WEBGL;case Oo.D24:return e.UNSIGNED_INT;case Oo.D24S8:return YD.UNSIGNED_INT_24_8_WEBGL;case Oo.D32F:return e.UNSIGNED_INT;case Oo.D32F_S8:return YD.UNSIGNED_INT_24_8_WEBGL;case Oo.BC1:case Oo.BC1_SRGB:case Oo.BC2:case Oo.BC2_SRGB:case Oo.BC3:case Oo.BC3_SRGB:case Oo.BC4:return e.UNSIGNED_BYTE;case Oo.BC4_SNORM:return e.BYTE;case Oo.BC5:return e.UNSIGNED_BYTE;case Oo.BC5_SNORM:return e.BYTE;case Oo.BC6H_SF16:case Oo.BC6H_UF16:return e.FLOAT;case Oo.BC7:case Oo.BC7_SRGB:case Oo.ETC_RGB8:case Oo.ETC2_RGB8:case Oo.ETC2_SRGB8:case Oo.ETC2_RGB8_A1:case Oo.ETC2_SRGB8_A1:case Oo.EAC_R11:return e.UNSIGNED_BYTE;case Oo.EAC_R11SN:return e.BYTE;case Oo.EAC_RG11:return e.UNSIGNED_BYTE;case Oo.EAC_RG11SN:return e.BYTE;case Oo.PVRTC_RGB2:case Oo.PVRTC_RGBA2:case Oo.PVRTC_RGB4:case Oo.PVRTC_RGBA4:case Oo.PVRTC2_2BPP:case Oo.PVRTC2_4BPP:return e.UNSIGNED_BYTE;case Oo.ASTC_RGBA_4x4:case Oo.ASTC_RGBA_5x4:case Oo.ASTC_RGBA_5x5:case Oo.ASTC_RGBA_6x5:case Oo.ASTC_RGBA_6x6:case Oo.ASTC_RGBA_8x5:case Oo.ASTC_RGBA_8x6:case Oo.ASTC_RGBA_8x8:case Oo.ASTC_RGBA_10x5:case Oo.ASTC_RGBA_10x6:case Oo.ASTC_RGBA_10x8:case Oo.ASTC_RGBA_10x10:case Oo.ASTC_RGBA_12x10:case Oo.ASTC_RGBA_12x12:case Oo.ASTC_SRGBA_4x4:case Oo.ASTC_SRGBA_5x4:case Oo.ASTC_SRGBA_5x5:case Oo.ASTC_SRGBA_6x5:case Oo.ASTC_SRGBA_6x6:case Oo.ASTC_SRGBA_8x5:case Oo.ASTC_SRGBA_8x6:case Oo.ASTC_SRGBA_8x8:case Oo.ASTC_SRGBA_10x5:case Oo.ASTC_SRGBA_10x6:case Oo.ASTC_SRGBA_10x8:case Oo.ASTC_SRGBA_10x10:case Oo.ASTC_SRGBA_12x10:case Oo.ASTC_SRGBA_12x12:default:return e.UNSIGNED_BYTE}}function nI(t,e){switch(t){case Oo.A8:return e.ALPHA;case Oo.L8:return e.LUMINANCE;case Oo.LA8:return e.LUMINANCE_ALPHA;case Oo.RGB8:case Oo.RGB16F:case Oo.RGB32F:return e.RGB;case Oo.BGRA8:case Oo.RGBA8:case Oo.RGBA16F:case Oo.RGBA32F:return e.RGBA;case Oo.R5G6B5:return e.RGB565;case Oo.RGB5A1:return e.RGB5_A1;case Oo.RGBA4:return e.RGBA4;case Oo.D16:return e.DEPTH_COMPONENT;case Oo.D16S8:return e.DEPTH_STENCIL;case Oo.D24:return e.DEPTH_COMPONENT;case Oo.D24S8:return e.DEPTH_STENCIL;case Oo.D32F:return e.DEPTH_COMPONENT;case Oo.D32F_S8:return e.DEPTH_STENCIL;case Oo.BC1:return YD.COMPRESSED_RGB_S3TC_DXT1_EXT;case Oo.BC1_ALPHA:return YD.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Oo.BC1_SRGB:return YD.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Oo.BC1_SRGB_ALPHA:return YD.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Oo.BC2:return YD.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Oo.BC2_SRGB:return YD.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Oo.BC3:return YD.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Oo.BC3_SRGB:return YD.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Oo.ETC_RGB8:return YD.COMPRESSED_RGB_ETC1_WEBGL;case Oo.ETC2_RGB8:return YD.COMPRESSED_RGB8_ETC2;case Oo.ETC2_SRGB8:return YD.COMPRESSED_SRGB8_ETC2;case Oo.ETC2_RGB8_A1:return YD.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Oo.ETC2_SRGB8_A1:return YD.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Oo.ETC2_RGBA8:return YD.COMPRESSED_RGBA8_ETC2_EAC;case Oo.ETC2_SRGB8_A8:return YD.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Oo.EAC_R11:return YD.COMPRESSED_R11_EAC;case Oo.EAC_R11SN:return YD.COMPRESSED_SIGNED_R11_EAC;case Oo.EAC_RG11:return YD.COMPRESSED_RG11_EAC;case Oo.EAC_RG11SN:return YD.COMPRESSED_SIGNED_RG11_EAC;case Oo.PVRTC_RGB2:return YD.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Oo.PVRTC_RGBA2:return YD.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Oo.PVRTC_RGB4:return YD.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Oo.PVRTC_RGBA4:return YD.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Oo.ASTC_RGBA_4x4:return YD.COMPRESSED_RGBA_ASTC_4x4_KHR;case Oo.ASTC_RGBA_5x4:return YD.COMPRESSED_RGBA_ASTC_5x4_KHR;case Oo.ASTC_RGBA_5x5:return YD.COMPRESSED_RGBA_ASTC_5x5_KHR;case Oo.ASTC_RGBA_6x5:return YD.COMPRESSED_RGBA_ASTC_6x5_KHR;case Oo.ASTC_RGBA_6x6:return YD.COMPRESSED_RGBA_ASTC_6x6_KHR;case Oo.ASTC_RGBA_8x5:return YD.COMPRESSED_RGBA_ASTC_8x5_KHR;case Oo.ASTC_RGBA_8x6:return YD.COMPRESSED_RGBA_ASTC_8x6_KHR;case Oo.ASTC_RGBA_8x8:return YD.COMPRESSED_RGBA_ASTC_8x8_KHR;case Oo.ASTC_RGBA_10x5:return YD.COMPRESSED_RGBA_ASTC_10x5_KHR;case Oo.ASTC_RGBA_10x6:return YD.COMPRESSED_RGBA_ASTC_10x6_KHR;case Oo.ASTC_RGBA_10x8:return YD.COMPRESSED_RGBA_ASTC_10x8_KHR;case Oo.ASTC_RGBA_10x10:return YD.COMPRESSED_RGBA_ASTC_10x10_KHR;case Oo.ASTC_RGBA_12x10:return YD.COMPRESSED_RGBA_ASTC_12x10_KHR;case Oo.ASTC_RGBA_12x12:return YD.COMPRESSED_RGBA_ASTC_12x12_KHR;case Oo.ASTC_SRGBA_4x4:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Oo.ASTC_SRGBA_5x4:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Oo.ASTC_SRGBA_5x5:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Oo.ASTC_SRGBA_6x5:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Oo.ASTC_SRGBA_6x6:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Oo.ASTC_SRGBA_8x5:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Oo.ASTC_SRGBA_8x6:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Oo.ASTC_SRGBA_8x8:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Oo.ASTC_SRGBA_10x5:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Oo.ASTC_SRGBA_10x6:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Oo.ASTC_SRGBA_10x8:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Oo.ASTC_SRGBA_10x10:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Oo.ASTC_SRGBA_12x10:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Oo.ASTC_SRGBA_12x12:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),e.RGBA}}function iI(t,e){switch(t){case Oo.A8:return e.ALPHA;case Oo.L8:return e.LUMINANCE;case Oo.LA8:return e.LUMINANCE_ALPHA;case Oo.RGB8:case Oo.RGB16F:case Oo.RGB32F:return e.RGB;case Oo.BGRA8:case Oo.RGBA8:case Oo.RGBA16F:case Oo.RGBA32F:return e.RGBA;case Oo.R5G6B5:return e.RGB;case Oo.RGB5A1:case Oo.RGBA4:return e.RGBA;case Oo.D16:return e.DEPTH_COMPONENT;case Oo.D16S8:return e.DEPTH_STENCIL;case Oo.D24:return e.DEPTH_COMPONENT;case Oo.D24S8:return e.DEPTH_STENCIL;case Oo.D32F:return e.DEPTH_COMPONENT;case Oo.D32F_S8:return e.DEPTH_STENCIL;case Oo.BC1:return YD.COMPRESSED_RGB_S3TC_DXT1_EXT;case Oo.BC1_ALPHA:return YD.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Oo.BC1_SRGB:return YD.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Oo.BC1_SRGB_ALPHA:return YD.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Oo.BC2:return YD.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Oo.BC2_SRGB:return YD.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Oo.BC3:return YD.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Oo.BC3_SRGB:return YD.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Oo.ETC_RGB8:return YD.COMPRESSED_RGB_ETC1_WEBGL;case Oo.ETC2_RGB8:return YD.COMPRESSED_RGB8_ETC2;case Oo.ETC2_SRGB8:return YD.COMPRESSED_SRGB8_ETC2;case Oo.ETC2_RGB8_A1:return YD.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Oo.ETC2_SRGB8_A1:return YD.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Oo.ETC2_RGBA8:return YD.COMPRESSED_RGBA8_ETC2_EAC;case Oo.ETC2_SRGB8_A8:return YD.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Oo.EAC_R11:return YD.COMPRESSED_R11_EAC;case Oo.EAC_R11SN:return YD.COMPRESSED_SIGNED_R11_EAC;case Oo.EAC_RG11:return YD.COMPRESSED_RG11_EAC;case Oo.EAC_RG11SN:return YD.COMPRESSED_SIGNED_RG11_EAC;case Oo.PVRTC_RGB2:return YD.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Oo.PVRTC_RGBA2:return YD.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Oo.PVRTC_RGB4:return YD.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Oo.PVRTC_RGBA4:return YD.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Oo.ASTC_RGBA_4x4:return YD.COMPRESSED_RGBA_ASTC_4x4_KHR;case Oo.ASTC_RGBA_5x4:return YD.COMPRESSED_RGBA_ASTC_5x4_KHR;case Oo.ASTC_RGBA_5x5:return YD.COMPRESSED_RGBA_ASTC_5x5_KHR;case Oo.ASTC_RGBA_6x5:return YD.COMPRESSED_RGBA_ASTC_6x5_KHR;case Oo.ASTC_RGBA_6x6:return YD.COMPRESSED_RGBA_ASTC_6x6_KHR;case Oo.ASTC_RGBA_8x5:return YD.COMPRESSED_RGBA_ASTC_8x5_KHR;case Oo.ASTC_RGBA_8x6:return YD.COMPRESSED_RGBA_ASTC_8x6_KHR;case Oo.ASTC_RGBA_8x8:return YD.COMPRESSED_RGBA_ASTC_8x8_KHR;case Oo.ASTC_RGBA_10x5:return YD.COMPRESSED_RGBA_ASTC_10x5_KHR;case Oo.ASTC_RGBA_10x6:return YD.COMPRESSED_RGBA_ASTC_10x6_KHR;case Oo.ASTC_RGBA_10x8:return YD.COMPRESSED_RGBA_ASTC_10x8_KHR;case Oo.ASTC_RGBA_10x10:return YD.COMPRESSED_RGBA_ASTC_10x10_KHR;case Oo.ASTC_RGBA_12x10:return YD.COMPRESSED_RGBA_ASTC_12x10_KHR;case Oo.ASTC_RGBA_12x12:return YD.COMPRESSED_RGBA_ASTC_12x12_KHR;case Oo.ASTC_SRGBA_4x4:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Oo.ASTC_SRGBA_5x4:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Oo.ASTC_SRGBA_5x5:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Oo.ASTC_SRGBA_6x5:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Oo.ASTC_SRGBA_6x6:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Oo.ASTC_SRGBA_8x5:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Oo.ASTC_SRGBA_8x6:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Oo.ASTC_SRGBA_8x8:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Oo.ASTC_SRGBA_10x5:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Oo.ASTC_SRGBA_10x6:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Oo.ASTC_SRGBA_10x8:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Oo.ASTC_SRGBA_10x10:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Oo.ASTC_SRGBA_12x10:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Oo.ASTC_SRGBA_12x12:return YD.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),e.RGBA}}function sI(t,e){switch(t){case No.BOOL:return e.BOOL;case No.BOOL2:return e.BOOL_VEC2;case No.BOOL3:return e.BOOL_VEC3;case No.BOOL4:return e.BOOL_VEC4;case No.INT:return e.INT;case No.INT2:return e.INT_VEC2;case No.INT3:return e.INT_VEC3;case No.INT4:return e.INT_VEC4;case No.UINT:return e.UNSIGNED_INT;case No.FLOAT:return e.FLOAT;case No.FLOAT2:return e.FLOAT_VEC2;case No.FLOAT3:return e.FLOAT_VEC3;case No.FLOAT4:return e.FLOAT_VEC4;case No.MAT2:return e.FLOAT_MAT2;case No.MAT3:return e.FLOAT_MAT3;case No.MAT4:return e.FLOAT_MAT4;case No.SAMPLER2D:return e.SAMPLER_2D;case No.SAMPLER_CUBE:return e.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),No.UNKNOWN}}function oI(t){switch(t){case No.BOOL:case No.BOOL2:case No.BOOL3:case No.BOOL4:case No.INT:case No.INT2:case No.INT3:case No.INT4:case No.UINT:return Int32Array;case No.FLOAT:case No.FLOAT2:case No.FLOAT3:case No.FLOAT4:case No.MAT2:case No.MAT3:case No.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function rI(t,e){switch(t){case e.BOOL:return No.BOOL;case e.BOOL_VEC2:return No.BOOL2;case e.BOOL_VEC3:return No.BOOL3;case e.BOOL_VEC4:return No.BOOL4;case e.INT:return No.INT;case e.INT_VEC2:return No.INT2;case e.INT_VEC3:return No.INT3;case e.INT_VEC4:return No.INT4;case e.UNSIGNED_INT:return No.UINT;case e.FLOAT:return No.FLOAT;case e.FLOAT_VEC2:return No.FLOAT2;case e.FLOAT_VEC3:return No.FLOAT3;case e.FLOAT_VEC4:return No.FLOAT4;case e.FLOAT_MAT2:return No.MAT2;case e.FLOAT_MAT3:return No.MAT3;case e.FLOAT_MAT4:return No.MAT4;case e.SAMPLER_2D:return No.SAMPLER2D;case e.SAMPLER_CUBE:return No.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),No.UNKNOWN}}function aI(t,e){switch(t){case e.BOOL:return 4;case e.BOOL_VEC2:return 8;case e.BOOL_VEC3:return 12;case e.BOOL_VEC4:return 16;case e.INT:return 4;case e.INT_VEC2:return 8;case e.INT_VEC3:return 12;case e.INT_VEC4:return 16;case e.UNSIGNED_INT:case e.FLOAT:return 4;case e.FLOAT_VEC2:return 8;case e.FLOAT_VEC3:return 12;case e.FLOAT_VEC4:case e.FLOAT_MAT2:return 16;case e.FLOAT_MAT3:return 36;case e.FLOAT_MAT4:return 64;case e.SAMPLER_2D:case e.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function cI(t,e){switch(t){case e.FLOAT_MAT2:return 2;case e.FLOAT_MAT3:return 3;case e.FLOAT_MAT4:return 4;default:return 1}}!function(t){t[t.RGBA16F_EXT=34842]="RGBA16F_EXT",t[t.RGB16F_EXT=34843]="RGB16F_EXT",t[t.RGBA32F_EXT=34836]="RGBA32F_EXT",t[t.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",t[t.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",t[t.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",t[t.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",t[t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",t[t.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",t[t.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",t[t.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",t[t.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(YD||(YD={}));const lI=[512,513,514,515,516,517,518,519],hI=[0,7680,7681,7682,7683,5386,34055,34056],_I=[32774,32778,32779,32775,32776],uI=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];let dI;!function(t){t[t.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",t[t.END_RENDER_PASS=1]="END_RENDER_PASS",t[t.BIND_STATES=2]="BIND_STATES",t[t.DRAW=3]="DRAW",t[t.UPDATE_BUFFER=4]="UPDATE_BUFFER",t[t.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",t[t.COUNT=6]="COUNT"}(dI||(dI={}));class pI{constructor(t){this.cmdType=void 0,this.refCount=0,this.cmdType=t}}class fI extends pI{constructor(){super(dI.BEGIN_RENDER_PASS),this.gpuRenderPass=null,this.gpuFramebuffer=null,this.renderArea=new mr,this.clearFlag=_r.NONE,this.clearColors=[],this.clearDepth=1,this.clearStencil=0}clear(){this.gpuFramebuffer=null,this.clearColors.length=0}}class mI extends pI{constructor(){super(dI.BIND_STATES),this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets=[],this.dynamicOffsets=[],this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants=[],this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}clear(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0,this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants.length=0,this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}}class gI extends pI{constructor(){super(dI.DRAW),this.drawInfo=new wr}clear(){}}class vI extends pI{constructor(){super(dI.UPDATE_BUFFER),this.gpuBuffer=null,this.buffer=null,this.offset=0,this.size=0}clear(){this.gpuBuffer=null,this.buffer=null}}class yI extends pI{constructor(){super(dI.COPY_BUFFER_TO_TEXTURE),this.gpuTexture=null,this.buffers=[],this.regions=[]}clear(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0}}class xI{constructor(){this.cmds=new Dn(1),this.beginRenderPassCmds=new Dn(1),this.bindStatesCmds=new Dn(1),this.drawCmds=new Dn(1),this.updateBufferCmds=new Dn(1),this.copyBufferToTextureCmds=new Dn(1)}clearCmds(t){this.beginRenderPassCmds.length&&(t.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(t.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(t.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(t.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(t.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}function SI(t,e,n,i,s){if(e.usage&Lo.UNIFORM)ArrayBuffer.isView(n)?e.vf32.set(n,i/Float32Array.BYTES_PER_ELEMENT):e.vf32.set(new Float32Array(n),i/Float32Array.BYTES_PER_ELEMENT);else if(e.usage&Lo.INDIRECT)e.indirects.length=i,Array.prototype.push.apply(e.indirects,n.drawInfos);else{const o=n,{gl:r}=t,a=t.stateCache;switch(e.glTarget){case r.ARRAY_BUFFER:t.useVAO&&a.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=TI.gpuInputAssembler=null),t.stateCache.glArrayBuffer!==e.glBuffer&&(r.bindBuffer(r.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer);break;case r.ELEMENT_ARRAY_BUFFER:t.useVAO&&a.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=TI.gpuInputAssembler=null),t.stateCache.glElementArrayBuffer!==e.glBuffer&&(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}s===o.byteLength?r.bufferSubData(e.glTarget,i,o):r.bufferSubData(e.glTarget,i,o.slice(0,s))}}const TI={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0};function EI(t,e,n,i,s,o,r){const{gl:a}=t,c=t.stateCache;let l=0;if(n&&e){c.glFramebuffer!==n.glFramebuffer&&(a.bindFramebuffer(a.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(a.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(a.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height);let h=s.length;t.WEBGL_draw_buffers||(h=1);for(let t=0;t<h;++t){const n=e.colorAttachments[t];if(n.format!==Oo.UNKNOWN)switch(n.loadOp){case Zo.LOAD:break;case Zo.CLEAR:{c.bs.targets[0].blendColorMask!==Ko.ALL&&a.colorMask(!0,!0,!0,!0);const t=s[0];a.clearColor(t.x,t.y,t.z,t.w),l|=a.COLOR_BUFFER_BIT;break}case Zo.DISCARD:}}if(e.depthStencilAttachment&&e.depthStencilAttachment.format!==Oo.UNKNOWN){switch(e.depthStencilAttachment.depthLoadOp){case Zo.LOAD:break;case Zo.CLEAR:c.dss.depthWrite||a.depthMask(!0),a.clearDepth(o),l|=a.DEPTH_BUFFER_BIT;break;case Zo.DISCARD:}if(ha[e.depthStencilAttachment.format].hasStencil)switch(e.depthStencilAttachment.stencilLoadOp){case Zo.LOAD:break;case Zo.CLEAR:c.dss.stencilWriteMaskFront||a.stencilMaskSeparate(a.FRONT,65535),c.dss.stencilWriteMaskBack||a.stencilMaskSeparate(a.BACK,65535),a.clearStencil(r),l|=a.STENCIL_BUFFER_BIT;break;case Zo.DISCARD:}}if(l&&a.clear(l),l&a.COLOR_BUFFER_BIT){const t=c.bs.targets[0].blendColorMask;if(t!==Ko.ALL){const e=(t&Ko.R)!==Ko.NONE,n=(t&Ko.G)!==Ko.NONE,i=(t&Ko.B)!==Ko.NONE,s=(t&Ko.A)!==Ko.NONE;a.colorMask(e,n,i,s)}}l&a.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&a.depthMask(!1),l&a.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||a.stencilMaskSeparate(a.FRONT,0),c.dss.stencilWriteMaskBack||a.stencilMaskSeparate(a.BACK,0))}}function AI(t,e,n,i,s,o,r,a,c,l,h,_,u){const{gl:d}=t,f=t.stateCache,m=e&&e.gpuShader;let g,v,y,x=!1;if(e&&TI.gpuPipelineState!==e){if(TI.gpuPipelineState=e,TI.glPrimitive=e.glPrimitive,e.gpuShader){const{glProgram:t}=e.gpuShader;f.glProgram!==t&&(d.useProgram(t),f.glProgram=t,x=!0)}const{rs:t}=e;if(t){if(f.rs.cullMode!==t.cullMode){switch(t.cullMode){case or.NONE:d.disable(d.CULL_FACE);break;case or.FRONT:d.enable(d.CULL_FACE),d.cullFace(d.FRONT);break;case or.BACK:d.enable(d.CULL_FACE),d.cullFace(d.BACK)}f.rs.cullMode=t.cullMode}const e=t.isFrontFaceCCW;f.rs.isFrontFaceCCW!==e&&(d.frontFace(e?d.CCW:d.CW),f.rs.isFrontFaceCCW=e),f.rs.depthBias===t.depthBias&&f.rs.depthBiasSlop===t.depthBiasSlop||(d.polygonOffset(t.depthBias,t.depthBiasSlop),f.rs.depthBias=t.depthBias,f.rs.depthBiasSlop=t.depthBiasSlop),f.rs.lineWidth!==t.lineWidth&&(d.lineWidth(t.lineWidth),f.rs.lineWidth=t.lineWidth)}const{dss:n}=e;n&&(f.dss.depthTest!==n.depthTest&&(n.depthTest?d.enable(d.DEPTH_TEST):d.disable(d.DEPTH_TEST),f.dss.depthTest=n.depthTest),f.dss.depthWrite!==n.depthWrite&&(d.depthMask(n.depthWrite),f.dss.depthWrite=n.depthWrite),f.dss.depthFunc!==n.depthFunc&&(d.depthFunc(lI[n.depthFunc]),f.dss.depthFunc=n.depthFunc),f.dss.stencilTestFront===n.stencilTestFront&&f.dss.stencilTestBack===n.stencilTestBack||(n.stencilTestFront||n.stencilTestBack?d.enable(d.STENCIL_TEST):d.disable(d.STENCIL_TEST),f.dss.stencilTestFront=n.stencilTestFront,f.dss.stencilTestBack=n.stencilTestBack),f.dss.stencilFuncFront===n.stencilFuncFront&&f.dss.stencilRefFront===n.stencilRefFront&&f.dss.stencilReadMaskFront===n.stencilReadMaskFront||(d.stencilFuncSeparate(d.FRONT,lI[n.stencilFuncFront],n.stencilRefFront,n.stencilReadMaskFront),f.dss.stencilFuncFront=n.stencilFuncFront,f.dss.stencilRefFront=n.stencilRefFront,f.dss.stencilReadMaskFront=n.stencilReadMaskFront),f.dss.stencilFailOpFront===n.stencilFailOpFront&&f.dss.stencilZFailOpFront===n.stencilZFailOpFront&&f.dss.stencilPassOpFront===n.stencilPassOpFront||(d.stencilOpSeparate(d.FRONT,hI[n.stencilFailOpFront],hI[n.stencilZFailOpFront],hI[n.stencilPassOpFront]),f.dss.stencilFailOpFront=n.stencilFailOpFront,f.dss.stencilZFailOpFront=n.stencilZFailOpFront,f.dss.stencilPassOpFront=n.stencilPassOpFront),f.dss.stencilWriteMaskFront!==n.stencilWriteMaskFront&&(d.stencilMaskSeparate(d.FRONT,n.stencilWriteMaskFront),f.dss.stencilWriteMaskFront=n.stencilWriteMaskFront),f.dss.stencilFuncBack===n.stencilFuncBack&&f.dss.stencilRefBack===n.stencilRefBack&&f.dss.stencilReadMaskBack===n.stencilReadMaskBack||(d.stencilFuncSeparate(d.BACK,lI[n.stencilFuncBack],n.stencilRefBack,n.stencilReadMaskBack),f.dss.stencilFuncBack=n.stencilFuncBack,f.dss.stencilRefBack=n.stencilRefBack,f.dss.stencilReadMaskBack=n.stencilReadMaskBack),f.dss.stencilFailOpBack===n.stencilFailOpBack&&f.dss.stencilZFailOpBack===n.stencilZFailOpBack&&f.dss.stencilPassOpBack===n.stencilPassOpBack||(d.stencilOpSeparate(d.BACK,hI[n.stencilFailOpBack],hI[n.stencilZFailOpBack],hI[n.stencilPassOpBack]),f.dss.stencilFailOpBack=n.stencilFailOpBack,f.dss.stencilZFailOpBack=n.stencilZFailOpBack,f.dss.stencilPassOpBack=n.stencilPassOpBack),f.dss.stencilWriteMaskBack!==n.stencilWriteMaskBack&&(d.stencilMaskSeparate(d.BACK,n.stencilWriteMaskBack),f.dss.stencilWriteMaskBack=n.stencilWriteMaskBack));const{bs:i}=e;if(i){f.bs.isA2C!==i.isA2C&&(i.isA2C?d.enable(d.SAMPLE_ALPHA_TO_COVERAGE):d.disable(d.SAMPLE_ALPHA_TO_COVERAGE),f.bs.isA2C=i.isA2C),f.bs.blendColor.x===i.blendColor.x&&f.bs.blendColor.y===i.blendColor.y&&f.bs.blendColor.z===i.blendColor.z&&f.bs.blendColor.w===i.blendColor.w||(d.blendColor(i.blendColor.x,i.blendColor.y,i.blendColor.z,i.blendColor.w),f.bs.blendColor.x=i.blendColor.x,f.bs.blendColor.y=i.blendColor.y,f.bs.blendColor.z=i.blendColor.z,f.bs.blendColor.w=i.blendColor.w);const t=i.targets[0],e=f.bs.targets[0];e.blend!==t.blend&&(t.blend?d.enable(d.BLEND):d.disable(d.BLEND),e.blend=t.blend),e.blendEq===t.blendEq&&e.blendAlphaEq===t.blendAlphaEq||(d.blendEquationSeparate(_I[t.blendEq],_I[t.blendAlphaEq]),e.blendEq=t.blendEq,e.blendAlphaEq=t.blendAlphaEq),e.blendSrc===t.blendSrc&&e.blendDst===t.blendDst&&e.blendSrcAlpha===t.blendSrcAlpha&&e.blendDstAlpha===t.blendDstAlpha||(d.blendFuncSeparate(uI[t.blendSrc],uI[t.blendDst],uI[t.blendSrcAlpha],uI[t.blendDstAlpha]),e.blendSrc=t.blendSrc,e.blendDst=t.blendDst,e.blendSrcAlpha=t.blendSrcAlpha,e.blendDstAlpha=t.blendDstAlpha),e.blendColorMask!==t.blendColorMask&&(d.colorMask((t.blendColorMask&Ko.R)!==Ko.NONE,(t.blendColorMask&Ko.G)!==Ko.NONE,(t.blendColorMask&Ko.B)!==Ko.NONE,(t.blendColorMask&Ko.A)!==Ko.NONE),e.blendColorMask=t.blendColorMask)}}if(e&&e.gpuPipelineLayout&&m){const n=m.glBlocks.length,{dynamicOffsetIndices:o}=e.gpuPipelineLayout;for(let t=0;t<n;t++){const e=m.glBlocks[t],n=i[e.set],r=n&&n.descriptorIndices[e.binding],a=r>=0&&n.gpuDescriptors[r];let c=null,l=0;if(a&&a.gpuBuffer){const{gpuBuffer:t}=a,n=o[e.set],i=n&&n[e.binding];i>=0&&(l=s[i]),"vf32"in t?c=t.vf32:(l+=t.offset,c=t.gpuBuffer.vf32),l>>=2}if(!c){p(`Buffer binding '${e.name}' at set ${e.set} binding ${e.binding} is not bounded`);continue}const h=e.glActiveUniforms.length;for(let t=0;t<h;t++){const n=e.glActiveUniforms[t];switch(n.glType){case d.BOOL:case d.INT:for(let t=0;t<n.array.length;++t){const e=n.begin+l+t;if(c[e]!==n.array[t]){for(let i=t,s=e;i<n.array.length;++i,++s)n.array[i]=c[s];d.uniform1iv(n.glLoc,n.array);break}}break;case d.BOOL_VEC2:case d.INT_VEC2:for(let t=0;t<n.array.length;++t){const e=n.begin+l+t;if(c[e]!==n.array[t]){for(let i=t,s=e;i<n.array.length;++i,++s)n.array[i]=c[s];d.uniform2iv(n.glLoc,n.array);break}}break;case d.BOOL_VEC3:case d.INT_VEC3:for(let t=0;t<n.array.length;++t){const e=n.begin+l+t;if(c[e]!==n.array[t]){for(let i=t,s=e;i<n.array.length;++i,++s)n.array[i]=c[s];d.uniform3iv(n.glLoc,n.array);break}}break;case d.BOOL_VEC4:case d.INT_VEC4:for(let t=0;t<n.array.length;++t){const e=n.begin+l+t;if(c[e]!==n.array[t]){for(let i=t,s=e;i<n.array.length;++i,++s)n.array[i]=c[s];d.uniform4iv(n.glLoc,n.array);break}}break;case d.FLOAT:for(let t=0;t<n.array.length;++t){const e=n.begin+l+t;if(c[e]!==n.array[t]){for(let i=t,s=e;i<n.array.length;++i,++s)n.array[i]=c[s];d.uniform1fv(n.glLoc,n.array);break}}break;case d.FLOAT_VEC2:for(let t=0;t<n.array.length;++t){const e=n.begin+l+t;if(c[e]!==n.array[t]){for(let i=t,s=e;i<n.array.length;++i,++s)n.array[i]=c[s];d.uniform2fv(n.glLoc,n.array);break}}break;case d.FLOAT_VEC3:for(let t=0;t<n.array.length;++t){const e=n.begin+l+t;if(c[e]!==n.array[t]){for(let i=t,s=e;i<n.array.length;++i,++s)n.array[i]=c[s];d.uniform3fv(n.glLoc,n.array);break}}break;case d.FLOAT_VEC4:for(let t=0;t<n.array.length;++t){const e=n.begin+l+t;if(c[e]!==n.array[t]){for(let i=t,s=e;i<n.array.length;++i,++s)n.array[i]=c[s];d.uniform4fv(n.glLoc,n.array);break}}break;case d.FLOAT_MAT2:for(let t=0;t<n.array.length;++t){const e=n.begin+l+t;if(c[e]!==n.array[t]){for(let i=t,s=e;i<n.array.length;++i,++s)n.array[i]=c[s];d.uniformMatrix2fv(n.glLoc,!1,n.array);break}}break;case d.FLOAT_MAT3:for(let t=0;t<n.array.length;++t){const e=n.begin+l+t;if(c[e]!==n.array[t]){for(let i=t,s=e;i<n.array.length;++i,++s)n.array[i]=c[s];d.uniformMatrix3fv(n.glLoc,!1,n.array);break}}break;case d.FLOAT_MAT4:for(let t=0;t<n.array.length;++t){const e=n.begin+l+t;if(c[e]!==n.array[t]){for(let i=t,s=e;i<n.array.length;++i,++s)n.array[i]=c[s];d.uniformMatrix4fv(n.glLoc,!1,n.array);break}}}}}const r=m.glSamplerTextures.length;for(let e=0;e<r;e++){const n=m.glSamplerTextures[e],s=i[n.set];let o=s&&s.descriptorIndices[n.binding],r=o>=0&&s.gpuDescriptors[o];const a=n.units.length;for(let e=0;e<a;e++){const i=n.units[e];if(r&&r.gpuSampler){if(r.gpuTexture&&r.gpuTexture.size>0){const{gpuTexture:e}=r,n=f.glTexUnits[i];n.glTexture!==e.glTexture&&(f.texUnit!==i&&(d.activeTexture(d.TEXTURE0+i),f.texUnit=i),e.glTexture?d.bindTexture(e.glTarget,e.glTexture):d.bindTexture(e.glTarget,t.nullTex2D.gpuTexture.glTexture),n.glTexture=e.glTexture);const{gpuSampler:s}=r;e.isPowerOf2?(g=s.glWrapS,v=s.glWrapT):(g=d.CLAMP_TO_EDGE,v=d.CLAMP_TO_EDGE),y=e.isPowerOf2?e.mipLevel<=1&&(s.glMinFilter===d.LINEAR_MIPMAP_NEAREST||s.glMinFilter===d.LINEAR_MIPMAP_LINEAR)?d.LINEAR:s.glMinFilter:s.glMinFilter===d.LINEAR||s.glMinFilter===d.LINEAR_MIPMAP_NEAREST||s.glMinFilter===d.LINEAR_MIPMAP_LINEAR?d.LINEAR:d.NEAREST,e.glWrapS!==g&&(f.texUnit!==i&&(d.activeTexture(d.TEXTURE0+i),f.texUnit=i),d.texParameteri(e.glTarget,d.TEXTURE_WRAP_S,g),e.glWrapS=g),e.glWrapT!==v&&(f.texUnit!==i&&(d.activeTexture(d.TEXTURE0+i),f.texUnit=i),d.texParameteri(e.glTarget,d.TEXTURE_WRAP_T,v),e.glWrapT=v),e.glMinFilter!==y&&(f.texUnit!==i&&(d.activeTexture(d.TEXTURE0+i),f.texUnit=i),d.texParameteri(e.glTarget,d.TEXTURE_MIN_FILTER,y),e.glMinFilter=y),e.glMagFilter!==s.glMagFilter&&(f.texUnit!==i&&(d.activeTexture(d.TEXTURE0+i),f.texUnit=i),d.texParameteri(e.glTarget,d.TEXTURE_MAG_FILTER,s.glMagFilter),e.glMagFilter=s.glMagFilter)}r=s.gpuDescriptors[++o]}else p(`Sampler binding '${n.name}' at set ${n.set} binding ${n.binding} index ${e} is not bounded`)}}}if(n&&m&&(x||TI.gpuInputAssembler!==n)){TI.gpuInputAssembler=n;const e=t.ANGLE_instanced_arrays;if(t.useVAO){const i=t.OES_vertex_array_object;let s=n.glVAOs.get(m.glProgram);if(!s){let t;s=i.createVertexArrayOES(),n.glVAOs.set(m.glProgram,s),i.bindVertexArrayOES(s),d.bindBuffer(d.ARRAY_BUFFER,null),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null),f.glArrayBuffer=null,f.glElementArrayBuffer=null;const o=m.glInputs.length;for(let i=0;i<o;i++){const s=m.glInputs[i];t=null;const o=n.glAttribs.length;for(let e=0;e<o;e++){const i=n.glAttribs[e];if(i.name===s.name){t=i;break}}if(t){f.glArrayBuffer!==t.glBuffer&&(d.bindBuffer(d.ARRAY_BUFFER,t.glBuffer),f.glArrayBuffer=t.glBuffer);for(let n=0;n<t.componentCount;++n){const i=s.glLoc+n,o=t.offset+t.size*n;d.enableVertexAttribArray(i),f.glCurrentAttribLocs[i]=!0,d.vertexAttribPointer(i,t.count,t.glType,t.isNormalized,t.stride,o),e&&e.vertexAttribDivisorANGLE(i,t.isInstanced?1:0)}}}const r=n.gpuIndexBuffer;r&&d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,r.glBuffer),i.bindVertexArrayOES(null),d.bindBuffer(d.ARRAY_BUFFER,null),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null),f.glArrayBuffer=null,f.glElementArrayBuffer=null}f.glVAO!==s&&(i.bindVertexArrayOES(s),f.glVAO=s)}else{for(let e=0;e<t.capabilities.maxVertexAttributes;++e)f.glCurrentAttribLocs[e]=!1;const i=m.glInputs.length;for(let t=0;t<i;t++){const i=m.glInputs[t];let s=null;const o=n.glAttribs.length;for(let t=0;t<o;t++){const e=n.glAttribs[t];if(e.name===i.name){s=e;break}}if(s){f.glArrayBuffer!==s.glBuffer&&(d.bindBuffer(d.ARRAY_BUFFER,s.glBuffer),f.glArrayBuffer=s.glBuffer);for(let t=0;t<s.componentCount;++t){const n=i.glLoc+t,o=s.offset+s.size*t;!f.glEnabledAttribLocs[n]&&n>=0&&(d.enableVertexAttribArray(n),f.glEnabledAttribLocs[n]=!0),f.glCurrentAttribLocs[n]=!0,d.vertexAttribPointer(n,s.count,s.glType,s.isNormalized,s.stride,o),e&&e.vertexAttribDivisorANGLE(n,s.isInstanced?1:0)}}}const s=n.gpuIndexBuffer;s&&f.glElementArrayBuffer!==s.glBuffer&&(d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,s.glBuffer),f.glElementArrayBuffer=s.glBuffer);for(let e=0;e<t.capabilities.maxVertexAttributes;++e)f.glEnabledAttribLocs[e]!==f.glCurrentAttribLocs[e]&&(d.disableVertexAttribArray(e),f.glEnabledAttribLocs[e]=!1)}}if(e&&e.dynamicStates.length){const t=e.dynamicStates.length;for(let n=0;n<t;n++)switch(e.dynamicStates[n]){case rr.VIEWPORT:o&&(f.viewport.left===o.left&&f.viewport.top===o.top&&f.viewport.width===o.width&&f.viewport.height===o.height||(d.viewport(o.left,o.top,o.width,o.height),f.viewport.left=o.left,f.viewport.top=o.top,f.viewport.width=o.width,f.viewport.height=o.height));break;case rr.SCISSOR:r&&(f.scissorRect.x===r.x&&f.scissorRect.y===r.y&&f.scissorRect.width===r.width&&f.scissorRect.height===r.height||(d.scissor(r.x,r.y,r.width,r.height),f.scissorRect.x=r.x,f.scissorRect.y=r.y,f.scissorRect.width=r.width,f.scissorRect.height=r.height));break;case rr.LINE_WIDTH:a&&f.rs.lineWidth!==a&&(d.lineWidth(a),f.rs.lineWidth=a);break;case rr.DEPTH_BIAS:c&&(f.rs.depthBias===c.constantFactor&&f.rs.depthBiasSlop===c.slopeFactor||(d.polygonOffset(c.constantFactor,c.slopeFactor),f.rs.depthBias=c.constantFactor,f.rs.depthBiasSlop=c.slopeFactor));break;case rr.BLEND_CONSTANTS:f.bs.blendColor.x===l[0]&&f.bs.blendColor.y===l[1]&&f.bs.blendColor.z===l[2]&&f.bs.blendColor.w===l[3]||(d.blendColor(l[0],l[1],l[2],l[3]),[f.bs.blendColor.x,f.bs.blendColor.y,f.bs.blendColor.z,f.bs.blendColor.w]=l);break;case rr.STENCIL_WRITE_MASK:if(_)switch(_.face){case ar.FRONT:f.dss.stencilWriteMaskFront!==_.writeMask&&(d.stencilMaskSeparate(d.FRONT,_.writeMask),f.dss.stencilWriteMaskFront=_.writeMask);break;case ar.BACK:f.dss.stencilWriteMaskBack!==_.writeMask&&(d.stencilMaskSeparate(d.BACK,_.writeMask),f.dss.stencilWriteMaskBack=_.writeMask);break;case ar.ALL:f.dss.stencilWriteMaskFront===_.writeMask&&f.dss.stencilWriteMaskBack===_.writeMask||(d.stencilMask(_.writeMask),f.dss.stencilWriteMaskFront=_.writeMask,f.dss.stencilWriteMaskBack=_.writeMask)}break;case rr.STENCIL_COMPARE_MASK:if(u)switch(u.face){case ar.FRONT:f.dss.stencilRefFront===u.reference&&f.dss.stencilReadMaskFront===u.compareMask||(d.stencilFuncSeparate(d.FRONT,lI[f.dss.stencilFuncFront],u.reference,u.compareMask),f.dss.stencilRefFront=u.reference,f.dss.stencilReadMaskFront=u.compareMask);break;case ar.BACK:f.dss.stencilRefBack===u.reference&&f.dss.stencilReadMaskBack===u.compareMask||(d.stencilFuncSeparate(d.BACK,lI[f.dss.stencilFuncBack],u.reference,u.compareMask),f.dss.stencilRefBack=u.reference,f.dss.stencilReadMaskBack=u.compareMask);break;case ar.ALL:f.dss.stencilRefFront===u.reference&&f.dss.stencilReadMaskFront===u.compareMask&&f.dss.stencilRefBack===u.reference&&f.dss.stencilReadMaskBack===u.compareMask||(d.stencilFunc(lI[f.dss.stencilFuncBack],u.reference,u.compareMask),f.dss.stencilRefFront=u.reference,f.dss.stencilReadMaskFront=u.compareMask,f.dss.stencilRefBack=u.reference,f.dss.stencilReadMaskBack=u.compareMask)}}}}function CI(t,e){const{gl:n}=t,i=t.ANGLE_instanced_arrays,{gpuInputAssembler:s,glPrimitive:o}=TI;if(s)if(s.gpuIndirectBuffer){const t=s.gpuIndirectBuffer.indirects.length;for(let e=0;e<t;e++){const t=s.gpuIndirectBuffer.indirects[e],r=s.gpuIndexBuffer;if(t.instanceCount&&i)if(r){if(t.indexCount>0){const e=t.firstIndex*r.stride;i.drawElementsInstancedANGLE(o,t.indexCount,s.glIndexType,e,t.instanceCount)}}else t.vertexCount>0&&i.drawArraysInstancedANGLE(o,t.firstVertex,t.vertexCount,t.instanceCount);else if(r){if(t.indexCount>0){const e=t.firstIndex*r.stride;n.drawElements(o,t.indexCount,s.glIndexType,e)}}else t.vertexCount>0&&n.drawArrays(o,t.firstVertex,t.vertexCount)}}else{const t=s.gpuIndexBuffer;if(e.instanceCount&&i)if(t){if(e.indexCount>0){const n=e.firstIndex*t.stride;i.drawElementsInstancedANGLE(o,e.indexCount,s.glIndexType,n,e.instanceCount)}}else e.vertexCount>0&&i.drawArraysInstancedANGLE(o,e.firstVertex,e.vertexCount,e.instanceCount);else if(t){if(e.indexCount>0){const i=e.firstIndex*t.stride;n.drawElements(o,e.indexCount,s.glIndexType,i)}}else e.vertexCount>0&&n.drawArrays(o,e.firstVertex,e.vertexCount)}}const bI=new Array(dI.COUNT);function PI(t,e){bI.fill(0);for(let n=0;n<e.cmds.length;++n){const i=e.cmds.array[n],s=bI[i]++;switch(i){case dI.BEGIN_RENDER_PASS:{const n=e.beginRenderPassCmds.array[s];EI(t,n.gpuRenderPass,n.gpuFramebuffer,n.renderArea,n.clearColors,n.clearDepth,n.clearStencil);break}case dI.BIND_STATES:{const n=e.bindStatesCmds.array[s];AI(t,n.gpuPipelineState,n.gpuInputAssembler,n.gpuDescriptorSets,n.dynamicOffsets,n.viewport,n.scissor,n.lineWidth,n.depthBias,n.blendConstants,n.depthBounds,n.stencilWriteMask,n.stencilCompareMask);break}case dI.DRAW:CI(t,e.drawCmds.array[s].drawInfo);break;case dI.UPDATE_BUFFER:{const n=e.updateBufferCmds.array[s];SI(t,n.gpuBuffer,n.buffer,n.offset,n.size);break}case dI.COPY_BUFFER_TO_TEXTURE:{const n=e.copyBufferToTextureCmds.array[s];wI(t,n.buffers,n.gpuTexture,n.regions);break}}}}function wI(t,e,n,i){const{gl:s}=t,o=t.stateCache.glTexUnits[t.stateCache.texUnit];o.glTexture!==n.glTexture&&(s.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);let r=0,a=1,c=1,l=0;const h=ha[n.format],{isCompressed:_}=h;switch(n.glTarget){case s.TEXTURE_2D:for(let o=0;o<i.length;o++){const l=i[o];a=l.texExtent.width,c=l.texExtent.height;const h=e[r++];_?n.glInternalFmt===YD.COMPRESSED_RGB_ETC1_WEBGL||t.noCompressedTexSubImage2D?s.compressedTexImage2D(s.TEXTURE_2D,l.texSubres.mipLevel,n.glInternalFmt,a,c,0,h):s.compressedTexSubImage2D(s.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,a,c,n.glFormat,h):s.texSubImage2D(s.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,a,c,n.glFormat,n.glType,h)}break;case s.TEXTURE_CUBE_MAP:for(let o=0;o<i.length;o++){const h=i[o],u=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(l=h.texSubres.baseArrayLayer;l<u;++l){a=h.texExtent.width,c=h.texExtent.height;const i=e[r++];_?n.glInternalFmt===YD.COMPRESSED_RGB_ETC1_WEBGL||t.noCompressedTexSubImage2D?s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,h.texSubres.mipLevel,n.glInternalFmt,a,c,0,i):s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,a,c,n.glFormat,i):s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,a,c,n.glFormat,n.glType,i)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Go.GEN_MIPMAP&&s.generateMipmap(n.glTarget)}class DI extends wa{constructor(...t){super(...t),this._gpuBuffer=null,this._gpuBufferView=null,this._uniformBuffer=null}get gpuBuffer(){return this._gpuBuffer}get gpuBufferView(){return this._gpuBufferView}initialize(t){if("buffer"in t){this._isBufferView=!0;const e=t.buffer;this._usage=e.usage,this._memUsage=e.memUsage,this._size=this._stride=t.range,this._count=1,this._flags=e.flags,this._gpuBufferView={gpuBuffer:e.gpuBuffer,offset:t.offset,range:t.range}}else this._usage=t.usage,this._memUsage=t.memUsage,this._size=t.size,this._stride=Math.max(t.stride||this._size,1),this._count=this._size/this._stride,this._flags=t.flags,this._usage&Lo.INDIRECT&&(this._indirectBuffer=new Ir),this._usage&Lo.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:[],glTarget:0,glBuffer:null},t.usage&Lo.INDIRECT&&(this._gpuBuffer.indirects=this._indirectBuffer.drawInfos),this._usage&Lo.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(t,e){const{gl:n}=t,i=t.stateCache,s=e.memUsage&zo.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(e.usage&Lo.VERTEX){e.glTarget=n.ARRAY_BUFFER;const o=n.createBuffer();o&&(e.glBuffer=o,e.size>0&&(t.useVAO&&i.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=TI.gpuInputAssembler=null),t.stateCache.glArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer),n.bufferData(n.ARRAY_BUFFER,e.size,s),n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null))}else if(e.usage&Lo.INDEX){e.glTarget=n.ELEMENT_ARRAY_BUFFER;const o=n.createBuffer();o&&(e.glBuffer=o,e.size>0&&(t.useVAO&&i.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=TI.gpuInputAssembler=null),t.stateCache.glElementArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.size,s),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null))}else e.usage&Lo.UNIFORM?(e.glTarget=n.NONE,e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer))):(e.usage&Lo.INDIRECT||e.usage&Lo.TRANSFER_DST||e.usage&Lo.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=n.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size;return!0}destroy(){var t,e;this._gpuBuffer&&(t=this._device,(e=this._gpuBuffer).glBuffer&&(t.gl.deleteBuffer(e.glBuffer),e.glBuffer=null),this._device.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)}resize(t){if(this._isBufferView)return void console.warn("cannot resize buffer views!");const e=this._size;e!==t&&(this._size=t,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(t)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=t,t>0&&(function(t,e){const{gl:n}=t,i=t.stateCache,s=e.memUsage&zo.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;e.usage&Lo.VERTEX?(t.useVAO&&i.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=TI.gpuInputAssembler=null),t.stateCache.glArrayBuffer!==e.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,e.glBuffer),e.buffer?n.bufferData(n.ARRAY_BUFFER,e.buffer,s):n.bufferData(n.ARRAY_BUFFER,e.size,s),n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null):e.usage&Lo.INDEX?(t.useVAO&&i.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=TI.gpuInputAssembler=null),t.stateCache.glElementArrayBuffer!==e.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.glBuffer),e.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.buffer,s):n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.size,s),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):e.usage&Lo.UNIFORM?e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer)):(e.usage&Lo.INDIRECT||e.usage&Lo.TRANSFER_DST||e.usage&Lo.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=n.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=e,this._device.memoryStatus.bufferSize+=t)))}update(t,e){if(this._isBufferView)return void console.warn("cannot update through buffer views!");let n;n=void 0!==e?e:this._usage&Lo.INDIRECT?0:t.byteLength,SI(this._device,this._gpuBuffer,t,0,n)}}class II{constructor(t,e){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(e),this._freeCmds=new Dn(e);for(let n=0;n<e;++n)this._frees[n]=new t;this._freeIdx=e-1}alloc(t){if(this._freeIdx<0){const e=2*this._frees.length,n=this._frees;this._frees=new Array(e);const i=e-n.length;for(let e=0;e<i;++e)this._frees[e]=new t;for(let t=i,s=0;t<e;++t,++s)this._frees[t]=n[s];this._freeIdx+=i}const e=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++e.refCount,e}free(t){0==--t.refCount&&this._freeCmds.push(t)}freeCmds(t){for(let e=0;e<t.length;++e)0==--t.array[e].refCount&&this._freeCmds.push(t.array[e])}release(){for(let t=0;t<this._freeCmds.length;++t){const e=this._freeCmds.array[t];e.clear(),this._frees[++this._freeIdx]=e}this._freeCmds.clear()}}class RI{constructor(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new II(fI,1),this.bindStatesCmdPool=new II(mI,1),this.drawCmdPool=new II(gI,1),this.updateBufferCmdPool=new II(vI,1),this.copyBufferToTextureCmdPool=new II(yI,1)}clearCmds(t){t.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(t.beginRenderPassCmds),t.beginRenderPassCmds.clear()),t.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(t.bindStatesCmds),t.bindStatesCmds.clear()),t.drawCmds.length&&(this.drawCmdPool.freeCmds(t.drawCmds),t.drawCmds.clear()),t.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(t.updateBufferCmds),t.updateBufferCmds.clear()),t.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(t.copyBufferToTextureCmds),t.copyBufferToTextureCmds.clear()),t.cmds.clear()}releaseCmds(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}class OI extends Da{constructor(...t){super(...t),this.cmdPackage=new xI,this._webGLAllocator=null,this._isInRenderPass=!1,this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets=[],this._curDynamicOffsets=[],this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants=[],this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._isStateInvalied=!1}initialize(t){this._type=t.type,this._queue=t.queue,this._webGLAllocator=this._device.cmdAllocator;const e=this._device.bindingMappingInfo.bufferOffsets.length;for(let t=0;t<e;t++)this._curGPUDescriptorSets.push(null),this._curDynamicOffsets.push([]);return!0}destroy(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._webGLAllocator=null)}begin(t,e=0,n){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0;for(let t=0;t<this._curDynamicOffsets.length;t++)this._curDynamicOffsets[t].length=0;this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants.length=0,this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0}end(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}beginRenderPass(t,e,n,i,s,o){const r=this._webGLAllocator.beginRenderPassCmdPool.alloc(fI);r.gpuRenderPass=t.gpuRenderPass,r.gpuFramebuffer=e.gpuFramebuffer,r.renderArea=n,r.clearColors.length=i.length;for(let t=0;t<i.length;++t)r.clearColors[t]=i[t];r.clearDepth=s,r.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(r),this.cmdPackage.cmds.push(dI.BEGIN_RENDER_PASS),this._isInRenderPass=!0}endRenderPass(){this._isInRenderPass=!1}bindPipelineState(t){const e=t.gpuPipelineState;e!==this._curGPUPipelineState&&(this._curGPUPipelineState=e,this._isStateInvalied=!0)}bindDescriptorSet(t,e,n){const i=e.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[t]&&(this._curGPUDescriptorSets[t]=i,this._isStateInvalied=!0),n){const e=this._curDynamicOffsets[t];for(let t=0;t<n.length;t++)e[t]=n[t];e.length=n.length,this._isStateInvalied=!0}}bindInputAssembler(t){const e=t.gpuInputAssembler;this._curGPUInputAssembler=e,this._isStateInvalied=!0}setViewport(t){this._curViewport?this._curViewport.left===t.left&&this._curViewport.top===t.top&&this._curViewport.width===t.width&&this._curViewport.height===t.height&&this._curViewport.minDepth===t.minDepth&&this._curViewport.maxDepth===t.maxDepth||(this._curViewport.left=t.left,this._curViewport.top=t.top,this._curViewport.width=t.width,this._curViewport.height=t.height,this._curViewport.minDepth=t.minDepth,this._curViewport.maxDepth=t.maxDepth,this._isStateInvalied=!0):this._curViewport=new Er(t.left,t.top,t.width,t.height,t.minDepth,t.maxDepth)}setScissor(t){this._curScissor?this._curScissor.x===t.x&&this._curScissor.y===t.y&&this._curScissor.width===t.width&&this._curScissor.height===t.height||(this._curScissor.x=t.x,this._curScissor.y=t.y,this._curScissor.width=t.width,this._curScissor.height=t.height,this._isStateInvalied=!0):this._curScissor=new mr(t.x,t.y,t.width,t.height)}setLineWidth(t){this._curLineWidth!==t&&(this._curLineWidth=t,this._isStateInvalied=!0)}setDepthBias(t,e,n){this._curDepthBias?this._curDepthBias.constantFactor===t&&this._curDepthBias.clamp===e&&this._curDepthBias.slopeFactor===n||(this._curDepthBias.constantFactor=t,this._curDepthBias.clamp=e,this._curDepthBias.slopeFactor=n,this._isStateInvalied=!0):(this._curDepthBias={constantFactor:t,clamp:e,slopeFactor:n},this._isStateInvalied=!0)}setBlendConstants(t){4!==t.length||this._curBlendConstants[0]===t[0]&&this._curBlendConstants[1]===t[1]&&this._curBlendConstants[2]===t[2]&&this._curBlendConstants[3]===t[3]||(this._curBlendConstants.length=0,Array.prototype.push.apply(this._curBlendConstants,t),this._isStateInvalied=!0)}setDepthBound(t,e){this._curDepthBounds&&this._curDepthBounds.minBounds===t&&this._curDepthBounds.maxBounds===e||(this._curDepthBounds={minBounds:t,maxBounds:e},this._isStateInvalied=!0)}setStencilWriteMask(t,e){this._curStencilWriteMask?this._curStencilWriteMask.face===t&&this._curStencilWriteMask.writeMask===e||(this._curStencilWriteMask.face=t,this._curStencilWriteMask.writeMask=e,this._isStateInvalied=!0):(this._curStencilWriteMask={face:t,writeMask:e},this._isStateInvalied=!0)}setStencilCompareMask(t,e,n){this._curStencilCompareMask?this._curStencilCompareMask.face===t&&this._curStencilCompareMask.reference===e&&this._curStencilCompareMask.compareMask===n||(this._curStencilCompareMask.face=t,this._curStencilCompareMask.reference=e,this._curStencilCompareMask.compareMask=n,this._isStateInvalied=!0):(this._curStencilCompareMask={face:t,reference:e,compareMask:n},this._isStateInvalied=!0)}draw(t){if(this._type===hr.PRIMARY&&this._isInRenderPass||this._type===hr.SECONDARY){this._isStateInvalied&&this.bindStates();const e=this._webGLAllocator.drawCmdPool.alloc(gI);e.drawInfo.vertexCount=t.vertexCount,e.drawInfo.firstVertex=t.firstVertex,e.drawInfo.indexCount=t.indexCount,e.drawInfo.firstIndex=t.firstIndex,e.drawInfo.vertexOffset=t.vertexOffset,e.drawInfo.instanceCount=t.instanceCount,e.drawInfo.firstInstance=t.firstInstance,this.cmdPackage.drawCmds.push(e),this.cmdPackage.cmds.push(dI.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;const n=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}updateBuffer(t,e,n){if(this._type===hr.PRIMARY&&!this._isInRenderPass||this._type===hr.SECONDARY){const i=t.gpuBuffer;if(i){const s=this._webGLAllocator.updateBufferCmdPool.alloc(vI);let o=0,r=null;t.usage&Lo.INDIRECT||(o=void 0!==n?n:e.byteLength),r=e,s.gpuBuffer=i,s.buffer=r,s.offset=0,s.size=o,this.cmdPackage.updateBufferCmds.push(s),this.cmdPackage.cmds.push(dI.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}copyBuffersToTexture(t,e,n){if(this._type===hr.PRIMARY&&!this._isInRenderPass||this._type===hr.SECONDARY){const i=e.gpuTexture;if(i){const e=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(yI);e&&(e.gpuTexture=i,e.regions=n,e.buffers=t,this.cmdPackage.copyBufferToTextureCmds.push(e),this.cmdPackage.cmds.push(dI.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}execute(t,e){for(let n=0;n<e;++n){const e=t[n];for(let t=0;t<e.cmdPackage.beginRenderPassCmds.length;++t){const n=e.cmdPackage.beginRenderPassCmds.array[t];++n.refCount,this.cmdPackage.beginRenderPassCmds.push(n)}for(let t=0;t<e.cmdPackage.bindStatesCmds.length;++t){const n=e.cmdPackage.bindStatesCmds.array[t];++n.refCount,this.cmdPackage.bindStatesCmds.push(n)}for(let t=0;t<e.cmdPackage.drawCmds.length;++t){const n=e.cmdPackage.drawCmds.array[t];++n.refCount,this.cmdPackage.drawCmds.push(n)}for(let t=0;t<e.cmdPackage.updateBufferCmds.length;++t){const n=e.cmdPackage.updateBufferCmds.array[t];++n.refCount,this.cmdPackage.updateBufferCmds.push(n)}for(let t=0;t<e.cmdPackage.copyBufferToTextureCmds.length;++t){const n=e.cmdPackage.copyBufferToTextureCmds.array[t];++n.refCount,this.cmdPackage.copyBufferToTextureCmds.push(n)}this.cmdPackage.cmds.concat(e.cmdPackage.cmds.array),this._numDrawCalls+=e._numDrawCalls,this._numInstances+=e._numInstances,this._numTris+=e._numTris}}pipelineBarrier(t,e){}get webGLDevice(){return this._device}bindStates(){const t=this._webGLAllocator.bindStatesCmdPool.alloc(mI);if(t){t.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(t.gpuDescriptorSets,this._curGPUDescriptorSets);for(let e=0;e<this._curDynamicOffsets.length;e++)Array.prototype.push.apply(t.dynamicOffsets,this._curDynamicOffsets[e]);t.gpuInputAssembler=this._curGPUInputAssembler,t.viewport=this._curViewport,t.scissor=this._curScissor,t.lineWidth=this._curLineWidth,t.depthBias=this._curDepthBias,Array.prototype.push.apply(t.blendConstants,this._curBlendConstants),t.depthBounds=this._curDepthBounds,t.stencilWriteMask=this._curStencilWriteMask,t.stencilCompareMask=this._curStencilCompareMask,this.cmdPackage.bindStatesCmds.push(t),this.cmdPackage.cmds.push(dI.BIND_STATES),this._isStateInvalied=!1}}}class MI extends Ra{constructor(...t){super(...t),this._gpuFramebuffer=null}get gpuFramebuffer(){return this._gpuFramebuffer}initialize(t){this._renderPass=t.renderPass,this._colorTextures=t.colorTextures||[],this._depthStencilTexture=t.depthStencilTexture||null,0!==t.depthStencilMipmapLevel&&console.warn("The mipmap level of th texture image to be attached of depth stencil attachment should be 0. Convert to 0.");for(let e=0;e<t.colorMipmapLevels.length;++e)0!==t.colorMipmapLevels[e]&&console.warn(`The mipmap level of th texture image to be attached of color attachment ${e} should be 0. Convert to 0.`);const e=[];for(let n=0;n<t.colorTextures.length;++n){const i=t.colorTextures[n];i&&e.push(i.gpuTexture)}let n=null;return t.depthStencilTexture&&(n=t.depthStencilTexture.gpuTexture),this._gpuFramebuffer={gpuRenderPass:t.renderPass.gpuRenderPass,gpuColorTextures:e,gpuDepthStencilTexture:n,glFramebuffer:null},function(t,e){if(!e.gpuColorTextures.length&&!e.gpuDepthStencilTexture)return;const{gl:n}=t,i=[],s=n.createFramebuffer();if(s){e.glFramebuffer=s,t.stateCache.glFramebuffer!==e.glFramebuffer&&n.bindFramebuffer(n.FRAMEBUFFER,e.glFramebuffer);for(let t=0;t<e.gpuColorTextures.length;++t){const s=e.gpuColorTextures[t];s&&(s.glTexture?n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0+t,s.glTarget,s.glTexture,0):n.framebufferRenderbuffer(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0+t,n.RENDERBUFFER,s.glRenderbuffer),i.push(n.COLOR_ATTACHMENT0+t))}const o=e.gpuDepthStencilTexture;if(o){const t=ha[o.format].hasStencil?n.DEPTH_STENCIL_ATTACHMENT:n.DEPTH_ATTACHMENT;o.glTexture?n.framebufferTexture2D(n.FRAMEBUFFER,t,o.glTarget,o.glTexture,0):n.framebufferRenderbuffer(n.FRAMEBUFFER,t,n.RENDERBUFFER,o.glRenderbuffer)}t.WEBGL_draw_buffers&&t.WEBGL_draw_buffers.drawBuffersWEBGL(i);const r=n.checkFramebufferStatus(n.FRAMEBUFFER);if(r!==n.FRAMEBUFFER_COMPLETE)switch(r){case n.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case n.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case n.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case n.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}t.stateCache.glFramebuffer!==e.glFramebuffer&&n.bindFramebuffer(n.FRAMEBUFFER,t.stateCache.glFramebuffer)}}(this._device,this._gpuFramebuffer),!0}destroy(){var t,e;this._gpuFramebuffer&&(t=this._device,(e=this._gpuFramebuffer).glFramebuffer&&(t.gl.deleteFramebuffer(e.glFramebuffer),e.glFramebuffer=null),this._gpuFramebuffer=null)}}class NI extends La{constructor(...t){super(...t),this._gpuInputAssembler=null}get gpuInputAssembler(){return this._gpuInputAssembler}initialize(t){if(0===t.vertexBuffers.length)return console.error("InputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=t.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=t.vertexBuffers,t.indexBuffer)this._indexBuffer=t.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._firstIndex=0;else{const t=this._vertexBuffers[0];this._vertexCount=t.size/t.stride,this._firstVertex=0,this._vertexOffset=0}this._instanceCount=0,this._firstInstance=0,this._indirectBuffer=t.indirectBuffer||null;const e=new Array(t.vertexBuffers.length);for(let n=0;n<t.vertexBuffers.length;++n){const i=t.vertexBuffers[n];i.gpuBuffer&&(e[n]=i.gpuBuffer)}let n=null,i=0;if(t.indexBuffer&&(n=t.indexBuffer.gpuBuffer,n))switch(n.stride){case 1:i=5121;break;case 2:i=5123;break;case 4:i=5125;break;default:console.error("Error index buffer stride.")}let s=null;return t.indirectBuffer&&(s=t.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:t.attributes,gpuVertexBuffers:e,gpuIndexBuffer:n,gpuIndirectBuffer:s,glAttribs:[],glIndexType:i,glVAOs:new Map},function(t,e){const{gl:n}=t;e.glAttribs=new Array(e.attributes.length);const i=[0,0,0,0,0,0,0,0];for(let t=0;t<e.attributes.length;++t){const s=e.attributes[t],o=void 0!==s.stream?s.stream:0,r=e.gpuVertexBuffers[o],a=eI(s.format,n),{size:c}=ha[s.format];e.glAttribs[t]={name:s.name,glBuffer:r.glBuffer,glType:a,size:c,count:ha[s.format].count,stride:r.stride,componentCount:cI(a,n),isNormalized:void 0!==s.isNormalized&&s.isNormalized,isInstanced:void 0!==s.isInstanced&&s.isInstanced,offset:i[o]},i[o]+=c}}(this._device,this._gpuInputAssembler),!0}destroy(){const t=this._device;this._gpuInputAssembler&&t.useVAO&&function(t,e){const n=e.glVAOs.values();let i=n.next();for(;!i.done;)t.OES_vertex_array_object.deleteVertexArrayOES(i.value),i=n.next();e.glVAOs.clear()}(t,this._gpuInputAssembler),this._gpuInputAssembler=null}}class LI extends Ba{constructor(...t){super(...t),this._gpuDescriptorSetLayout=null}get gpuDescriptorSetLayout(){return this._gpuDescriptorSetLayout}initialize(t){Array.prototype.push.apply(this._bindings,t.bindings);let e=0,n=-1;const i=[];for(let t=0;t<this._bindings.length;t++){const s=this._bindings[t];i.push(e),e+=s.count,s.binding>n&&(n=s.binding)}this._bindingIndices=Array(n+1).fill(-1);const s=this._descriptorIndices=Array(n+1).fill(-1);for(let t=0;t<this._bindings.length;t++){const e=this._bindings[t];this._bindingIndices[e.binding]=t,s[e.binding]=i[t]}const o=[];for(let t=0;t<this._bindings.length;t++){const e=this._bindings[t];if(e.descriptorType&da)for(let t=0;t<e.count;t++)o.push(e.binding)}return this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:o,descriptorIndices:s,descriptorCount:e},!0}destroy(){this._bindings.length=0}}class BI extends Fa{constructor(...t){super(...t),this._gpuPipelineLayout=null}get gpuPipelineLayout(){return this._gpuPipelineLayout}initialize(t){Array.prototype.push.apply(this._setLayouts,t.setLayouts);const e=[],n=[];let i=0;for(let t=0;t<this._setLayouts.length;t++){const s=this._setLayouts[t],o=s.gpuDescriptorSetLayout.dynamicBindings,r=Array(s.bindingIndices.length).fill(-1);for(let t=0;t<o.length;t++){const e=o[t];r[e]<0&&(r[e]=i+t)}n.push(s.gpuDescriptorSetLayout),e.push(r),i+=o.length}return this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:e,dynamicOffsetCount:i},!0}destroy(){this._setLayouts.length=0}}class FI{constructor(t=!1,e=ir.FILL,n=sr.GOURAND,i=or.BACK,s=!0,o=!1,r=0,a=0,c=0,l=!0,h=!1,_=1){this.isDiscard=t,this.polygonMode=e,this.shadeModel=n,this.cullMode=i,this.isFrontFaceCCW=s,this.depthBiasEnabled=o,this.depthBias=r,this.depthBiasClamp=a,this.depthBiasSlop=c,this.isDepthClip=l,this.isMultisample=h,this.lineWidth=_}reset(){this.isDiscard=!1,this.polygonMode=ir.FILL,this.shadeModel=sr.GOURAND,this.cullMode=or.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1}assign(t){Object.assign(this,t)}get handle(){return 0}destroy(){}}class zI{constructor(t=!0,e=!0,n=ko.LESS,i=!1,s=ko.ALWAYS,o=65535,r=65535,a=qo.KEEP,c=qo.KEEP,l=qo.KEEP,h=1,_=!1,u=ko.ALWAYS,d=65535,p=65535,f=qo.KEEP,m=qo.KEEP,g=qo.KEEP,v=1){this.depthTest=t,this.depthWrite=e,this.depthFunc=n,this.stencilTestFront=i,this.stencilFuncFront=s,this.stencilReadMaskFront=o,this.stencilWriteMaskFront=r,this.stencilFailOpFront=a,this.stencilZFailOpFront=c,this.stencilPassOpFront=l,this.stencilRefFront=h,this.stencilTestBack=_,this.stencilFuncBack=u,this.stencilReadMaskBack=d,this.stencilWriteMaskBack=p,this.stencilFailOpBack=f,this.stencilZFailOpBack=m,this.stencilPassOpBack=g,this.stencilRefBack=v}reset(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=ko.LESS,this.stencilTestFront=!1,this.stencilFuncFront=ko.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=qo.KEEP,this.stencilZFailOpFront=qo.KEEP,this.stencilPassOpFront=qo.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=ko.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=qo.KEEP,this.stencilZFailOpBack=qo.KEEP,this.stencilPassOpBack=qo.KEEP,this.stencilRefBack=1}assign(t){Object.assign(this,t)}get handle(){return 0}destroy(){}}class UI{constructor(t=!1,e=Xo.ONE,n=Xo.ZERO,i=Yo.ADD,s=Xo.ONE,o=Xo.ZERO,r=Yo.ADD,a=Ko.ALL){this.blend=t,this.blendSrc=e,this.blendDst=n,this.blendEq=i,this.blendSrcAlpha=s,this.blendDstAlpha=o,this.blendAlphaEq=r,this.blendColorMask=a}reset(){this.blend=!1,this.blendSrc=Xo.ONE,this.blendDst=Xo.ZERO,this.blendEq=Yo.ADD,this.blendSrcAlpha=Xo.ONE,this.blendDstAlpha=Xo.ZERO,this.blendAlphaEq=Yo.ADD,this.blendColorMask=Ko.ALL}assign(t){Object.assign(this,t)}get handle(){return 0}destroy(){}}class HI{constructor(t=!1,e=!1,n=new Ar,i=[new UI]){this.isA2C=t,this.isIndepend=e,this.blendColor=n,this.targets=i}setTarget(t,e){let n=this.targets[t];n||(n=this.targets[t]=new UI),Object.assign(n,e)}reset(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()}get handle(){return 0}destroy(){}}class GI extends ca{get shader(){return this._shader}get pipelineLayout(){return this._pipelineLayout}get primitive(){return this._primitive}get rasterizerState(){return this._rs}get depthStencilState(){return this._dss}get blendState(){return this._bs}get inputState(){return this._is}get dynamicStates(){return this._dynamicStates}get renderPass(){return this._renderPass}constructor(t){super(Po.PIPELINE_STATE),this._device=void 0,this._shader=null,this._pipelineLayout=null,this._primitive=er.TRIANGLE_LIST,this._is=null,this._rs=new FI,this._dss=new zI,this._bs=new HI,this._dynamicStates=rr.NONE,this._renderPass=null,this._device=t}}const VI=[0,1,3,2,0,0,0,4,5,6,0,0,0,0];class jI extends GI{constructor(...t){super(...t),this._gpuPipelineState=null}get gpuPipelineState(){return this._gpuPipelineState}initialize(t){this._primitive=t.primitive,this._shader=t.shader,this._pipelineLayout=t.pipelineLayout;const e=this._bs;if(t.blendState){const n=t.blendState,{targets:i}=n;i&&i.forEach(((t,n)=>{e.setTarget(n,t)})),void 0!==n.isA2C&&(e.isA2C=n.isA2C),void 0!==n.isIndepend&&(e.isIndepend=n.isIndepend),void 0!==n.blendColor&&(e.blendColor=n.blendColor)}Object.assign(this._rs,t.rasterizerState),Object.assign(this._dss,t.depthStencilState),this._is=t.inputState,this._renderPass=t.renderPass,this._dynamicStates=t.dynamicStates;const n=[];for(let t=0;t<31;t++)this._dynamicStates&1<<t&&n.push(1<<t);return this._gpuPipelineState={glPrimitive:VI[t.primitive],gpuShader:t.shader.gpuShader,gpuPipelineLayout:t.pipelineLayout.gpuPipelineLayout,rs:t.rasterizerState,dss:t.depthStencilState,bs:t.blendState,gpuRenderPass:t.renderPass.gpuRenderPass,dynamicStates:n},!0}destroy(){this._gpuPipelineState=null}}const WI=[];class kI extends OI{beginRenderPass(t,e,n,i,s,o){EI(this._device,t.gpuRenderPass,e.gpuFramebuffer,n,i,s,o),this._isInRenderPass=!0}draw(t){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates(),CI(this._device,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;const e=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=e/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(e-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}updateBuffer(t,e,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{const i=t.gpuBuffer;if(i){let s;s=void 0!==n?n:t.usage&Lo.INDIRECT?0:e.byteLength,SI(this._device,i,e,0,s)}}}copyBuffersToTexture(t,e,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{const i=e.gpuTexture;i&&wI(this._device,t,i,n)}}execute(t,e){for(let n=0;n<e;++n){const e=t[n];PI(this._device,e.cmdPackage),this._numDrawCalls+=e._numDrawCalls,this._numInstances+=e._numInstances,this._numTris+=e._numTris}}bindStates(){WI.length=0;for(let t=0;t<this._curDynamicOffsets.length;t++)Array.prototype.push.apply(WI,this._curDynamicOffsets[t]);AI(this._device,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,WI,this._curViewport,this._curScissor,this._curLineWidth,this._curDepthBias,this._curBlendConstants,this._curDepthBounds,this._curStencilWriteMask,this._curStencilCompareMask),this._isStateInvalied=!1}}class qI extends za{constructor(...t){super(...t),this.numDrawCalls=0,this.numInstances=0,this.numTris=0}initialize(t){return this._type=t.type,!0}destroy(){}submit(t){if(!this._isAsync){const e=t.length;for(let n=0;n<e;n++){const e=t[n];this.numDrawCalls+=e.numDrawCalls,this.numInstances+=e.numInstances,this.numTris+=e.numTris}}}clear(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0}}class XI extends Ua{constructor(...t){super(...t),this._gpuRenderPass=null}get gpuRenderPass(){return this._gpuRenderPass}initialize(t){return this._colorInfos=t.colorAttachments,this._depthStencilInfo=t.depthStencilAttachment,t.subpasses&&(this._subpasses=t.subpasses),this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash(),!0}destroy(){this._gpuRenderPass=null}}const YI=[10497,33648,33071,33071];class KI extends Ha{constructor(...t){super(...t),this._gpuSampler=null}get gpuSampler(){return this._gpuSampler}initialize(t){this._minFilter=t.minFilter,this._magFilter=t.magFilter,this._mipFilter=t.mipFilter,this._addressU=t.addressU,this._addressV=t.addressV,this._addressW=t.addressW,this._maxAnisotropy=t.maxAnisotropy,this._cmpFunc=t.cmpFunc,this._borderColor=t.borderColor,this._mipLODBias=t.mipLODBias;let e=0,n=0;const i=this._minFilter,s=this._magFilter,o=this._mipFilter;e=i===jo.LINEAR||i===jo.ANISOTROPIC?o===jo.LINEAR||o===jo.ANISOTROPIC?9987:o===jo.POINT?9985:9729:o===jo.LINEAR||o===jo.ANISOTROPIC?9986:o===jo.POINT?9984:9728,n=s===jo.LINEAR||s===jo.ANISOTROPIC?9729:9728;const r=YI[this._addressU],a=YI[this._addressV],c=YI[this._addressW];return this._gpuSampler={glMinFilter:e,glMagFilter:n,glWrapS:r,glWrapT:a,glWrapR:c},!0}destroy(){this._gpuSampler=null}}class $I extends Ga{constructor(...t){super(...t),this._gpuShader=null}get gpuShader(){return this._gpuShader}initialize(t){this._name=t.name,this._stages=t.stages,this._attributes=t.attributes,this._blocks=t.blocks,this._samplers=t.samplers,this._gpuShader={name:t.name,blocks:t.blocks,samplerTextures:t.samplerTextures,gpuStages:new Array(t.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(let e=0;e<t.stages.length;++e){const n=t.stages[e];this._gpuShader.gpuStages[e]={type:n.stage,source:n.source,glShader:null}}return function(t,e){const{gl:n}=t;for(let t=0;t<e.gpuStages.length;t++){const i=e.gpuStages[t];let s=0,o="",r=1;switch(i.type){case $o.VERTEX:o="VertexShader",s=n.VERTEX_SHADER;break;case $o.FRAGMENT:o="FragmentShader",s=n.FRAGMENT_SHADER;break;default:return void console.error("Unsupported ShaderType.")}const a=n.createShader(s);if(a&&(i.glShader=a,n.shaderSource(i.glShader,i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(`${o} in '${e.name}' compilation failed.`),console.error("Shader source dump:",i.source.replace(/^|\n/g,(()=>`\n${r++} `))),console.error(n.getShaderInfoLog(i.glShader));for(let i=0;i<e.gpuStages.length;i++){const i=e.gpuStages[t];i.glShader&&(n.deleteShader(i.glShader),i.glShader=null)}return}}const i=n.createProgram();if(!i)return;e.glProgram=i;for(let t=0;t<e.gpuStages.length;t++){const i=e.gpuStages[t];n.attachShader(e.glProgram,i.glShader)}if(n.linkProgram(e.glProgram),t.destroyShadersImmediately)for(let t=0;t<e.gpuStages.length;t++){const i=e.gpuStages[t];i.glShader&&(n.detachShader(e.glProgram,i.glShader),n.deleteShader(i.glShader),i.glShader=null)}if(!n.getProgramParameter(e.glProgram,n.LINK_STATUS))return console.error(`Failed to link shader '${e.name}'.`),void console.error(n.getProgramInfoLog(e.glProgram));console.info(`Shader '${e.name}' compilation succeeded.`);const s=n.getProgramParameter(e.glProgram,n.ACTIVE_ATTRIBUTES);e.glInputs=new Array(s);for(let t=0;t<s;++t){const i=n.getActiveAttrib(e.glProgram,t);if(i){let s;const o=i.name.indexOf("[");s=-1!==o?i.name.substr(0,o):i.name;const r=n.getAttribLocation(e.glProgram,s),a=rI(i.type,n),c=aI(i.type,n);e.glInputs[t]={binding:r,name:s,type:a,stride:c,count:i.size,size:c*i.size,glType:i.type,glLoc:r}}}if(e.blocks.length>0){e.glBlocks=new Array(e.blocks.length);for(let t=0;t<e.blocks.length;++t){const i=e.blocks[t],s={set:i.set,binding:i.binding,name:i.name,size:0,glUniforms:new Array(i.members.length),glActiveUniforms:[]};e.glBlocks[t]=s;for(let t=0;t<i.members.length;++t){const e=i.members[t],o=sI(e.type,n),r=oI(e.type),a=aI(o,n),c=a*e.count,l=s.size/4,h=new r(c/4);s.glUniforms[t]={binding:-1,name:e.name,type:e.type,stride:a,count:e.count,size:c,offset:s.size,glType:o,glLoc:-1,array:h,begin:l},s.size+=c}}}if(e.samplerTextures.length>0){e.glSamplerTextures=new Array(e.samplerTextures.length);for(let t=0;t<e.samplerTextures.length;++t){const i=e.samplerTextures[t];e.glSamplerTextures[t]={set:i.set,binding:i.binding,name:i.name,type:i.type,count:i.count,units:[],glUnits:null,glType:sI(i.type,n),glLoc:null}}}const o=n.getProgramParameter(e.glProgram,n.ACTIVE_UNIFORMS);for(let t=0;t<o;++t){const i=n.getActiveUniform(e.glProgram,t);if(i&&i.type!==n.SAMPLER_2D&&i.type!==n.SAMPLER_CUBE){const t=n.getUniformLocation(e.glProgram,i.name);if(null!==t&&("number"==typeof t||-1!==t.id)){let n;const s=i.name.indexOf("[");n=-1!==s?i.name.substr(0,s):i.name;for(let i=0;i<e.glBlocks.length;i++){const s=e.glBlocks[i];for(let e=0;e<s.glUniforms.length;e++){const i=s.glUniforms[e];if(i.name===n){i.glLoc=t,s.glActiveUniforms.push(i);break}}}}}}const r=[],a=[],{bindingMappingInfo:c}=t,{texUnitCacheMap:l}=t.stateCache;let h=0;for(let t=0;t<e.blocks.length;++t)e.blocks[t].set===c.flexibleSet&&h++;let _=0;for(let i=0;i<e.samplerTextures.length;++i){const s=e.samplerTextures[i],o=n.getUniformLocation(e.glProgram,s.name);if(null===o||"number"!=typeof o&&-1===o.id||(r.push(e.glSamplerTextures[i]),a.push(o)),void 0===l[s.name]){let e=s.binding+c.samplerOffsets[s.set]+_;s.set===c.flexibleSet&&(e-=h),l[s.name]=e%t.capabilities.maxTextureUnits,_+=s.count-1}}if(r.length){const i=[];for(let e=0;e<r.length;++e){const n=r[e];let s=l[n.name];if(void 0!==s){n.glLoc=a[e];for(let e=0;e<n.count;++e){for(;i[s];)s=(s+1)%t.capabilities.maxTextureUnits;n.units.push(s),i[s]=!0}}}let s=0;for(let e=0;e<r.length;++e){const n=r[e];if(!n.glLoc){n.glLoc=a[e];for(let e=0;e<n.count;++e){for(;i[s];)s=(s+1)%t.capabilities.maxTextureUnits;void 0===l[n.name]&&(l[n.name]=s),n.units.push(s),i[s]=!0}}}t.stateCache.glProgram!==e.glProgram&&n.useProgram(e.glProgram);for(let t=0;t<r.length;t++){const e=r[t];e.glUnits=new Int32Array(e.units),n.uniform1iv(e.glLoc,e.glUnits)}t.stateCache.glProgram!==e.glProgram&&n.useProgram(t.stateCache.glProgram)}for(let t=0;t<e.glBlocks.length;)e.glBlocks[t].glActiveUniforms.length?t++:(e.glBlocks[t]=e.glBlocks[e.glBlocks.length-1],e.glBlocks.length--);e.glSamplerTextures=r}(this._device,this._gpuShader),!0}destroy(){this._gpuShader&&(function(t,e){if(e.glProgram){const{gl:n}=t;if(!t.destroyShadersImmediately)for(let t=0;t<e.gpuStages.length;t++){const i=e.gpuStages[t];i.glShader&&(n.detachShader(e.glProgram,i.glShader),n.deleteShader(i.glShader),i.glShader=null)}n.deleteProgram(e.glProgram),e.glProgram=null}}(this._device,this._gpuShader),this._gpuShader=null)}}class ZI{constructor(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new Er,this.scissorRect=new mr(0,0,0,0),this.rs=new FI,this.dss=new zI,this.bs=new HI,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}initialize(t,e){for(let e=0;e<t;++e)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=e,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=e,this.glCurrentAttribLocs.fill(!1)}}class JI extends Va{constructor(...t){super(...t),this._gpuTexture=null}get gpuTexture(){return this._gpuTexture}initialize(t){return"texture"in t?(console.log("WebGL does not support texture view."),!1):(this._type=t.type,this._usage=t.usage,this._format=t.format,this._width=t.width,this._height=t.height,this._depth=t.depth,this._layerCount=t.layerCount,this._levelCount=t.levelCount,this._samples=t.samples,this._flags=t.flags,this._isPowerOf2=pa(this._width)&&pa(this._height),this._size=ma(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(t,e){const{gl:n}=t;e.glInternalFmt=nI(e.format,n),e.glFormat=iI(e.format,n),e.glType=eI(e.format,n);let i=e.width,s=e.height;switch(e.type){case Uo.TEX2D:{e.glTarget=n.TEXTURE_2D;const o=Math.max(i,s);if(o>t.capabilities.maxTextureSize&&C(9100,o,t.capabilities.maxTextureSize),!t.WEBGL_depth_texture&&ha[e.format].hasDepth){const o=n.createRenderbuffer();o&&e.size>0&&(e.glRenderbuffer=o,t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),e.glInternalFmt===n.DEPTH_COMPONENT&&(e.glInternalFmt=n.DEPTH_COMPONENT16),n.renderbufferStorage(n.RENDERBUFFER,e.glInternalFmt,i,s))}else if(e.samples===Vo.X1){const o=n.createTexture();if(o&&e.size>0){e.glTexture=o;const r=t.stateCache.glTexUnits[t.stateCache.texUnit];if(r.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_2D,e.glTexture),r.glTexture=e.glTexture),ha[e.format].isCompressed)if(e.glInternalFmt!==YD.COMPRESSED_RGB_ETC1_WEBGL)for(let t=0;t<e.mipLevel;++t){const o=fa(e.format,i,s,1),r=new Uint8Array(o);n.compressedTexImage2D(n.TEXTURE_2D,t,e.glInternalFmt,i,s,0,r),i=Math.max(1,i>>1),s=Math.max(1,s>>1)}else{const t=fa(e.format,2,2,1),i=new Uint8Array(t);n.compressedTexImage2D(n.TEXTURE_2D,0,e.glInternalFmt,2,2,0,i)}else for(let t=0;t<e.mipLevel;++t)n.texImage2D(n.TEXTURE_2D,t,e.glInternalFmt,i,s,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),s=Math.max(1,s>>1);e.isPowerOf2?(e.glWrapS=n.REPEAT,e.glWrapT=n.REPEAT):(e.glWrapS=n.CLAMP_TO_EDGE,e.glWrapT=n.CLAMP_TO_EDGE),e.glMinFilter=n.LINEAR,e.glMagFilter=n.LINEAR,n.texParameteri(e.glTarget,n.TEXTURE_WRAP_S,e.glWrapS),n.texParameteri(e.glTarget,n.TEXTURE_WRAP_T,e.glWrapT),n.texParameteri(e.glTarget,n.TEXTURE_MIN_FILTER,e.glMinFilter),n.texParameteri(e.glTarget,n.TEXTURE_MAG_FILTER,e.glMagFilter)}else n.deleteTexture(o)}break}case Uo.CUBE:{e.glTarget=n.TEXTURE_CUBE_MAP;const o=Math.max(i,s);o>t.capabilities.maxCubeMapTextureSize&&C(9100,o,t.capabilities.maxTextureSize);const r=n.createTexture();if(r&&e.size>0){e.glTexture=r;const o=t.stateCache.glTexUnits[t.stateCache.texUnit];if(o.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,e.glTexture),o.glTexture=e.glTexture),ha[e.format].isCompressed)if(e.glInternalFmt!==YD.COMPRESSED_RGB_ETC1_WEBGL)for(let t=0;t<6;++t){i=e.width,s=e.height;for(let o=0;o<e.mipLevel;++o){const r=fa(e.format,i,s,1),a=new Uint8Array(r);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+t,o,e.glInternalFmt,i,s,0,a),i=Math.max(1,i>>1),s=Math.max(1,s>>1)}}else for(let t=0;t<6;++t){const i=fa(e.format,2,2,1),s=new Uint8Array(i);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,e.glInternalFmt,2,2,0,s)}else for(let t=0;t<6;++t){i=e.width,s=e.height;for(let o=0;o<e.mipLevel;++o)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+t,o,e.glInternalFmt,i,s,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),s=Math.max(1,s>>1)}e.isPowerOf2?(e.glWrapS=n.REPEAT,e.glWrapT=n.REPEAT):(e.glWrapS=n.CLAMP_TO_EDGE,e.glWrapT=n.CLAMP_TO_EDGE),e.glMinFilter=n.LINEAR,e.glMagFilter=n.LINEAR,n.texParameteri(e.glTarget,n.TEXTURE_WRAP_S,e.glWrapS),n.texParameteri(e.glTarget,n.TEXTURE_WRAP_T,e.glWrapT),n.texParameteri(e.glTarget,n.TEXTURE_MIN_FILTER,e.glMinFilter),n.texParameteri(e.glTarget,n.TEXTURE_MAG_FILTER,e.glMagFilter)}break}default:console.error("Unsupported TextureType, create texture failed."),e.type=Uo.TEX2D,e.glTarget=n.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,!0)}destroy(){var t,e;this._gpuTexture&&(t=this._device,(e=this._gpuTexture).glTexture&&(t.gl.deleteTexture(e.glTexture),e.glTexture=null),e.glRenderbuffer&&(t.gl.deleteRenderbuffer(e.glRenderbuffer),e.glRenderbuffer=null),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null)}resize(t,e){const n=this._size;this._width=t,this._height=e,this._size=ma(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=t,this._gpuTexture.height=e,this._gpuTexture.size=this._size,function(t,e){const{gl:n}=t;e.glInternalFmt=nI(e.format,n),e.glFormat=iI(e.format,n),e.glType=eI(e.format,n);let i=e.width,s=e.height;switch(e.type){case Uo.TEX2D:{e.glTarget=n.TEXTURE_2D;const o=Math.max(i,s);if(o>t.capabilities.maxTextureSize&&C(9100,o,t.capabilities.maxTextureSize),e.glRenderbuffer)t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,e.glInternalFmt,i,s);else if(e.glTexture){const o=t.stateCache.glTexUnits[t.stateCache.texUnit];if(o.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_2D,e.glTexture),o.glTexture=e.glTexture),ha[e.format].isCompressed){if(e.glInternalFmt!==YD.COMPRESSED_RGB_ETC1_WEBGL)for(let t=0;t<e.mipLevel;++t){const o=fa(e.format,i,s,1),r=new Uint8Array(o);n.compressedTexImage2D(n.TEXTURE_2D,t,e.glInternalFmt,i,s,0,r),i=Math.max(1,i>>1),s=Math.max(1,s>>1)}}else for(let t=0;t<e.mipLevel;++t)n.texImage2D(n.TEXTURE_2D,t,e.glInternalFmt,i,s,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),s=Math.max(1,s>>1)}break}case Uo.CUBE:{e.glTarget=n.TEXTURE_CUBE_MAP;const o=Math.max(i,s);o>t.capabilities.maxCubeMapTextureSize&&C(9100,o,t.capabilities.maxTextureSize);const r=t.stateCache.glTexUnits[t.stateCache.texUnit];if(r.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,e.glTexture),r.glTexture=e.glTexture),ha[e.format].isCompressed){if(e.glInternalFmt!==YD.COMPRESSED_RGB_ETC1_WEBGL)for(let t=0;t<6;++t){i=e.width,s=e.height;for(let o=0;o<e.mipLevel;++o){const r=fa(e.format,i,s,1),a=new Uint8Array(r);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+t,o,e.glInternalFmt,i,s,0,a),i=Math.max(1,i>>1),s=Math.max(1,s>>1)}}}else for(let t=0;t<6;++t){i=e.width,s=e.height;for(let o=0;o<e.mipLevel;++o)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+t,o,e.glInternalFmt,i,s,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),s=Math.max(1,s>>1)}break}default:console.error("Unsupported TextureType, create texture failed."),e.type=Uo.TEX2D,e.glTarget=n.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=n,this._device.memoryStatus.textureSize+=this._size)}}const QI="webglcontextlost";class tR extends Ia{constructor(...t){super(...t),this.stateCache=new ZI,this.cmdAllocator=new RI,this.nullTex2D=null,this.nullTexCube=null,this._webGLRC=null,this._isAntialias=!0,this._isPremultipliedAlpha=!0,this._useVAO=!1,this._destroyShadersImmediately=!0,this._noCompressedTexSubImage2D=!1,this._bindingMappingInfo=new Cr,this._webGLContextLostHandler=null,this._extensions=null,this._EXT_texture_filter_anisotropic=null,this._EXT_blend_minmax=null,this._EXT_frag_depth=null,this._EXT_shader_texture_lod=null,this._EXT_sRGB=null,this._OES_vertex_array_object=null,this._EXT_color_buffer_half_float=null,this._WEBGL_color_buffer_float=null,this._WEBGL_compressed_texture_etc1=null,this._WEBGL_compressed_texture_etc=null,this._WEBGL_compressed_texture_pvrtc=null,this._WEBGL_compressed_texture_astc=null,this._WEBGL_compressed_texture_s3tc=null,this._WEBGL_compressed_texture_s3tc_srgb=null,this._WEBGL_debug_shaders=null,this._WEBGL_draw_buffers=null,this._WEBGL_lose_context=null,this._WEBGL_depth_texture=null,this._WEBGL_debug_renderer_info=null,this._OES_texture_half_float=null,this._OES_texture_half_float_linear=null,this._OES_texture_float=null,this._OES_texture_float_linear=null,this._OES_standard_derivatives=null,this._OES_element_index_uint=null,this._ANGLE_instanced_arrays=null}get gl(){return this._webGLRC}get webGLQueue(){return this._queue}get isAntialias(){return this._isAntialias}get isPremultipliedAlpha(){return this._isPremultipliedAlpha}get useVAO(){return this._useVAO}get destroyShadersImmediately(){return this._destroyShadersImmediately}get noCompressedTexSubImage2D(){return this._noCompressedTexSubImage2D}get bindingMappingInfo(){return this._bindingMappingInfo}get EXT_texture_filter_anisotropic(){return this._EXT_texture_filter_anisotropic}get EXT_blend_minmax(){return this._EXT_blend_minmax}get EXT_frag_depth(){return this._EXT_frag_depth}get EXT_shader_texture_lod(){return this._EXT_shader_texture_lod}get EXT_sRGB(){return this._EXT_sRGB}get OES_vertex_array_object(){return this._OES_vertex_array_object}get WEBGL_color_buffer_float(){return this._WEBGL_color_buffer_float}get WEBGL_compressed_texture_etc1(){return this._WEBGL_compressed_texture_etc1}get WEBGL_compressed_texture_pvrtc(){return this._WEBGL_compressed_texture_pvrtc}get WEBGL_compressed_texture_astc(){return this._WEBGL_compressed_texture_astc}get WEBGL_compressed_texture_s3tc(){return this._WEBGL_compressed_texture_s3tc}get WEBGL_compressed_texture_s3tc_srgb(){return this._WEBGL_compressed_texture_s3tc_srgb}get WEBGL_debug_shaders(){return this._WEBGL_debug_shaders}get WEBGL_draw_buffers(){return this._WEBGL_draw_buffers}get WEBGL_lose_context(){return this._WEBGL_lose_context}get WEBGL_depth_texture(){return this._WEBGL_depth_texture}get WEBGL_debug_renderer_info(){return this._WEBGL_debug_renderer_info}get OES_texture_half_float(){return this._OES_texture_half_float}get OES_texture_half_float_linear(){return this._OES_texture_half_float_linear}get OES_texture_float(){return this._OES_texture_float}get OES_standard_derivatives(){return this._OES_standard_derivatives}get OES_element_index_uint(){return this._OES_element_index_uint}get ANGLE_instanced_arrays(){return this._ANGLE_instanced_arrays}initialize(t){this._canvas=t.canvasElm,this._isAntialias=t.isAntialias,this._isPremultipliedAlpha=t.isPremultipliedAlpha,this._bindingMappingInfo=t.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);try{const t={alpha:Lt.ENABLE_TRANSPARENT_CANVAS,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGLRC=this._canvas.getContext("webgl",t)}catch(t){return console.error(t),!1}if(!this._webGLRC)return console.error("This device does not support WebGL."),!1;this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(QI,this._onWebGLContextLost),this._canvas2D=document.createElement("canvas"),console.info("WebGL device initialized."),this._gfxAPI=Do.WEBGL,this._deviceName="WebGL";const e=this._webGLRC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=e.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=e.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=e.getParameter(e.RENDERER),this._vendor=e.getParameter(e.VENDOR)),this._version=e.getParameter(e.VERSION),this._caps.maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.depthBits=e.getParameter(e.DEPTH_BITS),this._caps.stencilBits=e.getParameter(e.STENCIL_BITS),this.stateCache.initialize(this._caps.maxTextureUnits,this._caps.maxVertexAttributes),this._devicePixelRatio=t.devicePixelRatio||1,this._width=this._canvas.width,this._height=this._canvas.height,this._nativeWidth=Math.max(t.nativeWidth||this._width,0),this._nativeHeight=Math.max(t.nativeHeight||this._height,0),this._colorFmt=Oo.RGBA8,24===this._caps.depthBits?8===this._caps.stencilBits?this._depthStencilFmt=Oo.D24S8:this._depthStencilFmt=Oo.D24:8===this._caps.stencilBits?this._depthStencilFmt=Oo.D16S8:this._depthStencilFmt=Oo.D16,this._extensions=e.getSupportedExtensions();let n="";if(this._extensions){for(const t of this._extensions)n+=`${t} `;console.debug(`EXTENSIONS: ${n}`)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_blend_minmax=this.getExtension("EXT_blend_minmax"),this._EXT_frag_depth=this.getExtension("EXT_frag_depth"),this._EXT_shader_texture_lod=this.getExtension("EXT_shader_texture_lod"),this._EXT_sRGB=this.getExtension("EXT_sRGB"),this._OES_vertex_array_object=this.getExtension("OES_vertex_array_object"),this._EXT_color_buffer_half_float=this.getExtension("EXT_color_buffer_half_float"),this._WEBGL_color_buffer_float=this.getExtension("WEBGL_color_buffer_float"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_draw_buffers=this.getExtension("WEBGL_draw_buffers"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._WEBGL_depth_texture=this.getExtension("WEBGL_depth_texture"),this._OES_texture_half_float=this.getExtension("OES_texture_half_float"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._OES_texture_float=this.getExtension("OES_texture_float"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_standard_derivatives=this.getExtension("OES_standard_derivatives"),this._OES_element_index_uint=this.getExtension("OES_element_index_uint"),this._ANGLE_instanced_arrays=this.getExtension("ANGLE_instanced_arrays"),Qn.os===Xn.IOS&&14===Rp.osMainVersion&&Rp.isBrowser||(this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc")),Qn.browserType===jn.UC&&(this._ANGLE_instanced_arrays=null),Qn.os===Xn.IOS&&Rp.osMainVersion<=10&&(this._destroyShadersImmediately=!1),this._features.fill(!1),this._EXT_blend_minmax&&(this._features[Ro.BLEND_MINMAX]=!0),this._WEBGL_color_buffer_float&&(this._features[Ro.COLOR_FLOAT]=!0),this._EXT_color_buffer_half_float&&(this._features[Ro.COLOR_HALF_FLOAT]=!0),this._OES_texture_float&&(this._features[Ro.TEXTURE_FLOAT]=!0),this._OES_texture_half_float&&(this._features[Ro.TEXTURE_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[Ro.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[Ro.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._features[Ro.FORMAT_RGB8]=!0,this._WEBGL_depth_texture&&(this._features[Ro.FORMAT_D16]=!0,this._features[Ro.FORMAT_D24]=!0,this._features[Ro.FORMAT_D24S8]=!0),this._OES_element_index_uint&&(this._features[Ro.ELEMENT_INDEX_UINT]=!0),this._ANGLE_instanced_arrays&&(this._features[Ro.INSTANCED_ARRAYS]=!0),this._WEBGL_draw_buffers&&(this._features[Ro.MULTIPLE_RENDER_TARGETS]=!0);let i="";this._WEBGL_compressed_texture_etc1&&(this._features[Ro.FORMAT_ETC1]=!0,i+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[Ro.FORMAT_ETC2]=!0,i+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[Ro.FORMAT_DXT]=!0,i+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[Ro.FORMAT_PVRTC]=!0,i+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[Ro.FORMAT_ASTC]=!0,i+="astc "),this._OES_vertex_array_object&&(this._useVAO=!0),console.info(`RENDERER: ${this._renderer}`),console.info(`VENDOR: ${this._vendor}`),console.info(`VERSION: ${this._version}`),console.info(`DPR: ${this._devicePixelRatio}`),console.info(`SCREEN_SIZE: ${this._width} x ${this._height}`),console.info(`NATIVE_SIZE: ${this._nativeWidth} x ${this._nativeHeight}`),console.info(`MAX_VERTEX_UNIFORM_VECTORS: ${this._caps.maxVertexUniformVectors}`),console.info(`DEPTH_BITS: ${this._caps.depthBits}`),console.info(`STENCIL_BITS: ${this._caps.stencilBits}`),this._EXT_texture_filter_anisotropic&&console.info(`MAX_TEXTURE_MAX_ANISOTROPY_EXT: ${this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT}`),console.info(`USE_VAO: ${this._useVAO}`),console.info(`COMPRESSED_FORMAT: ${i}`),this.initStates(e),this._queue=this.createQueue(new oa(lr.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new sa(this._queue)),this.nullTex2D=this.createTexture(new Rr(Uo.TEX2D,Ho.SAMPLED,Oo.RGBA8,2,2,Go.GEN_MIPMAP)),this.nullTexCube=this.createTexture(new Rr(Uo.CUBE,Ho.SAMPLED,Oo.RGBA8,2,2,Go.GEN_MIPMAP,6));const s=new Tr;s.texExtent.width=2,s.texExtent.height=2;const o=new Uint8Array(this.nullTex2D.size);return o.fill(0),this.copyBuffersToTexture([o],this.nullTex2D,[s]),s.texSubres.layerCount=6,this.copyBuffersToTexture([o,o,o,o,o,o],this.nullTexCube,[s]),!0}destroy(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(QI,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null),this._extensions=null,this._webGLRC=null}resize(t,e){this._width===t&&this._height===e||(console.info(`Resizing device: ${t}x${e}`),this._canvas.width=t,this._canvas.height=e,this._width=t,this._height=e)}flushCommands(t){}acquire(){this.cmdAllocator.releaseCmds()}present(){const t=this._queue;this._numDrawCalls=t.numDrawCalls,this._numInstances=t.numInstances,this._numTris=t.numTris,t.clear()}createCommandBuffer(t){const e=new(t.type===hr.PRIMARY?kI:OI)(this);return e.initialize(t),e}createBuffer(t){const e=new DI(this);return e.initialize(t)?e:null}createTexture(t){const e=new JI(this);return e.initialize(t)?e:null}createSampler(t){const e=new KI(this);return e.initialize(t)?e:null}createDescriptorSet(t){const e=new tI(this);return e.initialize(t)?e:null}createShader(t){const e=new $I(this);return e.initialize(t)?e:null}createInputAssembler(t){const e=new NI(this);return e.initialize(t)?e:null}createRenderPass(t){const e=new XI(this);return e.initialize(t)?e:null}createFramebuffer(t){const e=new MI(this);return e.initialize(t)?e:null}createDescriptorSetLayout(t){const e=new LI(this);return e.initialize(t)?e:null}createPipelineLayout(t){const e=new BI(this);return e.initialize(t)?e:null}createPipelineState(t){const e=new jI(this);return e.initialize(t)?e:null}createQueue(t){const e=new qI(this);return e.initialize(t)?e:null}createGlobalBarrier(t){const e=new ja(this);return e.initialize(t)?e:null}createTextureBarrier(t){const e=new Wa(this);return e.initialize(t)?e:null}copyBuffersToTexture(t,e,n){wI(this,t,e.gpuTexture,n)}copyTexImagesToTexture(t,e,n){!function(t,e,n,i){const{gl:s}=t,o=t.stateCache.glTexUnits[t.stateCache.texUnit];o.glTexture!==n.glTexture&&(s.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);let r=0,a=0;switch(n.glTarget){case s.TEXTURE_2D:for(let t=0;t<i.length;t++){const o=i[t];s.texSubImage2D(s.TEXTURE_2D,o.texSubres.mipLevel,o.texOffset.x,o.texOffset.y,n.glFormat,n.glType,e[r++])}break;case s.TEXTURE_CUBE_MAP:for(let t=0;t<i.length;t++){const o=i[t],c=o.texSubres.baseArrayLayer+o.texSubres.layerCount;for(a=o.texSubres.baseArrayLayer;a<c;++a)s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,o.texSubres.mipLevel,o.texOffset.x,o.texOffset.y,n.glFormat,n.glType,e[r++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Go.GEN_MIPMAP&&n.isPowerOf2&&s.generateMipmap(n.glTarget)}(this,t,e.gpuTexture,n)}copyFramebufferToBuffer(t,e,n){const i=this._webGLRC,s=t.gpuFramebuffer,o=s.gpuColorTextures[0].format,r=iI(o,i),a=eI(o,i),c=ya(ha[o]),l=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==s.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,s.glFramebuffer),this.stateCache.glFramebuffer=s.glFramebuffer);const h=new c(e);for(const t of n){const e=t.texExtent.width,n=t.texExtent.height;i.readPixels(t.texOffset.x,t.texOffset.y,e,n,r,a,h)}this.stateCache.glFramebuffer!==l&&(i.bindFramebuffer(i.FRAMEBUFFER,l),this.stateCache.glFramebuffer=l)}blitFramebuffer(t,e,n,i,s){}getExtension(t){const e=["","WEBKIT_","MOZ_"];for(let n=0;n<e.length;++n){const i=this.gl.getExtension(e[n]+t);if(i)return i}return null}initStates(t){t.activeTexture(t.TEXTURE0),t.pixelStorei(t.PACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.bindFramebuffer(t.FRAMEBUFFER,null),t.enable(t.SCISSOR_TEST),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.frontFace(t.CCW),t.disable(t.POLYGON_OFFSET_FILL),t.polygonOffset(0,0),t.enable(t.DEPTH_TEST),t.depthMask(!0),t.depthFunc(t.LESS),t.depthRange(0,1),t.stencilFuncSeparate(t.FRONT,t.ALWAYS,1,65535),t.stencilOpSeparate(t.FRONT,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.FRONT,65535),t.stencilFuncSeparate(t.BACK,t.ALWAYS,1,65535),t.stencilOpSeparate(t.BACK,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.BACK,65535),t.disable(t.STENCIL_TEST),t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.BLEND),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ZERO,t.ONE,t.ZERO),t.colorMask(!0,!0,!0,!0),t.blendColor(0,0,0,0)}_onWebGLContextLost(t){E(11e3),d(t)}}t("WebGLDevice",tR),i.WebGLDevice=tR;const eR=new $e,nR=new pn;function iR(t,e,n,i){const s=n.data;let o=e.acquireBufferBatch(),r=o.byteOffset>>2,a=n.vertexCount,c=o.indicesOffset,l=o.vertexOffset;o.request(a,n.indicesCount)||(o=e.currBufferBatch,a=0,c=0,l=0);const h=o.vData,_=o.iData;t.getWorldMatrix(nR);for(let t=0;t<a;t++){const e=s[t];$e.set(eR,e.x,e.y,0),$e.transformMat4(eR,eR,nR),h[r++]=eR.x,h[r++]=eR.y,h[r++]=eR.z,h[r++]=e.u,h[r++]=e.v,An.toArray(h,i,r),r+=4}for(let t=0,e=a/4;t<e;t++){const e=l+4*t;_[c++]=e,_[c++]=e+1,_[c++]=e+2,_[c++]=e+1,_[c++]=e+3,_[c++]=e+2}}class sR{constructor(t,e){this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;const n=new oR;n.initWithSize(t,e),this._texture=n,this._width=t,this._height=e,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}insertSpriteFrame(t){const e=t.rect,n=t.texture,s=this._innerTextureInfos[n.getId()];let o=e.x,r=e.y;if(s)o+=s.x,r+=s.y;else{const t=n.width,e=n.height;if(this._x+t+2>this._width&&(this._x=2,this._y=this._nexty),this._y+e+2>this._nexty&&(this._nexty=this._y+e+2),this._nexty>this._height)return null;i.internal.dynamicAtlasManager.textureBleeding&&((t<=8||e<=8)&&(this._texture.drawTextureAt(n.image,this._x-1,this._y-1),this._texture.drawTextureAt(n.image,this._x-1,this._y+1),this._texture.drawTextureAt(n.image,this._x+1,this._y-1),this._texture.drawTextureAt(n.image,this._x+1,this._y+1)),this._texture.drawTextureAt(n.image,this._x-1,this._y),this._texture.drawTextureAt(n.image,this._x+1,this._y),this._texture.drawTextureAt(n.image,this._x,this._y-1),this._texture.drawTextureAt(n.image,this._x,this._y+1)),this._texture.drawTextureAt(n.image,this._x,this._y),this._innerTextureInfos[n.getId()]={x:this._x,y:this._y,texture:n},this._count++,o+=this._x,r+=this._y,this._x+=t+2}const a={x:o,y:r,texture:this._texture};return this._innerSpriteFrames.push(t),a}deleteInnerTexture(t){t&&this._innerTextureInfos[t.getId()]&&(delete this._innerTextureInfos[t.getId()],this._count--)}isEmpty(){return this._count<=0}reset(){this._x=2,this._y=2,this._nexty=2;const t=this._innerSpriteFrames;for(let e=0,n=t.length;e<n;e++){const n=t[e];n.isValid&&n._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}}destroy(){this.reset(),this._texture.destroy()}}class oR extends Gd{initWithSize(t,e,n=hu.RGBA8888){this.reset({width:t,height:e,format:n}),this.loaded=!0,this.emit("load")}drawTextureAt(t,e,n){const i=this.getGFXTexture();if(!t||!i)return;const s=this._getGFXDevice();if(!s)return void console.warn("Unable to get device");const o=new Tr;o.texOffset.x=e,o.texOffset.y=n,o.texExtent.width=t.width,o.texExtent.height=t.height,s.copyTexImagesToTexture([t.data],i,[o])}}class rR{constructor(){this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){this._enabled!==t&&(t?(this.reset(),i.director.on(i.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),i.director.off(i.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=t)}get maxAtlasCount(){return this._maxAtlasCount}set maxAtlasCount(t){this._maxAtlasCount=t}get atlasCount(){return this._atlases.length}get textureBleeding(){return this._textureBleeding}set textureBleeding(t){this._textureBleeding=t}get textureSize(){return this._textureSize}set textureSize(t){this._textureSize=t}get maxFrameSize(){return this._maxFrameSize}set maxFrameSize(t){this._maxFrameSize=t}newAtlas(){let t=this._atlases[++this._atlasIndex];return t||(t=new sR(this._textureSize,this._textureSize),this._atlases.push(t)),t}beforeSceneLoad(){this.reset()}insertSpriteFrame(t){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!t||t._original)return null;if(!t.packable)return null;let e=this._atlases[this._atlasIndex];e||(e=this.newAtlas());const n=e.insertSpriteFrame(t);return n||this._atlasIndex===this._maxAtlasCount?n:(e=this.newAtlas(),e.insertSpriteFrame(t))}reset(){for(let t=0,e=this._atlases.length;t<e;t++)this._atlases[t].destroy();this._atlases.length=0,this._atlasIndex=-1}deleteAtlasSpriteFrame(t){if(!t._original)return;const e=t._original._texture;this.deleteAtlasTexture(e)}deleteAtlasTexture(t){if(t)for(let e=this._atlases.length-1;e>=0;e--)this._atlases[e].deleteInnerTexture(t),this._atlases[e].isEmpty()&&(this._atlases[e].destroy(),this._atlases.splice(e,1),this._atlasIndex--)}packToDynamicAtlas(t,e){if(!e._original&&e.packable){const t=this.insertSpriteFrame(e);t&&e._setDynamicAtlasFrame(t)}}}rR.instance=void 0;const aR=t("dynamicAtlasManager",rR.instance=new rR);var cR;i.internal.dynamicAtlasManager=aR;const lR=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}];let hR=t("SpriteFrame",i_("cc.SpriteFrame")(cR=class t extends lu{static createWithImage(e){const n=e instanceof xu?e:new xu(e),i=new Gd;i.image=n;const s=new t;return s.texture=i,s}get insetTop(){return this._capInsets[1]}set insetTop(t){this._capInsets[1]!==t&&(this._capInsets[1]=t,this._texture&&this._calculateSlicedUV())}get insetBottom(){return this._capInsets[3]}set insetBottom(t){this._capInsets[3]!==t&&(this._capInsets[3]=t,this._texture&&this._calculateSlicedUV())}get insetLeft(){return this._capInsets[0]}set insetLeft(t){this._capInsets[0]!==t&&(this._capInsets[0]=t,this._texture&&this._calculateSlicedUV())}get insetRight(){return this._capInsets[2]}set insetRight(t){this._capInsets[2]!==t&&(this._capInsets[2]=t,this._texture&&this._calculateSlicedUV())}get rect(){return this._rect}set rect(t){this._rect.equals(t)||(this._rect.set(t),this._texture&&this._calculateUV())}get originalSize(){return this._originalSize}set originalSize(t){this._originalSize.equals(t)||(this._originalSize.set(t),this._texture&&this._calculateUV())}get offset(){return this._offset}set offset(t){this._offset.set(t)}get rotated(){return this._rotated}set rotated(t){this._rotated!==t&&(this._rotated=t,this._texture&&this._calculateUV())}get texture(){return this._texture}set texture(t){t?this.reset({texture:t},!0):console.warn(`Error Texture in ${this.name}`)}get atlasUuid(){return this._atlasUuid}set atlasUuid(t){this._atlasUuid=t}get width(){return this._texture.width}get height(){return this._texture.height}set _textureSource(t){window.Build?this._texture=t:t&&(this._refreshTexture(t),this._calculateUV())}get flipUVX(){return this._isFlipUVX}set flipUVX(t){this._isFlipUVX=t,this._calculateUV()}get flipUVY(){return this._isFlipUVY}set flipUVY(t){this._isFlipUVY=t,this._calculateUV()}get packable(){return this._packable}set packable(t){this._packable=t}get original(){return this._original}constructor(){super(),this.vertices=null,this.uv=[],this.uvHash=0,this.unbiasUV=[],this.uvSliced=[],this._rect=new Sn,this._offset=new qe,this._originalSize=new yn,this._rotated=!1,this._capInsets=[0,0,0,0],this._atlasUuid="",this._texture=void 0,this._isFlipUVY=!1,this._isFlipUVX=!1,this._original=null,this._packable=!0}textureLoaded(){return this.texture&&this.texture.loaded}isRotated(){return this._rotated}setRotated(t){this.rotated=t}getRect(t){return t?(t.set(this._rect),t):this._rect.clone()}setRect(t){this.rect=t}getOriginalSize(t){return t?(t.set(this._originalSize),t):this._originalSize.clone()}setOriginalSize(t){this.originalSize=t}getOffset(t){return t?(t.set(this._offset),t):this._offset.clone()}setOffset(t){this.offset=t}getGFXTexture(){return this._texture.getGFXTexture()}getGFXSampler(){return this._texture.getGFXSampler()}getHash(){return this._texture.getHash()}getSamplerHash(){return this._texture.getSamplerHash()}reset(t,e=!1){let n=!1;e&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,n=!0),t&&(t.texture&&(this.loaded=!1,this._rect.x=this._rect.y=0,this._rect.width=t.texture.width,this._rect.height=t.texture.height,this._refreshTexture(t.texture),this.checkRect(this._texture)),t.originalSize&&this._originalSize.set(t.originalSize),t.rect&&this._rect.set(t.rect),t.offset&&this._offset.set(t.offset),void 0!==t.borderTop&&(this._capInsets[1]=t.borderTop),void 0!==t.borderBottom&&(this._capInsets[3]=t.borderBottom),void 0!==t.borderLeft&&(this._capInsets[0]=t.borderLeft),void 0!==t.borderRight&&(this._capInsets[2]=t.borderRight),void 0!==t.isRotate&&(this._rotated=!!t.isRotate),void 0!==t.isFlipUv&&(this._isFlipUVY=!!t.isFlipUv),n=!0),n&&this.texture&&this._calculateUV()}checkRect(t){const e=this._rect;let n=e.x,i=e.y;return this._rotated?(n+=e.height,i+=e.width):(n+=e.width,i+=e.height),n>t.width?(C(3300,`${this.name}/${t.name}`,n,t.width),!1):!(i>t.height&&(C(3301,`${this.name}/${t.name}`,i,t.height),1))}onLoaded(){this.loaded=!0,this.emit("load")}destroy(){return this._packable&&aR&&aR.deleteAtlasSpriteFrame(this),super.destroy()}_calculateSlicedUV(){const t=this._rect,e=this.texture,n=e.width,i=e.height,s=this._capInsets[0],o=this._capInsets[2],r=t.width-s-o,a=this._capInsets[1],c=this._capInsets[3],l=t.height-a-c,h=this.uvSliced;if(h.length=0,this._rotated){lR[0].u=t.x/n,lR[1].u=(t.x+c)/n,lR[2].u=(t.x+c+l)/n,lR[3].u=(t.x+t.height)/n,lR[3].v=t.y/i,lR[2].v=(t.y+s)/i,lR[1].v=(t.y+s+r)/i,lR[0].v=(t.y+t.width)/i;for(let t=0;t<4;++t){const e=lR[t];for(let t=0;t<4;++t){const n=lR[3-t];h.push({u:e.u,v:n.v})}}}else{lR[0].u=t.x/n,lR[1].u=(t.x+s)/n,lR[2].u=(t.x+s+r)/n,lR[3].u=(t.x+t.width)/n,lR[3].v=t.y/i,lR[2].v=(t.y+a)/i,lR[1].v=(t.y+a+l)/i,lR[0].v=(t.y+t.height)/i;for(let t=0;t<4;++t){const e=lR[t];for(let t=0;t<4;++t){const n=lR[t];h.push({u:n.u,v:e.v})}}}}_calculateUV(){const t=this._rect,e=this.uv,n=this.unbiasUV,i=this.texture,s=i.width,o=i.height;if(this._rotated){const i=0===s?0:t.x/s,r=0===s?1:(t.x+t.height)/s,a=0===o?0:t.y/o,c=0===o?1:(t.y+t.width)/o;this._isFlipUVX&&this._isFlipUVY?(e[0]=r,e[1]=c,e[2]=r,e[3]=a,e[4]=i,e[5]=c,e[6]=i,e[7]=a):this._isFlipUVX?(e[0]=r,e[1]=a,e[2]=r,e[3]=c,e[4]=i,e[5]=a,e[6]=i,e[7]=c):this._isFlipUVY?(e[0]=i,e[1]=c,e[2]=i,e[3]=a,e[4]=r,e[5]=c,e[6]=r,e[7]=a):(e[0]=i,e[1]=a,e[2]=i,e[3]=c,e[4]=r,e[5]=a,e[6]=r,e[7]=c);const l=0===s?0:t.x/s,h=0===s?1:(t.x+t.height)/s,_=0===o?0:t.y/o,u=0===o?1:(t.y+t.width)/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=h,n[1]=u,n[2]=h,n[3]=_,n[4]=l,n[5]=u,n[6]=l,n[7]=_):this._isFlipUVX?(n[0]=h,n[1]=_,n[2]=h,n[3]=u,n[4]=l,n[5]=_,n[6]=l,n[7]=u):this._isFlipUVY?(n[0]=l,n[1]=u,n[2]=l,n[3]=_,n[4]=h,n[5]=u,n[6]=h,n[7]=_):(n[0]=l,n[1]=_,n[2]=l,n[3]=u,n[4]=h,n[5]=_,n[6]=h,n[7]=u)}else{const i=0===s?0:t.x/s,r=0===s?1:(t.x+t.width)/s,a=0===o?1:(t.y+t.height)/o,c=0===o?0:t.y/o;this._isFlipUVX&&this._isFlipUVY?(e[0]=r,e[1]=c,e[2]=i,e[3]=c,e[4]=r,e[5]=a,e[6]=i,e[7]=a):this._isFlipUVX?(e[0]=r,e[1]=a,e[2]=i,e[3]=a,e[4]=r,e[5]=c,e[6]=i,e[7]=c):this._isFlipUVY?(e[0]=i,e[1]=c,e[2]=r,e[3]=c,e[4]=i,e[5]=a,e[6]=r,e[7]=a):(e[0]=i,e[1]=a,e[2]=r,e[3]=a,e[4]=i,e[5]=c,e[6]=r,e[7]=c);const l=0===s?0:t.x/s,h=0===s?1:(t.x+t.width)/s,_=0===o?1:(t.y+t.height)/o,u=0===o?0:t.y/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=h,n[1]=u,n[2]=l,n[3]=u,n[4]=h,n[5]=_,n[6]=l,n[7]=_):this._isFlipUVX?(n[0]=h,n[1]=_,n[2]=l,n[3]=_,n[4]=h,n[5]=u,n[6]=l,n[7]=u):this._isFlipUVY?(n[0]=l,n[1]=u,n[2]=h,n[3]=u,n[4]=l,n[5]=_,n[6]=h,n[7]=_):(n[0]=l,n[1]=_,n[2]=h,n[3]=_,n[4]=l,n[5]=u,n[6]=h,n[7]=u)}let r="";for(let t=0;t<e.length;t++)r+=e[t];this.uvHash=Na(r,666);const a=this.vertices;if(a){a.nu.length=0,a.nv.length=0;for(let t=0;t<a.u.length;t++)a.nu[t]=a.u[t]/s,a.nv[t]=a.v[t]/o}this._calculateSlicedUV()}_setDynamicAtlasFrame(t){t&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=t.texture,this._rect.x=t.x,this._rect.y=t.y,this._calculateUV())}_resetDynamicAtlasFrame(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())}_checkPackable(){const t=aR;if(!t)return;const e=this._texture;if(!(e instanceof Gd)||e.isCompressed)return void(this._packable=!1);const n=this.width,i=this.height;!e.image||n>t.maxFrameSize||i>t.maxFrameSize?this._packable=!1:e.image&&e.image instanceof HTMLCanvasElement&&(this._packable=!0)}_serialize(t){return null}_deserialize(t,e){const n=t,i=n.rect;i&&(this._rect=new Sn(i.x,i.y,i.width,i.height));const s=n.offset;n.offset&&(this._offset=new qe(s.x,s.y));const o=n.originalSize;n.originalSize&&(this._originalSize=new yn(o.width,o.height)),this._rotated=!!n.rotated,this._name=n.name,this._packable=!!n.packable;const r=n.capInsets;r&&(this._capInsets[0]=r[0],this._capInsets[1]=r[1],this._capInsets[2]=r[2],this._capInsets[3]=r[3]),this.vertices=n.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])}clone(){var e,n,i,s;const o=new t,r=this.vertices;return o.vertices=r?{x:r.x,y:r.y,triangles:r.triangles,nu:null===(e=r.nu)||void 0===e?void 0:e.slice(0),u:null===(n=r.u)||void 0===n?void 0:n.slice(0),nv:null===(i=r.nv)||void 0===i?void 0:i.slice(0),v:null===(s=r.v)||void 0===s?void 0:s.slice(0)}:null,o.uv.splice(0,o.uv.length,...this.uv),o.uvHash=this.uvHash,o.unbiasUV.splice(0,o.unbiasUV.length,...this.unbiasUV),o.uvSliced.splice(0,o.uvSliced.length,...this.uvSliced),o._rect.set(this._rect),o._offset.set(this._offset),o._originalSize.set(this._originalSize),o._rotated=this._rotated,o._capInsets.splice(0,o._capInsets.length,...this._capInsets),o._atlasUuid=this._atlasUuid,o._texture=this._texture,o._isFlipUVX=this._isFlipUVX,o._isFlipUVY=this._isFlipUVY,o}_textureLoaded(){const t=this._texture,e={};let n=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(t)||(e.rect=new Sn(0,0,t.width,t.height),n=!0),(0===this._originalSize.width||0===this._originalSize.height||n)&&(e.originalSize=new yn(t.width,t.height),n=!0),n&&(this.reset(e),this.onLoaded()),this._checkPackable()}_refreshTexture(t){this._texture=t,t.loaded?this._textureLoaded():t.once("load",this._textureLoaded,this)}initDefault(t){super.initDefault(t);const e=new Gd;e.initDefault(),this._refreshTexture(e),this._calculateUV()}validate(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height}})||cR);var _R,uR,dR;i.SpriteFrame=hR;let pR=t("SpriteAtlas",i_("cc.SpriteAtlas")((dR=Yh((uR=class extends lu{constructor(...t){super(...t),Xh(this,"spriteFrames",dR,this)}getTexture(){const t=Object.keys(this.spriteFrames);if(t.length>0){const e=this.spriteFrames[t[0]];return e&&e.texture}return null}getSpriteFrame(t){const e=this.spriteFrames[t];return e?(e.name||(e.name=t),e):null}getSpriteFrames(){const t=[],e=this.spriteFrames;for(const n of Object.keys(e))t.push(e[n]);return t}_serialize(t){}_deserialize(t,e){const n=t;this._name=n.name;const i=n.spriteFrames;this.spriteFrames=Q();for(let t=0;t<i.length;t+=2)e.result.push(this.spriteFrames,i[t],i[t+1],Ct(hR))}}).prototype,"spriteFrames",[c_,m_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Q()}}),_R=uR))||_R);var fR;i.SpriteAtlas=pR;let mR=t("Font",i_("cc.Font")(fR=class extends lu{})||fR);var gR,vR,yR;i.Font=mR;let xR=t("TTFFont",i_("cc.TTFFont")((yR=Yh((vR=class extends mR{constructor(...t){super(...t),Xh(this,"_fontFamily",yR,this)}get _nativeAsset(){return this._fontFamily}set _nativeAsset(t){this._fontFamily=t||"Arial"}get _nativeDep(){return{uuid:this._uuid,__nativeName__:this._native,ext:si(this._native),__isNative__:!0}}}).prototype,"_fontFamily",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Yh(vR.prototype,"_nativeAsset",[M_,R_],Object.getOwnPropertyDescriptor(vR.prototype,"_nativeAsset"),vR.prototype),Yh(vR.prototype,"_nativeDep",[M_],Object.getOwnPropertyDescriptor(vR.prototype,"_nativeDep"),vR.prototype),gR=vR))||gR);var SR,TR,ER,AR,CR,bR,PR,wR;i.TTFFont=xR;class DR{constructor(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0}}class IR{constructor(t){this.letterDefinitions={},this.texture=t}addLetterDefinitions(t,e){this.letterDefinitions[t]=e}cloneLetterDefinition(){const t={};for(const e of Object.keys(this.letterDefinitions)){const n=new DR;ht(n,this.letterDefinitions[e]),t[e]=n}return t}getTexture(){return this.texture}getLetter(t){return this.letterDefinitions[t]}getLetterDefinitionForChar(t,e){const n=t.charCodeAt(0);let i;return i=this.letterDefinitions.hasOwnProperty(n)?this.letterDefinitions[n]:null,i}clear(){this.letterDefinitions={}}}let RR=t("BitmapFont",(SR=i_("cc.BitmapFont"),TR=O_(hR),SR((CR=Yh((AR=class extends mR{constructor(...t){super(...t),Xh(this,"fntDataStr",CR,this),Xh(this,"spriteFrame",bR,this),Xh(this,"fontSize",PR,this),Xh(this,"fntConfig",wR,this)}onLoaded(){const t=this.spriteFrame;!this.fontDefDictionary&&t&&(this.fontDefDictionary=new IR(t.texture));const e=this.fntConfig;if(!e)return void d("The fnt config is not exists!");const n=e.fontDefDictionary;for(const t in n){const e=new DR,i=n[t].rect;e.offsetX=n[t].xOffset,e.offsetY=n[t].yOffset,e.w=i.width,e.h=i.height,e.u=i.x,e.v=i.y,e.textureID=0,e.valid=!0,e.xAdvance=n[t].xAdvance,this.fontDefDictionary.addLetterDefinitions(t,e)}}}).prototype,"fntDataStr",[c_,m_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),bR=Yh(AR.prototype,"spriteFrame",[TR],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),PR=Yh(AR.prototype,"fontSize",[c_,m_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),wR=Yh(AR.prototype,"fntConfig",[c_,m_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ER=AR))||ER));var OR;i.BitmapFont=RR;let MR=t("LabelAtlas",i_("cc.LabelAtlas")(OR=class extends RR{})||OR);i.LabelAtlas=MR;const NR=t("BASELINE_RATIO",.26),LR=t("MIDDLE_RATIO",(NR+1)/2-NR);const BR=new bt(2);BR.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};const FR=new class{constructor(t){this.count=0,this.limit=0,this.datas={},this.limit=t}moveToHead(t){t.next=this.head,t.prev=null,this.head&&(this.head.prev=t),this.head=t,this.tail||(this.tail=t),this.count++,this.datas[t.key]=t}put(t,e){const n=BR.get();if(n.key=t,n.value=e,this.count>=this.limit){const t=this.tail;delete this.datas[t.key],this.count--,this.tail=t.prev,this.tail.next=null,t.prev=null,t.next=null,BR.put(t)}this.moveToHead(n)}remove(t){t.prev?t.prev.next=t.next:this.head=t.next,t.next?t.next.prev=t.prev:this.tail=t.prev,delete this.datas[t.key],this.count--}get(t){const e=this.datas[t];return e?(this.remove(e),this.moveToHead(e),e.value):null}clear(){this.count=0,this.datas={},this.head=null,this.tail=null}has(t){return!!this.datas[t]}delete(t){const e=this.datas[t];this.remove(e)}}(100),zR=/([a-zA-Z0-9--]+|\S)/,UR=/^[!,.:;'}\]%\?>]/,HR=/([a-zA-Z0-9--]+|\S)$/,GR=/[a-zA-Z0-9--]+$/,VR=/^[a-zA-Z0-9--]/;function jR(t){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(t)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(t)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(t)}function WR(t){const e=t.charCodeAt(0);return e>=9&&e<=13||32===e||133===e||160===e||5760===e||e>=8192&&e<=8202||8232===e||8233===e||8239===e||8287===e||12288===e}function kR(t,e,n){const i=`${n||t.font}${e}`,s=FR.get(i);if(null!==s)return s;const o=t.measureText(e),r=o&&o.width||0;return FR.put(i,r),r}function qR(t,e,n){let i=e,s=n;const o=t[e];if(o>="\udc00"&&o<="\udfff"&&i--,void 0!==n)if(n-1!==e){const e=t[n-1];e>="\ud800"&&e<="\udbff"&&s--}else o>="\ud800"&&o<="\udbff"&&s++;return t.substring(i,s)}function XR(t,e,n,i){const s=[];if(0===t.length||n<0)return s.push(""),s;let o=t;for(;e>n&&o.length>1;){let t=o.length*(n/e)|0,r=qR(o,t),a=e-i(r),c=r,l=0,h=0;const _=10;for(;a>n&&h++<_;)t*=n/a,t|=0,r=qR(o,t),a=e-i(r);for(h=0;a<=n&&h++<_;){if(r){const t=zR.exec(r);l=t?t[0].length:1,c=r}t+=l,r=qR(o,t),a=e-i(r)}t-=l,0===t?(t=1,c=qR(o,1)):1===t&&o[0]>="\ud800"&&o[0]<="\udbff"&&(t=2,c=qR(o,2));let u,d=qR(o,0,t);UR.test(c||r)&&(u=HR.exec(d),t-=u?u[0].length:0,0===t&&(t=1),c=qR(o,t),d=qR(o,0,t)),VR.test(c)&&(u=GR.exec(d),u&&d!==u[0]&&(t-=u[0].length,c=qR(o,t),d=qR(o,0,t))),0===s.length?s.push(d):(d=d.trim(),d.length>0&&s.push(d)),o=c||r,e=i(o)}return 0===s.length?s.push(o):(o=o.trim(),o.length>0&&s.push(o)),s}let YR;class KR{constructor(){this.pool=[]}static getInstance(){return YR||(YR=new KR),YR}get(){let t=this.pool.pop();if(!t){const e=document.createElement("canvas"),n=e.getContext("2d");t={canvas:e,context:n}}return t}put(t){this.pool.length>=Lt.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(t)}}t("CanvasPool",KR);const $R=An.WHITE.clone();class ZR{constructor(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0}}const JR=`rgba(255, 255, 255, ${(1/255).toFixed(3)})`;class QR{constructor(t,e){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=t,this.labelInfo=e,this.hash=t.charCodeAt(0)+e.hash}updateRenderData(){this._updateProperties(),this._updateTexture()}destroy(){this.image=null}_updateProperties(){if(this.data=KR.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;const t=kR(this.context,this.char,this.labelInfo.fontDesc),e=2*this.labelInfo.margin+2;this.width=parseFloat(t.toFixed(2))+e,this.height=(1+NR)*this.labelInfo.fontSize+e,this.offsetY=-this.labelInfo.fontSize*NR/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new xu),this.image.reset(this.canvas)}_updateTexture(){if(!this.context||!this.canvas)return;const t=this.context,e=this.labelInfo,n=this.canvas.width,i=this.canvas.height;t.textAlign="center",t.textBaseline="alphabetic",t.clearRect(0,0,n,i),t.fillStyle=JR,t.fillRect(0,0,n,i),t.font=e.fontDesc;const s=e.fontSize,o=n/2,r=i/2+s*LR+0*s,a=e.color;if(t.lineJoin="round",t.fillStyle=`rgba(${a.r}, ${a.g}, ${a.b}, 1)`,e.isOutlined){const n=e.out||$R;t.strokeStyle=`rgba(${n.r}, ${n.g}, ${n.b}, ${n.a/255})`,t.lineWidth=2*e.margin,t.strokeText(this.char,o,r)}t.fillText(this.char,o,r)}}class tO extends Gd{initWithSize(t,e,n=hu.RGBA8888){this.reset({width:t,height:e,format:n}),this.loaded=!0,this.emit("load")}drawTextureAt(t,e,n){const i=this.getGFXTexture();if(!t||!i)return;const s=this._getGFXDevice();if(!s)return void console.warn("Unable to get device");const o=new Tr;o.texOffset.x=e,o.texOffset.y=n,o.texExtent.width=t.width,o.texExtent.height=t.height,s.copyTexImagesToTexture([t.data],i,[o])}}class eO{get width(){return this._width}get height(){return this._height}constructor(t,e){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;const n=new tO;n.initWithSize(t,e),this.fontDefDictionary=new IR(n),this._halfBleed=1,this._width=t,this._height=e,qA.on(kA.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}insertLetterTexture(t){const e=t.image,n=qA.root.device;if(!e||!this.fontDefDictionary||!n)return null;const i=e.width,s=e.height;if(this._x+i+0>this._width&&(this._x=0,this._y=this._nextY),this._y+s>this._nextY&&(this._nextY=this._y+s+0),this._nextY>this._height)return E(12100),null;this.fontDefDictionary.texture.drawTextureAt(e,this._x,this._y),this._dirty=!0;const o=new ZR;return o.u=this._x+this._halfBleed,o.v=this._y+this._halfBleed,o.texture=this.fontDefDictionary.texture,o.valid=!0,o.w=t.width-2,o.h=t.height-2,o.xAdvance=o.w,o.offsetY=t.offsetY,this._x+=i+0,this.fontDefDictionary.addLetterDefinitions(t.hash,o),o}update(){this._dirty&&(this._dirty=!1)}reset(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()}destroy(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)}getTexture(){return this.fontDefDictionary.getTexture()}beforeSceneLoad(){this.clearAllCache()}clearAllCache(){this.destroy();const t=new tO;t.initWithSize(this._width,this._height),this.fontDefDictionary.texture=t}getLetter(t){return this.fontDefDictionary.letterDefinitions[t]}getLetterDefinitionForChar(t,e){const n=t.charCodeAt(0)+e.hash;let i=this.fontDefDictionary.letterDefinitions[n];if(!i){const n=new QR(t,e);n.updateRenderData(),i=this.insertLetterTexture(n),n.destroy()}return i}}const nO={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:An.WHITE.clone(),isOutlined:!1,out:An.WHITE.clone(),margin:0};class iO{constructor(){this.material=null,this.vertexCount=0,this.indicesCount=0}}class sO extends iO{constructor(...t){super(...t),this.vData=null,this.uvDirty=!0,this.vertDirty=!0,this._data=[],this._indices=[],this._pivotX=0,this._pivotY=0,this._width=0,this._height=0}get dataLength(){return this._data.length}set dataLength(t){const e=this._data;if(e.length!==t){const n=e.length;let i=0;for(i=t;i<n;i++)rO.free(e[i]);for(i=n;i<t;i++)e[i]=rO.alloc();e.length=t}}get data(){return this._data}static add(){return aO.add()}static remove(t){const e=aO.data.indexOf(t);-1!==e&&(aO.data[e].clear(),aO.removeAt(e))}updateSizeNPivot(t,e,n,i){t===this._width&&e===this._height&&n===this._pivotX&&i===this._pivotY||(this._width=t,this._height=e,this._pivotX=n,this._pivotY=i,this.vertDirty=!0)}clear(){this._data.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.uvDirty=!0,this.vertDirty=!0,this.material=null,this.vertexCount=0,this.indicesCount=0}}class oO extends iO{constructor(t=9){super(),this.vData=void 0,this.iData=void 0,this.vertexStart=0,this.indicesStart=0,this.byteStart=0,this.byteCount=0,this.lastFilledIndices=0,this.lastFilledVertex=0,this._formatByte=void 0,this._formatByte=t*Float32Array.BYTES_PER_ELEMENT,this.vData=new Float32Array(256*t*Float32Array.BYTES_PER_ELEMENT),this.iData=new Uint16Array(1536)}set formatByte(t){this._formatByte=t}get formatByte(){return this._formatByte}get floatStride(){return this._formatByte>>2}get vDataOffset(){return this.byteCount>>>2}static add(){return cO.add()}static remove(t){const e=cO.data.indexOf(t);-1!==e&&(cO.data[e].reset(),cO.removeAt(e))}request(t,e){const n=this.byteCount+t*this._formatByte;return this.reserve(t,e),this.vertexCount+=t,this.indicesCount+=e,this.byteCount=n,!0}reserve(t,e){const n=this.byteCount+t*this._formatByte,i=this.indicesCount+e;if(t+this.vertexCount>65535)return!1;let s=this.vData.byteLength,o=this.iData.length,r=this.vData.length,a=this.iData.length;if(n>s||i>o){for(;s<n||o<i;)r*=2,a*=2,s=4*r,o=a;this._reallocBuffer(r,a)}return!0}advance(t,e){this.vertexCount+=t,this.indicesCount+=e,this.byteCount+=t*this._formatByte}reset(){this.vertexCount=0,this.indicesCount=0,this.byteCount=0,this.vertexStart=0,this.indicesStart=0,this.byteStart=0,this.lastFilledIndices=0,this.lastFilledVertex=0}_reallocBuffer(t,e){const n=this.vData;this.vData=new Float32Array(t),this.vData.set(n,0);const i=this.iData;this.iData=new Uint16Array(e),this.iData.set(i,0)}}const rO=new Pn((()=>({x:0,y:0,z:0,u:0,v:0,color:An.WHITE.clone()})),128),aO=new wn((()=>new sO),32),cO=new wn((()=>new oO),32);var lO,hO,_O,uO,dO,pO,fO,mO,gO,vO,yO,xO,SO,TO;const EO=new qe,AO=new qe,CO=new pn,bO=new pn,PO=new pn,wO=new pn(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),DO=new Sn;let IO,RO=t("UITransform",(lO=i_("cc.UITransform"),hO=f_(),_O=o_(110),uO=__(),dO=C_(),pO=y_(),fO=C_(),mO=y_(),lO(gO=hO(gO=_O(gO=uO(gO=r_(gO=h_((TO=SO=class t extends Ad{constructor(...t){super(...t),this._priority=0,Xh(this,"_contentSize",yO,this),Xh(this,"_anchorPoint",xO,this)}get contentSize(){return this._contentSize}set contentSize(t){this._contentSize.equals(t)||(this._contentSize.set(t),this.node.emit(Mp.SIZE_CHANGED))}get width(){return this._contentSize.width}set width(t){this._contentSize.width!==t&&(this._contentSize.width=t,this.node.emit(Mp.SIZE_CHANGED))}get height(){return this._contentSize.height}set height(t){this.contentSize.height!==t&&(this._contentSize.height=t,this.node.emit(Mp.SIZE_CHANGED))}get anchorPoint(){return this._anchorPoint}set anchorPoint(t){this._anchorPoint.equals(t)||(this._anchorPoint.set(t),this.node.emit(Mp.ANCHOR_CHANGED,this._anchorPoint))}get anchorX(){return this._anchorPoint.x}set anchorX(t){this._anchorPoint.x!==t&&(this._anchorPoint.x=t,this.node.emit(Mp.ANCHOR_CHANGED,this._anchorPoint))}get anchorY(){return this._anchorPoint.y}set anchorY(t){this._anchorPoint.y!==t&&(this._anchorPoint.y=t,this.node.emit(Mp.ANCHOR_CHANGED,this._anchorPoint))}get priority(){return this._priority}set priority(e){this._priority!==e&&(this.node.getComponent("cc.RenderRoot2D")?E(6706):(this._priority=e,this.node.parent&&t.insertChangeMap(this.node.parent)))}get visibility(){const t=qA.root.batcher2D.getFirstRenderCamera(this.node);return t?t.visibility:0}get cameraPriority(){const t=qA.root.batcher2D.getFirstRenderCamera(this.node);return t?t.priority:0}__preload(){this.node._uiProps.uiTransformComp=this}onLoad(){this.node.parent&&t.insertChangeMap(this.node.parent)}onEnable(){this.node.on(Mp.PARENT_CHANGED,this._parentChanged,this)}onDisable(){this.node.off(Mp.PARENT_CHANGED,this._parentChanged,this)}onDestroy(){this.node._uiProps.uiTransformComp=null}setContentSize(t,e){const n=this._contentSize;if(void 0===e){if((t=t).width===n.width&&t.height===n.height)return;n.width=t.width,n.height=t.height}else{if(t===n.width&&e===n.height)return;n.width=t,n.height=e}this.node.emit(Mp.SIZE_CHANGED)}setAnchorPoint(t,e){const n=this._anchorPoint;if(void 0===e){if((t=t).x===n.x&&t.y===n.y)return;n.x=t.x,n.y=t.y}else{if(t===n.x&&e===n.y)return;n.x=t,n.y=e}this.node.emit(Mp.ANCHOR_CHANGED,this._anchorPoint)}isHit(t,e){const n=this._contentSize.width,s=this._contentSize.height,o=EO,r=AO,a=this._getRenderScene().cameras;for(let c=0;c<a.length;c++){const l=a[c];if(!(l.visibility&this.node.layer))continue;l.node.getWorldRT(CO);const h=CO.m12,_=CO.m13,u=i.visibleRect.center;if(CO.m12=u.x-(CO.m00*h+CO.m04*_),CO.m13=u.y-(CO.m01*h+CO.m05*_),pn.invert(CO,CO),qe.transformMat4(o,t,CO),this.node.getWorldMatrix(PO),pn.invert(CO,PO),pn.strictEquals(CO,wO))continue;qe.transformMat4(r,o,CO),r.x+=this._anchorPoint.x*n,r.y+=this._anchorPoint.y*s;let d=!1;if(r.x>=0&&r.y>=0&&r.x<=n&&r.y<=s&&(d=!0,e&&e.mask)){const t=e.mask;let n=this.node;const i=t?t.length:0;for(let e=0,s=0;n&&s<i;++e,n=n.parent){const i=t[s];if(e===i.index){if(n!==i.comp.node){t.length=s;break}{const t=i.comp;if(t&&t._enabled&&!t.isHit(o)){d=!1;break}s++}}else if(e>i.index){t.length=s;break}}}if(d)return!0}return!1}convertToNodeSpaceAR(t,e){return this.node.getWorldMatrix(PO),pn.invert(CO,PO),e||(e=new $e),$e.transformMat4(e,t,CO)}convertToWorldSpaceAR(t,e){return this.node.getWorldMatrix(PO),e||(e=new $e),$e.transformMat4(e,t,PO)}getBoundingBox(){pn.fromRTS(bO,this.node.getRotation(),this.node.getPosition(),this.node.getScale());const t=this._contentSize.width,e=this._contentSize.height,n=new Sn(-this._anchorPoint.x*t,-this._anchorPoint.y*e,t,e);return n.transformMat4(bO),n}getBoundingBoxToWorld(){return this.node.parent?(this.node.parent.getWorldMatrix(PO),this.getBoundingBoxTo(PO)):this.getBoundingBox()}getBoundingBoxTo(e){pn.fromRTS(bO,this.node.getRotation(),this.node.getPosition(),this.node.getScale());const n=this._contentSize.width,i=this._contentSize.height,s=new Sn(-this._anchorPoint.x*n,-this._anchorPoint.y*i,n,i);if(pn.multiply(PO,e,bO),s.transformMat4(PO),!this.node.children)return s;const o=this.node.children;for(const n of o)if(n&&n.active){const i=n.getComponent(t);if(i){const t=i.getBoundingBoxTo(e);t&&Sn.union(s,s,t)}}return s}getComputeAABB(t){const e=this._contentSize.width,n=this._contentSize.height;DO.set(-this._anchorPoint.x*e,-this._anchorPoint.y*n,e,n),DO.transformMat4(this.node.worldMatrix);const i=DO.x+.5*DO.width,s=DO.y+.5*DO.height,o=this.node.worldPosition.z,r=DO.width/2,a=DO.height/2;return null!=t?($c.set(t,i,s,o,r,a,.001),t):new $c(i,s,o,r,a,.001)}_parentChanged(e){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&t.insertChangeMap(this.node.parent)}static insertChangeMap(e){const n=e.uuid;t.priorityChangeNodeMap.has(n)||t.priorityChangeNodeMap.set(n,e)}static _sortChildrenSibling(t){const e=t.children;e&&e.sort(((t,e)=>{const n=t._uiProps.uiTransformComp,i=e._uiProps.uiTransformComp,s=(n?n._priority:0)-(i?i._priority:0);return 0===s?t.getSiblingIndex()-e.getSiblingIndex():s}))}static _sortSiblings(){t.priorityChangeNodeMap.forEach((e=>{t._sortChildrenSibling(e),e._updateSiblingIndex(),e.emit("childrenSiblingOrderChanged")})),t.priorityChangeNodeMap.clear()}static _cleanChangeMap(){t.priorityChangeNodeMap.clear()}},SO.EventType=Mp,SO.priorityChangeNodeMap=new Map,Yh((vO=TO).prototype,"contentSize",[dO,pO],Object.getOwnPropertyDescriptor(vO.prototype,"contentSize"),vO.prototype),Yh(vO.prototype,"anchorPoint",[fO,mO],Object.getOwnPropertyDescriptor(vO.prototype,"anchorPoint"),vO.prototype),yO=Yh(vO.prototype,"_contentSize",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn(100,100)}}),xO=Yh(vO.prototype,"_anchorPoint",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qe(.5,.5)}}),gO=vO))||gO)||gO)||gO)||gO)||gO)||gO));qA.on(kA.EVENT_AFTER_UPDATE,RO._sortSiblings),qA.on(kA.EVENT_BEFORE_SCENE_LAUNCH,RO._cleanChangeMap),function(t){t[t.DISABLED=0]="DISABLED",t[t.CLEAR=1]="CLEAR",t[t.ENTER_LEVEL=2]="ENTER_LEVEL",t[t.ENABLED=3]="ENABLED",t[t.EXIT_LEVEL=4]="EXIT_LEVEL",t[t.CLEAR_INVERTED=5]="CLEAR_INVERTED",t[t.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(IO||(IO={}));class OO{constructor(){this.stage=IO.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:ko.ALWAYS,stencilMask:65535,writeMask:65535,failOp:qo.KEEP,zFailOp:qo.KEEP,passOp:qo.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}get pattern(){return this._stencilPattern}pushMask(t){this._maskStack.push(t)}clear(t){t.stencilStage=t.inverted?IO.CLEAR_INVERTED:IO.CLEAR}enterLevel(t){t.graphics.stencilStage=t.inverted?IO.ENTER_LEVEL_INVERTED:IO.ENTER_LEVEL}enableMask(){this.stage=IO.ENABLED}exitMask(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=IO.DISABLED:this.stage=IO.ENABLED)}getWriteMask(){return 1<<this._maskStack.length-1}getExitWriteMask(){return 1<<this._maskStack.length}getStencilRef(){let t=0;for(let e=0;e<this._maskStack.length;++e)t+=1<<e;return t}reset(){this._maskStack.length=0,this.stage=IO.DISABLED}destroy(){this.stencilStateMap.forEach((t=>{t.destroy()})),this.stencilStateMap.clear()}getStencilStage(t,e){let n=0,i=!1,s=!1,o=ko.LESS,r=this.stencilStateMap;if(e&&e.passes[0]){const a=e.passes[0].depthStencilState;let c=0,l=0;a.depthTest&&(c=1),a.depthWrite&&(l=1),n=c|l<<1|a.depthFunc<<2|t<<6|this._maskStack.length<<9,i=a.depthTest,s=a.depthWrite,o=a.depthFunc,r=this.stencilStateMapWithDepth}else n=t<<16|this._maskStack.length;if(r&&r.has(n))return r.get(n);this.setStateFromStage(t);const a=new $a(i,s,o,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return r.set(n,a),a}getStencilHash(t){return t<<8|this._maskStack.length}setStateFromStage(t){const e=this._stencilPattern;t===IO.DISABLED?(e.stencilTest=!1,e.func=ko.ALWAYS,e.failOp=qo.KEEP,e.stencilMask=e.writeMask=65535,e.ref=1):(e.stencilTest=!0,t===IO.ENABLED?(e.func=ko.EQUAL,e.failOp=qo.KEEP,e.stencilMask=e.ref=this.getStencilRef(),e.writeMask=this.getWriteMask()):t===IO.CLEAR?(e.func=ko.NEVER,e.failOp=qo.ZERO,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):t===IO.CLEAR_INVERTED||t===IO.ENTER_LEVEL?(e.func=ko.NEVER,e.failOp=qo.REPLACE,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):t===IO.ENTER_LEVEL_INVERTED&&(e.func=ko.NEVER,e.failOp=qo.ZERO,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()))}}var MO,NO,LO,BO,FO,zO,UO,HO,GO,VO,jO,WO,kO,qO,XO,YO,KO,$O;let ZO;t("StencilManager",OO),OO.sharedManager=null,OO.sharedManager=new OO,Mt(Xo),function(t){t[t.ADD_COLOR=0]="ADD_COLOR",t[t.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",t[t.GRAYSCALE=2]="GRAYSCALE",t[t.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",t[t.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(ZO||(ZO=t("InstanceMaterialType",{})));let JO=t("Renderable2D",(MO=i_("cc.Renderable2D"),NO=s_(RO),LO=g_(),BO=O_(kf),FO=O_(kf),zO=C_(),UO=v_(),HO=C_(),GO=y_(),MO(VO=NO(VO=r_(VO=h_(($O=KO=class t extends FP{constructor(...t){super(...t),Xh(this,"_materials",WO,this),Xh(this,"_customMaterial",kO,this),this.stencilStage=IO.DISABLED,Xh(this,"_srcBlendFactor",qO,this),Xh(this,"_dstBlendFactor",XO,this),Xh(this,"_color",YO,this),this._assembler=null,this._postAssembler=null,this._renderData=null,this._renderDataFlag=!0,this._renderFlag=!0,this._delegateSrc=null,this._instanceMaterialType=ZO.ADD_COLOR_AND_TEXTURE,this._blendState=new Ya,this._blendHash=0,this._colorDirty=!0,this._cacheAlpha=1,this._lastParent=null}get sharedMaterials(){return this._materials}set sharedMaterials(t){for(let e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(let e=t.length;e<this._materials.length;e++)this.setMaterial(null,e);this._materials.splice(t.length)}}get customMaterial(){return this._customMaterial}set customMaterial(t){this._customMaterial=t,this.updateMaterial()}updateMaterial(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),void(this._blendHash=-1);const t=this._updateBuiltinMaterial();this.setMaterial(t,0),this._updateBlendFunc()}get srcBlendFactor(){return this._customMaterial&&E(12001),this._srcBlendFactor}set srcBlendFactor(t){this._customMaterial?E(12001):this._srcBlendFactor!==t&&(this._srcBlendFactor=t,this._updateBlendFunc())}get dstBlendFactor(){return this._customMaterial&&E(12001),this._dstBlendFactor}set dstBlendFactor(t){this._customMaterial?E(12001):this._dstBlendFactor!==t&&(this._dstBlendFactor=t,this._updateBlendFunc())}get color(){return this._color}set color(t){this._color.equals(t)||(this._color.set(t),this._colorDirty=!0)}get renderData(){return this._renderData}set delegateSrc(t){this._delegateSrc=t}get blendHash(){return this._blendHash}updateBlendHash(){const t=this._blendState.targets[0].blendDst<<4;this._blendHash=t|this._blendState.targets[0].blendSrc}__preload(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()}onEnable(){this.node.on(Mp.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(Mp.SIZE_CHANGED,this._nodeStateChange,this),this.updateMaterial(),this._renderFlag=this._canRender()}onRestore(){this.updateMaterial(),this._renderFlag=this._canRender()}onDisable(){this.node.off(Mp.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(Mp.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1}onDestroy(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(let t=0;t<this._materialInstances.length;t++)this._materialInstances[t]&&this._materialInstances[t].destroy();this._renderData=null,this._blendState&&this._blendState.destroy()}markForUpdateRenderData(t=!0){if(this._renderFlag=this._canRender(),t&&this._renderFlag){const e=this._renderData;e&&(e.vertDirty=!0),this._renderDataFlag=t}else t||(this._renderDataFlag=t)}requestRenderData(){const t=sO.add();return this._renderData=t,t}destroyRenderData(){this._renderData&&(sO.remove(this._renderData),this._renderData=null)}updateAssembler(t){this._updateColor(),this._renderFlag&&(this._checkAndUpdateRenderData(),this._render(t))}postUpdateAssembler(t){this._renderFlag&&this._postRender(t)}_render(t){}_postRender(t){}_checkAndUpdateRenderData(){this._renderDataFlag&&(this._assembler.updateRenderData(this),this._renderDataFlag=!1)}_canRender(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&this.node._uiProps.opacity>0}_postCanRender(){}_updateColor(){this._updateWorldAlpha(),(this._colorDirty||this._cacheAlpha!==this.node._uiProps.opacity)&&this._renderFlag&&this._assembler&&this._assembler.updateColor&&(this._assembler.updateColor(this),this._cacheAlpha=this.node._uiProps.opacity,this._colorDirty=!1)}_updateWorldAlpha(){let t=this.color.a/255;1===t&&(t=this.node._uiProps.localOpacity),this.node._uiProps.opacity=this.node.parent&&this.node.parent._uiProps?this.node.parent._uiProps.opacity*t:t,this._renderFlag=this._canRender()}_updateBlendFunc(){let t=this._blendState.targets[0];t||(t=new Xa,this._blendState.setTarget(0,t)),t.blendDst===this._dstBlendFactor&&t.blendSrc===this._srcBlendFactor||(t.blend=!0,t.blendDstAlpha=Xo.ONE_MINUS_SRC_ALPHA,t.blendDst=this._dstBlendFactor,t.blendSrc=this._srcBlendFactor),this.updateBlendHash()}getBlendState(){return this._blendState}_nodeStateChange(e){this._renderData&&this.markForUpdateRenderData();for(let e=0;e<this.node.children.length;++e){const n=this.node.children[e].getComponent(t);n&&n.markForUpdateRenderData()}}_updateBuiltinMaterial(){let t;switch(this._instanceMaterialType){case ZO.ADD_COLOR:t=Tp.get("ui-base-material");break;case ZO.GRAYSCALE:t=Tp.get("ui-sprite-gray-material");break;case ZO.USE_ALPHA_SEPARATED:t=Tp.get("ui-sprite-alpha-sep-material");break;case ZO.USE_ALPHA_SEPARATED_AND_GRAY:t=Tp.get("ui-sprite-gray-alpha-sep-material");break;default:t=Tp.get("ui-sprite-material")}return t}_setCacheAlpha(t){this._cacheAlpha=t}},KO.BlendState=Xo,KO.Assembler=null,KO.PostAssembler=null,WO=Yh((jO=$O).prototype,"_materials",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Yh(jO.prototype,"sharedMaterials",[M_,LO],Object.getOwnPropertyDescriptor(jO.prototype,"sharedMaterials"),jO.prototype),kO=Yh(jO.prototype,"_customMaterial",[BO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Yh(jO.prototype,"customMaterial",[FO,zO,UO],Object.getOwnPropertyDescriptor(jO.prototype,"customMaterial"),jO.prototype),Yh(jO.prototype,"color",[HO,GO],Object.getOwnPropertyDescriptor(jO.prototype,"color"),jO.prototype),qO=Yh(jO.prototype,"_srcBlendFactor",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xo.SRC_ALPHA}}),XO=Yh(jO.prototype,"_dstBlendFactor",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xo.ONE_MINUS_SRC_ALPHA}}),YO=Yh(jO.prototype,"_color",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return An.WHITE.clone()}}),VO=jO))||VO)||VO)||VO)||VO));var QO,tM,eM,nM,iM,sM,oM,rM,aM,cM,lM,hM,_M,uM,dM,pM,fM,mM,gM,vM,yM,xM,SM,TM,EM,AM,CM,bM,PM,wM,DM,IM,RM,OM,MM,NM,LM,BM,FM,zM,UM,HM,GM,VM,jM,WM,kM,qM,XM,YM,KM,$M,ZM,JM,QM,tN,eN,nN,iN,sN;let oN,rN,aN,cN;i.internal.Renderable2D=JO,function(t){t[t.LEFT=0]="LEFT",t[t.CENTER=1]="CENTER",t[t.RIGHT=2]="RIGHT"}(oN||(oN=t("HorizontalTextAlignment",{}))),Mt(oN),function(t){t[t.TOP=0]="TOP",t[t.CENTER=1]="CENTER",t[t.BOTTOM=2]="BOTTOM"}(rN||(rN=t("VerticalTextAlignment",{}))),Mt(rN),function(t){t[t.NONE=0]="NONE",t[t.CLAMP=1]="CLAMP",t[t.SHRINK=2]="SHRINK",t[t.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(aN||(aN=t("Overflow",{}))),Mt(aN),function(t){t[t.NONE=0]="NONE",t[t.BITMAP=1]="BITMAP",t[t.CHAR=2]="CHAR"}(cN||(cN=t("CacheMode",{}))),Mt(cN);let lN,hN,_N,uN=t("Label",(QO=i_("cc.Label"),tM=f_(),eM=o_(110),nM=__(),iM=C_(),sM=y_(),oM=O_(oN),rM=C_(),aM=y_(),cM=O_(rN),lM=C_(),hM=y_(),_M=C_(),uM=y_(),dM=C_(),pM=g_(),fM=y_(),mM=C_(),gM=y_(),vM=O_(aN),yM=C_(),xM=y_(),SM=C_(),TM=y_(),EM=O_(mR),AM=C_(),CM=g_(),bM=y_(),PM=C_(),wM=y_(),DM=O_(cN),IM=C_(),RM=y_(),OM=C_(),MM=y_(),NM=C_(),LM=y_(),BM=C_(),FM=y_(),zM=g_(),QO(UM=tM(UM=eM(UM=nM((sN=iN=class t extends JO{get string(){return this._string}set string(t){t+="",this._string!==t&&(this._string=t,this.updateRenderData())}get horizontalAlign(){return this._horizontalAlign}set horizontalAlign(t){this._horizontalAlign!==t&&(this._horizontalAlign=t,this.updateRenderData())}get verticalAlign(){return this._verticalAlign}set verticalAlign(t){this._verticalAlign!==t&&(this._verticalAlign=t,this.updateRenderData())}get actualFontSize(){return this._actualFontSize}set actualFontSize(t){this._actualFontSize=t}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize!==t&&(this._fontSize=t,this.updateRenderData())}get fontFamily(){return this._fontFamily}set fontFamily(t){this._fontFamily!==t&&(this._fontFamily=t,this.updateRenderData())}get lineHeight(){return this._lineHeight}set lineHeight(t){this._lineHeight!==t&&(this._lineHeight=t,this.updateRenderData())}get overflow(){return this._overflow}set overflow(t){this._overflow!==t&&(this._overflow=t,this.updateRenderData())}get enableWrapText(){return this._enableWrapText}set enableWrapText(t){this._enableWrapText!==t&&(this._enableWrapText=t,this.updateRenderData())}get font(){return this._font}set font(t){this._font!==t&&(this._isSystemFontUsed=!t,this._font=t,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}get useSystemFont(){return this._isSystemFontUsed}set useSystemFont(t){this._isSystemFontUsed!==t&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!t,t&&(this.font=null),this._flushAssembler(),this.updateRenderData())}get cacheMode(){return this._cacheMode}set cacheMode(t){this._cacheMode!==t&&(this._cacheMode!==cN.BITMAP||this._font instanceof RR||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===cN.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=t,this.updateRenderData(!0))}get spriteFrame(){return this._texture}get ttfSpriteFrame(){return this._ttfSpriteFrame}get isBold(){return this._isBold}set isBold(t){this._isBold!==t&&(this._isBold=t,this.updateRenderData())}get isItalic(){return this._isItalic}set isItalic(t){this._isItalic!==t&&(this._isItalic=t,this.updateRenderData())}get isUnderline(){return this._isUnderline}set isUnderline(t){this._isUnderline!==t&&(this._isUnderline=t,this.updateRenderData())}get underlineHeight(){return this._underlineHeight}set underlineHeight(t){this._underlineHeight!==t&&(this._underlineHeight=t,this.updateRenderData())}get assemblerData(){return this._assemblerData}get fontAtlas(){return this._fontAtlas}set fontAtlas(t){this._fontAtlas=t}get spacingX(){return this._spacingX}set spacingX(t){this._spacingX!==t&&(this._spacingX=t,this.updateRenderData())}get _bmFontOriginalSize(){return this._font instanceof RR?this._font.fontSize:-1}constructor(){super(),Xh(this,"_string",GM,this),Xh(this,"_horizontalAlign",VM,this),Xh(this,"_verticalAlign",jM,this),Xh(this,"_actualFontSize",WM,this),Xh(this,"_fontSize",kM,this),Xh(this,"_fontFamily",qM,this),Xh(this,"_lineHeight",XM,this),Xh(this,"_overflow",YM,this),Xh(this,"_enableWrapText",KM,this),Xh(this,"_font",$M,this),Xh(this,"_isSystemFontUsed",ZM,this),this._spacingX=0,Xh(this,"_isItalic",JM,this),Xh(this,"_isBold",QM,this),Xh(this,"_isUnderline",tN,this),Xh(this,"_underlineHeight",eN,this),Xh(this,"_cacheMode",nN,this),this._N$file=null,this._texture=null,this._ttfSpriteFrame=null,this._userDefinedFont=null,this._assemblerData=null,this._fontAtlas=null,this._letterTexture=null,this._ttfSpriteFrame=null}onEnable(){super.onEnable(),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this.updateRenderData(!0)}onDisable(){super.onDisable()}onDestroy(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){const t=this._ttfSpriteFrame.texture;if(t&&null===this._ttfSpriteFrame.original){const e=t;e.image&&e.image.destroy(),t.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,super.onDestroy()}updateRenderData(t=!1){this.markForUpdateRenderData(),t&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture())}_render(t){t.commitComp(this,this._texture,this._assembler,null)}_updateColor(){this._font instanceof RR?(this._updateWorldAlpha(),this._colorDirty=!1):(this._updateWorldAlpha(),this._colorDirty?(this.updateRenderData(!1),this._colorDirty=!1):this._cacheAlpha!==this.node._uiProps.opacity&&this._renderFlag&&this._assembler&&this._assembler.updateOpacity&&(this._assembler.updateOpacity(this),this._cacheAlpha=this.node._uiProps.opacity))}_canRender(){if(!super._canRender()||!this._string)return!1;const t=this._font;if(t&&t instanceof RR){const e=t.spriteFrame;if(!e||!e.textureLoaded())return!1}return!0}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)}_applyFontTexture(){const t=this._font;if(t instanceof RR){const e=t.spriteFrame,n=()=>{this._texture=e,this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this)};e&&(e.loaded||e.textureLoaded?n():e.once("load",n,this))}else{if(this.cacheMode===cN.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new hR,this._assemblerData=this._assembler.getAssemblerData();const t=new xu(this._assemblerData.canvas)._texture;this._ttfSpriteFrame.texture=t}this.cacheMode!==cN.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this)}}changeMaterialForDefine(){if(!this._texture)return;let t=!1;if(this.cacheMode!==cN.CHAR){const e=this._texture.texture;if(e instanceof Hu){const n=e.getPixelFormat();t=n===hu.RGBA_ETC1||n===hu.RGB_A_PVRTC_4BPPV1||n===hu.RGB_A_PVRTC_2BPPV1}}this._instanceMaterialType=t?ZO.USE_ALPHA_SEPARATED:ZO.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}},iN.HorizontalAlign=oN,iN.VerticalAlign=rN,iN.Overflow=aN,iN.CacheMode=cN,iN._canvasPool=KR.getInstance(),Yh((HM=sN).prototype,"string",[iM,sM,b_],Object.getOwnPropertyDescriptor(HM.prototype,"string"),HM.prototype),Yh(HM.prototype,"horizontalAlign",[oM,rM,aM],Object.getOwnPropertyDescriptor(HM.prototype,"horizontalAlign"),HM.prototype),Yh(HM.prototype,"verticalAlign",[cM,lM,hM],Object.getOwnPropertyDescriptor(HM.prototype,"verticalAlign"),HM.prototype),Yh(HM.prototype,"fontSize",[_M,uM],Object.getOwnPropertyDescriptor(HM.prototype,"fontSize"),HM.prototype),Yh(HM.prototype,"fontFamily",[dM,pM,fM],Object.getOwnPropertyDescriptor(HM.prototype,"fontFamily"),HM.prototype),Yh(HM.prototype,"lineHeight",[mM,gM],Object.getOwnPropertyDescriptor(HM.prototype,"lineHeight"),HM.prototype),Yh(HM.prototype,"overflow",[vM,yM,xM],Object.getOwnPropertyDescriptor(HM.prototype,"overflow"),HM.prototype),Yh(HM.prototype,"enableWrapText",[SM,TM],Object.getOwnPropertyDescriptor(HM.prototype,"enableWrapText"),HM.prototype),Yh(HM.prototype,"font",[EM,AM,CM,bM],Object.getOwnPropertyDescriptor(HM.prototype,"font"),HM.prototype),Yh(HM.prototype,"useSystemFont",[PM,wM],Object.getOwnPropertyDescriptor(HM.prototype,"useSystemFont"),HM.prototype),Yh(HM.prototype,"cacheMode",[DM,IM,RM],Object.getOwnPropertyDescriptor(HM.prototype,"cacheMode"),HM.prototype),Yh(HM.prototype,"isBold",[OM,MM],Object.getOwnPropertyDescriptor(HM.prototype,"isBold"),HM.prototype),Yh(HM.prototype,"isItalic",[NM,LM],Object.getOwnPropertyDescriptor(HM.prototype,"isItalic"),HM.prototype),Yh(HM.prototype,"isUnderline",[BM,FM],Object.getOwnPropertyDescriptor(HM.prototype,"isUnderline"),HM.prototype),Yh(HM.prototype,"underlineHeight",[zM,m_],Object.getOwnPropertyDescriptor(HM.prototype,"underlineHeight"),HM.prototype),GM=Yh(HM.prototype,"_string",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),VM=Yh(HM.prototype,"_horizontalAlign",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return oN.CENTER}}),jM=Yh(HM.prototype,"_verticalAlign",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rN.CENTER}}),WM=Yh(HM.prototype,"_actualFontSize",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kM=Yh(HM.prototype,"_fontSize",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),qM=Yh(HM.prototype,"_fontFamily",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),XM=Yh(HM.prototype,"_lineHeight",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),YM=Yh(HM.prototype,"_overflow",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return aN.NONE}}),KM=Yh(HM.prototype,"_enableWrapText",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),$M=Yh(HM.prototype,"_font",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ZM=Yh(HM.prototype,"_isSystemFontUsed",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),JM=Yh(HM.prototype,"_isItalic",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),QM=Yh(HM.prototype,"_isBold",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),tN=Yh(HM.prototype,"_isUnderline",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),eN=Yh(HM.prototype,"_underlineHeight",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),nN=Yh(HM.prototype,"_cacheMode",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cN.NONE}}),UM=HM))||UM)||UM)||UM)||UM));!function(t){t[t.BUTT=0]="BUTT",t[t.ROUND=1]="ROUND",t[t.SQUARE=2]="SQUARE"}(lN||(lN={})),Mt(lN),function(t){t[t.BEVEL=0]="BEVEL",t[t.ROUND=1]="ROUND",t[t.MITER=2]="MITER"}(hN||(hN={})),Mt(hN),function(t){t[t.PT_CORNER=1]="PT_CORNER",t[t.PT_LEFT=2]="PT_LEFT",t[t.PT_BEVEL=4]="PT_BEVEL",t[t.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(_N||(_N={})),Mt(_N);const dN=Math.PI,pN=Math.min,fN=Math.max,mN=Math.cos,gN=Math.sin,vN=Math.abs,yN=Math.sign,xN=.5522847493;function SN(t,e,n,i,s){t.moveTo(e-i,n),t.bezierCurveTo(e-i,n+s*xN,e-i*xN,n+s,e,n+s),t.bezierCurveTo(e+i*xN,n+s,e+i,n+s*xN,e+i,n),t.bezierCurveTo(e+i,n-s*xN,e+i*xN,n-s,e,n-s),t.bezierCurveTo(e-i*xN,n-s,e-i,n-s*xN,e-i,n),t.close()}function TN(t,e,n,i,s,o,r,a,c,l,h){let _=0,u=0,d=0,p=0,f=0,m=0,g=0,v=0,y=0,x=0,S=0,T=0,E=0,A=0,C=0,b=0;l>10||(_=.5*(e+i),u=.5*(n+s),d=.5*(i+o),p=.5*(s+r),f=.5*(o+a),m=.5*(r+c),g=.5*(_+d),v=.5*(u+p),E=a-e,A=c-n,C=vN((i-a)*A-(s-c)*E),b=vN((o-a)*A-(r-c)*E),(C+b)*(C+b)<t.tessTol*(E*E+A*A)?t.addPoint(a,c,0===h?h|_N.PT_BEVEL:h):(y=.5*(d+f),x=.5*(p+m),S=.5*(g+y),T=.5*(v+x),TN(t,e,n,_,u,g,v,S,T,l+1,0),TN(t,S,T,y,x,f,m,a,c,l+1,h)))}class EN extends qe{constructor(t,e){super(t,e),this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0,this.reset()}reset(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0}}class AN{constructor(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}reset(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]}}class CN{constructor(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=An.WHITE.clone(),this.lineCap=lN.BUTT,this.strokeColor=An.BLACK.clone(),this.lineJoin=hN.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}moveTo(t,e){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(t,e,_N.PT_CORNER),this._commandX=t,this._commandY=e}lineTo(t,e){this.addPoint(t,e,_N.PT_CORNER),this._commandX=t,this._commandY=e}bezierCurveTo(t,e,n,i,s,o){const r=this._curPath,a=r.points[r.points.length-1];a&&(a.x!==t||a.y!==e||n!==s||i!==o?(TN(this,a.x,a.y,t,e,n,i,s,o,0,_N.PT_CORNER),this._commandX=s,this._commandY=o):this.lineTo(s,o))}quadraticCurveTo(t,e,n,i){const s=this._commandX,o=this._commandY;this.bezierCurveTo(s+2/3*(t-s),o+2/3*(e-o),n+2/3*(t-n),i+2/3*(e-i),n,i)}arc(t,e,n,i,s,o){!function(t,e,n,i,s,o,r){let a=0,c=0,l=0,h=0,_=0,u=0,d=0,p=0,f=0,m=0,g=0,v=0,y=0,x=0,S=0,T=0;if(c=o-s,r=r||!1)if(vN(c)>=2*dN)c=2*dN;else for(;c<0;)c+=2*dN;else if(vN(c)>=2*dN)c=2*-dN;else for(;c>0;)c-=2*dN;for(T=0|fN(1,pN(vN(c)/(.5*dN)+.5,5)),l=c/T/2,h=vN(4/3*(1-mN(l))/gN(l)),r||(h=-h),S=0;S<=T;S++)a=s+c*(S/T),_=mN(a),u=gN(a),d=e+_*i,p=n+u*i,f=-u*i*h,m=_*i*h,0===S?t.moveTo(d,p):t.bezierCurveTo(g+y,v+x,d-f,p-m,d,p),g=d,v=p,y=f,x=m}(this,t,e,n,i,s,o)}ellipse(t,e,n,i){SN(this,t,e,n,i),this._curPath.complex=!1}circle(t,e,n){SN(this,t,e,n,n),this._curPath.complex=!1}rect(t,e,n,i){this.moveTo(t,e),this.lineTo(t+n,e),this.lineTo(t+n,e+i),this.lineTo(t,e+i),this.close(),this._curPath.complex=!1}roundRect(t,e,n,i,s){!function(t,e,n,i,s,o){if(o<.1)t.rect(e,n,i,s);else{const r=pN(o,.5*vN(i))*yN(i),a=pN(o,.5*vN(s))*yN(s);t.moveTo(e,n+a),t.lineTo(e,n+s-a),t.bezierCurveTo(e,n+s-a*(1-xN),e+r*(1-xN),n+s,e+r,n+s),t.lineTo(e+i-r,n+s),t.bezierCurveTo(e+i-r*(1-xN),n+s,e+i,n+s-a*(1-xN),e+i,n+s-a),t.lineTo(e+i,n+a),t.bezierCurveTo(e+i,n+a*(1-xN),e+i-r*(1-xN),n,e+i-r,n),t.lineTo(e+r,n),t.bezierCurveTo(e+r*(1-xN),n,e,n+a*(1-xN),e,n+a),t.close()}}(this,t,e,n,i,s),this._curPath.complex=!1}clear(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;const t=this._renderDataList;for(let e=0,n=t.length;e<n;e++){const n=t[e];n&&oO.remove(n)}this._renderDataList.length=0}close(){this._curPath.closed=!0}requestRenderData(){const t=oO.add();return this._renderDataList.push(t),t}getRenderDataList(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList}addPoint(t,e,n){const i=this._curPath;if(!i)return;const s=this._points,o=i.points;let r=s[this.pointsOffset++];r?(r.x=t,r.y=e):(r=new EN(t,e),s.push(r)),r.flags=n,o.push(r)}_addPath(){const t=this.pathLength;let e=this.paths[t];return e?e.reset():(e=new AN,this.paths.push(e)),this.pathLength++,this._curPath=e,e}}const bN=[new qa(ur.ATTR_POSITION,Oo.RGB32F)],PN=[new qa(ur.ATTR_POSITION,Oo.RGB32F),new qa(ur.ATTR_COLOR,Oo.RGBA32F)],wN=[new qa(ur.ATTR_POSITION,Oo.RGB32F),new qa(ur.ATTR_TEX_COORD,Oo.RG32F),new qa(ur.ATTR_COLOR,Oo.RGBA32F)],DN=[new qa(ur.ATTR_POSITION,Oo.RGB32F),new qa(ur.ATTR_TEX_COORD,Oo.RG32F),new qa(ur.ATTR_COLOR,Oo.RGBA32F),new qa(ur.ATTR_COLOR2,Oo.RGBA32F)];function IN(t){let e=0;for(let n=0;n<t.length;n++){const i=t[n];e+=ha[i.format].count}return e}function RN(t){let e=0;for(let n=0;n<t.length;n++){const i=t[n];e+=ha[i.format].size}return e}var ON,MN,NN,LN,BN,FN,zN,UN,HN,GN,VN,jN,WN,kN,qN,XN,YN,KN,$N,ZN,JN,QN;i.internal.vfmtPosUvColor=wN,i.internal.vfmtPosUvTwoColor=DN;const tL=PN.concat([new qa("a_dist",Oo.R32F)]),eL=IN(tL),nL=RN(tL);let iL=t("Graphics",(ON=i_("cc.Graphics"),MN=f_(),NN=o_(110),LN=__(),BN=O_(hN),FN=y_(),zN=O_(lN),UN=y_(),HN=y_(),GN=y_(),VN=y_(),jN=g_(),ON(WN=MN(WN=NN(WN=LN((QN=JN=class t extends JO{get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t,this.impl&&(this.impl.lineWidth=t)}get lineJoin(){return this._lineJoin}set lineJoin(t){this._lineJoin=t,this.impl&&(this.impl.lineJoin=t)}get lineCap(){return this._lineCap}set lineCap(t){this._lineCap=t,this.impl&&(this.impl.lineCap=t)}get strokeColor(){return this._strokeColor}set strokeColor(t){this.impl&&(this._strokeColor.set(t),this.impl.strokeColor=this._strokeColor)}get fillColor(){return this._fillColor}set fillColor(t){this.impl&&(this._fillColor.set(t),this.impl.fillColor=this._fillColor)}get miterLimit(){return this._miterLimit}set miterLimit(t){this._miterLimit=t}get color(){return this._color}set color(t){this._color!==t&&this._color.set(t)}get srcBlendFactor(){return this._srcBlendFactor}set srcBlendFactor(t){}get dstBlendFactor(){return this._dstBlendFactor}set dstBlendFactor(t){}constructor(){super(),this.impl=null,this.model=null,Xh(this,"_lineWidth",qN,this),Xh(this,"_strokeColor",XN,this),Xh(this,"_lineJoin",YN,this),Xh(this,"_lineCap",KN,this),Xh(this,"_fillColor",$N,this),Xh(this,"_miterLimit",ZN,this),this._isDrawing=!1,this._isNeedUploadData=!0,this._instanceMaterialType=ZO.ADD_COLOR,this.impl=new CN}onRestore(){this.impl||this._flushAssembler()}onLoad(){this.model=qA.root.createModel(km),this.model.node=this.model.transform=this.node,this._flushAssembler()}onEnable(){super.onEnable(),this._updateMtlForGraphics()}onDisable(){super.onDisable()}onDestroy(){super.onDestroy(),this._sceneGetter=null,this.model&&(qA.root.destroyModel(this.model),this.model=null),this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null)}moveTo(t,e){this.impl&&this.impl.moveTo(t,e)}lineTo(t,e){this.impl&&this.impl.lineTo(t,e)}bezierCurveTo(t,e,n,i,s,o){this.impl&&this.impl.bezierCurveTo(t,e,n,i,s,o)}quadraticCurveTo(t,e,n,i){this.impl&&this.impl.quadraticCurveTo(t,e,n,i)}arc(t,e,n,i,s,o){this.impl&&this.impl.arc(t,e,n,i,s,o)}ellipse(t,e,n,i){this.impl&&this.impl.ellipse(t,e,n,i)}circle(t,e,n){this.impl&&this.impl.circle(t,e,n)}rect(t,e,n,i){this.impl&&this.impl.rect(t,e,n,i)}roundRect(t,e,n,i,s){this.impl&&this.impl.roundRect(t,e,n,i,s)}fillRect(t,e,n,i){this.rect(t,e,n,i),this.fill()}clear(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(let t=0;t<this.model.subModels.length;t++)this.model.subModels[t].inputAssembler.indexCount=0;this.markForUpdateRenderData()}}close(){this.impl&&this.impl.close()}stroke(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)}fill(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)}_updateMtlForGraphics(){let t;this._customMaterial?t=this.getMaterialInstance(0):(t=Tp.get("ui-graphics-material"),this.setMaterial(t,0),t=this.getMaterialInstance(0),t.recompileShaders({USE_LOCAL:!0}))}activeSubModel(t){if(this.model){if(this.model.subModels.length<=t){const e=i.director.root.device,n=e.createBuffer(new br(Lo.VERTEX|Lo.TRANSFER_DST,zo.DEVICE,65535*nL,nL)),s=e.createBuffer(new br(Lo.INDEX|Lo.TRANSFER_DST,zo.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),o=new fS([n],tL,er.TRIANGLE_LIST,s);o.subMeshIdx=0,this.model.initSubModel(t,o,this.getMaterialInstance(0))}}else E(4500,this.node.name)}_uploadData(t){const e=this.impl;if(!e)return;const n=e&&e.getRenderDataList();if(n.length<=0||!this.model)return;const i=this.model.subModels;for(let t=0;t<n.length;t++){const e=n[t],s=i[t].inputAssembler;if(e.lastFilledVertex===e.vertexStart)continue;const o=new Float32Array(e.vData.buffer,0,e.vertexStart*eL);s.vertexBuffers[0].update(o),s.vertexCount=e.vertexStart;const r=new Uint16Array(e.iData.buffer,0,e.indicesStart);s.indexBuffer.update(r),s.indexCount=e.indicesStart,e.lastFilledVertex=e.vertexStart,e.lastFilledIndices=e.indicesStart}t.removeUploadBuffersFunc(this),this._isNeedUploadData=!1}_render(t){if(this._isNeedUploadData){if(this.impl){const t=this.impl.getRenderDataList(),e=this.model.subModels.length;if(t.length>e)for(let n=e;n<t.length;n++)this.activeSubModel(n)}t.addUploadBuffersFunc(this,this._uploadData)}t.commitModel(this,this.model,this.getMaterialInstance(0))}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)}_canRender(){return!!super._canRender()&&!!this.model&&this._isDrawing}},JN.LineJoin=hN,JN.LineCap=lN,Yh((kN=QN).prototype,"lineWidth",[m_],Object.getOwnPropertyDescriptor(kN.prototype,"lineWidth"),kN.prototype),Yh(kN.prototype,"lineJoin",[BN,FN],Object.getOwnPropertyDescriptor(kN.prototype,"lineJoin"),kN.prototype),Yh(kN.prototype,"lineCap",[zN,UN],Object.getOwnPropertyDescriptor(kN.prototype,"lineCap"),kN.prototype),Yh(kN.prototype,"strokeColor",[HN],Object.getOwnPropertyDescriptor(kN.prototype,"strokeColor"),kN.prototype),Yh(kN.prototype,"fillColor",[GN],Object.getOwnPropertyDescriptor(kN.prototype,"fillColor"),kN.prototype),Yh(kN.prototype,"miterLimit",[VN],Object.getOwnPropertyDescriptor(kN.prototype,"miterLimit"),kN.prototype),Yh(kN.prototype,"color",[M_,jN],Object.getOwnPropertyDescriptor(kN.prototype,"color"),kN.prototype),qN=Yh(kN.prototype,"_lineWidth",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),XN=Yh(kN.prototype,"_strokeColor",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return An.BLACK.clone()}}),YN=Yh(kN.prototype,"_lineJoin",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hN.MITER}}),KN=Yh(kN.prototype,"_lineCap",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lN.BUTT}}),$N=Yh(kN.prototype,"_fillColor",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return An.WHITE.clone()}}),ZN=Yh(kN.prototype,"_miterLimit",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),WN=kN))||WN)||WN)||WN)||WN));var sL,oL,rL,aL,cL,lL,hL,_L,uL,dL,pL,fL,mL,gL,vL,yL,xL,SL,TL,EL,AL,CL,bL,PL,wL;const DL=new pn,IL=new qe,RL=new pn,OL=[];let ML;!function(t){t[t.RECT=0]="RECT",t[t.ELLIPSE=1]="ELLIPSE",t[t.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",t[t.IMAGE_STENCIL=3]="IMAGE_STENCIL"}(ML||(ML={})),Mt(ML);let NL=t("Mask",(sL=i_("cc.Mask"),oL=f_(),rL=o_(110),aL=__(),cL=O_(ML),lL=C_(),hL=y_(),_L=C_(),uL=y_(),dL=g_(),pL=O_(hR),fL=g_(),mL=g_(),gL=x_(),vL=g_(),yL=g_(),sL(xL=oL(xL=rL(xL=aL((wL=PL=class t extends JO{get type(){return this._type}set type(t){this._type!==t&&(this._type=t,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==ML.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}get inverted(){return this._inverted}set inverted(t){i.game.renderType!==xm.RENDER_TYPE_CANVAS?(this._inverted=t,this.stencilStage=IO.DISABLED,this._graphics&&(this._graphics.stencilStage=IO.DISABLED)):E(4202)}get segments(){return this._segments}set segments(t){this._segments!==t&&(this._segments=De(t,3,1e4),this._updateGraphics())}get spriteFrame(){return this._spriteFrame}set spriteFrame(t){if(this._spriteFrame===t)return;const e=this._spriteFrame;this._spriteFrame=t,this._type===ML.IMAGE_STENCIL&&!e&&t&&this.markForUpdateRenderData()}get alphaThreshold(){return this._alphaThreshold}set alphaThreshold(t){this._alphaThreshold!==t&&(this._alphaThreshold=t,this.type===ML.IMAGE_STENCIL&&this._graphics)&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold)}get graphics(){return this._graphics}get dstBlendFactor(){return this._dstBlendFactor}set dstBlendFactor(t){this._dstBlendFactor!==t&&(this._dstBlendFactor=t,this._updateBlendFunc())}get srcBlendFactor(){return this._srcBlendFactor}set srcBlendFactor(t){this._srcBlendFactor!==t&&(this._srcBlendFactor=t,this._updateBlendFunc())}get color(){return this._color}set color(t){this._color!==t&&(this._color.set(t),this.markForUpdateRenderData())}get customMaterial(){return this._customMaterial}set customMaterial(t){}constructor(){super(),this._clearStencilMtl=null,this._clearModel=null,Xh(this,"_type",TL,this),Xh(this,"_inverted",EL,this),Xh(this,"_segments",AL,this),Xh(this,"_spriteFrame",CL,this),Xh(this,"_alphaThreshold",bL,this),this._graphics=null,this._instanceMaterialType=ZO.ADD_COLOR}onLoad(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()}onEnable(){super.onEnable(),this._updateGraphics()}onRestore(){this._createGraphics(),super.updateMaterial(),this._updateGraphics(),this._renderFlag=this._canRender()}onDisable(){super.onDisable(),this._disableGraphics()}onDestroy(){super.onDestroy(),this._clearModel&&qA.root.destroyModel(this._clearModel),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics()}isHit(t){const e=this.node._uiProps.uiTransformComp,n=e.contentSize,i=n.width,s=n.height,o=IL;this.node.getWorldMatrix(DL),pn.invert(RL,DL),qe.transformMat4(o,t,RL);const r=e.anchorPoint;o.x+=r.x*i,o.y+=r.y*s;let a=!1;if(this.type===ML.RECT||this.type===ML.GRAPHICS_STENCIL)a=o.x>=0&&o.y>=0&&o.x<=i&&o.y<=s;else if(this.type===ML.ELLIPSE){const t=i/2,e=s/2,n=o.x-.5*i,r=o.y-.5*s;a=n*n/(t*t)+r*r/(e*e)<1}return this._inverted&&(a=!a),a}_render(t){t.commitComp(this,null,this._assembler,null)}_postRender(t){this._postAssembler&&t.commitComp(this,null,this._postAssembler,null)}_nodeStateChange(t){super._nodeStateChange(t),this._updateGraphics()}_canRender(){return!!super._canRender()&&null!==this._graphics&&(this._type!==ML.IMAGE_STENCIL||null!==this._spriteFrame)}_flushAssembler(){const e=t.Assembler.getAssembler(this),n=t.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==n&&(this._postAssembler=n),this._useRenderData()}_createGraphics(){if(!this._graphics){const t=this._graphics=new iL;t._objFlags|=Rn.Flags.IsOnLoadCalled,t.node=this.node,t.node.getWorldMatrix(),t.lineWidth=0;const e=An.WHITE.clone();e.a=0,t.fillColor=e}this._updateMaterial()}_updateGraphics(){if(!this._graphics||this._type!==ML.RECT&&this._type!==ML.ELLIPSE)return;const t=this.node._uiProps.uiTransformComp,e=this._graphics;e.clear();const n=t.contentSize,i=n.width,s=n.height,o=t.anchorPoint,r=-i*o.x,a=-s*o.y;if(this._type===ML.RECT)e.rect(r,a,i,s);else if(this._type===ML.ELLIPSE){const t=function(t,e,n){OL.length=0;const i=2*Math.PI/n;for(let s=0;s<n;++s)OL.push(new $e(e.x*Math.cos(i*s)+t.x,e.y*Math.sin(i*s)+t.y,0));return OL}(new $e(r+i/2,a+s/2,0),new $e(i/2,s/2,0),this._segments);for(let n=0;n<t.length;++n){const i=t[n];0===n?e.moveTo(i.x,i.y):e.lineTo(i.x,i.y)}e.close()}e.fill()}_createClearModel(){if(!this._clearModel){const t=Tp.get("default-clear-stencil");this._clearStencilMtl=new Xf({parent:t,owner:this,subModelIdx:0}),this._clearModel=qA.root.createModel(km),this._clearModel.node=this._clearModel.transform=this.node;const e=RN(bN),n=i.director.root.device,s=n.createBuffer(new br(Lo.VERTEX|Lo.TRANSFER_DST,zo.DEVICE,4*e,e)),o=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);s.update(o);const r=n.createBuffer(new br(Lo.INDEX|Lo.TRANSFER_DST,zo.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),a=new Uint16Array([0,1,2,2,1,3]);r.update(a);const c=new fS([s],bN,er.TRIANGLE_LIST,r);c.subMeshIdx=0,this._clearModel.initSubModel(0,c,this._clearStencilMtl)}}_updateMaterial(){if(this._graphics){const t=this._graphics;let e;t.stencilStage=IO.DISABLED,this._type===ML.IMAGE_STENCIL?(e=Tp.get("ui-alpha-test-material"),t.setMaterial(e,0),e=t.getMaterialInstance(0),e.setProperty("alphaThreshold",this._alphaThreshold)):(e=Tp.get("ui-graphics-material"),t.setMaterial(e,0),t.getMaterialInstance(0))}}_disableGraphics(){this._graphics&&this._graphics.onDisable()}_removeGraphics(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)}_useRenderData(){this._type!==ML.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())}},PL.Type=ML,Yh((SL=wL).prototype,"type",[cL,lL,hL],Object.getOwnPropertyDescriptor(SL.prototype,"type"),SL.prototype),Yh(SL.prototype,"inverted",[_L,uL],Object.getOwnPropertyDescriptor(SL.prototype,"inverted"),SL.prototype),Yh(SL.prototype,"segments",[dL],Object.getOwnPropertyDescriptor(SL.prototype,"segments"),SL.prototype),Yh(SL.prototype,"spriteFrame",[pL,fL],Object.getOwnPropertyDescriptor(SL.prototype,"spriteFrame"),SL.prototype),Yh(SL.prototype,"alphaThreshold",[mL,gL,A_],Object.getOwnPropertyDescriptor(SL.prototype,"alphaThreshold"),SL.prototype),Yh(SL.prototype,"color",[M_,vL],Object.getOwnPropertyDescriptor(SL.prototype,"color"),SL.prototype),Yh(SL.prototype,"customMaterial",[M_,yL],Object.getOwnPropertyDescriptor(SL.prototype,"customMaterial"),SL.prototype),TL=Yh(SL.prototype,"_type",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ML.RECT}}),EL=Yh(SL.prototype,"_inverted",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),AL=Yh(SL.prototype,"_segments",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),CL=Yh(SL.prototype,"_spriteFrame",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bL=Yh(SL.prototype,"_alphaThreshold",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),xL=SL))||xL)||xL)||xL)||xL));RS._comp=NL,i.Mask=NL;const LL=/^(click)(\s)*=|(param)(\s)*=/,BL=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;class FL{constructor(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}parse(t){this._resultObjectArray.length=0,this._stack.length=0;let e=0;const n=t.length;for(;e<n;){let i=t.indexOf(">",e),s=-1;if(i>=0&&(s=t.lastIndexOf("<",i),s<e-1&&(s=t.indexOf("<",i+1),i=t.indexOf(">",s+1))),s<0)this._stack.pop(),this._processResult(t.substring(e)),e=n;else{let n=t.substring(e,s);const o=t.substring(s+1,i);""===o&&(n=t.substring(e,i+1)),this._processResult(n),-1===i?i=s:"/"===t.charAt(s+1)?this._stack.pop():this._addToStack(o),e=i+1}}return this._resultObjectArray}_attributeToObject(t){t=t.trim();const e={};let n=/^(color|size)(\s)*=/.exec(t),i="",s=0,o="";if(n){if(i=n[0],""===(t=t.substring(i.length).trim()))return e;switch(s=t.indexOf(" "),i[0]){case"c":e.color=s>-1?t.substring(0,s).trim():t;break;case"s":e.size=parseInt(t)}return s>-1&&(o=t.substring(s+1).trim(),e.event=this._processEventHandler(o)),e}if(n=/^(br(\s)*\/)/.exec(t),n&&n[0].length>0&&(i=n[0].trim(),i.startsWith("br")&&"/"===i[i.length-1]))return e.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),e;n=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(t);let r="";if(n&&n[0].length>0&&(i=n[0].trim(),i.startsWith("img")&&"/"===i[i.length-1])){let o;n=BL.exec(t);let a=!1;for(;n;){if(i=(t=t.substring(t.indexOf(n[0]))).substr(0,n[0].length),r=t.substring(i.length).trim(),s=r.indexOf(" "),o=s>-1?r.substr(0,s):r,i=i.replace(/[^a-zA-Z]/g,"").trim(),i=i.toLowerCase(),t=r.substring(s).trim(),o.endsWith("/")&&(o=o.slice(0,-1)),"src"===i){switch(o.charCodeAt(0)){case 34:case 39:a=!0,o=o.slice(1,-1)}e.isImage=!0,e.src=o}else if("height"===i)e.imageHeight=parseInt(o);else if("width"===i)e.imageWidth=parseInt(o);else if("align"===i){switch(o.charCodeAt(0)){case 34:case 39:o=o.slice(1,-1)}e.imageAlign=o.toLowerCase()}else"offset"===i?e.imageOffset=o:"click"===i&&(e.event=this._processEventHandler(`${i}=${o}`));e.event&&"param"===i&&(e.event[i]=o.replace(/^"|"$/g,"")),n=BL.exec(t)}return a&&e.isImage&&this._resultObjectArray.push({text:"",style:e}),{}}if(n=/^(outline(\s)*[^>]*)/.exec(t),n){const o={color:"#ffffff",width:1};if(t=n[0].substring("outline".length).trim()){const a=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;let c;for(n=a.exec(t);n;)i=(t=t.substring(t.indexOf(n[0]))).substr(0,n[0].length),r=t.substring(i.length).trim(),s=r.indexOf(" "),c=s>-1?r.substr(0,s):r,i=i.replace(/[^a-zA-Z]/g,"").trim(),i=i.toLowerCase(),t=r.substring(s).trim(),"click"===i?e.event=this._processEventHandler(`${i}=${c}`):"color"===i?o.color=c:"width"===i&&(o.width=parseInt(c)),e.event&&"param"===i&&(e.event[i]=c.replace(/^"|"$/g,"")),n=a.exec(t)}e.outline=o}if(n=/^(on|u|b|i)(\s)*/.exec(t),n&&n[0].length>0){switch(i=n[0],t=t.substring(i.length).trim(),i[0]){case"u":e.underline=!0;break;case"i":e.italic=!0;break;case"b":e.bold=!0}if(""===t)return e;e.event=this._processEventHandler(t)}return e}_processEventHandler(t){const e={};let n=0,i=!1,s=LL.exec(t);for(;s;){let o=s[0],r="";if(i=!1,'"'===(t=t.substring(o.length).trim()).charAt(0))n=t.indexOf('"',1),n>-1&&(r=t.substring(1,n).trim(),i=!0),n++;else if("'"===t.charAt(0))n=t.indexOf("'",1),n>-1&&(r=t.substring(1,n).trim(),i=!0),n++;else{const e=/(\S)+/.exec(t);r=e?e[0]:"",n=r.length}i&&(o=o.substring(0,o.length-1).trim(),e[o]=r),t=t.substring(n).trim(),s=LL.exec(t)}return e}_addToStack(t){const e=this._attributeToObject(t);if(0===this._stack.length)this._stack.push(e);else{if(e.isNewLine||e.isImage)return;const t=this._stack[this._stack.length-1];for(const n in t)e[n]||(e[n]=t[n]);this._stack.push(e)}}_processResult(t){0!==t.length&&(t=this._escapeSpecialSymbol(t),this._stack.length>0?this._resultObjectArray.push({text:t,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:t}))}_escapeSpecialSymbol(t){for(const e of this._specialSymbolArray){const n=e[0],i=e[1];t=t.replace(n,i)}return t}}var zL,UL,HL,GL,VL,jL,WL,kL,qL,XL,YL;t("HtmlTextParser",FL);let KL=t("LabelOutline",(zL=i_("cc.LabelOutline"),UL=f_(),HL=o_(110),GL=__(),VL=s_(uN),jL=y_(),WL=y_(),zL(kL=UL(kL=HL(kL=GL(kL=VL(kL=h_((XL=Yh((qL=class extends Ad{constructor(...t){super(...t),Xh(this,"_color",XL,this),Xh(this,"_width",YL,this)}get color(){return this._color}set color(t){this._color!==t&&(this._color.set(t),this._updateRenderData())}get width(){return this._width}set width(t){this._width!==t&&(this._width=t,this._updateRenderData())}onEnable(){this._updateRenderData()}onDisable(){this._updateRenderData()}_updateRenderData(){const t=this.node.getComponent(uN);t&&t.updateRenderData(!0)}}).prototype,"_color",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new An(0,0,0,255)}}),YL=Yh(qL.prototype,"_width",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),Yh(qL.prototype,"color",[jL],Object.getOwnPropertyDescriptor(qL.prototype,"color"),qL.prototype),Yh(qL.prototype,"width",[WL],Object.getOwnPropertyDescriptor(qL.prototype,"width"),qL.prototype),kL=qL))||kL)||kL)||kL)||kL)||kL)||kL));var $L,ZL,JL,QL,tB,eB,nB,iB,sB,oB,rB,aB,cB,lB,hB,_B,uB,dB,pB,fB,mB,gB,vB,yB,xB,SB,TB,EB,AB,CB,bB,PB,wB,DB,IB,RB,OB,MB,NB,LB,BB,FB,zB;!function(t){t[t.SIMPLE=0]="SIMPLE",t[t.SLICED=1]="SLICED",t[t.TILED=2]="TILED",t[t.FILLED=3]="FILLED"}(LB||(LB={})),Mt(LB),function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL",t[t.RADIAL=2]="RADIAL"}(BB||(BB={})),Mt(BB),function(t){t[t.CUSTOM=0]="CUSTOM",t[t.TRIMMED=1]="TRIMMED",t[t.RAW=2]="RAW"}(FB||(FB={})),Mt(FB),function(t){t.SPRITE_FRAME_CHANGED="spriteframe-changed"}(zB||(zB={}));let UB=t("Sprite",($L=i_("cc.Sprite"),ZL=f_(),JL=o_(110),QL=__(),tB=O_(pR),eB=C_(),nB=y_(),iB=O_(hR),sB=C_(),oB=y_(),rB=O_(LB),aB=C_(),cB=y_(),lB=O_(BB),hB=y_(),_B=y_(),uB=x_(),dB=y_(),pB=x_(),fB=y_(),mB=C_(),gB=y_(),vB=O_(FB),yB=C_(),xB=y_(),$L(SB=ZL(SB=JL(SB=QL((NB=MB=class t extends JO{constructor(...t){super(...t),Xh(this,"_spriteFrame",EB,this),Xh(this,"_type",AB,this),Xh(this,"_fillType",CB,this),Xh(this,"_sizeMode",bB,this),Xh(this,"_fillCenter",PB,this),Xh(this,"_fillStart",wB,this),Xh(this,"_fillRange",DB,this),Xh(this,"_isTrimmedMode",IB,this),Xh(this,"_useGrayscale",RB,this),Xh(this,"_atlas",OB,this)}get spriteAtlas(){return this._atlas}set spriteAtlas(t){this._atlas!==t&&(this._atlas=t)}get spriteFrame(){return this._spriteFrame}set spriteFrame(t){if(this._spriteFrame===t)return;const e=this._spriteFrame;this._spriteFrame=t,this.markForUpdateRenderData(!1),this._applySpriteFrame(e)}get type(){return this._type}set type(t){this._type!==t&&(this._type=t,this._flushAssembler())}get fillType(){return this._fillType}set fillType(t){this._fillType!==t&&(t===BB.RADIAL||this._fillType===BB.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=t,this._flushAssembler()}get fillCenter(){return this._fillCenter}set fillCenter(t){this._fillCenter.x=t.x,this._fillCenter.y=t.y,this._type===LB.FILLED&&this._renderData&&this.markForUpdateRenderData()}get fillStart(){return this._fillStart}set fillStart(t){this._fillStart=De(t,-1,1),this._type===LB.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}get fillRange(){return this._fillRange}set fillRange(t){this._fillRange=De(t,-1,1),this._type===LB.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}get trim(){return this._isTrimmedMode}set trim(t){this._isTrimmedMode!==t&&(this._isTrimmedMode=t,this._type===LB.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}get grayscale(){return this._useGrayscale}set grayscale(t){this._useGrayscale!==t&&(this._useGrayscale=t,this._instanceMaterialType=!0===t?ZO.GRAYSCALE:ZO.ADD_COLOR_AND_TEXTURE,this.updateMaterial())}get sizeMode(){return this._sizeMode}set sizeMode(t){this._sizeMode!==t&&(this._sizeMode=t,t!==FB.CUSTOM&&this._applySpriteSize())}__preload(){this.changeMaterialForDefine(),super.__preload(),this._spriteFrame&&this._spriteFrame.once("load",this._onTextureLoaded,this)}onEnable(){super.onEnable(),this._activateMaterial(),this._markForUpdateUvDirty()}onDestroy(){this.destroyRenderData(),this._spriteFrame&&!this._spriteFrame.loaded&&this._spriteFrame.off("load",this._onTextureLoaded,this),super.onDestroy()}changeSpriteFrameFromAtlas(t){if(!this._atlas)return void console.warn("SpriteAtlas is null.");const e=this._atlas.getSpriteFrame(t);this.spriteFrame=e}changeMaterialForDefine(){let t;const e=this._instanceMaterialType;this._spriteFrame&&(t=this._spriteFrame.texture);let n=!1;if(t instanceof Hu){const e=t.getPixelFormat();n=e===hu.RGBA_ETC1||e===hu.RGB_A_PVRTC_4BPPV1||e===hu.RGB_A_PVRTC_2BPPV1}n&&this.grayscale?this._instanceMaterialType=ZO.USE_ALPHA_SEPARATED_AND_GRAY:n?this._instanceMaterialType=ZO.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=ZO.GRAYSCALE:this._instanceMaterialType=ZO.ADD_COLOR_AND_TEXTURE,e!==this._instanceMaterialType&&this.updateMaterial()}_updateBuiltinMaterial(){let t=super._updateBuiltinMaterial();if(this.spriteFrame&&this.spriteFrame.texture instanceof Lf){const e={SAMPLE_FROM_RT:!0,...t.passes[0].defines},n=new kf;n.initialize({effectAsset:t.effectAsset,defines:e}),t=n}return t}_render(t){t.commitComp(this,this._spriteFrame,this._assembler,null)}_canRender(){if(!super._canRender())return!1;const t=this._spriteFrame;return!(!t||!t.textureLoaded())}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this._colorDirty=!0,this._updateColor())}_applySpriteSize(){if(this._spriteFrame){if(!this._spriteFrame.isDefault)if(FB.RAW===this._sizeMode){const t=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(t)}else if(FB.TRIMMED===this._sizeMode){const t=this._spriteFrame.getRect();this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this._activateMaterial()}}_resized(){}_activateMaterial(){const t=this._spriteFrame,e=this.getRenderMaterial(0);i.game.renderType!==i.game.RENDER_TYPE_CANVAS?(t&&e&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=e)):this.markForUpdateRenderData()}_onTextureLoaded(){this.isValid&&(this.changeMaterialForDefine(),this._applySpriteSize())}_applySpriteFrame(t){const e=this._spriteFrame;this._renderData&&(t&&!t.loaded&&t.off("load",this._onTextureLoaded,this),this._renderData.uvDirty||(this._renderData.uvDirty=!t||!e||t.uvHash!==e.uvHash),this._renderDataFlag=this._renderData.uvDirty),e&&(t&&e===t||(e.loaded?this._onTextureLoaded():e.once("load",this._onTextureLoaded,this)))}_markForUpdateUvDirty(){this._renderData&&(this._renderData.uvDirty=!0,this._renderDataFlag=!0)}},MB.FillType=BB,MB.Type=LB,MB.SizeMode=FB,MB.EventType=zB,Yh((TB=NB).prototype,"spriteAtlas",[tB,eB,nB],Object.getOwnPropertyDescriptor(TB.prototype,"spriteAtlas"),TB.prototype),Yh(TB.prototype,"spriteFrame",[iB,sB,oB],Object.getOwnPropertyDescriptor(TB.prototype,"spriteFrame"),TB.prototype),Yh(TB.prototype,"type",[rB,aB,cB],Object.getOwnPropertyDescriptor(TB.prototype,"type"),TB.prototype),Yh(TB.prototype,"fillType",[lB,hB],Object.getOwnPropertyDescriptor(TB.prototype,"fillType"),TB.prototype),Yh(TB.prototype,"fillCenter",[_B],Object.getOwnPropertyDescriptor(TB.prototype,"fillCenter"),TB.prototype),Yh(TB.prototype,"fillStart",[uB,dB],Object.getOwnPropertyDescriptor(TB.prototype,"fillStart"),TB.prototype),Yh(TB.prototype,"fillRange",[pB,fB],Object.getOwnPropertyDescriptor(TB.prototype,"fillRange"),TB.prototype),Yh(TB.prototype,"trim",[mB,gB],Object.getOwnPropertyDescriptor(TB.prototype,"trim"),TB.prototype),Yh(TB.prototype,"grayscale",[m_],Object.getOwnPropertyDescriptor(TB.prototype,"grayscale"),TB.prototype),Yh(TB.prototype,"sizeMode",[vB,yB,xB],Object.getOwnPropertyDescriptor(TB.prototype,"sizeMode"),TB.prototype),EB=Yh(TB.prototype,"_spriteFrame",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),AB=Yh(TB.prototype,"_type",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return LB.SIMPLE}}),CB=Yh(TB.prototype,"_fillType",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BB.HORIZONTAL}}),bB=Yh(TB.prototype,"_sizeMode",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return FB.TRIMMED}}),PB=Yh(TB.prototype,"_fillCenter",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qe(0,0)}}),wB=Yh(TB.prototype,"_fillStart",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),DB=Yh(TB.prototype,"_fillRange",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),IB=Yh(TB.prototype,"_isTrimmedMode",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),RB=Yh(TB.prototype,"_useGrayscale",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),OB=Yh(TB.prototype,"_atlas",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),SB=TB))||SB)||SB)||SB)||SB));var HB;let GB=t("RenderRoot2D",i_("cc.RenderRoot2D")(HB=o_(100)(HB=__()(HB=s_(RO)(HB=r_(HB=h_(HB=class extends Ad{onEnable(){i.director.root.batcher2D.addScreen(this)}onDisable(){i.director.root.batcher2D.removeScreen(this)}onDestroy(){i.director.root.batcher2D.removeScreen(this)}})||HB)||HB)||HB)||HB)||HB)||HB);var VB,jB,WB,kB,qB,XB,YB,KB,$B,ZB,JB,QB;const tF=new $e,eF=It({OVERLAY:0,INTERSPERSE:1});let nF=t("Canvas",(VB=i_("cc.Canvas"),jB=f_(),WB=o_(100),kB=__(),qB=O_(bP),XB=y_(),YB=y_(),KB=O_(bP),VB($B=jB($B=WB($B=kB($B=h_($B=r_((Yh((ZB=class extends GB{get renderMode(){return this._renderMode}set renderMode(t){this._renderMode=t,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}get cameraComponent(){return this._cameraComponent}set cameraComponent(t){this._cameraComponent!==t&&(this._cameraComponent=t,this._onResizeCamera())}get alignCanvasWithScreen(){return this._alignCanvasWithScreen}set alignCanvasWithScreen(t){this._alignCanvasWithScreen=t,this._onResizeCamera()}constructor(){super(),Xh(this,"_cameraComponent",JB,this),Xh(this,"_alignCanvasWithScreen",QB,this),this._thisOnCameraResized=void 0,this._fitDesignResolution=void 0,this._pos=new $e,this._renderMode=eF.OVERLAY,this._thisOnCameraResized=this._onResizeCamera.bind(this)}__preload(){const t=this.getComponent("cc.Widget");t&&t.updateAlignment(),this._cameraComponent&&this._cameraComponent._createCamera(),this._onResizeCamera(),this.node.on(Mp.TRANSFORM_CHANGED,this._thisOnCameraResized)}onDestroy(){super.onDestroy(),this.node.off(Mp.TRANSFORM_CHANGED,this._thisOnCameraResized)}_onResizeCamera(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture){const t=this._cameraComponent.targetTexture.window;this._cameraComponent.camera&&this._cameraComponent.camera.setFixedSize(t.width,t.height),this._cameraComponent.orthoHeight=Op.height/2}else if(Sm.canvas){const t=Sm.canvas;this._cameraComponent.camera&&this._cameraComponent.camera.resize(t.width,t.height),this._cameraComponent.orthoHeight=Sm.canvas.height/Pm.getScaleY()/2}this.node.getWorldPosition(tF),this._cameraComponent.node.setWorldPosition(tF.x,tF.y,1e3)}}_getViewPriority(){if(this._cameraComponent){var t;let e=null===(t=this.cameraComponent)||void 0===t?void 0:t.priority;return e=this._renderMode===eF.OVERLAY?e|1<<30:e&~(1<<30),e}return 0}}).prototype,"cameraComponent",[qB,XB],Object.getOwnPropertyDescriptor(ZB.prototype,"cameraComponent"),ZB.prototype),Yh(ZB.prototype,"alignCanvasWithScreen",[YB],Object.getOwnPropertyDescriptor(ZB.prototype,"alignCanvasWithScreen"),ZB.prototype),JB=Yh(ZB.prototype,"_cameraComponent",[KB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),QB=Yh(ZB.prototype,"_alignCanvasWithScreen",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),$B=ZB))||$B)||$B)||$B)||$B)||$B)||$B));var iF;i.Canvas=nF;let sF=t("UIComponent",i_("cc.UIComponent")(iF=s_(RO)(iF=o_(110)(iF=r_(iF=h_(iF=class extends Ad{constructor(...t){super(...t),this._lastParent=null,this.stencilStage=IO.DISABLED}__preload(){this.node._uiProps.uiComp=this}onEnable(){}onDisable(){}onDestroy(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)}updateAssembler(t){}postUpdateAssembler(t){}})||iF)||iF)||iF)||iF)||iF);var oF,rF,aF,cF,lF,hF,_F,uF,dF,pF,fF,mF,gF,vF,yF,xF,SF,TF,EF,AF,CF,bF,PF,wF,DF,IF,RF,OF,MF,NF,LF,BF,FF,zF,UF;const HF=new FL,GF="RICHTEXT_CHILD",VF="RICHTEXT_Image_CHILD",jF=new bt((t=>{if(!i.isValid(t.node))return!1;{const e=t.node.getComponent(KL);e&&(e.width=0)}return!0}),20),WF=new bt((t=>i.isValid(t.node)),10);function kF(t){return{node:new ey(t),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:t}}function qF(t,e){let n;t===GF?n=jF._get():t===VF&&(n=WF._get()),n=n||kF(t);let i=n.node;return i||(i=new ey(t)),i.hideFlags|=Rn.Flags.DontSave|Rn.Flags.HideInHierarchy,t===VF?(n.comp=i.getComponent(UB)||i.addComponent(UB),n.comp.spriteFrame=e,n.comp.type=UB.Type.SLICED,n.comp.sizeMode=UB.SizeMode.CUSTOM):(n.comp=i.getComponent(uN)||i.addComponent(uN),n.comp.string=e,n.comp.horizontalAlign=oN.LEFT,n.comp.verticalAlign=rN.TOP),i.setPosition(0,0,0),i._uiProps.uiTransformComp.setAnchorPoint(.5,.5),n.node=i,n.lineCount=0,n.styleIndex=0,n.imageOffset="",n.clickParam="",n.clickHandler="",n}var XF;t("RichText",(oF=i_("cc.RichText"),rF=f_(),aF=o_(110),cF=__(),lF=y_(),hF=O_(oN),_F=y_(),uF=y_(),dF=y_(),pF=O_(mR),fF=y_(),mF=y_(),gF=O_(cN),vF=y_(),yF=y_(),xF=y_(),SF=O_(pR),TF=y_(),EF=y_(),oF(AF=rF(AF=aF(AF=cF(AF=h_((UF=zF=class extends sF{get string(){return this._string}set string(t){this._string!==t&&(this._string=t,this._updateRichTextStatus())}get horizontalAlign(){return this._horizontalAlign}set horizontalAlign(t){this.horizontalAlign!==t&&(this._horizontalAlign=t,this._layoutDirty=!0,this._updateRichTextStatus())}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize!==t&&(this._fontSize=t,this._layoutDirty=!0,this._updateRichTextStatus())}get fontFamily(){return this._fontFamily}set fontFamily(t){this._fontFamily!==t&&(this._fontFamily=t,this._layoutDirty=!0,this._updateRichTextStatus())}get font(){return this._font}set font(t){this._font!==t&&(this._font=t,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}get useSystemFont(){return this._isSystemFontUsed}set useSystemFont(t){this._isSystemFontUsed!==t&&(this._isSystemFontUsed=t,this._layoutDirty=!0,this._updateRichTextStatus())}get cacheMode(){return this._cacheMode}set cacheMode(t){this._cacheMode!==t&&(this._cacheMode=t,this._updateRichTextStatus())}get maxWidth(){return this._maxWidth}set maxWidth(t){this._maxWidth!==t&&(this._maxWidth=t,this._layoutDirty=!0,this._updateRichTextStatus())}get lineHeight(){return this._lineHeight}set lineHeight(t){this._lineHeight!==t&&(this._lineHeight=t,this._layoutDirty=!0,this._updateRichTextStatus())}get imageAtlas(){return this._imageAtlas}set imageAtlas(t){this._imageAtlas!==t&&(this._imageAtlas=t,this._layoutDirty=!0,this._updateRichTextStatus())}get handleTouchEvent(){return this._handleTouchEvent}set handleTouchEvent(t){this._handleTouchEvent!==t&&(this._handleTouchEvent=t,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}constructor(){super(),Xh(this,"_lineHeight",bF,this),Xh(this,"_string",PF,this),Xh(this,"_horizontalAlign",wF,this),Xh(this,"_fontSize",DF,this),Xh(this,"_maxWidth",IF,this),Xh(this,"_fontFamily",RF,this),Xh(this,"_font",OF,this),Xh(this,"_isSystemFontUsed",MF,this),Xh(this,"_userDefinedFont",NF,this),Xh(this,"_cacheMode",LF,this),Xh(this,"_imageAtlas",BF,this),Xh(this,"_handleTouchEvent",FF,this),this._textArray=[],this._segments=[],this._labelSegmentsCache=[],this._linesWidth=[],this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0,this._lineOffsetX=0,this._updateRichTextStatus=void 0,this._updateRichTextStatus=this._updateRichText}onLoad(){this.node.on(Mp.LAYER_CHANGED,this._applyLayer,this)}onEnable(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)}onDisable(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)}start(){this._onTTFLoaded(),this.node.on(ey.EventType.ANCHOR_CHANGED,this._updateRichTextPosition,this)}onRestore(){}onDestroy(){for(const t of this._segments)t.node.removeFromParent(),t.type===GF?jF.put(t):t.type===VF&&WF.put(t);this.node.off(ey.EventType.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(Mp.LAYER_CHANGED,this._applyLayer,this)}_addEventListeners(){this.node.on(ey.EventType.TOUCH_END,this._onTouchEnded,this)}_removeEventListeners(){this.node.off(ey.EventType.TOUCH_END,this._onTouchEnded,this)}_updateLabelSegmentTextAttributes(){this._segments.forEach((t=>{this._applyTextAttribute(t)}))}_createFontLabel(t){return qF(GF,t)}_createImage(t){return qF(VF,t)}_onTTFLoaded(){this._font instanceof xR?this._font._nativeAsset?(this._layoutDirty=!0,this._updateRichText()):sb.postLoadNative(this._font,(()=>{this.isValid&&(this._layoutDirty=!0,this._updateRichText())})):(this._layoutDirty=!0,this._updateRichText())}_measureText(t,e){const n=e=>{let n;return 0===this._labelSegmentsCache.length?(n=this._createFontLabel(e),this._labelSegmentsCache.push(n)):(n=this._labelSegmentsCache[0],n.node.getComponent(uN).string=e),n.styleIndex=t,this._applyTextAttribute(n),n.node._uiProps.uiTransformComp.contentSize.width};return e?n(e):n}_onTouchEnded(t){const e=this.node.getComponents(Ad);for(const n of this._segments){const i=n.clickHandler,s=n.clickParam;i&&this._containsTouchLocation(n,t.touch.getUILocation())&&(e.forEach((e=>{const n=e[i];e.enabledInHierarchy&&n&&n.call(e,t,s)})),t.propagationStopped=!0)}}_containsTouchLocation(t,e){const n=t.node.getComponent(RO);return!!n&&n.getBoundingBoxToWorld().contains(e)}_resetState(){const t=this.node.children;for(let e=t.length-1;e>=0;e--){const n=t[e];if(n.name===GF||n.name===VF){n.parent===this.node?n.parent=null:t.splice(e,1);const i=kF(n.name);i.node=n,n.name===GF?(i.comp=n.getComponent(uN),jF.put(i)):(i.comp=n.getComponent(UB),WF.put(i))}}t.length=0,this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0}_activateChildren(t){for(let e=this.node.children.length-1;e>=0;e--){const n=this.node.children[e];n.name!==GF&&n.name!==VF||(n.active=t)}}_addLabelSegment(t,e){let n;if(0===this._labelSegmentsCache.length)n=this._createFontLabel(t);else{n=this._labelSegmentsCache.pop();const e=n.node.getComponent(uN);e&&(e.string=t)}return n.styleIndex=e,n.lineCount=this._lineCount,n.node._uiProps.uiTransformComp.setAnchorPoint(0,0),n.node.layer=this.node.layer,this._applyTextAttribute(n),this.node.addChild(n.node),this._segments.push(n),n}_updateRichTextWithMaxWidth(t,e,n){let i,s=e;if(this._lineOffsetX>0&&s+this._lineOffsetX>this._maxWidth){let e=0;for(;this._lineOffsetX<=this._maxWidth;){const i=this._getFirstWordLen(t,e,t.length),o=t.substr(e,i),r=this._measureText(n,o);if(!(this._lineOffsetX+r<=this._maxWidth)){if(e>0){const i=t.substr(0,e);this._addLabelSegment(i,n),t=t.substr(e,t.length),s=this._measureText(n,t)}this._updateLineInfo();break}this._lineOffsetX+=r,e+=i}}if(s>this._maxWidth){const e=XR(t,s,this._maxWidth,this._measureText(n));for(let t=0;t<e.length;++t){const s=e[t];i=this._addLabelSegment(s,n);const o=i.node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=o.width,e.length>1&&t<e.length-1&&this._updateLineInfo()}}else this._lineOffsetX+=s,this._addLabelSegment(t,n)}_isLastComponentCR(t){return t.length-1===t.lastIndexOf("\n")}_updateLineInfo(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++}_needsUpdateTextLayout(t){if(this._layoutDirty||!this._textArray||!t)return!0;if(this._textArray.length!==t.length)return!0;for(let e=0;e<this._textArray.length;e++){const n=this._textArray[e],i=t[e];if(n.text!==i.text)return!0;{const t=n.style,e=i.style;if(t){if(e){if(!!e.outline!=!!t.outline)return!0;if(t.size!==e.size||t.italic!==e.italic||t.isImage!==e.isImage)return!0;if(t.src!==e.src||t.imageAlign!==e.imageAlign||t.imageHeight!==e.imageHeight||t.imageWidth!==e.imageWidth||t.imageOffset!==e.imageOffset)return!0}else if(t.size||t.italic||t.isImage||t.outline)return!0}else if(e&&(e.size||e.italic||e.isImage||e.outline))return!0}}return!1}_addRichTextImageElement(t){if(!t.style)return;const e=t.style,n=e.src,i=this._imageAtlas&&n&&this._imageAtlas.getSpriteFrame(n);if(i){const t=this._createImage(i);switch(t.comp,e.imageAlign){case"top":t.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":t.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:t.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}t.node.layer=this.node.layer,this.node.addChild(t.node),this._segments.push(t);const n=i.rect.clone();let s=1,o=n.width,r=n.height;const a=e.imageWidth||0,c=e.imageHeight||0;c>0?(s=c/r,o*=s,r*=s):(s=this._lineHeight/r,o*=s,r*=s),a>0&&(o=a),this._maxWidth>0?(this._lineOffsetX+o>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=o):(this._lineOffsetX+=o,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),t.node._uiProps.uiTransformComp.setContentSize(o,r),t.lineCount=this._lineCount,t.clickHandler="",t.clickParam="";const l=e.event;l&&(t.clickHandler=l.click,t.clickParam=l.param)}else E(4400)}_updateRichText(){if(!this.enabledInHierarchy)return;const t=HF.parse(this._string);if(!this._needsUpdateTextLayout(t))return this._textArray=t.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=t.slice(),this._resetState();let e,n=!1;for(let t=0;t<this._textArray.length;++t){const i=this._textArray[t],s=i.text;if(void 0===s)continue;if(""===s){if(i.style&&i.style.isNewLine){this._updateLineInfo();continue}if(i.style&&i.style.isImage&&this._imageAtlas){this._addRichTextImageElement(i);continue}}const o=s.split("\n");for(let i=0;i<o.length;++i){const r=o[i];if(""!==r)if(n=!1,this._maxWidth>0){const e=this._measureText(t,r);this._updateRichTextWithMaxWidth(r,e,t),o.length>1&&i<o.length-1&&this._updateLineInfo()}else e=this._addLabelSegment(r,t),this._lineOffsetX+=e.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),o.length>1&&i<o.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(s)&&i===o.length-1)continue;this._updateLineInfo(),n=!0}}}n||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+NR)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}_getFirstWordLen(t,e,n){let i=t.charAt(e);if(jR(i)||WR(i))return 1;let s=1;for(let o=e+1;o<n&&(i=t.charAt(o),!WR(i)&&!jR(i));++o)s++;return s}_updateRichTextPosition(){let t=0,e=1;const n=this._lineCount,i=this.node._uiProps.uiTransformComp,s=i.anchorX,o=i.anchorY;for(let i=0;i<this._segments.length;++i){const r=this._segments[i],a=r.lineCount;a>e&&(t=0,e=a);let c=this._labelWidth*(.5*this._horizontalAlign-s);switch(this._horizontalAlign){case oN.LEFT:break;case oN.CENTER:c-=this._linesWidth[a-1]/2;break;case oN.RIGHT:c-=this._linesWidth[a-1]}const l=r.node.position;if(r.node.setPosition(t+c,this._lineHeight*(n-a)-this._labelHeight*o,l.z),a===e&&(t+=r.node._uiProps.uiTransformComp.width),r.node.getComponent(UB)){const t=r.node.position.clone(),e=this._lineHeight,n=this._lineHeight*(1+NR);switch(r.node._uiProps.uiTransformComp.anchorY){case 1:t.y+=e+(n-e)/2;break;case.5:t.y+=n/2;break;default:t.y+=(n-e)/2}if(r.imageOffset){const e=r.imageOffset.split(",");if(1===e.length&&e[0]){const n=parseFloat(e[0]);Number.isInteger(n)&&(t.y+=n)}else if(2===e.length){const n=parseFloat(e[0]),i=parseFloat(e[1]);Number.isInteger(n)&&(t.x+=n),Number.isInteger(i)&&(t.y+=i)}}r.node.position=t}const h=r.node.getComponent(KL);if(h){const t=r.node.position.clone();t.y-=h.width,r.node.position=t}}}_convertLiteralColorValue(t){const e=t.toUpperCase();return An[e]?An[e]:(new An).fromHEX(t)}_applyTextAttribute(t){const e=t.node.getComponent(uN);if(!e)return;const n=t.styleIndex;let i;if(this._textArray[n]&&(i=this._textArray[n].style),i){if(e.color=this._convertLiteralColorValue(i.color||"white"),e.isBold=!!i.bold,e.isItalic=!!i.italic,e.isUnderline=!!i.underline,i.outline){let e=t.node.getComponent(KL);e||(e=t.node.addComponent(KL)),e.color=this._convertLiteralColorValue(i.outline.color),e.width=i.outline.width}e.fontSize=i.size||this._fontSize,t.clickHandler="",t.clickParam="";const n=i.event;n&&(t.clickHandler=n.click||"",t.clickParam=n.param||"")}else e.fontSize=this._fontSize;e.cacheMode=this._cacheMode,this._font instanceof mR&&!this._isSystemFontUsed?e.font=this._font:e.fontFamily=this._fontFamily,e.useSystemFont=this._isSystemFontUsed,e.lineHeight=this._lineHeight,e.updateRenderData(!0);const s=e._assembler;s&&s.updateRenderData(e)}_applyLayer(){for(const t of this._segments)t.node.layer=this.node.layer}},zF.HorizontalAlign=oN,zF.VerticalAlign=rN,Yh((CF=UF).prototype,"string",[b_,lF],Object.getOwnPropertyDescriptor(CF.prototype,"string"),CF.prototype),Yh(CF.prototype,"horizontalAlign",[hF,_F],Object.getOwnPropertyDescriptor(CF.prototype,"horizontalAlign"),CF.prototype),Yh(CF.prototype,"fontSize",[uF],Object.getOwnPropertyDescriptor(CF.prototype,"fontSize"),CF.prototype),Yh(CF.prototype,"fontFamily",[dF],Object.getOwnPropertyDescriptor(CF.prototype,"fontFamily"),CF.prototype),Yh(CF.prototype,"font",[pF,fF],Object.getOwnPropertyDescriptor(CF.prototype,"font"),CF.prototype),Yh(CF.prototype,"useSystemFont",[mF],Object.getOwnPropertyDescriptor(CF.prototype,"useSystemFont"),CF.prototype),Yh(CF.prototype,"cacheMode",[gF,vF],Object.getOwnPropertyDescriptor(CF.prototype,"cacheMode"),CF.prototype),Yh(CF.prototype,"maxWidth",[yF],Object.getOwnPropertyDescriptor(CF.prototype,"maxWidth"),CF.prototype),Yh(CF.prototype,"lineHeight",[xF],Object.getOwnPropertyDescriptor(CF.prototype,"lineHeight"),CF.prototype),Yh(CF.prototype,"imageAtlas",[SF,TF],Object.getOwnPropertyDescriptor(CF.prototype,"imageAtlas"),CF.prototype),Yh(CF.prototype,"handleTouchEvent",[EF],Object.getOwnPropertyDescriptor(CF.prototype,"handleTouchEvent"),CF.prototype),bF=Yh(CF.prototype,"_lineHeight",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),PF=Yh(CF.prototype,"_string",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),wF=Yh(CF.prototype,"_horizontalAlign",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return oN.LEFT}}),DF=Yh(CF.prototype,"_fontSize",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),IF=Yh(CF.prototype,"_maxWidth",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),RF=Yh(CF.prototype,"_fontFamily",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),OF=Yh(CF.prototype,"_font",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),MF=Yh(CF.prototype,"_isSystemFontUsed",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),NF=Yh(CF.prototype,"_userDefinedFont",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),LF=Yh(CF.prototype,"_cacheMode",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cN.NONE}}),BF=Yh(CF.prototype,"_imageAtlas",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),FF=Yh(CF.prototype,"_handleTouchEvent",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),AF=CF))||AF)||AF)||AF)||AF)||AF)),t("UIMeshRenderer",i_("cc.UIMeshRenderer")(XF=f_()(XF=o_(110)(XF=__()(XF=class extends sF{constructor(...t){super(...t),this._models=null,this._modelComponent=null}get modelComponent(){return this._modelComponent}onLoad(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?this._models=this._modelComponent._collectModels():console.warn(`node '${this.node&&this.node.name}' doesn't have any renderable component`)}onEnable(){super.onEnable()}onDisable(){super.onDisable()}onDestroy(){super.onDestroy(),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,this._models=null)}updateAssembler(t){if(this._models){this._modelComponent._detachFromScene();for(const e of this._models)t.commitModel.call(t,this,e,this._modelComponent.material);return!0}return!1}update(){this._fitUIRenderQueue()}_fitUIRenderQueue(){if(!this._modelComponent)return;const t=this._modelComponent.sharedMaterials.length;for(let e=0;e<t;e++){const t=this._modelComponent.getMaterialInstance(e);if(null==t)continue;const n=t.passes,i=n.length;for(let e=0;e<i;e++){const i=n[e];i._priority=fl.MAX-11,i.blendState.targets[0].blend||t.overridePipelineStates({blendState:{targets:[{blend:!0}]}},e)}}}})||XF)||XF)||XF)||XF);class YF{get attributes(){return this._attributes}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}constructor(t){this.vData=null,this.iData=null,this.byteStart=0,this.byteOffset=0,this.indicesStart=0,this.indicesOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=1,this._attributes=null,this._vertexBuffers=[],this._indexBuffer=null,this._iaInfo=null,this._batcher=void 0,this._dirty=!1,this._vertexFormatBytes=0,this._initVDataCount=0,this._initIDataCount=1536,this._outOfCallback=null,this._hInputAssemblers=[],this._nextFreeIAHandle=0,this._batcher=t}get vertexFormatBytes(){return this._vertexFormatBytes}initialize(t,e){this._outOfCallback=e;const n=IN(t);this._vertexFormatBytes=n*Float32Array.BYTES_PER_ELEMENT,this._initVDataCount=256*this._vertexFormatBytes;const i=Float32Array.BYTES_PER_ELEMENT*n;this.vertexBuffers.length||this.vertexBuffers.push(this._batcher.device.createBuffer(new br(Lo.VERTEX|Lo.TRANSFER_DST,zo.HOST|zo.DEVICE,i,i)));const s=Uint16Array.BYTES_PER_ELEMENT;this.indexBuffer||(this._indexBuffer=this._batcher.device.createBuffer(new br(Lo.INDEX|Lo.TRANSFER_DST,zo.HOST|zo.DEVICE,s,s))),this._attributes=t,this._iaInfo=new kr(this.attributes,this.vertexBuffers,this.indexBuffer),this._reallocBuffer()}request(t=4,e=6){this.lastByteOffset=this.byteOffset;const n=this.byteOffset+t*this._vertexFormatBytes,i=this.indicesOffset+e;if(t+this.vertexOffset>65535)return this._outOfCallback&&this._outOfCallback.call(this._batcher,t,e),!1;let s=this.vData.byteLength,o=this.iData.length;if(n>s||i>o){for(;s<n||o<i;)this._initVDataCount*=2,this._initIDataCount*=2,s=4*this._initVDataCount,o=this._initIDataCount;this._reallocBuffer()}return this.vertexOffset+=t,this.indicesOffset+=e,this.byteOffset=n,this._dirty=!0,!0}reset(){this.byteStart=0,this.byteOffset=0,this.indicesStart=0,this.indicesOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=0,this._nextFreeIAHandle=0,this._dirty=!1}destroy(){this._attributes=null,this.vertexBuffers[0].destroy(),this.vertexBuffers.length=0,this.indexBuffer.destroy(),this._indexBuffer=null;for(let t=0;t<this._hInputAssemblers.length;t++)wi.free(this._hInputAssemblers[t]);this._hInputAssemblers.length=0}recordBatch(){const t=this.indicesOffset-this.indicesStart;if(!t)return 0;this._hInputAssemblers.length<=this._nextFreeIAHandle&&this._hInputAssemblers.push(wi.alloc(this._batcher.device,this._iaInfo));const e=this._hInputAssemblers[this._nextFreeIAHandle++],n=wi.get(e);return n.firstIndex=this.indicesStart,n.indexCount=t,e}uploadBuffers(){if(0===this.byteOffset||!this._dirty)return;const t=new Float32Array(this.vData.buffer,0,this.byteOffset>>2),e=new Uint16Array(this.iData.buffer,0,this.indicesOffset);this.byteOffset>this.vertexBuffers[0].size&&this.vertexBuffers[0].resize(this.byteOffset),this.vertexBuffers[0].update(t),2*this.indicesOffset>this.indexBuffer.size&&this.indexBuffer.resize(2*this.indicesOffset),this.indexBuffer.update(e),this._dirty=!1}_reallocBuffer(){this._reallocVData(!0),this._reallocIData(!0)}_reallocVData(t){let e;if(this.vData&&(e=new Uint8Array(this.vData.buffer)),this.vData=new Float32Array(this._initVDataCount),e&&t){const t=new Uint8Array(this.vData.buffer);for(let n=0,i=e.length;n<i;n++)t[n]=e[n]}}_reallocIData(t){const e=this.iData;if(this.iData=new Uint16Array(this._initIDataCount),e&&t){const t=this.iData;for(let n=0,i=e.length;n<i;n++)t[n]=e[n]}}}t("MeshBuffer",YF),YF.OPACITY_OFFSET=8;const KF=dl.Enum.NONE|dl.Enum.UI_3D;class $F{get handle(){return this._handle}get hInputAssembler(){return Zi.get(this._handle,Ki.INPUT_ASSEMBLER)}set hInputAssembler(t){Zi.set(this._handle,Ki.INPUT_ASSEMBLER,t)}get hDescriptorSet(){return Zi.get(this._handle,Ki.DESCRIPTOR_SET)}set hDescriptorSet(t){Zi.set(this._handle,Ki.DESCRIPTOR_SET,t)}get visFlags(){return Zi.get(this._handle,Ki.VIS_FLAGS)}set visFlags(t){Zi.set(this._handle,Ki.VIS_FLAGS,t)}get passes(){return this._passes}constructor(){this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._handle=0,this._passes=[],this._handle=Zi.alloc(),Zi.set(this._handle,Ki.VIS_FLAGS,KF),Zi.set(this._handle,Ki.INPUT_ASSEMBLER,0),Zi.set(this._handle,Ki.DESCRIPTOR_SET,0)}destroy(t){if(this._handle){const t=this.passes.length;for(let e=0;e<t;e++)this.passes[e]._destroyHandle();this._passes=[],Zi.free(this._handle),this._handle=0}}clear(){this.bufferBatch=null,this.hInputAssembler=0,this.hDescriptorSet=0,this.camera=null,this.texture=null,this.sampler=null,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=KF}fillPasses(t,e,n,s,o,r){if(t){const a=t.passes;if(!a)return;Zi.set(this._handle,Ki.PASS_COUNT,a.length);let c=Ki.PASS_0,l=Ki.SHADER_0,h=0;for(let t=0;t<a.length;t++,c++,l++){this._passes[t]||(this._passes[t]=new wp(i.director.root),this._passes[t]._handle=Vi.alloc());const _=a[t],u=this._passes[t];e||(e=_.depthStencilState,n=0),s||(s=_.blendState,o=0),-1===o&&(o=0),h=n<<16|o,_.update(),u._initPassFromTarget(_,e,s,h),Zi.set(this._handle,c,u.handle),Zi.set(this._handle,l,u.getShaderVariant(r))}}}}var ZF,JF,QF,tz,ez,nz,iz,sz,oz,rz,az,cz,lz,hz,_z,uz,dz,pz,fz,mz;t("UIStaticBatch",(ZF=i_("cc.UIStaticBatch"),JF=f_(),QF=__(),tz=o_(110),ez=g_(),ZF(nz=JF(nz=QF(nz=tz((Yh((iz=class extends JO{constructor(...t){super(...t),this._init=!1,this._meshBuffer=null,this._dirty=!0,this._lastMeshBuffer=null,this._uiDrawBatchList=[]}get color(){return this._color}set color(t){this._color!==t&&this._color.set(t)}get drawBatchList(){return this._uiDrawBatchList}onLoad(){const t=this._getBatcher();if(!t)return;const e=wN,n=new YF(t);n.initialize(e,this._arrivalMaxBuffer.bind(this)),this._meshBuffer=n}onDestroy(){super.onDestroy(),this._clearData(),this._meshBuffer&&(this._meshBuffer.destroy(),this._meshBuffer=null)}updateAssembler(t){t.currIsStatic=!0,this._dirty&&(t.finishMergeBatches(),this._lastMeshBuffer=t.currBufferBatch,t.currBufferBatch=this._meshBuffer,t.currStaticRoot=this),this._init&&(t.finishMergeBatches(),t.commitStaticBatch(this))}postUpdateAssembler(t){this._dirty&&(t.finishMergeBatches(),t.currBufferBatch=this._lastMeshBuffer,t.currStaticRoot=null,this._dirty=!1,this._init=!0,this.node._static=!0,this._meshBuffer.uploadBuffers()),t.currIsStatic=!1}markAsDirty(){this._getBatcher()&&(this.node._static=!1,this._dirty=!0,this._init=!1,this._clearData())}_requireDrawBatch(){const t=new $F;return t.isStatic=!0,this._uiDrawBatchList.push(t),t}_clearData(){if(this._meshBuffer){this._meshBuffer.reset();const t=this._getBatcher();for(let e=0;e<this._uiDrawBatchList.length;e++)this._uiDrawBatchList[e].destroy(t)}this._uiDrawBatchList.length=0,this._init=!1}_getBatcher(){return qA.root&&qA.root.batcher2D?qA.root.batcher2D:(E(9301),null)}_arrivalMaxBuffer(){const t=this._getBatcher();t&&t.autoMergeBatches(),E(9300)}}).prototype,"color",[M_,ez],Object.getOwnPropertyDescriptor(iz.prototype,"color"),iz.prototype),nz=iz))||nz)||nz)||nz)||nz));let gz=t("LabelShadow",(sz=i_("cc.LabelShadow"),oz=f_(),rz=o_(110),az=__(),cz=s_(uN),lz=y_(),hz=y_(),_z=y_(),sz(uz=oz(uz=rz(uz=az(uz=cz(uz=h_((pz=Yh((dz=class extends Ad{constructor(...t){super(...t),Xh(this,"_color",pz,this),Xh(this,"_offset",fz,this),Xh(this,"_blur",mz,this)}get color(){return this._color}set color(t){this._color!==t&&(this._color.set(t),this._updateRenderData())}get offset(){return this._offset}set offset(t){this._offset=t,this._updateRenderData()}get blur(){return this._blur}set blur(t){this._blur=t,this._updateRenderData()}onEnable(){this._updateRenderData()}onDisable(){this._updateRenderData()}_updateRenderData(){const t=this.node.getComponent(uN);t&&t.updateRenderData(!0)}}).prototype,"_color",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new An(0,0,0,255)}}),fz=Yh(dz.prototype,"_offset",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qe(2,2)}}),mz=Yh(dz.prototype,"_blur",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),Yh(dz.prototype,"color",[lz],Object.getOwnPropertyDescriptor(dz.prototype,"color"),dz.prototype),Yh(dz.prototype,"offset",[hz],Object.getOwnPropertyDescriptor(dz.prototype,"offset"),dz.prototype),Yh(dz.prototype,"blur",[_z],Object.getOwnPropertyDescriptor(dz.prototype,"blur"),dz.prototype),uz=dz))||uz)||uz)||uz)||uz)||uz)||uz));var vz,yz,xz;t("UIOpacity",i_("cc.UIOpacity")(vz=f_()(vz=o_(110)(vz=__()(vz=h_((Yh((yz=class extends Ad{constructor(...t){super(...t),Xh(this,"_opacity",xz,this)}get opacity(){return this._opacity}set opacity(t){this._opacity!==t&&(t=kt(t,0,255),this._opacity=t,this.node._uiProps.localOpacity=t/255)}onEnable(){this.node._uiProps.localOpacity=this._opacity/255}onDisable(){this.node._uiProps.localOpacity=1}}).prototype,"opacity",[m_],Object.getOwnPropertyDescriptor(yz.prototype,"opacity"),yz.prototype),xz=Yh(yz.prototype,"_opacity",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),vz=yz))||vz)||vz)||vz)||vz)||vz);class Sz{constructor(t,e,n){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=e,this.y=n}}function Tz(t,e,n,i,s){let o=0,r=null;if(s===function(t,e,n,i){let s=0;for(let o=e,r=n-i;o<n;o+=i)s+=(t[r]-t[o])*(t[o+1]+t[r+1]),r=o;return s}(t,e,n,i)>0)for(o=e;o<n;o+=i)r=Hz(o,t[o],t[o+1],r);else for(o=n-i;o>=e;o-=i)r=Hz(o,t[o],t[o+1],r);return r&&Bz(r,r.next)&&(Gz(r),r=r.next),r}function Ez(t,e=null){if(!t)return t;e||(e=t);let n=t,i=!1;do{if(i=!1,n.steiner||!Bz(n,n.next)&&0!==Lz(n.prev,n,n.next))n=n.next;else{if(Gz(n),n=e=n.prev,n===n.next)return null;i=!0}}while(i||n!==e);return e}function Az(t,e,n,i,s,o,r=0){if(!t)return;!r&&o&&function(t,e,n,i){let s=t;do{null===s.z&&(s.z=Rz(s.x,s.y,e,n,i)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==t);s.prevZ.nextZ=null,s.prevZ=null,function(t){let e=0,n=null,i=null,s=null,o=null,r=0,a=0,c=0,l=1;do{for(n=t,t=null,o=null,r=0;n;){for(r++,i=n,a=0,e=0;e<l&&(a++,i=i.nextZ,i);e++);for(c=l;a>0||c>0&&i;)0===a?(s=i,i=i.nextZ,c--):0!==c&&i?n.z<=i.z?(s=n,n=n.nextZ,a--):(s=i,i=i.nextZ,c--):(s=n,n=n.nextZ,a--),o?o.nextZ=s:t=s,s.prevZ=o,o=s;n=i}o.nextZ=null,l*=2}while(r>1)}(s)}(t,i,s,o);let a=t,c=null,l=null;for(;t.prev!==t.next;)if(c=t.prev,l=t.next,o?bz(t,i,s,o):Cz(t))e.push(c.i/n),e.push(t.i/n),e.push(l.i/n),Gz(t),t=l.next,a=l.next;else if((t=l)===a){r?1===r?Az(t=Pz(t,e,n),e,n,i,s,o,2):2===r&&wz(t,e,n,i,s,o):Az(Ez(t),e,n,i,s,o,1);break}}function Cz(t){const e=t.prev,n=t,i=t.next;if(Lz(e,n,i)>=0)return!1;let s=t.next.next;for(;s!==t.prev;){if(Mz(e.x,e.y,n.x,n.y,i.x,i.y,s.x,s.y)&&Lz(s.prev,s,s.next)>=0)return!1;s=s.next}return!0}function bz(t,e,n,i){const s=t.prev,o=t,r=t.next;if(Lz(s,o,r)>=0)return!1;const a=s.x<o.x?s.x<r.x?s.x:r.x:o.x<r.x?o.x:r.x,c=s.y<o.y?s.y<r.y?s.y:r.y:o.y<r.y?o.y:r.y,l=s.x>o.x?s.x>r.x?s.x:r.x:o.x>r.x?o.x:r.x,h=s.y>o.y?s.y>r.y?s.y:r.y:o.y>r.y?o.y:r.y,_=Rz(a,c,e,n,i),u=Rz(l,h,e,n,i);let d=t.nextZ;for(;d&&d.z<=u;){if(d!==t.prev&&d!==t.next&&Mz(s.x,s.y,o.x,o.y,r.x,r.y,d.x,d.y)&&Lz(d.prev,d,d.next)>=0)return!1;d=d.nextZ}for(d=t.prevZ;d&&d.z>=_;){if(d!==t.prev&&d!==t.next&&Mz(s.x,s.y,o.x,o.y,r.x,r.y,d.x,d.y)&&Lz(d.prev,d,d.next)>=0)return!1;d=d.prevZ}return!0}function Pz(t,e,n){let i=t;do{const s=i.prev,o=i.next.next;!Bz(s,o)&&Fz(s,i,i.next,o)&&zz(s,o)&&zz(o,s)&&(e.push(s.i/n),e.push(i.i/n),e.push(o.i/n),Gz(i),Gz(i.next),i=t=o),i=i.next}while(i!==t);return i}function wz(t,e,n,i,s,o){let r=t;do{let t=r.next.next;for(;t!==r.prev;){if(r.i!==t.i&&Nz(r,t)){let a=Uz(r,t);return r=Ez(r,r.next),a=Ez(a,a.next),Az(r,e,n,i,s,o),void Az(a,e,n,i,s,o)}t=t.next}r=r.next}while(r!==t)}function Dz(t,e){return t.x-e.x}function Iz(t,e){if(e=function(t,e){let n=e;const i=t.x,s=t.y;let o=-1/0,r=null;do{if(s<=n.y&&s>=n.next.y){const t=n.x+(s-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(t<=i&&t>o){if(o=t,t===i){if(s===n.y)return n;if(s===n.next.y)return n.next}r=n.x<n.next.x?n:n.next}}n=n.next}while(n!==e);if(!r)return null;if(i===o)return r.prev;const a=r,c=r.x,l=r.y;let h,_=1/0;for(n=r.next;n!==a;)i>=n.x&&n.x>=c&&Mz(s<l?i:o,s,c,l,s<l?o:i,s,n.x,n.y)&&(h=Math.abs(s-n.y)/(i-n.x),(h<_||h===_&&n.x>r.x)&&zz(n,t)&&(r=n,_=h)),n=n.next;return r}(t,e)){const n=Uz(e,t);Ez(n,n.next)}}function Rz(t,e,n,i,s){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)/s)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/s)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Oz(t){let e=t,n=t;do{e.x<n.x&&(n=e),e=e.next}while(e!==t);return n}function Mz(t,e,n,i,s,o,r,a){return(s-r)*(e-a)-(t-r)*(o-a)>=0&&(t-r)*(i-a)-(n-r)*(e-a)>=0&&(n-r)*(o-a)-(s-r)*(i-a)>=0}function Nz(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&Fz(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&zz(t,e)&&zz(e,t)&&function(t,e){let n=t,i=!1;const s=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&s<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==t);return i}(t,e)}function Lz(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function Bz(t,e){return t.x===e.x&&t.y===e.y}function Fz(t,e,n,i){return!!(Bz(t,e)&&Bz(n,i)||Bz(t,i)&&Bz(n,e))||Lz(t,e,n)>0!=Lz(t,e,i)>0&&Lz(n,i,t)>0!=Lz(n,i,e)>0}function zz(t,e){return Lz(t.prev,t,t.next)<0?Lz(t,e,t.next)>=0&&Lz(t,t.prev,e)>=0:Lz(t,e,t.prev)<0||Lz(t,t.next,e)<0}function Uz(t,e){const n=new Sz(t.i,t.x,t.y),i=new Sz(e.i,e.x,e.y),s=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=s,s.prev=n,i.next=n,n.prev=i,o.next=i,i.prev=o,i}function Hz(t,e,n,i){const s=new Sz(t,e,n);return i?(s.next=i.next,s.prev=i,i.next.prev=s,i.next=s):(s.prev=s,s.next=s),s}function Gz(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Vz(t,e,n){n=n||3;const i=e?e.length:0,s=i?e[0]*n:t.length;let o=Tz(t,0,s,n,!0);const r=[];if(!o)return r;let a=0,c=0,l=0,h=0,_=0,u=0,d=0;if(i&&(o=function(t,e,n,i){const s=[];let o=0,r=0,a=0,c=0,l=null;for(o=0,r=e.length;o<r;o++)a=e[o]*i,c=o<r-1?e[o+1]*i:t.length,l=Tz(t,a,c,i,!1),l&&(l===l.next&&(l.steiner=!0),s.push(Oz(l)));if(s.sort(Dz),!n)return n;for(o=0;o<s.length;o++)Iz(s[o],n),n=Ez(n,n.next);return n}(t,e,o,n)),t.length>80*n){a=l=t[0],c=h=t[1];for(let e=n;e<s;e+=n)_=t[e],u=t[e+1],_<a&&(a=_),u<c&&(c=u),_>l&&(l=_),u>h&&(h=u);d=Math.max(l-a,h-c)}return Az(o,r,n,a,c,d),r}const jz=Math.PI,Wz=Math.min,kz=Math.max,qz=Math.ceil,Xz=Math.acos,Yz=Math.cos,Kz=Math.sin,$z=Math.atan2;let Zz=null,Jz=null;const Qz=new An,tU=[];for(let t=0;t<4;t++)tU.push(new $e);function eU(t,e,n){return t<e?e:t>n?n:t}const nU={useModel:!0,updateRenderData(t){},fillBuffers(t,e){},renderIA(t,e){},getRenderData(t,e){if(!Jz)return null;const n=Jz.getRenderDataList();let i=n[Jz.dataOffset];if(!i)return null;let s=i;const o=s?s.vertexStart+e:0;return(o>65535||3*o>131070)&&(++Jz.dataOffset,Jz.dataOffset<n.length?i=n[Jz.dataOffset]:(i=Jz.requestRenderData(),n[Jz.dataOffset]=i),s=i),s&&s.vertexCount<o&&s.request(e,3*e),i},stroke(t){An.copy(Qz,t.strokeColor),t.impl&&(this._flattenPaths(t.impl),this._expandStroke(t),t.impl.updatePathOffset=!0,this.end(t))},fill(t){An.copy(Qz,t.fillColor),this._expandFill(t),t.impl&&(t.impl.updatePathOffset=!0),this.end(t)},end(t){t.markForUpdateRenderData()},_expandStroke(t){const e=.5*t.lineWidth,n=t.lineCap,i=t.lineJoin,s=t.miterLimit;if(Jz=t.impl,!Jz)return;const o=function(t,e,n){const i=2*Xz(t/(t+n));return kz(2,qz(e/i))}(e,jz,Jz.tessTol);this._calculateJoins(Jz,e,i,s);const r=Jz.paths;let a=0;for(let t=Jz.pathOffset,e=Jz.pathLength;t<e;t++){const e=r[t],s=e.points.length;i===hN.ROUND?a+=2*(s+e.bevel*(o+2)+1):a+=2*(s+5*e.bevel+1),e.closed||(n===lN.ROUND?a+=2*(2*o+2):a+=12)}const c=Zz=this.getRenderData(t,a);if(!c)return;const l=c.vData,h=c.iData;for(let t=Jz.pathOffset,s=Jz.pathLength;t<s;t++){const s=r[t],a=s.points,_=a.length,u=c.vertexStart;let d,p,f=0,m=0;const g=s.closed;if(g?(d=a[_-1],p=a[0],f=0,m=_):(d=a[0],p=a[1],f=1,m=_-1),p=p||d,!g){const t=new EN(p.x,p.y);t.subtract(d),t.normalize();const i=t.x,s=t.y;n===lN.BUTT?this._buttCapStart(d,i,s,e,0):n===lN.SQUARE?this._buttCapStart(d,i,s,e,e):n===lN.ROUND&&this._roundCapStart(d,i,s,e,o)}for(let t=f;t<m;++t)i===hN.ROUND?this._roundJoin(d,p,e,e,o):0!=(p.flags&(_N.PT_BEVEL|_N.PT_INNERBEVEL))?this._bevelJoin(d,p,e,e):(this._vSet(p.x+p.dmx*e,p.y+p.dmy*e,1),this._vSet(p.x-p.dmx*e,p.y-p.dmy*e,-1)),d=p,p=a[t+1];if(g){const t=8*u;this._vSet(l[t],l[t+1],1),this._vSet(l[t+8],l[t+8+1],-1)}else{const t=new EN(p.x,p.y);t.subtract(d),t.normalize();const i=t.x,s=t.y;n===lN.BUTT?this._buttCapEnd(p,i,s,e,0):n===lN.SQUARE?this._buttCapEnd(p,i,s,e,e):n===lN.ROUND&&this._roundCapEnd(p,i,s,e,o)}let v=c.indicesStart;for(let t=u+2,e=c.vertexStart;t<e;t++)h[v++]=t-2,h[v++]=t-1,h[v++]=t;c.indicesStart=v}Zz=null,Jz=null},_expandFill(t){if(Jz=t.impl,!Jz)return;const e=Jz.paths;let n=0;for(let t=Jz.pathOffset,i=Jz.pathLength;t<i;t++)n+=e[t].points.length;const i=Zz=this.getRenderData(t,n);if(!i)return;const s=i,o=s.vData,r=s.iData;for(let t=Jz.pathOffset,n=Jz.pathLength;t<n;t++){const n=e[t],a=n.points,c=a.length;if(0===c)continue;const l=i.vertexStart;for(let t=0;t<c;++t)this._vSet(a[t].x,a[t].y);let h=i.indicesStart;if(n.complex){const t=[];for(let e=l,n=i.vertexStart;e<n;e++){let n=8*e;t.push(o[n++]),t.push(o[n++]),t.push(o[n++])}const e=Vz(t,null,3);if(!e||0===e.length)continue;for(let t=0,n=e.length;t<n;t++)r[h++]=e[t]+l}else{const t=l;for(let e=l+2,n=s.vertexStart;e<n;e++)r[h++]=t,r[h++]=e-1,r[h++]=e}s.indicesStart=h}Zz=null,Jz=null},_calculateJoins(t,e,n,i){let s=0;e>0&&(s=1/e);const o=t.paths;for(let e=t.pathOffset,r=t.pathLength;e<r;e++){const t=o[e],r=t.points,a=r.length;let c=r[a-1],l=r[0];t.bevel=0;for(let e=0;e<a;e++){let o=0,a=0,h=0;const _=c.dy,u=-c.dx,d=l.dy,p=-l.dx;if(l.dmx=.5*(_+d),l.dmy=.5*(u+p),o=l.dmx*l.dmx+l.dmy*l.dmy,o>1e-6){let t=1/o;t>600&&(t=600),l.dmx*=t,l.dmy*=t}a=l.dx*c.dy-c.dx*l.dy,a>0&&(l.flags|=_N.PT_LEFT),h=kz(11,Wz(c.len,l.len)*s),o*h*h<1&&(l.flags|=_N.PT_INNERBEVEL),l.flags&_N.PT_CORNER&&(o*i*i<1||n===hN.BEVEL||n===hN.ROUND)&&(l.flags|=_N.PT_BEVEL),0!=(l.flags&(_N.PT_BEVEL|_N.PT_INNERBEVEL))&&t.bevel++,c=l,l=r[e+1]}}},_flattenPaths(t){const e=t.paths;for(let n=t.pathOffset,i=t.pathLength;n<i;n++){const t=e[n],i=t.points;let s=i[i.length-1],o=i[0];i.length>2&&s.equals(o)&&(t.closed=!0,i.pop(),s=i[i.length-1]);for(let t=0,e=i.length;t<e;t++){const e=new EN(o.x,o.y);e.subtract(s),s.len=e.length(),(e.x||e.y)&&e.normalize(),s.dx=e.x,s.dy=e.y,s=o,o=i[t+1]}}},_chooseBevel(t,e,n,i){const s=n.x,o=n.y;let r=0,a=0,c=0,l=0;return 0!==t?(r=s+e.dy*i,a=o-e.dx*i,c=s+n.dy*i,l=o-n.dx*i):(r=c=s+n.dmx*i,a=l=o+n.dmy*i),[r,a,c,l]},_buttCapStart(t,e,n,i,s){const o=t.x-e*s,r=t.y-n*s,a=n,c=-e;this._vSet(o+a*i,r+c*i,1),this._vSet(o-a*i,r-c*i,-1)},_buttCapEnd(t,e,n,i,s){const o=t.x+e*s,r=t.y+n*s,a=n,c=-e;this._vSet(o+a*i,r+c*i,1),this._vSet(o-a*i,r-c*i,-1)},_roundCapStart(t,e,n,i,s){const o=t.x,r=t.y,a=n,c=-e;for(let t=0;t<s;t++){const l=t/(s-1)*jz,h=Yz(l)*i,_=Kz(l)*i;this._vSet(o-a*h-e*_,r-c*h-n*_,1),this._vSet(o,r,0)}this._vSet(o+a*i,r+c*i,1),this._vSet(o-a*i,r-c*i,-1)},_roundCapEnd(t,e,n,i,s){const o=t.x,r=t.y,a=n,c=-e;this._vSet(o+a*i,r+c*i,1),this._vSet(o-a*i,r-c*i,-1);for(let t=0;t<s;t++){const l=t/(s-1)*jz,h=Yz(l)*i,_=Kz(l)*i;this._vSet(o,r,0),this._vSet(o-a*h+e*_,r-c*h+n*_,1)}},_roundJoin(t,e,n,i,s){const o=t.dy,r=-t.dx,a=e.dy,c=-e.dx,l=e.x,h=e.y;if(0!=(e.flags&_N.PT_LEFT)){const _=this._chooseBevel(e.flags&_N.PT_INNERBEVEL,t,e,n),u=_[0],d=_[1],p=_[2],f=_[3],m=$z(-r,-o);let g=$z(-c,-a);g>m&&(g-=2*jz),this._vSet(u,d,1),this._vSet(l-o*i,e.y-r*i,-1);const v=eU(qz((m-g)/jz)*s,2,s);for(let t=0;t<v;t++){const e=m+t/(v-1)*(g-m),n=l+Yz(e)*i,s=h+Kz(e)*i;this._vSet(l,h,0),this._vSet(n,s,-1)}this._vSet(p,f,1),this._vSet(l-a*i,h-c*i,-1)}else{const _=this._chooseBevel(e.flags&_N.PT_INNERBEVEL,t,e,-i),u=_[0],d=_[1],p=_[2],f=_[3],m=$z(r,o);let g=$z(c,a);g<m&&(g+=2*jz),this._vSet(l+o*i,h+r*i,1),this._vSet(u,d,-1);const v=eU(qz((g-m)/jz)*s,2,s);for(let t=0;t<v;t++){const e=m+t/(v-1)*(g-m),i=l+Yz(e)*n,s=h+Kz(e)*n;this._vSet(i,s,1),this._vSet(l,h,0)}this._vSet(l+a*i,h+c*i,1),this._vSet(p,f,-1)}},_bevelJoin(t,e,n,i){let s=0,o=0,r=0,a=0,c=0,l=0,h=0,_=0;const u=t.dy,d=-t.dx,p=e.dy,f=-e.dx;if(e.flags&_N.PT_LEFT){const s=this._chooseBevel(e.flags&_N.PT_INNERBEVEL,t,e,n);c=s[0],l=s[1],h=s[2],_=s[3],this._vSet(c,l,1),this._vSet(e.x-u*i,e.y-d*i,-1),this._vSet(h,_,1),this._vSet(e.x-p*i,e.y-f*i,-1)}else{const c=this._chooseBevel(e.flags&_N.PT_INNERBEVEL,t,e,-i);s=c[0],o=c[1],r=c[2],a=c[3],this._vSet(e.x+u*n,e.y+d*n,1),this._vSet(s,o,-1),this._vSet(e.x+p*n,e.y+f*n,1),this._vSet(r,a,-1)}},_vSet(t,e,n=0){if(!Zz)return;const i=Zz;let s=8*i.vertexStart;const o=i.vData;o[s++]=t,o[s++]=e,o[s++]=0,An.toArray(o,Qz,s),s+=4,o[s++]=n,i.vertexStart++}},iU=t("graphicsAssembler",{getAssembler:()=>nU});iL.Assembler=iU;class sU{constructor(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""}}const oU=new Sn;let rU=null,aU=null;const cU=[],lU=[],hU=[],_U=[],uU=new yn,dU=new yn,pU=new qe;let fU=null,mU=0,gU=0,vU=0,yU=0,xU=0,SU=1,TU=null,EU="",AU=0,CU=0,bU=0,PU=0,wU=0,DU=0,IU=0,RU=!1,OU=0,MU=0,NU=0;const LU={updateRenderData(t){t.renderData&&t.renderData.vertDirty&&rU!==t&&(rU=t,aU=rU.node._uiProps.uiTransformComp,this._updateFontFamily(t),this._updateProperties(t),this._updateLabelInfo(t),this._updateContent(),rU.actualFontSize=AU,aU.setContentSize(dU),rU.renderData.vertDirty=rU.renderData.uvDirty=!1,rU.markForUpdateRenderData(!1),rU=null,this._resetProperties())},_updateFontScale(){SU=AU/CU},_updateFontFamily(t){const e=t.font;TU=e.spriteFrame,fU=e.fntConfig,nO.fontAtlas=e.fontDefDictionary,aR.packToDynamicAtlas(t,TU)},_updateLabelInfo(t){nO.hash="",nO.margin=0},_updateProperties(t){EU=t.string.toString(),AU=t.fontSize,CU=fU?fU.fontSize:t.fontSize,bU=t.horizontalAlign,PU=t.verticalAlign,wU=t.spacingX,IU=t.overflow,DU=t._lineHeight;const e=aU.contentSize;dU.width=e.width,dU.height=e.height,IU===aN.NONE?(RU=!1,dU.width+=2*nO.margin,dU.height+=2*nO.margin):IU===aN.RESIZE_HEIGHT?(RU=!0,dU.height+=2*nO.margin):RU=t.enableWrapText,nO.lineHeight=DU,nO.fontSize=AU,this._setupBMFontOverflowMetrics()},_resetProperties(){fU=null,TU=null,nO.hash="",nO.margin=0},_updateContent(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText(){const t=EU,e=t.length,n=fU.kerningDict,i=cU;let s=-1;for(let o=0;o<e;++o){const r=t.charCodeAt(o),a=n[s<<16|65535&r]||0;i[o]=o<e-1?a:0,s=r}},_multilineTextWrap(t){const e=EU.length;let n=0,i=0,s=0,o=0,r=0,a=0,c=0,l=null;for(let h=0;h<e;){let _=EU.charAt(h);if("\n"===_){hU.push(r),r=0,n++,i=0,s-=DU*this._getFontScale()+0,this._recordPlaceholderInfo(h,_),h++;continue}const u=t(EU,h,e);let d=a,p=c,f=r,m=i,g=!1;for(let t=0;t<u;++t){const o=h+t;if(_=EU.charAt(o),"\r"===_){this._recordPlaceholderInfo(o,_);continue}if(l=nO.fontAtlas.getLetterDefinitionForChar(_,nO),!l){this._recordPlaceholderInfo(o,_),console.log(`Can't find letter definition in texture atlas ${fU.atlasName} for letter:${_}`);continue}const a=m+l.offsetX*SU-nO.margin;if(RU&&NU>0&&i>0&&a+l.w*SU>NU&&!WR(_)){hU.push(r),r=0,n++,i=0,s-=DU*this._getFontScale()+0,g=!0;break}pU.x=a,pU.y=s-l.offsetY*SU,this._recordLetterInfo(pU,_,o,n),o+1<cU.length&&o<e-1&&(m+=cU[o+1]),m+=l.xAdvance*SU+wU,f=pU.x+l.w*SU,d<pU.y&&(d=pU.y),p>pU.y-l.h*SU&&(p=pU.y-l.h*SU)}g||(i=m,r=f,a<d&&(a=d),c>p&&(c=p),o<r&&(o=r),h+=u)}return hU.push(r),mU=n+1,gU=mU*DU*this._getFontScale(),mU>1&&(gU+=0*(mU-1)),dU.width=OU,dU.height=MU,OU<=0&&(dU.width=parseFloat(o.toFixed(2))+2*nO.margin),MU<=0&&(dU.height=parseFloat(gU.toFixed(2))+2*nO.margin),yU=dU.height,xU=0,a>0&&(yU=dU.height+a),c<-gU&&(xU=gU+c),!0},_getFirstCharLen:()=>1,_getFontScale:()=>IU===aN.SHRINK?SU:1,_getFirstWordLen(t,e,n){let i=t.charAt(e);if(jR(i)||"\n"===i||WR(i))return 1;let s=1,o=nO.fontAtlas.getLetterDefinitionForChar(i,nO);if(!o)return s;let r=o.xAdvance*SU+wU,a=0;for(let c=e+1;c<n&&(i=t.charAt(c),o=nO.fontAtlas.getLetterDefinitionForChar(i,nO),o);++c){if(a=r+o.offsetX*SU,a+o.w*SU>NU&&!WR(i)&&NU>0)return s;if(r+=o.xAdvance*SU+wU,"\n"===i||WR(i)||jR(i))break;s++}return s},_multilineTextWrapByWord(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo(t,e){if(t>=lU.length){const t=new sU;lU.push(t)}lU[t].char=e,lU[t].hash=e.charCodeAt(0)+nO.hash,lU[t].valid=!1},_recordLetterInfo(t,e,n,i){if(n>=lU.length){const t=new sU;lU.push(t)}const s=e.charCodeAt(0)+nO.hash;lU[n].line=i,lU[n].char=e,lU[n].hash=s,lU[n].valid=nO.fontAtlas.getLetter(s).valid,lU[n].x=t.x,lU[n].y=t.y},_alignText(){gU=0,hU.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),IU===aN.SHRINK&&AU>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||IU===aN.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown(t){let e=!0;t||(t=.1,e=!1),AU=t,e&&this._updateContent()},_shrinkLabelToContentSize(t){let e=0,n=0|AU,i=0;for(;e<n;){i=e+n+1>>1;const s=i;if(s<=0)break;SU=s/CU,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),t()?n=i-1:e=i}e>=0&&this._scaleFontSizeDown(e)},_isVerticalClamp:()=>gU>dU.height,_isHorizontalClamp(){let t=!1;for(let e=0,n=EU.length;e<n;++e){const n=lU[e];if(n.valid){const e=nO.fontAtlas.getLetterDefinitionForChar(n.char,nO);if(!e)continue;const i=n.x+e.w/2*SU,s=n.line;if(OU>0)if(RU){if(hU[s]>dU.width&&(i>dU.width||i<0)){t=!0;break}}else if(i>dU.width){t=!0;break}}}return t},_isHorizontalClamped(t,e){const n=hU[e],i=t>dU.width||t<0;return RU?n>dU.width&&i:i},_updateQuads(){if(!rU)return!1;const t=TU?TU.texture:nO.fontAtlas.getTexture(),e=rU.renderData;e.dataLength=e.vertexCount=e.indicesCount=0;const n=aU.anchorPoint,i=dU,s=n.x*i.width,o=n.y*i.height;let r=!0;for(let e=0,n=EU.length;e<n;++e){const n=lU[e];if(!n.valid)continue;const i=nO.fontAtlas.getLetter(n.hash);if(!i){console.warn("Can't find letter in this bitmap-font");continue}oU.height=i.h,oU.width=i.w,oU.x=i.u,oU.y=i.v;let a=n.y+vU;if(MU>0){if(a>yU){const t=a-yU;oU.y+=t,oU.height-=t,a-=t}a-i.h*SU<xU&&IU===aN.CLAMP&&(oU.height=a<xU?0:(a-xU)/SU)}const c=n.line,l=n.x+i.w/2*SU+_U[c];if(OU>0&&this._isHorizontalClamped(l,c))if(IU===aN.CLAMP)oU.width=0;else if(IU===aN.SHRINK){if(dU.width>i.w){r=!1;break}oU.width=0}if(oU.height>0&&oU.width>0){const e=this._determineRect(),i=n.x+_U[n.line];this.appendQuad(rU,t,oU,e,i-s,a-o,SU)}}return r},appendQuad(t,e,n,i,s,o,r){},_determineRect(){const t=TU.isRotated(),e=TU.getOriginalSize(),n=TU.getRect(),i=TU.getOffset(),s=i.x+(e.width-n.width)/2,o=i.y-(e.height-n.height)/2;if(t){const t=oU.x;oU.x=n.x+n.height-oU.y-oU.height-o,oU.y=t+n.y-s,oU.y<0&&(oU.height+=o)}else oU.x+=n.x-s,oU.y+=n.y+o;return t},_computeAlignmentOffset(){switch(_U.length=0,bU){case oN.LEFT:for(let t=0;t<mU;++t)_U.push(0);break;case oN.CENTER:for(let t=0,e=hU.length;t<e;t++)_U.push((dU.width-hU[t])/2);break;case oN.RIGHT:for(let t=0,e=hU.length;t<e;t++)_U.push(dU.width-hU[t])}if(vU=dU.height,PU!==rN.TOP){const t=dU.height-gU+DU*this._getFontScale()-CU*SU;PU===rN.BOTTOM?vU-=t:vU-=t/2}},_setupBMFontOverflowMetrics(){let t=dU.width,e=dU.height;IU===aN.RESIZE_HEIGHT&&(e=0),IU===aN.NONE&&(t=0,e=0),OU=t,MU=e,uU.width=t,uU.height=e,NU=t}},BU=new An(255,255,255,255),FU={createData:t=>t.requestRenderData(),fillBuffers(t,e){const n=t.node;t._setCacheAlpha(n._uiProps.opacity),BU.set(t.color),BU.a=255*n._uiProps.opacity,iR(n,e,t.renderData,BU)},appendQuad(t,e,n,i,s,o,r){const a=t.renderData;if(!a)return;const c=a.dataLength;a.dataLength+=4,a.vertexCount=a.dataLength,a.indicesCount=a.dataLength/2*3;const l=a.data,h=e.width,_=e.height,u=n.width,d=n.height;let p=0,f=0,m=0,g=0;i?(p=n.x/h,g=(n.x+d)/h,f=(n.y+u)/_,m=n.y/_,l[c].u=p,l[c].v=m,l[c+1].u=p,l[c+1].v=f,l[c+2].u=g,l[c+2].v=m,l[c+3].u=g,l[c+3].v=f):(p=n.x/h,g=(n.x+u)/h,f=(n.y+d)/_,m=n.y/_,l[c].u=p,l[c].v=f,l[c+1].u=g,l[c+1].v=f,l[c+2].u=p,l[c+2].v=m,l[c+3].u=g,l[c+3].v=m),l[c].x=s,l[c].y=o-d*r,l[c+1].x=s+u*r,l[c+1].y=o-d*r,l[c+2].x=s,l[c+2].y=o,l[c+3].x=s+u*r,l[c+3].y=o}};lt(FU,LU);let zU=null;const UU=ht(LU,{getAssemblerData:()=>(zU||(zU=new eO(1024,1024)),zU.getTexture()),_updateFontFamily(t){nO.fontAtlas=zU,nO.fontFamily=this._getFontFamily(t);const e=t.getComponent(KL);e&&e.enabled?(nO.isOutlined=!0,nO.margin=e.width,nO.out=e.color.clone(),nO.out.a=e.color.a*t.color.a/255):(nO.isOutlined=!1,nO.margin=0)},_getFontFamily(t){let e="Arial";return t.useSystemFont?e=t.fontFamily||"Arial":t.font&&(t.font._nativeAsset?e=t.font._nativeAsset:sb.postLoadNative(t.font,(()=>{t.isValid&&(e=t.font._nativeAsset||"Arial",t.updateRenderData(!0))}))),e},_updateLabelInfo(t){nO.fontDesc=this._getFontDesc(),nO.color=t.color,nO.hash=function(t){const e=t.color.toHEX();let n="";return t.isOutlined&&t.margin>0&&(n=n+t.margin+t.out.toHEX()),""+t.fontSize+t.fontFamily+e+n}(nO)},_getFontDesc(){let t=`${nO.fontSize.toString()}px `;return t+=nO.fontFamily,t},_computeHorizontalKerningForText(){},_determineRect:()=>!1}),HU=new An(255,255,255,255),GU={createData:t=>t.requestRenderData(),fillBuffers(t,e){if(!t.renderData)return;const n=t.node;t._setCacheAlpha(n._uiProps.opacity),HU.a=255*n._uiProps.opacity,iR(n,e,t.renderData,HU)},appendQuad:FU.appendQuad};lt(GU,UU);const VU=uN.Overflow,jU=(1/255).toFixed(3);let WU=null,kU=null,qU=null,XU="",YU="",KU=0,$U=0,ZU=[];const JU=new yn;let QU=0,tH=0,eH=0,nH=new An,iH=1,sH="",oH=VU.NONE,rH=!1,aH=null;const cH=An.BLACK.clone();let lH=null;const hH=An.BLACK.clone(),_H=new Sn,uH=yn.ZERO.clone(),dH=yn.ZERO.clone(),pH=qe.ZERO.clone(),fH=qe.ZERO.clone();let mH=0,gH=0,vH=!1,yH=!1,xH=!1;const SH=["left","center","right"],TH={getAssemblerData:()=>uN._canvasPool.get(),resetAssemblerData(t){t&&uN._canvasPool.put(t)},updateRenderData(t){if(!t.renderData||!t.renderData.vertDirty)return;const e=t.node._uiProps.uiTransformComp;this._updateFontFamily(t),this._updateProperties(t,e),this._calculateLabelFont(),this._updateLabelDimensions(),this._resetDynamicAtlas(t),this._updateTexture(t),this.updateOpacity(t),t._setCacheAlpha(iH),this._calDynamicAtlas(t),t.actualFontSize=KU,e.setContentSize(JU),this.updateVertexData(t),this.updateUvs(t),t.markForUpdateRenderData(!1),WU=null,kU=null,qU=null},updateVertexData(t){},updateUvs(t){},updateOpacity(t){const e=t.renderData.vData;let n=5;const i=t.node._uiProps.opacity;for(let t=0;t<4;t++)e[n+3]=i,n+=9},_updateFontFamily(t){t.useSystemFont?sH=t.fontFamily||"Arial":t.font?t.font._nativeAsset?sH=t.font._nativeAsset:(sb.postLoadNative(t.font,(()=>{t.isValid&&(sH=t.font._nativeAsset||"Arial",t.updateRenderData(!0))})),sH="Arial"):sH="Arial"},_updateProperties(t,e){const n=t.assemblerData;n&&(WU=n.context,kU=n.canvas,qU=t.spriteFrame,YU=t.string.toString(),KU=t.fontSize,$U=KU,oH=t.overflow,dH.width=JU.width=e.width,dH.height=JU.height=e.height,gH=t.underlineHeight,QU=t.lineHeight,tH=t.horizontalAlign,eH=t.verticalAlign,nH=t.color,iH=t.node._uiProps.opacity,vH=t.isBold,yH=t.isItalic,xH=t.isUnderline,rH=oH!==VU.NONE&&(oH===VU.RESIZE_HEIGHT||t.enableWrapText),aH=KL&&t.getComponent(KL),aH=aH&&aH.enabled&&aH.width>0?aH:null,aH&&cH.set(aH.color),lH=gz&&t.getComponent(gz),lH=lH&&lH.enabled?lH:null,lH&&hH.set(lH.color),this._updatePaddingRect())},_updatePaddingRect(){let t=0,e=0,n=0,i=0,s=0;if(uH.width=uH.height=0,aH&&(s=aH.width,t=e=n=i=s,uH.width=uH.height=2*s),lH){const o=lH.blur+s,r=lH.offset.x,a=lH.offset.y;n=Math.max(n,-r+o),i=Math.max(i,r+o),t=Math.max(t,a+o),e=Math.max(e,-a+o)}if(yH){const t=$U*Math.tan(.20943951);i+=t,uH.width+=t}_H.x=n,_H.y=t,_H.width=n+i,_H.height=t+e},_calculateFillTextStartPosition(){let t=0;tH===oN.RIGHT?t=JU.width-_H.width:tH===oN.CENTER&&(t=(JU.width-_H.width)/2);const e=this._getLineHeight()*(ZU.length-1);let n=KU*(1-NR/2);if(eH!==rN.TOP){let t=e+_H.height+KU-JU.height;eH===rN.BOTTOM?(t+=NR/2*KU,n-=t):n-=t/2}n+=0*KU,pH.set(t+_H.x,n+_H.y)},_updateTexture(t){if(!WU||!kU)return;WU.clearRect(0,0,kU.width,kU.height),WU.font=XU,this._calculateFillTextStartPosition();const e=this._getLineHeight();WU.lineJoin="round",t._srcBlendFactor===Xo.SRC_ALPHA&&(WU.fillStyle=`rgba(${nH.r}, ${nH.g}, ${nH.b}, ${jU})`,WU.fillRect(0,0,kU.width,kU.height)),WU.fillStyle=`rgb(${nH.r}, ${nH.g}, ${nH.b})`;const n=pH.x;let s=0;this._drawTextEffect(pH,e);for(let t=0;t<ZU.length;++t)s=pH.y+t*e,aH&&WU.strokeText(ZU[t],n,s),WU.fillText(ZU[t],n,s);if(lH&&(WU.shadowColor="transparent"),qU){let t;t=qU instanceof hR?qU.texture:qU,0!==kU.width&&0!==kU.height&&(t.reset({width:kU.width,height:kU.height,mipmapLevel:1}),t.uploadData(kU),qU instanceof hR&&(qU.rect=new Sn(0,0,kU.width,kU.height),qU._calculateUV()),i.director.root&&i.director.root.batcher2D&&i.director.root.batcher2D._releaseDescriptorSetCache(t.getHash()))}},_resetDynamicAtlas(t){if(t.cacheMode!==uN.CacheMode.BITMAP)return;const e=t.ttfSpriteFrame;aR.deleteAtlasSpriteFrame(e),e._resetDynamicAtlasFrame()},_calDynamicAtlas(t){if(t.cacheMode!==uN.CacheMode.BITMAP)return;const e=t.ttfSpriteFrame;aR.packToDynamicAtlas(t,e),t.renderData.uvDirty=!0},_setupOutline(){WU.strokeStyle=`rgba(${cH.r}, ${cH.g}, ${cH.b}, ${cH.a/255})`,WU.lineWidth=2*aH.width},_setupShadow(){WU.shadowColor=`rgba(${hH.r}, ${hH.g}, ${hH.b}, ${hH.a/255})`,WU.shadowBlur=lH.blur,WU.shadowOffsetX=lH.offset.x,WU.shadowOffsetY=-lH.offset.y},_drawTextEffect(t,e){if(!lH&&!aH&&!xH)return;const n=ZU.length>1&&lH,i=this._measureText(WU,XU);let s=0,o=0;lH&&this._setupShadow(),aH&&this._setupOutline();for(let r=0;r<ZU.length;++r)s=t.x,o=t.y+r*e,n&&(aH&&WU.strokeText(ZU[r],s,o),WU.fillText(ZU[r],s,o)),xH&&(mH=i(ZU[r]),tH===oN.RIGHT?fH.x=t.x-mH:tH===oN.CENTER?fH.x=t.x-mH/2:fH.x=t.x,fH.y=o+$U/8,WU.fillRect(fH.x,fH.y,mH,gH));n&&(WU.shadowColor="transparent")},_updateLabelDimensions(){JU.width=Math.min(JU.width,2048),JU.height=Math.min(JU.height,2048);let t=!1;kU.width!==JU.width&&(kU.width=JU.width,t=!0),kU.height!==JU.height&&(kU.height=JU.height,t=!0),t&&(WU.font=XU),WU.textAlign=SH[tH],WU.textBaseline="alphabetic"},_getFontDesc(){let t=`${KU.toString()}px `;return t+=sH,vH&&(t=`bold ${t}`),yH&&(t=`italic ${t}`),t},_getLineHeight(){let t=QU;return t=0===t?KU:t*KU/$U,0|t},_calculateParagraphLength(t,e){const n=[];for(const i of t){const t=kR(e,i,XU);n.push(t)}return n},_measureText:(t,e)=>n=>kR(t,n,e),_calculateShrinkFont(t){if(!WU)return;const e=this._calculateParagraphLength(t,WU);let n=0,i=0,s=0;if(rH){const e=dH.width,s=dH.height;if(e<0||s<0)return;i=s+1;let o=[],r=0,a=0|KU+1,c=0;for(;r<a;){if(c=r+a+1>>1,c<=0){S(4003);break}KU=c,XU=this._getFontDesc(),WU.font=XU;const l=this._getLineHeight();for(i=0,n=0;n<t.length;++n){const s=kR(WU,t[n],XU);o=XR(t[n],s,e,this._measureText(WU,XU)),i+=o.length*l}i>s?a=c-1:r=c}0===r?S(4003):(KU=r,XU=this._getFontDesc(),WU.font=XU)}else{for(i=t.length*this._getLineHeight(),n=0;n<t.length;++n)s<e[n]&&(s=e[n]);const o=(JU.width-_H.width)/s,r=JU.height/i;KU=$U*Math.min(1,o,r)|0,XU=this._getFontDesc(),WU.font=XU}},_calculateWrapText(t){if(!rH||!WU)return;ZU=[];const e=dH.width;for(let n=0;n<t.length;++n){const i=kR(WU,t[n],XU),s=XR(t[n],i,e,this._measureText(WU,XU));ZU=ZU.concat(s)}},_calculateLabelFont(){if(!WU)return;const t=YU.split("\n");switch(ZU=t,XU=this._getFontDesc(),WU.font=XU,oH){case VU.NONE:{let e=0,n=0;for(let n=0;n<t.length;++n){const i=kR(WU,t[n],XU);e=e>i?e:i}n=(ZU.length+NR)*this._getLineHeight();const i=parseFloat(e.toFixed(2)),s=parseFloat(n.toFixed(2));JU.width=i+_H.width,JU.height=s+_H.height,dH.width=i+uH.width,dH.height=s+uH.height;break}case VU.SHRINK:this._calculateShrinkFont(t),this._calculateWrapText(t);break;case VU.CLAMP:this._calculateWrapText(t);break;case VU.RESIZE_HEIGHT:{this._calculateWrapText(t);const e=(ZU.length+NR)*this._getLineHeight();JU.height=e+_H.height,dH.height=e+uH.height;break}}}},EH=An.WHITE.clone(),AH={createData(t){const e=t.requestRenderData();e.dataLength=4,e.vertexCount=4,e.indicesCount=6;const n=e.vData=new Float32Array(36);n[3]=n[21]=n[22]=n[31]=0,n[4]=n[12]=n[13]=n[30]=1;let i=5;for(let t=0;t<4;t++)An.toArray(n,EH,i),i+=9;return e},fillBuffers(t,e){const n=t.renderData,i=n.data,s=t.node;let o=e.acquireBufferBatch(),r=o.byteOffset>>2,a=o.indicesOffset,c=o.vertexOffset;o.request()||(o=e.currBufferBatch,a=0,c=0,r=0);const l=o.vData,h=o.iData,_=n.vData,u=i[0],d=i[3];s.updateWorldTransform();const p=s._pos,f=s._rot,m=s._scale,g=u.x*m.x,v=d.x*m.x,y=u.y*m.y,x=d.y*m.y,S=f.x,T=f.y,E=f.z,A=f.w,C=S*T,b=E*A,P=S*S-T*T,w=A*A-E*E,D=w+P,I=2*(C-b),R=w-P,O=2*(C+b),M=p.x,N=p.y;_[0]=D*g+I*y+M,_[1]=R*y+O*g+N,_[9]=D*v+I*y+M,_[10]=R*y+O*v+N,_[18]=D*g+I*x+M,_[19]=R*x+O*g+N,_[27]=D*v+I*x+M,_[28]=R*x+O*v+N,l.set(_,r),h[a++]=c,h[a++]=c+1,h[a++]=c+2,h[a++]=c+2,h[a++]=c+1,h[a++]=c+3},updateVertexData(t){const e=t.renderData;if(!e)return;const n=t.node._uiProps.uiTransformComp,i=n.width,s=n.height,o=n.anchorX*i,r=n.anchorY*s,a=e.data;a[0].x=-o,a[0].y=-r,a[3].x=i-o,a[3].y=s-r},updateUvs(t){const e=t.renderData;if(!e)return;const n=e.vData;if(!n||!e.uvDirty)return;const i=t.ttfSpriteFrame.uv;n[3]=i[0],n[4]=i[1],n[12]=i[2],n[13]=i[3],n[21]=i[4],n[22]=i[5],n[30]=i[6],n[31]=i[7],e.uvDirty=!1}};lt(AH,TH);const CH=t("labelAssembler",{getAssembler(t){let e=AH;return t.font instanceof RR?e=FU:t.cacheMode===uN.CacheMode.CHAR&&(e=GU),e}});uN.Assembler=CH;const bH=UB.FillType,PH=new pn,wH=new An(255,255,255,255),DH={useModel:!1,updateRenderData(t){const e=t.spriteFrame;aR.packToDynamicAtlas(t,e);const n=t.renderData;if(n&&e){const e=n.uvDirty,i=n.vertDirty;if(!e&&!i)return;let s=t.fillStart,o=t.fillRange;o<0&&(s+=o,o=-o),o=s+o,s=s>1?1:s,s=s<0?0:s,o=o>1?1:o,o=o<0?0:o,o-=s,o=o<0?0:o;let r=s+o;r=r>1?1:r,e&&this.updateUVs(t,s,r),i&&(this.updateVertexData&&this.updateVertexData(t,s,r),this.updateWorldVertexData(t))}},updateUVs(t,e,n){const i=t.spriteFrame,s=t.renderData,o=s.data,r=i.width,a=i.height,c=i.getRect();let l=0,h=0,_=0,u=0,d=0,p=0,f=0,m=0,g=0,v=0,y=0,x=0;switch(i.isRotated()?(l=c.x/r,h=(c.y+c.width)/a,_=(c.x+c.height)/r,u=c.y/a,d=f=l,g=y=_,m=x=h,p=v=u):(l=c.x/r,h=(c.y+c.height)/a,_=(c.x+c.width)/r,u=c.y/a,d=g=l,f=y=_,p=m=h,v=x=u),t.fillType){case bH.HORIZONTAL:o[0].u=d+(f-d)*e,o[0].v=p+(m-p)*e,o[1].u=d+(f-d)*n,o[1].v=p+(m-p)*n,o[2].u=g+(y-g)*e,o[2].v=v+(x-v)*e,o[3].u=g+(y-g)*n,o[3].v=v+(x-v)*n;break;case bH.VERTICAL:o[0].u=d+(g-d)*e,o[0].v=p+(v-p)*e,o[1].u=f+(y-f)*e,o[1].v=m+(x-m)*e,o[2].u=d+(g-d)*n,o[2].v=p+(v-p)*n,o[3].u=f+(y-f)*n,o[3].v=m+(x-m)*n;break;default:C(2626)}s.uvDirty=!1},updateVertexData(t,e,n){const i=t.renderData,s=i.data,o=t.node._uiProps.uiTransformComp,r=o.width,a=o.height,c=o.anchorX*r,l=o.anchorY*a;let h=-c,_=-l,u=r-c,d=a-l,p=0,f=0;switch(t.fillType){case bH.HORIZONTAL:p=h+(u-h)*e,f=h+(u-h)*n,h=p,u=f;break;case bH.VERTICAL:p=_+(d-_)*e,f=_+(d-_)*n,_=p,d=f;break;default:C(2626)}s[4].x=h,s[4].y=_,s[5].x=u,s[5].y=_,s[6].x=h,s[6].y=d,s[7].x=u,s[7].y=d,i.vertDirty=!1},createData(t){const e=t.requestRenderData();e.dataLength=8,e.vertexCount=4,e.indicesCount=6;const n=e.data;for(const t of n)t.z=0;return e},updateWorldVertexData(t){const e=t.node,n=t.renderData.data;e.getWorldMatrix(PH);for(let t=0;t<4;t++){const e=n[t+4],i=n[t];$e.transformMat4(i,e,PH)}},fillBuffers(t,e){t.node.hasChangedFlags&&this.updateWorldVertexData(t);const n=t.node;wH.set(t.color),wH.a=255*n._uiProps.opacity,function(t,e,n,i){const s=n.data;let o=e.acquireBufferBatch(),r=o.byteOffset>>2,a=n.vertexCount,c=o.indicesOffset,l=o.vertexOffset;o.request(a,n.indicesCount)||(o=e.currBufferBatch,a=0,c=0,l=0);const h=o.vData;for(let t=0;t<a;t++){const e=s[t];h[r++]=e.x,h[r++]=e.y,h[r++]=e.z,h[r++]=e.u,h[r++]=e.v,An.toArray(h,i,r),r+=4}const _=o.iData;_[c++]=l,_[c++]=l+1,_[c++]=l+2,_[c++]=l+1,_[c++]=l+3,_[c++]=l+2}(0,e,t.renderData,wH)},updateColor(t){}},IH=2*Math.PI,RH=1e-6,OH=new An(255,255,255,255),MH=[new qe,new qe,new qe,new qe],NH=new Array(4),LH=new Array(8),BH=[new qe,new qe,new qe,new qe],FH=[new qe,new qe,new qe,new qe],zH=new qe,UH=[new qe,new qe,new qe,new qe];function HH(t,e,n,i,s,o,r){let a=Math.sin(o);a=Math.abs(a)>RH?a:0;let c=Math.cos(o);c=Math.abs(c)>RH?c:0;let l=0,h=0;if(0!==c){if(l=a/c,(t-s.x)*c>0){const e=s.y+l*(t-s.x);r[0].x=t,r[0].y=e}if((e-s.x)*c>0){const t=s.y+l*(e-s.x);r[2].x=e,r[2].y=t}}if(0!==a){if(h=c/a,(i-s.y)*a>0){const t=s.x+h*(i-s.y);r[3].x=t,r[3].y=i}if((n-s.y)*a>0){const t=s.x+h*(n-s.y);r[1].x=t,r[1].y=n}}}function GH(t,e){const n=e.x-t.x,i=e.y-t.y;if(0===n&&0===i)return 0;if(0===n)return i>0?.5*Math.PI:1.5*Math.PI;{let t=Math.atan(i/n);return n<0&&(t+=Math.PI),t}}function VH(t,e,n,i,s){const o=NH,r=o[0],a=o[1],c=o[2],l=o[3];t[e].x=n.x,t[e].y=n.y,t[e+1].x=i.x,t[e+1].y=i.y,t[e+2].x=s.x,t[e+2].y=s.y;let h=0,_=0;h=(n.x-r)/(c-r),_=(n.y-a)/(l-a),jH(h,_,t,e),h=(i.x-r)/(c-r),_=(i.y-a)/(l-a),jH(h,_,t,e+1),h=(s.x-r)/(c-r),_=(s.y-a)/(l-a),jH(h,_,t,e+2)}function jH(t,e,n,i){const s=LH,o=s[0]+(s[2]-s[0])*t,r=s[4]+(s[6]-s[4])*t,a=s[1]+(s[3]-s[1])*t,c=s[5]+(s[7]-s[5])*t,l=n[i];l.u=o+(r-o)*e,l.v=a+(c-a)*e}const WH={useModel:!1,createData:t=>t.requestRenderData(),updateRenderData(t){const e=t.spriteFrame;aR.packToDynamicAtlas(t,e);const n=t.renderData;if(n&&e&&(n.vertDirty||n.uvDirty)){const i=n.data;let s=t.fillStart,o=t.fillRange;for(o<0&&(s+=o,o=-o);s>=1;)s-=1;for(;s<0;)s+=1;s*=IH,o*=IH;const r=s+o;!function(t){const e=t.node._uiProps.uiTransformComp,n=e.width,i=e.height,s=e.anchorX*n,o=e.anchorY*i,r=-s,a=-o,c=n-s,l=i-o,h=NH;h[0]=r,h[1]=a,h[2]=c,h[3]=l;const _=t.fillCenter,u=zH.x=Math.min(Math.max(0,_.x),1)*(c-r)+r,d=zH.y=Math.min(Math.max(0,_.y),1)*(l-a)+a;MH[0].x=MH[3].x=r,MH[1].x=MH[2].x=c,MH[0].y=MH[1].y=a,MH[2].y=MH[3].y=l;for(const t of UH)qe.set(t,0,0);u!==h[0]&&qe.set(UH[0],3,0),u!==h[2]&&qe.set(UH[2],1,2),d!==h[1]&&qe.set(UH[1],0,1),d!==h[3]&&qe.set(UH[3],2,3)}(t),function(t){const e=t.width,n=t.height,i=t.getRect();let s=0,o=0,r=0,a=0;const c=LH;t.isRotated()?(s=i.x/e,o=(i.x+i.height)/e,r=i.y/n,a=(i.y+i.width)/n,c[0]=c[2]=s,c[4]=c[6]=o,c[3]=c[7]=a,c[1]=c[5]=r):(s=i.x/e,o=(i.x+i.width)/e,r=i.y/n,a=(i.y+i.height)/n,c[0]=c[4]=s,c[2]=c[6]=o,c[1]=c[3]=a,c[5]=c[7]=r)}(e),HH(NH[0],NH[2],NH[1],NH[3],zH,s,BH),HH(NH[0],NH[2],NH[1],NH[3],zH,s+o,FH);let a=0;for(let t=0;t<4;++t){const e=UH[t];if(!e)continue;if(o>=IH){n.dataLength=a+3,VH(i,a,zH,MH[e.x],MH[e.y]),a+=3;continue}let c=GH(zH,MH[e.x]),l=GH(zH,MH[e.y]);l<c&&(l+=IH),c-=IH,l-=IH;for(let o=0;o<3;++o)c>=r||(c>=s?(n.dataLength=a+3,VH(i,a,zH,MH[e.x],l>=r?FH[t]:MH[e.y]),a+=3):l>s&&(l<=r?(n.dataLength=a+3,VH(i,a,zH,BH[t],MH[e.y]),a+=3):(n.dataLength=a+3,VH(i,a,zH,BH[t],FH[t]),a+=3))),c+=IH,l+=IH}n.indicesCount=n.vertexCount=a,n.vertDirty=n.uvDirty=!1}},fillBuffers(t,e){const n=t.node,i=t.renderData;OH.set(t.color),OH.a=255*n._uiProps.opacity,function(t,e,n,i){const s=n.data;let o=e.acquireBufferBatch(),r=o.byteOffset>>2,a=n.vertexCount,c=o.indicesOffset,l=o.vertexOffset;o.request(a,n.indicesCount)||(o=e.currBufferBatch,a=0,c=0,l=0);const h=o.vData;t.getWorldMatrix(nR);for(let t=0;t<a;t++){const e=s[t];$e.set(eR,e.x,e.y,0),$e.transformMat4(eR,eR,nR),h[r++]=eR.x,h[r++]=eR.y,h[r++]=eR.z,h[r++]=e.u,h[r++]=e.v,An.toArray(h,i,r),r+=4}const _=o.iData;for(let t=0;t<n.dataLength;t++)_[c+t]=l+t}(n,e,i,OH)},updateColor(t){}},kH=[];for(let t=0;t<4;t++)kH.push(new $e);const qH={createData(t){const e=t.requestRenderData();return e.dataLength=4,e.vertexCount=4,e.indicesCount=6,e.vData=new Float32Array(36),e},updateRenderData(t){const e=t.spriteFrame;aR.packToDynamicAtlas(t,e);const n=t.renderData;n&&e&&(n.vertDirty&&this.updateVertexData(t),n.uvDirty&&this.updateUvs(t))},fillBuffers(t,e){if(null===t)return;const n=t.renderData.data,i=t.node;let s=e.acquireBufferBatch(),o=s.byteOffset>>2,r=s.indicesOffset,a=s.vertexOffset;s.request()||(s=e.currBufferBatch,o=0,r=0,a=0);const c=s.vData,l=s.iData,h=t.renderData.vData,_=n[0],u=n[3],d=i.worldMatrix,p=d.m00,f=d.m01,m=d.m04,g=d.m05,v=d.m12,y=d.m13,x=_.x,S=u.x,T=_.y,E=u.y,A=p*x,C=p*S,b=f*x,P=f*S,w=m*T,D=m*E,I=g*T,R=g*E;h[0]=A+w+v,h[1]=b+I+y,h[9]=C+w+v,h[10]=P+I+y,h[18]=A+D+v,h[19]=b+R+y,h[27]=C+D+v,h[28]=P+R+y,c.set(h,o),l[r++]=a,l[r++]=a+1,l[r++]=a+2,l[r++]=a+2,l[r++]=a+1,l[r++]=a+3},updateVertexData(t){const e=t.renderData;if(!e)return;const n=t.node._uiProps.uiTransformComp,i=e.data,s=n.width,o=n.height,r=n.anchorX*s,a=n.anchorY*o;let c=0,l=0,h=0,_=0;if(t.trim)c=-r,l=-a,h=s-r,_=o-a;else{const e=t.spriteFrame,n=e.getOriginalSize(),i=e.getRect(),u=n.width,d=n.height,p=i.width,f=i.height,m=e.getOffset(),g=s/u,v=o/d,y=m.x+(u-p)/2,x=m.x-(u-p)/2;c=y*g-r,l=(m.y+(d-f)/2)*v-a,h=s+x*g-r,_=o+(m.y-(d-f)/2)*v-a}i[0].x=c,i[0].y=l,i[0].z=0,i[3].x=h,i[3].y=_,i[3].z=0,e.vertDirty=!1},updateUvs(t){const e=t.renderData,n=e.vData,i=t.spriteFrame.uv;n[3]=i[0],n[4]=i[1],n[12]=i[2],n[13]=i[3],n[21]=i[4],n[22]=i[5],n[30]=i[6],n[31]=i[7],e.uvDirty=!1},updateColor(t){const e=t.renderData.vData;let n=5;const i=t.color,s=i.r/255,o=i.g/255,r=i.b/255,a=t.node._uiProps.opacity;for(let t=0;t<4;t++)e[n]=s,e[n+1]=o,e[n+2]=r,e[n+3]=a,n+=9}},XH=new $e,YH=new pn,KH={useModel:!1,createData(t){const e=t.requestRenderData();return e.dataLength=20,e.vertexCount=16,e.indicesCount=54,e},updateRenderData(t){const e=t.spriteFrame;aR.packToDynamicAtlas(t,e);const n=t.renderData;n&&e&&n.vertDirty&&(this.updateVertexData(t),this.updateWorldVertexData(t))},updateVertexData(t){const e=t.renderData,n=e.data,i=t.node._uiProps.uiTransformComp,s=i.width,o=i.height,r=i.anchorX*s,a=i.anchorY*o,c=t.spriteFrame,l=c.insetLeft,h=c.insetRight,_=c.insetTop,u=c.insetBottom;let d=s-l-h,p=o-_-u,f=s/(l+h),m=o/(_+u);f=Number.isNaN(f)||f>1?1:f,m=Number.isNaN(m)||m>1?1:m,d=d<0?0:d,p=p<0?0:p,n[0].x=-r,n[0].y=-a,n[1].x=l*f-r,n[1].y=u*m-a,n[2].x=n[1].x+d,n[2].y=n[1].y+p,n[3].x=s-r,n[3].y=o-a,e.vertDirty=!1},fillBuffers(t,e){t.node.hasChangedFlags&&this.updateWorldVertexData(t);let n=e.acquireBufferBatch();const i=t.renderData,s=i.data;let o=n.byteOffset>>2;const r=i.vertexCount;let a=n.indicesOffset,c=n.vertexOffset;const l=t.spriteFrame.uvSliced;n.request(r,i.indicesCount)||(n=e.currBufferBatch,o=0,a=0,c=0);const h=n.vData,_=n.iData;for(let t=4;t<20;++t){const e=s[t],n=l[t-4];h[o++]=e.x,h[o++]=e.y,h[o++]=e.z,h[o++]=n.u,h[o++]=n.v,An.toArray(h,s[t].color,o),o+=4}for(let t=0;t<3;++t)for(let e=0;e<3;++e){const n=c+4*t+e;_[a++]=n,_[a++]=n+1,_[a++]=n+4,_[a++]=n+1,_[a++]=n+5,_[a++]=n+4}},updateWorldVertexData(t){const e=t.node,n=t.renderData.data;e.getWorldMatrix(YH);for(let t=0;t<4;++t){const e=n[t];for(let i=0;i<4;++i){const s=n[i],o=n[4+4*t+i];$e.set(XH,s.x,e.y,0),$e.transformMat4(o,XH,YH)}}},updateColor(t){const e=t.renderData.data,n=t.color,i=n.r,s=n.g,o=n.b,r=255*t.node._uiProps.opacity;for(let t=4;t<20;t++)e[t].color.r=i,e[t].color.g=s,e[t].color.b=o,e[t].color.a=r}},$H=[];for(let t=0;t<4;t++)$H.push(new $e);const ZH={createData:t=>t.requestRenderData(),updateRenderData(t){const e=t.renderData,n=t.spriteFrame;if(!n||!e||!e.uvDirty&&!e.vertDirty)return;const i=t.node._uiProps.uiTransformComp,s=Math.abs(i.width),o=Math.abs(i.height),r=n.getRect(),a=n.insetLeft,c=n.insetRight,l=r.width-a-c,h=n.insetTop,_=n.insetBottom,u=r.height-h-_;let d=s-a-c,p=o-h-_;d=d>0?d:0,p=p>0?p:0;const f=0===l?d:d/l,m=0===u?p:p/u,g=Math.ceil(m+2),v=Math.ceil(f+2);e.dataLength=Math.max(8,g+1,v+1),this.updateVerts(t,d,p,g,v),e.vertexCount=g*v*4,e.indicesCount=g*v*6,e.uvDirty=!1,e.vertDirty=!1,this.updateColor(t)},fillBuffers(t,e){const n=t.node,i=t.node._uiProps.uiTransformComp,s=Math.abs(i.width),o=Math.abs(i.height),r=t.renderData;let a=e.acquireBufferBatch(),c=a.indicesOffset,l=a.byteOffset>>2,h=a.vertexOffset;const _=r.vertexCount,u=r.indicesCount,d=a.vData,p=a.iData;a.request(_,u)||(a=e.currBufferBatch,l=0,c=0,h=0);const f=t.spriteFrame,m=f.isRotated(),g=f.uv,v=t.spriteFrame.uvSliced,y=f.getRect(),x=f.insetLeft,S=f.insetRight,T=y.width-x-S,E=f.insetTop,A=f.insetBottom,C=y.height-E-A;let b=s-x-S,P=o-E-A;b=b>0?b:0,P=P>0?P:0;const w=0===T?b:b/T,D=0===C?P:P/C,I=Math.ceil(D+2),R=Math.ceil(w+2),O=n.worldMatrix,M=r.data;this.fillVertices(d,l,O,I,R,M);let N=0,L=0;const B=[],F=[];for(let t=0,e=I;t<e;++t){L=P>C?P>=t*C?1:D%1:D;for(let e=0,n=R;e<n;++e){N=b>T?b>=e*T?1:w%1:w;const n=l+3,i=n+1;m?(0===t?(B[0]=v[0].u,B[1]=v[0].u,B[2]=v[4].u+(v[8].u-v[4].u)*L):t<I-1?(B[0]=v[4].u,B[1]=v[4].u,B[2]=v[4].u+(v[8].u-v[4].u)*L):t===I-1&&(B[0]=v[8].u,B[1]=v[8].u,B[2]=v[12].u),0===e?(F[0]=v[0].v,F[1]=v[1].v+(v[2].v-v[1].v)*N,F[2]=v[0].v):e<R-1?(F[0]=v[1].v,F[1]=v[1].v+(v[2].v-v[1].v)*N,F[2]=v[1].v):e===R-1&&(F[0]=v[2].v,F[1]=v[3].v,F[2]=v[2].v),B[3]=B[2],F[3]=F[1]):(0===e?(B[0]=v[0].u,B[1]=v[1].u+(v[2].u-v[1].u)*N,B[2]=g[0]):e<R-1?(B[0]=v[1].u,B[1]=v[1].u+(v[2].u-v[1].u)*N,B[2]=v[1].u):e===R-1&&(B[0]=v[2].u,B[1]=v[3].u,B[2]=v[2].u),0===t?(F[0]=v[0].v,F[1]=v[0].v,F[2]=v[4].v+(v[8].v-v[4].v)*L):t<I-1?(F[0]=v[4].v,F[1]=v[4].v,F[2]=v[4].v+(v[8].v-v[4].v)*L):t===I-1&&(F[0]=v[8].v,F[1]=v[8].v,F[2]=v[12].v),B[3]=B[1],F[3]=F[2]),d[n]=B[0],d[i]=F[0],d[n+9]=B[1],d[i+9]=F[1],d[n+18]=B[2],d[i+18]=F[2],d[n+27]=B[3],d[i+27]=F[3],An.toArray(d,M[0].color,i+1),An.toArray(d,M[0].color,i+9+1),An.toArray(d,M[0].color,i+18+1),An.toArray(d,M[0].color,i+27+1),l+=36}}for(let t=0;t<u;t+=6)p[c++]=h,p[c++]=h+1,p[c++]=h+2,p[c++]=h+1,p[c++]=h+3,p[c++]=h+2,h+=4},fillVertices(t,e,n,i,s,o){let r=0,a=0,c=0,l=0;for(let h=0,_=i;h<_;++h){c=o[h].y,l=o[h+1].y;for(let i=0,h=s;i<h;++i){r=o[i].x,a=o[i+1].x,$e.set($H[0],r,c,0),$e.set($H[1],a,c,0),$e.set($H[2],r,l,0),$e.set($H[3],a,l,0);for(let i=0;i<4;i++){const s=$H[i];$e.transformMat4(s,s,n);const o=9*i;t[e+o]=s.x,t[e+o+1]=s.y,t[e+o+2]=s.z}e+=36}}},updateVerts(t,e,n,i,s){const o=t.node._uiProps.uiTransformComp,r=t.renderData.data,a=t.spriteFrame,c=a.getRect(),l=Math.abs(o.width),h=Math.abs(o.height),_=o.anchorX*l,u=o.anchorY*h,d=a.insetLeft,p=a.insetRight,f=c.width-d-p,m=a.insetTop,g=a.insetBottom,v=c.height-m-g,y=o.width/(d+p)>1?1:o.width/(d+p),x=o.height/(m+g)>1?1:o.height/(m+g);let S=0,T=0;S=f>0?Math.floor(1e3*e)/1e3%f==0?f:e%f:e,T=v>0?Math.floor(1e3*n)/1e3%v==0?v:n%v:n;for(let t=0;t<=s;t++)0===t?r[t].x=-_:t>0&&t<s?r[t].x=1===t?d*y+Math.min(f,e)-_:f>0?t===s-1?d+S+f*(t-2)-_:d+Math.min(f,e)+f*(t-2)-_:d+e-_:t===s&&(r[t].x=Math.min(d+e+p,l)-_);for(let t=0;t<=i;t++)0===t?r[t].y=-u:t>0&&t<i?r[t].y=1===t?g*x+Math.min(v,n)-u:v>0?t===i-1?g+T+(t-2)*v-u:g+Math.min(v,n)+(t-2)*v-u:g+n-u:t===i&&(r[t].y=Math.min(g+n+m,h)-u)},updateColor(t){const e=t.renderData.data,n=e.length;if(0===n)return;const i=t.color,s=i.r,o=i.g,r=i.b,a=255*t.node._uiProps.opacity;for(let t=0;t<n;t++)e[t].color.r=s,e[t].color.g=o,e[t].color.b=r,e[t].color.a=a}},JH=UB.Type,QH=UB.FillType,tG=t("spriteAssembler",{getAssembler(t){let e=qH;const n=t;switch(n.type){case JH.SLICED:e=KH;break;case JH.TILED:e=ZH;break;case JH.FILLED:e=n.fillType===QH.RADIAL?WH:DH}return e}});UB.Assembler=tG;const eG=OO.sharedManager,nG={createData(t){const e=t.requestRenderData();return e.dataLength=4,e.vertexCount=4,e.indicesCount=6,e.vData=new Float32Array(36),e},updateRenderData(t){t.type===ML.IMAGE_STENCIL&&(qH.updateRenderData(t),qH.updateColor(t))},fillBuffers(t,e){(t.type!==ML.IMAGE_STENCIL||t.spriteFrame)&&(eG.pushMask(t),e.finishMergeBatches(),function(t,e){eG.clear(t),e.commitModel(t,t._clearModel,t._clearStencilMtl)}(t,e),function(t,e){if(eG.enterLevel(t),t.type===ML.IMAGE_STENCIL){qH.fillBuffers(t,e);const n=t.graphics.getMaterialInstance(0);e.forceMergeBatches(n,t.spriteFrame,t.graphics)}else t.graphics.updateAssembler(e)}(t,e),eG.enableMask())}},iG={fillBuffers(t,e){eG.exitMask()}},sG={getAssembler:()=>nG},oG={getAssembler:()=>iG};NL.Assembler=sG,NL.PostAssembler=oG;const rG=new ea(null),aG=new pn;class cG{get handle(){return this._handle}constructor(){this._handle=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;const t=i.director.root.device;this._localData=new Float32Array(Ql.COUNT),this._localBuffer=t.createBuffer(new br(Lo.UNIFORM|Lo.TRANSFER_DST,zo.HOST|zo.DEVICE,Ql.SIZE,Ql.SIZE))}initialize(t){const e=i.director.root.device;this._transform=t.useLocalData,this._textureHash=t.textureHash,this._samplerHash=t.samplerHash,rG.layout=t.passes[0].localSetLayout,this._handle&&(Pi.free(this._handle),this._handle=null),this._handle=Pi.alloc(e,rG),this._descriptorSet=Pi.get(this._handle),this._descriptorSet.bindBuffer(Ql.BINDING,this._localBuffer);const n=Sl.SAMPLER_SPRITE;this._descriptorSet.bindTexture(n,t.texture),this._descriptorSet.bindSampler(n,t.sampler),this._descriptorSet.update(),this._transformUpdate=!0}updateTransform(t){t!==this._transform&&(this._transform=t,this._transformUpdate=!0,this.uploadLocalData())}updateLocal(){this._transform&&this.uploadLocalData()}equals(t,e,n){return this._transform===t&&this._textureHash===e&&this._samplerHash===n}reset(){this._transform=null,this._textureHash=0,this._samplerHash=0}destroy(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._handle&&(Pi.free(this._handle),this._handle=null),this._localData=null}uploadLocalData(){const t=this._transform;if((t.hasChangedFlags||t._dirtyFlags)&&t.updateWorldTransform(),this._transformUpdate){const e=t._mat;pn.toArray(this._localData,e,Ql.MAT_WORLD_OFFSET),pn.inverseTranspose(aG,e),pn.toArray(this._localData,aG,Ql.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}}}class lG{constructor(){this._descriptorSetCache=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new Pn((()=>new cG),16)}getDescriptorSet(t){const e=i.director.root;if(t.useLocalData){const e=this._localDescriptorSetCache;for(let n=0,i=e.length;n<i;n++){const i=e[n];if(i.equals(t.useLocalData,t.textureHash,t.samplerHash))return i.handle}const n=this._localCachePool.alloc();return n.initialize(t),this._localDescriptorSetCache.push(n),n.handle}{const n=this._descriptorSetCache.get(t.textureHash);if(n&&n.has(t.samplerHash))return n.get(t.samplerHash);{rG.layout=t.passes[0].localSetLayout;const i=Pi.alloc(e.device,rG),s=Pi.get(i),o=Sl.SAMPLER_SPRITE;return s.bindTexture(o,t.texture),s.bindSampler(o,t.sampler),s.update(),n?this._descriptorSetCache.get(t.textureHash).set(t.samplerHash,i):this._descriptorSetCache.set(t.textureHash,new Map([[t.samplerHash,i]])),i}}}update(){this._localDescriptorSetCache.forEach((t=>{t.updateLocal()}))}reset(){this._localDescriptorSetCache.forEach((t=>{this._localCachePool.free(t)})),this._localDescriptorSetCache.length=0}releaseDescriptorSetCache(t){this._descriptorSetCache.has(t)&&(this._descriptorSetCache.get(t).forEach((t=>{Pi.free(t)})),this._descriptorSetCache.delete(t))}destroy(){this._descriptorSetCache.forEach((t=>{t.forEach((t=>{Pi.free(t)}))})),this._descriptorSetCache.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy((t=>{t.destroy()}))}}i.internal.Batcher2D=class{get currBufferBatch(){return this._currMeshBuffer||(this._currMeshBuffer=this.acquireBufferBatch()),this._currMeshBuffer}set currBufferBatch(t){t&&(this._currMeshBuffer=t)}get batches(){return this._batches}acquireBufferBatch(t=wN){const e=t===wN?36:RN(t);return this._currMeshBuffer&&this._currMeshBuffer.vertexFormatBytes===e||this._requireBufferBatch(t),this._currMeshBuffer}registerCustomBuffer(t,e){let n;t instanceof YF?n=t:(n=this._bufferBatchPool.add(),n.initialize(t,e||this._recreateMeshBuffer.bind(this,t)));const i=n.vertexFormatBytes;let s=this._customMeshBuffers.get(i);return s||(s=[],this._customMeshBuffers.set(i,s)),s.push(n),n}unRegisterCustomBuffer(t){const e=this._customMeshBuffers.get(t.vertexFormatBytes);if(e)for(let n=0;n<e.length;n++)if(e[n]===t){e.splice(n,1);break}}set currStaticRoot(t){this._currStaticRoot=t}set currIsStatic(t){this._currIsStatic=t}constructor(t){this.device=void 0,this._screens=[],this._bufferBatchPool=new wn((()=>new YF(this)),128),this._drawBatchPool=void 0,this._meshBuffers=new Map,this._customMeshBuffers=new Map,this._meshBufferUseCount=new Map,this._batches=void 0,this._doUploadBuffersCall=new Map,this._emptyMaterial=new kf,this._currScene=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currMeshBuffer=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currBlendTargetHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._descriptorSetCache=new lG,this._root=t,this.device=t.device,this._batches=new Dn(64),this._drawBatchPool=new Pn((()=>new $F),128)}initialize(){return!0}destroy(){for(let t=0;t<this._batches.length;t++)this._batches.array[t]&&this._batches.array[t].destroy(this);this._batches.destroy();for(const t of this._meshBuffers.keys()){const e=this._meshBuffers.get(t);e&&e.forEach((t=>t.destroy()))}this._drawBatchPool&&this._drawBatchPool.destroy((t=>{t.destroy(this)})),this._descriptorSetCache.destroy(),this._meshBuffers.clear(),OO.sharedManager.destroy()}addScreen(t){this._screens.push(t),this._screens.sort(this._screenSort)}getFirstRenderCamera(t){if(t.scene&&t.scene.renderScene){const e=t.scene.renderScene.cameras;for(let n=0;n<e.length;n++){const i=e[n];if(i.visibility&t.layer)return i}}return null}removeScreen(t){const e=this._screens.indexOf(t);-1!==e&&this._screens.splice(e,1)}sortScreens(){this._screens.sort(this._screenSort)}addUploadBuffersFunc(t,e){this._doUploadBuffersCall.set(t,e)}removeUploadBuffersFunc(t){this._doUploadBuffersCall.delete(t)}update(){const t=this._screens;for(let e=0;e<t.length;++e){const n=t[e];n.enabledInHierarchy&&this._recursiveScreenNode(n.node)}let e=0;if(this._batches.length)for(let t=0;t<this._batches.length;++t){const n=this._batches.array[t];if(n.renderScene){if(n.model){const t=n.model.subModels;for(let n=0;n<t.length;n++)t[n].priority=e++}else n.hDescriptorSet=this._descriptorSetCache.getDescriptorSet(n);n.renderScene.addBatch(n)}}}uploadBuffers(){this._batches.length>0&&(this._doUploadBuffersCall.forEach(((t,e)=>{t.call(e,this)})),this._meshBuffers.forEach((t=>{t.forEach((t=>{t.uploadBuffers(),t.reset()}))})),this._customMeshBuffers.forEach((t=>{t.forEach((t=>{t.uploadBuffers(),t.reset()}))})),this._descriptorSetCache.update())}reset(){for(let t=0;t<this._batches.length;++t){const e=this._batches.array[t];e.isStatic||(e.clear(),this._drawBatchPool.free(e))}this._currLayer=0,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._currScene=null,this._currMeshBuffer=null,this._meshBufferUseCount.clear(),this._batches.clear(),OO.sharedManager.reset(),this._descriptorSetCache.reset()}commitComp(t,e,n,i){const s=t;let o,r,a=0,c=0;e?(o=e.getGFXTexture(),r=e.getGFXSampler(),a=e.getHash(),c=e.getSamplerHash()):(o=null,r=null);const l=s._getRenderScene(),h=s.getRenderMaterial(0);s.stencilStage=OO.sharedManager.stage;const _=s.blendHash,u=s.stencilStage;this._currScene===l&&this._currLayer===t.node.layer&&this._currMaterial===h&&this._currBlendTargetHash===_&&this._currDepthStencilStateStage===u&&this._currTextureHash===a&&this._currSamplerHash===c&&this._currTransform===i||(this.autoMergeBatches(this._currComponent),this._currScene=l,this._currComponent=s,this._currTransform=i,this._currMaterial=h,this._currTexture=o,this._currSampler=r,this._currTextureHash=a,this._currSamplerHash=c,this._currBlendTargetHash=_,this._currDepthStencilStateStage=u,this._currLayer=t.node.layer),n&&n.fillBuffers(s,this)}commitModel(t,e,n){let s;this._currMaterial!==this._emptyMaterial&&this.autoMergeBatches(this._currComponent);let o=0;n&&(t.stencilStage!==IO.ENABLED&&t.stencilStage!==IO.DISABLED||(t.stencilStage=OO.sharedManager.stage),s=OO.sharedManager.getStencilStage(t.stencilStage,n),o=OO.sharedManager.getStencilHash(t.stencilStage));const r=i.director.getTotalFrames();e&&(e.updateTransform(r),e.updateUBOs(r));for(let i=0;i<e.subModels.length;i++){const r=this._drawBatchPool.alloc(),a=e.subModels[i];r.renderScene=t._getRenderScene(),r.visFlags=t.node.layer,r.model=e,r.bufferBatch=null,r.texture=null,r.sampler=null,r.useLocalData=null,s||(s=null),r.fillPasses(n,s,o,null,0,a.patches),r.hDescriptorSet=ki.get(a.handle,ji.DESCRIPTOR_SET),r.hInputAssembler=ki.get(a.handle,ji.INPUT_ASSEMBLER),r.model.visFlags=r.visFlags,this._batches.push(r)}this._currMaterial=this._emptyMaterial,this._currScene=null,this._currComponent=null,this._currTransform=null,this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0}commitStaticBatch(t){this._batches.concat(t.drawBatchList),this.finishMergeBatches()}autoMergeBatches(t){const e=this.currBufferBatch,n=null==e?void 0:e.recordBatch(),i=this._currMaterial;if(!n||!i||!e)return;let s,o,r=0,a=0;t&&(s=-1===t.blendHash?null:t.getBlendState(),a=t.blendHash,o=null!==t.customMaterial?OO.sharedManager.getStencilStage(t.stencilStage,i):OO.sharedManager.getStencilStage(t.stencilStage),r=OO.sharedManager.getStencilHash(t.stencilStage));const c=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();c.renderScene=this._currScene,c.visFlags=this._currLayer,c.bufferBatch=e,c.texture=this._currTexture,c.sampler=this._currSampler,c.hInputAssembler=n,c.useLocalData=this._currTransform,c.textureHash=this._currTextureHash,c.samplerHash=this._currSamplerHash,c.fillPasses(i,o,r,s,a,null),this._batches.push(c),e.vertexStart=e.vertexOffset,e.indicesStart=e.indicesOffset,e.byteStart=e.byteOffset,Rp.__isWebIOS14OrIPadOS14Env&&!this._currIsStatic&&(this._currMeshBuffer=null)}forceMergeBatches(t,e,n){this._currMaterial=t,e?(this._currTexture=e.getGFXTexture(),this._currSampler=e.getGFXSampler(),this._currTextureHash=e.getHash(),this._currSamplerHash=e.getSamplerHash()):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=n.node.layer,this._currScene=n._getRenderScene(),this.autoMergeBatches(n)}finishMergeBatches(){this.autoMergeBatches(),this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0}flushMaterial(t){this._currMaterial=t}walk(t,e=0){const n=t.children.length;if(this._preProcess(t),n>0&&!t._static){const n=t.children;for(let t=0;t<n.length;++t){const i=n[t];this.walk(i,e)}}this._postProcess(t),e+=1}_preProcess(t){const e=t._uiProps.uiComp;if(!e){const e=t._uiProps.localOpacity;t._uiProps.opacity=t.parent&&t.parent._uiProps?t.parent._uiProps.opacity*e:e}t._uiProps.uiTransformComp&&e&&e.enabledInHierarchy&&e.updateAssembler(this)}_postProcess(t){const e=t._uiProps.uiComp;e&&e.enabledInHierarchy&&e.postUpdateAssembler(this)}_recursiveScreenNode(t){this.walk(t),this.autoMergeBatches(this._currComponent)}_createMeshBuffer(t){const e=this._bufferBatchPool.add();e.initialize(t,this._recreateMeshBuffer.bind(this,t));const n=RN(t);let i=this._meshBuffers.get(n);return i||(i=[],this._meshBuffers.set(n,i)),i.push(e),e}_recreateMeshBuffer(t,e,n){this.autoMergeBatches(),this._requireBufferBatch(t,e,n)}_requireBufferBatch(t,e,n){const i=RN(t);let s=this._meshBuffers.get(i);s||(s=[],this._meshBuffers.set(i,s));const o=this._meshBufferUseCount.get(i)||0;o>=s.length?this._currMeshBuffer=this._createMeshBuffer(t):this._currMeshBuffer=s[o],this._meshBufferUseCount.set(i,o+1),e&&n&&this._currMeshBuffer.request(e,n)}_screenSort(t,e){return t.node.getSiblingIndex()-e.node.getSiblingIndex()}_releaseDescriptorSetCache(t){this._descriptorSetCache.releaseDescriptorSetCache(t)}};let hG=null,_G=-1;const uG="BES bswy:->@123",dG=Object.create(null),pG=[],fG=3e3,mG=(()=>{let t;return()=>{if(void 0===t)if("FontFace"in window){const e=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),n=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);t=e?parseInt(e[1],10)>42:!n}else t=!1;return t}})();function gG(){let t=!0;const e=Date.now();for(let n=pG.length-1;n>=0;n--){const i=pG[n],s=i.fontFamilyName;if(e-i.startTime>fG){E(4933,s),i.onComplete(null,s),pG.splice(n,1);continue}const o=i.refWidth,r=`40px ${s}`;hG.font=r,o!==kR(hG,uG,r)?(pG.splice(n,1),i.onComplete(null,s)):t=!1}t&&(clearInterval(_G),_G=-1)}function vG(t,e,n){const i=function(t){const e=t.lastIndexOf(".ttf");if(-1===e)return t;const n=t.lastIndexOf("/");let i;return i=-1===n?`${t.substring(0,e)}_LABEL`:`${t.substring(n+1,e)}_LABEL`,-1!==i.indexOf(" ")&&(i=`"${i}"`),i}(t);if(dG[i])return void n(null,i);if(!hG){const t=document.createElement("canvas");t.width=100,t.height=100,hG=t.getContext("2d")}const s=kR(hG,uG,`40px ${i}`),o=document.createElement("style");o.type="text/css";let r="";Number.isNaN(i)?r+=`@font-face { font-family:${i}; src:`:r+=`@font-face { font-family:"${i}"; src:`,r+=`url("${t}");`,o.textContent=`${r}}`,document.body.appendChild(o);const a=document.createElement("div"),c=a.style;if(c.fontFamily=i,a.innerHTML=".",c.position="absolute",c.left="-100px",c.top="-100px",document.body.appendChild(a),mG())!function(t,e,n){const i=new Promise(((n,i)=>{const s=()=>{Date.now()-t>=fG?i():document.fonts.load(`40px ${e}`).then((t=>{t.length>=1?n():setTimeout(s,100)}),(()=>{i()}))};s()}));let s=null;const o=new Promise(((t,e)=>{s=setTimeout(e,fG)}));Promise.race([o,i]).then((()=>{s&&(clearTimeout(s),s=null),n(null,e)}),(()=>{E(4933,e),n(null,e)}))}(Date.now(),i,n);else{const t={fontFamilyName:i,refWidth:s,onComplete:n,startTime:Date.now()};pG.push(t),-1===_G&&(_G=setInterval(gG,100))}dG[i]=o}function yG(t,e,n,i){const s=new xR;s._nativeUrl=t,s._nativeAsset=e,i(null,s)}var xG,SG,TG,EG,AG,CG,bG,PG,wG,DG,IG,RG,OG,MG,NG,LG,BG,FG,zG,UG,HG,GG,VG,jG,WG,kG,qG,XG,YG,KG,$G,ZG,JG,QG,tV,eV,nV,iV,sV,oV,rV,aV,cV,lV,hV,_V,uV,dV,pV,fV;EC.register({".font":vG,".eot":vG,".ttf":vG,".woff":vG,".svg":vG,".ttc":vG}),IC.register({".font":yG,".eot":yG,".ttf":yG,".woff":yG,".svg":yG,".ttc":yG}),i.UI={MeshBuffer:YF,spriteAssembler:tG,graphicsAssembler:iU,labelAssembler:CH};const mV=new An;var gV,vV;let yV;!function(t){t[t.NONE=0]="NONE",t[t.COLOR=1]="COLOR",t[t.SPRITE=2]="SPRITE",t[t.SCALE=3]="SCALE"}(gV||(gV={})),Mt(gV),function(t){t.NORMAL="normal",t.HOVER="hover",t.PRESSED="pressed",t.DISABLED="disabled"}(vV||(vV={})),function(t){t.CLICK="click"}(yV||(yV={}));let xV,SV,TV,EV=t("Button",(xG=i_("cc.Button"),SG=f_(),TG=o_(110),EG=__(),AG=s_(RO),CG=O_(ey),bG=C_(),PG=y_(),wG=C_(),DG=y_(),IG=O_(gV),RG=C_(),OG=y_(),MG=y_(),NG=y_(),LG=y_(),BG=y_(),FG=S_(),zG=T_(),UG=y_(),HG=y_(),GG=O_(hR),VG=y_(),jG=O_(hR),WG=y_(),kG=O_(hR),qG=y_(),XG=O_(hR),YG=y_(),KG=O_([ob]),$G=C_(),ZG=y_(),xG(JG=SG(JG=TG(JG=EG(JG=AG(JG=h_((fV=pV=class extends Ad{constructor(...t){super(...t),Xh(this,"clickEvents",tV,this),Xh(this,"_interactable",eV,this),Xh(this,"_transition",nV,this),Xh(this,"_normalColor",iV,this),Xh(this,"_hoverColor",sV,this),Xh(this,"_pressedColor",oV,this),Xh(this,"_disabledColor",rV,this),Xh(this,"_normalSprite",aV,this),Xh(this,"_hoverSprite",cV,this),Xh(this,"_pressedSprite",lV,this),Xh(this,"_disabledSprite",hV,this),Xh(this,"_duration",_V,this),Xh(this,"_zoomScale",uV,this),Xh(this,"_target",dV,this),this._pressed=!1,this._hovered=!1,this._fromColor=new An,this._toColor=new An,this._time=0,this._transitionFinished=!0,this._fromScale=new $e,this._toScale=new $e,this._originalScale=null,this._sprite=null,this._targetScale=new $e}get target(){return this._target||this.node}set target(t){this._target!==t&&(this._target&&this._unregisterTargetEvent(this._target),this._target=t,this._applyTarget())}get interactable(){return this._interactable}set interactable(t){this._interactable=t,this._updateState(),this._interactable||this._resetState()}set _resizeToTarget(t){t&&this._resizeNodeToTargetNode()}get transition(){return this._transition}set transition(t){this._transition!==t&&(this._transition===gV.COLOR?this._updateColorTransition(vV.NORMAL):this._transition===gV.SPRITE&&this._updateSpriteTransition(vV.NORMAL),this._transition=t,this._updateState())}get normalColor(){return this._normalColor}set normalColor(t){this._normalColor!==t&&(this._normalColor.set(t),this._updateState())}get pressedColor(){return this._pressedColor}set pressedColor(t){this._pressedColor!==t&&this._pressedColor.set(t)}get hoverColor(){return this._hoverColor}set hoverColor(t){this._hoverColor!==t&&this._hoverColor.set(t)}get disabledColor(){return this._disabledColor}set disabledColor(t){this._disabledColor!==t&&(this._disabledColor.set(t),this._updateState())}get duration(){return this._duration}set duration(t){this._duration!==t&&(this._duration=t)}get zoomScale(){return this._zoomScale}set zoomScale(t){this._zoomScale!==t&&(this._zoomScale=t)}get normalSprite(){return this._normalSprite}set normalSprite(t){if(this._normalSprite===t)return;this._normalSprite=t;const e=this.node.getComponent(UB);e&&(e.spriteFrame=t),this._updateState()}get pressedSprite(){return this._pressedSprite}set pressedSprite(t){this._pressedSprite!==t&&(this._pressedSprite=t,this._updateState())}get hoverSprite(){return this._hoverSprite}set hoverSprite(t){this._hoverSprite!==t&&(this._hoverSprite=t,this._updateState())}get disabledSprite(){return this._disabledSprite}set disabledSprite(t){this._disabledSprite!==t&&(this._disabledSprite=t,this._updateState())}__preload(){this.target||(this.target=this.node);const t=this.node.getComponent(UB);t&&(this._normalSprite=t.spriteFrame),this._applyTarget(),this._resetState()}onEnable(){this._registerNodeEvent()}onDisable(){this._resetState(),this._unregisterNodeEvent()}update(t){const e=this.target;if(this._transitionFinished||!e)return;if(this._transition!==gV.COLOR&&this._transition!==gV.SCALE)return;this._time+=t;let n=1;if(this._duration>0&&(n=this._time/this._duration),n>=1&&(n=1),this._transition===gV.COLOR){const t=e._uiProps.uiComp;An.lerp(mV,this._fromColor,this._toColor,n),t&&(t.color=mV)}else this.transition===gV.SCALE&&(e.getScale(this._targetScale),this._targetScale.x=Re(this._fromScale.x,this._toScale.x,n),this._targetScale.y=Re(this._fromScale.y,this._toScale.y,n),e.setScale(this._targetScale));1===n&&(this._transitionFinished=!0)}_resizeNodeToTargetNode(){this.target&&this.target._uiProps.uiTransformComp}_resetState(){this._pressed=!1,this._hovered=!1;const t=this.target;if(!t)return;const e=t.getComponent(JO);if(!e)return;const n=this._transition;n===gV.COLOR&&this._interactable?e.color=this._normalColor:n===gV.SCALE&&this._originalScale&&t.setScale(this._originalScale),this._transitionFinished=!0}_registerNodeEvent(){this.node.on(Mp.TOUCH_START,this._onTouchBegan,this),this.node.on(Mp.TOUCH_MOVE,this._onTouchMove,this),this.node.on(Mp.TOUCH_END,this._onTouchEnded,this),this.node.on(Mp.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(Mp.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(Mp.MOUSE_LEAVE,this._onMouseMoveOut,this)}_registerTargetEvent(t){t.on(Mp.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)}_unregisterNodeEvent(){this.node.off(Mp.TOUCH_START,this._onTouchBegan,this),this.node.off(Mp.TOUCH_MOVE,this._onTouchMove,this),this.node.off(Mp.TOUCH_END,this._onTouchEnded,this),this.node.off(Mp.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(Mp.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(Mp.MOUSE_LEAVE,this._onMouseMoveOut,this)}_unregisterTargetEvent(t){t.off(Mp.TRANSFORM_CHANGED)}_getTargetSprite(t){let e=null;return t&&(e=t.getComponent(UB)),e}_applyTarget(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new $e),$e.copy(this._originalScale,this.target.getScale()))}_onTargetSpriteFrameChanged(t){this._transition===gV.SPRITE&&this._setCurrentStateSpriteFrame(t.spriteFrame)}_setCurrentStateSpriteFrame(t){if(t)switch(this._getButtonState()){case vV.NORMAL:this._normalSprite=t;break;case vV.HOVER:this._hoverSprite=t;break;case vV.PRESSED:this._pressedSprite=t;break;case vV.DISABLED:this._disabledSprite=t}}_onTargetColorChanged(t){this._transition===gV.COLOR&&this._setCurrentStateColor(t)}_setCurrentStateColor(t){switch(this._getButtonState()){case vV.NORMAL:this._normalColor=t;break;case vV.HOVER:this._hoverColor=t;break;case vV.PRESSED:this._pressedColor=t;break;case vV.DISABLED:this._disabledColor=t}}_onTargetTransformChanged(t){t|Hh.SCALE&&this._originalScale&&this._transition===gV.SCALE&&this._transitionFinished&&$e.copy(this._originalScale,this.target.getScale())}_onTouchBegan(t){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),t&&(t.propagationStopped=!0))}_onTouchMove(t){if(!this._interactable||!this.enabledInHierarchy||!this._pressed)return;if(!t)return;const e=t.touch;if(!e)return;const n=this.node._uiProps.uiTransformComp.isHit(e.getUILocation());if(this._transition===gV.SCALE&&this.target&&this._originalScale)n?($e.copy(this._fromScale,this._originalScale),$e.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale));else{let t;t=n?vV.PRESSED:vV.NORMAL,this._applyTransition(t)}t&&(t.propagationStopped=!0)}_onTouchEnded(t){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(ob.emitEvents(this.clickEvents,t),this.node.emit(yV.CLICK,this)),this._pressed=!1,this._updateState(),t&&(t.propagationStopped=!0))}_onTouchCancel(t){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())}_onMouseMoveIn(t){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==gV.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))}_onMouseMoveOut(t){this._hovered&&(this._hovered=!1,this._updateState())}_updateState(){const t=this._getButtonState();this._applyTransition(t)}_getButtonState(){let t=vV.NORMAL;return this._interactable?this._pressed?t=vV.PRESSED:this._hovered&&(t=vV.HOVER):t=vV.DISABLED,t.toString()}_updateColorTransition(t){var e;const n=this[`${t}Color`],i=null===(e=this.target)||void 0===e?void 0:e.getComponent(JO);i&&(t===vV.DISABLED?i.color=n:(this._fromColor=i.color.clone(),this._toColor=n,this._time=0,this._transitionFinished=!1))}_updateSpriteTransition(t){const e=this[`${t}Sprite`];this._sprite&&e&&(this._sprite.spriteFrame=e)}_updateScaleTransition(t){this._interactable&&(t===vV.PRESSED?this._zoomUp():this._zoomBack())}_zoomUp(){this._originalScale&&($e.copy(this._fromScale,this._originalScale),$e.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)}_zoomBack(){this.target&&this._originalScale&&($e.copy(this._fromScale,this.target.getScale()),$e.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)}_applyTransition(t){const e=this._transition;e===gV.COLOR?this._updateColorTransition(t):e===gV.SPRITE?this._updateSpriteTransition(t):e===gV.SCALE&&this._updateScaleTransition(t)}},pV.Transition=gV,pV.EventType=yV,Yh((QG=fV).prototype,"target",[CG,bG,PG],Object.getOwnPropertyDescriptor(QG.prototype,"target"),QG.prototype),Yh(QG.prototype,"interactable",[wG,DG],Object.getOwnPropertyDescriptor(QG.prototype,"interactable"),QG.prototype),Yh(QG.prototype,"transition",[IG,RG,OG],Object.getOwnPropertyDescriptor(QG.prototype,"transition"),QG.prototype),Yh(QG.prototype,"normalColor",[MG],Object.getOwnPropertyDescriptor(QG.prototype,"normalColor"),QG.prototype),Yh(QG.prototype,"pressedColor",[NG],Object.getOwnPropertyDescriptor(QG.prototype,"pressedColor"),QG.prototype),Yh(QG.prototype,"hoverColor",[LG],Object.getOwnPropertyDescriptor(QG.prototype,"hoverColor"),QG.prototype),Yh(QG.prototype,"disabledColor",[BG],Object.getOwnPropertyDescriptor(QG.prototype,"disabledColor"),QG.prototype),Yh(QG.prototype,"duration",[FG,zG,UG],Object.getOwnPropertyDescriptor(QG.prototype,"duration"),QG.prototype),Yh(QG.prototype,"zoomScale",[HG],Object.getOwnPropertyDescriptor(QG.prototype,"zoomScale"),QG.prototype),Yh(QG.prototype,"normalSprite",[GG,VG],Object.getOwnPropertyDescriptor(QG.prototype,"normalSprite"),QG.prototype),Yh(QG.prototype,"pressedSprite",[jG,WG],Object.getOwnPropertyDescriptor(QG.prototype,"pressedSprite"),QG.prototype),Yh(QG.prototype,"hoverSprite",[kG,qG],Object.getOwnPropertyDescriptor(QG.prototype,"hoverSprite"),QG.prototype),Yh(QG.prototype,"disabledSprite",[XG,YG],Object.getOwnPropertyDescriptor(QG.prototype,"disabledSprite"),QG.prototype),tV=Yh(QG.prototype,"clickEvents",[KG,c_,$G,ZG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),eV=Yh(QG.prototype,"_interactable",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),nV=Yh(QG.prototype,"_transition",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gV.NONE}}),iV=Yh(QG.prototype,"_normalColor",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return An.WHITE.clone()}}),sV=Yh(QG.prototype,"_hoverColor",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new An(211,211,211,255)}}),oV=Yh(QG.prototype,"_pressedColor",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return An.WHITE.clone()}}),rV=Yh(QG.prototype,"_disabledColor",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new An(124,124,124,255)}}),aV=Yh(QG.prototype,"_normalSprite",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cV=Yh(QG.prototype,"_hoverSprite",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lV=Yh(QG.prototype,"_pressedSprite",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hV=Yh(QG.prototype,"_disabledSprite",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_V=Yh(QG.prototype,"_duration",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),uV=Yh(QG.prototype,"_zoomScale",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),dV=Yh(QG.prototype,"_target",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JG=QG))||JG)||JG)||JG)||JG)||JG)||JG));(function(t){t[t.DEFAULT=0]="DEFAULT",t[t.DONE=1]="DONE",t[t.SEND=2]="SEND",t[t.SEARCH=3]="SEARCH",t[t.GO=4]="GO",t[t.NEXT=5]="NEXT"})(xV||(xV={})),It(xV),function(t){t[t.ANY=0]="ANY",t[t.EMAIL_ADDR=1]="EMAIL_ADDR",t[t.NUMERIC=2]="NUMERIC",t[t.PHONE_NUMBER=3]="PHONE_NUMBER",t[t.URL=4]="URL",t[t.DECIMAL=5]="DECIMAL",t[t.SINGLE_LINE=6]="SINGLE_LINE"}(SV||(SV={})),It(SV),function(t){t[t.PASSWORD=0]="PASSWORD",t[t.SENSITIVE=1]="SENSITIVE",t[t.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",t[t.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",t[t.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",t[t.DEFAULT=5]="DEFAULT"}(TV||(TV={})),It(TV);var AV,CV,bV,PV,wV,DV,IV,RV,OV,MV,NV,LV,BV,FV,zV,UV,HV,GV,VV,jV,WV,kV,qV,XV,YV,KV,$V,ZV,JV,QV,tj,ej,nj,ij,sj,oj,rj,aj,cj,lj,hj,_j,uj,dj,pj,fj,mj,gj,vj,yj,xj,Sj,Tj,Ej,Aj,Cj,bj,Pj,wj,Dj,Ij,Rj,Oj,Mj,Nj,Lj,Bj,Fj,zj,Uj,Hj,Gj,Vj,jj,Wj,kj,qj,Xj,Yj,Kj,$j,Zj,Jj,Qj,tW,eW,nW,iW,sW,oW,rW,aW,cW,lW,hW,_W,uW,dW,pW,fW,mW,gW,vW,yW,xW,SW,TW,EW,AW,CW,bW,PW,wW,DW,IW;new pn,new pn,new $e,function(t){t.EDITING_DID_BEGAN="editing-did-began",t.EDITING_DID_ENDED="editing-did-ended",t.TEXT_CHANGED="text-changed",t.EDITING_RETURN="editing-return"}(Ij||(Ij={})),t("EditBox",(AV=i_("cc.EditBox"),CV=f_(),bV=o_(110),PV=__(),wV=s_(RO),DV=C_(),IV=y_(),RV=C_(),OV=y_(),MV=O_(uN),NV=C_(),LV=y_(),BV=O_(uN),FV=C_(),zV=y_(),UV=O_(hR),HV=C_(),GV=y_(),VV=O_(TV),jV=C_(),WV=y_(),kV=O_(SV),qV=C_(),XV=y_(),YV=O_(xV),KV=C_(),$V=y_(),ZV=C_(),JV=y_(),QV=C_(),tj=y_(),ej=O_([ob]),nj=C_(),ij=y_(),sj=O_([ob]),oj=C_(),rj=y_(),aj=O_([ob]),cj=C_(),lj=y_(),hj=O_([ob]),_j=C_(),uj=y_(),AV(dj=CV(dj=bV(dj=PV(dj=wV(dj=h_((Dj=wj=class t extends Ad{constructor(...t){super(...t),Xh(this,"editingDidBegan",fj,this),Xh(this,"textChanged",mj,this),Xh(this,"editingDidEnded",gj,this),Xh(this,"editingReturn",vj,this),this._impl=null,this._background=null,Xh(this,"_textLabel",yj,this),Xh(this,"_placeholderLabel",xj,this),Xh(this,"_returnType",Sj,this),Xh(this,"_string",Tj,this),Xh(this,"_tabIndex",Ej,this),Xh(this,"_backgroundImage",Aj,this),Xh(this,"_inputFlag",Cj,this),Xh(this,"_inputMode",bj,this),Xh(this,"_maxLength",Pj,this),this._isLabelVisible=!1}get string(){return this._string}set string(t){this._maxLength>=0&&t.length>=this._maxLength&&(t=t.slice(0,this._maxLength)),this._string=t,this._updateString(t)}get placeholder(){return this._placeholderLabel?this._placeholderLabel.string:""}set placeholder(t){this._placeholderLabel&&(this._placeholderLabel.string=t)}get textLabel(){return this._textLabel}set textLabel(t){this._textLabel!==t&&(this._textLabel=t,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}get placeholderLabel(){return this._placeholderLabel}set placeholderLabel(t){this._placeholderLabel!==t&&(this._placeholderLabel=t,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}get backgroundImage(){return this._backgroundImage}set backgroundImage(t){this._backgroundImage!==t&&(this._backgroundImage=t,this._createBackgroundSprite())}get inputFlag(){return this._inputFlag}set inputFlag(t){this._inputFlag=t,this._updateString(this._string)}get inputMode(){return this._inputMode}set inputMode(t){this._inputMode!==t&&(this._inputMode=t,this._updateTextLabel(),this._updatePlaceholderLabel())}get returnType(){return this._returnType}set returnType(t){this._returnType=t}get maxLength(){return this._maxLength}set maxLength(t){this._maxLength=t}get tabIndex(){return this._tabIndex}set tabIndex(t){this._tabIndex!==t&&(this._tabIndex=t,this._impl&&this._impl.setTabIndex(t))}__preload(){this._init()}onEnable(){this._registerEvent(),this._impl&&this._impl.onEnable()}update(){this._impl&&this._impl.update()}onDisable(){this._unregisterEvent(),this._impl&&this._impl.onDisable()}onDestroy(){this._impl&&this._impl.clear()}setFocus(){this._impl&&this._impl.setFocus(!0)}focus(){this._impl&&this._impl.setFocus(!0)}blur(){this._impl&&this._impl.setFocus(!1)}isFocused(){return!!this._impl&&this._impl.isFocused()}_editBoxEditingDidBegan(){ob.emitEvents(this.editingDidBegan,this),this.node.emit(Ij.EDITING_DID_BEGAN,this)}_editBoxEditingDidEnded(){ob.emitEvents(this.editingDidEnded,this),this.node.emit(Ij.EDITING_DID_ENDED,this)}_editBoxTextChanged(t){t=this._updateLabelStringStyle(t,!0),this.string=t,ob.emitEvents(this.textChanged,t,this),this.node.emit(Ij.TEXT_CHANGED,this)}_editBoxEditingReturn(){ob.emitEvents(this.editingReturn,this),this.node.emit(Ij.EDITING_RETURN,this)}_showLabels(){this._isLabelVisible=!0,this._updateLabels()}_hideLabels(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)}_onTouchBegan(t){t.propagationStopped=!0}_onTouchCancel(t){t.propagationStopped=!0}_onTouchEnded(t){this._impl&&this._impl.beginEditing(),t.propagationStopped=!0}_init(){this._createBackgroundSprite(),this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(Mp.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new t._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()}_createBackgroundSprite(){this._background||(this._background=this.node.getComponent(UB),this._background||(this._background=this.node.addComponent(UB))),this._background.type=UB.Type.SLICED,this._background.spriteFrame=this._backgroundImage}_updateTextLabel(){let t=this._textLabel;if(!t){let e=this.node.getChildByName("TEXT_LABEL");e||(e=new ey("TEXT_LABEL")),t=e.getComponent(uN),t||(t=e.addComponent(uN)),e.parent=this.node,this._textLabel=t}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),t.overflow=uN.Overflow.CLAMP,this._inputMode===SV.ANY?(t.verticalAlign=rN.TOP,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this._updateLabelStringStyle(this._string)}_updatePlaceholderLabel(){let t=this._placeholderLabel;if(!t){let e=this.node.getChildByName("PLACEHOLDER_LABEL");e||(e=new ey("PLACEHOLDER_LABEL")),t=e.getComponent(uN),t||(t=e.addComponent(uN)),e.parent=this.node,this._placeholderLabel=t}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),t.overflow=uN.Overflow.CLAMP,this._inputMode===SV.ANY?(t.verticalAlign=rN.TOP,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this.placeholder}_syncSize(){const t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(this._background){const n=this._background.node._uiProps.uiTransformComp;n.anchorPoint=t.anchorPoint,n.setContentSize(e)}this._updateLabelPosition(e),this._impl&&this._impl.setSize(e.width,e.height)}_updateLabels(){if(this._isLabelVisible){const t=this._string;this._textLabel&&(this._textLabel.node.active=""!==t),this._placeholderLabel&&(this._placeholderLabel.node.active=""===t)}}_updateString(t){const e=this._textLabel;if(!e)return;let n=t;n&&(n=this._updateLabelStringStyle(n)),e.string=n,this._updateLabels()}_updateLabelStringStyle(t,e=!1){const n=this._inputFlag;if(e||n!==TV.PASSWORD)n===TV.INITIAL_CAPS_ALL_CHARACTERS?t=t.toUpperCase():n===TV.INITIAL_CAPS_WORD?t=t.replace(/(?:^|\s)\S/g,(t=>t.toUpperCase())):n===TV.INITIAL_CAPS_SENTENCE&&(t=(i=t).charAt(0).toUpperCase()+i.slice(1));else{let e="";const n=t.length;for(let t=0;t<n;++t)e+="";t=e}var i;return t}_registerEvent(){this.node.on(Mp.TOUCH_START,this._onTouchBegan,this),this.node.on(Mp.TOUCH_END,this._onTouchEnded,this)}_unregisterEvent(){this.node.off(Mp.TOUCH_START,this._onTouchBegan,this),this.node.off(Mp.TOUCH_END,this._onTouchEnded,this)}_updateLabelPosition(t){const e=this.node._uiProps.uiTransformComp,n=-e.anchorX*e.width,i=-e.anchorY*e.height,s=this._placeholderLabel,o=this._textLabel;o&&(o.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),o.node.setPosition(n+2,i+t.height,o.node.position.z),this._inputMode===SV.ANY&&(o.verticalAlign=rN.TOP),o.enableWrapText=this._inputMode===SV.ANY),s&&(s.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),s.lineHeight=t.height,s.node.setPosition(n+2,i+t.height,s.node.position.z),this._inputMode===SV.ANY&&(s.verticalAlign=rN.TOP),s.enableWrapText=this._inputMode===SV.ANY)}_resizeChildNodes(){const t=this.node._uiProps.uiTransformComp,e=this._textLabel&&this._textLabel.node;e&&(e.setPosition(-t.width/2,t.height/2,e.position.z),e._uiProps.uiTransformComp.setContentSize(t.contentSize));const n=this._placeholderLabel&&this._placeholderLabel.node;n&&(n.setPosition(-t.width/2,t.height/2,n.position.z),n._uiProps.uiTransformComp.setContentSize(t.contentSize));const i=this._background&&this._background.node;i&&i._uiProps.uiTransformComp.setContentSize(t.contentSize)}},wj._EditBoxImpl=class{constructor(){this._editing=!1,this._delegate=null}init(t){}onEnable(){}update(){}onDisable(){this._editing&&this.endEditing()}clear(){this._delegate=null}setTabIndex(t){}setSize(t,e){}setFocus(t){t?this.beginEditing():this.endEditing()}isFocused(){return this._editing}beginEditing(){}endEditing(){}},wj.KeyboardReturnType=xV,wj.InputFlag=TV,wj.InputMode=SV,wj.EventType=Ij,Yh((pj=Dj).prototype,"string",[DV,IV],Object.getOwnPropertyDescriptor(pj.prototype,"string"),pj.prototype),Yh(pj.prototype,"placeholder",[RV,OV],Object.getOwnPropertyDescriptor(pj.prototype,"placeholder"),pj.prototype),Yh(pj.prototype,"textLabel",[MV,NV,LV],Object.getOwnPropertyDescriptor(pj.prototype,"textLabel"),pj.prototype),Yh(pj.prototype,"placeholderLabel",[BV,FV,zV],Object.getOwnPropertyDescriptor(pj.prototype,"placeholderLabel"),pj.prototype),Yh(pj.prototype,"backgroundImage",[UV,HV,GV],Object.getOwnPropertyDescriptor(pj.prototype,"backgroundImage"),pj.prototype),Yh(pj.prototype,"inputFlag",[VV,jV,WV],Object.getOwnPropertyDescriptor(pj.prototype,"inputFlag"),pj.prototype),Yh(pj.prototype,"inputMode",[kV,qV,XV],Object.getOwnPropertyDescriptor(pj.prototype,"inputMode"),pj.prototype),Yh(pj.prototype,"returnType",[YV,KV,$V],Object.getOwnPropertyDescriptor(pj.prototype,"returnType"),pj.prototype),Yh(pj.prototype,"maxLength",[ZV,JV],Object.getOwnPropertyDescriptor(pj.prototype,"maxLength"),pj.prototype),Yh(pj.prototype,"tabIndex",[QV,tj],Object.getOwnPropertyDescriptor(pj.prototype,"tabIndex"),pj.prototype),fj=Yh(pj.prototype,"editingDidBegan",[ej,c_,nj,ij],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mj=Yh(pj.prototype,"textChanged",[sj,c_,oj,rj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gj=Yh(pj.prototype,"editingDidEnded",[aj,c_,cj,lj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vj=Yh(pj.prototype,"editingReturn",[hj,c_,_j,uj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yj=Yh(pj.prototype,"_textLabel",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xj=Yh(pj.prototype,"_placeholderLabel",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Sj=Yh(pj.prototype,"_returnType",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xV.DEFAULT}}),Tj=Yh(pj.prototype,"_string",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ej=Yh(pj.prototype,"_tabIndex",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Aj=Yh(pj.prototype,"_backgroundImage",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Cj=Yh(pj.prototype,"_inputFlag",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TV.DEFAULT}}),bj=Yh(pj.prototype,"_inputMode",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return SV.ANY}}),Pj=Yh(pj.prototype,"_maxLength",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),dj=pj))||dj)||dj)||dj)||dj)||dj)||dj));const RW=Mp;var OW,MW,NW,LW,BW,FW;!function(t){t[t.NONE=0]="NONE",t[t.HORIZONTAL=1]="HORIZONTAL",t[t.VERTICAL=2]="VERTICAL",t[t.GRID=3]="GRID"}(OW||(OW={})),Mt(OW),function(t){t[t.NONE=0]="NONE",t[t.CONTAINER=1]="CONTAINER",t[t.CHILDREN=2]="CHILDREN"}(MW||(MW={})),Mt(MW),function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(NW||(NW={})),Mt(NW),function(t){t[t.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",t[t.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(LW||(LW={})),Mt(LW),function(t){t[t.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",t[t.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(BW||(BW={})),Mt(BW),function(t){t[t.NONE=0]="NONE",t[t.FIXED_ROW=1]="FIXED_ROW",t[t.FIXED_COL=2]="FIXED_COL"}(FW||(FW={})),Mt(FW);const zW=new $e;let UW=t("Layout",(Rj=i_("cc.Layout"),Oj=f_(),Mj=o_(110),Nj=__(),Lj=s_(RO),Bj=g_(),Fj=y_(),zj=g_(),Uj=y_(),Hj=O_(OW),Gj=y_(),Vj=O_(MW),jj=g_(),Wj=y_(),kj=g_(),qj=y_(),Xj=O_(NW),Yj=y_(),Kj=y_(),$j=y_(),Zj=y_(),Jj=y_(),Qj=y_(),tW=y_(),eW=O_(LW),nW=y_(),iW=O_(BW),sW=y_(),oW=O_(FW),rW=g_(),aW=y_(),cW=g_(),lW=y_(),hW=y_(),Rj(_W=Oj(_W=Mj(_W=Nj(_W=Lj(_W=h_((IW=DW=class extends Ad{constructor(...t){super(...t),Xh(this,"_resizeMode",dW,this),Xh(this,"_layoutType",pW,this),Xh(this,"_cellSize",fW,this),Xh(this,"_startAxis",mW,this),Xh(this,"_paddingLeft",gW,this),Xh(this,"_paddingRight",vW,this),Xh(this,"_paddingTop",yW,this),Xh(this,"_paddingBottom",xW,this),Xh(this,"_spacingX",SW,this),Xh(this,"_spacingY",TW,this),Xh(this,"_verticalDirection",EW,this),Xh(this,"_horizontalDirection",AW,this),Xh(this,"_constraint",CW,this),Xh(this,"_constraintNum",bW,this),Xh(this,"_affectedByScale",PW,this),Xh(this,"_isAlign",wW,this),this._layoutSize=new yn(300,200),this._layoutDirty=!0,this._childrenDirty=!1,this._usefulLayoutObj=[],this._init=!1}get alignHorizontal(){return this._isAlign}set alignHorizontal(t){this._layoutType===OW.HORIZONTAL&&(this._isAlign=t,this._doLayoutDirty())}get alignVertical(){return this._isAlign}set alignVertical(t){this._layoutType===OW.VERTICAL&&(this._isAlign=t,this._doLayoutDirty())}get type(){return this._layoutType}set type(t){this._layoutType=t,this._doLayoutDirty()}get resizeMode(){return this._resizeMode}set resizeMode(t){this._layoutType!==OW.NONE&&(this._resizeMode=t,this._doLayoutDirty())}get cellSize(){return this._cellSize}set cellSize(t){this._cellSize!==t&&(this._cellSize.set(t),this._doLayoutDirty())}get startAxis(){return this._startAxis}set startAxis(t){this._startAxis!==t&&(this._startAxis=t,this._doLayoutDirty())}get paddingLeft(){return this._paddingLeft}set paddingLeft(t){this._paddingLeft!==t&&(this._paddingLeft=t,this._doLayoutDirty())}get paddingRight(){return this._paddingRight}set paddingRight(t){this._paddingRight!==t&&(this._paddingRight=t,this._doLayoutDirty())}get paddingTop(){return this._paddingTop}set paddingTop(t){this._paddingTop!==t&&(this._paddingTop=t,this._doLayoutDirty())}get paddingBottom(){return this._paddingBottom}set paddingBottom(t){this._paddingBottom!==t&&(this._paddingBottom=t,this._doLayoutDirty())}get spacingX(){return this._spacingX}set spacingX(t){this._spacingX!==t&&(this._spacingX=t,this._doLayoutDirty())}get spacingY(){return this._spacingY}set spacingY(t){this._spacingY!==t&&(this._spacingY=t,this._doLayoutDirty())}get verticalDirection(){return this._verticalDirection}set verticalDirection(t){this._verticalDirection!==t&&(this._verticalDirection=t,this._doLayoutDirty())}get horizontalDirection(){return this._horizontalDirection}set horizontalDirection(t){this._horizontalDirection!==t&&(this._horizontalDirection=t,this._doLayoutDirty())}get padding(){return this._paddingLeft}set padding(t){this.paddingLeft===t&&this._paddingRight===t&&this._paddingTop===t&&this._paddingBottom===t||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=t,this._doLayoutDirty())}get constraint(){return this._constraint}set constraint(t){this._layoutType!==OW.NONE&&this._constraint!==t&&(this._constraint=t,this._doLayoutDirty())}get constraintNum(){return this._constraintNum}set constraintNum(t){this._constraint!==FW.NONE&&this._constraintNum!==t&&(t<=0&&d("Limit values to be greater than 0"),this._constraintNum=t,this._doLayoutDirty())}get affectedByScale(){return this._affectedByScale}set affectedByScale(t){this._affectedByScale=t,this._doLayoutDirty()}updateLayout(t=!1){(this._layoutDirty||t)&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)}onEnable(){this._addEventListeners();const t=this.node._uiProps.uiTransformComp;t.contentSize.equals(yn.ZERO)&&t.setContentSize(this._layoutSize),this._childrenChanged()}onDisable(){this._usefulLayoutObj.length=0,this._removeEventListeners()}_checkUsefulObj(){this._usefulLayoutObj.length=0;const t=this.node.children;for(let e=0;e<t.length;++e){const n=t[e],i=n._uiProps.uiTransformComp;n.activeInHierarchy&&i&&this._usefulLayoutObj.push(i)}}_addEventListeners(){qA.on(kA.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(RW.SIZE_CHANGED,this._resized,this),this.node.on(RW.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(RW.CHILD_ADDED,this._childAdded,this),this.node.on(RW.CHILD_REMOVED,this._childRemoved,this),this.node.on(RW.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()}_removeEventListeners(){qA.off(kA.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(RW.SIZE_CHANGED,this._resized,this),this.node.off(RW.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(RW.CHILD_ADDED,this._childAdded,this),this.node.off(RW.CHILD_REMOVED,this._childRemoved,this),this.node.off(RW.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()}_addChildrenEventListeners(){const t=this.node.children;for(let e=0;e<t.length;++e){const n=t[e];n.on(RW.SIZE_CHANGED,this._doLayoutDirty,this),n.on(RW.TRANSFORM_CHANGED,this._transformDirty,this),n.on(RW.ANCHOR_CHANGED,this._doLayoutDirty,this),n.on("active-in-hierarchy-changed",this._childrenChanged,this)}}_removeChildrenEventListeners(){const t=this.node.children;for(let e=0;e<t.length;++e){const n=t[e];n.off(RW.SIZE_CHANGED,this._doLayoutDirty,this),n.off(RW.TRANSFORM_CHANGED,this._transformDirty,this),n.off(RW.ANCHOR_CHANGED,this._doLayoutDirty,this),n.off("active-in-hierarchy-changed",this._childrenChanged,this)}}_childAdded(t){t.on(RW.SIZE_CHANGED,this._doLayoutDirty,this),t.on(RW.TRANSFORM_CHANGED,this._transformDirty,this),t.on(RW.ANCHOR_CHANGED,this._doLayoutDirty,this),t.on("active-in-hierarchy-changed",this._childrenChanged,this),this._childrenChanged()}_childRemoved(t){t.off(RW.SIZE_CHANGED,this._doLayoutDirty,this),t.off(RW.TRANSFORM_CHANGED,this._transformDirty,this),t.off(RW.ANCHOR_CHANGED,this._doLayoutDirty,this),t.off("active-in-hierarchy-changed",this._childrenChanged,this),this._childrenChanged()}_resized(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()}_doLayoutHorizontally(t,e,n,i){const s=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum();let r=1,a=this._paddingLeft;this._horizontalDirection===BW.RIGHT_TO_LEFT&&(r=-1,a=this._paddingRight);const c=(this._horizontalDirection-s.x)*t+r*a;let l=c-r*this._spacingX,h=0,_=0,u=0,d=0,p=!1;const f=this._usefulLayoutObj.length;let m=this._cellSize.width;const g=this._getPaddingH();this._layoutType!==OW.GRID&&this._resizeMode===MW.CHILDREN&&(m=(t-g-(f-1)*this._spacingX)/f);const v=this._usefulLayoutObj;for(let a=0;a<v.length;++a){const f=v[a],y=f.node,x=y.scale,S=this._getUsedScaleValue(x.x),T=this._getUsedScaleValue(x.y);this._resizeMode===MW.CHILDREN&&(f.width=m/S,this._layoutType===OW.GRID&&(f.height=this._cellSize.height/T));const E=Math.abs(this._horizontalDirection-f.anchorX),A=f.width*S,C=f.height*T;C>u&&(d=Math.max(u,d),_=u||C,u=C),l+=r*(E*A+this._spacingX);const b=r*(1-E)*A;if(e){if(o>0)p=a/o>0&&a%o==0,p&&(_=u>C?u:_);else if(A>t-g)l>c+r*E*A&&(p=!0);else{const e=(1-this._horizontalDirection-s.x)*t,n=l+b+r*(r>0?this._paddingRight:this._paddingLeft);p=Math.abs(n)>Math.abs(e)}p&&(l=c+r*E*A,C!==u&&(_=u),h+=_+this._spacingY,_=u=C)}const P=n(y,f,h);i&&y.setPosition(l,P),l+=b}return _=Math.max(_,u),Math.max(d,h+_)+this._getPaddingV()}_doLayoutVertically(t,e,n,i){const s=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum();let r=1,a=this._paddingBottom;this._verticalDirection===LW.TOP_TO_BOTTOM&&(r=-1,a=this._paddingTop);const c=(this._verticalDirection-s.y)*t+r*a;let l=c-r*this._spacingY,h=0,_=0,u=0,d=0,p=!1;const f=this._usefulLayoutObj.length;let m=this._cellSize.height;const g=this._getPaddingV();this._layoutType!==OW.GRID&&this._resizeMode===MW.CHILDREN&&(m=(t-g-(f-1)*this._spacingY)/f);const v=this._usefulLayoutObj;for(let a=0;a<v.length;++a){const f=v[a],y=f.node,x=y.scale,S=this._getUsedScaleValue(x.x),T=this._getUsedScaleValue(x.y);this._resizeMode===MW.CHILDREN&&(f.height=m/T,this._layoutType===OW.GRID&&(f.width=this._cellSize.width/S));const E=Math.abs(this._verticalDirection-f.anchorY),A=f.width*S,C=f.height*T;A>h&&(_=Math.max(h,_),u=h||A,h=A),l+=r*(E*C+this._spacingY);const b=r*(1-E)*C;if(e){if(o>0)p=a/o>0&&a%o==0,p&&(u=h>C?h:u);else if(C>t-g)l>c+r*E*C&&(p=!0);else{const e=(1-this._verticalDirection-s.y)*t,n=l+b+r*(r>0?this._paddingTop:this._paddingBottom);p=Math.abs(n)>Math.abs(e)}p&&(l=c+r*E*C,A!==h&&(u=h),d+=u+this._spacingX,u=h=A)}const P=n(y,f,d);i&&(y.getPosition(zW),y.setPosition(P,l,zW.z)),l+=b}return u=Math.max(u,h),Math.max(_,d+u)+this._getPaddingH()}_doLayoutGridAxisHorizontal(t,e){const n=e.width;let i=1,s=-t.y*e.height,o=this._paddingBottom;this._verticalDirection===LW.TOP_TO_BOTTOM&&(i=-1,s=(1-t.y)*e.height,o=this._paddingTop);const r=(t,e,n)=>s+i*(n+(1-e.anchorY)*e.height*this._getUsedScaleValue(t.scale.y)+o);let a=0;this._resizeMode===MW.CONTAINER&&(a=this._doLayoutHorizontally(n,!0,r,!1),s=-t.y*a,this._verticalDirection===LW.TOP_TO_BOTTOM&&(i=-1,s=(1-t.y)*a)),this._doLayoutHorizontally(n,!0,r,!0),this._resizeMode===MW.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(n,a)}_doLayoutGridAxisVertical(t,e){const n=e.height;let i=1,s=-t.x*e.width,o=this._paddingLeft;this._horizontalDirection===BW.RIGHT_TO_LEFT&&(i=-1,s=(1-t.x)*e.width,o=this._paddingRight);const r=(t,e,n)=>s+i*(n+(1-e.anchorX)*e.width*this._getUsedScaleValue(t.scale.x)+o);let a=0;this._resizeMode===MW.CONTAINER&&(a=this._doLayoutVertically(n,!0,r,!1),s=-t.x*a,this._horizontalDirection===BW.RIGHT_TO_LEFT&&(i=-1,s=(1-t.x)*a)),this._doLayoutVertically(n,!0,r,!0),this._resizeMode===MW.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(a,n)}_doLayoutGrid(){const t=this.node._uiProps.uiTransformComp,e=t.anchorPoint,n=t.contentSize;this.startAxis===NW.HORIZONTAL?this._doLayoutGridAxisHorizontal(e,n):this.startAxis===NW.VERTICAL&&this._doLayoutGridAxisVertical(e,n)}_getHorizontalBaseWidth(t=!0){const e=this._usefulLayoutObj;let n=0;const i=e.length;if(this._resizeMode===MW.CONTAINER){for(let t=0;t<e.length;++t){const i=e[t],s=i.node.scale;n+=i.width*this._getUsedScaleValue(s.x)}n+=(i-1)*this._spacingX+this._getPaddingH()}else n=this.node._uiProps.uiTransformComp.width;return n}_getVerticalBaseHeight(){const t=this._usefulLayoutObj;let e=0;const n=t.length;if(this._resizeMode===MW.CONTAINER){for(let n=0;n<t.length;++n){const i=t[n],s=i.node.scale;e+=i.height*this._getUsedScaleValue(s.y)}e+=(n-1)*this._spacingY+this._getPaddingV()}else e=this.node._uiProps.uiTransformComp.height;return e}_doLayout(){if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===OW.HORIZONTAL){const t=this._getHorizontalBaseWidth(),e=t=>(this._isAlign?$e.ZERO:t.position).y;this._doLayoutHorizontally(t,!1,e,!0),this.node._uiProps.uiTransformComp.width=t}else if(this._layoutType===OW.VERTICAL){const t=this._getVerticalBaseHeight(),e=t=>(this._isAlign?$e.ZERO:t.position).x;this._doLayoutVertically(t,!1,e,!0),this.node._uiProps.uiTransformComp.height=t}else this._layoutType===OW.GRID&&this._doLayoutGrid()}_getUsedScaleValue(t){return this._affectedByScale?Math.abs(t):1}_transformDirty(t){t&Hh.SCALE&&t&Hh.POSITION&&this._affectedByScale&&this._doLayoutDirty()}_doLayoutDirty(){this._layoutDirty=!0}_childrenChanged(){this._childrenDirty=!0,this._doLayoutDirty()}_getPaddingH(){return this._paddingLeft+this._paddingRight}_getPaddingV(){return this._paddingTop+this._paddingBottom}_getFixedBreakingNum(){if(this._layoutType!==OW.GRID||this._constraint===FW.NONE||this._constraintNum<=0)return 0;let t=this._constraint===FW.FIXED_ROW?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return this._startAxis===NW.VERTICAL&&(t=this._constraint===FW.FIXED_COL?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),t}},DW.Type=OW,DW.VerticalDirection=LW,DW.HorizontalDirection=BW,DW.ResizeMode=MW,DW.AxisDirection=NW,DW.Constraint=FW,Yh((uW=IW).prototype,"alignHorizontal",[Bj,Fj],Object.getOwnPropertyDescriptor(uW.prototype,"alignHorizontal"),uW.prototype),Yh(uW.prototype,"alignVertical",[zj,Uj],Object.getOwnPropertyDescriptor(uW.prototype,"alignVertical"),uW.prototype),Yh(uW.prototype,"type",[Hj,Gj],Object.getOwnPropertyDescriptor(uW.prototype,"type"),uW.prototype),Yh(uW.prototype,"resizeMode",[Vj,jj,Wj],Object.getOwnPropertyDescriptor(uW.prototype,"resizeMode"),uW.prototype),Yh(uW.prototype,"cellSize",[kj,qj],Object.getOwnPropertyDescriptor(uW.prototype,"cellSize"),uW.prototype),Yh(uW.prototype,"startAxis",[Xj,Yj],Object.getOwnPropertyDescriptor(uW.prototype,"startAxis"),uW.prototype),Yh(uW.prototype,"paddingLeft",[Kj],Object.getOwnPropertyDescriptor(uW.prototype,"paddingLeft"),uW.prototype),Yh(uW.prototype,"paddingRight",[$j],Object.getOwnPropertyDescriptor(uW.prototype,"paddingRight"),uW.prototype),Yh(uW.prototype,"paddingTop",[Zj],Object.getOwnPropertyDescriptor(uW.prototype,"paddingTop"),uW.prototype),Yh(uW.prototype,"paddingBottom",[Jj],Object.getOwnPropertyDescriptor(uW.prototype,"paddingBottom"),uW.prototype),Yh(uW.prototype,"spacingX",[Qj],Object.getOwnPropertyDescriptor(uW.prototype,"spacingX"),uW.prototype),Yh(uW.prototype,"spacingY",[tW],Object.getOwnPropertyDescriptor(uW.prototype,"spacingY"),uW.prototype),Yh(uW.prototype,"verticalDirection",[eW,nW],Object.getOwnPropertyDescriptor(uW.prototype,"verticalDirection"),uW.prototype),Yh(uW.prototype,"horizontalDirection",[iW,sW],Object.getOwnPropertyDescriptor(uW.prototype,"horizontalDirection"),uW.prototype),Yh(uW.prototype,"constraint",[oW,rW,aW],Object.getOwnPropertyDescriptor(uW.prototype,"constraint"),uW.prototype),Yh(uW.prototype,"constraintNum",[cW,lW],Object.getOwnPropertyDescriptor(uW.prototype,"constraintNum"),uW.prototype),Yh(uW.prototype,"affectedByScale",[hW],Object.getOwnPropertyDescriptor(uW.prototype,"affectedByScale"),uW.prototype),dW=Yh(uW.prototype,"_resizeMode",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return MW.NONE}}),pW=Yh(uW.prototype,"_layoutType",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OW.NONE}}),fW=Yh(uW.prototype,"_cellSize",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn(40,40)}}),mW=Yh(uW.prototype,"_startAxis",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return NW.HORIZONTAL}}),gW=Yh(uW.prototype,"_paddingLeft",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vW=Yh(uW.prototype,"_paddingRight",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yW=Yh(uW.prototype,"_paddingTop",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xW=Yh(uW.prototype,"_paddingBottom",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),SW=Yh(uW.prototype,"_spacingX",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),TW=Yh(uW.prototype,"_spacingY",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),EW=Yh(uW.prototype,"_verticalDirection",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return LW.TOP_TO_BOTTOM}}),AW=Yh(uW.prototype,"_horizontalDirection",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BW.LEFT_TO_RIGHT}}),CW=Yh(uW.prototype,"_constraint",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return FW.NONE}}),bW=Yh(uW.prototype,"_constraintNum",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),PW=Yh(uW.prototype,"_affectedByScale",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wW=Yh(uW.prototype,"_isAlign",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_W=uW))||_W)||_W)||_W)||_W)||_W)||_W));var HW,GW,VW,jW,WW,kW,qW,XW,YW,KW,$W,ZW,JW,QW,tk,ek,nk,ik,sk,ok,rk,ak,ck,lk,hk,_k,uk,dk,pk,fk,mk,gk,vk,yk,xk,Sk,Tk,Ek,Ak,Ck,bk,Pk,wk,Dk,Ik,Rk,Ok;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL",t[t.FILLED=2]="FILLED"}(ck||(ck={})),It(ck),t("ProgressBar",(HW=i_("cc.ProgressBar"),GW=f_(),VW=o_(110),jW=__(),WW=s_(RO),kW=O_(UB),qW=y_(),XW=O_(ck),YW=y_(),KW=y_(),$W=x_(),ZW=y_(),JW=y_(),HW(QW=GW(QW=VW(QW=jW(QW=WW((ak=rk=class extends Ad{constructor(...t){super(...t),Xh(this,"_barSprite",ek,this),Xh(this,"_mode",nk,this),Xh(this,"_totalLength",ik,this),Xh(this,"_progress",sk,this),Xh(this,"_reverse",ok,this)}get barSprite(){return this._barSprite}set barSprite(t){this._barSprite!==t&&(this._barSprite=t,this._initBarSprite())}get mode(){return this._mode}set mode(t){if(this._mode!==t&&(this._mode=t,this._barSprite)){const t=this._barSprite.node;if(!t)return;const e=t._uiProps.uiTransformComp.contentSize;this._mode===ck.HORIZONTAL?this.totalLength=e.width:this._mode===ck.VERTICAL?this.totalLength=e.height:this._mode===ck.FILLED&&(this.totalLength=this._barSprite.fillRange)}}get totalLength(){return this._totalLength}set totalLength(t){this._mode===ck.FILLED&&(t=Ie(t)),this._totalLength=t,this._updateBarStatus()}get progress(){return this._progress}set progress(t){this._progress!==t&&(this._progress=t,this._updateBarStatus())}get reverse(){return this._reverse}set reverse(t){this._reverse!==t&&(this._reverse=t,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}_initBarSprite(){if(this._barSprite){const t=this._barSprite.node;if(!t)return;const e=this.node._uiProps.uiTransformComp,n=e.contentSize,i=e.anchorPoint,s=t._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===UB.FillType.RADIAL&&(this._mode=ck.FILLED),this._mode===ck.HORIZONTAL?this.totalLength=s.width:this._mode===ck.VERTICAL?this.totalLength=s.height:this.totalLength=this._barSprite.fillRange,t.parent===this.node){const e=-n.width*i.x;t.setPosition(e,0,0)}}}_updateBarStatus(){if(this._barSprite){const t=this._barSprite.node;if(!t)return;const e=t._uiProps.uiTransformComp,n=e.anchorPoint,i=e.contentSize,s=t.getPosition();let o=new qe(0,.5);const r=Ie(this._progress);let a=this._totalLength*r,c=i,l=0,h=0;switch(this._mode){case ck.HORIZONTAL:this._reverse&&(o=new qe(1,.5)),c=new yn(a,i.height),l=this._totalLength,h=i.height;break;case ck.VERTICAL:o=this._reverse?new qe(.5,1):new qe(.5,0),c=new yn(i.width,a),l=i.width,h=this._totalLength}if(this._mode===ck.FILLED)this._barSprite.type!==UB.Type.FILLED?d("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(a*=-1),this._barSprite.fillRange=a);else if(this._barSprite.type!==UB.Type.FILLED){const i=o.x-n.x,r=o.y-n.y,a=new $e(l*i,h*r,0);t.setPosition(s.x+a.x,s.y+a.y,s.z),e.setAnchorPoint(o),e.setContentSize(c)}else d("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}}},rk.Mode=ck,Yh((tk=ak).prototype,"barSprite",[kW,qW],Object.getOwnPropertyDescriptor(tk.prototype,"barSprite"),tk.prototype),Yh(tk.prototype,"mode",[XW,YW],Object.getOwnPropertyDescriptor(tk.prototype,"mode"),tk.prototype),Yh(tk.prototype,"totalLength",[KW],Object.getOwnPropertyDescriptor(tk.prototype,"totalLength"),tk.prototype),Yh(tk.prototype,"progress",[$W,A_,ZW],Object.getOwnPropertyDescriptor(tk.prototype,"progress"),tk.prototype),Yh(tk.prototype,"reverse",[JW],Object.getOwnPropertyDescriptor(tk.prototype,"reverse"),tk.prototype),ek=Yh(tk.prototype,"_barSprite",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nk=Yh(tk.prototype,"_mode",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ck.HORIZONTAL}}),ik=Yh(tk.prototype,"_totalLength",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),sk=Yh(tk.prototype,"_progress",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),ok=Yh(tk.prototype,"_reverse",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),QW=tk))||QW)||QW)||QW)||QW)||QW));const Mk=new $e,Nk=new $e,Lk=new $e,Bk=new qe,Fk=new An,zk=new qe;var Uk;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(Uk||(Uk={})),Mt(Uk);let Hk=t("ScrollBar",(lk=i_("cc.ScrollBar"),hk=f_(),_k=o_(110),uk=__(),dk=s_(RO),pk=O_(UB),fk=C_(),mk=y_(),gk=O_(Uk),vk=C_(),yk=y_(),xk=C_(),Sk=y_(),Tk=C_(),Ek=y_(),lk(Ak=hk(Ak=_k(Ak=uk(Ak=dk((Ok=Rk=class extends Ad{constructor(...t){super(...t),Xh(this,"_scrollView",bk,this),Xh(this,"_handle",Pk,this),Xh(this,"_direction",wk,this),Xh(this,"_enableAutoHide",Dk,this),Xh(this,"_autoHideTime",Ik,this),this._touching=!1,this._opacity=255,this._autoHideRemainingTime=0}get handle(){return this._handle}set handle(t){this._handle!==t&&(this._handle=t,this.onScroll(qe.ZERO))}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t,this.onScroll(qe.ZERO))}get enableAutoHide(){return this._enableAutoHide}set enableAutoHide(t){this._enableAutoHide!==t&&(this._enableAutoHide=t,this._enableAutoHide&&this._setOpacity(0))}get autoHideTime(){return this._autoHideTime}set autoHideTime(t){this._autoHideTime!==t&&(this._autoHideTime=t)}hide(){this._autoHideRemainingTime=0,this._setOpacity(0)}show(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)}onScroll(t){if(!this._scrollView)return;const e=this._scrollView.content;if(!e)return;const n=e._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize,s=this.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(n,i))return;this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));let o=0,r=0,a=0,c=0,l=0;const h=zk;h.set(0,0),this._direction===Uk.HORIZONTAL?(o=n.width,r=i.width,l=s.width,a=t.x,this._convertToScrollViewSpace(h,e),c=-h.x):this._direction===Uk.VERTICAL&&(o=n.height,r=i.height,l=s.height,a=t.y,this._convertToScrollViewSpace(h,e),c=-h.y);const _=this._calculateLength(o,r,l,a),u=zk;this._calculatePosition(u,o,r,l,c,a,_),this._updateLength(_),this._updateHandlerPosition(u)}setScrollView(t){this._scrollView=t}onTouchBegan(){this._enableAutoHide&&(this._touching=!0)}onTouchEnded(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){const t=this._scrollView.content;if(t){const e=t._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(e,n))return}}this._autoHideRemainingTime=this._autoHideTime}}onEnable(){const t=this.node.getComponent(UB);t&&(this._opacity=t.color.a)}start(){this._enableAutoHide&&this._setOpacity(0)}update(t){this._processAutoHide(t)}_convertToScrollViewSpace(t,e){const n=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,i=e._uiProps.uiTransformComp;if(n&&i){Mk.set(-i.anchorX*i.width,-i.anchorY*i.height,0),i.convertToWorldSpaceAR(Mk,Nk);const e=n.convertToNodeSpaceAR(Nk);e.x+=n.anchorX*n.width,e.y+=n.anchorY*n.height,t.set(e.x,e.y)}else t.set(qe.ZERO)}_setOpacity(t){if(this._handle){let e=this.node.getComponent(UB);e&&(Fk.set(e.color),Fk.a=t,e.color=Fk),e=this._handle.getComponent(UB),e&&(Fk.set(e.color),Fk.a=t,e.color=Fk)}}_updateHandlerPosition(t){if(this._handle){const e=Lk;this._fixupHandlerPosition(e),this._handle.node.setPosition(t.x+e.x,t.y+e.y,e.z)}}_fixupHandlerPosition(t){const e=this.node._uiProps.uiTransformComp,n=e.contentSize,i=e.anchorPoint,s=this.handle.node._uiProps.uiTransformComp.contentSize,o=this.handle.node.parent;$e.set(Mk,-n.width*i.x,-n.height*i.y,0);const r=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(Mk,Nk),a=t;a.set(0,0,0),o._uiProps.uiTransformComp.convertToNodeSpaceAR(r,a),this.direction===Uk.HORIZONTAL?a.set(a.x,a.y+(n.height-s.height)/2,a.z):this.direction===Uk.VERTICAL&&a.set(a.x+(n.width-s.width)/2,a.y,a.z),this.handle.node.setPosition(a)}_conditionalDisableScrollBar(t,e){return t.width<=e.width&&this._direction===Uk.HORIZONTAL||t.height<=e.height&&this._direction===Uk.VERTICAL}_calculateLength(t,e,n,i){let s=t;return i&&(s+=20*(i>0?i:-i)),n*(e/s)}_calculatePosition(t,e,n,i,s,o,r){let a=e-n;o&&(a+=Math.abs(o));let c=0;a&&(c=s/a,c=Ie(c));const l=(i-r)*c;this._direction===Uk.VERTICAL?t.set(0,l):t.set(l,0)}_updateLength(t){if(this._handle){const e=this._handle.node._uiProps.uiTransformComp,n=e.contentSize,i=e.anchorPoint;i.x===Bk.x&&i.y===Bk.y||e.setAnchorPoint(Bk),this._direction===Uk.HORIZONTAL?e.setContentSize(t,n.height):e.setContentSize(n.width,t)}}_processAutoHide(t){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=t,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);const t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}}},Rk.Direction=Uk,Yh((Ck=Ok).prototype,"handle",[pk,fk,mk],Object.getOwnPropertyDescriptor(Ck.prototype,"handle"),Ck.prototype),Yh(Ck.prototype,"direction",[gk,vk,yk],Object.getOwnPropertyDescriptor(Ck.prototype,"direction"),Ck.prototype),Yh(Ck.prototype,"enableAutoHide",[xk,Sk],Object.getOwnPropertyDescriptor(Ck.prototype,"enableAutoHide"),Ck.prototype),Yh(Ck.prototype,"autoHideTime",[Tk,Ek],Object.getOwnPropertyDescriptor(Ck.prototype,"autoHideTime"),Ck.prototype),bk=Yh(Ck.prototype,"_scrollView",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Pk=Yh(Ck.prototype,"_handle",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wk=Yh(Ck.prototype,"_direction",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Uk.HORIZONTAL}}),Dk=Yh(Ck.prototype,"_enableAutoHide",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ik=Yh(Ck.prototype,"_autoHideTime",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Ak=Ck))||Ak)||Ak)||Ak)||Ak)||Ak));var Gk;let Vk=t("ViewGroup",i_("cc.ViewGroup")(Gk=o_(110)(Gk=class extends Ad{})||Gk)||Gk);var jk,Wk,kk,qk,Xk,Yk,Kk,$k,Zk,Jk,Qk,tq,eq,nq,iq,sq,oq,rq,aq,cq,lq,hq,_q,uq,dq,pq,fq,mq,gq,vq,yq,xq,Sq,Tq,Eq,Aq,Cq,bq,Pq,wq,Dq,Iq,Rq,Oq,Mq,Nq,Lq,Bq;i.ViewGroup=Vk;const Fq=1e-4,zq=new $e,Uq=new $e,Hq=new qe,Gq=new qe,Vq=()=>(new Date).getMilliseconds(),jq={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};let Wq;!function(t){t.SCROLL_TO_TOP="scroll-to-top",t.SCROLL_TO_BOTTOM="scroll-to-bottom",t.SCROLL_TO_LEFT="scroll-to-left",t.SCROLL_TO_RIGHT="scroll-to-right",t.SCROLL_BEGAN="scroll-began",t.SCROLL_ENDED="scroll-ended",t.BOUNCE_TOP="bounce-top",t.BOUNCE_BOTTOM="bounce-bottom",t.BOUNCE_LEFT="bounce-left",t.BOUNCE_RIGHT="bounce-right",t.SCROLLING="scrolling",t.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",t.TOUCH_UP="touch-up"}(Wq||(Wq={}));let kq=t("ScrollView",(jk=i_("cc.ScrollView"),Wk=f_(),kk=o_(110),qk=__(),Xk=s_(RO),Yk=x_(),Kk=C_(),$k=y_(),Zk=x_(),Jk=C_(),Qk=y_(),tq=C_(),eq=y_(),nq=C_(),iq=y_(),sq=O_(ey),oq=C_(),rq=y_(),aq=C_(),cq=y_(),lq=O_(Hk),hq=C_(),_q=y_(),uq=C_(),dq=y_(),pq=O_(Hk),fq=C_(),mq=y_(),gq=C_(),vq=y_(),yq=O_([ob]),xq=C_(),Sq=y_(),jk(Tq=Wk(Tq=kk(Tq=qk(Tq=Xk((Bq=Lq=class extends Vk{constructor(...t){super(...t),Xh(this,"bounceDuration",Aq,this),Xh(this,"brake",Cq,this),Xh(this,"elastic",bq,this),Xh(this,"inertia",Pq,this),Xh(this,"horizontal",wq,this),Xh(this,"vertical",Dq,this),Xh(this,"cancelInnerEvents",Iq,this),Xh(this,"scrollEvents",Rq,this),this._autoScrolling=!1,this._scrolling=!1,Xh(this,"_content",Oq,this),Xh(this,"_horizontalScrollBar",Mq,this),Xh(this,"_verticalScrollBar",Nq,this),this._topBoundary=0,this._bottomBoundary=0,this._leftBoundary=0,this._rightBoundary=0,this._touchMoveDisplacements=[],this._touchMoveTimeDeltas=[],this._touchMovePreviousTimestamp=0,this._touchMoved=!1,this._autoScrollAttenuate=!1,this._autoScrollStartPosition=new $e,this._autoScrollTargetDelta=new $e,this._autoScrollTotalTime=0,this._autoScrollAccumulatedTime=0,this._autoScrollCurrentlyOutOfBoundary=!1,this._autoScrollBraking=!1,this._autoScrollBrakingStartPosition=new $e,this._outOfBoundaryAmount=new $e,this._outOfBoundaryAmountDirty=!0,this._stopMouseWheel=!1,this._mouseWheelEventElapsedTime=0,this._isScrollEndedWithThresholdEventFired=!1,this._scrollEventEmitMask=0,this._isBouncing=!1,this._contentPos=new $e,this._deltaPos=new $e}get content(){return this._content}set content(t){if(this._content===t)return;const e=t&&t.parent&&t.parent._uiProps.uiTransformComp;!t||t&&e?(this._content=t,this._calculateBoundary()):S(4302)}get horizontalScrollBar(){return this._horizontalScrollBar}set horizontalScrollBar(t){this._horizontalScrollBar!==t&&(this._horizontalScrollBar=t,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(qe.ZERO)))}get verticalScrollBar(){return this._verticalScrollBar}set verticalScrollBar(t){this._verticalScrollBar!==t&&(this._verticalScrollBar=t,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(qe.ZERO)))}get view(){const t=this._content&&this._content.parent;return t?t._uiProps.uiTransformComp:null}scrollToBottom(t,e=!0){const n=this._calculateMovePercentDelta({anchor:new qe(0,0),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n,!0)}scrollToTop(t,e=!0){const n=this._calculateMovePercentDelta({anchor:new qe(0,1),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)}scrollToLeft(t,e=!0){const n=this._calculateMovePercentDelta({anchor:new qe(0,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)}scrollToRight(t,e=!0){const n=this._calculateMovePercentDelta({anchor:new qe(1,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)}scrollToTopLeft(t,e=!0){const n=this._calculateMovePercentDelta({anchor:new qe(0,1),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)}scrollToTopRight(t,e=!0){const n=this._calculateMovePercentDelta({anchor:new qe(1,1),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)}scrollToBottomLeft(t,e=!0){const n=this._calculateMovePercentDelta({anchor:new qe(0,0),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)}scrollToBottomRight(t,e=!0){const n=this._calculateMovePercentDelta({anchor:new qe(1,0),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)}scrollToOffset(t,e,n=!0){const i=this.getMaxScrollOffset(),s=new qe(0,0);0===i.x?s.x=0:s.x=t.x/i.x,0===i.y?s.y=1:s.y=(i.y-t.y)/i.y,this.scrollTo(s,e,n)}getScrollOffset(){const t=this._getContentTopBoundary()-this._topBoundary,e=this._getContentLeftBoundary()-this._leftBoundary;return new qe(e,t)}getMaxScrollOffset(){if(!this._content||!this.view)return qe.ZERO;const t=this._content._uiProps.uiTransformComp.contentSize;let e=t.width-this.view.width,n=t.height-this.view.height;return e=e>=0?e:0,n=n>=0?n:0,new qe(e,n)}scrollToPercentHorizontal(t,e,n){const i=this._calculateMovePercentDelta({anchor:new qe(t,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==n):this._moveContent(i)}scrollTo(t,e,n){const i=this._calculateMovePercentDelta({anchor:new qe(t),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,n):this._moveContent(i)}scrollToPercentVertical(t,e,n){const i=this._calculateMovePercentDelta({anchor:new qe(0,t),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,n):this._moveContent(i)}stopAutoScroll(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime}setContentPosition(t){this._setContentPosition(t)}_setContentPosition(t){if(!this._content)return;const e=this._getContentPosition();Math.abs(t.x-e.x)<Fq&&Math.abs(t.y-e.y)<Fq||(this._content.setPosition(t),this._outOfBoundaryAmountDirty=!0)}getContentPosition(){return this._getContentPosition()}_getContentPosition(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):$e.ZERO}isScrolling(){return this._scrolling}isAutoScrolling(){return this._autoScrolling}getScrollEndedEventTiming(){return Fq}start(){this._calculateBoundary(),this._content&&qA.once(kA.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)}onEnable(){this._registerEvent(),this._content&&(this._content.on(ey.EventType.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(ey.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(ey.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(ey.EventType.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()}update(t){this._autoScrolling&&this._processAutoScrolling(t)}onDisable(){this._unregisterEvent(),this._content&&(this._content.off(ey.EventType.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(ey.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(ey.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(ey.EventType.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()}_registerEvent(){this.node.on(ey.EventType.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(ey.EventType.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(ey.EventType.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(ey.EventType.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(ey.EventType.MOUSE_WHEEL,this._onMouseWheel,this,!0)}_unregisterEvent(){this.node.off(ey.EventType.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(ey.EventType.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(ey.EventType.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(ey.EventType.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(ey.EventType.MOUSE_WHEEL,this._onMouseWheel,this,!0)}_onMouseWheel(t,e){if(!this.enabledInHierarchy)return;if(this._hasNestedViewGroup(t,e))return;const n=new $e,i=t.getScrollY();this.vertical?n.set(0,-.1*i,0):this.horizontal&&n.set(-.1*i,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(n),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(t)}_onTouchBegan(t,e){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(t,e)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(t)))}_onTouchMoved(t,e){if(!this.enabledInHierarchy||!this._content)return;if(this._hasNestedViewGroup(t,e))return;const n=t.touch;if(this._handleMoveLogic(n),!this.cancelInnerEvents)return;const i=n.getUILocation(Hq);if(i.subtract(n.getUIStartLocation(Gq)),i.length()>7&&!this._touchMoved&&t.target!==this.node){const e=new Jp(t.getTouches(),t.bubbles);e.type=ey.EventType.TOUCH_CANCEL,e.touch=t.touch,e.simulate=!0,t.target.dispatchEvent(e),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(t)}_onTouchEnded(t,e){if(!this.enabledInHierarchy||!this._content||!t)return;if(this._hasNestedViewGroup(t,e))return;this._dispatchEvent(Wq.TOUCH_UP);const n=t.touch;this._handleReleaseLogic(n),this._touchMoved?t.propagationStopped=!0:this._stopPropagationIfTargetIsMe(t)}_onTouchCancelled(t,e){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(t,e)){if(t&&!t.simulate){const e=t.touch;this._handleReleaseLogic(e)}this._stopPropagationIfTargetIsMe(t)}}_calculateBoundary(){if(this._content&&this.view){const t=this._content.getComponent(UW);t&&t.enabledInHierarchy&&t.updateLayout();const e=this.view,n=e.width*e.anchorX,i=e.height*e.anchorY;this._leftBoundary=-n,this._bottomBoundary=-i,this._rightBoundary=this._leftBoundary+e.width,this._topBoundary=this._bottomBoundary+e.height,this._moveContentToTopLeft(e.contentSize)}}_hasNestedViewGroup(t,e){if(!t||t.eventPhase!==cu.CAPTURING_PHASE)return!1;if(e)for(const n of e){const e=n;if(this.node===e)return!(!t.target||!t.target.getComponent(Vk));if(e.getComponent(Vk))return!0}return!1}_startInertiaScroll(t){const e=new $e(t);e.multiplyScalar(.7),this._startAttenuatingAutoScroll(e,t)}_calculateAttenuatedFactor(t){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*t+t*t*8e-9))}_startAttenuatingAutoScroll(t,e){const n=t.clone();if(n.normalize(),this._content&&this.view){const t=this._content._uiProps.uiTransformComp.contentSize,e=this.view.contentSize,i=t.width-e.width,s=t.height-e.height,o=this._calculateAttenuatedFactor(i),r=this._calculateAttenuatedFactor(s);n.x=n.x*i*(1-this.brake)*o,n.y=n.y*s*r*(1-this.brake),n.z=0}const i=t.length();let s=n.length()/i;if(n.add(t),this.brake>0&&s>7){s=Math.sqrt(s);const e=t.clone();e.multiplyScalar(s),n.set(e),n.add(t)}let o=this._calculateAutoScrollTimeByInitialSpeed(e.length());this.brake>0&&s>3&&(s=3,o*=s),0===this.brake&&s>1&&(o*=s),this._startAutoScroll(n,o,!0)}_calculateAutoScrollTimeByInitialSpeed(t){return Math.sqrt(Math.sqrt(t/5))}_startAutoScroll(t,e,n=!1){const i=this._flattenVectorByDirection(t);this._autoScrolling=!0,this._autoScrollTargetDelta=i,this._autoScrollAttenuate=n,$e.copy(this._autoScrollStartPosition,this._getContentPosition()),this._autoScrollTotalTime=e,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition.set(0,0,0),this._getHowMuchOutOfBoundary().equals($e.ZERO,Fq)||(this._autoScrollCurrentlyOutOfBoundary=!0)}_calculateTouchMoveVelocity(){const t=new $e;let e=0;if(e=this._touchMoveTimeDeltas.reduce(((t,e)=>t+e),e),e<=0||e>=.5)t.set($e.ZERO);else{let n=new $e;n=this._touchMoveDisplacements.reduce(((t,e)=>(t.add(e),t)),n),t.set(n.x*(1-this.brake)/e,n.y*(1-this.brake)/e,n.z)}return t}_flattenVectorByDirection(t){const e=t;return e.x=this.horizontal?e.x:0,e.y=this.vertical?e.y:0,e}_moveContent(t,e){const n=this._flattenVectorByDirection(t);zq.set(this._getContentPosition()),zq.add(n),zq.set(Math.floor(1e4*zq.x)*Fq,Math.floor(1e4*zq.y)*Fq,zq.z),this._setContentPosition(zq);const i=this._getHowMuchOutOfBoundary();Hq.set(i.x,i.y),this._updateScrollBar(Hq),this.elastic&&e&&this._startBounceBackIfNeeded()}_getContentLeftBoundary(){if(!this._content)return-1;const t=this._getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.x-e.anchorX*e.width}_getContentRightBoundary(){if(!this._content)return-1;const t=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+t.width}_getContentTopBoundary(){if(!this._content)return-1;const t=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+t.height}_getContentBottomBoundary(){if(!this._content)return-1;const t=this._getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.y-e.anchorY*e.height}_getHowMuchOutOfBoundary(t){if((t=t||new $e).equals($e.ZERO,Fq)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;const e=new $e;return this._getContentLeftBoundary()+t.x>this._leftBoundary?e.x=this._leftBoundary-(this._getContentLeftBoundary()+t.x):this._getContentRightBoundary()+t.x<this._rightBoundary&&(e.x=this._rightBoundary-(this._getContentRightBoundary()+t.x)),this._getContentTopBoundary()+t.y<this._topBoundary?e.y=this._topBoundary-(this._getContentTopBoundary()+t.y):this._getContentBottomBoundary()+t.y>this._bottomBoundary&&(e.y=this._bottomBoundary-(this._getContentBottomBoundary()+t.y)),t.equals($e.ZERO,Fq)&&(this._outOfBoundaryAmount=e,this._outOfBoundaryAmountDirty=!1),this._clampDelta(e),e}_updateScrollBar(t){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(t),this.verticalScrollBar&&this.verticalScrollBar.onScroll(t)}_onScrollBarTouchBegan(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()}_onScrollBarTouchEnded(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()}_dispatchEvent(t){if(t===Wq.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(t===Wq.SCROLL_TO_TOP||t===Wq.SCROLL_TO_BOTTOM||t===Wq.SCROLL_TO_LEFT||t===Wq.SCROLL_TO_RIGHT){const e=1<<jq[t];if(this._scrollEventEmitMask&e)return;this._scrollEventEmitMask|=e}ob.emitEvents(this.scrollEvents,this,jq[t]),this.node.emit(t,this)}_adjustContentOutOfBoundary(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){const t=this._getHowMuchOutOfBoundary();zq.set(this._getContentPosition()),zq.add(t),this._content.setPosition(zq),this._updateScrollBar(qe.ZERO)}}_hideScrollBar(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()}_updateScrollBarState(){if(!this._content||!this.view)return;const t=this.view,e=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(e.height<t.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(e.width<t.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}_stopPropagationIfTargetIsMe(t){t.eventPhase===cu.AT_TARGET&&t.target===this.node&&(t.propagationStopped=!0)}_processDeltaMove(t){this._scrollChildren(t),this._gatherTouchMove(t)}_handleMoveLogic(t){this._getLocalAxisAlignDelta(this._deltaPos,t),this._processDeltaMove(this._deltaPos)}_handleReleaseLogic(t){this._getLocalAxisAlignDelta(this._deltaPos,t),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(Wq.SCROLL_ENDED))}_getLocalAxisAlignDelta(t,e){const n=this.node._uiProps.uiTransformComp,i=new $e;n&&(e.getUILocation(Hq),e.getUIPreviousLocation(Gq),zq.set(Hq.x,Hq.y,0),Uq.set(Gq.x,Gq.y,0),n.convertToNodeSpaceAR(zq,zq),n.convertToNodeSpaceAR(Uq,Uq),$e.subtract(i,zq,Uq)),t.set(i)}_scrollChildren(t){this._clampDelta(t);const e=t;let n,i;if(this.elastic&&(n=this._getHowMuchOutOfBoundary(),e.x*=0===n.x?1:.5,e.y*=0===n.y?1:.5),this.elastic||(n=this._getHowMuchOutOfBoundary(e),e.add(n)),this._content){const{anchorX:t,anchorY:n,width:s,height:o}=this._content._uiProps.uiTransformComp,r=this._content.position||$e.ZERO;e.y>0?r.y-n*o+e.y>=this._bottomBoundary&&(i=Wq.SCROLL_TO_BOTTOM):e.y<0&&r.y-n*o+o+e.y<=this._topBoundary&&(i=Wq.SCROLL_TO_TOP),e.x<0?r.x-t*s+s+e.x<=this._rightBoundary&&(i=Wq.SCROLL_TO_RIGHT):e.x>0&&r.x-t*s+e.x>=this._leftBoundary&&(i=Wq.SCROLL_TO_LEFT)}this._moveContent(e,!1),0===e.x&&0===e.y||(this._scrolling||(this._scrolling=!0,this._dispatchEvent(Wq.SCROLL_BEGAN)),this._dispatchEvent(Wq.SCROLLING)),i&&i.length>0&&this._dispatchEvent(i)}_handlePressLogic(){this._autoScrolling&&this._dispatchEvent(Wq.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=Vq(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()}_clampDelta(t){if(this._content&&this.view){const e=this.view.contentSize,n=this._content._uiProps.uiTransformComp;n.width<e.width&&(t.x=0),n.height<e.height&&(t.y=0)}}_gatherTouchMove(t){const e=t.clone();for(this._clampDelta(e);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(e);const n=Vq();this._touchMoveTimeDeltas.push((n-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=n}_startBounceBackIfNeeded(){if(!this.elastic)return!1;const t=this._getHowMuchOutOfBoundary();if(this._clampDelta(t),t.equals($e.ZERO,Fq))return!1;const e=Math.max(this.bounceDuration,0);return this._startAutoScroll(t,e,!0),this._isBouncing||(t.y>0&&this._dispatchEvent(Wq.BOUNCE_TOP),t.y<0&&this._dispatchEvent(Wq.BOUNCE_BOTTOM),t.x>0&&this._dispatchEvent(Wq.BOUNCE_RIGHT),t.x<0&&this._dispatchEvent(Wq.BOUNCE_LEFT),this._isBouncing=!0),!0}_processInertiaScroll(){if(!this._startBounceBackIfNeeded()&&this.inertia){const t=this._calculateTouchMoveVelocity();!t.equals(zq,Fq)&&this.brake<1&&this._startInertiaScroll(t)}this._onScrollBarTouchEnded()}_isOutOfBoundary(){return!this._getHowMuchOutOfBoundary().equals($e.ZERO,Fq)}_isNecessaryAutoScrollBrake(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this._getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1}_processAutoScrolling(t){const e=this._isNecessaryAutoScrollBrake(),n=e?.05:1;this._autoScrollAccumulatedTime+=t*(1/n);let i=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);var s;this._autoScrollAttenuate&&(s=i,i=(s-=1)*s*s*s*s+1);const o=this._autoScrollTargetDelta.clone();o.multiplyScalar(i);const r=this._autoScrollStartPosition.clone();r.add(o);let a=Math.abs(i-1)<=Fq;if(Math.abs(i-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(Wq.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){const t=r.clone();t.subtract(this._autoScrollBrakingStartPosition),e&&t.multiplyScalar(n),r.set(this._autoScrollBrakingStartPosition),r.add(t)}else{const t=r.clone();t.subtract(this.getContentPosition());const e=this._getHowMuchOutOfBoundary(t);e.equals($e.ZERO,Fq)||(r.add(e),a=!0)}a&&(this._autoScrolling=!1);const c=r.clone();c.subtract(this._getContentPosition()),this._clampDelta(c),this._moveContent(c,a),this._dispatchEvent(Wq.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(Wq.SCROLL_ENDED))}_checkMouseWheel(t){if(!this._getHowMuchOutOfBoundary().equals($e.ZERO,Fq))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(Wq.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=t,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(Wq.SCROLL_ENDED),this._stopMouseWheel=!1)}_calculateMovePercentDelta(t){const e=t.anchor,n=t.applyToHorizontal,i=t.applyToVertical;this._calculateBoundary(),e.clampf(qe.ZERO,qe.ONE);let s=this._getContentBottomBoundary()-this._bottomBoundary;s=-s;let o=this._getContentLeftBoundary()-this._leftBoundary;o=-o;const r=new $e;if(this._content&&this.view){let t=0;const a=this._content._uiProps.uiTransformComp.contentSize,c=this.view.contentSize;n&&(t=a.width-c.width,r.x=o-t*e.x),i&&(t=a.height-c.height,r.y=s-t*e.y)}return r}_moveContentToTopLeft(t){let e=this._getContentBottomBoundary()-this._bottomBoundary;e=-e;const n=new $e;let i=0,s=this._getContentLeftBoundary()-this._leftBoundary;if(s=-s,this._content){const o=this._content._uiProps.uiTransformComp.contentSize;o.height<t.height&&(i=o.height-t.height,n.y=e-i),o.width<t.width&&(i=o.width-t.width,n.x=s)}this._updateScrollBarState(),this._moveContent(n),this._adjustContentOutOfBoundary()}_scaleChanged(t){t===Hh.SCALE&&this._calculateBoundary()}},Lq.EventType=Wq,Aq=Yh((Eq=Bq).prototype,"bounceDuration",[c_,Yk,Kk,$k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Cq=Yh(Eq.prototype,"brake",[c_,Zk,Jk,Qk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),bq=Yh(Eq.prototype,"elastic",[c_,tq,eq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Pq=Yh(Eq.prototype,"inertia",[c_,nq,iq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Yh(Eq.prototype,"content",[sq,oq,rq],Object.getOwnPropertyDescriptor(Eq.prototype,"content"),Eq.prototype),wq=Yh(Eq.prototype,"horizontal",[c_,aq,cq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Yh(Eq.prototype,"horizontalScrollBar",[lq,hq,_q],Object.getOwnPropertyDescriptor(Eq.prototype,"horizontalScrollBar"),Eq.prototype),Dq=Yh(Eq.prototype,"vertical",[c_,uq,dq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Yh(Eq.prototype,"verticalScrollBar",[pq,fq,mq],Object.getOwnPropertyDescriptor(Eq.prototype,"verticalScrollBar"),Eq.prototype),Iq=Yh(Eq.prototype,"cancelInnerEvents",[c_,gq,vq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Rq=Yh(Eq.prototype,"scrollEvents",[yq,c_,xq,Sq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Oq=Yh(Eq.prototype,"_content",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Mq=Yh(Eq.prototype,"_horizontalScrollBar",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nq=Yh(Eq.prototype,"_verticalScrollBar",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Tq=Eq))||Tq)||Tq)||Tq)||Tq)||Tq));var qq,Xq,Yq,Kq,$q,Zq,Jq,Qq,tX,eX,nX,iX,sX,oX,rX,aX,cX,lX,hX,_X,uX;const dX=new $e;var pX,fX,mX,gX,vX,yX,xX,SX,TX,EX,AX,CX,bX,PX,wX,DX,IX,RX,OX,MX,NX,LX,BX,FX,zX,UX,HX,GX,VX,jX,WX,kX,qX,XX,YX,KX,$X,ZX,JX,QX,tY,eY,nY,iY,sY,oY,rY,aY,cY,lY,hY,_Y,uY,dY,pY,fY,mY,gY,vY,yY,xY,SY,TY,EY,AY,CY,bY,PY,wY,DY,IY,RY,OY,MY,NY,LY,BY;function FY(...t){return Object.assign({},...t)}!function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(pX||(pX={})),Mt(pX),t("Slider",(qq=i_("cc.Slider"),Xq=f_(),Yq=o_(110),Kq=__(),$q=s_(RO),Zq=O_(UB),Jq=y_(),Qq=O_(pX),tX=y_(),eX=x_(),nX=y_(),iX=O_([ob]),sX=y_(),qq(oX=Xq(oX=Yq(oX=Kq(oX=$q((uX=_X=class extends Ad{constructor(...t){super(...t),Xh(this,"slideEvents",aX,this),Xh(this,"_handle",cX,this),Xh(this,"_direction",lX,this),Xh(this,"_progress",hX,this),this._offset=new $e,this._dragging=!1,this._touchHandle=!1,this._handleLocalPos=new $e,this._touchPos=new $e}get handle(){return this._handle}set handle(t){this._handle!==t&&(this._handle=t)}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t,this._changeLayout())}get progress(){return this._progress}set progress(t){this._progress!==t&&(this._progress=t,this._updateHandlePosition())}__preload(){this._updateHandlePosition()}onEnable(){this._updateHandlePosition(),this.node.on(Mp.TOUCH_START,this._onTouchBegan,this),this.node.on(Mp.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(Mp.TOUCH_END,this._onTouchEnded,this),this.node.on(Mp.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(Mp.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(Mp.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(Mp.TOUCH_END,this._onTouchEnded,this))}onDisable(){this.node.off(Mp.TOUCH_START,this._onTouchBegan,this),this.node.off(Mp.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(Mp.TOUCH_END,this._onTouchEnded,this),this.node.off(Mp.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(Mp.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(Mp.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(Mp.TOUCH_END,this._onTouchEnded,this))}_onHandleDragStart(t){if(!t||!this._handle||!this._handle.node._uiProps.uiTransformComp)return;this._dragging=!0,this._touchHandle=!0;const e=t.touch.getUILocation();$e.set(this._touchPos,e.x,e.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),t.propagationStopped=!0}_onTouchBegan(t){this._handle&&t&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(t.touch),t.propagationStopped=!0)}_onTouchMoved(t){this._dragging&&t&&(this._handleSliderLogic(t.touch),t.propagationStopped=!0)}_onTouchEnded(t){this._dragging=!1,this._touchHandle=!1,this._offset=new $e,t&&(t.propagationStopped=!0)}_onTouchCancelled(t){this._dragging=!1,t&&(t.propagationStopped=!0)}_handleSliderLogic(t){this._updateProgress(t),this._emitSlideEvent()}_emitSlideEvent(){ob.emitEvents(this.slideEvents,this),this.node.emit("slide",this)}_updateProgress(t){if(!this._handle||!t)return;const e=t.getUILocation();$e.set(this._touchPos,e.x,e.y,0);const n=this.node._uiProps.uiTransformComp,i=n.convertToNodeSpaceAR(this._touchPos,dX);this.direction===pX.Horizontal?this.progress=Ie(.5+(i.x-this._offset.x)/n.width):this.progress=Ie(.5+(i.y-this._offset.y)/n.height)}_updateHandlePosition(){if(!this._handle)return;this._handleLocalPos.set(this._handle.node.getPosition());const t=this.node._uiProps.uiTransformComp;this._direction===pX.Horizontal?this._handleLocalPos.x=-t.width*t.anchorX+this.progress*t.width:this._handleLocalPos.y=-t.height*t.anchorY+this.progress*t.height,this._handle.node.setPosition(this._handleLocalPos)}_changeLayout(){const t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(t.setContentSize(e.height,e.width),this._handle){const t=this._handle.node.position;this._direction===pX.Horizontal?this._handle.node.setPosition(t.x,0,t.z):this._handle.node.setPosition(0,t.y,t.z),this._updateHandlePosition()}}},_X.Direction=pX,Yh((rX=uX).prototype,"handle",[Zq,Jq],Object.getOwnPropertyDescriptor(rX.prototype,"handle"),rX.prototype),Yh(rX.prototype,"direction",[Qq,tX],Object.getOwnPropertyDescriptor(rX.prototype,"direction"),rX.prototype),Yh(rX.prototype,"progress",[A_,eX,nX],Object.getOwnPropertyDescriptor(rX.prototype,"progress"),rX.prototype),aX=Yh(rX.prototype,"slideEvents",[iX,c_,sX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cX=Yh(rX.prototype,"_handle",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lX=Yh(rX.prototype,"_direction",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pX.Horizontal}}),hX=Yh(rX.prototype,"_progress",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),oX=rX))||oX)||oX)||oX)||oX)||oX)),function(t){t.TOGGLE="toggle"}(NX||(NX={})),t("Toggle",(fX=i_("cc.Toggle"),mX=f_(),gX=o_(110),vX=__(),yX=s_(RO),xX=C_(),SX=y_(),TX=O_(UB),EX=C_(),AX=y_(),CX=O_([ob]),bX=y_(),fX(PX=mX(PX=gX(PX=vX(PX=yX((MX=OX=class t extends EV{constructor(...t){super(...t),Xh(this,"checkEvents",DX,this),Xh(this,"_isChecked",IX,this),Xh(this,"_checkMark",RX,this)}get isChecked(){return this._isChecked}set isChecked(t){this._set(t)}get checkMark(){return this._checkMark}set checkMark(t){this._checkMark!==t&&(this._checkMark=t)}set _resizeToTarget(t){t&&this._resizeNodeToTargetNode()}get _toggleContainer(){const t=this.node.parent;return i.Node.isNode(t)?t.getComponent("cc.ToggleContainer"):null}_internalToggle(){this.isChecked=!this.isChecked}_set(t,e=!0){if(this._isChecked==t)return;this._isChecked=t;const n=this._toggleContainer;n&&n.enabled&&this.enabled&&(t||!n.anyTogglesChecked()&&!n.allowSwitchOff)&&(this._isChecked=!0,n.notifyToggleCheck(this,e)),this.playEffect(),e&&this._emitToggleEvents()}playEffect(){this._checkMark&&(this._checkMark.node.active=this._isChecked)}setIsCheckedWithoutNotify(t){this._set(t,!1)}onEnable(){super.onEnable(),this.playEffect(),this.node.on(t.EventType.CLICK,this._internalToggle,this)}onDisable(){super.onDisable(),this.node.off(t.EventType.CLICK,this._internalToggle,this)}OnDestroy(){const t=this._toggleContainer;t&&t.ensureValidState()}_emitToggleEvents(){this.node.emit(t.EventType.TOGGLE,this),this.checkEvents&&ob.emitEvents(this.checkEvents,this)}},OX.EventType=FY(NX,yV),Yh((wX=MX).prototype,"isChecked",[xX,SX],Object.getOwnPropertyDescriptor(wX.prototype,"isChecked"),wX.prototype),Yh(wX.prototype,"checkMark",[TX,EX,AX],Object.getOwnPropertyDescriptor(wX.prototype,"checkMark"),wX.prototype),DX=Yh(wX.prototype,"checkEvents",[CX,c_,bX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),IX=Yh(wX.prototype,"_isChecked",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),RX=Yh(wX.prototype,"_checkMark",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),PX=wX))||PX)||PX)||PX)||PX)||PX)),t("ToggleContainer",(LX=i_("cc.ToggleContainer"),BX=f_(),FX=o_(110),zX=__(),UX=y_(),HX=O_([ob]),GX=y_(),LX(VX=BX(VX=FX(VX=zX(VX=h_((WX=Yh((jX=class extends Ad{constructor(...t){super(...t),Xh(this,"_allowSwitchOff",WX,this),Xh(this,"checkEvents",kX,this)}get allowSwitchOff(){return this._allowSwitchOff}set allowSwitchOff(t){this._allowSwitchOff=t}get toggleItems(){return this.node.children.map((t=>{const e=t.getComponent("cc.Toggle");return e&&e.enabled?e:null})).filter(Boolean)}onEnable(){this.ensureValidState(),this.node.on(Mp.CHILD_ADDED,this.ensureValidState,this),this.node.on(Mp.CHILD_REMOVED,this.ensureValidState,this)}onDisable(){this.node.off(Mp.CHILD_ADDED,this.ensureValidState,this),this.node.off(Mp.CHILD_REMOVED,this.ensureValidState,this)}activeToggles(){return this.toggleItems.filter((t=>t.isChecked))}anyTogglesChecked(){return!!this.toggleItems.find((t=>t.isChecked))}notifyToggleCheck(t,e=!0){if(this.enabledInHierarchy){for(let n=0;n<this.toggleItems.length;n++){const i=this.toggleItems[n];i!==t&&(e?i.isChecked=!1:i.setIsCheckedWithoutNotify(!1))}this.checkEvents&&i.Component.EventHandler.emitEvents(this.checkEvents,t)}}ensureValidState(){const t=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==t.length){const e=t[0];e.isChecked=!0,this.notifyToggleCheck(e)}const e=this.activeToggles();if(e.length>1){const t=e[0];for(let n=0;n<e.length;++n){const i=e[n];i!==t&&(i.isChecked=!1)}}}}).prototype,"_allowSwitchOff",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Yh(jX.prototype,"allowSwitchOff",[UX],Object.getOwnPropertyDescriptor(jX.prototype,"allowSwitchOff"),jX.prototype),kX=Yh(jX.prototype,"checkEvents",[HX,c_,GX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),VX=jX))||VX)||VX)||VX)||VX)||VX));const zY=new qe;function UY(t){return t instanceof ZE?Op:t._uiProps.uiTransformComp?t._uiProps.uiTransformComp.contentSize:yn.ZERO}function HY(t,e,n,i){t.parent?zY.set(t.parent.getScale().x,t.parent.getScale().y):zY.set(0,0);let s=zY.x,o=zY.y,r=0,a=0;for(let c=t.parent;;){if(!c)return n.x=n.y=0,void(i.x=i.y=1);const t=c.getPosition();if(r+=t.x,a+=t.y,c=c.parent,c===e)break;{c?zY.set(c.getScale().x,c.getScale().y):zY.set(0,0);const t=zY.x,e=zY.y;r*=t,a*=e,s*=t,o*=e}}i.x=0!==s?1/s:1,i.y=0!==o?1/o:1,n.x=-r,n.y=-a}let GY,VY;!function(t){t[t.ONCE=0]="ONCE",t[t.ALWAYS=1]="ALWAYS",t[t.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(GY||(GY={})),Mt(GY),function(t){t[t.TOP=1]="TOP",t[t.MID=2]="MID",t[t.BOT=4]="BOT",t[t.LEFT=8]="LEFT",t[t.CENTER=16]="CENTER",t[t.RIGHT=32]="RIGHT",t[t.HORIZONTAL=56]="HORIZONTAL",t[t.VERTICAL=7]="VERTICAL"}(VY||(VY={}));const jY=VY.TOP|VY.BOT,WY=VY.LEFT|VY.RIGHT;let kY=t("Widget",(qX=i_("cc.Widget"),XX=f_(),YX=o_(110),KX=__(),$X=s_(RO),ZX=O_(ey),JX=y_(),QX=y_(),tY=y_(),eY=y_(),nY=y_(),iY=y_(),sY=y_(),oY=g_(),rY=g_(),aY=y_(),cY=y_(),lY=y_(),hY=y_(),_Y=y_(),uY=y_(),dY=O_(GY),pY=y_(),qX(fY=XX(fY=YX(fY=KX(fY=$X(fY=h_((BY=LY=class extends Ad{constructor(...t){super(...t),this._lastPos=new $e,this._lastSize=new yn,this._dirty=!0,this._hadAlignOnce=!1,Xh(this,"_alignFlags",gY,this),Xh(this,"_target",vY,this),Xh(this,"_left",yY,this),Xh(this,"_right",xY,this),Xh(this,"_top",SY,this),Xh(this,"_bottom",TY,this),Xh(this,"_horizontalCenter",EY,this),Xh(this,"_verticalCenter",AY,this),Xh(this,"_isAbsLeft",CY,this),Xh(this,"_isAbsRight",bY,this),Xh(this,"_isAbsTop",PY,this),Xh(this,"_isAbsBottom",wY,this),Xh(this,"_isAbsHorizontalCenter",DY,this),Xh(this,"_isAbsVerticalCenter",IY,this),Xh(this,"_originalWidth",RY,this),Xh(this,"_originalHeight",OY,this),Xh(this,"_alignMode",MY,this),Xh(this,"_lockFlags",NY,this)}get target(){return this._target}set target(t){this._target!==t&&(this._unregisterTargetEvents(),this._target=t,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}get isAlignTop(){return(this._alignFlags&VY.TOP)>0}set isAlignTop(t){this._setAlign(VY.TOP,t),this._recursiveDirty()}get isAlignBottom(){return(this._alignFlags&VY.BOT)>0}set isAlignBottom(t){this._setAlign(VY.BOT,t),this._recursiveDirty()}get isAlignLeft(){return(this._alignFlags&VY.LEFT)>0}set isAlignLeft(t){this._setAlign(VY.LEFT,t),this._recursiveDirty()}get isAlignRight(){return(this._alignFlags&VY.RIGHT)>0}set isAlignRight(t){this._setAlign(VY.RIGHT,t),this._recursiveDirty()}get isAlignVerticalCenter(){return(this._alignFlags&VY.MID)>0}set isAlignVerticalCenter(t){t?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=VY.MID):this._alignFlags&=~VY.MID,this._recursiveDirty()}get isAlignHorizontalCenter(){return(this._alignFlags&VY.CENTER)>0}set isAlignHorizontalCenter(t){t?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=VY.CENTER):this._alignFlags&=~VY.CENTER,this._recursiveDirty()}get isStretchWidth(){return(this._alignFlags&WY)===WY}get isStretchHeight(){return(this._alignFlags&jY)===jY}get top(){return this._top}set top(t){this._top=t,this._recursiveDirty()}get editorTop(){return this._isAbsTop?this._top:100*this._top}set editorTop(t){this._top=this._isAbsTop?t:t/100,this._recursiveDirty()}get bottom(){return this._bottom}set bottom(t){this._bottom=t,this._recursiveDirty()}get editorBottom(){return this._isAbsBottom?this._bottom:100*this._bottom}set editorBottom(t){this._bottom=this._isAbsBottom?t:t/100,this._recursiveDirty()}get left(){return this._left}set left(t){this._left=t,this._recursiveDirty()}get editorLeft(){return this._isAbsLeft?this._left:100*this._left}set editorLeft(t){this._left=this._isAbsLeft?t:t/100,this._recursiveDirty()}get right(){return this._right}set right(t){this._right=t,this._recursiveDirty()}get editorRight(){return this._isAbsRight?this._right:100*this._right}set editorRight(t){this._right=this._isAbsRight?t:t/100,this._recursiveDirty()}get horizontalCenter(){return this._horizontalCenter}set horizontalCenter(t){this._horizontalCenter=t,this._recursiveDirty()}get editorHorizontalCenter(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter}set editorHorizontalCenter(t){this._horizontalCenter=this._isAbsHorizontalCenter?t:t/100,this._recursiveDirty()}get verticalCenter(){return this._verticalCenter}set verticalCenter(t){this._verticalCenter=t,this._recursiveDirty()}get editorVerticalCenter(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter}set editorVerticalCenter(t){this._verticalCenter=this._isAbsVerticalCenter?t:t/100,this._recursiveDirty()}get isAbsoluteTop(){return this._isAbsTop}set isAbsoluteTop(t){this._isAbsTop!==t&&(this._isAbsTop=t,this._autoChangedValue(VY.TOP,this._isAbsTop))}get isAbsoluteBottom(){return this._isAbsBottom}set isAbsoluteBottom(t){this._isAbsBottom!==t&&(this._isAbsBottom=t,this._autoChangedValue(VY.BOT,this._isAbsBottom))}get isAbsoluteLeft(){return this._isAbsLeft}set isAbsoluteLeft(t){this._isAbsLeft!==t&&(this._isAbsLeft=t,this._autoChangedValue(VY.LEFT,this._isAbsLeft))}get isAbsoluteRight(){return this._isAbsRight}set isAbsoluteRight(t){this._isAbsRight!==t&&(this._isAbsRight=t,this._autoChangedValue(VY.RIGHT,this._isAbsRight))}get isAbsoluteHorizontalCenter(){return this._isAbsHorizontalCenter}set isAbsoluteHorizontalCenter(t){this._isAbsHorizontalCenter!==t&&(this._isAbsHorizontalCenter=t,this._autoChangedValue(VY.CENTER,this._isAbsHorizontalCenter))}get isAbsoluteVerticalCenter(){return this._isAbsVerticalCenter}set isAbsoluteVerticalCenter(t){this._isAbsVerticalCenter!==t&&(this._isAbsVerticalCenter=t,this._autoChangedValue(VY.MID,this._isAbsVerticalCenter))}get alignMode(){return this._alignMode}set alignMode(t){this._alignMode=t,this._recursiveDirty()}get alignFlags(){return this._alignFlags}set alignFlags(t){this._alignFlags!==t&&(this._alignFlags=t,this._recursiveDirty())}updateAlignment(){i._widgetManager.updateAlignment(this.node)}_validateTargetInDEV(){}setDirty(){this._recursiveDirty()}onEnable(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),i._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()}onDisable(){i._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()}onDestroy(){this._removeParentEvent()}_adjustWidgetToAllowMovingInEditor(t){}_adjustWidgetToAllowResizingInEditor(){}_adjustWidgetToAnchorChanged(){this.setDirty()}_adjustTargetToParentChanged(t){t&&this._unregisterOldParentEvents(t),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()}_registerEvent(){this.node.on(Mp.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.on(Mp.SIZE_CHANGED,this._setDirtyByMode,this),this.node.on(Mp.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(Mp.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}_unregisterEvent(){this.node.off(Mp.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.off(Mp.SIZE_CHANGED,this._setDirtyByMode,this),this.node.off(Mp.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)}_removeParentEvent(){this.node.off(Mp.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}_autoChangedValue(t,e){if(!((this._alignFlags&t)>0))return;const n=this.node.parent&&this.node.parent._uiProps,i=n&&n.uiTransformComp,s=i?i.contentSize:Op;this.isAlignLeft&&t===VY.LEFT?this._left=e?this._left*s.width:this._left/s.width:this.isAlignRight&&t===VY.RIGHT?this._right=e?this._right*s.width:this._right/s.width:this.isAlignHorizontalCenter&&t===VY.CENTER?this._horizontalCenter=e?this._horizontalCenter*s.width:this._horizontalCenter/s.width:this.isAlignTop&&t===VY.TOP?this._top=e?this._top*s.height:this._top/s.height:this.isAlignBottom&&t===VY.BOT?this._bottom=e?this._bottom*s.height:this._bottom/s.height:this.isAbsoluteVerticalCenter&&t===VY.MID&&(this._verticalCenter=this._verticalCenter/s.height),this._recursiveDirty()}_registerTargetEvents(){const t=this._target||this.node.parent;t&&t.getComponent(RO)&&(t.on(Mp.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.on(Mp.SIZE_CHANGED,this._setDirtyByMode,this))}_unregisterTargetEvents(){const t=this._target||this.node.parent;t&&(t.off(Mp.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.off(Mp.SIZE_CHANGED,this._setDirtyByMode,this))}_unregisterOldParentEvents(t){const e=this._target||t;e&&(e.off(Mp.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off(Mp.SIZE_CHANGED,this._setDirtyByMode,this))}_setDirtyByMode(){this.alignMode===GY.ALWAYS&&this._recursiveDirty()}_setAlign(t,e){if(e===(this._alignFlags&t)>0)return;const n=(t&WY)>0,i=this.node._uiProps.uiTransformComp;e?(this._alignFlags|=t,n?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=i.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=i.height))):(n?this.isStretchWidth&&(i.width=this._originalWidth):this.isStretchHeight&&(i.height=this._originalHeight),this._alignFlags&=~t)}_recursiveDirty(){this._dirty||(this._dirty=!0)}},LY.AlignMode=GY,Yh((mY=BY).prototype,"target",[ZX,JX],Object.getOwnPropertyDescriptor(mY.prototype,"target"),mY.prototype),Yh(mY.prototype,"isAlignTop",[QX],Object.getOwnPropertyDescriptor(mY.prototype,"isAlignTop"),mY.prototype),Yh(mY.prototype,"isAlignBottom",[tY],Object.getOwnPropertyDescriptor(mY.prototype,"isAlignBottom"),mY.prototype),Yh(mY.prototype,"isAlignLeft",[eY],Object.getOwnPropertyDescriptor(mY.prototype,"isAlignLeft"),mY.prototype),Yh(mY.prototype,"isAlignRight",[nY],Object.getOwnPropertyDescriptor(mY.prototype,"isAlignRight"),mY.prototype),Yh(mY.prototype,"isAlignVerticalCenter",[iY],Object.getOwnPropertyDescriptor(mY.prototype,"isAlignVerticalCenter"),mY.prototype),Yh(mY.prototype,"isAlignHorizontalCenter",[sY],Object.getOwnPropertyDescriptor(mY.prototype,"isAlignHorizontalCenter"),mY.prototype),Yh(mY.prototype,"isStretchWidth",[oY],Object.getOwnPropertyDescriptor(mY.prototype,"isStretchWidth"),mY.prototype),Yh(mY.prototype,"isStretchHeight",[rY],Object.getOwnPropertyDescriptor(mY.prototype,"isStretchHeight"),mY.prototype),Yh(mY.prototype,"top",[aY],Object.getOwnPropertyDescriptor(mY.prototype,"top"),mY.prototype),Yh(mY.prototype,"editorTop",[m_],Object.getOwnPropertyDescriptor(mY.prototype,"editorTop"),mY.prototype),Yh(mY.prototype,"bottom",[cY],Object.getOwnPropertyDescriptor(mY.prototype,"bottom"),mY.prototype),Yh(mY.prototype,"editorBottom",[m_],Object.getOwnPropertyDescriptor(mY.prototype,"editorBottom"),mY.prototype),Yh(mY.prototype,"left",[lY],Object.getOwnPropertyDescriptor(mY.prototype,"left"),mY.prototype),Yh(mY.prototype,"editorLeft",[m_],Object.getOwnPropertyDescriptor(mY.prototype,"editorLeft"),mY.prototype),Yh(mY.prototype,"right",[hY],Object.getOwnPropertyDescriptor(mY.prototype,"right"),mY.prototype),Yh(mY.prototype,"editorRight",[m_],Object.getOwnPropertyDescriptor(mY.prototype,"editorRight"),mY.prototype),Yh(mY.prototype,"horizontalCenter",[_Y],Object.getOwnPropertyDescriptor(mY.prototype,"horizontalCenter"),mY.prototype),Yh(mY.prototype,"editorHorizontalCenter",[m_],Object.getOwnPropertyDescriptor(mY.prototype,"editorHorizontalCenter"),mY.prototype),Yh(mY.prototype,"verticalCenter",[uY],Object.getOwnPropertyDescriptor(mY.prototype,"verticalCenter"),mY.prototype),Yh(mY.prototype,"editorVerticalCenter",[m_],Object.getOwnPropertyDescriptor(mY.prototype,"editorVerticalCenter"),mY.prototype),Yh(mY.prototype,"isAbsoluteTop",[m_],Object.getOwnPropertyDescriptor(mY.prototype,"isAbsoluteTop"),mY.prototype),Yh(mY.prototype,"isAbsoluteBottom",[m_],Object.getOwnPropertyDescriptor(mY.prototype,"isAbsoluteBottom"),mY.prototype),Yh(mY.prototype,"isAbsoluteLeft",[m_],Object.getOwnPropertyDescriptor(mY.prototype,"isAbsoluteLeft"),mY.prototype),Yh(mY.prototype,"isAbsoluteRight",[m_],Object.getOwnPropertyDescriptor(mY.prototype,"isAbsoluteRight"),mY.prototype),Yh(mY.prototype,"isAbsoluteHorizontalCenter",[m_],Object.getOwnPropertyDescriptor(mY.prototype,"isAbsoluteHorizontalCenter"),mY.prototype),Yh(mY.prototype,"isAbsoluteVerticalCenter",[m_],Object.getOwnPropertyDescriptor(mY.prototype,"isAbsoluteVerticalCenter"),mY.prototype),Yh(mY.prototype,"alignMode",[dY,pY],Object.getOwnPropertyDescriptor(mY.prototype,"alignMode"),mY.prototype),Yh(mY.prototype,"alignFlags",[m_],Object.getOwnPropertyDescriptor(mY.prototype,"alignFlags"),mY.prototype),gY=Yh(mY.prototype,"_alignFlags",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vY=Yh(mY.prototype,"_target",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yY=Yh(mY.prototype,"_left",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xY=Yh(mY.prototype,"_right",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),SY=Yh(mY.prototype,"_top",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),TY=Yh(mY.prototype,"_bottom",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),EY=Yh(mY.prototype,"_horizontalCenter",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),AY=Yh(mY.prototype,"_verticalCenter",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),CY=Yh(mY.prototype,"_isAbsLeft",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),bY=Yh(mY.prototype,"_isAbsRight",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),PY=Yh(mY.prototype,"_isAbsTop",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),wY=Yh(mY.prototype,"_isAbsBottom",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),DY=Yh(mY.prototype,"_isAbsHorizontalCenter",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),IY=Yh(mY.prototype,"_isAbsVerticalCenter",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),RY=Yh(mY.prototype,"_originalWidth",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),OY=Yh(mY.prototype,"_originalHeight",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),MY=Yh(mY.prototype,"_alignMode",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return GY.ON_WINDOW_RESIZE}}),NY=Yh(mY.prototype,"_lockFlags",[c_,l_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fY=mY))||fY)||fY)||fY)||fY)||fY)||fY));var qY,XY,YY,KY,$Y,ZY,JY,QY,tK,eK,nK,iK,sK,oK,rK,aK,cK,lK,hK;i.internal.computeInverseTransForTarget=HY,i.internal.getReadonlyNodeSize=UY;const _K=new An;var uK;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(uK||(uK={})),Mt(uK);let dK=t("PageViewIndicator",(qY=i_("cc.PageViewIndicator"),XY=f_(),YY=o_(110),KY=__(),$Y=O_(hR),ZY=y_(),JY=O_(uK),QY=y_(),tK=O_(yn),eK=y_(),nK=y_(),qY(iK=XY(iK=YY(iK=KY((hK=lK=class extends Ad{constructor(...t){super(...t),Xh(this,"spacing",oK,this),Xh(this,"_spriteFrame",rK,this),Xh(this,"_direction",aK,this),Xh(this,"_cellSize",cK,this),this._layout=null,this._pageView=null,this._indicators=[]}get spriteFrame(){return this._spriteFrame}set spriteFrame(t){this._spriteFrame!==t&&(this._spriteFrame=t)}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t)}get cellSize(){return this._cellSize}set cellSize(t){this._cellSize!==t&&(this._cellSize=t)}onLoad(){this._updateLayout()}setPageView(t){this._pageView=t,this._refresh()}_updateLayout(){this._layout=this.getComponent(UW),this._layout||(this._layout=this.addComponent(UW));const t=this._layout;this.direction===uK.HORIZONTAL?(t.type=UW.Type.HORIZONTAL,t.spacingX=this.spacing):this.direction===uK.VERTICAL&&(t.type=UW.Type.VERTICAL,t.spacingY=this.spacing),t.resizeMode=UW.ResizeMode.CONTAINER}_createIndicator(){const t=new ey;t.layer=this.node.layer;const e=t.addComponent(UB);return e.spriteFrame=this.spriteFrame,e.sizeMode=UB.SizeMode.CUSTOM,t.parent=this.node,t._uiProps.uiTransformComp.setContentSize(this._cellSize),t}_changedState(){const t=this._indicators;if(0===t.length||!this._pageView)return;const e=this._pageView.curPageIdx;if(!(e>=t.length)){for(let e=0;e<t.length;++e){const n=t[e];if(!n._uiProps.uiComp)continue;const i=n._uiProps.uiComp;_K.set(i.color),_K.a=127.5,i.color=_K}if(t[e]._uiProps.uiComp){const n=t[e]._uiProps.uiComp;_K.set(n.color),_K.a=255,n.color=_K}}}_refresh(){if(!this._pageView)return;const t=this._indicators,e=this._pageView.getPages();if(e.length===t.length)return;let n=0;if(e.length>t.length)for(n=0;n<e.length;++n)t[n]||(t[n]=this._createIndicator());else for(n=t.length-e.length;n>0;--n){const e=t[n-1];this.node.removeChild(e),t.splice(n-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}},lK.Direction=uK,Yh((sK=hK).prototype,"spriteFrame",[$Y,ZY],Object.getOwnPropertyDescriptor(sK.prototype,"spriteFrame"),sK.prototype),Yh(sK.prototype,"direction",[JY,QY],Object.getOwnPropertyDescriptor(sK.prototype,"direction"),sK.prototype),Yh(sK.prototype,"cellSize",[tK,eK],Object.getOwnPropertyDescriptor(sK.prototype,"cellSize"),sK.prototype),oK=Yh(sK.prototype,"spacing",[c_,nK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rK=Yh(sK.prototype,"_spriteFrame",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aK=Yh(sK.prototype,"_direction",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uK.HORIZONTAL}}),cK=Yh(sK.prototype,"_cellSize",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn(20,20)}}),iK=sK))||iK)||iK)||iK)||iK));var pK,fK,mK,gK,vK,yK,xK,SK,TK,EK,AK,CK,bK,PK,wK,DK,IK,RK,OK,MK,NK,LK,BK,FK,zK,UK,HK,GK,VK,jK,WK,kK,qK,XK,YK,KK,$K,ZK,JK,QK,t$,e$;const n$=new qe;var i$,s$,o$;!function(t){t[t.Unified=0]="Unified",t[t.Free=1]="Free"}(i$||(i$={})),Mt(i$),function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(s$||(s$={})),Mt(s$),function(t){t.PAGE_TURNING="page-turning"}(o$||(o$={})),t("PageView",(pK=i_("cc.PageView"),fK=f_(),mK=o_(110),gK=__(),vK=O_(i$),yK=y_(),xK=O_(s$),SK=y_(),TK=x_(),EK=y_(),AK=x_(),CK=y_(),bK=O_(dK),PK=y_(),wK=y_(),DK=O_(Hk),IK=g_(),RK=O_(Hk),OK=g_(),MK=g_(),NK=g_(),LK=g_(),BK=O_([ob]),FK=g_(),zK=O_([ob]),UK=y_(),pK(HK=fK(HK=mK(HK=gK((e$=t$=class t extends kq{constructor(...t){super(...t),Xh(this,"autoPageTurningThreshold",VK,this),Xh(this,"horizontal",jK,this),Xh(this,"vertical",WK,this),Xh(this,"cancelInnerEvents",kK,this),Xh(this,"scrollEvents",qK,this),Xh(this,"pageTurningSpeed",XK,this),Xh(this,"pageEvents",YK,this),Xh(this,"_sizeMode",KK,this),Xh(this,"_direction",$K,this),Xh(this,"_scrollThreshold",ZK,this),Xh(this,"_pageTurningEventTiming",JK,this),Xh(this,"_indicator",QK,this),this._curPageIdx=0,this._lastPageIdx=0,this._pages=[],this._initContentPos=new $e,this._scrollCenterOffsetX=[],this._scrollCenterOffsetY=[],this._touchBeganPosition=new qe,this._touchEndPosition=new qe}get sizeMode(){return this._sizeMode}set sizeMode(t){this._sizeMode!==t&&(this._sizeMode=t,this._syncSizeMode())}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t,this._syncScrollDirection())}get scrollThreshold(){return this._scrollThreshold}set scrollThreshold(t){this._scrollThreshold!==t&&(this._scrollThreshold=t)}get pageTurningEventTiming(){return this._pageTurningEventTiming}set pageTurningEventTiming(t){this._pageTurningEventTiming!==t&&(this._pageTurningEventTiming=t)}get indicator(){return this._indicator}set indicator(t){this._indicator!==t&&(this._indicator=t,this.indicator&&this.indicator.setPageView(this))}get curPageIdx(){return this._curPageIdx}get verticalScrollBar(){return super.verticalScrollBar}set verticalScrollBar(t){super.verticalScrollBar=t}get horizontalScrollBar(){return super.horizontalScrollBar}set horizontalScrollBar(t){super.horizontalScrollBar=t}onEnable(){super.onEnable(),this.node.on(Mp.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}onDisable(){super.onDisable(),this.node.off(Mp.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}onLoad(){this._initPages(),this.indicator&&this.indicator.setPageView(this)}getCurrentPageIndex(){return this._curPageIdx}setCurrentPageIndex(t){this.scrollToPage(t,1)}getPages(){return this._pages}addPage(t){t&&-1===this._pages.indexOf(t)&&this.content&&(t._uiProps.uiTransformComp?(this.content.addChild(t),this._pages.push(t),this._updatePageView()):S(4301))}insertPage(t,e){if(!(e<0)&&t&&-1===this._pages.indexOf(t)&&this.content)if(e>=this._pages.length)this.addPage(t);else{if(!t._uiProps.uiTransformComp)return void S(4301);this._pages.splice(e,0,t),this.content.insertChild(t,e),this._updatePageView()}}removePage(t){if(!t||!this.content)return;const e=this._pages.indexOf(t);-1!==e?this.removePageAtIndex(e):E(4300,t.name)}removePageAtIndex(t){const e=this._pages;if(t<0||t>=e.length)return;const n=e[t];n&&this.content&&(this.content.removeChild(n),e.splice(t,1),this._updatePageView())}removeAllPages(){if(!this.content)return;const t=this._pages;for(let e=0,n=t.length;e<n;e++)this.content.removeChild(t[e]);this._pages.length=0,this._updatePageView()}scrollToPage(t,e=.3){t<0||t>=this._pages.length||(this._curPageIdx=t,this.scrollToOffset(this._moveOffsetValue(t),e,!0),this.indicator&&this.indicator._changedState())}getScrollEndedEventTiming(){return this.pageTurningEventTiming}_updatePageView(){if(!this.content)return;const t=this.content.getComponent(UW);t&&t.enabled&&t.updateLayout();const e=this._pages.length;this._curPageIdx>=e&&(this._curPageIdx=0===e?0:e-1,this._lastPageIdx=this._curPageIdx);const n=this._initContentPos;for(let t=0;t<e;++t){const e=this._pages[t].position;this.direction===s$.Horizontal?this._scrollCenterOffsetX[t]=Math.abs(n.x+e.x):this._scrollCenterOffsetY[t]=Math.abs(n.y+e.y)}this.indicator&&this.indicator._refresh()}_updateAllPagesSize(){const t=this.view;if(!this.content||!t)return;if(this._sizeMode!==i$.Unified)return;const e=this._pages,n=t.contentSize;for(let t=0,i=e.length;t<i;t++)e[t]._uiProps.uiTransformComp.setContentSize(n)}_handleReleaseLogic(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(t.EventType.SCROLL_ENDED))}_onTouchBegan(t,e){t.touch.getUILocation(n$),qe.set(this._touchBeganPosition,n$.x,n$.y),super._onTouchBegan(t,e)}_onTouchMoved(t,e){super._onTouchMoved(t,e)}_onTouchEnded(t,e){t.touch.getUILocation(n$),qe.set(this._touchEndPosition,n$.x,n$.y),super._onTouchEnded(t,e)}_onTouchCancelled(t,e){t.touch.getUILocation(n$),qe.set(this._touchEndPosition,n$.x,n$.y),super._onTouchCancelled(t,e)}_onMouseWheel(){}_syncScrollDirection(){this.horizontal=this.direction===s$.Horizontal,this.vertical=this.direction===s$.Vertical}_syncSizeMode(){const t=this.view;if(!this.content||!t)return;const e=this.content.getComponent(UW);if(e){if(this._sizeMode===i$.Free&&this._pages.length>0){const n=this._pages[0]._uiProps.uiTransformComp,i=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===s$.Horizontal?(e.paddingLeft=(t.width-n.width)/2,e.paddingRight=(t.width-i.width)/2):this.direction===s$.Vertical&&(e.paddingTop=(t.height-n.height)/2,e.paddingBottom=(t.height-i.height)/2)}e.updateLayout()}}_initPages(){if(!this.content)return;this._initContentPos=this.content.position;const t=this.content.children;for(let e=0;e<t.length;++e){const n=t[e];this._pages.indexOf(n)>=0||this._pages.push(n)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}_dispatchPageTurningEvent(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,ob.emitEvents(this.pageEvents,this,o$.PAGE_TURNING),this.node.emit(o$.PAGE_TURNING,this))}_isQuicklyScrollable(t){if(this.direction===s$.Horizontal){if(Math.abs(t.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===s$.Vertical&&Math.abs(t.y)>this.autoPageTurningThreshold)return!0;return!1}_moveOffsetValue(t){const e=new qe;if(this._sizeMode===i$.Free)this.direction===s$.Horizontal?e.x=this._scrollCenterOffsetX[t]:this.direction===s$.Vertical&&(e.y=this._scrollCenterOffsetY[t]);else{const n=this.view;if(!n)return e;this.direction===s$.Horizontal?e.x=t*n.width:this.direction===s$.Vertical&&(e.y=t*n.height)}return e}_getDragDirection(t){return this._direction===s$.Horizontal?0===t.x?0:t.x>0?1:-1:0===t.y?0:t.y<0?1:-1}_isScrollable(t,e,n){if(this._sizeMode===i$.Free){let i=0,s=0;if(this.direction===s$.Horizontal)return i=this._scrollCenterOffsetX[e],s=this._scrollCenterOffsetX[n],Math.abs(t.x)>=Math.abs(i-s)*this.scrollThreshold;if(this.direction===s$.Vertical)return i=this._scrollCenterOffsetY[e],s=this._scrollCenterOffsetY[n],Math.abs(t.y)>=Math.abs(i-s)*this.scrollThreshold}else{const e=this.view;if(!e)return!1;if(this.direction===s$.Horizontal)return Math.abs(t.x)>=e.width*this.scrollThreshold;if(this.direction===s$.Vertical)return Math.abs(t.y)>=e.height*this.scrollThreshold}return!1}_autoScrollToPage(){if(this._startBounceBackIfNeeded()){const t=this._getHowMuchOutOfBoundary();this._clampDelta(t),(t.x>0||t.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(t.x<0||t.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{const t=new qe;qe.subtract(t,this._touchBeganPosition,this._touchEndPosition);const e=this._curPageIdx,n=e+this._getDragDirection(t),i=this.pageTurningSpeed*Math.abs(e-n);if(n<this._pages.length){if(this._isScrollable(t,e,n))return void this.scrollToPage(n,i);{const t=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(t))return void this.scrollToPage(n,i)}}this.scrollToPage(e,i)}}},t$.SizeMode=i$,t$.Direction=s$,t$.EventType=FY(o$,Wq),Yh((GK=e$).prototype,"sizeMode",[vK,yK],Object.getOwnPropertyDescriptor(GK.prototype,"sizeMode"),GK.prototype),Yh(GK.prototype,"direction",[xK,SK],Object.getOwnPropertyDescriptor(GK.prototype,"direction"),GK.prototype),Yh(GK.prototype,"scrollThreshold",[A_,TK,EK],Object.getOwnPropertyDescriptor(GK.prototype,"scrollThreshold"),GK.prototype),Yh(GK.prototype,"pageTurningEventTiming",[A_,AK,CK],Object.getOwnPropertyDescriptor(GK.prototype,"pageTurningEventTiming"),GK.prototype),Yh(GK.prototype,"indicator",[bK,PK],Object.getOwnPropertyDescriptor(GK.prototype,"indicator"),GK.prototype),VK=Yh(GK.prototype,"autoPageTurningThreshold",[c_,wK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),Yh(GK.prototype,"verticalScrollBar",[DK,M_,IK],Object.getOwnPropertyDescriptor(GK.prototype,"verticalScrollBar"),GK.prototype),Yh(GK.prototype,"horizontalScrollBar",[RK,M_,OK],Object.getOwnPropertyDescriptor(GK.prototype,"horizontalScrollBar"),GK.prototype),jK=Yh(GK.prototype,"horizontal",[M_,c_,MK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),WK=Yh(GK.prototype,"vertical",[M_,c_,NK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),kK=Yh(GK.prototype,"cancelInnerEvents",[M_,c_,LK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),qK=Yh(GK.prototype,"scrollEvents",[BK,c_,M_,FK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),XK=Yh(GK.prototype,"pageTurningSpeed",[c_,m_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),YK=Yh(GK.prototype,"pageEvents",[zK,c_,UK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),KK=Yh(GK.prototype,"_sizeMode",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return i$.Unified}}),$K=Yh(GK.prototype,"_direction",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return s$.Horizontal}}),ZK=Yh(GK.prototype,"_scrollThreshold",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),JK=Yh(GK.prototype,"_pageTurningEventTiming",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),QK=Yh(GK.prototype,"_indicator",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),HK=GK))||HK)||HK)||HK)||HK));const r$=new $e,a$=new qe,c$=new qe,l$=new qe(1,1),h$=new qe,_$=new qe;function u$(t,e){if(e._hadAlignOnce)return;e.alignMode===GY.ONCE&&(e._hadAlignOnce=!0);const n=e.target;let i;const s=c$,o=l$;n?(i=n,HY(t,i,s,o)):i=t.parent;const r=UY(i),a=i instanceof ZE||!i.getComponent(RO),c=a?a$:i.getComponent(RO).anchorPoint,l=a;t.getPosition(r$);const h=t._uiProps.uiTransformComp;let _=r$.x,u=r$.y;const d=h.anchorPoint,p=t.getScale();if(e.alignFlags&VY.HORIZONTAL){let t=0,i=0;const a=r.width;l?(t=Op.left.x,i=Op.right.x):(t=-c.x*a,i=t+a),t+=e.isAbsoluteLeft?e.left:e.left*a,i-=e.isAbsoluteRight?e.right:e.right*a,n&&(t+=s.x,t*=o.x,i+=s.x,i*=o.x);let u=0,f=d.x,m=p.x;if(m<0&&(f=1-f,m=-m),e.isStretchWidth)u=i-t,0!==m&&(h.width=u/m),_=t+f*u;else if(u=h.width*m,e.isAlignHorizontalCenter){let t=e.isAbsoluteHorizontalCenter?e.horizontalCenter:e.horizontalCenter*a,i=(.5-c.x)*r.width;n&&(t*=o.x,i+=s.x,i*=o.x),_=i+(f-.5)*u+t}else _=e.isAlignLeft?t+f*u:i+(f-1)*u;e._lastSize.width=u}if(e.alignFlags&VY.VERTICAL){let t=0,i=0;const a=r.height;l?(i=Op.bottom.y,t=Op.top.y):(i=-c.y*a,t=i+a),i+=e.isAbsoluteBottom?e.bottom:e.bottom*a,t-=e.isAbsoluteTop?e.top:e.top*a,n&&(i+=s.y,i*=o.y,t+=s.y,t*=o.y);let _=0,f=d.y,m=p.y;if(m<0&&(f=1-f,m=-m),e.isStretchHeight)_=t-i,0!==m&&(h.height=_/m),u=i+f*_;else if(_=h.height*m,e.isAlignVerticalCenter){let t=e.isAbsoluteVerticalCenter?e.verticalCenter:e.verticalCenter*a,i=(.5-c.y)*r.height;n&&(t*=o.y,i+=s.y,i*=o.y),u=i+(f-.5)*_+t}else u=e.isAlignBottom?i+f*_:t+(f-1)*_;e._lastSize.height=_}t.setPosition(_,u,r$.z),$e.set(e._lastPos,_,u,r$.z)}function d$(t){const e=t.getComponent(kY);if(e&&e.enabled){if(!i.isValid(t,!0))return;f$.push(e)}const n=t.children;for(const t of n)t.active&&d$(t)}function p$(){const t=qA.getScene();if(t){m$.isAligning=!0,m$._nodesOrderDirty&&(f$.length=0,d$(t),m$._nodesOrderDirty=!1);let e=null;const n=m$._activeWidgetsIterator;for(n.i=0;n.i<f$.length;++n.i)e=f$[n.i],e._dirty&&(u$(e.node,e),e._dirty=!1);m$.isAligning=!1}}const f$=[],m$=t("widgetManager",i._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new Pt.MutableForwardIterator(f$),animationState:null,init(){qA.on(kA.EVENT_AFTER_UPDATE,p$),Em.instance.on("design-resolution-changed",this.onResized,this);{const t=this.onResized.bind(this);Em.instance.on("canvas-resize",t),Qn.onOrientationChange(t)}},add(t){this._nodesOrderDirty=!0},remove(t){this._activeWidgetsIterator.remove(t)},onResized(){const t=qA.getScene();t&&this.refreshWidgetOnResized(t)},refreshWidgetOnResized(t){const e=ey.isNode(t)&&t.getComponent(kY);e&&e.enabled&&(e.alignMode===GY.ON_WINDOW_RESIZE||e.alignMode===GY.ALWAYS)&&e.setDirty();const n=t.children;for(const t of n)this.refreshWidgetOnResized(t)},updateOffsetsToStayPut(t,e){function n(t,e){return Math.abs(t-e)>1e-10?e:t}const i=t.node;let s=i.parent;if(s){const o=h$;o.set(0,0);const r=_$;if(r.set(1,1),t.target&&(s=t.target,HY(i,s,o,r)),!e)return;const a=s._uiProps&&s._uiProps.uiTransformComp,c=a?a.anchorPoint:a$,l=i._uiProps.uiTransformComp,h=UY(s),_=l.anchorPoint,u=i.getPosition(),d=VY,p=i.getScale();let f=0;if(e&d.LEFT){let e=-c.x*h.width;e+=o.x,e*=r.x,f=u.x-_.x*l.width*p.x-e,t.isAbsoluteLeft||(f/=h.width),f/=r.x,t.left=n(t.left,f)}if(e&d.RIGHT){let e=(1-c.x)*h.width;e+=o.x,f=(e*=r.x)-(u.x+(1-_.x)*l.width*p.x),t.isAbsoluteRight||(f/=h.width),f/=r.x,t.right=n(t.right,f)}if(e&d.TOP){let e=(1-c.y)*h.height;e+=o.y,f=(e*=r.y)-(u.y+(1-_.y)*l.height*p.y),t.isAbsoluteTop||(f/=h.height),f/=r.y,t.top=n(t.top,f)}if(e&d.BOT){let e=-c.y*h.height;e+=o.y,e*=r.y,f=u.y-_.y*l.height*p.y-e,t.isAbsoluteBottom||(f/=h.height),f/=r.y,t.bottom=n(t.bottom,f)}}},updateAlignment:function t(e){const n=e.parent;n&&ey.isNode(n)&&t(n);const i=e.getComponent(kY);i&&n&&u$(e,i)},AlignMode:GY,AlignFlags:VY});var g$,v$,y$,x$,S$,T$,E$,A$,C$,b$,P$,w$,D$,I$,R$,O$,M$,N$,L$,B$,F$;qA.on(kA.EVENT_INIT,(()=>{m$.init()})),t("SafeArea",i_("cc.SafeArea")(g$=f_()(g$=o_(110)(g$=h_(g$=__()(g$=s_(kY)(g$=class extends Ad{onLoad(){this._boundUpdateArea=this.updateArea.bind(this)}onEnable(){this.updateArea(),Qn.onViewResize(this._boundUpdateArea),Qn.onOrientationChange(this._boundUpdateArea)}onDisable(){Qn.offViewResize(this._boundUpdateArea),Qn.offOrientationChange(this._boundUpdateArea)}updateArea(){const t=this.node.getComponent(kY),e=this.node.getComponent(RO);if(!t||!e)return;t.updateAlignment();const n=this.node.position.clone(),s=e.anchorPoint.clone();t.isAlignTop=t.isAlignBottom=t.isAlignLeft=t.isAlignRight=!0;const o=i.winSize.width,r=i.winSize.height,a=Rp.getSafeAreaRect();t.top=r-a.y-a.height,t.bottom=a.y,t.left=a.x,t.right=o-a.x-a.width,t.updateAlignment();const c=this.node.position.clone(),l=s.x-(c.x-n.x)/e.width,h=s.y-(c.y-n.y)/e.height;e.setAnchorPoint(l,h),m$.add(t)}})||g$)||g$)||g$)||g$)||g$)||g$),t("UICoordinateTracker",(v$=i_("cc.UICoordinateTracker"),y$=f_(),x$=__(),S$=o_(110),T$=O_(ey),E$=y_(),A$=O_(bP),C$=y_(),b$=y_(),P$=y_(),w$=O_([ob]),D$=y_(),v$(I$=y$(I$=x$(I$=S$((Yh((R$=class extends Ad{constructor(...t){super(...t),Xh(this,"syncEvents",O$,this),Xh(this,"_target",M$,this),Xh(this,"_camera",N$,this),Xh(this,"_useScale",L$,this),Xh(this,"_distance",B$,this),this._transformPos=new $e,this._viewPos=new $e,this._canMove=!0,this._lastWPos=new $e,this._lastCameraPos=new $e}get target(){return this._target}set target(t){this._target!==t&&(this._target=t,this._checkCanMove())}get camera(){return this._camera}set camera(t){this._camera!==t&&(this._camera=t,this._checkCanMove())}get useScale(){return this._useScale}set useScale(t){this._useScale!==t&&(this._useScale=t)}get distance(){return this._distance}set distance(t){this._distance!==t&&(this._distance=t)}onEnable(){this._checkCanMove()}update(){const t=this.node.worldPosition,e=this._camera;if(this._canMove&&e&&e.camera&&(!this._lastWPos.equals(t)||!this._lastCameraPos.equals(e.node.worldPosition))&&(this._lastWPos.set(t),this._lastCameraPos.set(e.node.worldPosition),e.camera.update(),e.convertToUINode(t,this._target,this._transformPos),this._useScale&&$e.transformMat4(this._viewPos,this.node.worldPosition,e.camera.matView),this.syncEvents.length>0)){const t=this._distance/Math.abs(this._viewPos.z);ob.emitEvents(this.syncEvents,this._transformPos,t)}}_checkCanMove(){this._canMove=!(!this._camera||!this._target)}}).prototype,"target",[T$,E$],Object.getOwnPropertyDescriptor(R$.prototype,"target"),R$.prototype),Yh(R$.prototype,"camera",[A$,C$],Object.getOwnPropertyDescriptor(R$.prototype,"camera"),R$.prototype),Yh(R$.prototype,"useScale",[b$],Object.getOwnPropertyDescriptor(R$.prototype,"useScale"),R$.prototype),Yh(R$.prototype,"distance",[P$],Object.getOwnPropertyDescriptor(R$.prototype,"distance"),R$.prototype),O$=Yh(R$.prototype,"syncEvents",[w$,c_,D$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),M$=Yh(R$.prototype,"_target",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),N$=Yh(R$.prototype,"_camera",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),L$=Yh(R$.prototype,"_useScale",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),B$=Yh(R$.prototype,"_distance",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),I$=R$))||I$)||I$)||I$)||I$));const z$=[Mp.TOUCH_START,Mp.TOUCH_END,Mp.TOUCH_MOVE,Mp.MOUSE_DOWN,Mp.MOUSE_MOVE,Mp.MOUSE_UP,Mp.MOUSE_ENTER,Mp.MOUSE_LEAVE,Mp.MOUSE_WHEEL];function U$(t){t.propagationStopped=!0}t("BlockInputEvents",i_("cc.BlockInputEvents")(F$=f_()(F$=__()(F$=class extends Ad{onEnable(){for(let t=0;t<z$.length;t++)this.node.on(z$[t],U$,this)}onDisable(){for(let t=0;t<z$.length;t++)this.node.off(z$[t],U$,this)}})||F$)||F$)||F$);const H$={};var G$,V$,j$,W$,k$,q$,X$,Y$,K$,$$,Z$;let J$,Q$,tZ,eZ=t("SubContextView",(G$=i_("cc.SubContextView"),V$=f_(),j$=o_(110),W$=s_(RO),k$=__(),q$=y_(),X$=y_(),G$(Y$=V$(Y$=j$(Y$=W$(Y$=k$((Yh((K$=class extends Ad{get designResolutionSize(){return this._designResolutionSize}set designResolutionSize(t){}get fps(){return this._fps}set fps(t){this._fps!==t&&(this._fps=t,this._updateInterval=1e3/t)}constructor(){super(),Xh(this,"_fps",$$,this),this._sprite=void 0,this._imageAsset=void 0,this._updatedTime=0,this._updateInterval=0,this._openDataContext=void 0,this._content=void 0,Xh(this,"_designResolutionSize",Z$,this),this._content=new ey("content"),this._content.hideFlags|=Rn.Flags.DontSave|Rn.Flags.HideInHierarchy,this._sprite=null,this._imageAsset=new xu,this._openDataContext=null,this._updatedTime=performance.now()}onLoad(){H$.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=H$.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1}onEnable(){this._registerNodeEvent()}onDisable(){this._unregisterNodeEvent()}_initSharedCanvas(){if(this._openDataContext){const t=this._openDataContext.canvas;t.width=this._designResolutionSize.width,t.height=this._designResolutionSize.height}}_initContentNode(){if(this._openDataContext){const t=this._openDataContext.canvas,e=this._imageAsset;if(e.reset(t),e._texture.create(t.width,t.height),this._sprite=this._content.getComponent(UB),this._sprite||(this._sprite=this._content.addComponent(UB)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._imageAsset._texture;else{const t=new hR;t.texture=this._imageAsset._texture,this._sprite.spriteFrame=t}this._content.parent=this.node}}_updateSubContextView(){if(!this._openDataContext||!H$.getSystemInfoSync)return;const t=this.node.getComponent(RO),e=this._content.getComponent(RO),n=t.width/e.width,i=t.height/e.height,s=n>i?i:n;e.width*=s,e.height*=s;const o=H$.getSystemInfoSync(),r=e.getBoundingBoxToWorld(),a=Pm.getVisibleSize(),c=o.screenWidth*(r.x/a.width),l=o.screenHeight*(r.y/a.height),h=o.screenWidth*(r.width/a.width),_=o.screenHeight*(r.height/a.height);this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:c,y:l,width:h,height:_})}_updateSubContextTexture(){const t=this._imageAsset;if(!t||!this._openDataContext)return;if(t.width<=0||t.height<=0)return;const e=this._openDataContext.canvas;t.reset(e),(e.width>t.width||e.height>t.height)&&this._imageAsset._texture.create(e.width,e.height),this._imageAsset._texture.uploadData(e)}_registerNodeEvent(){this.node.on(ey.EventType.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on(ey.EventType.SIZE_CHANGED,this._updateSubContextView,this),this.node.on(Mp.LAYER_CHANGED,this._updateContentLayer,this)}_unregisterNodeEvent(){this.node.off(ey.EventType.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off(ey.EventType.SIZE_CHANGED,this._updateSubContextView,this),this.node.off(Mp.LAYER_CHANGED,this._updateContentLayer,this)}_updateContentLayer(){this._content.layer=this.node.layer}update(t){void 0!==t?performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture()):this._updateSubContextTexture()}}).prototype,"designResolutionSize",[q$],Object.getOwnPropertyDescriptor(K$.prototype,"designResolutionSize"),K$.prototype),Yh(K$.prototype,"fps",[X$],Object.getOwnPropertyDescriptor(K$.prototype,"fps"),K$.prototype),$$=Yh(K$.prototype,"_fps",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),Z$=Yh(K$.prototype,"_designResolutionSize",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn(640,960)}}),Y$=K$))||Y$)||Y$)||Y$)||Y$)||Y$));i.SubContextView=eZ,function(t){t.PLAYED="play",t.PAUSED="pause",t.STOPPED="stop",t.SEEKED="seeked",t.ENDED="ended",t.INTERRUPTION_BEGIN="interruptionBegin",t.INTERRUPTION_END="interruptionEnd",t.USER_GESTURE="on_gesture"}(J$||(J$={})),function(t){t[t.DOM_AUDIO=0]="DOM_AUDIO",t[t.WEB_AUDIO=1]="WEB_AUDIO",t[t.MINIGAME_AUDIO=2]="MINIGAME_AUDIO",t[t.NATIVE_AUDIO=3]="NATIVE_AUDIO",t[t.UNKNOWN_AUDIO=4]="UNKNOWN_AUDIO"}(Q$||(Q$={})),function(t){t[t.INIT=0]="INIT",t[t.PLAYING=1]="PLAYING",t[t.PAUSED=2]="PAUSED",t[t.STOPPED=3]="STOPPED",t[t.INTERRUPTED=4]="INTERRUPTED"}(tZ||(tZ={}));let nZ=0;function iZ(t,e){e.invoking||(e.invoking=!0,e.func.call(t,...e.args).then((()=>{e.invoking=!1,t._operationQueue.shift(),t._eventTarget.emit(e.id.toString());const n=t._operationQueue[0];n&&iZ(t,n)})).catch((()=>{})))}function sZ(t,e,n){const i=n.value;n.value=function(...t){return new Promise((e=>{const n=nZ++,s=this;s._operationQueue.push({id:n,func:i,args:t,invoking:!1}),s._eventTarget.once(n.toString(),e),iZ(s,s._operationQueue[0])}))}}var oZ,rZ,aZ;const cZ={},lZ=jsb.AudioEngine,hZ=-1;class _Z{get onPlay(){return this._onPlayCb}set onPlay(t){this._onPlayCb=t}get onEnd(){return this._onEndCb}set onEnd(t){this._onEndCb=t}constructor(t,e){this._id=hZ,this._url=void 0,this._volume=void 0,this._onPlayCb=void 0,this._onEndCb=void 0,this._url=t,this._volume=e}play(){var t;this._id=jsb.AudioEngine.play2d(this._url,!1,this._volume),jsb.AudioEngine.setFinishCallback(this._id,(()=>{var t;null===(t=this.onEnd)||void 0===t||t.call(this)})),null===(t=this.onPlay)||void 0===t||t.call(this)}stop(){this._id!==hZ&&jsb.AudioEngine.stop(this._id)}}let uZ=(aZ=rZ=class t{constructor(t){this._url=void 0,this._id=hZ,this._state=tZ.INIT,this._onHide=void 0,this._onShow=void 0,this._eventTarget=new Vn,this._operationQueue=[],this._beforePlaying={duration:0,loop:!1,currentTime:0,volume:1},this._url=t,this._onHide=()=>{this._state===tZ.PLAYING&&this.pause().then((()=>{this._state=tZ.INTERRUPTED,this._eventTarget.emit(J$.INTERRUPTION_BEGIN)})).catch((()=>{}))},i.game.on(i.Game.EVENT_HIDE,this._onHide),this._onShow=()=>{this._state===tZ.INTERRUPTED&&this.play().then((()=>{this._eventTarget.emit(J$.INTERRUPTION_END)})).catch((()=>{}))},i.game.on(i.Game.EVENT_SHOW,this._onShow)}destroy(){this._onShow&&(i.game.off(i.Game.EVENT_SHOW,this._onShow),this._onShow=void 0),this._onHide&&(i.game.off(i.Game.EVENT_HIDE,this._onHide),this._onHide=void 0),--cZ[this._url]<=0&&lZ.uncache(this._url)}static load(e){return new Promise(((n,i)=>{t.loadNative(e).then((e=>{n(new t(e))})).catch((t=>i(t)))}))}static loadNative(t){return new Promise(((e,n)=>{Qn.platform===Kn.WIN32?e(t):lZ.preload(t,(i=>{i?e(t):n(new Error("load audio failed"))}))}))}static loadOneShotAudio(e,n){return new Promise(((i,s)=>{t.loadNative(e).then((t=>{i(new _Z(t,n))})).catch(s)}))}get _isValid(){return this._id!==hZ}get src(){return this._url}get type(){return Q$.NATIVE_AUDIO}get state(){return this._state}get loop(){return this._isValid?lZ.isLoop(this._id):this._beforePlaying.loop}set loop(t){this._isValid?lZ.setLoop(this._id,t):this._beforePlaying.loop=t}get volume(){return this._isValid?lZ.getVolume(this._id):this._beforePlaying.volume}set volume(t){t=Ie(t),this._isValid?lZ.setVolume(this._id,t):this._beforePlaying.volume=t}get duration(){return this._isValid?lZ.getDuration(this._id):this._beforePlaying.duration}get currentTime(){return this._isValid?lZ.getCurrentTime(this._id):this._beforePlaying.currentTime}seek(t){return new Promise((e=>(t=De(t,0,this.duration),this._isValid?(lZ.setCurrentTime(this._id,t),e()):(this._beforePlaying.currentTime=t,e()))))}play(){return new Promise((t=>{this._isValid?this._state===tZ.PAUSED?lZ.resume(this._id):this._state===tZ.PLAYING&&(lZ.pause(this._id),lZ.setCurrentTime(this._id,0),lZ.resume(this._id)):(this._id=lZ.play2d(this._url,this._beforePlaying.loop,this._beforePlaying.volume),this._isValid&&(0!==this._beforePlaying.currentTime&&lZ.setCurrentTime(this._id,this._beforePlaying.currentTime),lZ.setFinishCallback(this._id,(()=>{this._id=hZ,this._state=tZ.INIT,this._eventTarget.emit(J$.ENDED)})))),this._state=tZ.PLAYING,t()}))}pause(){return new Promise((t=>{this._isValid&&lZ.pause(this._id),this._state=tZ.PAUSED,t()}))}stop(){return new Promise((t=>{this._isValid&&lZ.stop(this._id),this._state=tZ.STOPPED,this._id=hZ,t()}))}onInterruptionBegin(t){this._eventTarget.on(J$.INTERRUPTION_BEGIN,t)}offInterruptionBegin(t){this._eventTarget.off(J$.INTERRUPTION_BEGIN,t)}onInterruptionEnd(t){this._eventTarget.on(J$.INTERRUPTION_END,t)}offInterruptionEnd(t){this._eventTarget.off(J$.INTERRUPTION_END,t)}onEnded(t){this._eventTarget.on(J$.ENDED,t)}offEnded(t){this._eventTarget.off(J$.ENDED,t)}},rZ.maxAudioChannel=lZ.getMaxAudioInstance(),Yh((oZ=aZ).prototype,"seek",[sZ],Object.getOwnPropertyDescriptor(oZ.prototype,"seek"),oZ.prototype),Yh(oZ.prototype,"play",[sZ],Object.getOwnPropertyDescriptor(oZ.prototype,"play"),oZ.prototype),Yh(oZ.prototype,"pause",[sZ],Object.getOwnPropertyDescriptor(oZ.prototype,"pause"),oZ.prototype),Yh(oZ.prototype,"stop",[sZ],Object.getOwnPropertyDescriptor(oZ.prototype,"stop"),oZ.prototype),oZ);var dZ,pZ,fZ,mZ,gZ;i.AudioPlayer=uZ;let vZ=t("AudioClip",i_("cc.AudioClip")((gZ=mZ=class extends lu{constructor(){super(),Xh(this,"_duration",fZ,this),this._loadMode=Q$.UNKNOWN_AUDIO,this._meta=null,this.loaded=!1}set _nativeAsset(t){this._meta=t,t?(this.loaded=!0,this._loadMode=t.type,this.emit("load")):(this._meta=null,this._loadMode=Q$.UNKNOWN_AUDIO,this._duration=0,this.loaded=!1)}get _nativeAsset(){return this._meta}get _nativeDep(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}get loadMode(){return this._loadMode}validate(){return!!this._meta}getDuration(){return this._duration?this._duration:this._meta?this._meta.duration:0}},mZ.AudioType=Q$,fZ=Yh((pZ=gZ).prototype,"_duration",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Yh(pZ.prototype,"_nativeDep",[M_],Object.getOwnPropertyDescriptor(pZ.prototype,"_nativeDep"),pZ.prototype),dZ=pZ))||dZ);function yZ(t,e,n){uZ.load(t,{audioLoadMode:e.audioLoadMode}).then((e=>{const i={url:t,duration:e.duration,type:e.type};e.destroy(),n(null,i)})).catch((t=>{n(t)}))}function xZ(t,e,n,i){const s=new vZ;s._nativeUrl=t,s._nativeAsset=e,s._duration=e.duration,i(null,s)}i.AudioClip=vZ,EC.register({".mp3":yZ,".ogg":yZ,".wav":yZ,".m4a":yZ}),IC.register({".mp3":xZ,".ogg":xZ,".wav":xZ,".m4a":xZ});const SZ=new class{constructor(){this._oneShotAudioInfoList=[],this._audioPlayerInfoList=[]}_findIndex(t,e){return t.findIndex((t=>t.audio===e))}_tryAddPlaying(t,e){const n=this._findIndex(t,e);return n>-1?(t[n].playTime=performance.now(),!1):(t.push({audio:e,playTime:performance.now()}),!0)}addPlaying(t){if(t instanceof uZ){if(this._tryAddPlaying(this._audioPlayerInfoList,t))return}else this._tryAddPlaying(this._oneShotAudioInfoList,t)}_tryRemovePlaying(t,e){const n=this._findIndex(t,e);return-1!==n&&(z(t,n),!0)}removePlaying(t){if(t instanceof uZ){if(this._tryRemovePlaying(this._audioPlayerInfoList,t))return}else this._tryRemovePlaying(this._oneShotAudioInfoList,t)}discardOnePlayingIfNeeded(){if(this._audioPlayerInfoList.length+this._oneShotAudioInfoList.length<uZ.maxAudioChannel)return;let t;this._oneShotAudioInfoList.length>0?this._oneShotAudioInfoList.forEach((e=>{(!t||e.playTime<t.playTime)&&(t=e)})):this._audioPlayerInfoList.forEach((e=>{(!t||e.playTime<t.playTime)&&(t=e)})),t&&(t.audio.stop(),this.removePlaying(t.audio))}};var TZ,EZ,AZ,CZ,bZ,PZ,wZ,DZ,IZ,RZ,OZ,MZ,NZ,LZ,BZ,FZ,zZ,UZ;let HZ=(TZ=i_("cc.AudioSource"),EZ=f_(),AZ=__(),CZ=O_(vZ),bZ=O_(vZ),PZ=y_(),wZ=y_(),DZ=y_(),IZ=x_(),RZ=y_(),GZ=TZ(OZ=EZ(OZ=AZ((UZ=zZ=class t extends Ad{constructor(...t){super(...t),Xh(this,"_clip",NZ,this),this._player=null,Xh(this,"_loop",LZ,this),Xh(this,"_playOnAwake",BZ,this),Xh(this,"_volume",FZ,this),this._cachedCurrentTime=0,this._operationsBeforeLoading=[],this._isLoaded=!1,this._lastSetClip=void 0}static get maxAudioChannel(){return uZ.maxAudioChannel}set clip(t){t!==this._clip&&(this._clip=t,this._syncPlayer())}get clip(){return this._clip}_syncPlayer(){const t=this._clip;this._isLoaded=!1,t&&this._lastSetClip!==t&&(t._nativeAsset?(this._lastSetClip=t,uZ.load(t._nativeAsset.url,{audioLoadMode:t.loadMode}).then((e=>{this._lastSetClip===t&&(this._isLoaded=!0,this._player&&(this._player.offEnded(),this._player.offInterruptionBegin(),this._player.offInterruptionEnd(),this._player.destroy()),this._player=e,e.onEnded((()=>{SZ.removePlaying(e)})),e.onInterruptionBegin((()=>{SZ.removePlaying(e)})),e.onInterruptionEnd((()=>{SZ.addPlaying(e)})),this._syncStates())})).catch((()=>{}))):console.error("Invalid audio clip"))}set loop(t){this._loop=t,this._player&&(this._player.loop=t)}get loop(){return this._loop}set playOnAwake(t){this._playOnAwake=t}get playOnAwake(){return this._playOnAwake}set volume(t){Number.isNaN(t)?console.warn("illegal audio volume!"):(t=De(t,0,1),this._player?(this._player.volume=t,this._volume=this._player.volume):this._volume=t)}get volume(){return this._volume}onLoad(){this._syncPlayer()}onEnable(){this._playOnAwake&&!this.playing&&this.play()}onDisable(){this.pause()}onDestroy(){this.stop()}play(){var t,e;this._isLoaded?(SZ.discardOnePlayingIfNeeded(),this.state===tZ.PLAYING&&(null===(e=this._player)||void 0===e||e.stop().catch((()=>{}))),null===(t=this._player)||void 0===t||t.play().then((()=>{SZ.addPlaying(this._player)})).catch((()=>{}))):this._operationsBeforeLoading.push("play")}pause(){var t;this._isLoaded?null===(t=this._player)||void 0===t||t.pause().then((()=>{SZ.removePlaying(this._player)})).catch((()=>{})):this._operationsBeforeLoading.push("pause")}stop(){var t;this._isLoaded?null===(t=this._player)||void 0===t||t.stop().then((()=>{SZ.removePlaying(this._player)})).catch((()=>{})):this._operationsBeforeLoading.push("stop")}playOneShot(t,e=1){t._nativeAsset?uZ.loadOneShotAudio(t._nativeAsset.url,this._volume*e,{audioLoadMode:t.loadMode}).then((t=>{SZ.discardOnePlayingIfNeeded(),t.onPlay=()=>{SZ.addPlaying(t)},t.onEnd=()=>{SZ.removePlaying(t)},t.play()})).catch((()=>{})):console.error("Invalid audio clip")}_syncStates(){this._player&&this._player.seek(this._cachedCurrentTime).then((()=>{this._player&&(this._player.loop=this._loop,this._player.volume=this._volume,this._operationsBeforeLoading.forEach((t=>{var e;null===(e=this[t])||void 0===e||e.call(this)})),this._operationsBeforeLoading.length=0)})).catch((()=>{}))}set currentTime(t){var e;Number.isNaN(t)?console.warn("illegal audio time!"):(t=De(t,0,this.duration),this._cachedCurrentTime=t,null===(e=this._player)||void 0===e||e.seek(this._cachedCurrentTime).catch((()=>{})))}get currentTime(){return this._player?this._player.currentTime:this._cachedCurrentTime}get duration(){var t,e;return null!==(t=null===(e=this._clip)||void 0===e?void 0:e.getDuration())&&void 0!==t?t:this._player?this._player.currentTime:0}get state(){return this._player?this._player.state:tZ.INIT}get playing(){return this.state===t.AudioState.PLAYING}},zZ.AudioState=tZ,NZ=Yh((MZ=UZ).prototype,"_clip",[CZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),LZ=Yh(MZ.prototype,"_loop",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),BZ=Yh(MZ.prototype,"_playOnAwake",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),FZ=Yh(MZ.prototype,"_volume",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Yh(MZ.prototype,"clip",[bZ,PZ],Object.getOwnPropertyDescriptor(MZ.prototype,"clip"),MZ.prototype),Yh(MZ.prototype,"loop",[wZ],Object.getOwnPropertyDescriptor(MZ.prototype,"loop"),MZ.prototype),Yh(MZ.prototype,"playOnAwake",[DZ],Object.getOwnPropertyDescriptor(MZ.prototype,"playOnAwake"),MZ.prototype),Yh(MZ.prototype,"volume",[IZ,RZ],Object.getOwnPropertyDescriptor(MZ.prototype,"volume"),MZ.prototype),OZ=MZ))||OZ)||OZ)||OZ,t({AudioSource:GZ,AudioSourceComponent:GZ}),GZ);var GZ,VZ,jZ,WZ;i.AudioSourceComponent=HZ,wt.setClassAlias(HZ,"cc.AudioSourceComponent");let kZ=t("VideoClip",i_("cc.VideoClip")((WZ=Yh((jZ=class extends lu{constructor(){super(),Xh(this,"_duration",WZ,this),this._video=null,this.loaded=!1}set _nativeAsset(t){this._video=t,t?(this._duration=t.duration,this.loaded=!0):(this._duration=0,this.loaded=!1)}get _nativeAsset(){return this._video}}).prototype,"_duration",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),VZ=jZ))||VZ);function qZ(t,e,n){const i=document.createElement("video"),s=document.createElement("source");i.appendChild(s);const o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="blob",o.onload=function(){200===this.status||0===this.status?(s.src=URL.createObjectURL(this.response),n(null,i)):n(new Error(`${o.status}(no response)`))},o.onerror=function(){const e=`load video failure - ${t}`;u(e),n(new Error(e))},o.send()}function XZ(t,e,n,i){const s=new kZ;s._nativeUrl=t,s._nativeAsset=e,i(null,s)}EC.register({".mp4":qZ,".avi":qZ,".mov":qZ,".mpg":qZ,".mpeg":qZ,".rm":qZ,".rmvb":qZ}),IC.register({".mp4":XZ,".avi":XZ,".mov":XZ,".mpg":XZ,".mpeg":XZ,".rm":XZ,".rmvb":XZ});const YZ=It({REMOTE:0,LOCAL:1});let KZ,$Z;!function(t){t.NONE="none",t.PLAYING="playing",t.PAUSED="paused",t.STOPPED="stopped",t.COMPLETED="completed",t.META_LOADED="meta-loaded",t.READY_TO_PLAY="ready-to-play",t.ERROR="error",t.CLICKED="clicked"}(KZ||(KZ={})),function(t){t[t.HAVE_NOTHING=0]="HAVE_NOTHING",t[t.HAVE_METADATA=1]="HAVE_METADATA",t[t.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",t[t.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",t[t.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"}($Z||($Z={}));class ZZ{constructor(t){this._componentEventList=new Map,this._state=KZ.NONE,this._video=null,this._onHide=void 0,this._onShow=void 0,this._interrupted=!1,this._loaded=!1,this._loadedMeta=!1,this._ignorePause=!1,this._fullScreenOnAwake=!1,this._visible=!0,this._playing=!1,this._cachedCurrentTime=-1,this._waitingFullscreen=!1,this._waitingPlay=!1,this._keepAspectRatio=!1,this._component=null,this._uiTrans=null,this._node=null,this._stayOnBottom=!1,this._dirty=!1,this._forceUpdate=!1,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._component=t,this._node=t.node,this._uiTrans=t.node.getComponent(RO),this._onHide=()=>{this.video&&this._state===KZ.PLAYING&&(this.video.pause(),this._interrupted=!0)},this._onShow=()=>{this._interrupted&&this.video&&(this.video.play(),this._interrupted=!1)},i.game.on(i.Game.EVENT_HIDE,this._onHide),i.game.on(i.Game.EVENT_SHOW,this._onShow)}get fullScreenOnAwake(){return this._fullScreenOnAwake}get loaded(){return this._loaded}get componentEventList(){return this._componentEventList}get video(){return this._video}get state(){return this._state}get isPlaying(){return this._playing}get UICamera(){return qA.root.batcher2D.getFirstRenderCamera(this._node)}onLoadedMetadata(t){this._loadedMeta=!0,this._forceUpdate=!0,this._visible?this.enable():this.disable(),this.dispatchEvent(KZ.META_LOADED);const e=t.target;this._keepAspectRatio&&e&&this.syncUITransform(e.videoWidth,e.videoHeight),this.delayedFullScreen(),this.delayedPlay()}onCanPlay(t){this._loaded=!0,this.dispatchEvent(KZ.READY_TO_PLAY)}onPlay(t){this._playing=!0,this.dispatchEvent(KZ.PLAYING)}onPlaying(t){this.dispatchEvent(KZ.PLAYING)}onPause(t){this._ignorePause?this._ignorePause=!1:(this._playing=!1,this.dispatchEvent(KZ.PAUSED))}onStoped(t){this._playing=!1,this._ignorePause=!1,this.dispatchEvent(KZ.STOPPED)}onEnded(t){this.dispatchEvent(KZ.COMPLETED)}onClick(t){this.dispatchEvent(KZ.CLICKED)}onError(t){this.dispatchEvent(KZ.ERROR);const e=t.target;e&&e.error&&p(`Error ${e.error.code}; details: ${e.error.message}`)}play(){this._loadedMeta||this._loaded?this.canPlay():this._waitingPlay=!0}delayedPlay(){this._waitingPlay&&(this.canPlay(),this._waitingPlay=!1)}syncFullScreenOnAwake(t){this._fullScreenOnAwake=t,this._loadedMeta||this._loaded?this.canFullScreen(t):this._waitingFullscreen=!0}delayedFullScreen(){this._waitingFullscreen&&(this.canFullScreen(this._fullScreenOnAwake),this._waitingFullscreen=!1)}dispatchEvent(t){const e=this._componentEventList.get(t);e&&(this._state=t,e.call(this))}syncUITransform(t,e){this._uiTrans&&(this._uiTrans.width=t,this._uiTrans.height=e)}syncCurrentTime(){this.video&&-1!==this._cachedCurrentTime&&this.video.currentTime!==this._cachedCurrentTime&&(this.seekTo(this._cachedCurrentTime),this._cachedCurrentTime=-1)}destroy(){this.removeVideoPlayer(),this._componentEventList.clear(),i.game.off(i.Game.EVENT_HIDE,this._onHide),i.game.off(i.Game.EVENT_SHOW,this._onShow)}}i.internal.VideoPlayerImpl=ZZ;const JZ=gn();class QZ extends ZZ{constructor(t){super(t),this._eventList=new Map,this._clearColorA=-1,this._clearFlag=void 0}addListener(t,e){this._video&&(this._eventList.set(t,e),this._video.addEventListener(t,e))}removeAllListeners(){this._eventList.forEach(((t,e)=>{this._video&&this._video.removeEventListener(e,t)})),this._eventList.clear()}canPlay(){if(this.video){const t=this.video.play();window.Promise&&t instanceof Promise&&t.catch((()=>{})).then((()=>{this.syncCurrentTime()}))}}pause(){this.video&&(this.video.pause(),this._cachedCurrentTime=this.video.currentTime)}resume(){this.play()}stop(){this.video&&(this._ignorePause=!0,this.video.currentTime=0,this.video.pause(),this._cachedCurrentTime=0,setTimeout((()=>{this._ignorePause=!1,this.dispatchEvent(KZ.STOPPED)}),0))}syncClip(t){this.removeVideoPlayer(),t&&this.createVideoPlayer(t.nativeUrl)}syncURL(t){this.removeVideoPlayer(),t&&this.createVideoPlayer(t)}syncPlaybackRate(t){Qn.browserType!==jn.UC?this.video&&(this.video.playbackRate=t):d("playbackRate is not supported by the uc mobile browser.")}syncVolume(t){this.video&&(this.video.volume=t)}syncMute(t){this.video&&(this.video.muted=t)}syncLoop(t){this.video&&(this.video.loop=t)}getDuration(){return this.video?this.video.duration:0}getCurrentTime(){return this.video?this.video.currentTime:-1}seekTo(t){this.video&&(this.video.currentTime=t)}canFullScreen(t){const e=this._video;if(e&&e.readyState===$Z.HAVE_ENOUGH_DATA)return Qn.os===Xn.IOS&&Rp.isBrowser?(t?e.webkitEnterFullscreen&&e.webkitEnterFullscreen():e.webkitExitFullscreen&&e.webkitExitFullscreen(),void(this._fullScreenOnAwake=e.webkitDisplayingFullscreen)):Nm.supportsFullScreen?void(t?(Qn.browserType===jn.IE&&(e.style.transform=""),e.setAttribute("x5-video-player-fullscreen","true"),Nm.requestFullScreen(e,(t=>{const n=Qn.browserType===jn.IE?t.msFullscreenElement:t.fullscreenElement;this._fullScreenOnAwake=n===e}),(()=>{this._fullScreenOnAwake=!1}))):(e.removeAttribute("x5-video-player-fullscreen"),Nm.exitFullScreen())):(this._fullScreenOnAwake=t,this._forceUpdate=!0,void this.syncMatrix())}syncStayOnBottom(t){this._video&&(this._video.style["z-index"]=t?-32768:0,this._stayOnBottom=t),this._dirty=!0}syncKeepAspectRatio(t){this._keepAspectRatio=t,t&&this._loadedMeta&&this._video&&this.syncUITransform(this._video.videoWidth,this._video.videoHeight)}removeVideoPlayer(){const t=this._video;t&&Gt(Sm.container,t)&&(Sm.container.removeChild(t),this.removeAllListeners()),this._cachedCurrentTime=0,this._playing=!1,this._loaded=!1,this._loadedMeta=!1,this._video=null}createVideoPlayer(t){const e=this._video=document.createElement("video");e.className="cocosVideo",e.style.visibility="hidden",e.style.position="absolute",e.style.bottom="0px",e.style.left="0px",e.style["transform-origin"]="0px 100% 0px",e.style["-webkit-transform-origin"]="0px 100% 0px",e.setAttribute("preload","auto"),e.setAttribute("webkit-playsinline",""),e.setAttribute("x5-playsinline",""),e.setAttribute("playsinline",""),this._bindDomEvent(),Sm.container.appendChild(e);const n=document.createElement("source");e.appendChild(n),n.src=t}_bindDomEvent(){this._video,this.addListener("loadedmetadata",this.onLoadedMetadata.bind(this)),this.addListener("canplay",this.onCanPlay.bind(this)),this.addListener("canplaythrough",this.onCanPlay.bind(this)),this.addListener("play",this.onPlay.bind(this)),this.addListener("playing",this.onPlaying.bind(this)),this.addListener("pause",this.onPause.bind(this)),this.addListener("click",this.onClick.bind(this)),this.addListener("ended",this.onEnded.bind(this)),this.addListener("error",this.onError.bind(this))}onCanPlay(t){const e=t.target;if(!this._loaded||!e)switch(e.readyState){case $Z.HAVE_METADATA:case $Z.HAVE_ENOUGH_DATA:super.onCanPlay(t)}}enable(){if(this._video){if(this._visible=!0,"visible"===this._video.style.visibility)return;this._video.style.visibility="visible"}}disable(t){if(this._video){if(!t&&this._playing&&this._video.pause(),this._visible=!1,"hidden"===this._video.style.visibility)return;this._video.style.visibility="hidden"}}syncMatrix(){if(!this._video||!this._visible||!this._component)return;const t=this.UICamera;if(!t)return;if(Nm.fullScreen())return;this._dirty&&(this._dirty=!1,this._stayOnBottom?(this._clearColorA=t.clearColor.w,this._clearFlag=t.clearFlag,t.clearColor.w=0,t.clearFlag=_r.ALL):this._clearFlag&&(t.clearColor.w=this._clearColorA,t.clearFlag=this._clearFlag,this._clearColorA=-1,this._clearFlag=null)),this._component.node.getWorldMatrix(JZ),t.update(!0),t.worldMatrixToScreen(JZ,JZ,Sm.canvas.width,Sm.canvas.height);let e=0,n=0;if(this._fullScreenOnAwake?(e=Op.width,n=Op.height):(e=this._uiTrans.contentSize.width,n=this._uiTrans.contentSize.height),!this._forceUpdate&&this._m00===JZ.m00&&this._m01===JZ.m01&&this._m04===JZ.m04&&this._m05===JZ.m05&&this._m12===JZ.m12&&this._m13===JZ.m13&&this._w===e&&this._h===n)return;this._m00=JZ.m00,this._m01=JZ.m01,this._m04=JZ.m04,this._m05=JZ.m05,this._m12=JZ.m12,this._m13=JZ.m13,this._w=e,this._h=n;const i=Pm.getDevicePixelRatio(),s=1/i,o=1/i,r=Sm.container,a=JZ.m00*s,c=JZ.m01,l=JZ.m04,h=JZ.m05*o;this._video.style.width=`${this._w}px`,this._video.style.height=`${this._h}px`,Qn.browserType!==jn.MOBILE_QQ?this._video.style.objectFit=this._keepAspectRatio?"none":"fill":d("keepAspectRatio is not supported by the qq mobile browser.");const _=this._w*s,u=this._h*o,{x:p,y:f}=this._uiTrans.anchorPoint,m=_*JZ.m00*p,g=u*JZ.m05*f,v=r&&r.style.paddingLeft?parseInt(r.style.paddingLeft):0,y=r&&r.style.paddingBottom?parseInt(r.style.paddingBottom):0,x=`matrix(${a},${-c},${-l},${h},${JZ.m12*s-m+v},${-(JZ.m13*o-g+y)})`;this._video.style.transform=x,this._video.style["-webkit-transform"]=x,Qn.browserType!==jn.IE&&(this._forceUpdate=!1)}}class tJ{static getImpl(t){return new QZ(t)}}var eJ,nJ,iJ,sJ,oJ,rJ,aJ,cJ,lJ,hJ,_J,uJ,dJ,pJ,fJ,mJ,gJ,vJ,yJ,xJ,SJ,TJ,EJ,AJ,CJ,bJ,PJ,wJ,DJ,IJ,RJ,OJ,MJ,NJ,LJ,BJ,FJ,zJ,UJ;i.internal.VideoPlayerImplManager=tJ;let HJ,GJ=t("VideoPlayer",(eJ=i_("cc.VideoPlayer"),nJ=f_(),iJ=__(),sJ=s_(RO),oJ=O_(kZ),rJ=O_(YZ),aJ=y_(),cJ=y_(),lJ=O_(kZ),hJ=y_(),_J=y_(),uJ=x_(),dJ=y_(),pJ=x_(),fJ=y_(),mJ=y_(),gJ=y_(),vJ=y_(),yJ=y_(),xJ=y_(),SJ=O_([ob]),TJ=C_(),EJ=y_(),eJ(AJ=nJ(AJ=iJ(AJ=sJ(AJ=h_((UJ=zJ=class extends Ad{constructor(...t){super(...t),Xh(this,"_resourceType",bJ,this),Xh(this,"_remoteURL",PJ,this),Xh(this,"_clip",wJ,this),Xh(this,"_playOnAwake",DJ,this),Xh(this,"_volume",IJ,this),Xh(this,"_mute",RJ,this),Xh(this,"_playbackRate",OJ,this),Xh(this,"_loop",MJ,this),Xh(this,"_fullScreenOnAwake",NJ,this),Xh(this,"_stayOnBottom",LJ,this),Xh(this,"_keepAspectRatio",BJ,this),this._impl=null,this._cachedCurrentTime=0,Xh(this,"videoPlayerEvent",FJ,this)}get resourceType(){return this._resourceType}set resourceType(t){this._resourceType!==t&&(this._resourceType=t,this.syncSource())}get remoteURL(){return this._remoteURL}set remoteURL(t){this._remoteURL!==t&&(this._remoteURL=t,this.syncSource())}get clip(){return this._clip}set clip(t){this._clip!==t&&(this._clip=t,this.syncSource())}get playOnAwake(){return this._playOnAwake}set playOnAwake(t){this._playOnAwake=t}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._impl&&this._impl.syncPlaybackRate(t)}get volume(){return this._volume}set volume(t){this._volume=t,this._impl&&this._impl.syncVolume(t)}get mute(){return this._mute}set mute(t){this._mute=t,this._impl&&this._impl.syncMute(t)}get loop(){return this._loop}set loop(t){this._loop=t,this._impl&&this._impl.syncLoop(t)}get keepAspectRatio(){return this._keepAspectRatio}set keepAspectRatio(t){this._keepAspectRatio!==t&&(this._keepAspectRatio=t,this._impl&&this._impl.syncKeepAspectRatio(t))}get fullScreenOnAwake(){return this._impl?(this._fullScreenOnAwake=this._impl.fullScreenOnAwake,this._fullScreenOnAwake):this._fullScreenOnAwake}set fullScreenOnAwake(t){this._fullScreenOnAwake!==t&&(this._fullScreenOnAwake=t,this._impl&&this._impl.syncFullScreenOnAwake(t))}get stayOnBottom(){return this._stayOnBottom}set stayOnBottom(t){this._stayOnBottom!==t&&(this._stayOnBottom=t,this._impl&&this._impl.syncStayOnBottom(t))}get nativeVideo(){return this._impl&&this._impl.video||null}get currentTime(){return this._impl?this._impl.getCurrentTime():this._cachedCurrentTime}set currentTime(t){Number.isNaN(t)?d(`illegal video time! value:${t}`):(t=De(t,0,this.duration),this._cachedCurrentTime=t,this._impl&&this._impl.seekTo(t))}get duration(){return this._impl?this._impl.getDuration():0}get state(){return this._impl?this._impl.state:KZ.NONE}get isPlaying(){return!!this._impl&&this._impl.isPlaying}syncSource(){this._impl&&(this._resourceType===YZ.REMOTE?this._impl.syncURL(this._remoteURL):this._impl.syncClip(this._clip))}__preload(){this._impl=tJ.getImpl(this),this.syncSource(),this._impl.syncLoop(this._loop),this._impl.syncVolume(this._volume),this._impl.syncMute(this._mute),this._impl.seekTo(this._cachedCurrentTime),this._impl.syncPlaybackRate(this._playbackRate),this._impl.syncStayOnBottom(this._stayOnBottom),this._impl.syncKeepAspectRatio(this._keepAspectRatio),this._impl.syncFullScreenOnAwake(this._fullScreenOnAwake),this._impl.componentEventList.set(KZ.META_LOADED,this.onMetaLoaded.bind(this)),this._impl.componentEventList.set(KZ.READY_TO_PLAY,this.onReadyToPlay.bind(this)),this._impl.componentEventList.set(KZ.PLAYING,this.onPlaying.bind(this)),this._impl.componentEventList.set(KZ.PAUSED,this.onPasued.bind(this)),this._impl.componentEventList.set(KZ.STOPPED,this.onStopped.bind(this)),this._impl.componentEventList.set(KZ.COMPLETED,this.onCompleted.bind(this)),this._impl.componentEventList.set(KZ.ERROR,this.onError.bind(this)),this._playOnAwake&&this._impl.loaded&&this.play()}onEnable(){this._impl&&this._impl.enable()}onDisable(){this._impl&&this._impl.disable()}onDestroy(){this._impl&&(this._impl.destroy(),this._impl=null)}update(t){this._impl&&this._impl.syncMatrix()}onMetaLoaded(){ob.emitEvents(this.videoPlayerEvent,this,KZ.META_LOADED),this.node.emit("meta-loaded",this)}onReadyToPlay(){this._playOnAwake&&!this.isPlaying&&this.play(),ob.emitEvents(this.videoPlayerEvent,this,KZ.READY_TO_PLAY),this.node.emit(KZ.READY_TO_PLAY,this)}onPlaying(){ob.emitEvents(this.videoPlayerEvent,this,KZ.PLAYING),this.node.emit(KZ.PLAYING,this)}onPasued(){ob.emitEvents(this.videoPlayerEvent,this,KZ.PAUSED),this.node.emit(KZ.PAUSED,this)}onStopped(){ob.emitEvents(this.videoPlayerEvent,this,KZ.STOPPED),this.node.emit(KZ.STOPPED,this)}onCompleted(){ob.emitEvents(this.videoPlayerEvent,this,KZ.COMPLETED),this.node.emit(KZ.COMPLETED,this)}onError(){ob.emitEvents(this.videoPlayerEvent,this,KZ.ERROR),this.node.emit(KZ.ERROR,this)}play(){this._impl&&this._impl.play()}resume(){this._impl&&this._impl.resume()}pause(){this._impl&&this._impl.pause()}stop(){this._impl&&this._impl.stop()}},zJ.EventType=KZ,zJ.ResourceType=YZ,bJ=Yh((CJ=UJ).prototype,"_resourceType",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return YZ.LOCAL}}),PJ=Yh(CJ.prototype,"_remoteURL",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),wJ=Yh(CJ.prototype,"_clip",[oJ,c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DJ=Yh(CJ.prototype,"_playOnAwake",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),IJ=Yh(CJ.prototype,"_volume",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),RJ=Yh(CJ.prototype,"_mute",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),OJ=Yh(CJ.prototype,"_playbackRate",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),MJ=Yh(CJ.prototype,"_loop",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),NJ=Yh(CJ.prototype,"_fullScreenOnAwake",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),LJ=Yh(CJ.prototype,"_stayOnBottom",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),BJ=Yh(CJ.prototype,"_keepAspectRatio",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Yh(CJ.prototype,"resourceType",[rJ,aJ],Object.getOwnPropertyDescriptor(CJ.prototype,"resourceType"),CJ.prototype),Yh(CJ.prototype,"remoteURL",[cJ],Object.getOwnPropertyDescriptor(CJ.prototype,"remoteURL"),CJ.prototype),Yh(CJ.prototype,"clip",[lJ,hJ],Object.getOwnPropertyDescriptor(CJ.prototype,"clip"),CJ.prototype),Yh(CJ.prototype,"playOnAwake",[_J],Object.getOwnPropertyDescriptor(CJ.prototype,"playOnAwake"),CJ.prototype),Yh(CJ.prototype,"playbackRate",[A_,uJ,dJ],Object.getOwnPropertyDescriptor(CJ.prototype,"playbackRate"),CJ.prototype),Yh(CJ.prototype,"volume",[A_,pJ,fJ],Object.getOwnPropertyDescriptor(CJ.prototype,"volume"),CJ.prototype),Yh(CJ.prototype,"mute",[mJ],Object.getOwnPropertyDescriptor(CJ.prototype,"mute"),CJ.prototype),Yh(CJ.prototype,"loop",[gJ],Object.getOwnPropertyDescriptor(CJ.prototype,"loop"),CJ.prototype),Yh(CJ.prototype,"keepAspectRatio",[vJ],Object.getOwnPropertyDescriptor(CJ.prototype,"keepAspectRatio"),CJ.prototype),Yh(CJ.prototype,"fullScreenOnAwake",[yJ],Object.getOwnPropertyDescriptor(CJ.prototype,"fullScreenOnAwake"),CJ.prototype),Yh(CJ.prototype,"stayOnBottom",[xJ],Object.getOwnPropertyDescriptor(CJ.prototype,"stayOnBottom"),CJ.prototype),FJ=Yh(CJ.prototype,"videoPlayerEvent",[c_,SJ,TJ,EJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),AJ=CJ))||AJ)||AJ)||AJ)||AJ)||AJ));i.internal.VideoPlayer=GJ,function(t){t.NONE="none",t.LOADING="loading",t.LOADED="loaded",t.ERROR="error"}(HJ||(HJ={}));class VJ{constructor(t){this._componentEventList=new Map,this._state=HJ.NONE,this._warpper=void 0,this._webview=null,this._loaded=!1,this._forceUpdate=!1,this._component=null,this._uiTrans=null,this._node=null,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._component=t,this._node=t.node,this._uiTrans=t.node.getComponent(RO),this.reset(),this.createWebView()}reset(){this._warpper=null,this._webview=null,this._loaded=!1,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._state=HJ.NONE,this._forceUpdate=!1}get loaded(){return this._loaded}get componentEventList(){return this._componentEventList}get webview(){return this._webview}get state(){return this._state}get UICamera(){return qA.root.batcher2D.getFirstRenderCamera(this._node)}dispatchEvent(t,...e){const n=this._componentEventList.get(t);n&&(this._state=t,n.call(this,e))}destroy(){this.removeWebView(),this._warpper=null,this._webview=null,this._loaded=!1,this._component=null,this._uiTrans=null,this._forceUpdate=!1,this._componentEventList.clear()}}i.internal.WebViewImpl=VJ;const jJ=gn();class WJ extends VJ{constructor(t){super(t)}_bindDomEvent(){this.webview&&this.webview.addEventListener("load",(t=>{this._forceUpdate=!0,this.dispatchEvent(HJ.LOADED);const e=t.target,n=e.contentDocument&&e.contentDocument.body;n&&n.innerHTML.includes("404")&&this.dispatchEvent(HJ.ERROR,n.innerHTML)}))}loadURL(t){this.webview&&(this.webview.src=t,this.dispatchEvent(HJ.LOADING))}createWebView(){const t=document.createElement("div");this._warpper=t,t.id="webview-wrapper",t.style["-webkit-overflow"]="auto",t.style["-webkit-overflow-scrolling"]="touch",t.style.position="absolute",t.style.bottom="0px",t.style.left="0px",t.style.transformOrigin="0px 100% 0px",t.style["-webkit-transform-origin"]="0px 100% 0px",Sm.container.appendChild(t);const e=document.createElement("iframe");this._webview=e,e.id="webview",e.style.border="none",e.style.width="100%",e.style.height="100%",t.appendChild(e),this._bindDomEvent()}removeWebView(){const t=this._warpper;Gt(Sm.container,t)&&Sm.container.removeChild(t),this.reset()}enable(){this._warpper&&(this._warpper.style.visibility="visible")}disable(){this._warpper&&(this._warpper.style.visibility="hidden")}evaluateJS(t){if(this.webview){const e=this.webview.contentWindow;if(e)try{e.eval(t)}catch(t){this.dispatchEvent(HJ.ERROR,t),p(t)}}}setOnJSCallback(t){d("The platform does not support")}setJavascriptInterfaceScheme(t){d("The platform does not support")}syncMatrix(){if(!this._warpper||!this._uiTrans||!this._component||"hidden"===this._warpper.style.visibility)return;const t=this.UICamera;if(!t)return;this._component.node.getWorldMatrix(jJ),t.update(!0),t.worldMatrixToScreen(jJ,jJ,Sm.canvas.width,Sm.canvas.height);const{width:e,height:n}=this._uiTrans.contentSize;if(!this._forceUpdate&&this._m00===jJ.m00&&this._m01===jJ.m01&&this._m04===jJ.m04&&this._m05===jJ.m05&&this._m12===jJ.m12&&this._m13===jJ.m13&&this._w===e&&this._h===n)return;this._m00=jJ.m00,this._m01=jJ.m01,this._m04=jJ.m04,this._m05=jJ.m05,this._m12=jJ.m12,this._m13=jJ.m13,this._w=e,this._h=n;const i=Pm.getDevicePixelRatio(),s=1/i,o=1/i,r=Sm.container,a=jJ.m00*s,c=jJ.m01,l=jJ.m04,h=jJ.m05*o;this._warpper.style.width=`${e}px`,this._warpper.style.height=`${n}px`;const _=this._w*s,u=this._h*o,d=_*jJ.m00*this._uiTrans.anchorX,p=u*jJ.m05*this._uiTrans.anchorY,f=r&&r.style.paddingLeft?parseInt(r.style.paddingLeft):0,m=r&&r.style.paddingBottom?parseInt(r.style.paddingBottom):0,g=`matrix(${a},${-c},${-l},${h},${jJ.m12*s-d+f},${-(jJ.m13*o-p+m)})`;this._warpper.style.transform=g,this._warpper.style["-webkit-transform"]=g,this._forceUpdate=!1}}class kJ{static getImpl(t){return new WJ(t)}}var qJ,XJ,YJ,KJ,$J,ZJ,JJ,QJ,tQ,eQ,nQ,iQ,sQ,oQ;i.internal.WebViewImplManager=kJ;let rQ=t("WebView",(qJ=i_("cc.WebView"),XJ=f_(),YJ=__(),KJ=s_(RO),$J=y_(),ZJ=O_([ob]),JJ=C_(),QJ=y_(),qJ(tQ=XJ(tQ=YJ(tQ=KJ(tQ=h_((oQ=sQ=class extends Ad{constructor(...t){super(...t),Xh(this,"_url",nQ,this),this._impl=null,Xh(this,"webviewEvents",iQ,this)}get url(){return this._url}set url(t){this._url=t,this._impl&&this._impl.loadURL(t)}get nativeWebView(){return this._impl&&this._impl.webview||null}get state(){return this._impl?this._impl.state:HJ.NONE}setJavascriptInterfaceScheme(t){this._impl&&this._impl.setJavascriptInterfaceScheme(t)}setOnJSCallback(t){this._impl&&this._impl.setOnJSCallback(t)}evaluateJS(t){this._impl&&this._impl.evaluateJS(t)}__preload(){this._impl=kJ.getImpl(this),this._impl.componentEventList.set(HJ.LOADING,this.onLoading.bind(this)),this._impl.componentEventList.set(HJ.LOADED,this.onLoaded.bind(this)),this._impl.componentEventList.set(HJ.ERROR,this.onError.bind(this)),this._impl.loadURL(this._url)}onLoading(){ob.emitEvents(this.webviewEvents,this,HJ.LOADING),this.node.emit(HJ.LOADING,this)}onLoaded(){ob.emitEvents(this.webviewEvents,this,HJ.LOADED),this.node.emit(HJ.LOADED,this)}onError(...t){ob.emitEvents(this.webviewEvents,this,HJ.ERROR,t),this.node.emit(HJ.ERROR,this,t)}onEnable(){this._impl&&this._impl.enable()}onDisable(){this._impl&&this._impl.disable()}onDestroy(){this._impl&&(this._impl.destroy(),this._impl=null)}update(t){this._impl&&this._impl.syncMatrix()}},sQ.EventType=HJ,nQ=Yh((eQ=oQ).prototype,"_url",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"https://cocos.com"}}),Yh(eQ.prototype,"url",[$J],Object.getOwnPropertyDescriptor(eQ.prototype,"url"),eQ.prototype),iQ=Yh(eQ.prototype,"webviewEvents",[c_,ZJ,JJ,QJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tQ=eQ))||tQ)||tQ)||tQ)||tQ)||tQ));i.internal.WebView=rQ;class aQ{constructor(){this.originalTarget=null,this.target=null,this.tag=aQ.TAG_INVALID}clone(){const t=new aQ;return t.originalTarget=null,t.target=null,t.tag=this.tag,t}isDone(){return!0}startWithTarget(t){this.originalTarget=t,this.target=t}stop(){this.target=null}step(t){S(1006)}update(t){S(1007)}getTarget(){return this.target}setTarget(t){this.target=t}getOriginalTarget(){return this.originalTarget}setOriginalTarget(t){this.originalTarget=t}getTag(){return this.tag}setTag(t){this.tag=t}reverse(){return S(1008),null}retain(){}release(){}}aQ.TAG_INVALID=-1;class cQ extends aQ{constructor(...t){super(...t),this._duration=0,this._timesForRepeat=1}getDuration(){return this._duration*(this._timesForRepeat||1)}setDuration(t){this._duration=t}clone(){return new cQ}}let lQ=0;class hQ{constructor(){this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1}}class _Q{constructor(){this._hashTargets=new Map,this._arrayTargets=[],this._elementPool=[]}_searchElementByTarget(t,e){for(let n=0;n<t.length;n++)if(e===t[n].target)return t[n];return null}_getElement(t,e){let n=this._elementPool.pop();return n||(n=new hQ),n.target=t,n.paused=!!e,n}_putElement(t){t.actions.length=0,t.actionIndex=0,t.currentAction=null,t.paused=!1,t.target=null,t.lock=!1,this._elementPool.push(t)}addAction(t,e,n){if(!t||!e)return void C(1e3);null==e.uuid&&(e.uuid="_TWEEN_UUID_"+lQ++);let i=this._hashTargets.get(e);i?i.actions||(i.actions=[]):(i=this._getElement(e,n),this._hashTargets.set(e,i),this._arrayTargets.push(i)),i.target=e,i.actions.push(t),t.startWithTarget(e)}removeAllActions(){const t=this._arrayTargets;for(let e=0;e<t.length;e++){const n=t[e];n&&this._putElement(n)}this._arrayTargets.length=0,this._hashTargets=new Map}removeAllActionsFromTarget(t){if(null==t)return;const e=this._hashTargets.get(t);e&&(e.actions.length=0,this._deleteHashElement(e))}removeAction(t){if(null==t)return;const e=t.getOriginalTarget(),n=this._hashTargets.get(e);if(n)for(let e=0;e<n.actions.length;e++)if(n.actions[e]===t){n.actions.splice(e,1),n.actionIndex>=e&&n.actionIndex--;break}}_removeActionByTag(t,e,n){for(let i=0,s=e.actions.length;i<s;++i){const s=e.actions[i];if(s&&s.getTag()===t){if(n&&s.getOriginalTarget()!==n)continue;this._removeActionAtIndex(i,e);break}}}removeActionByTag(t,e){t===aQ.TAG_INVALID&&S(1002);const n=this._hashTargets;if(e){const i=n.get(e);i&&this._removeActionByTag(t,i,e)}else n.forEach((e=>{this._removeActionByTag(t,e)}))}getActionByTag(t,e){t===aQ.TAG_INVALID&&S(1004);const n=this._hashTargets.get(e);if(n){if(null!=n.actions)for(let e=0;e<n.actions.length;++e){const i=n.actions[e];if(i&&i.getTag()===t)return i}S(1005,t)}return null}getNumberOfRunningActionsInTarget(t){const e=this._hashTargets.get(t);return e&&e.actions?e.actions.length:0}pauseTarget(t){const e=this._hashTargets.get(t);e&&(e.paused=!0)}resumeTarget(t){const e=this._hashTargets.get(t);e&&(e.paused=!1)}pauseAllRunningActions(){const t=[],e=this._arrayTargets;for(let n=0;n<e.length;n++){const i=e[n];i&&!i.paused&&(i.paused=!0,t.push(i.target))}return t}resumeTargets(t){if(t)for(let e=0;e<t.length;e++)t[e]&&this.resumeTarget(t[e])}pauseTargets(t){if(t)for(let e=0;e<t.length;e++)t[e]&&this.pauseTarget(t[e])}purgeSharedManager(){i.director.getScheduler().unscheduleUpdate(this)}_removeActionAtIndex(t,e){e.actions[t],e.actions.splice(t,1),e.actionIndex>=t&&e.actionIndex--,0===e.actions.length&&this._deleteHashElement(e)}_deleteHashElement(t){let e=!1;if(t&&!t.lock&&this._hashTargets.get(t.target)){this._hashTargets.delete(t.target);const n=this._arrayTargets;for(let e=0,i=n.length;e<i;e++)if(n[e]===t){n.splice(e,1);break}this._putElement(t),e=!0}return e}update(t){const e=this._arrayTargets;let n;for(let i=0;i<e.length;i++){this._currentTarget=e[i],n=this._currentTarget;const s=n.target;if(s instanceof Rn&&!s.isValid)this.removeAllActionsFromTarget(s),i--;else{if(!n.paused&&n.actions){for(n.lock=!0,n.actionIndex=0;n.actionIndex<n.actions.length;n.actionIndex++)if(n.currentAction=n.actions[n.actionIndex],n.currentAction){if(n.currentAction.step(t*(n.currentAction._speedMethod?n.currentAction._speed:1)),n.currentAction&&n.currentAction.isDone()){n.currentAction.stop();const t=n.currentAction;n.currentAction=null,this.removeAction(t)}n.currentAction=null}n.lock=!1}0===n.actions.length&&this._deleteHashElement(n)&&i--}}}}class uQ extends BA{constructor(...t){super(...t),this.actionMgr=new _Q}get ActionManager(){return this.actionMgr}update(t){this.actionMgr.update(t)}}t("TweenSystem",uQ),uQ.ID="TWEEN",uQ.instance=void 0,qA.on(kA.EVENT_INIT,(()=>{const t=new uQ;uQ.instance=t,qA.registerSystem(uQ.ID,t,100)}));class dQ extends cQ{isDone(){return!0}step(t){this.update(1)}update(t){}reverse(){return this.clone()}clone(){return new dQ}}class pQ extends dQ{update(t){const e=this.target.getComponentsInChildren(FP);for(let t=0;t<e.length;++t)e[t].enabled=!0}reverse(){return new fQ}clone(){return new pQ}}class fQ extends dQ{update(t){const e=this.target.getComponentsInChildren(FP);for(let t=0;t<e.length;++t)e[t].enabled=!1}reverse(){return new pQ}clone(){return new fQ}}class mQ extends dQ{constructor(t){super(),this._isNeedCleanUp=!0,void 0!==t&&this.init(t)}update(t){this.target.removeFromParent(),this._isNeedCleanUp&&this.target.destroy()}init(t){return this._isNeedCleanUp=t,!0}reverse(){return new mQ(this._isNeedCleanUp)}clone(){return new mQ(this._isNeedCleanUp)}}class gQ extends dQ{constructor(t,e,n){super(),this._selectorTarget=null,this._function=null,this._data=null,this.initWithFunction(t,e,n)}initWithFunction(t,e,n){return t&&(this._function=t),e&&(this._selectorTarget=e),void 0!==n&&(this._data=n),!0}execute(){this._function&&this._function.call(this._selectorTarget,this.target,this._data)}update(t){this.execute()}getTargetCallback(){return this._selectorTarget}setTargetCallback(t){t!==this._selectorTarget&&(this._selectorTarget&&(this._selectorTarget=null),this._selectorTarget=t)}clone(){const t=new gQ;return t.initWithFunction(this._function,this._selectorTarget,this._data),t}}class vQ extends cQ{constructor(t){super(),this.MAX_VALUE=2,this._elapsed=0,this._firstTick=!1,this._easeList=[],this._speed=1,this._repeatForever=!1,this._repeatMethod=!1,this._speedMethod=!1,void 0===t||isNaN(t)||this.initWithDuration(t)}getElapsed(){return this._elapsed}initWithDuration(t){return this._duration=0===t?Lt.FLT_EPSILON:t,this._elapsed=0,this._firstTick=!0,!0}isDone(){return this._elapsed>=this._duration}_cloneDecoration(t){t._repeatForever=this._repeatForever,t._speed=this._speed,t._timesForRepeat=this._timesForRepeat,t._easeList=this._easeList,t._speedMethod=this._speedMethod,t._repeatMethod=this._repeatMethod}_reverseEaseList(t){if(this._easeList){t._easeList=[];for(let e=0;e<this._easeList.length;e++)t._easeList.push(this._easeList[e])}}clone(){const t=new vQ(this._duration);return this._cloneDecoration(t),t}easing(t){this._easeList?this._easeList.length=0:this._easeList=[];for(let t=0;t<arguments.length;t++)this._easeList.push(arguments[t]);return this}_computeEaseTime(t){return t}step(t){this._firstTick?(this._firstTick=!1,this._elapsed=0):this._elapsed+=t;let e=this._elapsed/(this._duration>1.192092896e-7?this._duration:1.192092896e-7);e=e<1?e:1,this.update(e>0?e:0),this._repeatMethod&&this._timesForRepeat>1&&this.isDone()&&(this._repeatForever||this._timesForRepeat--,this.startWithTarget(this.target),this.step(this._elapsed-this._duration))}startWithTarget(t){aQ.prototype.startWithTarget.call(this,t),this._elapsed=0,this._firstTick=!0}reverse(){return S(1010),this}setAmplitudeRate(t){S(1011)}getAmplitudeRate(){return S(1012),0}speed(t){return t<=0?(S(1013),this):(this._speedMethod=!0,this._speed*=t,this)}getSpeed(){return this._speed}setSpeed(t){return this._speed=t,this}repeat(t){return t=Math.round(t),isNaN(t)||t<1?(S(1014),this):(this._repeatMethod=!0,this._timesForRepeat*=t,this)}repeatForever(){return this._repeatMethod=!0,this._timesForRepeat=this.MAX_VALUE,this._repeatForever=!0,this}}class yQ extends vQ{constructor(t){super(),this._actions=[],this._split=0,this._last=0,this._reversed=!1;const e=t instanceof Array?t:arguments;if(1===e.length)return void C(1019);const n=e.length-1;if(n>=0&&null==e[n]&&S(1015),n>=0){let t,i=e[0];for(let s=1;s<n;s++)e[s]&&(t=i,i=yQ._actionOneTwo(t,e[s]));this.initWithTwoActions(i,e[n])}}initWithTwoActions(t,e){if(!t||!e)return C(1025),!1;let n=t._duration,i=e._duration;n*=t._repeatMethod?t._timesForRepeat:1,i*=e._repeatMethod?e._timesForRepeat:1;const s=n+i;return this.initWithDuration(s),this._actions[0]=t,this._actions[1]=e,!0}clone(){const t=new yQ;return this._cloneDecoration(t),t.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),t}startWithTarget(t){vQ.prototype.startWithTarget.call(this,t),this._split=this._actions[0]._duration/this._duration,this._split*=this._actions[0]._repeatMethod?this._actions[0]._timesForRepeat:1,this._last=-1}stop(){-1!==this._last&&this._actions[this._last].stop(),aQ.prototype.stop.call(this)}update(t){let e,n=0;const i=this._split,s=this._actions,o=this._last;let r;(t=this._computeEaseTime(t))<i?(e=0!==i?t/i:1,0===n&&1===o&&this._reversed&&(s[1].update(0),s[1].stop())):(n=1,e=1===i?1:(t-i)/(1-i),-1===o&&(s[0].startWithTarget(this.target),s[0].update(1),s[0].stop()),0===o&&(s[0].update(1),s[0].stop())),r=s[n],o===n&&r.isDone()||(o!==n&&r.startWithTarget(this.target),e*=r._timesForRepeat,r.update(e>1?e%1:e),this._last=n)}reverse(){const t=yQ._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t._reversed=!0,t}}function xQ(t){const e=t instanceof Array?t:arguments;if(1===e.length)return C(1019),null;const n=e.length-1;n>=0&&null==e[n]&&S(1015);let i=null;if(n>=0){i=e[0];for(let t=1;t<=n;t++)e[t]&&(i=yQ._actionOneTwo(i,e[t]))}return i}yQ._actionOneTwo=function(t,e){const n=new yQ;return n.initWithTwoActions(t,e),n};class SQ extends vQ{constructor(t,e){super(),this._times=0,this._total=0,this._nextDt=0,this._actionInstant=!1,this._innerAction=null,void 0!==e&&this.initWithAction(t,e)}initWithAction(t,e){const n=t._duration*e;return!!this.initWithDuration(n)&&(this._times=e,this._innerAction=t,t instanceof dQ&&(this._actionInstant=!0,this._times-=1),this._total=0,!0)}clone(){const t=new SQ;return this._cloneDecoration(t),t.initWithAction(this._innerAction.clone(),this._times),t}startWithTarget(t){this._total=0,this._nextDt=this._innerAction._duration/this._duration,vQ.prototype.startWithTarget.call(this,t),this._innerAction.startWithTarget(t)}stop(){this._innerAction.stop(),aQ.prototype.stop.call(this)}update(t){t=this._computeEaseTime(t);const e=this._innerAction,n=this._duration,i=this._times;let s=this._nextDt;if(t>=s){for(;t>s&&this._total<i;)e.update(1),this._total++,e.stop(),e.startWithTarget(this.target),s+=e._duration/n,this._nextDt=s>1?1:s;t>=1&&this._total<i&&(e.update(1),this._total++),this._actionInstant||(this._total===i?e.stop():e.update(t-(s-e._duration/n)))}else e.update(t*i%1)}isDone(){return this._total===this._times}reverse(){const t=new SQ(this._innerAction.reverse(),this._times);return this._cloneDecoration(t),this._reverseEaseList(t),t}setInnerAction(t){this._innerAction!==t&&(this._innerAction=t)}getInnerAction(){return this._innerAction}}class TQ extends vQ{constructor(t){super(),this._innerAction=null,t&&this.initWithAction(t)}initWithAction(t){return t?(this._innerAction=t,!0):(C(1026),!1)}clone(){const t=new TQ;return this._cloneDecoration(t),t.initWithAction(this._innerAction.clone()),t}startWithTarget(t){vQ.prototype.startWithTarget.call(this,t),this._innerAction.startWithTarget(t)}step(t){const e=this._innerAction;e.step(t),e.isDone()&&(e.startWithTarget(this.target),e.step(e.getElapsed()-e._duration))}isDone(){return!1}reverse(){const t=new TQ(this._innerAction.reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t}setInnerAction(t){this._innerAction!==t&&(this._innerAction=t)}getInnerAction(){return this._innerAction}}class EQ extends vQ{constructor(t){super(),this._one=null,this._two=null;const e=t instanceof Array?t:arguments;if(1===e.length)return void C(1020);const n=e.length-1;if(n>=0&&null==e[n]&&S(1015),n>=0){let t,i=e[0];for(let s=1;s<n;s++)e[s]&&(t=i,i=EQ._actionOneTwo(t,e[s]));this.initWithTwoActions(i,e[n])}}initWithTwoActions(t,e){if(!t||!e)return C(1027),!1;let n=!1;const i=t._duration,s=e._duration;return this.initWithDuration(Math.max(i,s))&&(this._one=t,this._two=e,i>s?this._two=yQ._actionOneTwo(e,bQ(i-s)):i<s&&(this._one=yQ._actionOneTwo(t,bQ(s-i))),n=!0),n}clone(){const t=new EQ;return this._cloneDecoration(t),t.initWithTwoActions(this._one.clone(),this._two.clone()),t}startWithTarget(t){vQ.prototype.startWithTarget.call(this,t),this._one.startWithTarget(t),this._two.startWithTarget(t)}stop(){this._one.stop(),this._two.stop(),aQ.prototype.stop.call(this)}update(t){t=this._computeEaseTime(t),this._one&&this._one.update(t),this._two&&this._two.update(t)}reverse(){const t=EQ._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t}}function AQ(t){const e=t instanceof Array?t:arguments;if(1===e.length)return C(1020),null;e.length>0&&null==e[e.length-1]&&S(1015);let n=e[0];for(let t=1;t<e.length;t++)null!=e[t]&&(n=EQ._actionOneTwo(n,e[t]));return n}EQ._actionOneTwo=function(t,e){const n=new EQ;return n.initWithTwoActions(t,e),n};class CQ extends vQ{update(t){}reverse(){const t=new CQ(this._duration);return this._cloneDecoration(t),this._reverseEaseList(t),t}clone(){const t=new CQ;return this._cloneDecoration(t),t.initWithDuration(this._duration),t}}function bQ(t){return new CQ(t)}class PQ extends vQ{constructor(t){super(),this._other=null,t&&this.initWithAction(t)}initWithAction(t){return t?t===this._other?(C(1029),!1):!!vQ.prototype.initWithDuration.call(this,t._duration)&&(this._other=t,!0):(C(1028),!1)}clone(){const t=new PQ;return this._cloneDecoration(t),t.initWithAction(this._other.clone()),t}startWithTarget(t){vQ.prototype.startWithTarget.call(this,t),this._other.startWithTarget(t)}update(t){t=this._computeEaseTime(t),this._other&&this._other.update(1-t)}reverse(){return this._other.clone()}stop(){this._other.stop(),aQ.prototype.stop.call(this)}}class wQ extends vQ{constructor(t,e,n){if(super(),this._opts=void 0,this._props=void 0,this._originProps=void 0,null==n)n=Object.create(null);else if(function(t){const e=" [Tween:] ",n=` option is not support in v + ${s}`,i=t;i.delay&&d(`${e}delay${n}`),i.repeat&&d(`${e}repeat${n}`),i.repeatDelay&&d(`${e}repeatDelay${n}`),i.interpolation&&d(`${e}interpolation${n}`),i.onStop&&d(`${e}onStop${n}`)}(n),n.easing&&"string"==typeof n.easing&&(n.easing=function(t){const e=t.charAt(0);if(/[A-Z]/.test(e)){const n=(t=t.replace(e,e.toLowerCase())).split("-");if(2===n.length){const e=n[0];if("linear"===e)t="linear";else{const i=n[1];switch(e){case"quadratic":t=`quad${i}`;break;case"quartic":t=`quart${i}`;break;case"quintic":t=`quint${i}`;break;case"sinusoidal":t=`sine${i}`;break;case"exponential":t=`expo${i}`;break;case"circular":t=`circ${i}`;break;default:t=e+i}}}}return t}(n.easing)),n.progress||(n.progress=this.progress),n.easing&&"string"==typeof n.easing){const t=n.easing;n.easing=Fg[t],n.easing||E(1031,t)}this._opts=n,this._props=Object.create(null);for(const t in e){if(!e.hasOwnProperty(t))continue;let n,i,s=e[t];if(null==s||"string"==typeof s||"function"==typeof s)continue;void 0!==s.value&&(s.easing||s.progress)&&("string"==typeof s.easing?(n=Fg[s.easing],n||E(1031,s.easing)):n=s.easing,i=s.progress,s=s.value);const o=Object.create(null);o.value=s,o.easing=n,o.progress=i,this._props[t]=o}this._originProps=e,this.initWithDuration(t)}clone(){const t=new wQ(this._duration,this._originProps,this._opts);return this._cloneDecoration(t),t}startWithTarget(t){vQ.prototype.startWithTarget.call(this,t);const e=!!this._opts.relative,n=this._props;for(const i in n){const s=t[i];if(void 0===s)continue;const o=n[i],r=o.value;if("number"==typeof s)o.start=s,o.current=s,o.end=e?s+r:r;else if("object"==typeof s){null==o.start&&(o.start={},o.current={},o.end={});for(const t in r)isNaN(s[t])||(o.start[t]=s[t],o.current[t]=s[t],o.end[t]=e?s[t]+r[t]:r[t])}}this._opts.onStart&&this._opts.onStart(this.target)}update(t){const e=this.target;if(!e)return;const n=this._props,i=this._opts;let s=t;i.easing&&(s=i.easing(t));const o=i.progress;for(const i in n){const r=n[i],a=r.easing?r.easing(t):s,c=r.progress?r.progress:o,l=r.start,h=r.end;if("number"==typeof l)r.current=c(l,h,r.current,a);else if("object"==typeof l)for(const t in l)r.current[t]=c(l[t],h[t],r.current[t],a);e[i]=r.current}i.onUpdate&&i.onUpdate(this.target,t),1===t&&i.onComplete&&i.onComplete(this.target)}progress(t,e,n,i){return t+(e-t)*i}}class DQ extends dQ{constructor(t){super(),this._props=void 0,this._props={},void 0!==t&&this.init(t)}init(t){for(const e in t)this._props[e]=t[e];return!0}update(){const t=this._props,e=this.target;for(const n in t)e[n]=t[n]}clone(){const t=new DQ;return t.init(this._props),t}}class IQ{constructor(t){this._actions=[],this._finalAction=null,this._target=null,this._tag=aQ.TAG_INVALID,this._target=void 0===t?null:t}tag(t){return this._tag=t,this}then(t){return t instanceof aQ?this._actions.push(t.clone()):this._actions.push(t._union()),this}target(t){return this._target=t,this}start(){return this._target?(this._finalAction&&uQ.instance.ActionManager.removeAction(this._finalAction),this._finalAction=this._union(),this._finalAction.setTag(this._tag),uQ.instance.ActionManager.addAction(this._finalAction,this._target,!1),this):(d("Please set target to tween first"),this)}stop(){return this._finalAction&&uQ.instance.ActionManager.removeAction(this._finalAction),this}clone(t){const e=this._union();return RQ(t).then(e.clone())}union(){const t=this._union();return this._actions.length=0,this._actions.push(t),this}to(t,e,n){(n=n||Object.create(null)).relative=!1;const i=new wQ(t,e,n);return this._actions.push(i),this}by(t,e,n){(n=n||Object.create(null)).relative=!0;const i=new wQ(t,e,n);return this._actions.push(i),this}set(t){const e=new DQ(t);return this._actions.push(e),this}delay(t){const e=bQ(t);return this._actions.push(e),this}call(t){const e=new gQ(t,undefined,undefined);return this._actions.push(e),this}sequence(...t){const e=IQ._wrappedSequence(...t);return this._actions.push(e),this}parallel(...t){const e=IQ._wrappedParallel(...t);return this._actions.push(e),this}repeat(t,e){if(t==1/0)return this.repeatForever(e);const n=this._actions;let i;return i=e instanceof IQ?e._union():n.pop(),n.push(function(t,e){return new SQ(t,e)}(i,t)),this}repeatForever(t){const e=this._actions;let n;return n=t instanceof IQ?t._union():e.pop(),e.push(function(t){return new TQ(t)}(n)),this}reverseTime(t){const e=this._actions;let n;return n=t instanceof IQ?t._union():e.pop(),e.push(function(t){return new PQ(t)}(n)),this}hide(){const t=new fQ;return this._actions.push(t),this}show(){const t=new pQ;return this._actions.push(t),this}removeSelf(){const t=new mQ(!1);return this._actions.push(t),this}static stopAll(){uQ.instance.ActionManager.removeAllActions()}static stopAllByTag(t,e){uQ.instance.ActionManager.removeActionByTag(t,e)}static stopAllByTarget(t){uQ.instance.ActionManager.removeAllActionsFromTarget(t)}_union(){const t=this._actions;let e;return e=1===t.length?t[0]:xQ(t),e}_destroy(){this.stop()}static _wrappedSequence(...t){const e=IQ._tmp_args;e.length=0;for(let n=t.length,i=0;i<n;i++){const n=e[i]=t[i];n instanceof IQ&&(e[i]=n._union())}return xQ.apply(xQ,e)}static _wrappedParallel(...t){const e=IQ._tmp_args;e.length=0;for(let n=t.length,i=0;i<n;i++){const n=e[i]=t[i];n instanceof IQ&&(e[i]=n._union())}return AQ.apply(AQ,e)}}function RQ(t){return new IQ(t)}function OQ(t){return d("tweenUtil' is deprecated, please use 'tween' instead "),new IQ(t)}t("Tween",IQ),IQ._tmp_args=[],i.Tween=IQ,i.tween=RQ,i.tweenUtil=OQ;var MQ=Object.setPrototypeOf;let NQ={};NQ||(NQ={}),function(t){var e=function(){function e(n){this._clock=new t.WorldClock,this._events=[],this._objects=[],this._eventManager=null,this._eventManager=n,console.info("DragonBones: "+e.VERSION+"\nWebsite: http://dragonbones.com/\nSource and Demo: https://github.com/DragonBones/")}return e.prototype.advanceTime=function(e){if(this._objects.length>0){for(var n=0,i=this._objects;n<i.length;n++)i[n].returnToPool();this._objects.length=0}if(this._clock.advanceTime(e),this._events.length>0){for(var s=0;s<this._events.length;++s){var o=this._events[s],r=o.armature;null!==r._armatureData&&(r.eventDispatcher.dispatchDBEvent(o.type,o),o.type===t.EventObject.SOUND_EVENT&&this._eventManager.dispatchDBEvent(o.type,o)),this.bufferObject(o)}this._events.length=0}},e.prototype.bufferEvent=function(t){this._events.indexOf(t)<0&&this._events.push(t)},e.prototype.bufferObject=function(t){this._objects.indexOf(t)<0&&this._objects.push(t)},Object.defineProperty(e.prototype,"clock",{get:function(){return this._clock},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"eventManager",{get:function(){return this._eventManager},enumerable:!0,configurable:!0}),e.VERSION="5.6.300",e.yDown=!1,e.debug=!1,e.debugDraw=!1,e.webAssembly=!1,e}();t.DragonBones=e}(NQ||(NQ={})),console.warn||(console.warn=function(){}),console.assert||(console.assert=function(){}),Date.now||(Date.now=function(){return(new Date).getTime()}),MQ=function(t,e){function n(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);n.prototype=e.prototype,t.prototype=new n},function(t){var e=function(){function t(){this.hashCode=t._hashCode++,this._isInPool=!1}return t._returnObject=function(e){var n=String(e.constructor),i=n in t._maxCountMap?t._maxCountMap[n]:t._defaultMaxCount,s=t._poolsMap[n]=t._poolsMap[n]||[];s.length<i&&(e._isInPool?console.warn("The object is already in the pool."):(e._isInPool=!0,s.push(e)))},t.toString=function(){throw new Error},t.setMaxCount=function(e,n){if((n<0||n!=n)&&(n=0),null!==e)null!==(s=(i=String(e))in t._poolsMap?t._poolsMap[i]:null)&&s.length>n&&(s.length=n),t._maxCountMap[i]=n;else for(var i in t._defaultMaxCount=n,t._poolsMap){var s;(s=t._poolsMap[i]).length>n&&(s.length=n),i in t._maxCountMap&&(t._maxCountMap[i]=n)}},t.clearPool=function(e){if(void 0===e&&(e=null),null!==e){var n=String(e);null!==(s=n in t._poolsMap?t._poolsMap[n]:null)&&s.length>0&&(s.length=0)}else for(var i in t._poolsMap){var s;(s=t._poolsMap[i]).length=0}},t.borrowObject=function(e){var n=String(e),i=n in t._poolsMap?t._poolsMap[n]:null;if(null!==i&&i.length>0){var s=i.pop();return s._isInPool=!1,s}var o=new e;return o._onClear(),o},t.prototype.returnToPool=function(){this._onClear(),t._returnObject(this)},t._hashCode=0,t._defaultMaxCount=3e3,t._maxCountMap={},t._poolsMap={},t}();t.BaseObject=e}(NQ||(NQ={})),function(t){var e=function(){function t(t,e,n,i,s,o){void 0===t&&(t=1),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===s&&(s=0),void 0===o&&(o=0),this.a=t,this.b=e,this.c=n,this.d=i,this.tx=s,this.ty=o}return t.prototype.toString=function(){return"[object dragonBones.Matrix] a:"+this.a+" b:"+this.b+" c:"+this.c+" d:"+this.d+" tx:"+this.tx+" ty:"+this.ty},t.prototype.copyFrom=function(t){return this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.tx=t.tx,this.ty=t.ty,this},t.prototype.copyFromArray=function(t,e){return void 0===e&&(e=0),this.a=t[e],this.b=t[e+1],this.c=t[e+2],this.d=t[e+3],this.tx=t[e+4],this.ty=t[e+5],this},t.prototype.identity=function(){return this.a=this.d=1,this.b=this.c=0,this.tx=this.ty=0,this},t.prototype.concat=function(t){var e=this.a*t.a,n=0,i=0,s=this.d*t.d,o=this.tx*t.a+t.tx,r=this.ty*t.d+t.ty;return 0===this.b&&0===this.c||(e+=this.b*t.c,n+=this.b*t.d,i+=this.c*t.a,s+=this.c*t.b),0===t.b&&0===t.c||(n+=this.a*t.b,i+=this.d*t.c,o+=this.ty*t.c,r+=this.tx*t.b),this.a=e,this.b=n,this.c=i,this.d=s,this.tx=o,this.ty=r,this},t.prototype.invert=function(){var t=this.a,e=this.b,n=this.c,i=this.d,s=this.tx,o=this.ty;if(0===e&&0===n)return this.b=this.c=0,0===t||0===i?this.a=this.b=this.tx=this.ty=0:(t=this.a=1/t,i=this.d=1/i,this.tx=-t*s,this.ty=-i*o),this;var r=t*i-e*n;if(0===r)return this.a=this.d=1,this.b=this.c=0,this.tx=this.ty=0,this;r=1/r;var a=this.a=i*r;return e=this.b=-e*r,n=this.c=-n*r,i=this.d=t*r,this.tx=-(a*s+n*o),this.ty=-(e*s+i*o),this},t.prototype.transformPoint=function(t,e,n,i){void 0===i&&(i=!1),n.x=this.a*t+this.c*e,n.y=this.b*t+this.d*e,i||(n.x+=this.tx,n.y+=this.ty)},t.prototype.transformRectangle=function(t,e){void 0===e&&(e=!1);var n=this.a,i=this.b,s=this.c,o=this.d,r=e?0:this.tx,a=e?0:this.ty,c=t.x,l=t.y,h=c+t.width,_=l+t.height,u=n*c+s*l+r,d=i*c+o*l+a,p=n*h+s*l+r,f=i*h+o*l+a,m=n*h+s*_+r,g=i*h+o*_+a,v=n*c+s*_+r,y=i*c+o*_+a,x=0;u>p&&(x=u,u=p,p=x),m>v&&(x=m,m=v,v=x),t.x=Math.floor(u<m?u:m),t.width=Math.ceil((p>v?p:v)-t.x),d>f&&(x=d,d=f,f=x),g>y&&(x=g,g=y,y=x),t.y=Math.floor(d<g?d:g),t.height=Math.ceil((f>y?f:y)-t.y)},t}();t.Matrix=e}(NQ||(NQ={})),function(t){var e=function(){function t(t,e,n,i,s,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===s&&(s=1),void 0===o&&(o=1),this.x=t,this.y=e,this.skew=n,this.rotation=i,this.scaleX=s,this.scaleY=o}return t.normalizeRadian=function(t){return(t=(t+Math.PI)%(2*Math.PI))+(t>0?-Math.PI:Math.PI)},t.prototype.toString=function(){return"[object dragonBones.Transform] x:"+this.x+" y:"+this.y+" skewX:"+180*this.skew/Math.PI+" skewY:"+180*this.rotation/Math.PI+" scaleX:"+this.scaleX+" scaleY:"+this.scaleY},t.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.skew=t.skew,this.rotation=t.rotation,this.scaleX=t.scaleX,this.scaleY=t.scaleY,this},t.prototype.identity=function(){return this.x=this.y=0,this.skew=this.rotation=0,this.scaleX=this.scaleY=1,this},t.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this.skew+=t.skew,this.rotation+=t.rotation,this.scaleX*=t.scaleX,this.scaleY*=t.scaleY,this},t.prototype.minus=function(t){return this.x-=t.x,this.y-=t.y,this.skew-=t.skew,this.rotation-=t.rotation,this.scaleX/=t.scaleX,this.scaleY/=t.scaleY,this},t.prototype.fromMatrix=function(e){var n=this.scaleX,i=this.scaleY,s=t.PI_Q;this.x=e.tx,this.y=e.ty,this.rotation=Math.atan(e.b/e.a);var o=Math.atan(-e.c/e.d);return this.scaleX=this.rotation>-s&&this.rotation<s?e.a/Math.cos(this.rotation):e.b/Math.sin(this.rotation),this.scaleY=o>-s&&o<s?e.d/Math.cos(o):-e.c/Math.sin(o),n>=0&&this.scaleX<0&&(this.scaleX=-this.scaleX,this.rotation=this.rotation-Math.PI),i>=0&&this.scaleY<0&&(this.scaleY=-this.scaleY,o-=Math.PI),this.skew=o-this.rotation,this},t.prototype.toMatrix=function(t){return 0===this.rotation?(t.a=1,t.b=0):(t.a=Math.cos(this.rotation),t.b=Math.sin(this.rotation)),0===this.skew?(t.c=-t.b,t.d=t.a):(t.c=-Math.sin(this.skew+this.rotation),t.d=Math.cos(this.skew+this.rotation)),1!==this.scaleX&&(t.a*=this.scaleX,t.b*=this.scaleX),1!==this.scaleY&&(t.c*=this.scaleY,t.d*=this.scaleY),t.tx=this.x,t.ty=this.y,this},t.PI=Math.PI,t.PI_D=2*Math.PI,t.PI_H=Math.PI/2,t.PI_Q=Math.PI/4,t.RAD_DEG=180/Math.PI,t.DEG_RAD=Math.PI/180,t}();t.Transform=e}(NQ||(NQ={})),function(t){var e=function(){function t(t,e,n,i,s,o,r,a){void 0===t&&(t=1),void 0===e&&(e=1),void 0===n&&(n=1),void 0===i&&(i=1),void 0===s&&(s=0),void 0===o&&(o=0),void 0===r&&(r=0),void 0===a&&(a=0),this.alphaMultiplier=t,this.redMultiplier=e,this.greenMultiplier=n,this.blueMultiplier=i,this.alphaOffset=s,this.redOffset=o,this.greenOffset=r,this.blueOffset=a}return t.prototype.copyFrom=function(t){this.alphaMultiplier=t.alphaMultiplier,this.redMultiplier=t.redMultiplier,this.greenMultiplier=t.greenMultiplier,this.blueMultiplier=t.blueMultiplier,this.alphaOffset=t.alphaOffset,this.redOffset=t.redOffset,this.greenOffset=t.greenOffset,this.blueOffset=t.blueOffset},t.prototype.identity=function(){this.alphaMultiplier=this.redMultiplier=this.greenMultiplier=this.blueMultiplier=1,this.alphaOffset=this.redOffset=this.greenOffset=this.blueOffset=0},t}();t.ColorTransform=e}(NQ||(NQ={})),function(t){var e=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return t.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y},t.prototype.clear=function(){this.x=this.y=0},t}();t.Point=e}(NQ||(NQ={})),function(t){var e=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=t,this.y=e,this.width=n,this.height=i}return t.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height},t.prototype.clear=function(){this.x=this.y=0,this.width=this.height=0},t}();t.Rectangle=e}(NQ||(NQ={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.ints=[],e.floats=[],e.strings=[],e}return MQ(e,t),e.toString=function(){return"[class dragonBones.UserData]"},e.prototype._onClear=function(){this.ints.length=0,this.floats.length=0,this.strings.length=0},e.prototype.addInt=function(t){this.ints.push(t)},e.prototype.addFloat=function(t){this.floats.push(t)},e.prototype.addString=function(t){this.strings.push(t)},e.prototype.getInt=function(t){return void 0===t&&(t=0),t>=0&&t<this.ints.length?this.ints[t]:0},e.prototype.getFloat=function(t){return void 0===t&&(t=0),t>=0&&t<this.floats.length?this.floats[t]:0},e.prototype.getString=function(t){return void 0===t&&(t=0),t>=0&&t<this.strings.length?this.strings[t]:""},e}(t.BaseObject);t.UserData=e;var n=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.data=null,e}return MQ(e,t),e.toString=function(){return"[class dragonBones.ActionData]"},e.prototype._onClear=function(){null!==this.data&&this.data.returnToPool(),this.type=0,this.name="",this.bone=null,this.slot=null,this.data=null},e}(t.BaseObject);t.ActionData=n}(NQ||(NQ={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.frameIndices=[],e.cachedFrames=[],e.armatureNames=[],e.armatures={},e.userData=null,e}return MQ(e,t),e.toString=function(){return"[class dragonBones.DragonBonesData]"},e.prototype._onClear=function(){for(var t in this.armatures)this.armatures[t].returnToPool(),delete this.armatures[t];null!==this.userData&&this.userData.returnToPool(),this.autoSearch=!1,this.frameRate=0,this.version="",this.name="",this.stage=null,this.frameIndices.length=0,this.cachedFrames.length=0,this.armatureNames.length=0,this.binary=null,this.intArray=null,this.floatArray=null,this.frameIntArray=null,this.frameFloatArray=null,this.frameArray=null,this.timelineArray=null,this.userData=null},e.prototype.addArmature=function(t){t.name in this.armatures?console.warn("Same armature: "+t.name):(t.parent=this,this.armatures[t.name]=t,this.armatureNames.push(t.name))},e.prototype.getArmature=function(t){return t in this.armatures?this.armatures[t]:null},e.prototype.dispose=function(){console.warn(""),this.returnToPool()},e}(t.BaseObject);t.DragonBonesData=e}(NQ||(NQ={})),function(t){var e=function(e){function n(){var n=null!==e&&e.apply(this,arguments)||this;return n.aabb=new t.Rectangle,n.animationNames=[],n.sortedBones=[],n.sortedSlots=[],n.defaultActions=[],n.actions=[],n.bones={},n.slots={},n.constraints={},n.skins={},n.animations={},n.canvas=null,n.userData=null,n}return MQ(n,e),n.toString=function(){return"[class dragonBones.ArmatureData]"},n.prototype._onClear=function(){for(var t=0,e=this.defaultActions;t<e.length;t++)e[t].returnToPool();for(var n=0,i=this.actions;n<i.length;n++)i[n].returnToPool();for(var s in this.bones)this.bones[s].returnToPool(),delete this.bones[s];for(var s in this.slots)this.slots[s].returnToPool(),delete this.slots[s];for(var s in this.constraints)this.constraints[s].returnToPool(),delete this.constraints[s];for(var s in this.skins)this.skins[s].returnToPool(),delete this.skins[s];for(var s in this.animations)this.animations[s].returnToPool(),delete this.animations[s];null!==this.canvas&&this.canvas.returnToPool(),null!==this.userData&&this.userData.returnToPool(),this.type=0,this.frameRate=0,this.cacheFrameRate=0,this.scale=1,this.name="",this.aabb.clear(),this.animationNames.length=0,this.sortedBones.length=0,this.sortedSlots.length=0,this.defaultActions.length=0,this.actions.length=0,this.defaultSkin=null,this.defaultAnimation=null,this.canvas=null,this.userData=null,this.parent=null},n.prototype.sortBones=function(){var t=this.sortedBones.length;if(!(t<=0)){var e=this.sortedBones.concat(),n=0,i=0;for(this.sortedBones.length=0;i<t;){var s=e[n++];if(n>=t&&(n=0),!(this.sortedBones.indexOf(s)>=0)){var o=!1;for(var r in this.constraints){var a=this.constraints[r];if(a.root===s&&this.sortedBones.indexOf(a.target)<0){o=!0;break}}o||null!==s.parent&&this.sortedBones.indexOf(s.parent)<0||(this.sortedBones.push(s),i++)}}}},n.prototype.cacheFrames=function(t){if(!(this.cacheFrameRate>0))for(var e in this.cacheFrameRate=t,this.animations)this.animations[e].cacheFrames(this.cacheFrameRate)},n.prototype.setCacheFrame=function(t,e){var n=this.parent.cachedFrames,i=n.length;return n.length+=10,n[i]=t.a,n[i+1]=t.b,n[i+2]=t.c,n[i+3]=t.d,n[i+4]=t.tx,n[i+5]=t.ty,n[i+6]=e.rotation,n[i+7]=e.skew,n[i+8]=e.scaleX,n[i+9]=e.scaleY,i},n.prototype.getCacheFrame=function(t,e,n){var i=this.parent.cachedFrames;t.a=i[n],t.b=i[n+1],t.c=i[n+2],t.d=i[n+3],t.tx=i[n+4],t.ty=i[n+5],e.rotation=i[n+6],e.skew=i[n+7],e.scaleX=i[n+8],e.scaleY=i[n+9],e.x=t.tx,e.y=t.ty},n.prototype.addBone=function(t){t.name in this.bones?console.warn("Same bone: "+t.name):(this.bones[t.name]=t,this.sortedBones.push(t))},n.prototype.addSlot=function(t){t.name in this.slots?console.warn("Same slot: "+t.name):(this.slots[t.name]=t,this.sortedSlots.push(t))},n.prototype.addConstraint=function(t){t.name in this.constraints?console.warn("Same constraint: "+t.name):this.constraints[t.name]=t},n.prototype.addSkin=function(t){t.name in this.skins?console.warn("Same skin: "+t.name):(t.parent=this,this.skins[t.name]=t,null===this.defaultSkin&&(this.defaultSkin=t),"default"===t.name&&(this.defaultSkin=t))},n.prototype.addAnimation=function(t){t.name in this.animations?console.warn("Same animation: "+t.name):(t.parent=this,this.animations[t.name]=t,this.animationNames.push(t.name),null===this.defaultAnimation&&(this.defaultAnimation=t))},n.prototype.addAction=function(t,e){e?this.defaultActions.push(t):this.actions.push(t)},n.prototype.getBone=function(t){return t in this.bones?this.bones[t]:null},n.prototype.getSlot=function(t){return t in this.slots?this.slots[t]:null},n.prototype.getConstraint=function(t){return t in this.constraints?this.constraints[t]:null},n.prototype.getSkin=function(t){return t in this.skins?this.skins[t]:null},n.prototype.getMesh=function(t,e,n){var i=this.getSkin(t);return null===i?null:i.getDisplay(e,n)},n.prototype.getAnimation=function(t){return t in this.animations?this.animations[t]:null},n}(t.BaseObject);t.ArmatureData=e;var n=function(e){function n(){var n=null!==e&&e.apply(this,arguments)||this;return n.transform=new t.Transform,n.userData=null,n}return MQ(n,e),n.toString=function(){return"[class dragonBones.BoneData]"},n.prototype._onClear=function(){null!==this.userData&&this.userData.returnToPool(),this.inheritTranslation=!1,this.inheritRotation=!1,this.inheritScale=!1,this.inheritReflection=!1,this.type=0,this.length=0,this.name="",this.transform.identity(),this.userData=null,this.parent=null},n}(t.BaseObject);t.BoneData=n;var i=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.vertices=[],e}return MQ(e,t),e.toString=function(){return"[class dragonBones.SurfaceData]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=1,this.segmentX=0,this.segmentY=0,this.vertices.length=0},e}(n);t.SurfaceData=i;var s=function(e){function n(){var t=null!==e&&e.apply(this,arguments)||this;return t.color=null,t.userData=null,t}return MQ(n,e),n.createColor=function(){return new t.ColorTransform},n.toString=function(){return"[class dragonBones.SlotData]"},n.prototype._onClear=function(){null!==this.userData&&this.userData.returnToPool(),this.blendMode=0,this.displayIndex=0,this.zOrder=0,this.name="",this.color=null,this.userData=null,this.parent=null},n.DEFAULT_COLOR=new t.ColorTransform,n}(t.BaseObject);t.SlotData=s}(NQ||(NQ={})),function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return MQ(e,t),e.prototype._onClear=function(){this.order=0,this.name="",this.type=0,this.target=null,this.root=null,this.bone=null},e}(t.BaseObject);t.ConstraintData=e;var n=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return MQ(e,t),e.toString=function(){return"[class dragonBones.IKConstraintData]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.scaleEnabled=!1,this.bendPositive=!1,this.weight=1},e}(e);t.IKConstraintData=n;var i=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.bones=[],e}return MQ(e,t),e.toString=function(){return"[class dragonBones.PathConstraintData]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.pathSlot=null,this.pathDisplayData=null,this.bones.length=0,this.positionMode=0,this.spacingMode=1,this.rotateMode=1,this.position=0,this.spacing=0,this.rotateOffset=0,this.rotateMix=0,this.translateMix=0},e.prototype.AddBone=function(t){this.bones.push(t)},e}(e);t.PathConstraintData=i}(NQ||(NQ={})),function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return MQ(e,t),e.toString=function(){return"[class dragonBones.CanvasData]"},e.prototype._onClear=function(){this.hasBackground=!1,this.color=0,this.x=0,this.y=0,this.width=0,this.height=0},e}(t.BaseObject);t.CanvasData=e}(NQ||(NQ={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.displays={},e}return MQ(e,t),e.toString=function(){return"[class dragonBones.SkinData]"},e.prototype._onClear=function(){for(var t in this.displays){for(var e=0,n=this.displays[t];e<n.length;e++){var i=n[e];null!==i&&i.returnToPool()}delete this.displays[t]}this.name="",this.parent=null},e.prototype.addDisplay=function(t,e){t in this.displays||(this.displays[t]=[]),null!==e&&(e.parent=this),this.displays[t].push(e)},e.prototype.getDisplay=function(t,e){var n=this.getDisplays(t);if(null!==n)for(var i=0,s=n;i<s.length;i++){var o=s[i];if(null!==o&&o.name===e)return o}return null},e.prototype.getDisplays=function(t){return t in this.displays?this.displays[t]:null},e}(t.BaseObject);t.SkinData=e}(NQ||(NQ={})),function(t){var e=function(){function t(){this.weight=null}return t.prototype.clear=function(){this.isShared||null===this.weight||this.weight.returnToPool(),this.isShared=!1,this.inheritDeform=!1,this.offset=0,this.data=null,this.weight=null},t.prototype.shareFrom=function(t){this.isShared=!0,this.offset=t.offset,this.weight=t.weight},t}();t.VerticesData=e;var n=function(e){function n(){var n=null!==e&&e.apply(this,arguments)||this;return n.transform=new t.Transform,n}return MQ(n,e),n.prototype._onClear=function(){this.name="",this.path="",this.transform.identity(),this.parent=null},n}(t.BaseObject);t.DisplayData=n;var i=function(e){function n(){var n=null!==e&&e.apply(this,arguments)||this;return n.pivot=new t.Point,n}return MQ(n,e),n.toString=function(){return"[class dragonBones.ImageDisplayData]"},n.prototype._onClear=function(){e.prototype._onClear.call(this),this.type=0,this.pivot.clear(),this.texture=null},n}(n);t.ImageDisplayData=i;var s=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.actions=[],e}return MQ(e,t),e.toString=function(){return"[class dragonBones.ArmatureDisplayData]"},e.prototype._onClear=function(){t.prototype._onClear.call(this);for(var e=0,n=this.actions;e<n.length;e++)n[e].returnToPool();this.type=1,this.inheritAnimation=!1,this.actions.length=0,this.armature=null},e.prototype.addAction=function(t){this.actions.push(t)},e}(n);t.ArmatureDisplayData=s;var o=function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.vertices=new e,n}return MQ(n,t),n.toString=function(){return"[class dragonBones.MeshDisplayData]"},n.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=2,this.vertices.clear(),this.texture=null},n}(n);t.MeshDisplayData=o;var r=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.boundingBox=null,e}return MQ(e,t),e.toString=function(){return"[class dragonBones.BoundingBoxDisplayData]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),null!==this.boundingBox&&this.boundingBox.returnToPool(),this.type=3,this.boundingBox=null},e}(n);t.BoundingBoxDisplayData=r;var a=function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.vertices=new e,n.curveLengths=[],n}return MQ(n,t),n.toString=function(){return"[class dragonBones.PathDisplayData]"},n.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=4,this.closed=!1,this.constantSpeed=!1,this.vertices.clear(),this.curveLengths.length=0},n}(n);t.PathDisplayData=a;var c=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.bones=[],e}return MQ(e,t),e.toString=function(){return"[class dragonBones.WeightData]"},e.prototype._onClear=function(){this.count=0,this.offset=0,this.bones.length=0},e.prototype.addBone=function(t){this.bones.push(t)},e}(t.BaseObject);t.WeightData=c}(NQ||(NQ={})),function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return MQ(e,t),e.prototype._onClear=function(){this.color=0,this.width=0,this.height=0},e}(t.BaseObject);t.BoundingBoxData=e;var n=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return MQ(e,t),e.toString=function(){return"[class dragonBones.RectangleBoundingBoxData]"},e._computeOutCode=function(t,e,n,i,s,o){var r=0;return t<n?r|=1:t>s&&(r|=2),e<i?r|=4:e>o&&(r|=8),r},e.rectangleIntersectsSegment=function(t,n,i,s,o,r,a,c,l,h,_){void 0===l&&(l=null),void 0===h&&(h=null),void 0===_&&(_=null);var u=t>o&&t<a&&n>r&&n<c,d=i>o&&i<a&&s>r&&s<c;if(u&&d)return-1;for(var p=0,f=e._computeOutCode(t,n,o,r,a,c),m=e._computeOutCode(i,s,o,r,a,c);;){if(0==(f|m)){p=2;break}if(0!=(f&m))break;var g=0,v=0,y=0,x=0!==f?f:m;0!=(4&x)?(g=t+(i-t)*(r-n)/(s-n),v=r,null!==_&&(y=.5*-Math.PI)):0!=(8&x)?(g=t+(i-t)*(c-n)/(s-n),v=c,null!==_&&(y=.5*Math.PI)):0!=(2&x)?(v=n+(s-n)*(a-t)/(i-t),g=a,null!==_&&(y=0)):0!=(1&x)&&(v=n+(s-n)*(o-t)/(i-t),g=o,null!==_&&(y=Math.PI)),x===f?(t=g,n=v,f=e._computeOutCode(t,n,o,r,a,c),null!==_&&(_.x=y)):(i=g,s=v,m=e._computeOutCode(i,s,o,r,a,c),null!==_&&(_.y=y))}return p&&(u?(p=2,null!==l&&(l.x=i,l.y=s),null!==h&&(h.x=i,h.y=i),null!==_&&(_.x=_.y+Math.PI)):d?(p=1,null!==l&&(l.x=t,l.y=n),null!==h&&(h.x=t,h.y=n),null!==_&&(_.y=_.x+Math.PI)):(p=3,null!==l&&(l.x=t,l.y=n),null!==h&&(h.x=i,h.y=s))),p},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=0},e.prototype.containsPoint=function(t,e){var n=.5*this.width;if(t>=-n&&t<=n){var i=.5*this.height;if(e>=-i&&e<=i)return!0}return!1},e.prototype.intersectsSegment=function(t,n,i,s,o,r,a){void 0===o&&(o=null),void 0===r&&(r=null),void 0===a&&(a=null);var c=.5*this.width,l=.5*this.height;return e.rectangleIntersectsSegment(t,n,i,s,-c,-l,c,l,o,r,a)},e}(e);t.RectangleBoundingBoxData=n;var i=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return MQ(e,t),e.toString=function(){return"[class dragonBones.EllipseData]"},e.ellipseIntersectsSegment=function(t,e,n,i,s,o,r,a,c,l,h){void 0===c&&(c=null),void 0===l&&(l=null),void 0===h&&(h=null);var _=r/a,u=_*_,d=n-t,p=(i*=_)-(e*=_),f=Math.sqrt(d*d+p*p),m=d/f,g=p/f,v=(s-t)*m+(o-e)*g,y=r*r,x=y-(t*t+e*e)+v*v,S=0;if(x>=0){var T=Math.sqrt(x),E=v-T,A=v+T,C=E<0?-1:E<=f?0:1,b=A<0?-1:A<=f?0:1,P=C*b;if(P<0)return-1;0===P&&(-1===C?(S=2,n=t+A*m,i=(e+A*g)/_,null!==c&&(c.x=n,c.y=i),null!==l&&(l.x=n,l.y=i),null!==h&&(h.x=Math.atan2(i/y*u,n/y),h.y=h.x+Math.PI)):1===b?(S=1,t+=E*m,e=(e+E*g)/_,null!==c&&(c.x=t,c.y=e),null!==l&&(l.x=t,l.y=e),null!==h&&(h.x=Math.atan2(e/y*u,t/y),h.y=h.x+Math.PI)):(S=3,null!==c&&(c.x=t+E*m,c.y=(e+E*g)/_,null!==h&&(h.x=Math.atan2(c.y/y*u,c.x/y))),null!==l&&(l.x=t+A*m,l.y=(e+A*g)/_,null!==h&&(h.y=Math.atan2(l.y/y*u,l.x/y)))))}return S},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=1},e.prototype.containsPoint=function(t,e){var n=.5*this.width;if(t>=-n&&t<=n){var i=.5*this.height;if(e>=-i&&e<=i)return e*=n/i,Math.sqrt(t*t+e*e)<=n}return!1},e.prototype.intersectsSegment=function(t,n,i,s,o,r,a){return void 0===o&&(o=null),void 0===r&&(r=null),void 0===a&&(a=null),e.ellipseIntersectsSegment(t,n,i,s,0,0,.5*this.width,.5*this.height,o,r,a)},e}(e);t.EllipseBoundingBoxData=i;var s=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.vertices=[],e}return MQ(e,t),e.toString=function(){return"[class dragonBones.PolygonBoundingBoxData]"},e.polygonIntersectsSegment=function(t,e,n,i,s,o,r,a){void 0===o&&(o=null),void 0===r&&(r=null),void 0===a&&(a=null),t===n&&(t=n+1e-6),e===i&&(e=i+1e-6);for(var c=s.length,l=t-n,h=e-i,_=t*i-e*n,u=0,d=s[c-2],p=s[c-1],f=0,m=0,g=0,v=0,y=0,x=0,S=0;S<c;S+=2){var T=s[S],E=s[S+1];d===T&&(d=T+1e-4),p===E&&(p=E+1e-4);var A=d-T,C=p-E,b=d*E-p*T,P=l*C-h*A,w=(_*A-l*b)/P;if((w>=d&&w<=T||w>=T&&w<=d)&&(0===l||w>=t&&w<=n||w>=n&&w<=t)){var D=(_*C-h*b)/P;if((D>=p&&D<=E||D>=E&&D<=p)&&(0===h||D>=e&&D<=i||D>=i&&D<=e)){if(null===r){g=w,v=D,y=w,x=D,u++,null!==a&&(a.x=Math.atan2(E-p,T-d)-.5*Math.PI,a.y=a.x);break}var I=w-t;I<0&&(I=-I),0===u?(f=I,m=I,g=w,v=D,y=w,x=D,null!==a&&(a.x=Math.atan2(E-p,T-d)-.5*Math.PI,a.y=a.x)):(I<f&&(f=I,g=w,v=D,null!==a&&(a.x=Math.atan2(E-p,T-d)-.5*Math.PI)),I>m&&(m=I,y=w,x=D,null!==a&&(a.y=Math.atan2(E-p,T-d)-.5*Math.PI))),u++}}d=T,p=E}return 1===u?(null!==o&&(o.x=g,o.y=v),null!==r&&(r.x=g,r.y=v),null!==a&&(a.y=a.x+Math.PI)):u>1&&(u++,null!==o&&(o.x=g,o.y=v),null!==r&&(r.x=y,r.y=x)),u},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=2,this.x=0,this.y=0,this.vertices.length=0},e.prototype.containsPoint=function(t,e){var n=!1;if(t>=this.x&&t<=this.width&&e>=this.y&&e<=this.height)for(var i=0,s=this.vertices.length,o=s-2;i<s;i+=2){var r=this.vertices[o+1],a=this.vertices[i+1];if(a<e&&r>=e||r<e&&a>=e){var c=this.vertices[o],l=this.vertices[i];(e-a)*(c-l)/(r-a)+l<t&&(n=!n)}o=i}return n},e.prototype.intersectsSegment=function(t,i,s,o,r,a,c){void 0===r&&(r=null),void 0===a&&(a=null),void 0===c&&(c=null);var l=0;return 0!==n.rectangleIntersectsSegment(t,i,s,o,this.x,this.y,this.x+this.width,this.y+this.height,null,null,null)&&(l=e.polygonIntersectsSegment(t,i,s,o,this.vertices,r,a,c)),l},e}(e);t.PolygonBoundingBoxData=s}(NQ||(NQ={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.cachedFrames=[],e.boneTimelines={},e.surfaceTimelines={},e.slotTimelines={},e.constraintTimelines={},e.animationTimelines={},e.boneCachedFrameIndices={},e.slotCachedFrameIndices={},e.actionTimeline=null,e.zOrderTimeline=null,e}return MQ(e,t),e.toString=function(){return"[class dragonBones.AnimationData]"},e.prototype._onClear=function(){for(var t in this.boneTimelines){for(var e=0,n=this.boneTimelines[t];e<n.length;e++)n[e].returnToPool();delete this.boneTimelines[t]}for(var t in this.surfaceTimelines){for(var i=0,s=this.surfaceTimelines[t];i<s.length;i++)s[i].returnToPool();delete this.surfaceTimelines[t]}for(var t in this.slotTimelines){for(var o=0,r=this.slotTimelines[t];o<r.length;o++)r[o].returnToPool();delete this.slotTimelines[t]}for(var t in this.constraintTimelines){for(var a=0,c=this.constraintTimelines[t];a<c.length;a++)c[a].returnToPool();delete this.constraintTimelines[t]}for(var t in this.animationTimelines){for(var l=0,h=this.animationTimelines[t];l<h.length;l++)h[l].returnToPool();delete this.animationTimelines[t]}for(var t in this.boneCachedFrameIndices)delete this.boneCachedFrameIndices[t];for(var t in this.slotCachedFrameIndices)delete this.slotCachedFrameIndices[t];null!==this.actionTimeline&&this.actionTimeline.returnToPool(),null!==this.zOrderTimeline&&this.zOrderTimeline.returnToPool(),this.frameIntOffset=0,this.frameFloatOffset=0,this.frameOffset=0,this.frameCount=0,this.playTimes=0,this.duration=0,this.scale=1,this.fadeInTime=0,this.cacheFrameRate=0,this.name="",this.cachedFrames.length=0,this.actionTimeline=null,this.zOrderTimeline=null,this.parent=null},e.prototype.cacheFrames=function(t){if(!(this.cacheFrameRate>0)){this.cacheFrameRate=Math.max(Math.ceil(t*this.scale),1);var e=Math.ceil(this.cacheFrameRate*this.duration)+1;this.cachedFrames.length=e;for(var n=0,i=this.cacheFrames.length;n<i;++n)this.cachedFrames[n]=!1;for(var s=0,o=this.parent.sortedBones;s<o.length;s++){var r=o[s];for(n=0,i=(l=new Array(e)).length;n<i;++n)l[n]=-1;this.boneCachedFrameIndices[r.name]=l}for(var a=0,c=this.parent.sortedSlots;a<c.length;a++){var l,h=c[a];for(n=0,i=(l=new Array(e)).length;n<i;++n)l[n]=-1;this.slotCachedFrameIndices[h.name]=l}}},e.prototype.addBoneTimeline=function(t,e){var n=t.name in this.boneTimelines?this.boneTimelines[t.name]:this.boneTimelines[t.name]=[];n.indexOf(e)<0&&n.push(e)},e.prototype.addSurfaceTimeline=function(t,e){var n=t.name in this.surfaceTimelines?this.surfaceTimelines[t.name]:this.surfaceTimelines[t.name]=[];n.indexOf(e)<0&&n.push(e)},e.prototype.addSlotTimeline=function(t,e){var n=t.name in this.slotTimelines?this.slotTimelines[t.name]:this.slotTimelines[t.name]=[];n.indexOf(e)<0&&n.push(e)},e.prototype.addConstraintTimeline=function(t,e){var n=t.name in this.constraintTimelines?this.constraintTimelines[t.name]:this.constraintTimelines[t.name]=[];n.indexOf(e)<0&&n.push(e)},e.prototype.addAnimationTimeline=function(t,e){var n=t in this.animationTimelines?this.animationTimelines[t]:this.animationTimelines[t]=[];n.indexOf(e)<0&&n.push(e)},e.prototype.getBoneTimelines=function(t){return t in this.boneTimelines?this.boneTimelines[t]:null},e.prototype.getSurfaceTimelines=function(t){return t in this.surfaceTimelines?this.surfaceTimelines[t]:null},e.prototype.getSlotTimelines=function(t){return t in this.slotTimelines?this.slotTimelines[t]:null},e.prototype.getConstraintTimelines=function(t){return t in this.constraintTimelines?this.constraintTimelines[t]:null},e.prototype.getAnimationTimelines=function(t){return t in this.animationTimelines?this.animationTimelines[t]:null},e.prototype.getBoneCachedFrameIndices=function(t){return t in this.boneCachedFrameIndices?this.boneCachedFrameIndices[t]:null},e.prototype.getSlotCachedFrameIndices=function(t){return t in this.slotCachedFrameIndices?this.slotCachedFrameIndices[t]:null},e}(t.BaseObject);t.AnimationData=e;var n=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return MQ(e,t),e.toString=function(){return"[class dragonBones.TimelineData]"},e.prototype._onClear=function(){this.type=10,this.offset=0,this.frameIndicesOffset=-1},e}(t.BaseObject);t.TimelineData=n}(NQ||(NQ={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.boneMask=[],e}return MQ(e,t),e.toString=function(){return"[class dragonBones.AnimationConfig]"},e.prototype._onClear=function(){this.pauseFadeOut=!0,this.fadeOutMode=4,this.fadeOutTweenType=1,this.fadeOutTime=-1,this.actionEnabled=!0,this.additiveBlending=!1,this.displayControl=!0,this.pauseFadeIn=!0,this.resetToPose=!0,this.fadeInTweenType=1,this.playTimes=-1,this.layer=0,this.position=0,this.duration=-1,this.timeScale=-100,this.weight=1,this.fadeInTime=-1,this.autoFadeOutTime=-1,this.name="",this.animation="",this.group="",this.boneMask.length=0},e.prototype.clear=function(){this._onClear()},e.prototype.copyFrom=function(t){this.pauseFadeOut=t.pauseFadeOut,this.fadeOutMode=t.fadeOutMode,this.autoFadeOutTime=t.autoFadeOutTime,this.fadeOutTweenType=t.fadeOutTweenType,this.actionEnabled=t.actionEnabled,this.additiveBlending=t.additiveBlending,this.displayControl=t.displayControl,this.pauseFadeIn=t.pauseFadeIn,this.resetToPose=t.resetToPose,this.playTimes=t.playTimes,this.layer=t.layer,this.position=t.position,this.duration=t.duration,this.timeScale=t.timeScale,this.fadeInTime=t.fadeInTime,this.fadeOutTime=t.fadeOutTime,this.fadeInTweenType=t.fadeInTweenType,this.weight=t.weight,this.name=t.name,this.animation=t.animation,this.group=t.group,this.boneMask.length=t.boneMask.length;for(var e=0,n=this.boneMask.length;e<n;++e)this.boneMask[e]=t.boneMask[e]},e.prototype.containsBoneMask=function(t){return 0===this.boneMask.length||this.boneMask.indexOf(t)>=0},e.prototype.addBoneMask=function(t,e,n){void 0===n&&(n=!0);var i=t.getBone(e);if(null!==i&&(this.boneMask.indexOf(e)<0&&this.boneMask.push(e),n))for(var s=0,o=t.getBones();s<o.length;s++){var r=o[s];this.boneMask.indexOf(r.name)<0&&i.contains(r)&&this.boneMask.push(r.name)}},e.prototype.removeBoneMask=function(t,e,n){void 0===n&&(n=!0);var i=this.boneMask.indexOf(e);if(i>=0&&this.boneMask.splice(i,1),n){var s=t.getBone(e);if(null!==s)if(this.boneMask.length>0)for(var o=0,r=t.getBones();o<r.length;o++){var a=r[o],c=this.boneMask.indexOf(a.name);c>=0&&s.contains(a)&&this.boneMask.splice(c,1)}else for(var l=0,h=t.getBones();l<h.length;l++)(a=h[l])!==s&&(s.contains(a)||this.boneMask.push(a.name))}},e}(t.BaseObject);t.AnimationConfig=e}(NQ||(NQ={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.textures={},e}return MQ(e,t),e.prototype._onClear=function(){for(var t in this.textures)this.textures[t].returnToPool(),delete this.textures[t];this.autoSearch=!1,this.width=0,this.height=0,this.scale=1,this.name="",this.imagePath=""},e.prototype.copyFrom=function(t){for(var e in this.autoSearch=t.autoSearch,this.scale=t.scale,this.width=t.width,this.height=t.height,this.name=t.name,this.imagePath=t.imagePath,this.textures)this.textures[e].returnToPool(),delete this.textures[e];for(var e in t.textures){var n=this.createTexture();n.copyFrom(t.textures[e]),this.textures[e]=n}},e.prototype.addTexture=function(t){t.name in this.textures?console.warn("Same texture: "+t.name):(t.parent=this,this.textures[t.name]=t)},e.prototype.getTexture=function(t){return t in this.textures?this.textures[t]:null},e}(t.BaseObject);t.TextureAtlasData=e;var n=function(e){function n(){var n=null!==e&&e.apply(this,arguments)||this;return n.region=new t.Rectangle,n.frame=null,n}return MQ(n,e),n.createRectangle=function(){return new t.Rectangle},n.prototype._onClear=function(){this.rotated=!1,this.name="",this.region.clear(),this.parent=null,this.frame=null},n.prototype.copyFrom=function(t){this.rotated=t.rotated,this.name=t.name,this.region.copyFrom(t.region),this.parent=t.parent,null===this.frame&&null!==t.frame?this.frame=n.createRectangle():null!==this.frame&&null===t.frame&&(this.frame=null),null!==this.frame&&null!==t.frame&&this.frame.copyFrom(t.frame)},n}(t.BaseObject);t.TextureData=n}(NQ||(NQ={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.vertices=[],e.bones=[],e}return MQ(e,t),e.toString=function(){return"[class dragonBones.DeformVertices]"},e.prototype._onClear=function(){this.verticesDirty=!1,this.vertices.length=0,this.bones.length=0,this.verticesData=null},e.prototype.init=function(t,e){if(this.verticesData=t,null!==this.verticesData){var n;n=null!==this.verticesData.weight?2*this.verticesData.weight.count:2*this.verticesData.data.intArray[this.verticesData.offset+0],this.verticesDirty=!0,this.vertices.length=n,this.bones.length=0;for(var i=0,s=this.vertices.length;i<s;++i)this.vertices[i]=0;if(null!==this.verticesData.weight)for(i=0,s=this.verticesData.weight.bones.length;i<s;++i){var o=e.getBone(this.verticesData.weight.bones[i].name);this.bones.push(o)}}else this.verticesDirty=!1,this.vertices.length=0,this.bones.length=0,this.verticesData=null},e.prototype.isBonesUpdate=function(){for(var t=0,e=this.bones;t<e.length;t++){var n=e[t];if(null!==n&&n._childrenTransformDirty)return!0}return!1},e}(t.BaseObject);t.DeformVertices=e}(NQ||(NQ={})),function(t){var e=function(e){function n(){var t=null!==e&&e.apply(this,arguments)||this;return t._bones=[],t._slots=[],t._constraints=[],t._actions=[],t._animation=null,t._proxy=null,t._replaceTextureAtlasData=null,t._clock=null,t}return MQ(n,e),n.toString=function(){return"[class dragonBones.Armature]"},n._onSortSlots=function(t,e){return t._zOrder>e._zOrder?1:-1},n.prototype._onClear=function(){null!==this._clock&&this._clock.remove(this);for(var t=0,e=this._bones;t<e.length;t++)e[t].returnToPool();for(var n=0,i=this._slots;n<i.length;n++)i[n].returnToPool();for(var s=0,o=this._constraints;s<o.length;s++)o[s].returnToPool();for(var r=0,a=this._actions;r<a.length;r++)a[r].returnToPool();null!==this._animation&&this._animation.returnToPool(),null!==this._proxy&&this._proxy.dbClear(),null!==this._replaceTextureAtlasData&&this._replaceTextureAtlasData.returnToPool(),this.inheritAnimation=!0,this.userData=null,this._lockUpdate=!1,this._slotsDirty=!0,this._zOrderDirty=!1,this._flipX=!1,this._flipY=!1,this._cacheFrameIndex=-1,this._bones.length=0,this._slots.length=0,this._constraints.length=0,this._actions.length=0,this._armatureData=null,this._animation=null,this._proxy=null,this._display=null,this._replaceTextureAtlasData=null,this._replacedTexture=null,this._dragonBones=null,this._clock=null,this._parent=null},n.prototype._sortZOrder=function(t,e){var n=this._armatureData.sortedSlots,i=null===t;if(this._zOrderDirty||!i){for(var s=0,o=n.length;s<o;++s){var r=i?s:t[e+s];if(!(r<0||r>=o)){var a=n[r],c=this.getSlot(a.name);null!==c&&c._setZorder(s)}}this._slotsDirty=!0,this._zOrderDirty=!i}},n.prototype._addBone=function(t){this._bones.indexOf(t)<0&&this._bones.push(t)},n.prototype._addSlot=function(t){this._slots.indexOf(t)<0&&this._slots.push(t)},n.prototype._addConstraint=function(t){this._constraints.indexOf(t)<0&&this._constraints.push(t)},n.prototype._bufferAction=function(t,e){this._actions.indexOf(t)<0&&(e?this._actions.push(t):this._actions.unshift(t))},n.prototype.dispose=function(){null!==this._armatureData&&(this._lockUpdate=!0,this._dragonBones.bufferObject(this))},n.prototype.init=function(e,n,i,s){null===this._armatureData&&(this._armatureData=e,this._animation=t.BaseObject.borrowObject(t.Animation),this._proxy=n,this._display=i,this._dragonBones=s,this._proxy.dbInit(this),this._animation.init(this),this._animation.animations=this._armatureData.animations)},n.prototype.advanceTime=function(t){if(!this._lockUpdate)if(null!==this._armatureData)if(null!==this._armatureData.parent){var e=this._cacheFrameIndex;if(this._animation.advanceTime(t),this._slotsDirty&&(this._slotsDirty=!1,this._slots.sort(n._onSortSlots)),this._cacheFrameIndex<0||this._cacheFrameIndex!==e){var i=0,s=0;for(i=0,s=this._bones.length;i<s;++i)this._bones[i].update(this._cacheFrameIndex);for(i=0,s=this._slots.length;i<s;++i)this._slots[i].update(this._cacheFrameIndex)}if(this._actions.length>0){this._lockUpdate=!0;for(var o=0,r=this._actions;o<r.length;o++){var a=r[o],c=a.actionData;if(null!==c&&0===c.type)if(null!==a.slot)null!==(_=a.slot.childArmature)&&_.animation.fadeIn(c.name);else if(null!==a.bone)for(var l=0,h=this.getSlots();l<h.length;l++){var _,u=h[l];u.parent===a.bone&&null!==(_=u.childArmature)&&_.animation.fadeIn(c.name)}else this._animation.fadeIn(c.name);a.returnToPool()}this._actions.length=0,this._lockUpdate=!1}this._proxy.dbUpdate()}else console.warn("The armature data has been disposed.\nPlease make sure dispose armature before call factory.clear().");else console.warn("The armature has been disposed.")},n.prototype.invalidUpdate=function(t,e){if(void 0===t&&(t=null),void 0===e&&(e=!1),null!==t&&t.length>0){if(null!==(r=this.getBone(t))&&(r.invalidUpdate(),e))for(var n=0,i=this._slots;n<i.length;n++)(l=i[n]).parent===r&&l.invalidUpdate()}else{for(var s=0,o=this._bones;s<o.length;s++){var r;(r=o[s]).invalidUpdate()}if(e)for(var a=0,c=this._slots;a<c.length;a++){var l;(l=c[a]).invalidUpdate()}}},n.prototype.containsPoint=function(t,e){for(var n=0,i=this._slots;n<i.length;n++){var s=i[n];if(s.containsPoint(t,e))return s}return null},n.prototype.intersectsSegment=function(t,e,n,i,s,o,r){void 0===s&&(s=null),void 0===o&&(o=null),void 0===r&&(r=null);for(var a=t===n,c=0,l=0,h=0,_=0,u=0,d=0,p=0,f=0,m=null,g=null,v=0,y=this._slots;v<y.length;v++){var x=y[v];if(x.intersectsSegment(t,e,n,i,s,o,r)>0){if(null===s&&null===o){m=x;break}var S;null!==s&&((S=a?s.y-e:s.x-t)<0&&(S=-S),(null===m||S<c)&&(c=S,h=s.x,_=s.y,m=x,r&&(p=r.x))),null!==o&&((S=o.x-t)<0&&(S=-S),(null===g||S>l)&&(l=S,u=o.x,d=o.y,g=x,null!==r&&(f=r.y)))}}return null!==m&&null!==s&&(s.x=h,s.y=_,null!==r&&(r.x=p)),null!==g&&null!==o&&(o.x=u,o.y=d,null!==r&&(r.y=f)),m},n.prototype.getBone=function(t){for(var e=0,n=this._bones;e<n.length;e++){var i=n[e];if(i.name===t)return i}return null},n.prototype.getBoneByDisplay=function(t){var e=this.getSlotByDisplay(t);return null!==e?e.parent:null},n.prototype.getSlot=function(t){for(var e=0,n=this._slots;e<n.length;e++){var i=n[e];if(i.name===t)return i}return null},n.prototype.getSlotByDisplay=function(t){if(null!==t)for(var e=0,n=this._slots;e<n.length;e++){var i=n[e];if(i.display===t)return i}return null},n.prototype.getBones=function(){return this._bones},n.prototype.getSlots=function(){return this._slots},Object.defineProperty(n.prototype,"flipX",{get:function(){return this._flipX},set:function(t){this._flipX!==t&&(this._flipX=t,this.invalidUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"flipY",{get:function(){return this._flipY},set:function(t){this._flipY!==t&&(this._flipY=t,this.invalidUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"cacheFrameRate",{get:function(){return this._armatureData.cacheFrameRate},set:function(t){if(this._armatureData.cacheFrameRate!==t){this._armatureData.cacheFrames(t);for(var e=0,n=this._slots;e<n.length;e++){var i=n[e].childArmature;null!==i&&(i.cacheFrameRate=t)}}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"name",{get:function(){return this._armatureData.name},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"armatureData",{get:function(){return this._armatureData},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"animation",{get:function(){return this._animation},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"proxy",{get:function(){return this._proxy},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"eventDispatcher",{get:function(){return this._proxy},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"display",{get:function(){return this._display},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"replacedTexture",{get:function(){return this._replacedTexture},set:function(t){if(this._replacedTexture!==t){null!==this._replaceTextureAtlasData&&(this._replaceTextureAtlasData.returnToPool(),this._replaceTextureAtlasData=null),this._replacedTexture=t;for(var e=0,n=this._slots;e<n.length;e++){var i=n[e];i.invalidUpdate(),i.update(-1)}}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"clock",{get:function(){return this._clock},set:function(t){if(this._clock!==t){null!==this._clock&&this._clock.remove(this),this._clock=t,this._clock&&this._clock.add(this);for(var e=0,n=this._slots;e<n.length;e++){var i=n[e].childArmature;null!==i&&(i.clock=this._clock)}}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),n.prototype.replaceTexture=function(t){this.replacedTexture=t},n.prototype.hasEventListener=function(t){return this._proxy.hasDBEventListener(t)},n.prototype.addEventListener=function(t,e,n){this._proxy.addDBEventListener(t,e,n)},n.prototype.removeEventListener=function(t,e,n){this._proxy.removeDBEventListener(t,e,n)},n.prototype.enableAnimationCache=function(t){console.warn("Deprecated."),this.cacheFrameRate=t},n.prototype.getDisplay=function(){return this._display},n}(t.BaseObject);t.Armature=e}(NQ||(NQ={})),function(t){var e=function(e){function n(){var n=null!==e&&e.apply(this,arguments)||this;return n.globalTransformMatrix=new t.Matrix,n.global=new t.Transform,n.offset=new t.Transform,n}return MQ(n,e),n.prototype._onClear=function(){this.globalTransformMatrix.identity(),this.global.identity(),this.offset.identity(),this.origin=null,this.userData=null,this._globalDirty=!1,this._armature=null},n.prototype.updateGlobalTransform=function(){this._globalDirty&&(this._globalDirty=!1,this.global.fromMatrix(this.globalTransformMatrix))},Object.defineProperty(n.prototype,"armature",{get:function(){return this._armature},enumerable:!0,configurable:!0}),n._helpMatrix=new t.Matrix,n._helpTransform=new t.Transform,n._helpPoint=new t.Point,n}(t.BaseObject);t.TransformObject=e}(NQ||(NQ={})),function(t){var e=function(e){function n(){var n=null!==e&&e.apply(this,arguments)||this;return n.animationPose=new t.Transform,n._blendState=new t.BlendState,n}return MQ(n,e),n.toString=function(){return"[class dragonBones.Bone]"},n.prototype._onClear=function(){e.prototype._onClear.call(this),this.offsetMode=1,this.animationPose.identity(),this._transformDirty=!1,this._childrenTransformDirty=!1,this._localDirty=!0,this._hasConstraint=!1,this._visible=!0,this._cachedFrameIndex=-1,this._blendState.clear(),this._boneData=null,this._parent=null,this._cachedFrameIndices=null},n.prototype._updateGlobalTransformMatrix=function(e){var n=this._boneData,i=this.global,s=this.globalTransformMatrix,o=this.origin,r=this.offset,a=this.animationPose,c=this._parent,l=this._armature.flipX,h=this._armature.flipY===t.DragonBones.yDown,_=null!==c,u=0;if(1===this.offsetMode?null!==o?(i.x=o.x+r.x+a.x,i.scaleX=o.scaleX*r.scaleX*a.scaleX,i.scaleY=o.scaleY*r.scaleY*a.scaleY,t.DragonBones.yDown?(i.y=o.y+r.y+a.y,i.skew=o.skew+r.skew+a.skew,i.rotation=o.rotation+r.rotation+a.rotation):(i.y=o.y-r.y+a.y,i.skew=o.skew-r.skew+a.skew,i.rotation=o.rotation-r.rotation+a.rotation)):(i.copyFrom(r),t.DragonBones.yDown||(i.y=-i.y,i.skew=-i.skew,i.rotation=-i.rotation),i.add(a)):0===this.offsetMode?null!==o?i.copyFrom(o).add(a):i.copyFrom(a):(_=!1,i.copyFrom(r),t.DragonBones.yDown||(i.y=-i.y,i.skew=-i.skew,i.rotation=-i.rotation)),_){var d=0===c._boneData.type?c.globalTransformMatrix:c._getGlobalTransformMatrix(i.x,i.y);if(n.inheritScale)n.inheritRotation||(c.updateGlobalTransform(),u=l&&h?i.rotation-(c.global.rotation+Math.PI):l?i.rotation+c.global.rotation+Math.PI:h?i.rotation+c.global.rotation:i.rotation-c.global.rotation,i.rotation=u),i.toMatrix(s),s.concat(d),n.inheritTranslation?(i.x=s.tx,i.y=s.ty):(s.tx=i.x,s.ty=i.y),e?i.fromMatrix(s):this._globalDirty=!0;else{if(n.inheritTranslation){var p=i.x,f=i.y;i.x=d.a*p+d.c*f+d.tx,i.y=d.b*p+d.d*f+d.ty}else l&&(i.x=-i.x),h&&(i.y=-i.y);n.inheritRotation?(c.updateGlobalTransform(),u=c.global.scaleX<0?i.rotation+c.global.rotation+Math.PI:i.rotation+c.global.rotation,d.a*d.d-d.b*d.c<0&&(u-=2*i.rotation,(l!==h||n.inheritReflection)&&(i.skew+=Math.PI),t.DragonBones.yDown||(i.skew=-i.skew)),i.rotation=u):(l||h)&&(l&&h?u=i.rotation+Math.PI:(u=l?Math.PI-i.rotation:-i.rotation,i.skew+=Math.PI),i.rotation=u),i.toMatrix(s)}}else(l||h)&&(l&&(i.x=-i.x),h&&(i.y=-i.y),l&&h?u=i.rotation+Math.PI:(u=l?Math.PI-i.rotation:-i.rotation,i.skew+=Math.PI),i.rotation=u),i.toMatrix(s)},n.prototype.init=function(t,e){null===this._boneData&&(this._boneData=t,this._armature=e,null!==this._boneData.parent&&(this._parent=this._armature.getBone(this._boneData.parent.name)),this._armature._addBone(this),this.origin=this._boneData.transform)},n.prototype.update=function(t){if(this._blendState.dirty=!1,t>=0&&null!==this._cachedFrameIndices){var e=this._cachedFrameIndices[t];if(e>=0&&this._cachedFrameIndex===e)this._transformDirty=!1;else if(e>=0)this._transformDirty=!0,this._cachedFrameIndex=e;else{if(this._hasConstraint)for(var n=0,i=this._armature._constraints;n<i.length;n++)(r=i[n])._root===this&&r.update();this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty?(this._transformDirty=!0,this._cachedFrameIndex=-1):this._cachedFrameIndex>=0?(this._transformDirty=!1,this._cachedFrameIndices[t]=this._cachedFrameIndex):(this._transformDirty=!0,this._cachedFrameIndex=-1)}}else{if(this._hasConstraint)for(var s=0,o=this._armature._constraints;s<o.length;s++){var r;(r=o[s])._root===this&&r.update()}(this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty)&&(t=-1,this._transformDirty=!0,this._cachedFrameIndex=-1)}if(this._transformDirty)if(this._transformDirty=!1,this._childrenTransformDirty=!0,this._cachedFrameIndex<0){var a=t>=0;this._localDirty&&this._updateGlobalTransformMatrix(a),a&&null!==this._cachedFrameIndices&&(this._cachedFrameIndex=this._cachedFrameIndices[t]=this._armature._armatureData.setCacheFrame(this.globalTransformMatrix,this.global))}else this._armature._armatureData.getCacheFrame(this.globalTransformMatrix,this.global,this._cachedFrameIndex);else this._childrenTransformDirty&&(this._childrenTransformDirty=!1);this._localDirty=!0},n.prototype.updateByConstraint=function(){this._localDirty&&(this._localDirty=!1,(this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty)&&this._updateGlobalTransformMatrix(!0),this._transformDirty=!0)},n.prototype.invalidUpdate=function(){this._transformDirty=!0},n.prototype.contains=function(t){if(t===this)return!1;for(var e=t;e!==this&&null!==e;)e=e.parent;return e===this},Object.defineProperty(n.prototype,"boneData",{get:function(){return this._boneData},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"visible",{get:function(){return this._visible},set:function(t){if(this._visible!==t){this._visible=t;for(var e=0,n=this._armature.getSlots();e<n.length;e++){var i=n[e];i.parent===this&&i._updateVisible()}}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"name",{get:function(){return this._boneData.name},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),n.prototype.getBones=function(){console.warn("Deprecated.");for(var t=new Array,e=0,n=this._armature.getBones();e<n.length;e++){var i=n[e];i.parent===this&&t.push(i)}return t},n.prototype.getSlots=function(){console.warn("Deprecated.");for(var t=new Array,e=0,n=this._armature.getSlots();e<n.length;e++){var i=n[e];i.parent===this&&t.push(i)}return t},Object.defineProperty(n.prototype,"slot",{get:function(){console.warn("Deprecated.");for(var t=0,e=this._armature.getSlots();t<e.length;t++){var n=e[t];if(n.parent===this)return n}return null},enumerable:!0,configurable:!0}),n}(t.TransformObject);t.Bone=e}(NQ||(NQ={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._vertices=[],e._deformVertices=[],e._hullCache=[],e._matrixCahce=[],e}return MQ(e,t),e.toString=function(){return"[class dragonBones.Surface]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this._dX=0,this._dY=0,this._k=0,this._kX=0,this._kY=0,this._vertices.length=0,this._deformVertices.length=0,this._matrixCahce.length=0,this._hullCache.length=0},e.prototype._getAffineTransform=function(t,e,n,i,s,o,r,a,c,l,h,_,u){var d=r-s,p=a-o,f=c-s,m=l-o;h.rotation=Math.atan2(p,d),h.skew=Math.atan2(m,f)-.5*Math.PI-h.rotation,u&&(h.rotation+=Math.PI),h.scaleX=Math.sqrt(d*d+p*p)/n,h.scaleY=Math.sqrt(f*f+m*m)/i,h.toMatrix(_),h.x=_.tx=s-(_.a*t+_.c*e),h.y=_.ty=o-(_.b*t+_.d*e)},e.prototype._updateVertices=function(){var t=this._boneData.vertices,e=this._vertices,n=this._deformVertices;if(null!==this._parent)if(1===this._parent._boneData.type)for(var i=0,s=t.length;i<s;i+=2){var o=t[i]+n[i],r=t[i+1]+n[i],a=this._parent._getGlobalTransformMatrix(o,r);e[i]=a.a*o+a.c*r+a.tx,e[i+1]=a.b*o+a.d*r+a.ty}else{var c=this._parent.globalTransformMatrix;for(i=0,s=t.length;i<s;i+=2)o=t[i]+n[i],r=t[i+1]+n[i+1],e[i]=c.a*o+c.c*r+c.tx,e[i+1]=c.b*o+c.d*r+c.ty}else for(i=0,s=t.length;i<s;i+=2)e[i]=t[i]+n[i],e[i+1]=t[i+1]+n[i+1]},e.prototype._updateGlobalTransformMatrix=function(){var t=2*this._boneData.segmentX,e=this._vertices.length-2,n=this._vertices[0],i=this._vertices[1],s=this._vertices[t],o=this._vertices[t+1],r=this._vertices[e],a=this._vertices[e+1],c=this._vertices[e-t],l=this._vertices[e-t+1],h=n+.5*(r-n),_=i+.5*(a-i),u=h+.5*(s+.5*(c-s)-h),d=_+.5*(o+.5*(l-o)-_),p=s+.5*(r-s),f=o+.5*(a-o),m=c+.5*(r-c),g=l+.5*(a-l);this._globalDirty=!1,this._getAffineTransform(0,0,200,200,u,d,p,f,m,g,this.global,this.globalTransformMatrix,!1)},e.prototype._getGlobalTransformMatrix=function(t,n){var i=1e3;if(t<-i||i<t||n<-i||i<n)return this.globalTransformMatrix;var s=!1,o=200,r=this._boneData,a=r.segmentX,c=r.segmentY,l=2*r.segmentX,h=this._dX,_=this._dY,u=Math.floor((t+o)/h),d=Math.floor((n+o)/_),p=0,f=u*h-o,m=d*_-o,g=this._matrixCahce,v=e._helpMatrix;if(t<-o){if(n<-o||n>=o)return this.globalTransformMatrix;if(p=7*(2*(a*(c+1)+2*a+c+d)+((s=n>this._kX*(t+o)+m)?1:0)),this._matrixCahce[p]>0)v.copyFromArray(g,p+1);else{var y=d*(l+2),x=this._hullCache[4],S=this._hullCache[5],T=this._hullCache[2]-(c-d)*x,E=this._hullCache[3]-(c-d)*S,A=this._vertices;s?this._getAffineTransform(-o,m+_,800,_,A[y+l+2],A[y+l+3],T+x,E+S,A[y],A[y+1],e._helpTransform,v,!0):this._getAffineTransform(-i,m,800,_,T,E,A[y],A[y+1],T+x,E+S,e._helpTransform,v,!1),g[p]=1,g[p+1]=v.a,g[p+2]=v.b,g[p+3]=v.c,g[p+4]=v.d,g[p+5]=v.tx,g[p+6]=v.ty}}else if(t>=o){if(n<-o||n>=o)return this.globalTransformMatrix;p=7*(2*(a*(c+1)+a+d)+((s=n>this._kX*(t-i)+m)?1:0)),this._matrixCahce[p]>0?v.copyFromArray(g,p+1):(y=(d+1)*(l+2)-2,x=this._hullCache[4],S=this._hullCache[5],T=this._hullCache[0]+d*x,E=this._hullCache[1]+d*S,A=this._vertices,s?this._getAffineTransform(i,m+_,800,_,T+x,E+S,A[y+l+2],A[y+l+3],T,E,e._helpTransform,v,!0):this._getAffineTransform(o,m,800,_,A[y],A[y+1],T,E,A[y+l+2],A[y+l+3],e._helpTransform,v,!1),g[p]=1,g[p+1]=v.a,g[p+2]=v.b,g[p+3]=v.c,g[p+4]=v.d,g[p+5]=v.tx,g[p+6]=v.ty)}else if(n<-o){if(t<-o||t>=o)return this.globalTransformMatrix;p=7*(a*(c+1)+2*u+((s=n>this._kY*(t-f-h)-i)?1:0)),this._matrixCahce[p]>0?v.copyFromArray(g,p+1):(y=2*u,x=this._hullCache[10],S=this._hullCache[11],T=this._hullCache[8]+u*x,E=this._hullCache[9]+u*S,A=this._vertices,s?this._getAffineTransform(f+h,-o,h,800,A[y+2],A[y+3],A[y],A[y+1],T+x,E+S,e._helpTransform,v,!0):this._getAffineTransform(f,-i,h,800,T,E,T+x,E+S,A[y],A[y+1],e._helpTransform,v,!1),g[p]=1,g[p+1]=v.a,g[p+2]=v.b,g[p+3]=v.c,g[p+4]=v.d,g[p+5]=v.tx,g[p+6]=v.ty)}else if(n>=o){if(t<-o||t>=o)return this.globalTransformMatrix;p=7*(2*(a*(c+1)+a+c+d)+((s=n>this._kY*(t-f-h)+o)?1:0)),this._matrixCahce[p]>0?v.copyFromArray(g,p+1):(y=c*(l+2)+2*u,x=this._hullCache[10],S=this._hullCache[11],T=this._hullCache[6]-(a-u)*x,E=this._hullCache[7]-(a-u)*S,A=this._vertices,s?this._getAffineTransform(f+h,i,h,800,T+x,E+S,T,E,A[y+2],A[y+3],e._helpTransform,v,!0):this._getAffineTransform(f,o,h,800,A[y],A[y+1],A[y+2],A[y+3],T,E,e._helpTransform,v,!1),g[p]=1,g[p+1]=v.a,g[p+2]=v.b,g[p+3]=v.c,g[p+4]=v.d,g[p+5]=v.tx,g[p+6]=v.ty)}else p=7*(2*(a*d+u)+((s=n>this._k*(t-f-h)+m)?1:0)),this._matrixCahce[p]>0?v.copyFromArray(g,p+1):(y=2*u+d*(l+2),A=this._vertices,s?this._getAffineTransform(f+h,m+_,h,_,A[y+l+4],A[y+l+5],A[y+l+2],A[y+l+3],A[y+2],A[y+3],e._helpTransform,v,!0):this._getAffineTransform(f,m,h,_,A[y],A[y+1],A[y+2],A[y+3],A[y+l+2],A[y+l+3],e._helpTransform,v,!1),g[p]=1,g[p+1]=v.a,g[p+2]=v.b,g[p+3]=v.c,g[p+4]=v.d,g[p+5]=v.tx,g[p+6]=v.ty);return v},e.prototype.init=function(e,n){if(null===this._boneData){t.prototype.init.call(this,e,n);var i=e.segmentX,s=e.segmentY,o=e.vertices.length;this._dX=400/i,this._dY=400/s,this._k=-this._dY/this._dX,this._kX=-this._dY/800,this._kY=-800/this._dX,this._vertices.length=o,this._deformVertices.length=o,this._matrixCahce.length=14*(i*s+2*i+2*s),this._hullCache.length=10;for(var r=0;r<o;++r)this._deformVertices[r]=0}},e.prototype.update=function(t){if(this._blendState.dirty=!1,t>=0&&null!==this._cachedFrameIndices){var n=this._cachedFrameIndices[t];if(n>=0&&this._cachedFrameIndex===n)this._transformDirty=!1;else if(n>=0)this._transformDirty=!0,this._cachedFrameIndex=n;else{if(this._hasConstraint)for(var i=0,s=this._armature._constraints;i<s.length;i++)(a=s[i])._root===this&&a.update();this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty?(this._transformDirty=!0,this._cachedFrameIndex=-1):this._cachedFrameIndex>=0?(this._transformDirty=!1,this._cachedFrameIndices[t]=this._cachedFrameIndex):(this._transformDirty=!0,this._cachedFrameIndex=-1)}}else{if(this._hasConstraint)for(var o=0,r=this._armature._constraints;o<r.length;o++){var a;(a=r[o])._root===this&&a.update()}(this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty)&&(t=-1,this._transformDirty=!0,this._cachedFrameIndex=-1)}if(this._transformDirty){this._transformDirty=!1,this._childrenTransformDirty=!0;for(var c=0,l=this._matrixCahce.length;c<l;c+=7)this._matrixCahce[c]=-1;if(this._updateVertices(),this._cachedFrameIndex<0){var h=t>=0;this._localDirty&&this._updateGlobalTransformMatrix(h),h&&null!==this._cachedFrameIndices&&(this._cachedFrameIndex=this._cachedFrameIndices[t]=this._armature._armatureData.setCacheFrame(this.globalTransformMatrix,this.global))}else this._armature._armatureData.getCacheFrame(this.globalTransformMatrix,this.global,this._cachedFrameIndex);var _=2*this.global.x,u=2*this.global.y,d=e._helpPoint;this.globalTransformMatrix.transformPoint(1e3,-200,d),this._hullCache[0]=d.x,this._hullCache[1]=d.y,this._hullCache[2]=_-d.x,this._hullCache[3]=u-d.y,this.globalTransformMatrix.transformPoint(0,this._dY,d,!0),this._hullCache[4]=d.x,this._hullCache[5]=d.y,this.globalTransformMatrix.transformPoint(200,1e3,d),this._hullCache[6]=d.x,this._hullCache[7]=d.y,this._hullCache[8]=_-d.x,this._hullCache[9]=u-d.y,this.globalTransformMatrix.transformPoint(this._dX,0,d,!0),this._hullCache[10]=d.x,this._hullCache[11]=d.y}else this._childrenTransformDirty&&(this._childrenTransformDirty=!1);this._localDirty=!0},e}(t.Bone);t.Surface=e}(NQ||(NQ={})),function(t){var e=function(e){function n(){var n=null!==e&&e.apply(this,arguments)||this;return n._localMatrix=new t.Matrix,n._colorTransform=new t.ColorTransform,n._displayDatas=[],n._displayList=[],n._deformVertices=null,n._rawDisplay=null,n._meshDisplay=null,n}return MQ(n,e),n.prototype._onClear=function(){e.prototype._onClear.call(this);for(var n=[],i=0,s=this._displayList;i<s.length;i++)null!==(a=s[i])&&a!==this._rawDisplay&&a!==this._meshDisplay&&n.indexOf(a)<0&&n.push(a);for(var o=0,r=n;o<r.length;o++){var a;(a=r[o])instanceof t.Armature?a.dispose():this._disposeDisplay(a,!0)}null!==this._deformVertices&&this._deformVertices.returnToPool(),null!==this._meshDisplay&&this._meshDisplay!==this._rawDisplay&&this._disposeDisplay(this._meshDisplay,!1),null!==this._rawDisplay&&this._disposeDisplay(this._rawDisplay,!1),this.displayController=null,this._displayDirty=!1,this._zOrderDirty=!1,this._blendModeDirty=!1,this._colorDirty=!1,this._transformDirty=!1,this._visible=!0,this._blendMode=0,this._displayIndex=-1,this._animationDisplayIndex=-1,this._zOrder=0,this._cachedFrameIndex=-1,this._pivotX=0,this._pivotY=0,this._localMatrix.identity(),this._colorTransform.identity(),this._displayList.length=0,this._displayDatas.length=0,this._slotData=null,this._rawDisplayDatas=null,this._displayData=null,this._boundingBoxData=null,this._textureData=null,this._deformVertices=null,this._rawDisplay=null,this._meshDisplay=null,this._display=null,this._childArmature=null,this._parent=null,this._cachedFrameIndices=null},n.prototype._getDefaultRawDisplayData=function(t){var e=this._armature._armatureData.defaultSkin;if(null!==e){var n=e.getDisplays(this._slotData.name);if(null!==n)return t<n.length?n[t]:null}return null},n.prototype._updateDisplayData=function(){var e=this._displayData,i=null!==this._deformVertices?this._deformVertices.verticesData:null,s=this._textureData,o=null,r=null;if(this._displayData=null,this._boundingBoxData=null,this._textureData=null,this._displayIndex>=0&&(null!==this._rawDisplayDatas&&(o=this._displayIndex<this._rawDisplayDatas.length?this._rawDisplayDatas[this._displayIndex]:null),null===o&&(o=this._getDefaultRawDisplayData(this._displayIndex)),this._displayIndex<this._displayDatas.length&&(this._displayData=this._displayDatas[this._displayIndex])),null!==this._displayData&&(2===this._displayData.type||4===this._displayData.type?r=this._displayData.vertices:null!==o&&(2===o.type||4===o.type)&&(r=o.vertices),3===this._displayData.type?this._boundingBoxData=this._displayData.boundingBox:null!==o&&3===o.type&&(this._boundingBoxData=o.boundingBox),(0===this._displayData.type||2===this._displayData.type)&&(this._textureData=this._displayData.texture)),this._displayData!==e||r!==i||this._textureData!==s){if(null===r&&null!==this._textureData){var a=this._displayData,c=this._textureData.parent.scale*this._armature._armatureData.scale,l=this._textureData.frame;this._pivotX=a.pivot.x,this._pivotY=a.pivot.y;var h=null!==l?l:this._textureData.region,_=h.width,u=h.height;this._textureData.rotated&&null===l&&(_=h.height,u=h.width),this._pivotX*=_*c,this._pivotY*=u*c,null!==l&&(this._pivotX+=l.x*c,this._pivotY+=l.y*c),null!==this._displayData&&null!==o&&this._displayData!==o&&(o.transform.toMatrix(n._helpMatrix),n._helpMatrix.invert(),n._helpMatrix.transformPoint(0,0,n._helpPoint),this._pivotX-=n._helpPoint.x,this._pivotY-=n._helpPoint.y,this._displayData.transform.toMatrix(n._helpMatrix),n._helpMatrix.invert(),n._helpMatrix.transformPoint(0,0,n._helpPoint),this._pivotX+=n._helpPoint.x,this._pivotY+=n._helpPoint.y),t.DragonBones.yDown||(this._pivotY=(this._textureData.rotated?this._textureData.region.width:this._textureData.region.height)*c-this._pivotY)}else this._pivotX=0,this._pivotY=0;null!==o?this.origin=o.transform:null!==this._displayData?this.origin=this._displayData.transform:this.origin=null,r!==i?(null===this._deformVertices&&(this._deformVertices=t.BaseObject.borrowObject(t.DeformVertices)),this._deformVertices.init(r,this._armature)):null!==this._deformVertices&&this._textureData!==s&&(this._deformVertices.verticesDirty=!0),this._displayDirty=!0,this._transformDirty=!0}},n.prototype._updateDisplay=function(){var e=null!==this._display?this._display:this._rawDisplay,n=this._childArmature;this._displayIndex>=0&&this._displayIndex<this._displayList.length?(this._display=this._displayList[this._displayIndex],null!==this._display&&this._display instanceof t.Armature?(this._childArmature=this._display,this._display=this._childArmature.display):this._childArmature=null):(this._display=null,this._childArmature=null);var i=null!==this._display?this._display:this._rawDisplay;if(i!==e&&(this._onUpdateDisplay(),this._replaceDisplay(e),this._transformDirty=!0,this._visibleDirty=!0,this._blendModeDirty=!0,this._colorDirty=!0),i!==this._rawDisplay&&i!==this._meshDisplay||this._updateFrame(),this._childArmature!==n&&(null!==n&&(n._parent=null,n.clock=null,n.inheritAnimation&&n.animation.reset()),null!==this._childArmature&&(this._childArmature._parent=this,this._childArmature.clock=this._armature.clock,this._childArmature.inheritAnimation))){if(0===this._childArmature.cacheFrameRate){var s=this._armature.cacheFrameRate;0!==s&&(this._childArmature.cacheFrameRate=s)}var o=null;if(null!==this._displayData&&1===this._displayData.type)o=this._displayData.actions;else if(this._displayIndex>=0&&null!==this._rawDisplayDatas){var r=this._displayIndex<this._rawDisplayDatas.length?this._rawDisplayDatas[this._displayIndex]:null;null===r&&(r=this._getDefaultRawDisplayData(this._displayIndex)),null!==r&&1===r.type&&(o=r.actions)}if(null!==o&&o.length>0)for(var a=0,c=o;a<c.length;a++){var l=c[a],h=t.BaseObject.borrowObject(t.EventObject);t.EventObject.actionDataToInstance(l,h,this._armature),h.slot=this,this._armature._bufferAction(h,!1)}else this._childArmature.animation.play()}},n.prototype._updateGlobalTransformMatrix=function(t){var e=0===this._parent._boneData.type?this._parent.globalTransformMatrix:this._parent._getGlobalTransformMatrix(this.global.x,this.global.y);this.globalTransformMatrix.copyFrom(this._localMatrix),this.globalTransformMatrix.concat(e),t?this.global.fromMatrix(this.globalTransformMatrix):this._globalDirty=!0},n.prototype._setDisplayIndex=function(t,e){if(void 0===e&&(e=!1),e){if(this._animationDisplayIndex===t)return!1;this._animationDisplayIndex=t}return this._displayIndex!==t&&(this._displayIndex=t,this._displayDirty=!0,this._updateDisplayData(),this._displayDirty)},n.prototype._setZorder=function(t){return this._zOrder,this._zOrder=t,this._zOrderDirty=!0,this._zOrderDirty},n.prototype._setColor=function(t){return this._colorTransform.copyFrom(t),this._colorDirty=!0,this._colorDirty},n.prototype._setDisplayList=function(e){if(null!==e&&e.length>0){this._displayList.length!==e.length&&(this._displayList.length=e.length);for(var n=0,i=e.length;n<i;++n){var s=e[n];null!==s&&s!==this._rawDisplay&&s!==this._meshDisplay&&!(s instanceof t.Armature)&&this._displayList.indexOf(s)<0&&this._initDisplay(s,!0),this._displayList[n]=s}}else this._displayList.length>0&&(this._displayList.length=0);return this._displayIndex>=0&&this._displayIndex<this._displayList.length?this._displayDirty=this._display!==this._displayList[this._displayIndex]:this._displayDirty=null!==this._display,this._updateDisplayData(),this._displayDirty},n.prototype.init=function(t,e,n,i){if(null===this._slotData){this._slotData=t,this._isFromCache=!1,this._visibleDirty=!0,this._blendModeDirty=!0,this._colorDirty=!0,this._blendMode=this._slotData.blendMode,this._zOrder=this._slotData.zOrder,this._colorTransform.copyFrom(this._slotData.color),this._rawDisplay=n,this._meshDisplay=i,this._armature=e;var s=this._armature.getBone(this._slotData.parent.name);null!==s&&(this._parent=s),this._armature._addSlot(this),this._initDisplay(this._rawDisplay,!1),this._rawDisplay!==this._meshDisplay&&this._initDisplay(this._meshDisplay,!1),this._onUpdateDisplay(),this._addDisplay()}},n.prototype.update=function(t){if(this._isFromCache=!1,this._displayDirty&&(this._displayDirty=!1,this._updateDisplay(),this._transformDirty&&(null!==this.origin?this.global.copyFrom(this.origin).add(this.offset).toMatrix(this._localMatrix):this.global.copyFrom(this.offset).toMatrix(this._localMatrix))),this._zOrderDirty&&(this._zOrderDirty=!1,this._updateZOrder()),t>=0&&null!==this._cachedFrameIndices){var e=this._cachedFrameIndices[t];e>=0&&this._cachedFrameIndex===e?this._transformDirty=!1:e>=0?(this._transformDirty=!0,this._cachedFrameIndex=e):this._transformDirty||this._parent._childrenTransformDirty?(this._transformDirty=!0,this._cachedFrameIndex=-1):this._cachedFrameIndex>=0?(this._transformDirty=!1,this._cachedFrameIndices[t]=this._cachedFrameIndex):(this._transformDirty=!0,this._cachedFrameIndex=-1)}else(this._transformDirty||this._parent._childrenTransformDirty)&&(t=-1,this._transformDirty=!0,this._cachedFrameIndex=-1);if(null!==this._display){if(this._visibleDirty&&(this._visibleDirty=!1,this._updateVisible()),this._blendModeDirty&&(this._blendModeDirty=!1,this._updateBlendMode()),this._colorDirty&&(this._colorDirty=!1,this._updateColor()),null!==this._deformVertices&&null!==this._deformVertices.verticesData&&this._display===this._meshDisplay){var n=null!==this._deformVertices.verticesData.weight,i=0!==this._parent._boneData.type;if((this._deformVertices.verticesDirty||n&&this._deformVertices.isBonesUpdate()||i&&this._parent._childrenTransformDirty)&&(this._deformVertices.verticesDirty=!1,this._updateMesh()),n||i)return}if(this._transformDirty){if(this._transformDirty=!1,this._cachedFrameIndex<0){var s=t>=0;this._updateGlobalTransformMatrix(s),s&&null!==this._cachedFrameIndices&&(this._cachedFrameIndex=this._cachedFrameIndices[t]=this._armature._armatureData.setCacheFrame(this.globalTransformMatrix,this.global))}else this._isFromCache=!0,this._armature._armatureData.getCacheFrame(this.globalTransformMatrix,this.global,this._cachedFrameIndex);this._updateTransform()}}},n.prototype.updateTransformAndMatrix=function(){this._transformDirty&&(this._transformDirty=!1,this._updateGlobalTransformMatrix(!1))},n.prototype.replaceDisplayData=function(t,e){if(void 0===e&&(e=-1),e<0&&(e=this._displayIndex<0?0:this._displayIndex),this._displayDatas.length<=e){this._displayDatas.length=e+1;for(var n=0,i=this._displayDatas.length;n<i;++n)this._displayDatas[n]||(this._displayDatas[n]=null)}this._displayDatas[e]=t},n.prototype.containsPoint=function(t,e){return null!==this._boundingBoxData&&(this.updateTransformAndMatrix(),n._helpMatrix.copyFrom(this.globalTransformMatrix),n._helpMatrix.invert(),n._helpMatrix.transformPoint(t,e,n._helpPoint),this._boundingBoxData.containsPoint(n._helpPoint.x,n._helpPoint.y))},n.prototype.intersectsSegment=function(t,e,i,s,o,r,a){if(void 0===o&&(o=null),void 0===r&&(r=null),void 0===a&&(a=null),null===this._boundingBoxData)return 0;this.updateTransformAndMatrix(),n._helpMatrix.copyFrom(this.globalTransformMatrix),n._helpMatrix.invert(),n._helpMatrix.transformPoint(t,e,n._helpPoint),t=n._helpPoint.x,e=n._helpPoint.y,n._helpMatrix.transformPoint(i,s,n._helpPoint),i=n._helpPoint.x,s=n._helpPoint.y;var c=this._boundingBoxData.intersectsSegment(t,e,i,s,o,r,a);return c>0&&(1===c||2===c?null!==o?(this.globalTransformMatrix.transformPoint(o.x,o.y,o),null!==r&&(r.x=o.x,r.y=o.y)):null!==r&&this.globalTransformMatrix.transformPoint(r.x,r.y,r):(null!==o&&this.globalTransformMatrix.transformPoint(o.x,o.y,o),null!==r&&this.globalTransformMatrix.transformPoint(r.x,r.y,r)),null!==a&&(this.globalTransformMatrix.transformPoint(Math.cos(a.x),Math.sin(a.x),n._helpPoint,!0),a.x=Math.atan2(n._helpPoint.y,n._helpPoint.x),this.globalTransformMatrix.transformPoint(Math.cos(a.y),Math.sin(a.y),n._helpPoint,!0),a.y=Math.atan2(n._helpPoint.y,n._helpPoint.x))),c},n.prototype.invalidUpdate=function(){this._displayDirty=!0,this._transformDirty=!0},Object.defineProperty(n.prototype,"visible",{get:function(){return this._visible},set:function(t){this._visible!==t&&(this._visible=t,this._updateVisible())},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"displayIndex",{get:function(){return this._displayIndex},set:function(t){this._setDisplayIndex(t)&&this.update(-1)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"name",{get:function(){return this._slotData.name},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"displayList",{get:function(){return this._displayList.concat()},set:function(e){var n=this._displayList.concat(),i=new Array;this._setDisplayList(e)&&this.update(-1);for(var s=0,o=n;s<o.length;s++)null!==(c=o[s])&&c!==this._rawDisplay&&c!==this._meshDisplay&&this._displayList.indexOf(c)<0&&i.indexOf(c)<0&&i.push(c);for(var r=0,a=i;r<a.length;r++){var c;(c=a[r])instanceof t.Armature||this._disposeDisplay(c,!0)}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"slotData",{get:function(){return this._slotData},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"rawDisplayDatas",{get:function(){return this._rawDisplayDatas},set:function(t){if(this._rawDisplayDatas!==t)if(this._displayDirty=!0,this._rawDisplayDatas=t,null!==this._rawDisplayDatas){this._displayDatas.length=this._rawDisplayDatas.length;for(var e=0,n=this._displayDatas.length;e<n;++e){var i=this._rawDisplayDatas[e];null===i&&(i=this._getDefaultRawDisplayData(e)),this._displayDatas[e]=i}}else this._displayDatas.length=0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"displayData",{get:function(){return this._displayData},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"boundingBoxData",{get:function(){return this._boundingBoxData},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"rawDisplay",{get:function(){return this._rawDisplay},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"meshDisplay",{get:function(){return this._meshDisplay},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"display",{get:function(){return this._display},set:function(t){if(this._display!==t){var e=this._displayList.length;if(this._displayIndex<0&&0===e&&(this._displayIndex=0),!(this._displayIndex<0)){var n=this.displayList;e<=this._displayIndex&&(n.length=this._displayIndex+1),n[this._displayIndex]=t,this.displayList=n}}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"childArmature",{get:function(){return this._childArmature},set:function(t){this._childArmature!==t&&(this.display=t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),n.prototype.getDisplay=function(){return this._display},n.prototype.setDisplay=function(t){this.display=t},n}(t.TransformObject);t.Slot=e}(NQ||(NQ={})),function(t){var e=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return MQ(n,e),n.prototype._onClear=function(){this._armature=null,this._target=null,this._root=null,this._bone=null},Object.defineProperty(n.prototype,"name",{get:function(){return this._constraintData.name},enumerable:!0,configurable:!0}),n._helpMatrix=new t.Matrix,n._helpTransform=new t.Transform,n._helpPoint=new t.Point,n}(t.BaseObject);t.Constraint=e;var n=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return MQ(n,e),n.toString=function(){return"[class dragonBones.IKConstraint]"},n.prototype._onClear=function(){e.prototype._onClear.call(this),this._scaleEnabled=!1,this._bendPositive=!1,this._weight=1,this._constraintData=null},n.prototype._computeA=function(){var e=this._target.global,n=this._root.global,i=this._root.globalTransformMatrix,s=Math.atan2(e.y-n.y,e.x-n.x);n.scaleX<0&&(s+=Math.PI),n.rotation+=t.Transform.normalizeRadian(s-n.rotation)*this._weight,n.toMatrix(i)},n.prototype._computeB=function(){var e=this._bone._boneData.length,n=this._root,i=this._target.global,s=n.global,o=this._bone.global,r=this._bone.globalTransformMatrix,a=r.a*e,c=r.b*e,l=a*a+c*c,h=Math.sqrt(l),_=o.x-s.x,u=o.y-s.y,d=_*_+u*u,p=Math.sqrt(d),f=o.rotation,m=s.rotation,g=Math.atan2(u,_),v=(_=i.x-s.x)*_+(u=i.y-s.y)*u,y=Math.sqrt(v),x=0;if(h+p<=y||y+h<=p||y+p<=h)x=Math.atan2(i.y-s.y,i.x-s.x),h+p<=y||p<h&&(x+=Math.PI);else{var S=(d-l+v)/(2*v),T=Math.sqrt(d-S*S*v)/y,E=s.x+_*S,A=s.y+u*S,C=-u*T,b=_*T,P=!1,w=n.parent;if(null!==w){var D=w.globalTransformMatrix;P=D.a*D.d-D.b*D.c<0}P!==this._bendPositive?(o.x=E-C,o.y=A-b):(o.x=E+C,o.y=A+b),x=Math.atan2(o.y-s.y,o.x-s.x)}var I=t.Transform.normalizeRadian(x-g);s.rotation=m+I*this._weight,s.toMatrix(n.globalTransformMatrix);var R=g+I*this._weight;o.x=s.x+Math.cos(R)*p,o.y=s.y+Math.sin(R)*p;var O=Math.atan2(i.y-o.y,i.x-o.x);o.scaleX<0&&(O+=Math.PI),o.rotation=s.rotation+f-m+t.Transform.normalizeRadian(O-I-f)*this._weight,o.toMatrix(r)},n.prototype.init=function(t,e){if(null===this._constraintData){this._constraintData=t,this._armature=e,this._target=this._armature.getBone(this._constraintData.target.name),this._root=this._armature.getBone(this._constraintData.root.name),this._bone=null!==this._constraintData.bone?this._armature.getBone(this._constraintData.bone.name):null;var n=this._constraintData;this._scaleEnabled=n.scaleEnabled,this._bendPositive=n.bendPositive,this._weight=n.weight,this._root._hasConstraint=!0}},n.prototype.update=function(){this._root.updateByConstraint(),null!==this._bone?(this._bone.updateByConstraint(),this._computeB()):this._computeA()},n.prototype.invalidUpdate=function(){this._root.invalidUpdate(),null!==this._bone&&this._bone.invalidUpdate()},n}(e);t.IKConstraint=n;var i=function(e){function n(){var t=null!==e&&e.apply(this,arguments)||this;return t._bones=[],t._spaces=[],t._positions=[],t._curves=[],t._boneLengths=[],t._pathGlobalVertices=[],t._segments=[10],t}return MQ(n,e),n.toString=function(){return"[class dragonBones.PathConstraint]"},n.prototype._onClear=function(){e.prototype._onClear.call(this),this.dirty=!1,this.pathOffset=0,this.position=0,this.spacing=0,this.rotateOffset=0,this.rotateMix=1,this.translateMix=1,this._pathSlot=null,this._bones.length=0,this._spaces.length=0,this._positions.length=0,this._curves.length=0,this._boneLengths.length=0,this._pathGlobalVertices.length=0},n.prototype._updatePathVertices=function(t){var e=this._armature,n=e.armatureData.parent,i=e.armatureData.scale,s=n.intArray,o=n.floatArray,r=t.offset,a=s[r+0],c=s[r+2];this._pathGlobalVertices.length=2*a;var l=t.weight;if(null!==l)for(var h=this._pathSlot._deformVertices.bones,_=l.bones.length,u=l.offset,d=s[u+1],p=u+2+_,f=(A=0,0);A<a;A++){for(var m=0,g=0,v=0,y=s[p++];v<y;v++){var x=h[s[p++]];if(null!==x){x.updateByConstraint(),E=x.globalTransformMatrix;var S=o[d++];b=o[d++]*i,P=o[d++]*i,m+=(E.a*b+E.c*P+E.tx)*S,g+=(E.b*b+E.d*P+E.ty)*S}}this._pathGlobalVertices[f++]=m,this._pathGlobalVertices[f++]=g}else{var T=this._pathSlot.parent;T.updateByConstraint();for(var E=T.globalTransformMatrix,A=0,C=c;A<a;A+=2){var b=o[C++]*i,P=o[C++]*i,w=E.a*b+E.c*P+E.tx,D=E.b*b+E.d*P+E.ty;this._pathGlobalVertices[A]=w,this._pathGlobalVertices[A+1]=D}}},n.prototype._computeVertices=function(t,e,n,i){for(var s=n,o=t;s<e;s+=2)i[s]=this._pathGlobalVertices[o++],i[s+1]=this._pathGlobalVertices[o++]},n.prototype._computeBezierCurve=function(t,e,n,i,s){var o=this._armature.armatureData.parent.intArray[t.vertices.offset+0],r=this._positions,a=this._spaces,c=t.closed,l=Array(),h=2*o,_=h/6,u=-1,d=this.position;r.length=3*e+2;var p=0;if(t.constantSpeed){c?(h+=2,l.length=o,this._computeVertices(2,h-4,0,l),this._computeVertices(0,2,h-4,l),l[h-2]=l[0],l[h-1]=l[1]):(_--,h-=4,l.length=h,this._computeVertices(2,h,0,l));var f=new Array(_);p=0;for(var m,g,v,y,x,S,T,E,A=l[0],C=l[1],b=0,P=0,w=0,D=0,I=0,R=0,O=(V=0,2);V<_;V++,O+=6)b=l[O],P=l[O+1],w=l[O+2],D=l[O+3],x=2*(m=.1875*(A-2*b+w))+(v=.09375*(3*(b-w)-A+(I=l[O+4]))),S=2*(g=.1875*(C-2*P+D))+(y=.09375*(3*(P-D)-C+(R=l[O+5]))),T=.75*(b-A)+m+.16666667*v,E=.75*(P-C)+g+.16666667*y,p+=Math.sqrt(T*T+E*E),T+=x,E+=S,x+=v,S+=y,p+=Math.sqrt(T*T+E*E),T+=x,E+=S,p+=Math.sqrt(T*T+E*E),T+=x+v,E+=S+y,p+=Math.sqrt(T*T+E*E),f[V]=p,A=I,C=R;if(i&&(d*=p),s)for(V=0;V<e;V++)a[V]*=p;for(var M=this._segments,N=0,L=(V=0,j=0,W=0,0);V<e;V++,j+=3){var B=d+=a[V];if(c)(B%=p)<0&&(B+=p),W=0;else{if(B<0)continue;if(B>p)continue}for(;;W++){var F=f[W];if(!(B>F)){0===W?B/=F:B=(B-(H=f[W-1]))/(F-H);break}}if(W!==u){u=W;var z=6*W;for(A=l[z],C=l[z+1],b=l[z+2],P=l[z+3],w=l[z+4],D=l[z+5],x=2*(m=.03*(A-2*b+w))+(v=.006*(3*(b-w)-A+(I=l[z+6]))),S=2*(g=.03*(C-2*P+D))+(y=.006*(3*(P-D)-C+(R=l[z+7]))),T=.3*(b-A)+m+.16666667*v,E=.3*(P-C)+g+.16666667*y,N=Math.sqrt(T*T+E*E),M[0]=N,z=1;z<8;z++)T+=x,E+=S,x+=v,S+=y,N+=Math.sqrt(T*T+E*E),M[z]=N;T+=x,E+=S,N+=Math.sqrt(T*T+E*E),M[8]=N,T+=x+v,E+=S+y,N+=Math.sqrt(T*T+E*E),M[9]=N,L=0}for(B*=N;;L++){var U=M[L];if(!(B>U)){var H;0===L?B/=U:B=L+(B-(H=M[L-1]))/(U-H);break}}this.addCurvePosition(.1*B,A,C,b,P,w,D,I,R,r,j,n)}}else{var G=t.curveLengths;if(p=G[_-=c?1:2],i&&(d*=p),s)for(var V=0;V<e;V++)a[V]*=p;l.length=8;V=0;for(var j=0,W=0;V<e;V++,j+=3){if(d+=a[V],c)(d%=p)<0&&(d+=p),W=0;else{if(d<0)continue;if(d>p)continue}for(var k=0;;W++){var q=G[W];if(!(d>q)){if(0===W)k=d/q;else{var X=G[W-1];k=(d-X)/(q-X)}break}}W!==u&&(u=W,c&&W===_?(this._computeVertices(h-4,4,0,l),this._computeVertices(0,4,4,l)):this._computeVertices(6*W+2,8,0,l)),this.addCurvePosition(k,l[0],l[1],l[2],l[3],l[4],l[5],l[6],l[7],r,j,n)}}},n.prototype.addCurvePosition=function(t,e,n,i,s,o,r,a,c,l,h,_){if(0===t)return l[h]=e,l[h+1]=n,void(l[h+2]=0);if(1===t)return l[h]=a,l[h+1]=c,void(l[h+2]=0);var u=1-t,d=u*u,p=t*t,f=d*u,m=d*t*3,g=u*p*3,v=t*p,y=f*e+m*i+g*o+v*a,x=f*n+m*s+g*r+v*c;l[h]=y,l[h+1]=x,l[h+2]=_?Math.atan2(x-(f*n+m*s+g*r),y-(f*e+m*i+g*o)):0},n.prototype.init=function(t,e){this._constraintData=t,this._armature=e;var n=t;this.pathOffset=n.pathDisplayData.vertices.offset,this.position=n.position,this.spacing=n.spacing,this.rotateOffset=n.rotateOffset,this.rotateMix=n.rotateMix,this.translateMix=n.translateMix,this._root=this._armature.getBone(n.root.name),this._target=this._armature.getBone(n.target.name),this._pathSlot=this._armature.getSlot(n.pathSlot.name);for(var i=0,s=n.bones.length;i<s;i++){var o=this._armature.getBone(n.bones[i].name);null!==o&&this._bones.push(o)}2===n.rotateMode&&(this._boneLengths.length=this._bones.length),this._root._hasConstraint=!0},n.prototype.update=function(){var e=this._pathSlot;if(null!==e._deformVertices&&null!==e._deformVertices.verticesData&&e._deformVertices.verticesData.offset===this.pathOffset){var n=this._constraintData,i=e._displayData,s=!1,o=e._deformVertices;if(this._root._childrenTransformDirty?(this._updatePathVertices(i.vertices),s=!0):null!==o&&(o.verticesDirty||o.isBonesUpdate())&&(this._updatePathVertices(i.vertices),o.verticesDirty=!1,s=!0),s||this.dirty){var r=n.positionMode,a=n.spacingMode,c=n.rotateMode,l=this._bones,h=0===a,_=2===c,u=0===c,d=l.length,p=u?d:d+1,f=this.spacing,m=this._spaces;if(m.length=p,_||h){m[0]=0;for(var g=0,v=p-1;g<v;g++){(R=l[g]).updateByConstraint();var y=R._boneData.length,x=y*(O=R.globalTransformMatrix).a,S=y*O.b,T=Math.sqrt(x*x+S*S);_&&(this._boneLengths[g]=T),m[g+1]=(y+f)*T/y}}else for(g=0;g<p;g++)m[g]=f;this._computeBezierCurve(i,p,u,1===r,2===a);var E,A=this._positions,C=this.rotateOffset,b=A[0],P=A[1];0===C?E=1===c:(E=!1,null!==(R=e.parent)&&(C*=(O=R.globalTransformMatrix).a*O.d-O.b*O.c>0?t.Transform.DEG_RAD:-t.Transform.DEG_RAD));for(var w=this.rotateMix,D=this.translateMix,I=(g=0,3);g<d;g++,I+=3){var R,O;(R=l[g]).updateByConstraint(),(O=R.globalTransformMatrix).tx+=(b-O.tx)*D,O.ty+=(P-O.ty)*D;var M=(x=A[I])-b,N=(S=A[I+1])-P;if(_){var L=this._boneLengths[g],B=(Math.sqrt(M*M+N*N)/L-1)*w+1;O.a*=B,O.b*=B}if(b=x,P=S,w>0){var F=O.a,z=O.b,U=O.c,H=O.d,G=void 0,V=void 0,j=void 0;if(G=u?A[I-1]:Math.atan2(N,M),G-=Math.atan2(z,F),E){V=Math.cos(G),j=Math.sin(G);var W=R._boneData.length;b+=(W*(V*F-j*z)-M)*w,P+=(W*(j*F+V*z)-N)*w}else G+=C;G>t.Transform.PI?G-=t.Transform.PI_D:G<-t.Transform.PI&&(G+=t.Transform.PI_D),G*=w,V=Math.cos(G),j=Math.sin(G),O.a=V*F-j*z,O.b=j*F+V*z,O.c=V*U-j*H,O.d=j*U+V*H}R.global.fromMatrix(O)}this.dirty=!1}}},n.prototype.invalidUpdate=function(){},n}(e);t.PathConstraint=i}(NQ||(NQ={})),function(t){var e=function(){function t(t){void 0===t&&(t=0),this.time=0,this.timeScale=1,this._systemTime=0,this._animatebles=[],this._clock=null,this.time=t,this._systemTime=.001*(new Date).getTime()}return t.prototype.advanceTime=function(t){t!=t&&(t=0);var e=.001*Date.now();if(t<0&&(t=e-this._systemTime),this._systemTime=e,1!==this.timeScale&&(t*=this.timeScale),0!==t){t<0?this.time-=t:this.time+=t;for(var n=0,i=0,s=this._animatebles.length;n<s;++n){var o=this._animatebles[n];null!==o?(i>0&&(this._animatebles[n-i]=o,this._animatebles[n]=null),o.advanceTime(t)):i++}if(i>0){for(s=this._animatebles.length;n<s;++n){var r=this._animatebles[n];null!==r?this._animatebles[n-i]=r:i++}this._animatebles.length-=i}}},t.prototype.contains=function(t){if(t===this)return!1;for(var e=t;e!==this&&null!==e;)e=e.clock;return e===this},t.prototype.add=function(t){this._animatebles.indexOf(t)<0&&(this._animatebles.push(t),t.clock=this)},t.prototype.remove=function(t){var e=this._animatebles.indexOf(t);e>=0&&(this._animatebles[e]=null,t.clock=null)},t.prototype.clear=function(){for(var t=0,e=this._animatebles;t<e.length;t++){var n=e[t];null!==n&&(n.clock=null)}},Object.defineProperty(t.prototype,"clock",{get:function(){return this._clock},set:function(t){this._clock!==t&&(null!==this._clock&&this._clock.remove(this),this._clock=t,null!==this._clock&&this._clock.add(this))},enumerable:!0,configurable:!0}),t.clock=new t,t}();t.WorldClock=e}(NQ||(NQ={})),function(t){var e=function(e){function n(){var t=null!==e&&e.apply(this,arguments)||this;return t._animationNames=[],t._animationStates=[],t._animations={},t._animationConfig=null,t}return MQ(n,e),n.toString=function(){return"[class dragonBones.Animation]"},n.prototype._onClear=function(){for(var t=0,e=this._animationStates;t<e.length;t++)e[t].returnToPool();for(var n in this._animations)delete this._animations[n];null!==this._animationConfig&&this._animationConfig.returnToPool(),this.timeScale=1,this._lockUpdate=!1,this._animationDirty=!1,this._inheritTimeScale=1,this._animationNames.length=0,this._animationStates.length=0,this._armature=null,this._animationConfig=null,this._lastAnimationState=null},n.prototype._fadeOut=function(t){switch(t.fadeOutMode){case 1:for(var e=0,n=this._animationStates;e<n.length;e++)null===(l=n[e])._parent&&l.layer===t.layer&&l.fadeOut(t.fadeOutTime,t.pauseFadeOut);break;case 2:for(var i=0,s=this._animationStates;i<s.length;i++)null===(l=s[i])._parent&&l.group===t.group&&l.fadeOut(t.fadeOutTime,t.pauseFadeOut);break;case 3:for(var o=0,r=this._animationStates;o<r.length;o++)null===(l=r[o])._parent&&l.layer===t.layer&&l.group===t.group&&l.fadeOut(t.fadeOutTime,t.pauseFadeOut);break;case 4:for(var a=0,c=this._animationStates;a<c.length;a++){var l;null===(l=c[a])._parent&&l.fadeOut(t.fadeOutTime,t.pauseFadeOut)}}},n.prototype.init=function(e){null===this._armature&&(this._armature=e,this._animationConfig=t.BaseObject.borrowObject(t.AnimationConfig))},n.prototype.advanceTime=function(t){t<0&&(t=-t),this._armature.inheritAnimation&&null!==this._armature._parent?this._inheritTimeScale=this._armature._parent._armature.animation._inheritTimeScale*this.timeScale:this._inheritTimeScale=this.timeScale,1!==this._inheritTimeScale&&(t*=this._inheritTimeScale);var e=this._animationStates.length;if(1===e)if((p=this._animationStates[0])._fadeState>0&&p._subFadeState>0)this._armature._dragonBones.bufferObject(p),this._animationStates.length=0,this._lastAnimationState=null;else{var n=p._animationData,i=n.cacheFrameRate;if(this._animationDirty&&i>0){this._animationDirty=!1;for(var s=0,o=this._armature.getBones();s<o.length;s++){var r=o[s];r._cachedFrameIndices=n.getBoneCachedFrameIndices(r.name)}for(var a=0,c=this._armature.getSlots();a<c.length;a++){var l=c[a],h=l.rawDisplayDatas;if(null!==h&&h.length>0){var _=h[0];if(null!==_&&_.parent===this._armature.armatureData.defaultSkin){l._cachedFrameIndices=n.getSlotCachedFrameIndices(l.name);continue}}l._cachedFrameIndices=null}}p.advanceTime(t,i)}else if(e>1){for(var u=0,d=0;u<e;++u){var p;(p=this._animationStates[u])._fadeState>0&&p._subFadeState>0?(d++,this._armature._dragonBones.bufferObject(p),this._animationDirty=!0,this._lastAnimationState===p&&(this._lastAnimationState=null)):(d>0&&(this._animationStates[u-d]=p),p.advanceTime(t,0)),u===e-1&&d>0&&(this._animationStates.length-=d,null===this._lastAnimationState&&this._animationStates.length>0&&(this._lastAnimationState=this._animationStates[this._animationStates.length-1]))}this._armature._cacheFrameIndex=-1}else this._armature._cacheFrameIndex=-1},n.prototype.reset=function(){for(var t=0,e=this._animationStates;t<e.length;t++)e[t].returnToPool();this._animationDirty=!1,this._animationConfig.clear(),this._animationStates.length=0,this._lastAnimationState=null},n.prototype.stop=function(t){if(void 0===t&&(t=null),null!==t)null!==(i=this.getState(t))&&i.stop();else for(var e=0,n=this._animationStates;e<n.length;e++){var i;(i=n[e]).stop()}},n.prototype.playConfig=function(e){var n=e.animation;if(!(n in this._animations))return console.warn("Non-existent animation.\n","DragonBones name: "+this._armature.armatureData.parent.name,"Armature name: "+this._armature.name,"Animation name: "+n),null;var i=this._animations[n];if(5===e.fadeOutMode)for(var s=0,o=this._animationStates;s<o.length;s++){var r=o[s];if(r._animationData===i)return r}0===this._animationStates.length?e.fadeInTime=0:e.fadeInTime<0&&(e.fadeInTime=i.fadeInTime),e.fadeOutTime<0&&(e.fadeOutTime=e.fadeInTime),e.timeScale<=-100&&(e.timeScale=1/i.scale),i.frameCount>1?(e.position<0?(e.position%=i.duration,e.position=i.duration-e.position):e.position===i.duration?e.position-=1e-6:e.position>i.duration&&(e.position%=i.duration),e.duration>0&&e.position+e.duration>i.duration&&(e.duration=i.duration-e.position),e.playTimes<0&&(e.playTimes=i.playTimes)):(e.playTimes=1,e.position=0,e.duration>0&&(e.duration=0)),0===e.duration&&(e.duration=-1),this._fadeOut(e);var a=t.BaseObject.borrowObject(t.AnimationState);if(a.init(this._armature,i,e),this._animationDirty=!0,this._armature._cacheFrameIndex=-1,this._animationStates.length>0){for(var c=!1,l=0,h=this._animationStates.length;l<h;++l){if(a.layer>this._animationStates[l].layer){c=!0,this._animationStates.splice(l,0,a);break}if(l!==h-1&&a.layer>this._animationStates[l+1].layer){c=!0,this._animationStates.splice(l+1,0,a);break}}c||this._animationStates.push(a)}else this._animationStates.push(a);for(var _=0,u=this._armature.getSlots();_<u.length;_++){var d=u[_].childArmature;null!==d&&d.inheritAnimation&&d.animation.hasAnimation(n)&&null===d.animation.getState(n)&&d.animation.fadeIn(n)}var p=!1;for(var f in i.animationTimelines){this._lockUpdate||(p=!0,this._lockUpdate=!0);var m=this.fadeIn(f,e.fadeInTime,1,a.layer,null,0);null!==m&&(m.resetToPose=!1,m._parent=a,m.stop())}return p&&(this._lockUpdate=!1),this._lockUpdate||(e.fadeInTime<=0&&this._armature.advanceTime(0),this._lastAnimationState=a),a},n.prototype.play=function(t,e){if(void 0===t&&(t=null),void 0===e&&(e=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=e,this._animationConfig.fadeInTime=0,this._animationConfig.animation=null!==t?t:"",null!==t&&t.length>0)this.playConfig(this._animationConfig);else if(null===this._lastAnimationState){var n=this._armature.armatureData.defaultAnimation;null!==n&&(this._animationConfig.animation=n.name,this.playConfig(this._animationConfig))}else this._lastAnimationState.isPlaying||this._lastAnimationState.isCompleted?(this._animationConfig.animation=this._lastAnimationState.name,this.playConfig(this._animationConfig)):this._lastAnimationState.play();return this._lastAnimationState},n.prototype.fadeIn=function(t,e,n,i,s,o){return void 0===e&&(e=-1),void 0===n&&(n=-1),void 0===i&&(i=0),void 0===s&&(s=null),void 0===o&&(o=3),this._animationConfig.clear(),this._animationConfig.fadeOutMode=o,this._animationConfig.playTimes=n,this._animationConfig.layer=i,this._animationConfig.fadeInTime=e,this._animationConfig.animation=t,this._animationConfig.group=null!==s?s:"",this.playConfig(this._animationConfig)},n.prototype.gotoAndPlayByTime=function(t,e,n){return void 0===e&&(e=0),void 0===n&&(n=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=n,this._animationConfig.position=e,this._animationConfig.fadeInTime=0,this._animationConfig.animation=t,this.playConfig(this._animationConfig)},n.prototype.gotoAndPlayByFrame=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=n,this._animationConfig.fadeInTime=0,this._animationConfig.animation=t;var i=t in this._animations?this._animations[t]:null;return null!==i&&(this._animationConfig.position=i.duration*e/i.frameCount),this.playConfig(this._animationConfig)},n.prototype.gotoAndPlayByProgress=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=n,this._animationConfig.fadeInTime=0,this._animationConfig.animation=t;var i=t in this._animations?this._animations[t]:null;return null!==i&&(this._animationConfig.position=i.duration*(e>0?e:0)),this.playConfig(this._animationConfig)},n.prototype.gotoAndStopByTime=function(t,e){void 0===e&&(e=0);var n=this.gotoAndPlayByTime(t,e,1);return null!==n&&n.stop(),n},n.prototype.gotoAndStopByFrame=function(t,e){void 0===e&&(e=0);var n=this.gotoAndPlayByFrame(t,e,1);return null!==n&&n.stop(),n},n.prototype.gotoAndStopByProgress=function(t,e){void 0===e&&(e=0);var n=this.gotoAndPlayByProgress(t,e,1);return null!==n&&n.stop(),n},n.prototype.getState=function(t){for(var e=this._animationStates.length;e--;){var n=this._animationStates[e];if(n.name===t)return n}return null},n.prototype.hasAnimation=function(t){return t in this._animations},n.prototype.getStates=function(){return this._animationStates},Object.defineProperty(n.prototype,"isPlaying",{get:function(){for(var t=0,e=this._animationStates;t<e.length;t++)if(e[t].isPlaying)return!0;return!1},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isCompleted",{get:function(){for(var t=0,e=this._animationStates;t<e.length;t++)if(!e[t].isCompleted)return!1;return this._animationStates.length>0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"lastAnimationName",{get:function(){return null!==this._lastAnimationState?this._lastAnimationState.name:""},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"animationNames",{get:function(){return this._animationNames},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"animations",{get:function(){return this._animations},set:function(t){if(this._animations!==t){for(var e in this._animationNames.length=0,this._animations)delete this._animations[e];for(var e in t)this._animationNames.push(e),this._animations[e]=t[e]}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"animationConfig",{get:function(){return this._animationConfig.clear(),this._animationConfig},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"lastAnimationState",{get:function(){return this._lastAnimationState},enumerable:!0,configurable:!0}),n.prototype.gotoAndPlay=function(t,e,n,i,s,o,r){void 0===e&&(e=-1),void 0===n&&(n=-1),void 0===i&&(i=-1),void 0===s&&(s=0),void 0===o&&(o=null),void 0===r&&(r=3),console.warn("Deprecated."),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.fadeOutMode=r,this._animationConfig.playTimes=i,this._animationConfig.layer=s,this._animationConfig.fadeInTime=e,this._animationConfig.animation=t,this._animationConfig.group=null!==o?o:"";var a=this._animations[t];return a&&n>0&&(this._animationConfig.timeScale=a.duration/n),this.playConfig(this._animationConfig)},n.prototype.gotoAndStop=function(t,e){return void 0===e&&(e=0),console.warn("Deprecated."),this.gotoAndStopByTime(t,e)},Object.defineProperty(n.prototype,"animationList",{get:function(){return console.warn("Deprecated."),this._animationNames},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"animationDataList",{get:function(){console.warn("Deprecated.");for(var t=[],e=0,n=this._animationNames.length;e<n;++e)t.push(this._animations[this._animationNames[e]]);return t},enumerable:!0,configurable:!0}),n}(t.BaseObject);t.Animation=e}(NQ||(NQ={})),function(t){var e=function(e){function s(){var t=null!==e&&e.apply(this,arguments)||this;return t._blendState=new i,t._boneMask=[],t._boneTimelines=[],t._surfaceTimelines=[],t._slotTimelines=[],t._constraintTimelines=[],t._animationTimelines=[],t._poseTimelines=[],t._bonePoses={},t._actionTimeline=null,t._zOrderTimeline=null,t._parent=null,t}return MQ(s,e),s.toString=function(){return"[class dragonBones.AnimationState]"},s.prototype._onClear=function(){for(var t=0,e=this._boneTimelines;t<e.length;t++)e[t].returnToPool();for(var n=0,i=this._surfaceTimelines;n<i.length;n++)i[n].returnToPool();for(var s=0,o=this._slotTimelines;s<o.length;s++)o[s].returnToPool();for(var r=0,a=this._constraintTimelines;r<a.length;r++)a[r].returnToPool();for(var c=0,l=this._animationTimelines;c<l.length;c++)l[c].returnToPool();for(var h in this._bonePoses)this._bonePoses[h].returnToPool(),delete this._bonePoses[h];null!==this._actionTimeline&&this._actionTimeline.returnToPool(),null!==this._zOrderTimeline&&this._zOrderTimeline.returnToPool(),this.actionEnabled=!1,this.additiveBlending=!1,this.displayControl=!1,this.resetToPose=!1,this.playTimes=1,this.layer=0,this.timeScale=1,this.weight=1,this.autoFadeOutTime=0,this.fadeTotalTime=0,this.name="",this.group="",this._timelineDirty=2,this._playheadState=0,this._fadeState=-1,this._subFadeState=-1,this._position=0,this._duration=0,this._fadeTime=0,this._time=0,this._fadeProgress=0,this._weightResult=0,this._blendState.clear(),this._boneMask.length=0,this._boneTimelines.length=0,this._surfaceTimelines.length=0,this._slotTimelines.length=0,this._constraintTimelines.length=0,this._animationTimelines.length=0,this._poseTimelines.length=0,this._animationData=null,this._armature=null,this._actionTimeline=null,this._zOrderTimeline=null,this._parent=null},s.prototype._updateTimelines=function(){for(var e=0,n=this._armature._constraints;e<n.length;e++){var i=n[e];if(null!==(c=this._animationData.getConstraintTimelines(i.name)))for(var s=0,o=c;s<o.length;s++)switch((u=o[s]).type){case 30:(d=t.BaseObject.borrowObject(t.IKConstraintTimelineState)).constraint=i,d.init(this._armature,this,u),this._constraintTimelines.push(d)}else this.resetToPose&&((d=t.BaseObject.borrowObject(t.IKConstraintTimelineState)).constraint=i,d.init(this._armature,this,null),this._constraintTimelines.push(d),this._poseTimelines.push(d))}for(var r=0,a=this._armature.animation.getStates();r<a.length;r++){var c,l=a[r];if(l._parent===this&&null!==(c=this._animationData.getAnimationTimelines(l.name)))for(var h=0,_=c;h<_.length;h++){var u;switch((u=_[h]).type){case 40:var d;(d=t.BaseObject.borrowObject(t.AnimationTimelineState)).animationState=l,d.init(this._armature,this,u),this._animationTimelines.push(d)}}}},s.prototype._updateBoneAndSlotTimelines=function(){for(var e={},i=0,s=this._boneTimelines;i<s.length;i++)(c=(v=s[i]).bone.name)in e||(e[c]=[]),e[c].push(v);for(var o=0,r=this._armature.getBones();o<r.length;o++){var a=r[o],c=a.name;if(this.containsBoneMask(c))if(c in e)delete e[c];else if(0===a._boneData.type){var l=this._animationData.getBoneTimelines(c),h=c in this._bonePoses?this._bonePoses[c]:this._bonePoses[c]=t.BaseObject.borrowObject(n);if(null!==l)for(var _=0,u=l;_<u.length;_++)switch((R=u[_]).type){case 10:(v=t.BaseObject.borrowObject(t.BoneAllTimelineState)).bone=a,v.bonePose=h,v.init(this._armature,this,R),this._boneTimelines.push(v);break;case 11:(v=t.BaseObject.borrowObject(t.BoneTranslateTimelineState)).bone=a,v.bonePose=h,v.init(this._armature,this,R),this._boneTimelines.push(v);break;case 12:(v=t.BaseObject.borrowObject(t.BoneRotateTimelineState)).bone=a,v.bonePose=h,v.init(this._armature,this,R),this._boneTimelines.push(v);break;case 13:(v=t.BaseObject.borrowObject(t.BoneScaleTimelineState)).bone=a,v.bonePose=h,v.init(this._armature,this,R),this._boneTimelines.push(v)}else this.resetToPose&&((v=t.BaseObject.borrowObject(t.BoneAllTimelineState)).bone=a,v.bonePose=h,v.init(this._armature,this,null),this._boneTimelines.push(v),this._poseTimelines.push(v))}else if(1===a._boneData.type)if(null!==(l=this._animationData.getSurfaceTimelines(c)))for(var d=0,p=l;d<p.length;d++)switch((R=p[d]).type){case 50:(v=t.BaseObject.borrowObject(t.SurfaceTimelineState)).surface=a,v.init(this._armature,this,R),this._surfaceTimelines.push(v)}else this.resetToPose&&((v=t.BaseObject.borrowObject(t.SurfaceTimelineState)).surface=a,v.init(this._armature,this,null),this._surfaceTimelines.push(v),this._poseTimelines.push(v))}for(var f in e)for(var m=0,g=e[f];m<g.length;m++){var v=g[m];this._boneTimelines.splice(this._boneTimelines.indexOf(v),1),v.returnToPool()}for(var y={},x=[],S=0,T=this._slotTimelines;S<T.length;S++)(c=(v=T[S]).slot.name)in y||(y[c]=[]),y[c].push(v);for(var E=0,A=this._armature.getSlots();E<A.length;E++){var C=A[E],b=C.parent.name;if(this.containsBoneMask(b))if(c=C.name,l=this._animationData.getSlotTimelines(c),c in y)delete y[c];else{var P=!1,w=!1;if(x.length=0,null!==l)for(var D=0,I=l;D<I.length;D++){var R;switch((R=I[D]).type){case 20:(v=t.BaseObject.borrowObject(t.SlotDislayTimelineState)).slot=C,v.init(this._armature,this,R),this._slotTimelines.push(v),P=!0;break;case 21:(v=t.BaseObject.borrowObject(t.SlotColorTimelineState)).slot=C,v.init(this._armature,this,R),this._slotTimelines.push(v),w=!0;break;case 22:(v=t.BaseObject.borrowObject(t.DeformTimelineState)).slot=C,v.init(this._armature,this,R),this._slotTimelines.push(v),x.push(v.vertexOffset)}}if(this.resetToPose&&(P||((v=t.BaseObject.borrowObject(t.SlotDislayTimelineState)).slot=C,v.init(this._armature,this,null),this._slotTimelines.push(v),this._poseTimelines.push(v)),w||((v=t.BaseObject.borrowObject(t.SlotColorTimelineState)).slot=C,v.init(this._armature,this,null),this._slotTimelines.push(v),this._poseTimelines.push(v)),null!==C.rawDisplayDatas))for(var O=0,M=C.rawDisplayDatas;O<M.length;O++){var N=M[O];if(null!==N&&2===N.type){var L=N.vertices.offset;x.indexOf(L)<0&&((v=t.BaseObject.borrowObject(t.DeformTimelineState)).vertexOffset=L,v.slot=C,v.init(this._armature,this,null),this._slotTimelines.push(v),this._poseTimelines.push(v))}}}}for(var f in y)for(var B=0,F=y[f];B<F.length;B++)v=F[B],this._slotTimelines.splice(this._slotTimelines.indexOf(v),1),v.returnToPool()},s.prototype._advanceFadeTime=function(e){var n,i=this._fadeState>0;if(this._subFadeState<0){this._subFadeState=0;var s=i?t.EventObject.FADE_OUT:t.EventObject.FADE_IN;this._armature.eventDispatcher.hasDBEventListener(s)&&((n=t.BaseObject.borrowObject(t.EventObject)).type=s,n.armature=this._armature,n.animationState=this,this._armature._dragonBones.bufferEvent(n))}(e<0&&(e=-e),this._fadeTime+=e,this._fadeTime>=this.fadeTotalTime?(this._subFadeState=1,this._fadeProgress=i?0:1):this._fadeTime>0?this._fadeProgress=i?1-this._fadeTime/this.fadeTotalTime:this._fadeTime/this.fadeTotalTime:this._fadeProgress=i?1:0,this._subFadeState>0)&&(i||(this._playheadState|=1,this._fadeState=0),s=i?t.EventObject.FADE_OUT_COMPLETE:t.EventObject.FADE_IN_COMPLETE,this._armature.eventDispatcher.hasDBEventListener(s)&&((n=t.BaseObject.borrowObject(t.EventObject)).type=s,n.armature=this._armature,n.animationState=this,this._armature._dragonBones.bufferEvent(n)))},s.prototype.init=function(e,n,i){if(null===this._armature){if(this._armature=e,this._animationData=n,this.resetToPose=i.resetToPose,this.additiveBlending=i.additiveBlending,this.displayControl=i.displayControl,this.actionEnabled=i.actionEnabled,this.layer=i.layer,this.playTimes=i.playTimes,this.timeScale=i.timeScale,this.fadeTotalTime=i.fadeInTime,this.autoFadeOutTime=i.autoFadeOutTime,this.weight=i.weight,this.name=i.name.length>0?i.name:i.animation,this.group=i.group,i.pauseFadeIn?this._playheadState=2:this._playheadState=3,i.duration<0?(this._position=0,this._duration=this._animationData.duration,0!==i.position?this.timeScale>=0?this._time=i.position:this._time=i.position-this._duration:this._time=0):(this._position=i.position,this._duration=i.duration,this._time=0),this.timeScale<0&&0===this._time&&(this._time=-1e-6),this.fadeTotalTime<=0&&(this._fadeProgress=.999999),i.boneMask.length>0){this._boneMask.length=i.boneMask.length;for(var s=0,o=this._boneMask.length;s<o;++s)this._boneMask[s]=i.boneMask[s]}this._actionTimeline=t.BaseObject.borrowObject(t.ActionTimelineState),this._actionTimeline.init(this._armature,this,this._animationData.actionTimeline),this._actionTimeline.currentTime=this._time,this._actionTimeline.currentTime<0&&(this._actionTimeline.currentTime=this._duration-this._actionTimeline.currentTime),null!==this._animationData.zOrderTimeline&&(this._zOrderTimeline=t.BaseObject.borrowObject(t.ZOrderTimelineState),this._zOrderTimeline.init(this._armature,this,this._animationData.zOrderTimeline))}},s.prototype.advanceTime=function(e,n){if(this._blendState.dirty=!1,0===this._fadeState&&0===this._subFadeState||this._advanceFadeTime(e),3===this._playheadState&&(1!==this.timeScale&&(e*=this.timeScale),this._time+=e),0!==this._timelineDirty&&(2===this._timelineDirty&&this._updateTimelines(),this._timelineDirty=0,this._updateBoneAndSlotTimelines()),0!==this.weight){var i=0===this._fadeState&&n>0,s=!0,o=!0,r=this._time;if(this._weightResult=this.weight*this._fadeProgress,null!==this._parent&&(this._weightResult*=this._parent._weightResult/this._parent._fadeProgress),this._actionTimeline.playState<=0&&this._actionTimeline.update(r),i){var a=2*n;this._actionTimeline.currentTime=Math.floor(this._actionTimeline.currentTime*a)/a}if(null!==this._zOrderTimeline&&this._zOrderTimeline.playState<=0&&this._zOrderTimeline.update(r),i){var c=Math.floor(this._actionTimeline.currentTime*n);this._armature._cacheFrameIndex===c?(s=!1,o=!1):(this._armature._cacheFrameIndex=c,this._animationData.cachedFrames[c]?o=!1:this._animationData.cachedFrames[c]=!0)}if(s){if(o)for(var l=0,h=this._boneTimelines.length;l<h;++l)(f=this._boneTimelines[l]).playState<=0&&f.update(r),(l===h-1||f.bone!==this._boneTimelines[l+1].bone)&&0!==(_=f.bone._blendState.update(this._weightResult,this.layer))&&f.blend(_);for(l=0,h=this._surfaceTimelines.length;l<h;++l){var _=(f=this._surfaceTimelines[l]).surface._blendState.update(this._weightResult,this.layer);f.playState<=0&&f.update(r),0!==_&&f.blend(_)}if(this.displayControl)for(l=0,h=this._slotTimelines.length;l<h;++l){var u=(f=this._slotTimelines[l]).slot.displayController;null!==u&&u!==this.name&&u!==this.group||f.playState<=0&&f.update(r)}for(l=0,h=this._constraintTimelines.length;l<h;++l)(f=this._constraintTimelines[l]).playState<=0&&f.update(r);for(l=0,h=this._animationTimelines.length;l<h;++l)_=(f=this._animationTimelines[l]).animationState._blendState.update(this._weightResult,this.layer),f.playState<=0&&f.update(r),0!==_&&f.blend(_)}if(0===this._fadeState){if(this._subFadeState>0&&(this._subFadeState=0,this._poseTimelines.length>0)){for(var d=0,p=this._poseTimelines;d<p.length;d++){var f;(f=p[d])instanceof t.BoneTimelineState?this._boneTimelines.splice(this._boneTimelines.indexOf(f),1):f instanceof t.SurfaceTimelineState?this._surfaceTimelines.splice(this._surfaceTimelines.indexOf(f),1):f instanceof t.SlotTimelineState?this._slotTimelines.splice(this._slotTimelines.indexOf(f),1):f instanceof t.ConstraintTimelineState&&this._constraintTimelines.splice(this._constraintTimelines.indexOf(f),1),f.returnToPool()}this._poseTimelines.length=0}this._actionTimeline.playState>0&&this.autoFadeOutTime>=0&&this.fadeOut(this.autoFadeOutTime)}}},s.prototype.play=function(){this._playheadState=3},s.prototype.stop=function(){this._playheadState&=1},s.prototype.fadeOut=function(t,e){if(void 0===e&&(e=!0),t<0&&(t=0),e&&(this._playheadState&=2),this._fadeState>0){if(t>this.fadeTotalTime-this._fadeTime)return}else{this._fadeState=1,this._subFadeState=-1,(t<=0||this._fadeProgress<=0)&&(this._fadeProgress=1e-6);for(var n=0,i=this._boneTimelines;n<i.length;n++)(u=i[n]).fadeOut();for(var s=0,o=this._surfaceTimelines;s<o.length;s++)(u=o[s]).fadeOut();for(var r=0,a=this._slotTimelines;r<a.length;r++)(u=a[r]).fadeOut();for(var c=0,l=this._constraintTimelines;c<l.length;c++)(u=l[c]).fadeOut();for(var h=0,_=this._animationTimelines;h<_.length;h++){var u;(u=_[h]).animationState.fadeOut(t,e),u.fadeOut()}}this.displayControl=!1,this.fadeTotalTime=this._fadeProgress>1e-6?t/this._fadeProgress:0,this._fadeTime=this.fadeTotalTime*(1-this._fadeProgress)},s.prototype.containsBoneMask=function(t){return 0===this._boneMask.length||this._boneMask.indexOf(t)>=0},s.prototype.addBoneMask=function(t,e){void 0===e&&(e=!0);var n=this._armature.getBone(t);if(null!==n){if(this._boneMask.indexOf(t)<0&&this._boneMask.push(t),e)for(var i=0,s=this._armature.getBones();i<s.length;i++){var o=s[i];this._boneMask.indexOf(o.name)<0&&n.contains(o)&&this._boneMask.push(o.name)}this._timelineDirty=1}},s.prototype.removeBoneMask=function(t,e){void 0===e&&(e=!0);var n=this._boneMask.indexOf(t);if(n>=0&&this._boneMask.splice(n,1),e){var i=this._armature.getBone(t);if(null!==i){var s=this._armature.getBones();if(this._boneMask.length>0)for(var o=0,r=s;o<r.length;o++){var a=r[o],c=this._boneMask.indexOf(a.name);c>=0&&i.contains(a)&&this._boneMask.splice(c,1)}else for(var l=0,h=s;l<h.length;l++)(a=h[l])!==i&&(i.contains(a)||this._boneMask.push(a.name))}}this._timelineDirty=1},s.prototype.removeAllBoneMask=function(){this._boneMask.length=0,this._timelineDirty=1},Object.defineProperty(s.prototype,"isFadeIn",{get:function(){return this._fadeState<0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"isFadeOut",{get:function(){return this._fadeState>0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"isFadeComplete",{get:function(){return 0===this._fadeState},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"isPlaying",{get:function(){return 0!=(2&this._playheadState)&&this._actionTimeline.playState<=0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"isCompleted",{get:function(){return this._actionTimeline.playState>0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"currentPlayTimes",{get:function(){return this._actionTimeline.currentPlayTimes},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"totalTime",{get:function(){return this._duration},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"currentTime",{get:function(){return this._actionTimeline.currentTime},set:function(t){var e=this._actionTimeline.currentPlayTimes-(this._actionTimeline.playState>0?1:0);if((t<0||this._duration<t)&&(t=t%this._duration+e*this._duration)<0&&(t+=this._duration),this.playTimes>0&&e===this.playTimes-1&&t===this._duration&&(t=this._duration-1e-6),this._time!==t){this._time=t,this._actionTimeline.setCurrentTime(this._time),null!==this._zOrderTimeline&&(this._zOrderTimeline.playState=-1);for(var n=0,i=this._boneTimelines;n<i.length;n++)i[n].playState=-1;for(var s=0,o=this._slotTimelines;s<o.length;s++)o[s].playState=-1}},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"animationData",{get:function(){return this._animationData},enumerable:!0,configurable:!0}),s}(t.BaseObject);t.AnimationState=e;var n=function(e){function n(){var n=null!==e&&e.apply(this,arguments)||this;return n.current=new t.Transform,n.delta=new t.Transform,n.result=new t.Transform,n}return MQ(n,e),n.toString=function(){return"[class dragonBones.BonePose]"},n.prototype._onClear=function(){this.current.identity(),this.delta.identity(),this.result.identity()},n}(t.BaseObject);t.BonePose=n;var i=function(){function t(){}return t.prototype.update=function(t,e){if(this.dirty){if(!(this.leftWeight>0))return 0;if(this.layer!==e){if(this.layerWeight>=this.leftWeight)return this.leftWeight=0,0;this.layer=e,this.leftWeight-=this.layerWeight,this.layerWeight=0}return t*=this.leftWeight,this.layerWeight+=t,this.blendWeight=t,2}return this.dirty=!0,this.layer=e,this.layerWeight=t,this.leftWeight=1,this.blendWeight=t,1},t.prototype.clear=function(){this.dirty=!1,this.layer=0,this.leftWeight=0,this.layerWeight=0,this.blendWeight=0},t}();t.BlendState=i}(NQ||(NQ={})),function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return MQ(e,t),e.prototype._onClear=function(){this.playState=-1,this.currentPlayTimes=-1,this.currentTime=-1,this._tweenState=0,this._frameRate=0,this._frameValueOffset=0,this._frameCount=0,this._frameOffset=0,this._frameIndex=-1,this._frameRateR=0,this._position=0,this._duration=0,this._timeScale=1,this._timeOffset=0,this._dragonBonesData=null,this._animationData=null,this._timelineData=null,this._armature=null,this._animationState=null,this._actionTimeline=null,this._frameArray=null,this._frameIntArray=null,this._frameFloatArray=null,this._timelineArray=null,this._frameIndices=null},e.prototype._setCurrentTime=function(t){var e=this.playState,n=this.currentPlayTimes,i=this.currentTime;if(null!==this._actionTimeline&&this._frameCount<=1)this.playState=this._actionTimeline.playState>=0?1:-1,this.currentPlayTimes=1,this.currentTime=this._actionTimeline.currentTime;else if(null===this._actionTimeline||1!==this._timeScale||0!==this._timeOffset){var s=this._animationState.playTimes,o=s*this._duration;t*=this._timeScale,0!==this._timeOffset&&(t+=this._timeOffset*this._animationData.duration),s>0&&(t>=o||t<=-o)?(this.playState<=0&&3===this._animationState._playheadState&&(this.playState=1),this.currentPlayTimes=s,this.currentTime=t<0?0:this._duration+1e-6):(0!==this.playState&&3===this._animationState._playheadState&&(this.playState=0),t<0?(t=-t,this.currentPlayTimes=Math.floor(t/this._duration),this.currentTime=this._duration-t%this._duration):(this.currentPlayTimes=Math.floor(t/this._duration),this.currentTime=t%this._duration)),this.currentTime+=this._position}else this.playState=this._actionTimeline.playState,this.currentPlayTimes=this._actionTimeline.currentPlayTimes,this.currentTime=this._actionTimeline.currentTime;return(this.currentPlayTimes!==n||this.currentTime!==i)&&((e<0&&this.playState!==e||this.playState<=0&&this.currentPlayTimes!==n)&&(this._frameIndex=-1),!0)},e.prototype.init=function(t,e,n){this._armature=t,this._animationState=e,this._timelineData=n,this._actionTimeline=this._animationState._actionTimeline,this===this._actionTimeline&&(this._actionTimeline=null),this._animationData=this._animationState._animationData,this._frameRate=this._animationData.parent.frameRate,this._frameRateR=1/this._frameRate,this._position=this._animationState._position,this._duration=this._animationState._duration,this._dragonBonesData=this._animationData.parent.parent,null!==this._timelineData&&(this._frameIntArray=this._dragonBonesData.frameIntArray,this._frameFloatArray=this._dragonBonesData.frameFloatArray,this._frameArray=this._dragonBonesData.frameArray,this._timelineArray=this._dragonBonesData.timelineArray,this._frameIndices=this._dragonBonesData.frameIndices,this._frameCount=this._timelineArray[this._timelineData.offset+2],this._frameValueOffset=this._timelineArray[this._timelineData.offset+4],this._timeScale=100/this._timelineArray[this._timelineData.offset+0],this._timeOffset=.01*this._timelineArray[this._timelineData.offset+1])},e.prototype.fadeOut=function(){},e.prototype.update=function(t){if(this._setCurrentTime(t)){if(this._frameCount>1){var e=Math.floor(this.currentTime*this._frameRate),n=this._frameIndices[this._timelineData.frameIndicesOffset+e];this._frameIndex!==n&&(this._frameIndex=n,this._frameOffset=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5+this._frameIndex],this._onArriveAtFrame())}else this._frameIndex<0&&(this._frameIndex=0,null!==this._timelineData&&(this._frameOffset=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5]),this._onArriveAtFrame());0!==this._tweenState&&this._onUpdateFrame()}},e}(t.BaseObject);t.TimelineState=e;var n=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return MQ(e,t),e._getEasingValue=function(t,e,n){var i=e;switch(t){case 3:i=Math.pow(e,2);break;case 4:i=1-Math.pow(1-e,2);break;case 5:i=.5*(1-Math.cos(e*Math.PI))}return(i-e)*n+e},e._getEasingCurveValue=function(t,e,n,i){if(t<=0)return 0;if(t>=1)return 1;var s=n+1,o=Math.floor(t*s),r=0===o?0:e[i+o-1];return 1e-4*(r+((o===s-1?1e4:e[i+o])-r)*(t*s-o))},e.prototype._onClear=function(){t.prototype._onClear.call(this),this._tweenType=0,this._curveCount=0,this._framePosition=0,this._frameDurationR=0,this._tweenProgress=0,this._tweenEasing=0},e.prototype._onArriveAtFrame=function(){if(this._frameCount>1&&(this._frameIndex!==this._frameCount-1||0===this._animationState.playTimes||this._animationState.currentPlayTimes<this._animationState.playTimes-1))if(this._tweenType=this._frameArray[this._frameOffset+1],this._tweenState=0===this._tweenType?1:2,2===this._tweenType?this._curveCount=this._frameArray[this._frameOffset+2]:0!==this._tweenType&&1!==this._tweenType&&(this._tweenEasing=.01*this._frameArray[this._frameOffset+2]),this._framePosition=this._frameArray[this._frameOffset]*this._frameRateR,this._frameIndex===this._frameCount-1)this._frameDurationR=1/(this._animationData.duration-this._framePosition);else{var t=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5+this._frameIndex+1],e=this._frameArray[t]*this._frameRateR-this._framePosition;this._frameDurationR=e>0?1/e:0}else this._tweenState=1},e.prototype._onUpdateFrame=function(){2===this._tweenState?(this._tweenProgress=(this.currentTime-this._framePosition)*this._frameDurationR,2===this._tweenType?this._tweenProgress=e._getEasingCurveValue(this._tweenProgress,this._frameArray,this._curveCount,this._frameOffset+3):1!==this._tweenType&&(this._tweenProgress=e._getEasingValue(this._tweenType,this._tweenProgress,this._tweenEasing))):this._tweenProgress=0},e}(e);t.TweenTimelineState=n;var i=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return MQ(e,t),e.prototype._onClear=function(){t.prototype._onClear.call(this),this.bone=null,this.bonePose=null},e.prototype.blend=function(t){var e=this.bone._blendState.blendWeight,n=this.bone.animationPose,i=this.bonePose.result;2===t?(n.x+=i.x*e,n.y+=i.y*e,n.rotation+=i.rotation*e,n.skew+=i.skew*e,n.scaleX+=(i.scaleX-1)*e,n.scaleY+=(i.scaleY-1)*e):1!==e?(n.x=i.x*e,n.y=i.y*e,n.rotation=i.rotation*e,n.skew=i.skew*e,n.scaleX=(i.scaleX-1)*e+1,n.scaleY=(i.scaleY-1)*e+1):(n.x=i.x,n.y=i.y,n.rotation=i.rotation,n.skew=i.skew,n.scaleX=i.scaleX,n.scaleY=i.scaleY),0===this._animationState._fadeState&&0===this._animationState._subFadeState||(this.bone._transformDirty=!0)},e}(n);t.BoneTimelineState=i;var s=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return MQ(e,t),e.prototype._onClear=function(){t.prototype._onClear.call(this),this.slot=null},e}(n);t.SlotTimelineState=s;var o=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return MQ(e,t),e.prototype._onClear=function(){t.prototype._onClear.call(this),this.constraint=null},e}(n);t.ConstraintTimelineState=o}(NQ||(NQ={})),function(t){var e=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return MQ(n,e),n.toString=function(){return"[class dragonBones.ActionTimelineState]"},n.prototype._onCrossFrame=function(e){var n=this._armature.eventDispatcher;if(this._animationState.actionEnabled)for(var i=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5+e],s=this._frameArray[i+1],o=this._animationData.parent.actions,r=0;r<s;++r){var a=o[this._frameArray[i+2+r]];if(0===a.type)(c=t.BaseObject.borrowObject(t.EventObject)).time=this._frameArray[i]/this._frameRate,c.animationState=this._animationState,t.EventObject.actionDataToInstance(a,c,this._armature),this._armature._bufferAction(c,!0);else{var c,l=10===a.type?t.EventObject.FRAME_EVENT:t.EventObject.SOUND_EVENT;(11===a.type||n.hasDBEventListener(l))&&((c=t.BaseObject.borrowObject(t.EventObject)).time=this._frameArray[i]/this._frameRate,c.animationState=this._animationState,t.EventObject.actionDataToInstance(a,c,this._armature),this._armature._dragonBones.bufferEvent(c))}}},n.prototype._onArriveAtFrame=function(){},n.prototype._onUpdateFrame=function(){},n.prototype.update=function(e){var n=this.playState,i=this.currentPlayTimes,s=this.currentTime;if(this._setCurrentTime(e)){var o=this._armature.eventDispatcher;if(n<0){if(this.playState===n)return;if(this._animationState.displayControl&&this._animationState.resetToPose&&this._armature._sortZOrder(null,0),i=this.currentPlayTimes,o.hasDBEventListener(t.EventObject.START)){var r=t.BaseObject.borrowObject(t.EventObject);r.type=t.EventObject.START,r.armature=this._armature,r.animationState=this._animationState,this._armature._dragonBones.bufferEvent(r)}}var a=this._animationState.timeScale<0,c=null,l=null;if(this.currentPlayTimes!==i&&(o.hasDBEventListener(t.EventObject.LOOP_COMPLETE)&&((c=t.BaseObject.borrowObject(t.EventObject)).type=t.EventObject.LOOP_COMPLETE,c.armature=this._armature,c.animationState=this._animationState),this.playState>0&&o.hasDBEventListener(t.EventObject.COMPLETE)&&((l=t.BaseObject.borrowObject(t.EventObject)).type=t.EventObject.COMPLETE,l.armature=this._armature,l.animationState=this._animationState)),this._frameCount>1){var h=this._timelineData,_=Math.floor(this.currentTime*this._frameRate),u=this._frameIndices[h.frameIndicesOffset+_];if(this._frameIndex!==u){var d=this._frameIndex;if(this._frameIndex=u,null!==this._timelineArray)if(this._frameOffset=this._animationData.frameOffset+this._timelineArray[h.offset+5+this._frameIndex],a){if(d<0){var p=Math.floor(s*this._frameRate);d=this._frameIndices[h.frameIndicesOffset+p],this.currentPlayTimes===i&&d===u&&(d=-1)}for(;d>=0;){var f=this._animationData.frameOffset+this._timelineArray[h.offset+5+d],m=this._frameArray[f]/this._frameRate;if(this._position<=m&&m<=this._position+this._duration&&this._onCrossFrame(d),null!==c&&0===d&&(this._armature._dragonBones.bufferEvent(c),c=null),d>0?d--:d=this._frameCount-1,d===u)break}}else for(d<0&&(p=Math.floor(s*this._frameRate),d=this._frameIndices[h.frameIndicesOffset+p],f=this._animationData.frameOffset+this._timelineArray[h.offset+5+d],m=this._frameArray[f]/this._frameRate,this.currentPlayTimes===i&&(s<=m?d>0?d--:d=this._frameCount-1:d===u&&(d=-1)));d>=0&&(d<this._frameCount-1?d++:d=0,f=this._animationData.frameOffset+this._timelineArray[h.offset+5+d],m=this._frameArray[f]/this._frameRate,this._position<=m&&m<=this._position+this._duration&&this._onCrossFrame(d),null!==c&&0===d&&(this._armature._dragonBones.bufferEvent(c),c=null),d!==u););}}else this._frameIndex<0&&(this._frameIndex=0,null!==this._timelineData)&&(this._frameOffset=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5],m=this._frameArray[this._frameOffset]/this._frameRate,this.currentPlayTimes===i?s<=m&&this._onCrossFrame(this._frameIndex):this._position<=m&&(a||null===c||(this._armature._dragonBones.bufferEvent(c),c=null),this._onCrossFrame(this._frameIndex)));null!==c&&this._armature._dragonBones.bufferEvent(c),null!==l&&this._armature._dragonBones.bufferEvent(l)}},n.prototype.setCurrentTime=function(t){this._setCurrentTime(t),this._frameIndex=-1},n}(t.TimelineState);t.ActionTimelineState=e;var n=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return MQ(e,t),e.toString=function(){return"[class dragonBones.ZOrderTimelineState]"},e.prototype._onArriveAtFrame=function(){this.playState>=0&&(this._frameArray[this._frameOffset+1]>0?this._armature._sortZOrder(this._frameArray,this._frameOffset+2):this._armature._sortZOrder(null,0))},e.prototype._onUpdateFrame=function(){},e}(t.TimelineState);t.ZOrderTimelineState=n;var i=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return MQ(n,e),n.toString=function(){return"[class dragonBones.BoneAllTimelineState]"},n.prototype._onArriveAtFrame=function(){if(e.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var t=this._animationData.frameFloatOffset+this._frameValueOffset+6*this._frameIndex,n=this._armature._armatureData.scale,i=this._frameFloatArray,s=this.bonePose.current,o=this.bonePose.delta;s.x=i[t++]*n,s.y=i[t++]*n,s.rotation=i[t++],s.skew=i[t++],s.scaleX=i[t++],s.scaleY=i[t++],2===this._tweenState?(this._frameIndex===this._frameCount-1&&(t=this._animationData.frameFloatOffset+this._frameValueOffset),o.x=i[t++]*n-s.x,o.y=i[t++]*n-s.y,o.rotation=i[t++]-s.rotation,o.skew=i[t++]-s.skew,o.scaleX=i[t++]-s.scaleX,o.scaleY=i[t++]-s.scaleY):(o.x=0,o.y=0,o.rotation=0,o.skew=0,o.scaleX=0,o.scaleY=0)}else s=this.bonePose.current,o=this.bonePose.delta,s.x=0,s.y=0,s.rotation=0,s.skew=0,s.scaleX=1,s.scaleY=1,o.x=0,o.y=0,o.rotation=0,o.skew=0,o.scaleX=0,o.scaleY=0},n.prototype._onUpdateFrame=function(){e.prototype._onUpdateFrame.call(this);var t=this.bonePose.current,n=this.bonePose.delta,i=this.bonePose.result;this.bone._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0),i.x=t.x+n.x*this._tweenProgress,i.y=t.y+n.y*this._tweenProgress,i.rotation=t.rotation+n.rotation*this._tweenProgress,i.skew=t.skew+n.skew*this._tweenProgress,i.scaleX=t.scaleX+n.scaleX*this._tweenProgress,i.scaleY=t.scaleY+n.scaleY*this._tweenProgress},n.prototype.fadeOut=function(){var e=this.bonePose.result;e.rotation=t.Transform.normalizeRadian(e.rotation),e.skew=t.Transform.normalizeRadian(e.skew)},n}(t.BoneTimelineState);t.BoneAllTimelineState=i;var s=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return MQ(e,t),e.toString=function(){return"[class dragonBones.BoneTranslateTimelineState]"},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._animationData.frameFloatOffset+this._frameValueOffset+2*this._frameIndex,n=this._armature._armatureData.scale,i=this._frameFloatArray,s=this.bonePose.current,o=this.bonePose.delta;s.x=i[e++]*n,s.y=i[e++]*n,2===this._tweenState?(this._frameIndex===this._frameCount-1&&(e=this._animationData.frameFloatOffset+this._frameValueOffset),o.x=i[e++]*n-s.x,o.y=i[e++]*n-s.y):(o.x=0,o.y=0)}else s=this.bonePose.current,o=this.bonePose.delta,s.x=0,s.y=0,o.x=0,o.y=0},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this);var e=this.bonePose.current,n=this.bonePose.delta,i=this.bonePose.result;this.bone._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0),i.x=e.x+n.x*this._tweenProgress,i.y=e.y+n.y*this._tweenProgress},e}(t.BoneTimelineState);t.BoneTranslateTimelineState=s;var o=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return MQ(n,e),n.toString=function(){return"[class dragonBones.BoneRotateTimelineState]"},n.prototype._onArriveAtFrame=function(){if(e.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var n=this._animationData.frameFloatOffset+this._frameValueOffset+2*this._frameIndex,i=this._frameFloatArray,s=this.bonePose.current,o=this.bonePose.delta;s.rotation=i[n++],s.skew=i[n++],2===this._tweenState?(this._frameIndex===this._frameCount-1?(n=this._animationData.frameFloatOffset+this._frameValueOffset,o.rotation=t.Transform.normalizeRadian(i[n++]-s.rotation)):o.rotation=i[n++]-s.rotation,o.skew=i[n++]-s.skew):(o.rotation=0,o.skew=0)}else s=this.bonePose.current,o=this.bonePose.delta,s.rotation=0,s.skew=0,o.rotation=0,o.skew=0},n.prototype._onUpdateFrame=function(){e.prototype._onUpdateFrame.call(this);var t=this.bonePose.current,n=this.bonePose.delta,i=this.bonePose.result;this.bone._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0),i.rotation=t.rotation+n.rotation*this._tweenProgress,i.skew=t.skew+n.skew*this._tweenProgress},n.prototype.fadeOut=function(){var e=this.bonePose.result;e.rotation=t.Transform.normalizeRadian(e.rotation),e.skew=t.Transform.normalizeRadian(e.skew)},n}(t.BoneTimelineState);t.BoneRotateTimelineState=o;var r=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return MQ(e,t),e.toString=function(){return"[class dragonBones.BoneScaleTimelineState]"},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._animationData.frameFloatOffset+this._frameValueOffset+2*this._frameIndex,n=this._frameFloatArray,i=this.bonePose.current,s=this.bonePose.delta;i.scaleX=n[e++],i.scaleY=n[e++],2===this._tweenState?(this._frameIndex===this._frameCount-1&&(e=this._animationData.frameFloatOffset+this._frameValueOffset),s.scaleX=n[e++]-i.scaleX,s.scaleY=n[e++]-i.scaleY):(s.scaleX=0,s.scaleY=0)}else i=this.bonePose.current,s=this.bonePose.delta,i.scaleX=1,i.scaleY=1,s.scaleX=0,s.scaleY=0},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this);var e=this.bonePose.current,n=this.bonePose.delta,i=this.bonePose.result;this.bone._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0),i.scaleX=e.scaleX+n.scaleX*this._tweenProgress,i.scaleY=e.scaleY+n.scaleY*this._tweenProgress},e}(t.BoneTimelineState);t.BoneScaleTimelineState=r;var a=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._current=[],e._delta=[],e._result=[],e}return MQ(e,t),e.toString=function(){return"[class dragonBones.SurfaceTimelineState]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.surface=null,this._frameFloatOffset=0,this._valueCount=0,this._deformCount=0,this._valueOffset=0,this._current.length=0,this._delta.length=0,this._result.length=0},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._animationData.frameFloatOffset+this._frameValueOffset+this._frameIndex*this._valueCount,n=this._armature._armatureData.scale,i=this._frameFloatArray;if(2===this._tweenState){var s=e+this._valueCount;this._frameIndex===this._frameCount-1&&(s=this._animationData.frameFloatOffset+this._frameValueOffset);for(var o=0;o<this._valueCount;++o)this._delta[o]=i[s+o]*n-(this._current[o]=i[e+o]*n)}else for(o=0;o<this._valueCount;++o)this._current[o]=i[e+o]*n}else for(o=0;o<this._valueCount;++o)this._current[o]=0},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this),this.surface._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0);for(var e=0;e<this._valueCount;++e)this._result[e]=this._current[e]+this._delta[e]*this._tweenProgress},e.prototype.init=function(e,n,i){if(t.prototype.init.call(this,e,n,i),null!==this._timelineData){var s=this._animationData.frameIntOffset+this._timelineArray[this._timelineData.offset+3];this._deformCount=this._frameIntArray[s+1],this._valueCount=this._frameIntArray[s+2],this._valueOffset=this._frameIntArray[s+3],this._frameFloatOffset=this._frameIntArray[s+4]+this._animationData.frameFloatOffset}else this._deformCount=this.surface._deformVertices.length,this._valueCount=this._deformCount,this._valueOffset=0,this._frameFloatOffset=0;this._current.length=this._valueCount,this._delta.length=this._valueCount,this._result.length=this._valueCount;for(var o=0;o<this._valueCount;++o)this._delta[o]=0},e.prototype.blend=function(t){for(var e=this.surface._blendState.blendWeight,n=this.surface._deformVertices,i=0;i<this._deformCount;++i){var s;s=i<this._valueOffset?this._frameFloatArray[this._frameFloatOffset+i]:i<this._valueOffset+this._valueCount?this._result[i-this._valueOffset]:this._frameFloatArray[this._frameFloatOffset+i-this._valueCount],2===t?n[i]+=s*e:n[i]=1!==e?s*e:s}0===this._animationState._fadeState&&0===this._animationState._subFadeState||(this.surface._transformDirty=!0)},e}(t.TweenTimelineState);t.SurfaceTimelineState=a;var c=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return MQ(e,t),e.toString=function(){return"[class dragonBones.SlotDislayTimelineState]"},e.prototype._onArriveAtFrame=function(){if(this.playState>=0){var t=null!==this._timelineData?this._frameArray[this._frameOffset+1]:this.slot._slotData.displayIndex;this.slot.displayIndex!==t&&this.slot._setDisplayIndex(t,!0)}},e}(t.SlotTimelineState);t.SlotDislayTimelineState=c;var l=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._current=[0,0,0,0,0,0,0,0],e._delta=[0,0,0,0,0,0,0,0],e._result=[0,0,0,0,0,0,0,0],e}return MQ(e,t),e.toString=function(){return"[class dragonBones.SlotColorTimelineState]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this._dirty=!1},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._dragonBonesData.intArray,n=this._frameIntArray,i=this._animationData.frameIntOffset+this._frameValueOffset+1*this._frameIndex,s=n[i];s<0&&(s+=65536),this._current[0]=e[s++],this._current[1]=e[s++],this._current[2]=e[s++],this._current[3]=e[s++],this._current[4]=e[s++],this._current[5]=e[s++],this._current[6]=e[s++],this._current[7]=e[s++],2===this._tweenState&&((s=this._frameIndex===this._frameCount-1?n[this._animationData.frameIntOffset+this._frameValueOffset]:n[i+1])<0&&(s+=65536),this._delta[0]=e[s++]-this._current[0],this._delta[1]=e[s++]-this._current[1],this._delta[2]=e[s++]-this._current[2],this._delta[3]=e[s++]-this._current[3],this._delta[4]=e[s++]-this._current[4],this._delta[5]=e[s++]-this._current[5],this._delta[6]=e[s++]-this._current[6],this._delta[7]=e[s++]-this._current[7])}else{var o=this.slot._slotData.color;this._current[0]=100*o.alphaMultiplier,this._current[1]=100*o.redMultiplier,this._current[2]=100*o.greenMultiplier,this._current[3]=100*o.blueMultiplier,this._current[4]=o.alphaOffset,this._current[5]=o.redOffset,this._current[6]=o.greenOffset,this._current[7]=o.blueOffset}},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this),this._dirty=!0,2!==this._tweenState&&(this._tweenState=0),this._result[0]=.01*(this._current[0]+this._delta[0]*this._tweenProgress),this._result[1]=.01*(this._current[1]+this._delta[1]*this._tweenProgress),this._result[2]=.01*(this._current[2]+this._delta[2]*this._tweenProgress),this._result[3]=.01*(this._current[3]+this._delta[3]*this._tweenProgress),this._result[4]=this._current[4]+this._delta[4]*this._tweenProgress,this._result[5]=this._current[5]+this._delta[5]*this._tweenProgress,this._result[6]=this._current[6]+this._delta[6]*this._tweenProgress,this._result[7]=this._current[7]+this._delta[7]*this._tweenProgress},e.prototype.fadeOut=function(){this._tweenState=0,this._dirty=!1},e.prototype.update=function(e){if(t.prototype.update.call(this,e),0!==this._tweenState||this._dirty){var n=this.slot._colorTransform;if(0!==this._animationState._fadeState||0!==this._animationState._subFadeState){if(n.alphaMultiplier!==this._result[0]||n.redMultiplier!==this._result[1]||n.greenMultiplier!==this._result[2]||n.blueMultiplier!==this._result[3]||n.alphaOffset!==this._result[4]||n.redOffset!==this._result[5]||n.greenOffset!==this._result[6]||n.blueOffset!==this._result[7]){var i=Math.pow(this._animationState._fadeProgress,4);n.alphaMultiplier+=(this._result[0]-n.alphaMultiplier)*i,n.redMultiplier+=(this._result[1]-n.redMultiplier)*i,n.greenMultiplier+=(this._result[2]-n.greenMultiplier)*i,n.blueMultiplier+=(this._result[3]-n.blueMultiplier)*i,n.alphaOffset+=(this._result[4]-n.alphaOffset)*i,n.redOffset+=(this._result[5]-n.redOffset)*i,n.greenOffset+=(this._result[6]-n.greenOffset)*i,n.blueOffset+=(this._result[7]-n.blueOffset)*i,this.slot._colorDirty=!0}}else this._dirty&&(this._dirty=!1,n.alphaMultiplier===this._result[0]&&n.redMultiplier===this._result[1]&&n.greenMultiplier===this._result[2]&&n.blueMultiplier===this._result[3]&&n.alphaOffset===this._result[4]&&n.redOffset===this._result[5]&&n.greenOffset===this._result[6]&&n.blueOffset===this._result[7]||(n.alphaMultiplier=this._result[0],n.redMultiplier=this._result[1],n.greenMultiplier=this._result[2],n.blueMultiplier=this._result[3],n.alphaOffset=this._result[4],n.redOffset=this._result[5],n.greenOffset=this._result[6],n.blueOffset=this._result[7],this.slot._colorDirty=!0))}},e}(t.SlotTimelineState);t.SlotColorTimelineState=l;var h=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._current=[],e._delta=[],e._result=[],e}return MQ(e,t),e.toString=function(){return"[class dragonBones.DeformTimelineState]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.vertexOffset=0,this._dirty=!1,this._frameFloatOffset=0,this._valueCount=0,this._deformCount=0,this._valueOffset=0,this._current.length=0,this._delta.length=0,this._result.length=0},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._animationData.frameFloatOffset+this._frameValueOffset+this._frameIndex*this._valueCount,n=this._armature._armatureData.scale,i=this._frameFloatArray;if(2===this._tweenState){var s=e+this._valueCount;this._frameIndex===this._frameCount-1&&(s=this._animationData.frameFloatOffset+this._frameValueOffset);for(var o=0;o<this._valueCount;++o)this._delta[o]=i[s+o]*n-(this._current[o]=i[e+o]*n)}else for(o=0;o<this._valueCount;++o)this._current[o]=i[e+o]*n}else for(o=0;o<this._valueCount;++o)this._current[o]=0},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this),this._dirty=!0,2!==this._tweenState&&(this._tweenState=0);for(var e=0;e<this._valueCount;++e)this._result[e]=this._current[e]+this._delta[e]*this._tweenProgress},e.prototype.init=function(e,n,i){if(t.prototype.init.call(this,e,n,i),null!==this._timelineData){var s=this._animationData.frameIntOffset+this._timelineArray[this._timelineData.offset+3];this.vertexOffset=this._frameIntArray[s+0],this.vertexOffset<0&&(this.vertexOffset+=65536),this._deformCount=this._frameIntArray[s+1],this._valueCount=this._frameIntArray[s+2],this._valueOffset=this._frameIntArray[s+3],this._frameFloatOffset=this._frameIntArray[s+4]+this._animationData.frameFloatOffset}else{var o=this.slot._deformVertices;this._deformCount=null!==o?o.vertices.length:0,this._valueCount=this._deformCount,this._valueOffset=0,this._frameFloatOffset=0}this._current.length=this._valueCount,this._delta.length=this._valueCount,this._result.length=this._valueCount;for(var r=0;r<this._valueCount;++r)this._delta[r]=0},e.prototype.fadeOut=function(){this._tweenState=0,this._dirty=!1},e.prototype.update=function(e){var n=this.slot._deformVertices;if(null!==n&&null!==n.verticesData&&n.verticesData.offset===this.vertexOffset&&(t.prototype.update.call(this,e),0!==this._tweenState||this._dirty)){var i=n.vertices;if(0!==this._animationState._fadeState||0!==this._animationState._subFadeState){for(var s=Math.pow(this._animationState._fadeProgress,2),o=0;o<this._deformCount;++o)o<this._valueOffset?i[o]+=(this._frameFloatArray[this._frameFloatOffset+o]-i[o])*s:o<this._valueOffset+this._valueCount?i[o]+=(this._result[o-this._valueOffset]-i[o])*s:i[o]+=(this._frameFloatArray[this._frameFloatOffset+o-this._valueCount]-i[o])*s;n.verticesDirty=!0}else if(this._dirty){for(this._dirty=!1,o=0;o<this._deformCount;++o)o<this._valueOffset?i[o]=this._frameFloatArray[this._frameFloatOffset+o]:o<this._valueOffset+this._valueCount?i[o]=this._result[o-this._valueOffset]:i[o]=this._frameFloatArray[this._frameFloatOffset+o-this._valueCount];n.verticesDirty=!0}}},e}(t.SlotTimelineState);t.DeformTimelineState=h;var _=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return MQ(e,t),e.toString=function(){return"[class dragonBones.IKConstraintTimelineState]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this._current=0,this._delta=0},e.prototype._onArriveAtFrame=function(){t.prototype._onArriveAtFrame.call(this);var e=this.constraint;if(null!==this._timelineData){var n=this._animationData.frameIntOffset+this._frameValueOffset+2*this._frameIndex,i=this._frameIntArray,s=0!==i[n++];this._current=.01*i[n++],2===this._tweenState?(this._frameIndex===this._frameCount-1&&(n=this._animationData.frameIntOffset+this._frameValueOffset),this._delta=.01*i[n+1]-this._current):this._delta=0,e._bendPositive=s}else{var o=e._constraintData;this._current=o.weight,this._delta=0,e._bendPositive=o.bendPositive}e.invalidUpdate()},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this),2!==this._tweenState&&(this._tweenState=0);var e=this.constraint;e._weight=this._current+this._delta*this._tweenProgress,e.invalidUpdate()},e}(t.ConstraintTimelineState);t.IKConstraintTimelineState=_;var u=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._floats=[0,0,0,0,0,0],e}return MQ(e,t),e.toString=function(){return"[class dragonBones.AnimationTimelineState]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.animationState=null},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._animationData.frameIntOffset+this._frameValueOffset+2*this._frameIndex,n=1/this.animationState._animationData.parent.frameRate,i=this._frameIntArray;this._floats[0]=i[e++]*n,this._floats[3]=.01*i[e++],2===this._tweenState?(this._frameIndex===this._frameCount-1&&(e=this._animationData.frameIntOffset+this._frameValueOffset),this._floats[1]=i[e++]*n-this._floats[0],this._floats[4]=.01*i[e++]-this._floats[3]):(this._floats[1]=0,this._floats[4]=0)}},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this),2!==this._tweenState&&(this._tweenState=0),this._floats[0]>=0&&(this._floats[2]=this._floats[0]+this._floats[1]*this._tweenProgress),this._floats[5]=this._floats[3]+this._floats[4]*this._tweenProgress},e.prototype.blend=function(t){var e=this.animationState,n=e._blendState.blendWeight;2===t?(e.weight+=this._floats[5]*n,e.currentTime+=this._floats[2]*n):(e.weight=this._floats[5]*n,e.currentTime=this._floats[2]*n)},e}(t.TweenTimelineState);t.AnimationTimelineState=u}(NQ||(NQ={})),function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return MQ(e,t),e.actionDataToInstance=function(t,n,i){0===t.type?n.type=e.FRAME_EVENT:n.type=10===t.type?e.FRAME_EVENT:e.SOUND_EVENT,n.name=t.name,n.armature=i,n.actionData=t,n.data=t.data,null!==t.bone&&(n.bone=i.getBone(t.bone.name)),null!==t.slot&&(n.slot=i.getSlot(t.slot.name))},e.toString=function(){return"[class dragonBones.EventObject]"},e.prototype._onClear=function(){this.time=0,this.type="",this.name="",this.armature=null,this.bone=null,this.slot=null,this.animationState=null,this.actionData=null,this.data=null},e.START="start",e.LOOP_COMPLETE="loopComplete",e.COMPLETE="complete",e.FADE_IN="fadeIn",e.FADE_IN_COMPLETE="fadeInComplete",e.FADE_OUT="fadeOut",e.FADE_OUT_COMPLETE="fadeOutComplete",e.FRAME_EVENT="frameEvent",e.SOUND_EVENT="soundEvent",e}(t.BaseObject);t.EventObject=e}(NQ||(NQ={})),function(t){var e=function(){function e(){}return e._getArmatureType=function(t){switch(t.toLowerCase()){case"stage":return 2;case"armature":return 0;case"movieclip":return 1;default:return 0}},e._getBoneType=function(t){switch(t.toLowerCase()){case"bone":return 0;case"surface":return 1;default:return 0}},e._getDisplayType=function(t){switch(t.toLowerCase()){case"image":return 0;case"mesh":return 2;case"armature":return 1;case"boundingbox":return 3;case"path":return 4;default:return 0}},e._getBoundingBoxType=function(t){switch(t.toLowerCase()){case"rectangle":return 0;case"ellipse":return 1;case"polygon":return 2;default:return 0}},e._getActionType=function(t){switch(t.toLowerCase()){case"play":return 0;case"frame":return 10;case"sound":return 11;default:return 0}},e._getBlendMode=function(t){switch(t.toLowerCase()){case"normal":return 0;case"add":return 1;case"alpha":return 2;case"darken":return 3;case"difference":return 4;case"erase":return 5;case"hardlight":return 6;case"invert":return 7;case"layer":return 8;case"lighten":return 9;case"multiply":return 10;case"overlay":return 11;case"screen":return 12;case"subtract":return 13;default:return 0}},e._getPositionMode=function(t){switch(t.toLocaleLowerCase()){case"percent":return 1;case"fixed":return 0;default:return 1}},e._getSpacingMode=function(t){switch(t.toLocaleLowerCase()){case"length":return 0;case"percent":return 2;case"fixed":return 1;default:return 0}},e._getRotateMode=function(t){switch(t.toLocaleLowerCase()){case"tangent":return 0;case"chain":return 1;case"chainscale":return 2;default:return 0}},e.parseDragonBonesData=function(e){return console.warn("Deprecated."),e instanceof ArrayBuffer?t.BinaryDataParser.getInstance().parseDragonBonesData(e):t.ObjectDataParser.getInstance().parseDragonBonesData(e)},e.parseTextureAtlasData=function(n,i){void 0===i&&(i=1),console.warn("");for(var s={},o=n[e.SUB_TEXTURE],r=0,a=o.length;r<a;r++){var c=o[r],l=c[e.NAME],h=new t.Rectangle,_=null;h.x=c[e.X]/i,h.y=c[e.Y]/i,h.width=c[e.WIDTH]/i,h.height=c[e.HEIGHT]/i,e.FRAME_WIDTH in c&&((_=new t.Rectangle).x=c[e.FRAME_X]/i,_.y=c[e.FRAME_Y]/i,_.width=c[e.FRAME_WIDTH]/i,_.height=c[e.FRAME_HEIGHT]/i),s[l]={region:h,frame:_,rotated:!1}}return s},e.DATA_VERSION_2_3="2.3",e.DATA_VERSION_3_0="3.0",e.DATA_VERSION_4_0="4.0",e.DATA_VERSION_4_5="4.5",e.DATA_VERSION_5_0="5.0",e.DATA_VERSION_5_5="5.5",e.DATA_VERSION=e.DATA_VERSION_5_5,e.DATA_VERSIONS=[e.DATA_VERSION_4_0,e.DATA_VERSION_4_5,e.DATA_VERSION_5_0,e.DATA_VERSION_5_5],e.TEXTURE_ATLAS="textureAtlas",e.SUB_TEXTURE="SubTexture",e.FORMAT="format",e.IMAGE_PATH="imagePath",e.WIDTH="width",e.HEIGHT="height",e.ROTATED="rotated",e.FRAME_X="frameX",e.FRAME_Y="frameY",e.FRAME_WIDTH="frameWidth",e.FRAME_HEIGHT="frameHeight",e.DRADON_BONES="dragonBones",e.USER_DATA="userData",e.ARMATURE="armature",e.BONE="bone",e.SURFACE="surface",e.SLOT="slot",e.CONSTRAINT="constraint",e.IK="ik",e.PATH_CONSTRAINT="path",e.SKIN="skin",e.DISPLAY="display",e.ANIMATION="animation",e.Z_ORDER="zOrder",e.FFD="ffd",e.FRAME="frame",e.TRANSLATE_FRAME="translateFrame",e.ROTATE_FRAME="rotateFrame",e.SCALE_FRAME="scaleFrame",e.DISPLAY_FRAME="displayFrame",e.COLOR_FRAME="colorFrame",e.DEFAULT_ACTIONS="defaultActions",e.ACTIONS="actions",e.EVENTS="events",e.INTS="ints",e.FLOATS="floats",e.STRINGS="strings",e.CANVAS="canvas",e.TRANSFORM="transform",e.PIVOT="pivot",e.AABB="aabb",e.COLOR="color",e.VERSION="version",e.COMPATIBLE_VERSION="compatibleVersion",e.FRAME_RATE="frameRate",e.TYPE="type",e.SUB_TYPE="subType",e.NAME="name",e.PARENT="parent",e.TARGET="target",e.STAGE="stage",e.SHARE="share",e.PATH="path",e.LENGTH="length",e.DISPLAY_INDEX="displayIndex",e.BLEND_MODE="blendMode",e.INHERIT_TRANSLATION="inheritTranslation",e.INHERIT_ROTATION="inheritRotation",e.INHERIT_SCALE="inheritScale",e.INHERIT_REFLECTION="inheritReflection",e.INHERIT_ANIMATION="inheritAnimation",e.INHERIT_DEFORM="inheritDeform",e.SEGMENT_X="segmentX",e.SEGMENT_Y="segmentY",e.BEND_POSITIVE="bendPositive",e.CHAIN="chain",e.WEIGHT="weight",e.FADE_IN_TIME="fadeInTime",e.PLAY_TIMES="playTimes",e.SCALE="scale",e.OFFSET="offset",e.POSITION="position",e.DURATION="duration",e.TWEEN_EASING="tweenEasing",e.TWEEN_ROTATE="tweenRotate",e.TWEEN_SCALE="tweenScale",e.CLOCK_WISE="clockwise",e.CURVE="curve",e.SOUND="sound",e.EVENT="event",e.ACTION="action",e.X="x",e.Y="y",e.SKEW_X="skX",e.SKEW_Y="skY",e.SCALE_X="scX",e.SCALE_Y="scY",e.VALUE="value",e.ROTATE="rotate",e.SKEW="skew",e.ALPHA_OFFSET="aO",e.RED_OFFSET="rO",e.GREEN_OFFSET="gO",e.BLUE_OFFSET="bO",e.ALPHA_MULTIPLIER="aM",e.RED_MULTIPLIER="rM",e.GREEN_MULTIPLIER="gM",e.BLUE_MULTIPLIER="bM",e.UVS="uvs",e.VERTICES="vertices",e.TRIANGLES="triangles",e.WEIGHTS="weights",e.SLOT_POSE="slotPose",e.BONE_POSE="bonePose",e.GLUE_WEIGHTS="glueWeights",e.GLUE_MESHES="glueMeshes",e.BONES="bones",e.POSITION_MODE="positionMode",e.SPACING_MODE="spacingMode",e.ROTATE_MODE="rotateMode",e.SPACING="spacing",e.ROTATE_OFFSET="rotateOffset",e.ROTATE_MIX="rotateMix",e.TRANSLATE_MIX="translateMix",e.TARGET_DISPLAY="targetDisplay",e.CLOSED="closed",e.CONSTANT_SPEED="constantSpeed",e.VERTEX_COUNT="vertexCount",e.LENGTHS="lengths",e.GOTO_AND_PLAY="gotoAndPlay",e.DEFAULT_NAME="default",e}();t.DataParser=e}(NQ||(NQ={})),function(t){var e=function(e){function i(){var n=null!==e&&e.apply(this,arguments)||this;return n._rawTextureAtlasIndex=0,n._rawBones=[],n._data=null,n._armature=null,n._bone=null,n._surface=null,n._slot=null,n._skin=null,n._mesh=null,n._animation=null,n._timeline=null,n._rawTextureAtlases=null,n._defaultColorOffset=-1,n._prevClockwise=0,n._prevRotation=0,n._helpMatrixA=new t.Matrix,n._helpMatrixB=new t.Matrix,n._helpTransform=new t.Transform,n._helpColorTransform=new t.ColorTransform,n._helpPoint=new t.Point,n._helpArray=[],n._intArray=[],n._floatArray=[],n._frameIntArray=[],n._frameFloatArray=[],n._frameArray=[],n._timelineArray=[],n._cacheRawMeshes=[],n._cacheMeshes=[],n._actionFrames=[],n._weightSlotPose={},n._weightBonePoses={},n._cacheBones={},n._slotChildActions={},n}return MQ(i,e),i._getBoolean=function(t,e,n){if(e in t){var i=t[e],s=typeof i;if("boolean"===s)return i;if("string"!==s)return!!i;switch(i){case"0":case"NaN":case"":case"false":case"null":case"undefined":return!1;default:return!0}}return n},i._getNumber=function(t,e,n){if(e in t){var i=t[e];return null===i||"NaN"===i?n:+i||0}return n},i._getString=function(e,n,i){if(n in e){var s=e[n];if("string"==typeof s){if(t.DragonBones.webAssembly)for(var o=0,r=s.length;o<r;++o)if(s.charCodeAt(o)>255)return encodeURI(s);return s}return String(s)}return i},i.prototype._getCurvePoint=function(t,e,n,i,s,o,r,a,c,l){var h=1-c,_=h*h,u=c*c,d=h*_,p=3*c*_,f=3*h*u,m=c*u;l.x=d*t+p*n+f*s+m*r,l.y=d*e+p*i+f*o+m*a},i.prototype._samplingEasingCurve=function(t,e){for(var n=t.length,i=-2,s=0,o=e.length;s<o;++s){for(var r=(s+1)/(o+1);(i+6<n?t[i+6]:1)<r;)i+=6;for(var a=i>=0&&i+6<n,c=a?t[i]:0,l=a?t[i+1]:0,h=t[i+2],_=t[i+3],u=t[i+4],d=t[i+5],p=a?t[i+6]:1,f=a?t[i+7]:1,m=0,g=1;g-m>1e-4;){var v=.5*(g+m);this._getCurvePoint(c,l,h,_,u,d,p,f,v,this._helpPoint),r-this._helpPoint.x>0?m=v:g=v}e[s]=this._helpPoint.y}},i.prototype._parseActionDataInFrame=function(e,n,i,s){t.DataParser.EVENT in e&&this._mergeActionFrame(e[t.DataParser.EVENT],n,10,i,s),t.DataParser.SOUND in e&&this._mergeActionFrame(e[t.DataParser.SOUND],n,11,i,s),t.DataParser.ACTION in e&&this._mergeActionFrame(e[t.DataParser.ACTION],n,0,i,s),t.DataParser.EVENTS in e&&this._mergeActionFrame(e[t.DataParser.EVENTS],n,10,i,s),t.DataParser.ACTIONS in e&&this._mergeActionFrame(e[t.DataParser.ACTIONS],n,0,i,s)},i.prototype._mergeActionFrame=function(e,i,s,o,r){for(var a=t.DragonBones.webAssembly?this._armature.actions.size():this._armature.actions.length,c=this._parseActionData(e,s,o,r),l=0,h=null,_=0,u=c;_<u.length;_++){var d=u[_];this._armature.addAction(d,!1)}0===this._actionFrames.length&&((h=new n).frameStart=0,this._actionFrames.push(h),h=null);for(var p=0,f=this._actionFrames;p<f.length;p++){var m=f[p];if(m.frameStart===i){h=m;break}if(m.frameStart>i)break;l++}null===h&&((h=new n).frameStart=i,this._actionFrames.splice(l+1,0,h));for(var g=0;g<c.length;++g)h.actions.push(a+g)},i.prototype._parseArmature=function(e,n){var s=t.BaseObject.borrowObject(t.ArmatureData);if(s.name=i._getString(e,t.DataParser.NAME,""),s.frameRate=i._getNumber(e,t.DataParser.FRAME_RATE,this._data.frameRate),s.scale=n,t.DataParser.TYPE in e&&"string"==typeof e[t.DataParser.TYPE]?s.type=t.DataParser._getArmatureType(e[t.DataParser.TYPE]):s.type=i._getNumber(e,t.DataParser.TYPE,0),0===s.frameRate&&(s.frameRate=24),this._armature=s,t.DataParser.CANVAS in e){var o=e[t.DataParser.CANVAS],r=t.BaseObject.borrowObject(t.CanvasData);t.DataParser.COLOR in o?r.hasBackground=!0:r.hasBackground=!1,r.color=i._getNumber(o,t.DataParser.COLOR,0),r.x=i._getNumber(o,t.DataParser.X,0)*s.scale,r.y=i._getNumber(o,t.DataParser.Y,0)*s.scale,r.width=i._getNumber(o,t.DataParser.WIDTH,0)*s.scale,r.height=i._getNumber(o,t.DataParser.HEIGHT,0)*s.scale,s.canvas=r}if(t.DataParser.AABB in e){var a=e[t.DataParser.AABB];s.aabb.x=i._getNumber(a,t.DataParser.X,0)*s.scale,s.aabb.y=i._getNumber(a,t.DataParser.Y,0)*s.scale,s.aabb.width=i._getNumber(a,t.DataParser.WIDTH,0)*s.scale,s.aabb.height=i._getNumber(a,t.DataParser.HEIGHT,0)*s.scale}if(t.DataParser.BONE in e)for(var c=0,l=e[t.DataParser.BONE];c<l.length;c++){var h=l[c],_=i._getString(h,t.DataParser.PARENT,""),u=this._parseBone(h);if(_.length>0){var d=s.getBone(_);null!==d?u.parent=d:(_ in this._cacheBones||(this._cacheBones[_]=[]),this._cacheBones[_].push(u))}if(u.name in this._cacheBones){for(var p=0,f=this._cacheBones[u.name];p<f.length;p++)f[p].parent=u;delete this._cacheBones[u.name]}s.addBone(u),this._rawBones.push(u)}if(t.DataParser.IK in e)for(var m=0,g=e[t.DataParser.IK];m<g.length;m++){var v=g[m];(w=this._parseIKConstraint(v))&&s.addConstraint(w)}if(s.sortBones(),t.DataParser.SLOT in e)for(var y=0,x=0,S=e[t.DataParser.SLOT];x<S.length;x++){var T=S[x];s.addSlot(this._parseSlot(T,y++))}if(t.DataParser.SKIN in e)for(var E=0,A=e[t.DataParser.SKIN];E<A.length;E++){var C=A[E];s.addSkin(this._parseSkin(C))}if(t.DataParser.PATH_CONSTRAINT in e)for(var b=0,P=e[t.DataParser.PATH_CONSTRAINT];b<P.length;b++){var w,D=P[b];(w=this._parsePathConstraint(D))&&s.addConstraint(w)}for(var I=0,R=this._cacheRawMeshes.length;I<R;++I){var O=this._cacheRawMeshes[I];t.DataParser.GLUE_WEIGHTS in O&&t.DataParser.GLUE_MESHES in O&&this._parseMeshGlue(O,this._cacheMeshes[I])}for(I=0,R=this._cacheRawMeshes.length;I<R;++I){var M=this._cacheRawMeshes[I],N=i._getString(M,t.DataParser.SHARE,"");if(0!==N.length){var L=i._getString(M,t.DataParser.SKIN,t.DataParser.DEFAULT_NAME);0===L.length&&(L=t.DataParser.DEFAULT_NAME);var B=s.getMesh(L,"",N);null!==B&&this._cacheMeshes[I].vertices.shareFrom(B.vertices)}}if(t.DataParser.ANIMATION in e)for(var F=0,z=e[t.DataParser.ANIMATION];F<z.length;F++){var U=z[F],H=this._parseAnimation(U);s.addAnimation(H)}if(t.DataParser.DEFAULT_ACTIONS in e)for(var G=0,V=this._parseActionData(e[t.DataParser.DEFAULT_ACTIONS],0,null,null);G<V.length;G++){var j=V[G];s.addAction(j,!0),0===j.type&&null!==(H=s.getAnimation(j.name))&&(s.defaultAnimation=H)}if(t.DataParser.ACTIONS in e)for(var W=0,k=this._parseActionData(e[t.DataParser.ACTIONS],0,null,null);W<k.length;W++)j=k[W],s.addAction(j,!1);for(var q in this._rawBones.length=0,this._cacheRawMeshes.length=0,this._cacheMeshes.length=0,this._armature=null,this._weightSlotPose)delete this._weightSlotPose[q];for(var q in this._weightBonePoses)delete this._weightBonePoses[q];for(var q in this._cacheBones)delete this._cacheBones[q];for(var q in this._slotChildActions)delete this._slotChildActions[q];return s},i.prototype._parseBone=function(e){var n=this._armature.scale;if(0===(t.DataParser.TYPE in e&&"string"==typeof e[t.DataParser.TYPE]?t.DataParser._getBoneType(e[t.DataParser.TYPE]):i._getNumber(e,t.DataParser.TYPE,0))){var s=t.BaseObject.borrowObject(t.BoneData);return s.inheritTranslation=i._getBoolean(e,t.DataParser.INHERIT_TRANSLATION,!0),s.inheritRotation=i._getBoolean(e,t.DataParser.INHERIT_ROTATION,!0),s.inheritScale=i._getBoolean(e,t.DataParser.INHERIT_SCALE,!0),s.inheritReflection=i._getBoolean(e,t.DataParser.INHERIT_REFLECTION,!0),s.length=i._getNumber(e,t.DataParser.LENGTH,0)*n,s.name=i._getString(e,t.DataParser.NAME,""),t.DataParser.TRANSFORM in e&&this._parseTransform(e[t.DataParser.TRANSFORM],s.transform,n),s}var o=t.BaseObject.borrowObject(t.SurfaceData);if(o.name=i._getString(e,t.DataParser.NAME,""),o.segmentX=i._getNumber(e,t.DataParser.SEGMENT_X,0),o.segmentY=i._getNumber(e,t.DataParser.SEGMENT_Y,0),o.vertices.length=(o.segmentX+1)*(o.segmentY+1)*2,t.DataParser.VERTICES in e)for(var r=e[t.DataParser.VERTICES],a=0,c=o.vertices.length;a<c;++a)a<r.length?o.vertices[a]=r[a]*n:o.vertices[a]=0;return o},i.prototype._parseIKConstraint=function(e){var n=this._armature.getBone(i._getString(e,t.DataParser.BONE,""));if(null===n)return null;var s=this._armature.getBone(i._getString(e,t.DataParser.TARGET,""));if(null===s)return null;var o=t.BaseObject.borrowObject(t.IKConstraintData);return o.scaleEnabled=i._getBoolean(e,t.DataParser.SCALE,!1),o.bendPositive=i._getBoolean(e,t.DataParser.BEND_POSITIVE,!0),o.weight=i._getNumber(e,t.DataParser.WEIGHT,1),o.name=i._getString(e,t.DataParser.NAME,""),o.type=0,o.target=s,i._getNumber(e,t.DataParser.CHAIN,0)>0&&null!==n.parent?(o.root=n.parent,o.bone=n):(o.root=n,o.bone=null),o},i.prototype._parsePathConstraint=function(e){var n=this._armature.getSlot(i._getString(e,t.DataParser.TARGET,""));if(null===n)return null;var s=this._armature.defaultSkin;if(null===s)return null;var o=s.getDisplay(n.name,i._getString(e,t.DataParser.TARGET_DISPLAY,n.name));if(null===o||!(o instanceof t.PathDisplayData))return null;var r=e[t.DataParser.BONES];if(null===r||0===r.length)return null;var a=t.BaseObject.borrowObject(t.PathConstraintData);a.name=i._getString(e,t.DataParser.NAME,""),a.type=1,a.pathSlot=n,a.pathDisplayData=o,a.target=n.parent,a.positionMode=t.DataParser._getPositionMode(i._getString(e,t.DataParser.POSITION_MODE,"")),a.spacingMode=t.DataParser._getSpacingMode(i._getString(e,t.DataParser.SPACING_MODE,"")),a.rotateMode=t.DataParser._getRotateMode(i._getString(e,t.DataParser.ROTATE_MODE,"")),a.position=i._getNumber(e,t.DataParser.POSITION,0),a.spacing=i._getNumber(e,t.DataParser.SPACING,0),a.rotateOffset=i._getNumber(e,t.DataParser.ROTATE_OFFSET,0),a.rotateMix=i._getNumber(e,t.DataParser.ROTATE_MIX,1),a.translateMix=i._getNumber(e,t.DataParser.TRANSLATE_MIX,1);for(var c=0,l=r;c<l.length;c++){var h=l[c],_=this._armature.getBone(h);null!==_&&(a.AddBone(_),null===a.root&&(a.root=_))}return a},i.prototype._parseSlot=function(e,n){var s=t.BaseObject.borrowObject(t.SlotData);return s.displayIndex=i._getNumber(e,t.DataParser.DISPLAY_INDEX,0),s.zOrder=n,s.name=i._getString(e,t.DataParser.NAME,""),s.parent=this._armature.getBone(i._getString(e,t.DataParser.PARENT,"")),t.DataParser.BLEND_MODE in e&&"string"==typeof e[t.DataParser.BLEND_MODE]?s.blendMode=t.DataParser._getBlendMode(e[t.DataParser.BLEND_MODE]):s.blendMode=i._getNumber(e,t.DataParser.BLEND_MODE,0),t.DataParser.COLOR in e?(s.color=t.SlotData.createColor(),this._parseColorTransform(e[t.DataParser.COLOR],s.color)):s.color=t.SlotData.DEFAULT_COLOR,t.DataParser.ACTIONS in e&&(this._slotChildActions[s.name]=this._parseActionData(e[t.DataParser.ACTIONS],0,null,null)),s},i.prototype._parseSkin=function(e){var n=t.BaseObject.borrowObject(t.SkinData);if(n.name=i._getString(e,t.DataParser.NAME,t.DataParser.DEFAULT_NAME),0===n.name.length&&(n.name=t.DataParser.DEFAULT_NAME),t.DataParser.SLOT in e){var s=e[t.DataParser.SLOT];this._skin=n;for(var o=0,r=s;o<r.length;o++){var a=r[o],c=i._getString(a,t.DataParser.NAME,""),l=this._armature.getSlot(c);if(null!==l){if(this._slot=l,t.DataParser.DISPLAY in a)for(var h=0,_=a[t.DataParser.DISPLAY];h<_.length;h++){var u=_[h];u?n.addDisplay(c,this._parseDisplay(u)):n.addDisplay(c,null)}this._slot=null}}this._skin=null}return n},i.prototype._parseDisplay=function(e){var n=i._getString(e,t.DataParser.NAME,""),s=i._getString(e,t.DataParser.PATH,""),o=0,r=null;switch(o=t.DataParser.TYPE in e&&"string"==typeof e[t.DataParser.TYPE]?t.DataParser._getDisplayType(e[t.DataParser.TYPE]):i._getNumber(e,t.DataParser.TYPE,o)){case 0:var a=r=t.BaseObject.borrowObject(t.ImageDisplayData);a.name=n,a.path=s.length>0?s:n,this._parsePivot(e,a);break;case 1:var c=r=t.BaseObject.borrowObject(t.ArmatureDisplayData);if(c.name=n,c.path=s.length>0?s:n,c.inheritAnimation=!0,t.DataParser.ACTIONS in e)for(var l=0,h=this._parseActionData(e[t.DataParser.ACTIONS],0,null,null);l<h.length;l++){var _=h[l];c.addAction(_)}else if(this._slot.name in this._slotChildActions){var u=this._skin.getDisplays(this._slot.name);if(null===u?0===this._slot.displayIndex:this._slot.displayIndex===u.length){for(var d=0,p=this._slotChildActions[this._slot.name];d<p.length;d++)_=p[d],c.addAction(_);delete this._slotChildActions[this._slot.name]}}break;case 2:var f=r=t.BaseObject.borrowObject(t.MeshDisplayData);f.vertices.inheritDeform=i._getBoolean(e,t.DataParser.INHERIT_DEFORM,!0),f.name=n,f.path=s.length>0?s:n,f.vertices.data=this._data,t.DataParser.SHARE in e?(this._cacheRawMeshes.push(e),this._cacheMeshes.push(f)):this._parseMesh(e,f),t.DataParser.GLUE_WEIGHTS in e&&t.DataParser.GLUE_MESHES in e&&(this._cacheRawMeshes.push(e),this._cacheMeshes.push(f));break;case 3:var m=this._parseBoundingBox(e);if(null!==m){var g=r=t.BaseObject.borrowObject(t.BoundingBoxDisplayData);g.name=n,g.path=s.length>0?s:n,g.boundingBox=m}break;case 4:var v=e[t.DataParser.LENGTHS],y=r=t.BaseObject.borrowObject(t.PathDisplayData);y.closed=i._getBoolean(e,t.DataParser.CLOSED,!1),y.constantSpeed=i._getBoolean(e,t.DataParser.CONSTANT_SPEED,!1),y.name=n,y.path=s.length>0?s:n,y.vertices.data=this._data,y.curveLengths.length=v.length;for(var x=0,S=v.length;x<S;++x)y.curveLengths[x]=v[x];this._parsePath(e,y)}return null!==r&&t.DataParser.TRANSFORM in e&&this._parseTransform(e[t.DataParser.TRANSFORM],r.transform,this._armature.scale),r},i.prototype._parsePath=function(e,n){var s=e[t.DataParser.VERTICES],o=i._getNumber(e,t.DataParser.VERTEX_COUNT,0),r=this._floatArray.length,a=this._intArray.length;if(n.vertices.offset=a,this._intArray.length+=2,this._intArray[a+0]=o,this._intArray[a+2]=r,t.DataParser.WEIGHTS in e){var c=e[t.DataParser.WEIGHTS],l=e[t.DataParser.BONES],h=l.length,_=Math.floor(c.length-o)/2,u=this._intArray.length,d=this._floatArray.length,p=this._armature.sortedBones,f=t.BaseObject.borrowObject(t.WeightData);for(f.count=_,f.offset=u,this._intArray.length+=2+h+o+_,this._intArray[u+0]=h,this._intArray[u+1]=d,w=0;w<h;w++){var m=l[w],g=this._rawBones[m];f.addBone(g),this._intArray[u+2+w]=p.indexOf(g)}this._floatArray.length+=3*_,w=0;for(var v=0,y=0,x=u+2+h,S=d;w<_;w++){var T=c[v++];this._intArray[x++]=T;for(var E=0;E<T;E++){var A=c[v++],C=c[v++],b=s[y++],P=s[y++];this._intArray[x++]=l.indexOf(A),this._floatArray[S++]=C,this._floatArray[S++]=b,this._floatArray[S++]=P}}n.vertices.weight=f}else{this._floatArray.length+=s.length;for(var w=0,D=s.length;w<D;++w)this._floatArray[r+w]=s[w]}},i.prototype._parsePivot=function(e,n){if(t.DataParser.PIVOT in e){var s=e[t.DataParser.PIVOT];n.pivot.x=i._getNumber(s,t.DataParser.X,0),n.pivot.y=i._getNumber(s,t.DataParser.Y,0)}else n.pivot.x=.5,n.pivot.y=.5},i.prototype._parseMesh=function(e,n){var i=e[t.DataParser.VERTICES],s=e[t.DataParser.UVS],o=e[t.DataParser.TRIANGLES],r=Math.floor(i.length/2),a=Math.floor(o.length/3),c=this._floatArray.length,l=c+2*r,h=this._intArray.length,_=this._skin.name+"_"+this._slot.name+"_"+n.name;n.vertices.offset=h,this._intArray.length+=4+3*a,this._intArray[h+0]=r,this._intArray[h+1]=a,this._intArray[h+2]=c;for(var u=0,d=3*a;u<d;++u)this._intArray[h+4+u]=o[u];for(this._floatArray.length+=2*r+2*r,u=0,d=2*r;u<d;++u)this._floatArray[c+u]=i[u],this._floatArray[l+u]=s[u];if(t.DataParser.WEIGHTS in e){var p=e[t.DataParser.WEIGHTS],f=e[t.DataParser.SLOT_POSE],m=e[t.DataParser.BONE_POSE],g=this._armature.sortedBones,v=new Array,y=Math.floor(m.length/7),x=this._floatArray.length,S=Math.floor(p.length-r)/2,T=this._intArray.length,E=t.BaseObject.borrowObject(t.WeightData);for(E.count=S,E.offset=T,v.length=y,this._intArray.length+=2+y+r+S,this._intArray[T+1]=x,u=0;u<y;++u){var A=m[7*u],C=this._rawBones[A];E.addBone(C),v[u]=A,this._intArray[T+2+u]=g.indexOf(C)}this._floatArray.length+=3*S,this._helpMatrixA.copyFromArray(f,0),u=0;for(var b=0,P=T+2+y,w=x;u<r;++u){var D=2*u,I=this._intArray[P++]=p[b++],R=this._floatArray[c+D],O=this._floatArray[c+D+1];this._helpMatrixA.transformPoint(R,O,this._helpPoint),R=this._helpPoint.x,O=this._helpPoint.y;for(var M=0;M<I;++M){A=p[b++];var N=v.indexOf(A);this._helpMatrixB.copyFromArray(m,7*N+1),this._helpMatrixB.invert(),this._helpMatrixB.transformPoint(R,O,this._helpPoint),this._intArray[P++]=N,this._floatArray[w++]=p[b++],this._floatArray[w++]=this._helpPoint.x,this._floatArray[w++]=this._helpPoint.y}}n.vertices.weight=E,this._weightSlotPose[_]=f,this._weightBonePoses[_]=m}},i.prototype._parseMeshGlue=function(){},i.prototype._parseBoundingBox=function(e){var n=null,s=0;switch(s=t.DataParser.SUB_TYPE in e&&"string"==typeof e[t.DataParser.SUB_TYPE]?t.DataParser._getBoundingBoxType(e[t.DataParser.SUB_TYPE]):i._getNumber(e,t.DataParser.SUB_TYPE,s)){case 0:n=t.BaseObject.borrowObject(t.RectangleBoundingBoxData);break;case 1:n=t.BaseObject.borrowObject(t.EllipseBoundingBoxData);break;case 2:n=this._parsePolygonBoundingBox(e)}return null!==n&&(n.color=i._getNumber(e,t.DataParser.COLOR,0),0!==n.type&&1!==n.type||(n.width=i._getNumber(e,t.DataParser.WIDTH,0),n.height=i._getNumber(e,t.DataParser.HEIGHT,0))),n},i.prototype._parsePolygonBoundingBox=function(e){var n=t.BaseObject.borrowObject(t.PolygonBoundingBoxData);if(t.DataParser.VERTICES in e){var i=this._armature.scale,s=e[t.DataParser.VERTICES],o=n.vertices;t.DragonBones.webAssembly?o.resize(s.length,0):o.length=s.length;for(var r=0,a=s.length;r<a;r+=2){var c=s[r]*i,l=s[r+1]*i;t.DragonBones.webAssembly?(o.set(r,c),o.set(r+1,l)):(o[r]=c,o[r+1]=l),0===r?(n.x=c,n.y=l,n.width=c,n.height=l):(c<n.x?n.x=c:c>n.width&&(n.width=c),l<n.y?n.y=l:l>n.height&&(n.height=l))}n.width-=n.x,n.height-=n.y}else console.warn("Data error.\n Please reexport DragonBones Data to fixed the bug.");return n},i.prototype._parseAnimation=function(e){var n=t.BaseObject.borrowObject(t.AnimationData);if(n.frameCount=Math.max(i._getNumber(e,t.DataParser.DURATION,1),1),n.playTimes=i._getNumber(e,t.DataParser.PLAY_TIMES,1),n.duration=n.frameCount/this._armature.frameRate,n.fadeInTime=i._getNumber(e,t.DataParser.FADE_IN_TIME,0),n.scale=i._getNumber(e,t.DataParser.SCALE,1),n.name=i._getString(e,t.DataParser.NAME,t.DataParser.DEFAULT_NAME),0===n.name.length&&(n.name=t.DataParser.DEFAULT_NAME),n.frameIntOffset=this._frameIntArray.length,n.frameFloatOffset=this._frameFloatArray.length,n.frameOffset=this._frameArray.length,this._animation=n,t.DataParser.FRAME in e){var s=e[t.DataParser.FRAME],o=s.length;if(o>0)for(var r=0,a=0;r<o;++r){var c=s[r];this._parseActionDataInFrame(c,a,null,null),a+=i._getNumber(c,t.DataParser.DURATION,1)}}if(t.DataParser.Z_ORDER in e&&(this._animation.zOrderTimeline=this._parseTimeline(e[t.DataParser.Z_ORDER],null,t.DataParser.FRAME,1,!1,!1,0,this._parseZOrderFrame)),t.DataParser.BONE in e)for(var l=0,h=e[t.DataParser.BONE];l<h.length;l++){var _=h[l];this._parseBoneTimeline(_)}if(t.DataParser.SURFACE in e)for(var u=0,d=e[t.DataParser.SURFACE];u<d.length;u++){_=d[u];var p=i._getString(_,t.DataParser.NAME,"");this._surface=this._armature.getBone(p),null!==this._surface&&(null!==(w=this._parseTimeline(_,null,t.DataParser.FRAME,50,!1,!0,0,this._parseSurfaceFrame))&&this._animation.addSurfaceTimeline(this._surface,w),this._surface=null)}if(t.DataParser.SLOT in e)for(var f=0,m=e[t.DataParser.SLOT];f<m.length;f++)_=m[f],this._parseSlotTimeline(_);if(t.DataParser.FFD in e)for(var g=0,v=e[t.DataParser.FFD];g<v.length;g++){_=v[g];var y=i._getString(_,t.DataParser.SKIN,t.DataParser.DEFAULT_NAME),x=i._getString(_,t.DataParser.SLOT,""),S=i._getString(_,t.DataParser.NAME,"");0===y.length&&(y=t.DataParser.DEFAULT_NAME),this._slot=this._armature.getSlot(x),this._mesh=this._armature.getMesh(y,x,S),null!==this._slot&&null!==this._mesh&&(null!==(w=this._parseTimeline(_,null,t.DataParser.FRAME,22,!1,!0,0,this._parseSlotFFDFrame))&&this._animation.addSlotTimeline(this._slot,w),this._slot=null,this._mesh=null)}if(t.DataParser.IK in e)for(var T=0,E=e[t.DataParser.IK];T<E.length;T++){_=E[T];var A=i._getString(_,t.DataParser.NAME,""),C=this._armature.getConstraint(A);null!==C&&null!==(w=this._parseTimeline(_,null,t.DataParser.FRAME,30,!0,!1,2,this._parseIKConstraintFrame))&&this._animation.addConstraintTimeline(C,w)}if(t.DataParser.ANIMATION in e)for(var b=0,P=e[t.DataParser.ANIMATION];b<P.length;b++){_=P[b];var w,D=i._getString(_,t.DataParser.NAME,"");null!==(w=this._parseTimeline(_,null,t.DataParser.FRAME,40,!0,!1,2,this._parseAnimationFrame))&&this._animation.addAnimationTimeline(D,w)}return this._actionFrames.length>0&&(this._animation.actionTimeline=this._parseTimeline(null,this._actionFrames,"",0,!1,!1,0,this._parseActionFrame),this._actionFrames.length=0),this._animation=null,n},i.prototype._parseTimeline=function(e,s,o,r,a,c,l,h){if(null!==e&&o.length>0&&o in e&&(s=e[o]),null===s)return null;var _=s.length;if(0===_)return null;var u=this._frameIntArray.length,d=this._frameFloatArray.length,p=t.BaseObject.borrowObject(t.TimelineData),f=this._timelineArray.length;if(this._timelineArray.length+=5+_,null!==e?(this._timelineArray[f+0]=Math.round(100*i._getNumber(e,t.DataParser.SCALE,1)),this._timelineArray[f+1]=Math.round(100*i._getNumber(e,t.DataParser.OFFSET,0))):(this._timelineArray[f+0]=100,this._timelineArray[f+1]=0),this._timelineArray[f+2]=_,this._timelineArray[f+3]=l,this._timelineArray[f+4]=a?u-this._animation.frameIntOffset:c?d-this._animation.frameFloatOffset:0,this._timeline=p,p.type=r,p.offset=f,1===_)p.frameIndicesOffset=-1,this._timelineArray[f+5+0]=h.call(this,s[0],0,0)-this._animation.frameOffset;else{var m=this._animation.frameCount+1,g=this._data.frameIndices,v=0;t.DragonBones.webAssembly?(v=g.size(),g.resize(v+m,0)):(v=g.length,g.length+=m),p.frameIndicesOffset=v;for(var y=0,x=0,S=0,T=0;y<m;++y){if(S+T<=y&&x<_){var E=s[x];S=y,T=x===_-1?this._animation.frameCount-S:E instanceof n?this._actionFrames[x+1].frameStart-S:i._getNumber(E,t.DataParser.DURATION,1),this._timelineArray[f+5+x]=h.call(this,E,S,T)-this._animation.frameOffset,x++}t.DragonBones.webAssembly?g.set(v+y,x-1):g[v+y]=x-1}}return this._timeline=null,p},i.prototype._parseBoneTimeline=function(e){var n,s=this._armature.getBone(i._getString(e,t.DataParser.NAME,""));null!==s&&(this._bone=s,this._slot=this._armature.getSlot(this._bone.name),t.DataParser.TRANSLATE_FRAME in e&&null!==(n=this._parseTimeline(e,null,t.DataParser.TRANSLATE_FRAME,11,!1,!0,2,this._parseBoneTranslateFrame))&&this._animation.addBoneTimeline(s,n),t.DataParser.ROTATE_FRAME in e&&null!==(n=this._parseTimeline(e,null,t.DataParser.ROTATE_FRAME,12,!1,!0,2,this._parseBoneRotateFrame))&&this._animation.addBoneTimeline(s,n),t.DataParser.SCALE_FRAME in e&&null!==(n=this._parseTimeline(e,null,t.DataParser.SCALE_FRAME,13,!1,!0,2,this._parseBoneScaleFrame))&&this._animation.addBoneTimeline(s,n),t.DataParser.FRAME in e&&null!==(n=this._parseTimeline(e,null,t.DataParser.FRAME,10,!1,!0,6,this._parseBoneAllFrame))&&this._animation.addBoneTimeline(s,n),this._bone=null,this._slot=null)},i.prototype._parseSlotTimeline=function(e){var n=this._armature.getSlot(i._getString(e,t.DataParser.NAME,""));if(null!==n){this._slot=n;var s;null!==(s=t.DataParser.DISPLAY_FRAME in e?this._parseTimeline(e,null,t.DataParser.DISPLAY_FRAME,20,!1,!1,0,this._parseSlotDisplayFrame):this._parseTimeline(e,null,t.DataParser.FRAME,20,!1,!1,0,this._parseSlotDisplayFrame))&&this._animation.addSlotTimeline(n,s);var o;null!==(o=t.DataParser.COLOR_FRAME in e?this._parseTimeline(e,null,t.DataParser.COLOR_FRAME,21,!0,!1,1,this._parseSlotColorFrame):this._parseTimeline(e,null,t.DataParser.FRAME,21,!0,!1,1,this._parseSlotColorFrame))&&this._animation.addSlotTimeline(n,o),this._slot=null}},i.prototype._parseFrame=function(t,e){var n=this._frameArray.length;return this._frameArray.length+=1,this._frameArray[n+0]=e,n},i.prototype._parseTweenFrame=function(e,n,s){var o=this._parseFrame(e,n,s);if(s>0)if(t.DataParser.CURVE in e){var r=s+1;this._helpArray.length=r,this._samplingEasingCurve(e[t.DataParser.CURVE],this._helpArray),this._frameArray.length+=2+this._helpArray.length,this._frameArray[o+1]=2,this._frameArray[o+2]=r;for(var a=0;a<r;++a)this._frameArray[o+3+a]=Math.round(1e4*this._helpArray[a])}else{var c=-2;t.DataParser.TWEEN_EASING in e&&(c=i._getNumber(e,t.DataParser.TWEEN_EASING,-2)),-2===c?(this._frameArray.length+=1,this._frameArray[o+1]=0):0===c?(this._frameArray.length+=1,this._frameArray[o+1]=1):c<0?(this._frameArray.length+=2,this._frameArray[o+1]=3,this._frameArray[o+2]=Math.round(100*-c)):c<=1?(this._frameArray.length+=2,this._frameArray[o+1]=4,this._frameArray[o+2]=Math.round(100*c)):(this._frameArray.length+=2,this._frameArray[o+1]=5,this._frameArray[o+2]=Math.round(100*c-100))}else this._frameArray.length+=1,this._frameArray[o+1]=0;return o},i.prototype._parseActionFrame=function(t,e){var n=this._frameArray.length,i=t.actions.length;this._frameArray.length+=2+i,this._frameArray[n+0]=e,this._frameArray[n+0+1]=i;for(var s=0;s<i;++s)this._frameArray[n+0+2+s]=t.actions[s];return n},i.prototype._parseZOrderFrame=function(e,n,i){var s=this._parseFrame(e,n,i);if(t.DataParser.Z_ORDER in e){var o=e[t.DataParser.Z_ORDER];if(o.length>0){for(var r=this._armature.sortedSlots.length,a=new Array(r-o.length/2),c=new Array(r),l=0;l<a.length;++l)a[l]=0;for(var h=0;h<r;++h)c[h]=-1;for(var _=0,u=0,d=0,p=o.length;d<p;d+=2){for(var f=o[d],m=o[d+1];_!==f;)a[u++]=_++;c[_+m]=_++}for(;_<r;)a[u++]=_++;this._frameArray.length+=1+r,this._frameArray[s+1]=r;for(var g=r;g--;)-1===c[g]?this._frameArray[s+2+g]=a[--u]||0:this._frameArray[s+2+g]=c[g]||0;return s}}return this._frameArray.length+=1,this._frameArray[s+1]=0,s},i.prototype._parseBoneAllFrame=function(e,n,s){this._helpTransform.identity(),t.DataParser.TRANSFORM in e&&this._parseTransform(e[t.DataParser.TRANSFORM],this._helpTransform,1);var o=this._helpTransform.rotation;0!==n&&(0===this._prevClockwise?o=this._prevRotation+t.Transform.normalizeRadian(o-this._prevRotation):((this._prevClockwise>0?o>=this._prevRotation:o<=this._prevRotation)&&(this._prevClockwise=this._prevClockwise>0?this._prevClockwise-1:this._prevClockwise+1),o=this._prevRotation+o-this._prevRotation+t.Transform.PI_D*this._prevClockwise)),this._prevClockwise=i._getNumber(e,t.DataParser.TWEEN_ROTATE,0),this._prevRotation=o;var r=this._parseTweenFrame(e,n,s),a=this._frameFloatArray.length;return this._frameFloatArray.length+=6,this._frameFloatArray[a++]=this._helpTransform.x,this._frameFloatArray[a++]=this._helpTransform.y,this._frameFloatArray[a++]=o,this._frameFloatArray[a++]=this._helpTransform.skew,this._frameFloatArray[a++]=this._helpTransform.scaleX,this._frameFloatArray[a++]=this._helpTransform.scaleY,this._parseActionDataInFrame(e,n,this._bone,this._slot),r},i.prototype._parseBoneTranslateFrame=function(e,n,s){var o=this._parseTweenFrame(e,n,s),r=this._frameFloatArray.length;return this._frameFloatArray.length+=2,this._frameFloatArray[r++]=i._getNumber(e,t.DataParser.X,0),this._frameFloatArray[r++]=i._getNumber(e,t.DataParser.Y,0),o},i.prototype._parseBoneRotateFrame=function(e,n,s){var o=i._getNumber(e,t.DataParser.ROTATE,0)*t.Transform.DEG_RAD;0!==n&&(0===this._prevClockwise?o=this._prevRotation+t.Transform.normalizeRadian(o-this._prevRotation):((this._prevClockwise>0?o>=this._prevRotation:o<=this._prevRotation)&&(this._prevClockwise=this._prevClockwise>0?this._prevClockwise-1:this._prevClockwise+1),o=this._prevRotation+o-this._prevRotation+t.Transform.PI_D*this._prevClockwise)),this._prevClockwise=i._getNumber(e,t.DataParser.CLOCK_WISE,0),this._prevRotation=o;var r=this._parseTweenFrame(e,n,s),a=this._frameFloatArray.length;return this._frameFloatArray.length+=2,this._frameFloatArray[a++]=o,this._frameFloatArray[a++]=i._getNumber(e,t.DataParser.SKEW,0)*t.Transform.DEG_RAD,r},i.prototype._parseBoneScaleFrame=function(e,n,s){var o=this._parseTweenFrame(e,n,s),r=this._frameFloatArray.length;return this._frameFloatArray.length+=2,this._frameFloatArray[r++]=i._getNumber(e,t.DataParser.X,1),this._frameFloatArray[r++]=i._getNumber(e,t.DataParser.Y,1),o},i.prototype._parseSurfaceFrame=function(e,n,s){var o=this._frameFloatArray.length,r=this._parseTweenFrame(e,n,s),a=e[t.DataParser.VERTICES],c=i._getNumber(e,t.DataParser.OFFSET,0),l=this._surface.vertices.length/2,h=0,_=0;this._frameFloatArray.length+=2*l;for(var u=0;u<2*l;u+=2)h=u<c||u-c>=a.length?0:a[u-c],_=u+1<c||u+1-c>=a.length?0:a[u+1-c],this._frameFloatArray[o+u]=h,this._frameFloatArray[o+u+1]=_;if(0===n){var d=this._frameIntArray.length;this._frameIntArray.length+=5,this._frameIntArray[d+0]=0,this._frameIntArray[d+1]=this._frameFloatArray.length-o,this._frameIntArray[d+2]=this._frameFloatArray.length-o,this._frameIntArray[d+3]=0,this._frameIntArray[d+4]=o-this._animation.frameFloatOffset,this._timelineArray[this._timeline.offset+3]=d-this._animation.frameIntOffset}return r},i.prototype._parseSlotDisplayFrame=function(e,n,s){var o=this._parseFrame(e,n,s);return this._frameArray.length+=1,t.DataParser.VALUE in e?this._frameArray[o+1]=i._getNumber(e,t.DataParser.VALUE,0):this._frameArray[o+1]=i._getNumber(e,t.DataParser.DISPLAY_INDEX,0),this._parseActionDataInFrame(e,n,this._slot.parent,this._slot),o},i.prototype._parseSlotColorFrame=function(e,n,i){var s=this._parseTweenFrame(e,n,i),o=-1;if(t.DataParser.VALUE in e||t.DataParser.COLOR in e){var r=t.DataParser.VALUE in e?e[t.DataParser.VALUE]:e[t.DataParser.COLOR];for(var a in r){this._parseColorTransform(r,this._helpColorTransform),o=this._intArray.length,this._intArray.length+=8,this._intArray[o++]=Math.round(100*this._helpColorTransform.alphaMultiplier),this._intArray[o++]=Math.round(100*this._helpColorTransform.redMultiplier),this._intArray[o++]=Math.round(100*this._helpColorTransform.greenMultiplier),this._intArray[o++]=Math.round(100*this._helpColorTransform.blueMultiplier),this._intArray[o++]=Math.round(this._helpColorTransform.alphaOffset),this._intArray[o++]=Math.round(this._helpColorTransform.redOffset),this._intArray[o++]=Math.round(this._helpColorTransform.greenOffset),this._intArray[o++]=Math.round(this._helpColorTransform.blueOffset),o-=8;break}}o<0&&(this._defaultColorOffset<0&&(this._defaultColorOffset=o=this._intArray.length,this._intArray.length+=8,this._intArray[o++]=100,this._intArray[o++]=100,this._intArray[o++]=100,this._intArray[o++]=100,this._intArray[o++]=0,this._intArray[o++]=0,this._intArray[o++]=0,this._intArray[o++]=0),o=this._defaultColorOffset);var c=this._frameIntArray.length;return this._frameIntArray.length+=1,this._frameIntArray[c]=o,s},i.prototype._parseSlotFFDFrame=function(e,n,s){var o=this._frameFloatArray.length,r=this._parseTweenFrame(e,n,s),a=t.DataParser.VERTICES in e?e[t.DataParser.VERTICES]:null,c=i._getNumber(e,t.DataParser.OFFSET,0),l=this._intArray[this._mesh.vertices.offset+0],h=this._mesh.parent.name+"_"+this._slot.name+"_"+this._mesh.name,_=this._mesh.vertices.weight,u=0,d=0,p=0,f=0;if(null!==_){var m=this._weightSlotPose[h];this._helpMatrixA.copyFromArray(m,0),this._frameFloatArray.length+=2*_.count,p=_.offset+2+_.bones.length}else this._frameFloatArray.length+=2*l;for(var g=0;g<2*l;g+=2)if(null===a?(u=0,d=0):(u=g<c||g-c>=a.length?0:a[g-c],d=g+1<c||g+1-c>=a.length?0:a[g+1-c]),null!==_){var v=this._weightBonePoses[h],y=this._intArray[p++];this._helpMatrixA.transformPoint(u,d,this._helpPoint,!0),u=this._helpPoint.x,d=this._helpPoint.y;for(var x=0;x<y;++x){var S=this._intArray[p++];this._helpMatrixB.copyFromArray(v,7*S+1),this._helpMatrixB.invert(),this._helpMatrixB.transformPoint(u,d,this._helpPoint,!0),this._frameFloatArray[o+f++]=this._helpPoint.x,this._frameFloatArray[o+f++]=this._helpPoint.y}}else this._frameFloatArray[o+g]=u,this._frameFloatArray[o+g+1]=d;if(0===n){var T=this._frameIntArray.length;this._frameIntArray.length+=5,this._frameIntArray[T+0]=this._mesh.vertices.offset,this._frameIntArray[T+1]=this._frameFloatArray.length-o,this._frameIntArray[T+2]=this._frameFloatArray.length-o,this._frameIntArray[T+3]=0,this._frameIntArray[T+4]=o-this._animation.frameFloatOffset,this._timelineArray[this._timeline.offset+3]=T-this._animation.frameIntOffset}return r},i.prototype._parseIKConstraintFrame=function(e,n,s){var o=this._parseTweenFrame(e,n,s),r=this._frameIntArray.length;return this._frameIntArray.length+=2,this._frameIntArray[r++]=i._getBoolean(e,t.DataParser.BEND_POSITIVE,!0)?1:0,this._frameIntArray[r++]=Math.round(100*i._getNumber(e,t.DataParser.WEIGHT,1)),o},i.prototype._parseAnimationFrame=function(e,n,s){var o=this._parseTweenFrame(e,n,s),r=this._frameIntArray.length;return this._frameIntArray.length+=2,this._frameIntArray[r++]=i._getNumber(e,t.DataParser.VALUE,0),this._frameIntArray[r++]=Math.round(100*i._getNumber(e,t.DataParser.WEIGHT,1)),o},i.prototype._parseActionData=function(e,n,s,o){var r=new Array;if("string"==typeof e)(h=t.BaseObject.borrowObject(t.ActionData)).type=n,h.name=e,h.bone=s,h.slot=o,r.push(h);else if(e instanceof Array)for(var a=0,c=e;a<c.length;a++){var l=c[a],h=t.BaseObject.borrowObject(t.ActionData);if(t.DataParser.GOTO_AND_PLAY in l?(h.type=0,h.name=i._getString(l,t.DataParser.GOTO_AND_PLAY,"")):(t.DataParser.TYPE in l&&"string"==typeof l[t.DataParser.TYPE]?h.type=t.DataParser._getActionType(l[t.DataParser.TYPE]):h.type=i._getNumber(l,t.DataParser.TYPE,n),h.name=i._getString(l,t.DataParser.NAME,"")),t.DataParser.BONE in l){var _=i._getString(l,t.DataParser.BONE,"");h.bone=this._armature.getBone(_)}else h.bone=s;if(t.DataParser.SLOT in l){var u=i._getString(l,t.DataParser.SLOT,"");h.slot=this._armature.getSlot(u)}else h.slot=o;var d=null;if(t.DataParser.INTS in l){null===d&&(d=t.BaseObject.borrowObject(t.UserData));for(var p=0,f=l[t.DataParser.INTS];p<f.length;p++){var m=f[p];d.addInt(m)}}if(t.DataParser.FLOATS in l){null===d&&(d=t.BaseObject.borrowObject(t.UserData));for(var g=0,v=l[t.DataParser.FLOATS];g<v.length;g++)m=v[g],d.addFloat(m)}if(t.DataParser.STRINGS in l){null===d&&(d=t.BaseObject.borrowObject(t.UserData));for(var y=0,x=l[t.DataParser.STRINGS];y<x.length;y++)m=x[y],d.addString(m)}h.data=d,r.push(h)}return r},i.prototype._parseTransform=function(e,n,s){n.x=i._getNumber(e,t.DataParser.X,0)*s,n.y=i._getNumber(e,t.DataParser.Y,0)*s,t.DataParser.ROTATE in e||t.DataParser.SKEW in e?(n.rotation=t.Transform.normalizeRadian(i._getNumber(e,t.DataParser.ROTATE,0)*t.Transform.DEG_RAD),n.skew=t.Transform.normalizeRadian(i._getNumber(e,t.DataParser.SKEW,0)*t.Transform.DEG_RAD)):(t.DataParser.SKEW_X in e||t.DataParser.SKEW_Y in e)&&(n.rotation=t.Transform.normalizeRadian(i._getNumber(e,t.DataParser.SKEW_Y,0)*t.Transform.DEG_RAD),n.skew=t.Transform.normalizeRadian(i._getNumber(e,t.DataParser.SKEW_X,0)*t.Transform.DEG_RAD)-n.rotation),n.scaleX=i._getNumber(e,t.DataParser.SCALE_X,1),n.scaleY=i._getNumber(e,t.DataParser.SCALE_Y,1)},i.prototype._parseColorTransform=function(e,n){n.alphaMultiplier=.01*i._getNumber(e,t.DataParser.ALPHA_MULTIPLIER,100),n.redMultiplier=.01*i._getNumber(e,t.DataParser.RED_MULTIPLIER,100),n.greenMultiplier=.01*i._getNumber(e,t.DataParser.GREEN_MULTIPLIER,100),n.blueMultiplier=.01*i._getNumber(e,t.DataParser.BLUE_MULTIPLIER,100),n.alphaOffset=i._getNumber(e,t.DataParser.ALPHA_OFFSET,0),n.redOffset=i._getNumber(e,t.DataParser.RED_OFFSET,0),n.greenOffset=i._getNumber(e,t.DataParser.GREEN_OFFSET,0),n.blueOffset=i._getNumber(e,t.DataParser.BLUE_OFFSET,0)},i.prototype._parseArray=function(){this._intArray.length=0,this._floatArray.length=0,this._frameIntArray.length=0,this._frameFloatArray.length=0,this._frameArray.length=0,this._timelineArray.length=0},i.prototype._modifyArray=function(){this._intArray.length%Int16Array.BYTES_PER_ELEMENT!=0&&this._intArray.push(0),this._frameIntArray.length%Int16Array.BYTES_PER_ELEMENT!=0&&this._frameIntArray.push(0),this._frameArray.length%Int16Array.BYTES_PER_ELEMENT!=0&&this._frameArray.push(0),this._timelineArray.length%Uint16Array.BYTES_PER_ELEMENT!=0&&this._timelineArray.push(0);var e=this._intArray.length*Int16Array.BYTES_PER_ELEMENT,n=this._floatArray.length*Float32Array.BYTES_PER_ELEMENT,i=this._frameIntArray.length*Int16Array.BYTES_PER_ELEMENT,s=this._frameFloatArray.length*Float32Array.BYTES_PER_ELEMENT,o=this._frameArray.length*Int16Array.BYTES_PER_ELEMENT,r=this._timelineArray.length*Uint16Array.BYTES_PER_ELEMENT,a=e+n+i+s+o+r;if(t.DragonBones.webAssembly){for(var c=t.webAssemblyModule.HEAP16.buffer,l=t.webAssemblyModule._malloc(a),h=new Int16Array(c,l,this._intArray.length),_=new Float32Array(c,l+e,this._floatArray.length),u=new Int16Array(c,l+e+n,this._frameIntArray.length),d=new Float32Array(c,l+e+n+i,this._frameFloatArray.length),p=new Int16Array(c,l+e+n+i+s,this._frameArray.length),f=new Uint16Array(c,l+e+n+i+s+o,this._timelineArray.length),m=0,g=this._intArray.length;m<g;++m)h[m]=this._intArray[m];for(m=0,g=this._floatArray.length;m<g;++m)_[m]=this._floatArray[m];for(m=0,g=this._frameIntArray.length;m<g;++m)u[m]=this._frameIntArray[m];for(m=0,g=this._frameFloatArray.length;m<g;++m)d[m]=this._frameFloatArray[m];for(m=0,g=this._frameArray.length;m<g;++m)p[m]=this._frameArray[m];for(m=0,g=this._timelineArray.length;m<g;++m)f[m]=this._timelineArray[m];t.webAssemblyModule.setDataBinary(this._data,l,e,n,i,s,o,r)}else{var v=new ArrayBuffer(a);for(h=new Int16Array(v,0,this._intArray.length),_=new Float32Array(v,e,this._floatArray.length),u=new Int16Array(v,e+n,this._frameIntArray.length),d=new Float32Array(v,e+n+i,this._frameFloatArray.length),p=new Int16Array(v,e+n+i+s,this._frameArray.length),f=new Uint16Array(v,e+n+i+s+o,this._timelineArray.length),m=0,g=this._intArray.length;m<g;++m)h[m]=this._intArray[m];for(m=0,g=this._floatArray.length;m<g;++m)_[m]=this._floatArray[m];for(m=0,g=this._frameIntArray.length;m<g;++m)u[m]=this._frameIntArray[m];for(m=0,g=this._frameFloatArray.length;m<g;++m)d[m]=this._frameFloatArray[m];for(m=0,g=this._frameArray.length;m<g;++m)p[m]=this._frameArray[m];for(m=0,g=this._timelineArray.length;m<g;++m)f[m]=this._timelineArray[m];this._data.binary=v,this._data.intArray=h,this._data.floatArray=_,this._data.frameIntArray=u,this._data.frameFloatArray=d,this._data.frameArray=p,this._data.timelineArray=f}this._defaultColorOffset=-1},i.prototype.parseDragonBonesData=function(e,n){void 0===n&&(n=1),console.assert(null!=e,"Data error.");var s=i._getString(e,t.DataParser.VERSION,""),o=i._getString(e,t.DataParser.COMPATIBLE_VERSION,"");if(t.DataParser.DATA_VERSIONS.indexOf(s)>=0||t.DataParser.DATA_VERSIONS.indexOf(o)>=0){var r=t.BaseObject.borrowObject(t.DragonBonesData);if(r.version=s,r.name=i._getString(e,t.DataParser.NAME,""),r.frameRate=i._getNumber(e,t.DataParser.FRAME_RATE,24),0===r.frameRate&&(r.frameRate=24),t.DataParser.ARMATURE in e){this._data=r,this._parseArray(e);for(var a=0,c=e[t.DataParser.ARMATURE];a<c.length;a++){var l=c[a];r.addArmature(this._parseArmature(l,n))}this._data.binary||this._modifyArray(),t.DataParser.STAGE in e?r.stage=r.getArmature(i._getString(e,t.DataParser.STAGE,"")):r.armatureNames.length>0&&(r.stage=r.getArmature(r.armatureNames[0])),this._data=null}return t.DataParser.TEXTURE_ATLAS in e&&(this._rawTextureAtlases=e[t.DataParser.TEXTURE_ATLAS]),r}return console.assert(!1,"Nonsupport data version: "+s+"\nPlease convert DragonBones data to support version.\nRead more: https://github.com/DragonBones/Tools/"),null},i.prototype.parseTextureAtlasData=function(e,n,s){if(void 0===s&&(s=1),console.assert(void 0!==e),null===e){if(null===this._rawTextureAtlases||0===this._rawTextureAtlases.length)return!1;var o=this._rawTextureAtlases[this._rawTextureAtlasIndex++];return this.parseTextureAtlasData(o,n,s),this._rawTextureAtlasIndex>=this._rawTextureAtlases.length&&(this._rawTextureAtlasIndex=0,this._rawTextureAtlases=null),!0}if(n.width=i._getNumber(e,t.DataParser.WIDTH,0),n.height=i._getNumber(e,t.DataParser.HEIGHT,0),n.scale=1===s?1/i._getNumber(e,t.DataParser.SCALE,1):s,n.name=i._getString(e,t.DataParser.NAME,""),n.imagePath=i._getString(e,t.DataParser.IMAGE_PATH,""),t.DataParser.SUB_TEXTURE in e)for(var r=e[t.DataParser.SUB_TEXTURE],a=0,c=r.length;a<c;++a){var l=r[a],h=n.createTexture();h.rotated=i._getBoolean(l,t.DataParser.ROTATED,!1),h.name=i._getString(l,t.DataParser.NAME,""),h.region.x=i._getNumber(l,t.DataParser.X,0),h.region.y=i._getNumber(l,t.DataParser.Y,0),h.region.width=i._getNumber(l,t.DataParser.WIDTH,0),h.region.height=i._getNumber(l,t.DataParser.HEIGHT,0);var _=i._getNumber(l,t.DataParser.FRAME_WIDTH,-1),u=i._getNumber(l,t.DataParser.FRAME_HEIGHT,-1);_>0&&u>0&&(h.frame=t.TextureData.createRectangle(),h.frame.x=i._getNumber(l,t.DataParser.FRAME_X,0),h.frame.y=i._getNumber(l,t.DataParser.FRAME_Y,0),h.frame.width=_,h.frame.height=u),n.addTexture(h)}return!0},i.getInstance=function(){return null===i._objectDataParserInstance&&(i._objectDataParserInstance=new i),i._objectDataParserInstance},i._objectDataParserInstance=null,i}(t.DataParser);t.ObjectDataParser=e;var n=function(){this.frameStart=0,this.actions=[]};t.ActionFrame=n}(NQ||(NQ={})),function(t){var e=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return MQ(n,e),n.prototype._inRange=function(t,e,n){return e<=t&&t<=n},n.prototype._decodeUTF8=function(t){for(var e,n=0,i="",s=0,o=0,r=0,a=0;t.length>n;){var c=t[n++];if(-1===c)e=0!==o?65533:-1;else if(0===o)this._inRange(c,0,127)?e=c:(this._inRange(c,194,223)?(o=1,a=128,s=c-192):this._inRange(c,224,239)?(o=2,a=2048,s=c-224):this._inRange(c,240,244)&&(o=3,a=65536,s=c-240),s*=Math.pow(64,o),e=null);else if(this._inRange(c,128,191))if(r+=1,s+=(c-128)*Math.pow(64,o-r),r!==o)e=null;else{var l=s,h=a;s=0,o=0,r=0,a=0,e=this._inRange(l,h,1114111)&&!this._inRange(l,55296,57343)?l:c}else s=0,o=0,r=0,a=0,n--,e=c;null!==e&&-1!==e&&(e<=65535?e>0&&(i+=String.fromCharCode(e)):(e-=65536,i+=String.fromCharCode(55296+(e>>10&1023)),i+=String.fromCharCode(56320+(1023&e))))}return i},n.prototype._getUTF16Key=function(t){for(var e=0,n=t.length;e<n;++e)if(t.charCodeAt(e)>255)return encodeURI(t);return t},n.prototype._parseBinaryTimeline=function(e,n,i){void 0===i&&(i=null);var s=null!==i?i:t.BaseObject.borrowObject(t.TimelineData);s.type=e,s.offset=n,this._timeline=s;var o=this._timelineArrayBuffer[s.offset+2];if(1===o)s.frameIndicesOffset=-1;else{var r=0,a=this._animation.frameCount+1,c=this._data.frameIndices;t.DragonBones.webAssembly?(r=c.size(),c.resize(r+a,0)):(r=c.length,c.length+=a),s.frameIndicesOffset=r;for(var l=0,h=0,_=0,u=0;l<a;++l)_+u<=l&&h<o&&(_=this._frameArrayBuffer[this._animation.frameOffset+this._timelineArrayBuffer[s.offset+5+h]],u=h===o-1?this._animation.frameCount-_:this._frameArrayBuffer[this._animation.frameOffset+this._timelineArrayBuffer[s.offset+5+h+1]]-_,h++),t.DragonBones.webAssembly?c.set(r+l,h-1):c[r+l]=h-1}return this._timeline=null,s},n.prototype._parseVertices=function(e,n){n.offset=e[t.DataParser.OFFSET];var i=this._intArrayBuffer[n.offset+3];if(i>=0){var s=t.BaseObject.borrowObject(t.WeightData),o=this._intArrayBuffer[n.offset+0],r=this._intArrayBuffer[i+0];s.offset=i;for(var a=0;a<r;++a){var c=this._intArrayBuffer[i+2+a];s.addBone(this._rawBones[c])}for(var l=i+2+r,h=0,_=(a=0,o);a<_;++a){var u=this._intArrayBuffer[l++];h+=u,l+=u}s.count=h,n.weight=s}},n.prototype._parseMesh=function(t,e){this._parseVertices(t,e.vertices)},n.prototype._parsePath=function(t,e){this._parseVertices(t,e.vertices)},n.prototype._parseAnimation=function(e){var n=t.BaseObject.borrowObject(t.AnimationData);n.frameCount=Math.max(t.ObjectDataParser._getNumber(e,t.DataParser.DURATION,1),1),n.playTimes=t.ObjectDataParser._getNumber(e,t.DataParser.PLAY_TIMES,1),n.duration=n.frameCount/this._armature.frameRate,n.fadeInTime=t.ObjectDataParser._getNumber(e,t.DataParser.FADE_IN_TIME,0),n.scale=t.ObjectDataParser._getNumber(e,t.DataParser.SCALE,1),n.name=t.ObjectDataParser._getString(e,t.DataParser.NAME,t.DataParser.DEFAULT_NAME),0===n.name.length&&(n.name=t.DataParser.DEFAULT_NAME);var i=e[t.DataParser.OFFSET];if(n.frameIntOffset=i[0],n.frameFloatOffset=i[1],n.frameOffset=i[2],this._animation=n,t.DataParser.ACTION in e&&(n.actionTimeline=this._parseBinaryTimeline(0,e[t.DataParser.ACTION])),t.DataParser.Z_ORDER in e&&(n.zOrderTimeline=this._parseBinaryTimeline(1,e[t.DataParser.Z_ORDER])),t.DataParser.BONE in e){var s=e[t.DataParser.BONE];for(var o in s){var r=s[o];t.DragonBones.webAssembly&&(o=this._getUTF16Key(o));var a=this._armature.getBone(o);if(null!==a)for(var c=0,l=r.length;c<l;c+=2){var h=r[c],_=r[c+1],u=this._parseBinaryTimeline(h,_);this._animation.addBoneTimeline(a,u)}}}if(t.DataParser.SURFACE in e)for(var o in s=e[t.DataParser.SURFACE]){r=s[o],t.DragonBones.webAssembly&&(o=this._getUTF16Key(o));var d=this._armature.getBone(o);if(null!==d)for(c=0,l=r.length;c<l;c+=2)h=r[c],_=r[c+1],u=this._parseBinaryTimeline(h,_),this._animation.addSurfaceTimeline(d,u)}if(t.DataParser.SLOT in e)for(var o in s=e[t.DataParser.SLOT]){r=s[o],t.DragonBones.webAssembly&&(o=this._getUTF16Key(o));var p=this._armature.getSlot(o);if(null!==p)for(c=0,l=r.length;c<l;c+=2)h=r[c],_=r[c+1],u=this._parseBinaryTimeline(h,_),this._animation.addSlotTimeline(p,u)}if(t.DataParser.CONSTRAINT in e)for(var o in s=e[t.DataParser.CONSTRAINT]){r=s[o],t.DragonBones.webAssembly&&(o=this._getUTF16Key(o));var f=this._armature.getConstraint(o);if(null!==f)for(c=0,l=r.length;c<l;c+=2)h=r[c],_=r[c+1],u=this._parseBinaryTimeline(h,_),this._animation.addConstraintTimeline(f,u)}if(t.DataParser.ANIMATION in e)for(var o in s=e[t.DataParser.ANIMATION])for(r=s[o],t.DragonBones.webAssembly&&(o=this._getUTF16Key(o)),c=0,l=r.length;c<l;c+=2)h=r[c],_=r[c+1],u=this._parseBinaryTimeline(h,_),this._animation.addAnimationTimeline(o,u);return this._animation=null,n},n.prototype._parseArray=function(e){var n=e[t.DataParser.OFFSET],i=n[1],s=n[3],o=n[5],r=n[7],a=n[9],c=n[11],l=new Int16Array(this._binary,this._binaryOffset+n[0],i/Int16Array.BYTES_PER_ELEMENT),h=new Float32Array(this._binary,this._binaryOffset+n[2],s/Float32Array.BYTES_PER_ELEMENT),_=new Int16Array(this._binary,this._binaryOffset+n[4],o/Int16Array.BYTES_PER_ELEMENT),u=new Float32Array(this._binary,this._binaryOffset+n[6],r/Float32Array.BYTES_PER_ELEMENT),d=new Int16Array(this._binary,this._binaryOffset+n[8],a/Int16Array.BYTES_PER_ELEMENT),p=new Uint16Array(this._binary,this._binaryOffset+n[10],c/Uint16Array.BYTES_PER_ELEMENT);if(t.DragonBones.webAssembly){for(var f=i+s+o+r+a+c,m=t.webAssemblyModule._malloc(f),g=new Uint8Array(this._binary,this._binaryOffset,f/Uint8Array.BYTES_PER_ELEMENT),v=new Uint8Array(t.webAssemblyModule.HEAP16.buffer,m,g.length),y=0,x=g.length;y<x;++y)v[y]=g[y];t.webAssemblyModule.setDataBinary(this._data,m,i,s,o,r,a,c),this._intArrayBuffer=l,this._floatArrayBuffer=h,this._frameIntArrayBuffer=_,this._frameFloatArrayBuffer=u,this._frameArrayBuffer=d,this._timelineArrayBuffer=p}else this._data.binary=this._binary,this._data.intArray=this._intArrayBuffer=l,this._data.floatArray=this._floatArrayBuffer=h,this._data.frameIntArray=this._frameIntArrayBuffer=_,this._data.frameFloatArray=this._frameFloatArrayBuffer=u,this._data.frameArray=this._frameArrayBuffer=d,this._data.timelineArray=this._timelineArrayBuffer=p},n.prototype.parseDragonBonesData=function(t,n){void 0===n&&(n=1),console.assert(null!=t&&t instanceof ArrayBuffer,"Data error.");var i=new Uint8Array(t,0,8);if(i[0]!=="D".charCodeAt(0)||i[1]!=="B".charCodeAt(0)||i[2]!=="D".charCodeAt(0)||i[3]!=="T".charCodeAt(0))return console.assert(!1,"Nonsupport data."),null;var s=new Uint32Array(t,8,1)[0],o=new Uint8Array(t,12,s),r=this._decodeUTF8(o),a=JSON.parse(r);return this._binaryOffset=12+s,this._binary=t,e.prototype.parseDragonBonesData.call(this,a,n)},n.getInstance=function(){return null===n._binaryDataParserInstance&&(n._binaryDataParserInstance=new n),n._binaryDataParserInstance},n._binaryDataParserInstance=null,n}(t.ObjectDataParser);t.BinaryDataParser=e}(NQ||(NQ={})),function(t){var e=function(){function e(n){void 0===n&&(n=null),this.autoSearch=!1,this._dragonBonesDataMap={},this._textureAtlasDataMap={},this._dragonBones=null,this._dataParser=null,null===e._objectParser&&(e._objectParser=new t.ObjectDataParser),null===e._binaryParser&&(e._binaryParser=new t.BinaryDataParser),this._dataParser=null!==n?n:e._objectParser}return e.prototype._isSupportMesh=function(){return!0},e.prototype._getTextureData=function(t,e){if(t in this._textureAtlasDataMap)for(var n=0,i=this._textureAtlasDataMap[t];n<i.length;n++)if(null!==(c=(a=i[n]).getTexture(e)))return c;if(this.autoSearch)for(var s in this._textureAtlasDataMap)for(var o=0,r=this._textureAtlasDataMap[s];o<r.length;o++){var a,c;if((a=r[o]).autoSearch&&null!==(c=a.getTexture(e)))return c}return null},e.prototype._fillBuildArmaturePackage=function(t,e,n,i,s){var o=null,r=null;if(e.length>0&&e in this._dragonBonesDataMap&&(r=(o=this._dragonBonesDataMap[e]).getArmature(n)),null===r&&(0===e.length||this.autoSearch))for(var a in this._dragonBonesDataMap)if(o=this._dragonBonesDataMap[a],(0===e.length||o.autoSearch)&&null!==(r=o.getArmature(n))){e=a;break}if(null!==r){if(t.dataName=e,t.textureAtlasName=s,t.data=o,t.armature=r,t.skin=null,i.length>0&&(t.skin=r.getSkin(i),null===t.skin&&this.autoSearch))for(var a in this._dragonBonesDataMap){var c=this._dragonBonesDataMap[a].getArmature(i);if(null!==c){t.skin=c.defaultSkin;break}}return null===t.skin&&(t.skin=r.defaultSkin),!0}return!1},e.prototype._buildBones=function(e,n){for(var i=0,s=e.armature.sortedBones;i<s.length;i++){var o=s[i];t.BaseObject.borrowObject(0===o.type?t.Bone:t.Surface).init(o,n)}},e.prototype._buildSlots=function(e,n){var i=e.skin,s=e.armature.defaultSkin;if(null!==i&&null!==s){var o={};for(var r in s.displays){var a=s.getDisplays(r);o[r]=a}if(i!==s)for(var r in i.displays)a=i.getDisplays(r),o[r]=a;for(var c=0,l=e.armature.sortedSlots;c<l.length;c++){var h=l[c],_=h.name in o?o[h.name]:null,u=this._buildSlot(e,h,n);if(u.rawDisplayDatas=_,null!==_){for(var d=new Array,p=0,f=t.DragonBones.webAssembly?_.size():_.length;p<f;++p){var m=t.DragonBones.webAssembly?_.get(p):_[p];null!==m?d.push(this._getSlotDisplay(e,m,null,u)):d.push(null)}u._setDisplayList(d)}u._setDisplayIndex(h.displayIndex,!0)}}},e.prototype._buildConstraints=function(e,n){var i=e.armature.constraints;for(var s in i){var o=i[s];switch(o.type){case 0:var r=t.BaseObject.borrowObject(t.IKConstraint);r.init(o,n),n._addConstraint(r);break;case 1:var a=t.BaseObject.borrowObject(t.PathConstraint);a.init(o,n),n._addConstraint(a);break;default:var c=t.BaseObject.borrowObject(t.IKConstraint);c.init(o,n),n._addConstraint(c)}}},e.prototype._buildChildArmature=function(t,e,n){return this.buildArmature(n.path,null!==t?t.dataName:"","",null!==t?t.textureAtlasName:"")},e.prototype._getSlotDisplay=function(e,n,i,s){var o=null!==e?e.dataName:n.parent.parent.parent.name,r=null;switch(n.type){case 0:var a=n;null!==e&&e.textureAtlasName.length>0&&(a.texture=this._getTextureData(e.textureAtlasName,n.path)),null===a.texture&&(a.texture=this._getTextureData(o,n.path)),r=null!==i&&2===i.type&&this._isSupportMesh()?s.meshDisplay:s.rawDisplay;break;case 2:var c=n;null!==e&&e.textureAtlasName.length>0&&(c.texture=this._getTextureData(e.textureAtlasName,c.path)),null===c.texture&&(c.texture=this._getTextureData(o,c.path)),r=this._isSupportMesh()?s.meshDisplay:s.rawDisplay;break;case 1:var l=n,h=this._buildChildArmature(e,s,n);if(null!==h){if(h.inheritAnimation=l.inheritAnimation,!h.inheritAnimation){var _=l.actions.length>0?l.actions:h.armatureData.defaultActions;if(_.length>0)for(var u=0,d=_;u<d.length;u++){var p=d[u],f=t.BaseObject.borrowObject(t.EventObject);t.EventObject.actionDataToInstance(p,f,s.armature),f.slot=s,s.armature._bufferAction(f,!1)}else h.animation.play()}l.armature=h.armatureData}r=h}return r},e.prototype.parseDragonBonesData=function(t,n,i){void 0===n&&(n=null),void 0===i&&(i=1);for(var s=t instanceof ArrayBuffer?e._binaryParser:this._dataParser,o=s.parseDragonBonesData(t,i);;){var r=this._buildTextureAtlasData(null,null);if(!s.parseTextureAtlasData(null,r,i)){r.returnToPool();break}this.addTextureAtlasData(r,n)}return null!==o&&this.addDragonBonesData(o,n),o},e.prototype.parseTextureAtlasData=function(t,e,n,i){void 0===n&&(n=null),void 0===i&&(i=1);var s=this._buildTextureAtlasData(null,null);return this._dataParser.parseTextureAtlasData(t,s,i),this._buildTextureAtlasData(s,e||null),this.addTextureAtlasData(s,n),s},e.prototype.updateTextureAtlasData=function(t,e){var n=this.getTextureAtlasData(t);if(null!==n)for(var i=0,s=n.length;i<s;++i)i<e.length&&this._buildTextureAtlasData(n[i],e[i])},e.prototype.getDragonBonesData=function(t){return t in this._dragonBonesDataMap?this._dragonBonesDataMap[t]:null},e.prototype.addDragonBonesData=function(t,e){if(void 0===e&&(e=null),(e=null!==e?e:t.name)in this._dragonBonesDataMap){if(this._dragonBonesDataMap[e]===t)return;console.warn("Can not add same name data: "+e)}else this._dragonBonesDataMap[e]=t},e.prototype.removeDragonBonesData=function(t,e){void 0===e&&(e=!0),t in this._dragonBonesDataMap&&(e&&this._dragonBones.bufferObject(this._dragonBonesDataMap[t]),delete this._dragonBonesDataMap[t])},e.prototype.getTextureAtlasData=function(t){return t in this._textureAtlasDataMap?this._textureAtlasDataMap[t]:null},e.prototype.addTextureAtlasData=function(t,e){void 0===e&&(e=null);var n=(e=null!==e?e:t.name)in this._textureAtlasDataMap?this._textureAtlasDataMap[e]:this._textureAtlasDataMap[e]=[];n.indexOf(t)<0&&n.push(t)},e.prototype.removeTextureAtlasData=function(t,e){if(void 0===e&&(e=!0),t in this._textureAtlasDataMap){var n=this._textureAtlasDataMap[t];if(e)for(var i=0,s=n;i<s.length;i++){var o=s[i];this._dragonBones.bufferObject(o)}delete this._textureAtlasDataMap[t]}},e.prototype.getArmatureData=function(t,e){void 0===e&&(e="");var i=new n;return this._fillBuildArmaturePackage(i,e,t,"","")?i.armature:null},e.prototype.clear=function(t){for(var e in void 0===t&&(t=!0),this._dragonBonesDataMap)t&&this._dragonBones.bufferObject(this._dragonBonesDataMap[e]),delete this._dragonBonesDataMap[e];for(var e in this._textureAtlasDataMap){if(t)for(var n=0,i=this._textureAtlasDataMap[e];n<i.length;n++){var s=i[n];this._dragonBones.bufferObject(s)}delete this._textureAtlasDataMap[e]}},e.prototype.buildArmature=function(t,e,i,s){void 0===e&&(e=""),void 0===i&&(i=""),void 0===s&&(s="");var o=new n;if(!this._fillBuildArmaturePackage(o,e||"",t,i||"",s||""))return console.warn("No armature data: "+t+", "+(null!==e?e:"")),null;var r=this._buildArmature(o);return this._buildBones(o,r),this._buildSlots(o,r),this._buildConstraints(o,r),r.invalidUpdate(null,!0),r.advanceTime(0),r},e.prototype.replaceDisplay=function(e,n,i){void 0===i&&(i=-1),i<0&&(i=e.displayIndex),i<0&&(i=0),e.replaceDisplayData(n,i);var s=e.displayList;if(s.length<=i){s.length=i+1;for(var o=0,r=s.length;o<r;++o)s[o]||(s[o]=null)}if(null!==n){var a=e.rawDisplayDatas,c=null;a&&(t.DragonBones.webAssembly?i<a.size()&&(c=a.get(i)):i<a.length&&(c=a[i])),s[i]=this._getSlotDisplay(null,n,c,e)}else s[i]=null;e.displayList=s},e.prototype.replaceSlotDisplay=function(t,e,n,i,s,o){void 0===o&&(o=-1);var r=this.getArmatureData(e,t||"");if(!r||!r.defaultSkin)return!1;var a=r.defaultSkin.getDisplay(n,i);return!!a&&(this.replaceDisplay(s,a,o),!0)},e.prototype.replaceSlotDisplayList=function(e,n,i,s){var o=this.getArmatureData(n,e||"");if(!o||!o.defaultSkin)return!1;var r=o.defaultSkin.getDisplays(i);if(!r)return!1;for(var a=0,c=0,l=t.DragonBones.webAssembly?r.size():r.length;c<l;++c){var h=t.DragonBones.webAssembly?r.get(c):r[c];this.replaceDisplay(s,h,a++)}return!0},e.prototype.replaceSkin=function(e,n,i,s){void 0===i&&(i=!1),void 0===s&&(s=null);for(var o=!1,r=n.parent.defaultSkin,a=0,c=e.getSlots();a<c.length;a++){var l=c[a];if(!(null!==s&&s.indexOf(l.name)>=0)){var h=n.getDisplays(l.name);if(h||(null!==r&&n!==r&&(h=r.getDisplays(l.name)),h)){var _=t.DragonBones.webAssembly?h.size():h.length,u=l.displayList;u.length=_;for(var d=0,p=_;d<p;++d){var f=t.DragonBones.webAssembly?h.get(d):h[d];u[d]=null!==f?this._getSlotDisplay(null,f,null,l):null}o=!0,l.rawDisplayDatas=h,l.displayList=u}else i&&(l.rawDisplayDatas=null,l.displayList=[])}}return o},e.prototype.replaceAnimation=function(e,n,i){void 0===i&&(i=!0);var s=n.defaultSkin;if(null===s)return!1;if(i)e.animation.animations=n.animations;else{var o=e.animation.animations,r={};for(var a in o)r[a]=o[a];for(var a in n.animations)r[a]=n.animations[a];e.animation.animations=r}for(var c=0,l=e.getSlots();c<l.length;c++)for(var h=l[c],_=0,u=0,d=h.displayList;u<d.length;u++){var p=d[u];if(p instanceof t.Armature){var f=s.getDisplays(h.name);if(null!==f&&_<(t.DragonBones.webAssembly?f.size():f.length)){var m=t.DragonBones.webAssembly?f.get(_):f[_];if(null!==m&&1===m.type){var g=this.getArmatureData(m.path,m.parent.parent.parent.name);g&&this.replaceAnimation(p,g,i)}}}_++}return!0},e.prototype.getAllDragonBonesData=function(){return this._dragonBonesDataMap},e.prototype.getAllTextureAtlasData=function(){return this._textureAtlasDataMap},Object.defineProperty(e.prototype,"clock",{get:function(){return this._dragonBones.clock},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dragonBones",{get:function(){return this._dragonBones},enumerable:!0,configurable:!0}),e.prototype.changeSkin=function(t,e,n){return void 0===n&&(n=null),this.replaceSkin(t,e,!1,n)},e.prototype.copyAnimationsToArmature=function(t,e,n,i,s){void 0===i&&(i=""),void 0===s&&(s=!0);var o=this.getArmatureData(e,i);return!!o&&this.replaceAnimation(t,o,s)},e._objectParser=null,e._binaryParser=null,e}();t.BaseFactory=e;var n=function(){this.dataName="",this.textureAtlasName="",this.skin=null};t.BuildArmaturePackage=n}(NQ||(NQ={})),function(t){t.BinaryOffset={WeigthBoneCount:0,WeigthFloatOffset:1,WeigthBoneIndices:2,MeshVertexCount:0,MeshTriangleCount:1,MeshFloatOffset:2,MeshWeightOffset:3,MeshVertexIndices:4,TimelineScale:0,TimelineOffset:1,TimelineKeyFrameCount:2,TimelineFrameValueCount:3,TimelineFrameValueOffset:4,TimelineFrameOffset:5,FramePosition:0,FrameTweenType:1,FrameTweenEasingOrCurveSampleCount:2,FrameCurveSamples:3,DeformMeshOffset:0,DeformCount:1,DeformValueCount:2,DeformValueOffset:3,DeformFloatOffset:4},t.ArmatureType={Armature:0,MovieClip:1,Stage:2},t.BoneType={Bone:0,Surface:1},t.DisplayType={Image:0,Armature:1,Mesh:2,BoundingBox:3},t.BoundingBoxType={Rectangle:0,Ellipse:1,Polygon:2},t.ActionType={Play:0,Stop:1,GotoAndPlay:2,GotoAndStop:3,FadeIn:4,FadeOut:5,Frame:10,Sound:11},t.BlendMode={Normal:0,Add:1,Alpha:2,Darken:3,Difference:4,Erase:5,HardLight:6,Invert:7,Layer:8,Lighten:9,Multiply:10,Overlay:11,Screen:12,Subtract:13},t.TweenType={None:0,Line:1,Curve:2,QuadIn:3,QuadOut:4,QuadInOut:5},t.TimelineType={Action:0,ZOrder:1,BoneAll:10,BoneTranslate:11,BoneRotate:12,BoneScale:13,Surface:50,SlotDisplay:20,SlotColor:21,SlotFFD:22,IKConstraint:30,AnimationTime:40,AnimationWeight:41}}(NQ||(NQ={}));const LQ=NQ.DragonBones,BQ=NQ.BaseObject,FQ=NQ.Matrix,zQ=(NQ.Transform,NQ.ColorTransform,NQ.Point,NQ.Rectangle,NQ.UserData,NQ.ActionData,NQ.DragonBonesData,NQ.ArmatureData,NQ.BoneData,NQ.SurfaceData,NQ.SlotData,NQ.ConstraintData,NQ.IKConstraintData,NQ.PathConstraintData,NQ.CanvasData,NQ.SkinData,NQ.VerticesData,NQ.DisplayData),UQ=(NQ.ImageDisplayData,NQ.ArmatureDisplayData,NQ.MeshDisplayData,NQ.BoundingBoxDisplayData,NQ.PathDisplayData,NQ.WeightData,NQ.BoundingBoxData,NQ.RectangleBoundingBoxData,NQ.EllipseBoundingBoxData,NQ.PolygonBoundingBoxData,NQ.AnimationData,NQ.TimelineData,NQ.AnimationConfig,NQ.TextureAtlasData),HQ=NQ.TextureData,GQ=(NQ.DeformVertices,NQ.Armature),VQ=(NQ.TransformObject,NQ.Bone,NQ.Surface,NQ.Slot),jQ=(NQ.Constraint,NQ.IKConstraint,NQ.PathConstraint,NQ.WorldClock,NQ.Animation),WQ=(NQ.AnimationState,NQ.BonePose,NQ.BlendState,NQ.TimelineState,NQ.TweenTimelineState,NQ.BoneTimelineState,NQ.SlotTimelineState,NQ.ConstraintTimelineState,NQ.ActionTimelineState,NQ.ZOrderTimelineState,NQ.BoneAllTimelineState,NQ.BoneTranslateTimelineState,NQ.BoneRotateTimelineState,NQ.BoneScaleTimelineState,NQ.SurfaceTimelineState,NQ.SlotDislayTimelineState,NQ.SlotColorTimelineState,NQ.DeformTimelineState,NQ.IKConstraintTimelineState,NQ.AnimationTimelineState,NQ.EventObject),kQ=(NQ.DataParser,NQ.ObjectDataParser,NQ.ActionFrame,NQ.BinaryDataParser,NQ.BaseFactory),qQ=(NQ.BuildArmaturePackage,NQ.BinaryOffset),XQ=(NQ.ArmatureType,NQ.BoneType);var YQ,KQ;NQ.DisplayType,NQ.BoundingBoxType,NQ.ActionType,NQ.BlendMode,NQ.TweenType,NQ.TimelineType;let $Q=i_("dragonBones.CCTextureAtlasData")(YQ=class extends UQ{constructor(...t){super(...t),this._renderTexture=null}get renderTexture(){return this._renderTexture}set renderTexture(t){if(this._renderTexture=t,t)for(const e in this.textures){const n=this.textures[e];if(!n.spriteFrame){let e=null;n.rotated?e=new Sn(n.region.x,n.region.y,n.region.height,n.region.width):(e=new Sn(n.region.x,n.region.y,n.region.width,n.region.height),n.spriteFrame=new hR,n.spriteFrame.texture=t,n.spriteFrame.rect=e)}}else for(const t in this.textures)this.textures[t].spriteFrame=null}static toString(){return"[class dragonBones.CCTextureAtlasData]"}createTexture(){return BQ.borrowObject(ZQ)}_onClear(){super._onClear(),this.renderTexture=null}})||YQ,ZQ=i_("dragonBones.CCTextureData")(KQ=class extends HQ{constructor(...t){super(...t),this.spriteFrame=null}static toString(){return"[class dragonBones.CCTextureData]"}_onClear(){super._onClear(),this.spriteFrame=null}})||KQ;var JQ;let QQ=i_("dragonBones.CCSlot")(JQ=class extends VQ{static toString(){return"[class dragonBones.CCSlot]"}constructor(){super(),this._localVertices=void 0,this._indices=void 0,this._matrix=void 0,this._worldMatrix=void 0,this._worldMatrixDirty=void 0,this._color=void 0,this._localVertices=[],this._indices=[],this._matrix=new pn,this._worldMatrix=new pn,this._worldMatrixDirty=!0,this._visible=!1,this._color=new An}getTexture(){if(this._textureData){const t=this._textureData.spriteFrame;return t.texture instanceof xu?t.texture._texture:t.texture}return null}calculWorldMatrix(){const t=this._armature._parent;t?this._mulMat(this._worldMatrix,t._worldMatrix,this._matrix):pn.copy(this._worldMatrix,this._matrix),this._worldMatrixDirty=!1}_onClear(){super._onClear(),this._localVertices.length=0,this._indices.length=0,pn.identity(this._matrix),pn.identity(this._worldMatrix),this._worldMatrixDirty=!0,this._color=new An,this._visible=!1}_onUpdateDisplay(){}_initDisplay(t){}_addDisplay(){this._visible=!0}_replaceDisplay(t){}_removeDisplay(){this._visible=!1}_disposeDisplay(t){}_updateVisible(){this._visible=this.parent.visible}_updateGlueMesh(){}_updateZOrder(){}_updateBlendMode(){if(this._childArmature){const t=this._childArmature.getSlots();for(let e=0,n=t.length;e<n;e++){const n=t[e];n._blendMode=this._blendMode,n._updateBlendMode()}}}_updateColor(){const t=this._color;t.r=255*this._colorTransform.redMultiplier,t.g=255*this._colorTransform.greenMultiplier,t.b=255*this._colorTransform.blueMultiplier,t.a=255*this._colorTransform.alphaMultiplier}_updateFrame(){this._indices.length=0;const t=this._indices,e=this._localVertices;let n=0,i=0;const s=this._textureData;if(!this._display||this._displayIndex<0||!s||!s.spriteFrame)return;const o=s.spriteFrame.texture,r=o.width,a=o.height,c=s.region;if(0===r||0===a)return void console.error(`SpriteFrame ${s.spriteFrame.name} incorrect size ${r} x ${a}`);const l=null!==this._deformVertices&&this._display===this._meshDisplay?this._deformVertices.verticesData:null;if(l){const s=l.data,o=s.intArray,h=s.floatArray,_=o[l.offset+qQ.MeshVertexCount],u=o[l.offset+qQ.MeshTriangleCount];let d=o[l.offset+qQ.MeshFloatOffset];d<0&&(d+=65536);const p=d+2*_,f=this._armature._armatureData.scale;for(let t=0,n=2*_;t<n;t+=2)e[i++]=h[d+t]*f,e[i++]=-h[d+t+1]*f,l.rotated?(e[i++]=(c.x+(1-h[p+t])*c.width)/r,e[i++]=(c.y+h[p+t+1]*c.height)/a):(e[i++]=(c.x+h[p+t]*c.width)/r,e[i++]=(c.y+h[p+t+1]*c.height)/a);for(let e=0;e<3*u;++e)t[n++]=o[l.offset+qQ.MeshVertexIndices+e];e.length=i,t.length=n,l.weight&&this._identityTransform()}else{const n=c.x/r,s=(c.y+c.height)/a,o=(c.x+c.width)/r,l=c.y/a;e[i++]=0,e[i++]=0,e[i++]=n,e[i++]=s,e[i++]=c.width,e[i++]=0,e[i++]=o,e[i++]=s,e[i++]=0,e[i++]=c.height,e[i++]=n,e[i++]=l,e[i++]=c.width,e[i++]=c.height,e[i++]=o,e[i++]=l,t[0]=0,t[1]=1,t[2]=2,t[3]=1,t[4]=3,t[5]=2,e.length=i,t.length=6}this._visibleDirty=!0,this._blendModeDirty=!0,this._colorDirty=!0}_updateMesh(){const t=this._armature._armatureData.scale,e=this._deformVertices.vertices,n=this._deformVertices.bones,i=this._deformVertices.verticesData,s=i.weight,o=e.length>0&&i.inheritDeform,r=this._localVertices;if(s){const a=i.data,c=a.intArray,l=a.floatArray,h=c[i.offset+qQ.MeshVertexCount];let _=c[s.offset+qQ.WeigthFloatOffset];_<0&&(_+=65536);for(let i=0,a=s.offset+qQ.WeigthBoneIndices+n.length,u=_,d=0,p=0;i<h;i++,p+=4){const i=c[a++];let s=0,h=0;for(let r=0;r<i;++r){const i=n[c[a++]];if(null!==i){const n=i.globalTransformMatrix,r=l[u++];let a=l[u++]*t,c=l[u++]*t;o&&(a+=e[d++],c+=e[d++]),s+=(n.a*a+n.c*c+n.tx)*r,h+=(n.b*a+n.d*c+n.ty)*r}}r[p]=s,r[p+1]=-h}}else if(o){const n=this._parent._boneData.type!==XQ.Bone,s=i.data,o=s.intArray,a=s.floatArray,c=o[i.offset+qQ.MeshVertexCount];let l=o[i.offset+qQ.MeshFloatOffset];l<0&&(l+=65536);for(let i=0,s=c,o=0;i<s;i++,o+=4){const s=a[l+2*i]*t+e[2*i],c=a[l+2*i+1]*t+e[2*i+1];if(n){const t=this._parent._getGlobalTransformMatrix(s,c);r[o]=t.a*s+t.c*c+t.tx,r[o+1]=-t.b*s+t.d*c+t.ty}else r[o]=s,r[o+1]=-c}}s&&this._identityTransform()}_identityTransform(){const t=this._matrix;t.m00=1,t.m01=0,t.m04=-0,t.m05=-1,t.m12=0,t.m13=0,this._worldMatrixDirty=!0}_updateTransform(){const t=this._matrix;t.m00=this.globalTransformMatrix.a,t.m01=this.globalTransformMatrix.b,t.m04=-this.globalTransformMatrix.c,t.m05=-this.globalTransformMatrix.d,this._childArmature?(t.m12=this.globalTransformMatrix.tx,t.m13=this.globalTransformMatrix.ty):(t.m12=this.globalTransformMatrix.tx-(this.globalTransformMatrix.a*this._pivotX-this.globalTransformMatrix.c*this._pivotY),t.m13=this.globalTransformMatrix.ty-(this.globalTransformMatrix.b*this._pivotX-this.globalTransformMatrix.d*this._pivotY)),this._worldMatrixDirty=!0}updateWorldMatrix(){if(!this._armature)return;const t=this._armature._parent;if(t&&t.updateWorldMatrix(),this._worldMatrixDirty){this.calculWorldMatrix();const t=this.childArmature;if(!t)return;const e=t.getSlots();for(let t=0,n=e.length;t<n;t++){const n=e[t];n&&(n._worldMatrixDirty=!0)}}}_mulMat(t,e,n){const i=e.m00,s=e.m01,o=e.m04,r=e.m05,a=e.m12,c=e.m13,l=n.m00,h=n.m01,_=n.m04,u=n.m05,d=n.m12,p=n.m13;0!==s||0!==o?(t.m00=l*i+h*o,t.m01=l*s+h*r,t.m04=_*i+u*o,t.m05=_*s+u*r,t.m12=i*d+o*p+a,t.m13=s*d+r*p+c):(t.m00=l*i,t.m01=h*r,t.m04=_*i,t.m05=u*r,t.m12=i*d+a,t.m13=r*p+c)}})||JQ;var t0;let e0=i_("dragonBones.CCArmatureDisplay")(t0=class extends zQ{get node(){return this}constructor(){super(),this.shouldAdvanced=!1,this._ccNode=null,this._ccComponent=null,this._eventTarget=void 0,this._armature=null,this._eventTarget=new Vn}hasEvent(t){return console.warn("Method not implemented."),!1}addEvent(t,e,n){console.warn("Method not implemented.")}removeEvent(t,e,n){console.warn("Method not implemented.")}setEventTarget(t){this._eventTarget=t}getRootDisplay(){let t,e=this._armature._parent;if(!e)return this;for(;e;)t=e,e=e._armature._parent;return t._armature.display}convertToRootSpace(t){const e=this._armature._parent;if(!e)return t;e.updateWorldMatrix();const n=e._worldMatrix,i=new $e(0,0);return i.x=t.x*n.m00+t.y*n.m04+n.m12,i.y=t.x*n.m01+t.y*n.m05+n.m13,i}convertToWorldSpace(t){var e;const n=this.convertToRootSpace(t),i=this.getRootNode();return null==i||null===(e=i._uiProps.uiTransformComp)||void 0===e?void 0:e.convertToWorldSpaceAR(n)}getRootNode(){const t=this.getRootDisplay();return t&&t._ccNode}dbInit(t){this._armature=t}dbClear(){this._armature=null}dbUpdate(){this._ccComponent&&this._ccComponent.markForUpdateRenderData()}advanceTimeBySelf(t){this.shouldAdvanced=!!t}hasDBEventListener(t){return this._eventTarget.hasEventListener(t)}addDBEventListener(t,e,n){this._eventTarget.on(t,e,n)}removeDBEventListener(t,e,n){this._eventTarget.off(t,e,n)}dispatchDBEvent(t,e){this._eventTarget.emit(t,e)}})||t0;var n0,i0,s0;let o0=i_("CCFactory")((s0=i0=class t extends kQ{static getInstance(){return t._factory||(t._factory=new t),t._factory}constructor(){super(),this.id=void 0,this.uuid=void 0,this._slots=void 0;const t=new e0;this._dragonBones=new LQ(t),qA.getScheduler()&&(Sm.on(xm.EVENT_RESTART,this.initUpdate,this),this.initUpdate()),this.id=this.uuid="CCFactory"}initUpdate(t){VA.enableForTarget(this),qA.getScheduler().scheduleUpdate(this,VA.PRIORITY_SYSTEM,!1)}update(t){this._dragonBones.advanceTime(t)}getDragonBonesDataByRawData(t){return(t instanceof ArrayBuffer?kQ._binaryParser:this._dataParser).parseDragonBonesData(t,1)}buildArmatureDisplay(t,e,n,i){const s=this.buildArmature(t,e,n,i);return s?s._display:null}createArmatureNode(t,e,n){let i=(n=n||new ey).getComponent("dragonBones.ArmatureDisplay");return i||(i=n.addComponent("dragonBones.ArmatureDisplay")),n.name=e,i._armatureName=e,i._dragonAsset=t.dragonAsset,i._dragonAtlasAsset=t.dragonAtlasAsset,i._init(),i}_buildTextureAtlasData(t,e){return t?t.renderTexture=e:t=BQ.borrowObject($Q),t}_sortSlots(){const t=this._slots,e=[];for(let n=0,i=t.length;n<i;n++){const i=t[n],s=i._zOrder;let o=!1;for(let t=e.length-1;t>=0;t--)if(s>=e[t]._zOrder){e.splice(t+1,0,i),o=!0;break}o||e.splice(0,0,i)}this._slots=e}_buildArmature(t){const e=BQ.borrowObject(GQ);e._skinData=t.skin,e._animation=BQ.borrowObject(jQ),e._animation._armature=e,e._animation.animations=t.armature.animations,e._isChildArmature=!1;const n=new e0;return e.init(t.armature,n,n,this._dragonBones),e}_buildSlot(t,e,n){const i=BQ.borrowObject(QQ),s=i;return i.init(e,n,s,s),i}getDragonBonesDataByUUID(t){for(const e in this._dragonBonesDataMap)if(-1!==e.indexOf(t))return this._dragonBonesDataMap[e];return null}removeDragonBonesDataByUUID(t,e){void 0===e&&(e=!0);for(const n in this._dragonBonesDataMap)-1!==n.indexOf(t)&&(e&&this._dragonBones.bufferObject(this._dragonBonesDataMap[n]),delete this._dragonBonesDataMap[n])}},i0._factory=null,n0=s0))||n0;const r0=1/60,a0=[],c0=[];let l0,h0,_0=0,u0=0,d0=0,p0=null,f0=null,m0=0,g0=0,v0=0,y0=0,x0=0;class S0{constructor(){this._privateMode=!1,this._inited=!1,this._invalid=!0,this._enableCacheAttachedInfo=!1,this.frames=[],this.totalTime=0,this.isCompleted=!1,this._frameIdx=-1,this._armatureInfo=null,this._animationName=null,this._tempSegments=null,this._tempColors=null,this._tempBoneInfos=null}init(t,e){this._inited=!0,this._armatureInfo=t,this._animationName=e}clear(){this._inited=!1;for(let t=0,e=this.frames.length;t<e;t++)this.frames[t].segments.length=0;this.invalidAllFrame()}begin(){if(!this._invalid)return;const t=this._armatureInfo,e=t.curAnimationCache;e&&e!==this&&(this._privateMode?e.invalidAllFrame():e.updateToFrame()),t.armature.animation.play(this._animationName,1),t.curAnimationCache=this,this._invalid=!1,this._frameIdx=-1,this.totalTime=0,this.isCompleted=!1}end(){this._needToUpdate()||(this._armatureInfo.curAnimationCache=null,this.frames.length=this._frameIdx+1,this.isCompleted=!0)}_needToUpdate(t){return!this._armatureInfo.armature.animation.isCompleted&&this.totalTime<30&&(void 0===t||this._frameIdx<t)}updateToFrame(t){if(!this._inited)return;if(this.begin(),!this._needToUpdate(t))return;const e=this._armatureInfo.armature;do{e.advanceTime(r0),this._frameIdx++,this._updateFrame(e,this._frameIdx),this.totalTime+=r0}while(this._needToUpdate(t));this.end()}isInited(){return this._inited}isInvalid(){return this._invalid}invalidAllFrame(){this.isCompleted=!1,this._invalid=!0}updateAllFrame(){this.invalidAllFrame(),this.updateToFrame()}enableCacheAttachedInfo(){this._enableCacheAttachedInfo||(this._enableCacheAttachedInfo=!0,this.invalidAllFrame())}_updateFrame(t,e){d0=0,_0=0,u0=0,p0=null,f0=null,m0=0,g0=0,v0=0,y0=0,x0=0,this.frames[e]=this.frames[e]||{segments:[],colors:[],boneInfos:[],vertices:null,uintVert:null,indices:null};const n=this.frames[e],i=this._tempSegments=n.segments,s=this._tempColors=n.colors,o=this._tempBoneInfos=n.boneInfos;this._traverseArmature(t,1),y0>0&&(s[y0-1].vfOffset=d0),s.length=y0,o.length=_0;const r=v0-1;if(r>=0)if(g0>0){const t=i[r];t.indexCount=g0,t.vfCount=5*m0,t.vertexCount=m0,i.length=v0}else i.length=v0-1;if(0===i.length)return;let a=n.vertices,c=n.uintVert;(!a||a.length<d0)&&(a=n.vertices=new Float32Array(d0),c=n.uintVert=new Uint32Array(a.buffer));for(let t=0,e=0;t<d0;)a[t++]=a0[e++],a[t++]=a0[e++],a[t++]=a0[e++],a[t++]=a0[e++],c[t++]=a0[e++];let l=n.indices;(!l||l.length<u0)&&(l=n.indices=new Uint16Array(u0));for(let t=0;t<u0;t++)l[t]=c0[t];n.vertices=a,n.uintVert=c,n.indices=l}_traverseArmature(t,e){const n=this._tempColors,i=this._tempSegments,s=this._tempBoneInfos,o=a0,r=c0,a=t._slots;let c,l,h,_,u,d,p,f,m;const g=t._bones;if(this._enableCacheAttachedInfo)for(let t=0,e=g.length;t<e;t++,_0++){const e=g[t];let n=s[_0];n||(n=s[_0]={globalTransformMatrix:new FQ});const i=e.globalTransformMatrix;n.globalTransformMatrix.copyFrom(i)}for(let t=0,s=a.length;t<s;t++)if(h=a[t],h._visible&&h._displayData)if(h.updateWorldMatrix(),u=h._color,h.childArmature)this._traverseArmature(h.childArmature,e*u.a/255);else if(p=h.getTexture(),p){p0===p.nativeUrl&&f0===h._blendMode||(p0=p.nativeUrl,f0=h._blendMode,f=v0-1,f>=0&&(g0>0?(m=i[f],m.indexCount=g0,m.vertexCount=m0,m.vfCount=5*m0):v0--),i[v0]={tex:p,blendMode:h._blendMode,indexCount:0,vertexCount:0,vfCount:0},v0++,g0=0,m0=0),d=(u.a*e<<24>>>0)+(u.b<<16)+(u.g<<8)+u.r,x0!==d&&(x0=d,y0>0&&(n[y0-1].vfOffset=d0),n[y0++]={r:u.r,g:u.g,b:u.b,a:u.a*e,vfOffset:0}),c=h._localVertices,l=h._indices,_=h._worldMatrix;for(let t=0,e=c.length;t<e;)l0=c[t++],h0=c[t++],o[d0++]=l0*_.m00+h0*_.m04+_.m12,o[d0++]=l0*_.m01+h0*_.m05+_.m13,o[d0++]=c[t++],o[d0++]=c[t++],o[d0++]=d;for(let t=0,e=l.length;t<e;t++)r[u0++]=m0+l[t];g0+=l.length,m0+=c.length/4}}}class T0{constructor(){this._privateMode=!1,this._animationPool={},this._armatureCache={}}enablePrivateMode(){this._privateMode=!0}dispose(){for(const t in this._armatureCache){const e=this._armatureCache[t];if(e){const t=e.armature;t&&t.dispose()}}this._armatureCache={},this._animationPool={}}_removeArmature(t){const e=this._armatureCache[t],n=e.animationsCache;for(const e in n){const i=n[e];i&&(this._animationPool[`${t}#${e}`]=i,i.clear())}const i=e.armature;i&&i.dispose(),delete this._armatureCache[t]}resetArmature(t){for(const e in this._armatureCache)-1!==e.indexOf(t)&&this._removeArmature(e)}getArmatureCache(t,e,n){const i=this._armatureCache[e];let s;if(i)s=i.armature;else{const i=o0.getInstance().buildArmatureDisplay(t,e,"",n);if(!i||!i._armature)return null;if(s=i._armature,!T0.canCache(s))return s.dispose(),null;this._armatureCache[e]={armature:s,animationsCache:{},curAnimationCache:null}}return s}getAnimationCache(t,e){const n=this._armatureCache[t];return n?n.animationsCache[e]:null}initAnimationCache(t,e){if(!e)return null;const n=this._armatureCache[t],i=n&&n.armature;if(!i)return null;if(!i.animation.hasAnimation(e))return null;const s=n.animationsCache;let o=s[e];if(!o){const i=`${t}#${e}`;o=this._animationPool[i],o?delete this._animationPool[i]:(o=new S0,o._privateMode=this._privateMode),o.init(n,e),s[e]=o}return o}invalidAnimationCache(t){const e=this._armatureCache[t];if(!e||!e.armature)return;const n=e.animationsCache;for(const t in n)n[t].invalidAllFrame()}updateAnimationCache(t,e){if(e){const n=this.initAnimationCache(t,e);if(!n)return;n.updateAllFrame()}else{const e=this._armatureCache[t];if(!e||!e.armature)return;const n=e.animationsCache;for(const t in n)n[t].updateAllFrame()}}static canCache(t){const e=t._slots;for(let t=0,n=e.length;t<n;t++)if(e[t].childArmature)return!1;return!0}}var E0,A0,C0;T0.FrameTime=r0,T0.sharedCache=new T0;let b0=i_("dragonBones.DragonBonesAsset")((C0=Yh((A0=class extends lu{constructor(...t){super(...t),Xh(this,"_dragonBonesJson",C0,this),this._factory=null,this._dragonBonesJsonData=void 0,this._armaturesEnum=null}get dragonBonesJson(){return this._dragonBonesJson}set dragonBonesJson(t){this._dragonBonesJson=t,this._dragonBonesJsonData=JSON.parse(t),this.reset()}constructctor(){this.reset()}createNode(t){const e=new ey(this.name);return e.addComponent("dragonBones.ArmatureDisplay").dragonAsset=this,t(null,e)}reset(){this._clear()}init(t,e){this._factory=t,!this._dragonBonesJsonData&&this.dragonBonesJson&&(this._dragonBonesJsonData=JSON.parse(this.dragonBonesJson));let n=null;if(n=this._dragonBonesJsonData?this._dragonBonesJsonData:this._nativeAsset,!this._uuid){const t=this._factory.getDragonBonesDataByRawData(n);t?this._uuid=t.name:console.warn("dragonbones name is empty")}const i=`${this._uuid}#${e}`;return this._factory.getDragonBonesData(i)||this._factory.parseDragonBonesData(n instanceof ArrayBuffer?n:n.buffer instanceof ArrayBuffer?n.buffer:n,i),i}getArmatureEnum(){if(this._armaturesEnum)return this._armaturesEnum;this.init();const t=this._factory.getDragonBonesDataByUUID(this._uuid);if(t){const e=t.armatureNames,n={};for(let t=0;t<e.length;t++)n[e[t]]=t;return this._armaturesEnum=It(n)}return null}getAnimsEnum(t){this.init();const e=this._factory.getDragonBonesDataByUUID(this._uuid);if(e){const n=e.getArmature(t);if(!n)return null;const i={"<None>":0},s=n.animations;let o=0;for(const t in s)s.hasOwnProperty(t)&&(i[t]=o+1,o++);return It(i)}return null}destroy(){return this._clear(),super.destroy()}_clear(){this._factory&&(T0.sharedCache.resetArmature(this._uuid),this._factory.removeDragonBonesDataByUUID(this._uuid,!0))}}).prototype,"_dragonBonesJson",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),E0=A0))||E0;var P0,w0,D0,I0,R0,O0,M0,N0;i.internal.DragonBonesAsset=b0;let L0=(P0=i_("dragonBones.DragonBonesAtlasAsset"),w0=O_(Gd),P0((R0=Yh((I0=class extends lu{constructor(){super(),Xh(this,"_atlasJson",R0,this),Xh(this,"_texture",O0,this),Xh(this,"_atlasJsonData",M0,this),this._factory=null,Xh(this,"_textureAtlasData",N0,this),this._clear()}get atlasJson(){return this._atlasJson}set atlasJson(t){this._atlasJson=t,this._atlasJsonData=JSON.parse(this.atlasJson),this._clear()}get texture(){return this._texture}set texture(t){this._texture=t,this._clear()}createNode(t){const e=new ey(this.name);return e.addComponent("dragonBones.ArmatureDisplay").dragonAtlasAsset=this,t(null,e)}init(t){this._factory=t,this._atlasJsonData||(this._atlasJsonData=JSON.parse(this.atlasJson));const e=this._atlasJsonData;this._uuid=this._uuid||e.name,this._textureAtlasData?t.addTextureAtlasData(this._textureAtlasData,this._uuid):this._textureAtlasData=t.parseTextureAtlasData(e,this.texture,this._uuid)}destroy(){return this._clear(),super.destroy()}_clear(){}}).prototype,"_atlasJson",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),O0=Yh(I0.prototype,"_texture",[c_,w0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),M0=Yh(I0.prototype,"_atlasJsonData",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),N0=Yh(I0.prototype,"_textureAtlasData",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),D0=I0))||D0);var B0;i.internal.DragonBonesAtlasAsset=L0;const F0=new pn;let z0=i_("dragonBones.AttachUtil")(B0=class{constructor(){this._inited=!1,this._armature=null,this._armatureNode=null,this._armatureDisplay=null}init(t){this._inited=!0,this._armature=t._armature,this._armatureNode=t.node,this._armatureDisplay=t}reset(){this._inited=!1,this._armature=null,this._armatureNode=null,this._armatureDisplay=null}_syncAttachedNode(){if(!this._inited)return;this._armatureNode.worldMatrix;let t=null;const e=this._armatureDisplay.isAnimationCached();if(e&&this._armatureDisplay&&(t=this._armatureDisplay._curFrame&&this._armatureDisplay._curFrame.boneInfos,!t))return;const n=this._armatureDisplay.sockets,i=this._armatureDisplay.socketNodes,s=new $e,o=(t,e)=>{const n=F0;n.m00=e.a,n.m01=e.b,n.m04=-e.c,n.m05=-e.d,n.m12=e.tx,n.m13=e.ty,t._oldScale||(t._oldScale=t.scale.clone()),s.set(t._oldScale),t.matrix=F0,t.scale=s.multiply(this._armatureNode.scale)},r=this._armature.getBones();for(let s=n.length-1;s>=0;s--){const a=n[s],c=a.target;if(!c)continue;if(!c.isValid){i.delete(a.path),n.splice(s,1);continue}const l=e?t[a.boneIndex]:r[a.boneIndex];l&&o(c,l.globalTransformMatrix)}}})||B0;var U0,H0,G0,V0,j0,W0,k0,q0,X0,Y0,K0,$0,Z0,J0,Q0,t1,e1,n1,i1,s1,o1,r1,a1,c1,l1,h1,_1,u1,d1,p1,f1,m1,g1,v1,y1,x1,S1,T1,E1,A1,C1,b1,P1,w1,D1,I1,R1,O1,M1,N1;let L1;function B1(t,e,n){Se.Attr.setClassAttr(t,e,"type","Enum"),Se.Attr.setClassAttr(t,e,"enumList",It.getList(n))}!function(t){t[t.default=-1]="default"}(O1||(O1={})),Mt(O1),function(t){t[t["<None>"]=0]="<None>"}(M1||(M1={})),Mt(M1),function(t){t[t.REALTIME=0]="REALTIME"}(N1||(N1={})),Mt(M1),function(t){t[t.REALTIME=0]="REALTIME",t[t.SHARED_CACHE=1]="SHARED_CACHE",t[t.PRIVATE_CACHE=2]="PRIVATE_CACHE"}(L1||(L1={})),Mt(L1);let F1=(U0=i_("dragonBones.ArmatureDisplay.DragonBoneSocket"),H0=O_(ey),U0((j0=Yh((V0=class{constructor(t="",e=null){Xh(this,"path",j0,this),Xh(this,"target",W0,this),this.boneIndex=null,this.path=t,this.target=e}}).prototype,"path",[c_,m_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),W0=Yh(V0.prototype,"target",[H0,m_,c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),G0=V0))||G0);St(F1,"dragonBones.ArmatureDisplay.DragonBoneSocket");let z1=(k0=i_("dragonBones.ArmatureDisplay"),q0=f_(),X0=__(),Y0=O_(b0),K0=y_(),$0=O_(L0),Z0=y_(),J0=g_(),Q0=g_(),t1=v_(),e1=O_(O1),n1=y_(),i1=O_(M1),s1=v_(),o1=y_(),r1=v_(),a1=y_(),c1=y_(),l1=y_(),h1=y_(),_1=y_(),u1=O_([F1]),d1=y_(),k0(p1=q0(p1=X0(p1=h_((R1=I1=class t extends JO{get dragonAsset(){return this._dragonAsset}set dragonAsset(t){this._dragonAsset=t,this._refresh()}get dragonAtlasAsset(){return this._dragonAtlasAsset}set dragonAtlasAsset(t){this._dragonAtlasAsset=t,this._parseDragonAtlasAsset(),this._refresh()}get armatureName(){return this._armatureName}set armatureName(t){this._armatureName=t;const e=this.getAnimationNames(this._armatureName);(!this.animationName||e.indexOf(this.animationName)<0)&&(this.animationName=""),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.remove(this._armature),this._refresh(),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.add(this._armature)}get animationName(){return this._animationName}set animationName(t){this._animationName=t}get _defaultArmatureIndex(){return this._defaultArmatureIndexValue}set _defaultArmatureIndex(t){this._defaultArmatureIndexValue=t;let e="";if(this.dragonAsset){let t;if(this.dragonAsset&&(t=this.dragonAsset.getArmatureEnum()),!t)return void C(7400,this.name);e=t[this._defaultArmatureIndex]}void 0!==e?this.armatureName=e:C(7401,this.name),this.resetRenderData(),this.markForUpdateRenderData()}get _animationIndex(){return this._animationIndexValue}set _animationIndex(t){if(this._animationIndexValue=t,0===this._animationIndex)return void(this.animationName="");let e;if(this.dragonAsset&&(e=this.dragonAsset.getAnimsEnum(this.armatureName)),!e)return;const n=e[this._animationIndex];void 0!==n?this.playAnimation(n,this.playTimes):C(7402,this.name)}get _defaultCacheMode(){return this._defaultCacheModeValue}set _defaultCacheMode(t){if(this._defaultCacheModeValue=t,this._defaultCacheMode!==L1.REALTIME&&this._armature&&!T0.canCache(this._armature))return this._defaultCacheMode=L1.REALTIME,void console.warn("Animation cache mode doesn't support skeletal nesting");this.setAnimationCacheMode(this._defaultCacheMode)}get timeScale(){return this._timeScale}set timeScale(t){this._timeScale=t,this._armature&&!this.isAnimationCached()&&(this._armature.animation.timeScale=this.timeScale)}get debugBones(){return this._debugBones}set debugBones(t){this._debugBones=t,this._updateDebugDraw()}get sockets(){return this._sockets}set sockets(t){this._verifySockets(t),this._sockets=t,this._updateSocketBindings(),t.length>0&&this._frameCache&&this._frameCache.enableCacheAttachedInfo()}get socketNodes(){return this._socketNodes}get meshRenderDataArray(){return this._meshRenderDataArray}constructor(){super(),Xh(this,"playTimes",m1,this),Xh(this,"premultipliedAlpha",g1,this),this._armature=null,this.attachUtil=void 0,Xh(this,"_defaultArmatureIndexValue",v1,this),Xh(this,"_dragonAsset",y1,this),Xh(this,"_dragonAtlasAsset",x1,this),Xh(this,"_armatureName",S1,this),Xh(this,"_animationName",T1,this),Xh(this,"_animationIndexValue",E1,this),this._preCacheMode=-1,this._cacheMode=L1.REALTIME,Xh(this,"_defaultCacheModeValue",A1,this),Xh(this,"_timeScale",C1,this),Xh(this,"_playTimes",b1,this),Xh(this,"_debugBones",P1,this),this._debugDraw=null,Xh(this,"_enableBatch",w1,this),this._armatureKey="",this._accTime=0,this._playCount=0,this._frameCache=null,this._curFrame=null,this._playing=!1,this._armatureCache=null,this._eventTarget=void 0,this._factory=null,this._displayProxy=null,this._meshRenderDataArray=[],this._materialCache={},this._enumArmatures=It({}),this._enumAnimations=It({}),this._socketNodes=new Map,this._cachedSockets=new Map,Xh(this,"_sockets",D1,this),this._inited=void 0,this._meshRenderDataArrayIdx=0,this._cacheModeEnum=void 0,this._eventTarget=new Vn,this._inited=!1,this.attachUtil=new z0,this.initFactory(),B1(this,"_animationIndex",this._enumAnimations),B1(this,"_defaultArmatureIndex",this._enumArmatures)}initFactory(){this._factory=o0.getInstance()}onLoad(){const t=this.node.children;for(let e=0,n=t.length;e<n;e++){const n=t[e];0===(n.name&&n.name.search("CHILD_ARMATURE-"))&&n.destroy()}}requestMeshRenderData(){const t=this._meshRenderDataArray;if(t.length>0&&0===t[t.length-1].renderData.vertexCount)return t[t.length-1];const e={renderData:new oO,texture:null};return t.push(e),e}destroyRenderData(){this._meshRenderDataArray&&(this._meshRenderDataArray.forEach((t=>{t.renderData.reset()})),this._meshRenderDataArray.length=0)}resetRenderData(){this._meshRenderDataArray&&this._meshRenderDataArray.forEach((t=>{t.renderData.reset()}))}getMaterialForBlend(t,e){const n=`${t}/${e}`;let i=this._materialCache[n];if(i)return i;const s=this.getMaterial(0);return i=new Xf({parent:s,subModelIdx:0,owner:this}),i.recompileShaders({USE_LOCAL:!1},0),this._materialCache[n]=i,i.overridePipelineStates({blendState:{targets:[{blendSrc:t,blendDst:e}]}}),i}_render(t){if(this._meshRenderDataArray)for(let e=0;e<this._meshRenderDataArray.length;e++){const n=this.material;this._meshRenderDataArrayIdx=e;const i=this._meshRenderDataArray[e];this.material=i.renderData.material,i.texture&&t.commitComp(this,i.texture,this._assembler,null),this.material=n}}_updateBatch(){this._materialCache={},this.destroyRenderData(),this.markForUpdateRenderData()}_updateMaterial(){this.markForUpdateRenderData()}disableRender(){}_validateRender(){const t=this.dragonAtlasAsset&&this.dragonAtlasAsset.texture;return!(!t||!t.loaded)||(this.disableRender(),!1)}__preload(){super.__preload(),this._init()}_init(){if(this._cacheMode=this._defaultCacheMode,this._inited)return;this._inited=!0,this._parseDragonAtlasAsset(),this._refresh();const t=this.node.children;for(let e=0,n=t.length;e<n;e++){const n=t[e];n&&"DEBUG_DRAW_NODE"===n.name&&n.destroy()}this._updateDebugDraw(),this._indexBoneSockets(),this._updateSocketBindings()}getArmatureKey(){return this._armatureKey}setAnimationCacheMode(t){this._preCacheMode!==t&&(this._cacheMode=t,this._buildArmature(),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.add(this._armature),this._updateSocketBindings(),this.markForUpdateRenderData())}isAnimationCached(){return this._cacheMode!==L1.REALTIME}onEnable(){super.onEnable(),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.add(this._armature),this._flushAssembler()}onDisable(){super.onDisable(),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.remove(this._armature)}_emitCacheCompleteEvent(){this._eventTarget.emit(WQ.LOOP_COMPLETE),this._eventTarget.emit(WQ.COMPLETE)}update(t){if(!this.isAnimationCached())return;if(!this._frameCache)return;this.markForUpdateRenderData();const e=this._frameCache;if(!e.isInited())return;const n=e.frames;if(!this._playing)return void(e.isInvalid()&&(e.updateToFrame(),this._curFrame=n[n.length-1]));const i=T0.FrameTime;0===this._accTime&&0===this._playCount&&this._eventTarget.emit(WQ.START),this._accTime+=t*this.timeScale*1;let s=Math.floor(this._accTime/i);if(e.isCompleted||e.updateToFrame(s),e.isCompleted&&s>=n.length){if(this._playCount++,this.playTimes>0&&this._playCount>=this.playTimes)return this._curFrame=n[n.length-1],this._accTime=0,this._playing=!1,this._playCount=0,this._emitCacheCompleteEvent(),void this.attachUtil._syncAttachedNode();this._accTime=0,s=0,this._emitCacheCompleteEvent()}this._curFrame=n[s],this.attachUtil._syncAttachedNode()}onDestroy(){this._materialInstances=this._materialInstances.filter((t=>!!t)),super.onDestroy(),this._inited=!1,this._cacheMode===L1.PRIVATE_CACHE?(this._armatureCache.dispose(),this._armatureCache=null,this._armature=null):this._cacheMode===L1.SHARED_CACHE?(this._armatureCache=null,this._armature=null):this._armature&&(this._armature.dispose(),this._armature=null),this.destroyRenderData()}_updateDebugDraw(){if(this.debugBones){if(!this._debugDraw){const t=new ey("DEBUG_DRAW_NODE");t.hideFlags|=Rn.Flags.DontSave|Rn.Flags.HideInHierarchy;const e=t.addComponent(iL);e.lineWidth=1,e.strokeColor=new An(255,0,0,255),this._debugDraw=e}this._debugDraw.node.parent=this.node}else this._debugDraw&&(this._debugDraw.node.parent=null);this.destroyRenderData(),this.markForUpdateRenderData()}_buildArmature(){if(!this.dragonAsset||!this.dragonAtlasAsset||!this.armatureName)return;this._armature&&(this._preCacheMode===L1.PRIVATE_CACHE?this._armatureCache.dispose():this._preCacheMode===L1.REALTIME&&this._armature.dispose(),this._armatureCache=null,this._armature=null,this._displayProxy=null,this._frameCache=null,this._curFrame=null,this._playing=!1,this._preCacheMode=-1),this._cacheMode===L1.SHARED_CACHE?this._armatureCache=T0.sharedCache:this._cacheMode===L1.PRIVATE_CACHE&&(this._armatureCache=new T0,this._armatureCache.enablePrivateMode());const t=this.dragonAtlasAsset._uuid;if(this._armatureKey=this.dragonAsset.init(this._factory,t),this.isAnimationCached()&&(this._armature=this._armatureCache.getArmatureCache(this.armatureName,this._armatureKey,t),this._armature||(this._cacheMode=L1.REALTIME)),this._preCacheMode=this._cacheMode,this._cacheMode===L1.REALTIME){if(this._displayProxy=this._factory.buildArmatureDisplay(this.armatureName,this._armatureKey,"",t),!this._displayProxy)return;this._displayProxy._ccNode=this.node,this._displayProxy._ccComponent=this,this._displayProxy.setEventTarget(this._eventTarget),this._armature=this._displayProxy._armature,this._armature.animation.timeScale=this.timeScale}if(this._cacheMode!==L1.REALTIME&&this.debugBones&&console.warn("Debug bones is invalid in cached mode"),this._armature){const t=this._armature.armatureData.aabb;this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this._updateBatch(),this.attachUtil.init(this),this.animationName&&this.playAnimation(this.animationName,this.playTimes),this.destroyRenderData(),this.markForUpdateRenderData()}querySockets(){return this._armature?(0===this._cachedSockets.size&&this._indexBoneSockets(),Array.from(this._cachedSockets.keys()).sort()):[]}setBlendHash(){-1!==this._blendHash&&(this._blendHash=-1)}querySocketPathByName(t){const e=[];for(const n of this._cachedSockets.keys())n.endsWith(t)&&e.push(n);return e}_parseDragonAtlasAsset(){this.dragonAtlasAsset&&this.dragonAtlasAsset.init(this._factory)}_refresh(){this._buildArmature(),this.markForUpdateRenderData()}_updateCacheModeEnum(){this._cacheModeEnum=It({}),this._armature?Object.assign(this._cacheModeEnum,L1):Object.assign(this._cacheModeEnum,N1),B1(this,"_defaultCacheMode",this._cacheModeEnum)}_updateAnimEnum(){let t;t=this.dragonAsset?this.dragonAsset.getAnimsEnum(this.armatureName):M1,this._enumAnimations=It({}),Object.assign(this._enumAnimations,t||M1),It.update(this._enumAnimations),B1(this,"_animationIndex",this._enumAnimations)}_updateArmatureEnum(){let t;t=this.dragonAsset?this.dragonAsset.getArmatureEnum():O1,this._enumArmatures=It({}),Object.assign(this._enumArmatures,t||O1),It.update(this._enumArmatures),B1(this,"_defaultArmatureIndex",this._enumArmatures)}_indexBoneSockets(){if(!this._armature)return;this._cachedSockets.clear();const t=this._cachedSockets,e=(t,n,i)=>{if(i.has(t))return i.get(t);const s=n[t];if(!s.parent)return i.set(t,s.name),s.path=s.name,s.name;const o=`${e(s.parent._boneIndex,n,i)}/${s.name}`;return i.set(t,o),s.path=o,o},n=(i,s)=>{const o=s.getBones(),r=new Map;for(let t=0;t<o.length;t++)o[t]._boneIndex=t;for(let t=0;t<o.length;t++)e(t,o,r);for(const e of r.keys())t.set(`${i}${r.get(e)}`,e);const a=s.getSlots();for(let t=0;t<a.length;t++)a[t].childArmature&&n(a[t].name,a[t].childArmature)};n("",this._armature)}playAnimation(t,e){if(this.playTimes=void 0===e?-1:e,this.animationName=t,this.isAnimationCached()){let e=this._armatureCache.getAnimationCache(this._armatureKey,t);e||(e=this._armatureCache.initAnimationCache(this._armatureKey,t)),e&&(this._accTime=0,this._playCount=0,this._frameCache=e,this._sockets.length>0&&this._frameCache.enableCacheAttachedInfo(),this._frameCache.updateToFrame(0),this._playing=!0,this._curFrame=this._frameCache.frames[0])}else if(this._armature)return this._armature.animation.play(t,this.playTimes);return this.markForUpdateRenderData(),null}updateAnimationCache(t){this.isAnimationCached()&&this._armatureCache.updateAnimationCache(this._armatureKey,t)}invalidAnimationCache(){this.isAnimationCached()&&this._armatureCache.invalidAnimationCache(this._armatureKey)}getArmatureNames(){const t=this._factory.getDragonBonesData(this._armatureKey);return t&&t.armatureNames||[]}getAnimationNames(t){const e=[],n=this._factory.getDragonBonesData(this._armatureKey);if(n){const i=n.getArmature(t);if(i)for(const t in i.animations)i.animations.hasOwnProperty(t)&&e.push(t)}return e}on(t,e,n){this.addEventListener(t,e,n)}off(t,e,n){this.removeEventListener(t,e,n)}once(t,e,n){this._eventTarget.once(t,e,n)}addEventListener(t,e,n){this._eventTarget.on(t,e,n)}removeEventListener(t,e,n){this._eventTarget.off(t,e,n)}buildArmature(t,e){return this._factory.createArmatureNode(this,t,e)}armature(){return this._armature}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),0===this._meshRenderDataArray.length&&this._assembler&&this._assembler.createData&&(this._assembler.createData(this),this.markForUpdateRenderData(),this._updateColor())}_updateSocketBindings(){if(this._armature){this._socketNodes.clear();for(let t=0,e=this._sockets.length;t<e;t++){const e=this._sockets[t];if(e.path&&e.target){const t=this._cachedSockets.get(e.path);if(!t){console.error(`Skeleton data does not contain path ${e.path}`);continue}e.boneIndex=t,this._socketNodes.set(e.path,e.target)}}}}_verifySockets(t){for(let e=0,n=t.length;e<n;e++){const n=t[e].target;!n||n.parent&&n.parent===this.node||console.error(`Target node ${n.name} is expected to be a direct child of ${this.node.name}`)}}},I1.AnimationCacheMode=L1,Yh((f1=R1).prototype,"dragonAsset",[m_,Y0,K0],Object.getOwnPropertyDescriptor(f1.prototype,"dragonAsset"),f1.prototype),Yh(f1.prototype,"dragonAtlasAsset",[m_,$0,Z0],Object.getOwnPropertyDescriptor(f1.prototype,"dragonAtlasAsset"),f1.prototype),Yh(f1.prototype,"armatureName",[J0],Object.getOwnPropertyDescriptor(f1.prototype,"armatureName"),f1.prototype),Yh(f1.prototype,"animationName",[Q0],Object.getOwnPropertyDescriptor(f1.prototype,"animationName"),f1.prototype),Yh(f1.prototype,"_defaultArmatureIndex",[t1,m_,e1,n1],Object.getOwnPropertyDescriptor(f1.prototype,"_defaultArmatureIndex"),f1.prototype),Yh(f1.prototype,"_animationIndex",[m_,i1,s1,o1],Object.getOwnPropertyDescriptor(f1.prototype,"_animationIndex"),f1.prototype),Yh(f1.prototype,"_defaultCacheMode",[m_,r1,a1],Object.getOwnPropertyDescriptor(f1.prototype,"_defaultCacheMode"),f1.prototype),Yh(f1.prototype,"timeScale",[m_,c1,c_],Object.getOwnPropertyDescriptor(f1.prototype,"timeScale"),f1.prototype),m1=Yh(f1.prototype,"playTimes",[l1,m_,c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),g1=Yh(f1.prototype,"premultipliedAlpha",[c_,m_,h1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Yh(f1.prototype,"debugBones",[_1,m_],Object.getOwnPropertyDescriptor(f1.prototype,"debugBones"),f1.prototype),Yh(f1.prototype,"sockets",[u1,d1],Object.getOwnPropertyDescriptor(f1.prototype,"sockets"),f1.prototype),v1=Yh(f1.prototype,"_defaultArmatureIndexValue",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return O1.default}}),y1=Yh(f1.prototype,"_dragonAsset",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),x1=Yh(f1.prototype,"_dragonAtlasAsset",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S1=Yh(f1.prototype,"_armatureName",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),T1=Yh(f1.prototype,"_animationName",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),E1=Yh(f1.prototype,"_animationIndexValue",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),A1=Yh(f1.prototype,"_defaultCacheModeValue",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return L1.REALTIME}}),C1=Yh(f1.prototype,"_timeScale",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),b1=Yh(f1.prototype,"_playTimes",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),P1=Yh(f1.prototype,"_debugBones",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),w1=Yh(f1.prototype,"_enableBatch",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),D1=Yh(f1.prototype,"_sockets",[c_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),p1=f1))||p1)||p1)||p1)||p1);i.internal.ArmatureDisplay=z1;const U1=new An(255,0,0,255),H1=new An(0,0,255,255),G1=new An(0,255,0,255);let V1,j1,W1,k1,q1,X1,Y1,K1,$1,Z1,J1,Q1,t2,e2,n2,i2;const s2=new Float32Array(4);let o2,r2,a2,c2,l2,h2,_2;const u2=new $e;function d2(t,e){if(!t)return null;let n,i;switch(e){case 1:n=q1?Xo.ONE:Xo.SRC_ALPHA,i=Xo.ONE;break;case 10:n=Xo.DST_COLOR,i=Xo.ONE_MINUS_SRC_ALPHA;break;case 12:n=Xo.ONE,i=Xo.ONE_MINUS_SRC_COLOR;break;case 0:default:n=q1?Xo.ONE:Xo.SRC_ALPHA,i=Xo.ONE_MINUS_SRC_ALPHA}return $1.setBlendHash(),$1.getMaterialForBlend(n,i)}function p2(t,e){const n=t.a*e*k1,i=q1?n/255:1,s=t.r*V1*i/255,o=t.g*j1*i/255,r=t.b*W1*i/255;s2[0]=s,s2[1]=o,s2[2]=r,s2[3]=q1?1:n/255}function f2(t){s2[0]=(255&t>>>24)/255,s2[1]=(255&t>>>16)/255,s2[2]=(255&t>>>8)/255,s2[3]=(255&t>>>0)/255}const m2={createData(){},updateRenderData(t,e){$1=t,function(t){const e=t._armature;if(!e)return;t.markForUpdateRenderData(),t.destroyRenderData(),X1=!0,q1=t.premultipliedAlpha,K1=t.node,Y1=t.requestMeshRenderData(),$1=t,o2=0;const n=t.color;let i;if(V1=n.r/255,j1=n.g/255,W1=n.b/255,k1=n.a/255,4294967295!==n._val&&(o2|=1),$1._enableBatch&&(i=K1.worldMatrix,X1=!1,o2|=16),t.isAnimationCached())!function(t,e){if(!t)return;const n=t.segments;if(0===n.length)return;let i,s,o;const r=t.vertices,a=new Uint32Array(r.buffer),c=t.indices;let l=0,h=0,_=0;e&&(r2=e.m00,l2=e.m01,a2=e.m04,h2=e.m05,c2=e.m12,_2=e.m13);const u=16&o2,d=u&&(1===r2&&0===l2&&0===a2&&1===h2);let p=0;const f=t.colors;let m=f[p++],g=m.vfOffset;p2(m,1);for(let t=0,e=n.length;t<e;t++){const e=n[t];o=d2(e.tex,e.blendMode),Y1.renderData.material||(Y1.renderData.material=o),Y1.texture||(Y1.texture=e.tex),(X1||Y1.renderData.material!==o||Y1.texture!==e.tex)&&(X1=!1,Y1=$1.requestMeshRenderData(),Y1.renderData.material=o,Y1.texture=e.tex),t2=e.vertexCount,e2=e.indexCount;const v=Y1.renderData;v.reserve(t2,e2),J1=v.indicesCount,Z1=v.vDataOffset,Q1=v.vertexCount,i=Y1.renderData.vData,s=Y1.renderData.iData;for(let t=J1,e=J1+e2;t<e;t++)s[t]=Q1+c[h++];_=e.vfCount;for(let t=l,e=Z1;t<l+_;)i[e]=r[t++],i[e+1]=r[t++],i[e+3]=r[t++],i[e+4]=r[t++],f2(a[t++]),i.set(s2,e+5),e+=9;if(l+=_,d)for(let t=Z1,e=Z1+_;t<e;t+=9)i[t]+=c2,i[t+1]+=_2;else if(u)for(let t=Z1,e=Z1+_;t<e;t+=9)n2=i[t],i2=i[t+1],i[t]=n2*r2+i2*a2+c2,i[t+1]=n2*l2+i2*h2+_2;if(Y1.renderData.advance(t2,e2),!(1&o2))continue;let y=l-_;for(let t=Z1+5,e=Z1+4+_;t<e;t+=9,y+=9)y>=g&&(m=f[p++],p2(m,1),g=m.vfOffset),i.set(s2,t)}}(t._curFrame,i);else{g2(e,i,1);const n=t._debugDraw;if(t.debugBones&&n){n.clear(),n.lineWidth=5,n.strokeColor=U1,n.fillColor=H1;const t=e.getBones();for(let e=0,i=t.length;e<i;e++){const i=t[e],s=Math.max(i.boneData.length,5),o=i.globalTransformMatrix.tx,r=i.globalTransformMatrix.ty,a=o+i.globalTransformMatrix.a*s,c=r+i.globalTransformMatrix.b*s;n.moveTo(o,r),n.lineTo(a,c),n.stroke(),n.circle(o,r,2*Math.PI),n.fill(),0===e&&(n.fillColor=G1)}}}t.attachUtil._syncAttachedNode(),K1=void 0,Y1=void 0,$1=void 0}(t)},updateColor(t){},fillBuffers(t,e){if(!t||0===t.meshRenderDataArray.length)return;const n=t.meshRenderDataArray,i=t.node;let s=e.acquireBufferBatch(),o=s.byteOffset>>2,r=s.indicesOffset,a=s.vertexOffset;const c=n[t._meshRenderDataArrayIdx].renderData;s.request(c.vertexCount,c.indicesCount)||(s=e.currBufferBatch,o=0,r=0,a=0);const l=s.vData,h=s.iData,_=i.worldMatrix,u=c.vData,d=c.vertexStart,p=c.iData;if(l.set(u.slice(d,d+9*c.vertexCount),o),!t._enableBatch)for(let t=0;t<c.vertexCount;t++){const e=o+9*t;u2.set(l[e],l[e+1],l[e+2]),u2.transformMat4(_),l[e]=u2.x,l[e+1]=u2.y,l[e+2]=u2.z}const f=c.indicesStart;for(let t=0;t<c.indicesCount;t+=1)h[t+r]=p[t+f]+a}};function g2(t,e,n){const i=t._slots;let s,o,r,a,c,l,h;const _=new pn;for(let t=0,u=i.length;t<u;t++){if(h=i[t],l=h._color,!h._visible||!h._displayData)continue;if(e?h._mulMat(h._worldMatrix,e,h._matrix):pn.copy(h._worldMatrix,h._matrix),h.childArmature){g2(h.childArmature,h._worldMatrix,n*l.a/255);continue}if(r=d2(h.getTexture(),h._blendMode),!r)continue;Y1.renderData.material||(Y1.renderData.material=r),Y1.texture||(Y1.texture=h.getTexture()),(X1||r!==Y1.renderData.material||Y1.texture!==h.getTexture())&&(X1=!1,Y1=$1.requestMeshRenderData(),Y1.renderData.material=r,Y1.texture=h.getTexture()),p2(l,n),_.set(h._worldMatrix),a=h._localVertices,t2=a.length>>2,c=h._indices,e2=c.length;const u=Y1.renderData;u.reserve(t2,e2),J1=u.indicesCount,Z1=u.vDataOffset,Q1=u.vertexCount,s=Y1.renderData.vData,o=Y1.renderData.iData,r2=_.m00,a2=_.m04,c2=_.m12,l2=_.m01,h2=_.m05,_2=_.m13;for(let t=0,e=a.length;t<e;)n2=a[t++],i2=a[t++],s[Z1]=n2*r2+i2*a2+c2,s[Z1+1]=n2*l2+i2*h2+_2,s[Z1+3]=a[t++],s[Z1+4]=a[t++],s.set(s2,Z1+5),Z1+=9;for(let t=0,e=c.length;t<e;t++)o[J1++]=Q1+c[t];Y1.renderData.advance(t2,e2)}}i.internal.DragonBonesAssembler=m2;const v2={getAssembler:()=>m2};let y2,x2,S2;z1.Assembler=v2,function(t){t[t.FFD=0]="FFD",t[t.AdjustColor=10]="AdjustColor",t[t.BevelFilter=11]="BevelFilter",t[t.BlurFilter=12]="BlurFilter",t[t.DropShadowFilter=13]="DropShadowFilter",t[t.GlowFilter=14]="GlowFilter",t[t.GradientBevelFilter=15]="GradientBevelFilter",t[t.GradientGlowFilter=16]="GradientGlowFilter"}(y2||(y2={})),function(t){t[t.Frame=0]="Frame",t[t.Sound=1]="Sound"}(x2||(x2={})),function(t){t[t.None=0]="None",t[t.SameLayer=1]="SameLayer",t[t.SameGroup=2]="SameGroup",t[t.SameLayerAndGroup=3]="SameLayerAndGroup",t[t.All=4]="All"}(S2||(S2={}));const T2=window.dragonBones,E2=T2.Slot,A2=T2.Matrix,C2=T2.BaseObject,b2=T2.BoundingBoxData,P2=T2.PolygonBoundingBoxData,w2=T2.Transform,D2=T2.Animation,I2=T2.TextureData,R2=T2.CCTextureData,O2=T2.BaseFactory,M2=T2.CCFactory,N2=T2.WorldClock,L2=T2.TextureAtlasData,B2=T2.CCArmatureDisplay,F2=T2.AnimationState,z2=T2.BoneData,U2=T2.EllipseBoundingBoxData,H2=T2.ArmatureData,G2=T2.CCTextureAtlasData,V2=T2.TransformObject,j2=T2.CCSlot,W2=T2.Armature,k2=T2.Bone,q2=T2.RectangleBoundingBoxData,X2=T2.ArmatureCacheMgr,Y2=T2.SkinData,K2=T2.EventObject,$2=T2.SlotData,Z2=T2.DragonBonesData,J2=T2.AnimationData,Q2=T2.CCArmatureCacheDisplay;t("dragonBones",Object.freeze({__proto__:null,DragonBonesAsset:b0,DragonBonesAtlasAsset:L0,timeScale:1,get AnimationCacheMode(){return L1},DragonBoneSocket:F1,ArmatureDisplay:z1,AttachUtil:z0,simpleDragonBoneAssembler:v2,get ExtensionType(){return y2},get EventType(){return x2},get AnimationFadeOutMode(){return S2},Slot:E2,Matrix:A2,BaseObject:C2,BoundingBoxData:b2,PolygonBoundingBoxData:P2,Transform:w2,Animation:D2,TextureData:I2,CCTextureData:R2,BaseFactory:O2,CCFactory:M2,WorldClock:N2,TextureAtlasData:L2,CCArmatureDisplay:B2,AnimationState:F2,BoneData:z2,EllipseBoundingBoxData:U2,ArmatureData:H2,CCTextureAtlasData:G2,TransformObject:V2,CCSlot:j2,Armature:W2,Bone:k2,RectangleBoundingBoxData:q2,ArmatureCacheMgr:X2,SkinData:Y2,EventObject:K2,SlotData:$2,DragonBonesData:Z2,AnimationData:J2,CCArmatureCacheDisplay:Q2}))}}}));
